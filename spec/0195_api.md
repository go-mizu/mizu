# API Refactoring and Enhancement Plan

## Overview

This document outlines the plan to refactor the GitHome API handlers by:
1. Moving API handlers to a dedicated `api/` subdirectory
2. Implementing all missing features from feature APIs
3. Creating comprehensive E2E tests

## 1. Directory Structure Refactoring

### Current Structure
```
app/web/handler/
├── auth.go
├── issue.go
├── page.go
├── page_test.go
├── repo.go
├── response.go
└── user.go
```

### Target Structure
```
app/web/handler/
├── page.go          # HTML page handlers (kept in place)
├── page_test.go
└── api/             # New API handlers directory
    ├── auth.go
    ├── issue.go
    ├── label.go     # NEW
    ├── milestone.go # NEW
    ├── org.go       # NEW
    ├── pull.go      # NEW
    ├── release.go   # NEW
    ├── repo.go
    ├── response.go
    ├── team.go      # NEW
    ├── user.go
    └── webhook.go   # NEW
```

## 2. Missing Features Analysis

### 2.1 Users API (users.API)
| Method | Status | Handler Method |
|--------|--------|----------------|
| Register | ✅ Exists | Auth.Register |
| Login | ✅ Exists | Auth.Login |
| Logout | ✅ Exists | Auth.Logout |
| ValidateSession | ✅ Exists | Auth.Me |
| GetByID | ✅ Exists | User.GetCurrent |
| GetByUsername | ✅ Exists | User.GetByUsername |
| GetByEmail | ❌ Missing | User.GetByEmail |
| Update | ✅ Exists | User.UpdateCurrent |
| Delete | ❌ Missing | User.Delete |
| List | ❌ Missing | User.List |
| ChangePassword | ❌ Missing | User.ChangePassword |

### 2.2 Repos API (repos.API)
| Method | Status | Handler Method |
|--------|--------|----------------|
| Create | ✅ Exists | Repo.Create |
| GetByID | ✅ Exists | Repo.Get |
| GetByOwnerAndName | ✅ Exists | Repo.Get |
| Update | ✅ Exists | Repo.Update |
| Delete | ✅ Exists | Repo.Delete |
| ListByOwner | ✅ Exists | User.ListRepos/ListUserRepos |
| ListPublic | ✅ Exists | Repo.ListPublic |
| ListAccessible | ❌ Missing | Repo.ListAccessible |
| AddCollaborator | ✅ Exists | Repo.AddCollaborator |
| RemoveCollaborator | ✅ Exists | Repo.RemoveCollaborator |
| GetPermission | ❌ Missing | Repo.GetPermission |
| CanAccess | (internal) | - |
| ListCollaborators | ✅ Exists | Repo.ListCollaborators |
| Star | ✅ Exists | Repo.Star |
| Unstar | ✅ Exists | Repo.Unstar |
| IsStarred | ❌ Missing | Repo.CheckStarred |
| ListStarred | ✅ Exists | User.ListStarred |
| Fork | ❌ Missing | Repo.Fork |
| ListForks | ❌ Missing | Repo.ListForks |

### 2.3 Issues API (issues.API)
| Method | Status | Handler Method |
|--------|--------|----------------|
| Create | ✅ Exists | Issue.Create |
| GetByID | ✅ Exists | Issue.Get |
| GetByNumber | ✅ Exists | Issue.Get |
| Update | ✅ Exists | Issue.Update |
| Delete | ✅ Exists | Issue.Delete |
| List | ✅ Exists | Issue.List |
| Close | ❌ Missing | Issue.Close |
| Reopen | ❌ Missing | Issue.Reopen |
| Lock | ✅ Exists | Issue.Lock |
| Unlock | ✅ Exists | Issue.Unlock |
| AddLabels | ✅ Exists | Issue.AddLabels |
| RemoveLabel | ✅ Exists | Issue.RemoveLabel |
| SetLabels | ❌ Missing | Issue.SetLabels |
| AddAssignees | ❌ Missing | Issue.AddAssignees |
| RemoveAssignees | ❌ Missing | Issue.RemoveAssignees |
| AddComment | ✅ Exists | Issue.AddComment |
| UpdateComment | ❌ Missing | Issue.UpdateComment |
| DeleteComment | ❌ Missing | Issue.DeleteComment |
| ListComments | ✅ Exists | Issue.ListComments |

### 2.4 Pull Requests API (pulls.API) - NEW HANDLER
| Method | Handler Method |
|--------|----------------|
| Create | Pull.Create |
| GetByID | Pull.Get |
| GetByNumber | Pull.Get |
| Update | Pull.Update |
| List | Pull.List |
| Close | Pull.Close |
| Reopen | Pull.Reopen |
| Merge | Pull.Merge |
| MarkReady | Pull.MarkReady |
| Lock | Pull.Lock |
| Unlock | Pull.Unlock |
| AddLabels | Pull.AddLabels |
| RemoveLabel | Pull.RemoveLabel |
| SetLabels | Pull.SetLabels |
| AddAssignees | Pull.AddAssignees |
| RemoveAssignees | Pull.RemoveAssignees |
| RequestReview | Pull.RequestReview |
| RemoveReviewRequest | Pull.RemoveReviewRequest |
| CreateReview | Pull.CreateReview |
| GetReview | Pull.GetReview |
| SubmitReview | Pull.SubmitReview |
| DismissReview | Pull.DismissReview |
| ListReviews | Pull.ListReviews |
| CreateReviewComment | Pull.CreateReviewComment |
| UpdateReviewComment | Pull.UpdateReviewComment |
| DeleteReviewComment | Pull.DeleteReviewComment |
| ListReviewComments | Pull.ListReviewComments |

### 2.5 Organizations API (orgs.API) - NEW HANDLER
| Method | Handler Method |
|--------|----------------|
| Create | Org.Create |
| GetByID | Org.Get |
| GetBySlug | Org.Get |
| Update | Org.Update |
| Delete | Org.Delete |
| List | Org.List |
| AddMember | Org.AddMember |
| RemoveMember | Org.RemoveMember |
| UpdateMemberRole | Org.UpdateMemberRole |
| GetMember | Org.GetMember |
| ListMembers | Org.ListMembers |
| ListUserOrgs | Org.ListUserOrgs |
| IsMember | Org.CheckMembership |
| IsOwner | (internal) |

### 2.6 Labels API (labels.API) - NEW HANDLER
| Method | Handler Method |
|--------|----------------|
| Create | Label.Create |
| GetByID | Label.Get |
| GetByName | Label.GetByName |
| Update | Label.Update |
| Delete | Label.Delete |
| List | Label.List |

### 2.7 Milestones API (milestones.API) - NEW HANDLER
| Method | Handler Method |
|--------|----------------|
| Create | Milestone.Create |
| GetByID | Milestone.Get |
| GetByNumber | Milestone.Get |
| Update | Milestone.Update |
| Delete | Milestone.Delete |
| List | Milestone.List |
| Close | (via Update) |
| Reopen | (via Update) |

### 2.8 Releases API (releases.API) - NEW HANDLER
| Method | Handler Method |
|--------|----------------|
| Create | Release.Create |
| GetByID | Release.Get |
| GetByTag | Release.GetByTag |
| GetLatest | Release.GetLatest |
| Update | Release.Update |
| Delete | Release.Delete |
| List | Release.List |
| Publish | Release.Publish |
| UploadAsset | Release.UploadAsset |
| GetAsset | Release.GetAsset |
| UpdateAsset | Release.UpdateAsset |
| DeleteAsset | Release.DeleteAsset |
| ListAssets | Release.ListAssets |

### 2.9 Teams API (teams.API) - NEW HANDLER
| Method | Handler Method |
|--------|----------------|
| Create | Team.Create |
| GetByID | Team.Get |
| GetBySlug | Team.Get |
| Update | Team.Update |
| Delete | Team.Delete |
| List | Team.List |
| ListChildren | Team.ListChildren |
| AddMember | Team.AddMember |
| RemoveMember | Team.RemoveMember |
| UpdateMemberRole | Team.UpdateMemberRole |
| GetMember | Team.GetMember |
| ListMembers | Team.ListMembers |
| ListUserTeams | Team.ListUserTeams |
| AddRepo | Team.AddRepo |
| RemoveRepo | Team.RemoveRepo |
| UpdateRepoPermission | Team.UpdateRepoPermission |
| GetRepoAccess | Team.GetRepoAccess |
| ListRepos | Team.ListRepos |

### 2.10 Webhooks API (webhooks.API) - NEW HANDLER
| Method | Handler Method |
|--------|----------------|
| Create | Webhook.Create |
| GetByID | Webhook.Get |
| Update | Webhook.Update |
| Delete | Webhook.Delete |
| ListByRepo | Webhook.ListByRepo |
| ListByOrg | Webhook.ListByOrg |
| Ping | Webhook.Ping |
| Test | Webhook.Test |
| GetDelivery | Webhook.GetDelivery |
| ListDeliveries | Webhook.ListDeliveries |
| Redeliver | Webhook.Redeliver |

## 3. API Routes

### 3.1 Existing Routes (to be updated for api package)
```
/api/v1/auth/register          POST   - Auth.Register
/api/v1/auth/login             POST   - Auth.Login
/api/v1/auth/logout            POST   - Auth.Logout
/api/v1/auth/me                GET    - Auth.Me

/api/v1/user                   GET    - User.GetCurrent
/api/v1/user                   PATCH  - User.UpdateCurrent
/api/v1/user/repos             GET    - User.ListRepos
/api/v1/user/starred           GET    - User.ListStarred
/api/v1/users/{username}       GET    - User.GetByUsername
/api/v1/users/{username}/repos GET    - User.ListUserRepos

/api/v1/repos                  GET    - Repo.ListPublic
/api/v1/repos                  POST   - Repo.Create
/api/v1/repos/{owner}/{repo}   GET    - Repo.Get
/api/v1/repos/{owner}/{repo}   PATCH  - Repo.Update
/api/v1/repos/{owner}/{repo}   DELETE - Repo.Delete

/api/v1/user/starred/{owner}/{repo}        PUT    - Repo.Star
/api/v1/user/starred/{owner}/{repo}        DELETE - Repo.Unstar
/api/v1/repos/{owner}/{repo}/stargazers    GET    - Repo.ListStargazers

/api/v1/repos/{owner}/{repo}/collaborators              GET    - Repo.ListCollaborators
/api/v1/repos/{owner}/{repo}/collaborators/{username}   PUT    - Repo.AddCollaborator
/api/v1/repos/{owner}/{repo}/collaborators/{username}   DELETE - Repo.RemoveCollaborator

/api/v1/repos/{owner}/{repo}/issues               GET    - Issue.List
/api/v1/repos/{owner}/{repo}/issues               POST   - Issue.Create
/api/v1/repos/{owner}/{repo}/issues/{number}      GET    - Issue.Get
/api/v1/repos/{owner}/{repo}/issues/{number}      PATCH  - Issue.Update
/api/v1/repos/{owner}/{repo}/issues/{number}      DELETE - Issue.Delete
/api/v1/repos/{owner}/{repo}/issues/{number}/lock PUT    - Issue.Lock
/api/v1/repos/{owner}/{repo}/issues/{number}/lock DELETE - Issue.Unlock

/api/v1/repos/{owner}/{repo}/issues/{number}/labels         GET    - Issue.ListLabels
/api/v1/repos/{owner}/{repo}/issues/{number}/labels         POST   - Issue.AddLabels
/api/v1/repos/{owner}/{repo}/issues/{number}/labels/{label} DELETE - Issue.RemoveLabel

/api/v1/repos/{owner}/{repo}/issues/{number}/comments  GET    - Issue.ListComments
/api/v1/repos/{owner}/{repo}/issues/{number}/comments  POST   - Issue.AddComment
```

### 3.2 New Routes

#### User Routes (additions)
```
/api/v1/user                   DELETE - User.Delete
/api/v1/user/password          PUT    - User.ChangePassword
/api/v1/users                  GET    - User.List
/api/v1/users/email/{email}    GET    - User.GetByEmail
```

#### Repo Routes (additions)
```
/api/v1/user/starred/{owner}/{repo}   GET    - Repo.CheckStarred
/api/v1/repos/{owner}/{repo}/forks    GET    - Repo.ListForks
/api/v1/repos/{owner}/{repo}/forks    POST   - Repo.Fork
/api/v1/repos/{owner}/{repo}/permission/{username} GET - Repo.GetPermission
```

#### Issue Routes (additions)
```
/api/v1/repos/{owner}/{repo}/issues/{number}/assignees            POST   - Issue.AddAssignees
/api/v1/repos/{owner}/{repo}/issues/{number}/assignees            DELETE - Issue.RemoveAssignees
/api/v1/repos/{owner}/{repo}/issues/{number}/comments/{id}        PATCH  - Issue.UpdateComment
/api/v1/repos/{owner}/{repo}/issues/{number}/comments/{id}        DELETE - Issue.DeleteComment
```

#### Pull Request Routes (new)
```
/api/v1/repos/{owner}/{repo}/pulls                          GET    - Pull.List
/api/v1/repos/{owner}/{repo}/pulls                          POST   - Pull.Create
/api/v1/repos/{owner}/{repo}/pulls/{number}                 GET    - Pull.Get
/api/v1/repos/{owner}/{repo}/pulls/{number}                 PATCH  - Pull.Update
/api/v1/repos/{owner}/{repo}/pulls/{number}/merge           PUT    - Pull.Merge
/api/v1/repos/{owner}/{repo}/pulls/{number}/ready           PUT    - Pull.MarkReady
/api/v1/repos/{owner}/{repo}/pulls/{number}/lock            PUT    - Pull.Lock
/api/v1/repos/{owner}/{repo}/pulls/{number}/lock            DELETE - Pull.Unlock
/api/v1/repos/{owner}/{repo}/pulls/{number}/labels          GET    - Pull.ListLabels
/api/v1/repos/{owner}/{repo}/pulls/{number}/labels          POST   - Pull.AddLabels
/api/v1/repos/{owner}/{repo}/pulls/{number}/labels/{label}  DELETE - Pull.RemoveLabel
/api/v1/repos/{owner}/{repo}/pulls/{number}/assignees       POST   - Pull.AddAssignees
/api/v1/repos/{owner}/{repo}/pulls/{number}/assignees       DELETE - Pull.RemoveAssignees
/api/v1/repos/{owner}/{repo}/pulls/{number}/reviewers       POST   - Pull.RequestReview
/api/v1/repos/{owner}/{repo}/pulls/{number}/reviewers       DELETE - Pull.RemoveReviewRequest
/api/v1/repos/{owner}/{repo}/pulls/{number}/reviews         GET    - Pull.ListReviews
/api/v1/repos/{owner}/{repo}/pulls/{number}/reviews         POST   - Pull.CreateReview
/api/v1/repos/{owner}/{repo}/pulls/{number}/reviews/{id}    GET    - Pull.GetReview
/api/v1/repos/{owner}/{repo}/pulls/{number}/reviews/{id}    PUT    - Pull.SubmitReview
/api/v1/repos/{owner}/{repo}/pulls/{number}/reviews/{id}    DELETE - Pull.DismissReview
/api/v1/repos/{owner}/{repo}/pulls/{number}/comments        GET    - Pull.ListReviewComments
/api/v1/repos/{owner}/{repo}/pulls/{number}/comments        POST   - Pull.CreateReviewComment
/api/v1/repos/{owner}/{repo}/pulls/{number}/comments/{id}   PATCH  - Pull.UpdateReviewComment
/api/v1/repos/{owner}/{repo}/pulls/{number}/comments/{id}   DELETE - Pull.DeleteReviewComment
```

#### Organization Routes (new)
```
/api/v1/orgs                           GET    - Org.List
/api/v1/orgs                           POST   - Org.Create
/api/v1/orgs/{org}                     GET    - Org.Get
/api/v1/orgs/{org}                     PATCH  - Org.Update
/api/v1/orgs/{org}                     DELETE - Org.Delete
/api/v1/orgs/{org}/members             GET    - Org.ListMembers
/api/v1/orgs/{org}/members/{username}  GET    - Org.GetMember
/api/v1/orgs/{org}/members/{username}  PUT    - Org.AddMember
/api/v1/orgs/{org}/members/{username}  PATCH  - Org.UpdateMemberRole
/api/v1/orgs/{org}/members/{username}  DELETE - Org.RemoveMember
/api/v1/orgs/{org}/membership/{username} GET  - Org.CheckMembership
/api/v1/user/orgs                      GET    - Org.ListUserOrgs
/api/v1/users/{username}/orgs          GET    - Org.ListUserOrgs
```

#### Label Routes (new)
```
/api/v1/repos/{owner}/{repo}/labels        GET    - Label.List
/api/v1/repos/{owner}/{repo}/labels        POST   - Label.Create
/api/v1/repos/{owner}/{repo}/labels/{name} GET    - Label.Get
/api/v1/repos/{owner}/{repo}/labels/{name} PATCH  - Label.Update
/api/v1/repos/{owner}/{repo}/labels/{name} DELETE - Label.Delete
```

#### Milestone Routes (new)
```
/api/v1/repos/{owner}/{repo}/milestones             GET    - Milestone.List
/api/v1/repos/{owner}/{repo}/milestones             POST   - Milestone.Create
/api/v1/repos/{owner}/{repo}/milestones/{number}    GET    - Milestone.Get
/api/v1/repos/{owner}/{repo}/milestones/{number}    PATCH  - Milestone.Update
/api/v1/repos/{owner}/{repo}/milestones/{number}    DELETE - Milestone.Delete
```

#### Release Routes (new)
```
/api/v1/repos/{owner}/{repo}/releases                   GET    - Release.List
/api/v1/repos/{owner}/{repo}/releases                   POST   - Release.Create
/api/v1/repos/{owner}/{repo}/releases/latest            GET    - Release.GetLatest
/api/v1/repos/{owner}/{repo}/releases/tags/{tag}        GET    - Release.GetByTag
/api/v1/repos/{owner}/{repo}/releases/{id}              GET    - Release.Get
/api/v1/repos/{owner}/{repo}/releases/{id}              PATCH  - Release.Update
/api/v1/repos/{owner}/{repo}/releases/{id}              DELETE - Release.Delete
/api/v1/repos/{owner}/{repo}/releases/{id}/publish      PUT    - Release.Publish
/api/v1/repos/{owner}/{repo}/releases/{id}/assets       GET    - Release.ListAssets
/api/v1/repos/{owner}/{repo}/releases/{id}/assets       POST   - Release.UploadAsset
/api/v1/repos/{owner}/{repo}/releases/assets/{assetId}  GET    - Release.GetAsset
/api/v1/repos/{owner}/{repo}/releases/assets/{assetId}  PATCH  - Release.UpdateAsset
/api/v1/repos/{owner}/{repo}/releases/assets/{assetId}  DELETE - Release.DeleteAsset
```

#### Team Routes (new)
```
/api/v1/orgs/{org}/teams                        GET    - Team.List
/api/v1/orgs/{org}/teams                        POST   - Team.Create
/api/v1/orgs/{org}/teams/{team}                 GET    - Team.Get
/api/v1/orgs/{org}/teams/{team}                 PATCH  - Team.Update
/api/v1/orgs/{org}/teams/{team}                 DELETE - Team.Delete
/api/v1/orgs/{org}/teams/{team}/members         GET    - Team.ListMembers
/api/v1/orgs/{org}/teams/{team}/members/{username}  GET    - Team.GetMember
/api/v1/orgs/{org}/teams/{team}/members/{username}  PUT    - Team.AddMember
/api/v1/orgs/{org}/teams/{team}/members/{username}  PATCH  - Team.UpdateMemberRole
/api/v1/orgs/{org}/teams/{team}/members/{username}  DELETE - Team.RemoveMember
/api/v1/orgs/{org}/teams/{team}/repos           GET    - Team.ListRepos
/api/v1/orgs/{org}/teams/{team}/repos/{owner}/{repo}  GET    - Team.GetRepoAccess
/api/v1/orgs/{org}/teams/{team}/repos/{owner}/{repo}  PUT    - Team.AddRepo
/api/v1/orgs/{org}/teams/{team}/repos/{owner}/{repo}  PATCH  - Team.UpdateRepoPermission
/api/v1/orgs/{org}/teams/{team}/repos/{owner}/{repo}  DELETE - Team.RemoveRepo
/api/v1/user/teams                              GET    - Team.ListUserTeams
```

#### Webhook Routes (new)
```
/api/v1/repos/{owner}/{repo}/hooks              GET    - Webhook.ListByRepo
/api/v1/repos/{owner}/{repo}/hooks              POST   - Webhook.Create
/api/v1/repos/{owner}/{repo}/hooks/{id}         GET    - Webhook.Get
/api/v1/repos/{owner}/{repo}/hooks/{id}         PATCH  - Webhook.Update
/api/v1/repos/{owner}/{repo}/hooks/{id}         DELETE - Webhook.Delete
/api/v1/repos/{owner}/{repo}/hooks/{id}/pings   POST   - Webhook.Ping
/api/v1/repos/{owner}/{repo}/hooks/{id}/tests   POST   - Webhook.Test
/api/v1/repos/{owner}/{repo}/hooks/{id}/deliveries        GET  - Webhook.ListDeliveries
/api/v1/repos/{owner}/{repo}/hooks/{id}/deliveries/{did}  GET  - Webhook.GetDelivery
/api/v1/repos/{owner}/{repo}/hooks/{id}/deliveries/{did}  POST - Webhook.Redeliver
/api/v1/orgs/{org}/hooks                        GET    - Webhook.ListByOrg
/api/v1/orgs/{org}/hooks                        POST   - Webhook.Create
/api/v1/orgs/{org}/hooks/{id}                   GET    - Webhook.Get
/api/v1/orgs/{org}/hooks/{id}                   PATCH  - Webhook.Update
/api/v1/orgs/{org}/hooks/{id}                   DELETE - Webhook.Delete
```

## 4. Implementation Steps

### Step 1: Create api/ directory structure
1. Create `app/web/handler/api/` directory
2. Move and update existing handlers:
   - `auth.go` -> `api/auth.go`
   - `user.go` -> `api/user.go`
   - `repo.go` -> `api/repo.go`
   - `issue.go` -> `api/issue.go`
   - `response.go` -> `api/response.go`
3. Update package declaration from `handler` to `api`
4. Keep `page.go` in `handler/` package

### Step 2: Update server.go
1. Update imports to use new `api` package
2. Update handler instantiation
3. Add new service dependencies (pulls, orgs, labels, milestones, releases, teams, webhooks)

### Step 3: Add missing methods to existing handlers
1. User handler: Delete, ChangePassword, List, GetByEmail
2. Repo handler: Fork, ListForks, CheckStarred, GetPermission
3. Issue handler: Close, Reopen, SetLabels, AddAssignees, RemoveAssignees, UpdateComment, DeleteComment

### Step 4: Create new handlers
1. `api/pull.go` - Pull request handler
2. `api/org.go` - Organization handler
3. `api/label.go` - Label handler
4. `api/milestone.go` - Milestone handler
5. `api/release.go` - Release handler
6. `api/team.go` - Team handler
7. `api/webhook.go` - Webhook handler

### Step 5: Update server.go with new routes
Add all new API routes to the router

### Step 6: Create E2E tests
Create comprehensive `app/web/server_e2e_test.go` that tests:
- All authentication endpoints
- User CRUD and password management
- Repository CRUD, forking, starring
- Issue CRUD, comments, labels, assignees
- Pull request workflows
- Organization management
- Team management
- Release management
- Webhook management

## 5. Test Coverage

### E2E Test Categories
1. **Auth Tests**
   - Register new user
   - Login/logout
   - Session validation

2. **User Tests**
   - Get/update profile
   - Change password
   - Delete account
   - List users

3. **Repository Tests**
   - Create/read/update/delete repos
   - Star/unstar
   - Fork repos
   - Collaborator management

4. **Issue Tests**
   - Full issue lifecycle
   - Comments
   - Labels
   - Assignees
   - Lock/unlock

5. **Pull Request Tests**
   - Create/update PRs
   - Review workflow
   - Merge

6. **Organization Tests**
   - Create/manage orgs
   - Member management

7. **Team Tests**
   - Team CRUD
   - Member management
   - Repository access

8. **Release Tests**
   - Create releases
   - Asset management

9. **Webhook Tests**
   - CRUD
   - Ping/test
   - Deliveries
