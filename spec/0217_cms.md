# CMS Blueprint Specification

**Version**: 1.0.0
**Status**: Draft
**Blueprint**: `cms`
**Compatibility**: WordPress REST API v2 + XML-RPC API

## Overview

The CMS blueprint is a WordPress-compatible content management system built on the Mizu framework. It provides 100% feature parity with WordPress and full API compatibility with both the WordPress REST API v2 and the legacy XML-RPC API.

## Goals

1. **Full WordPress Feature Parity**: Support all WordPress core features
2. **REST API v2 Compatibility**: Drop-in replacement for WordPress REST API
3. **XML-RPC Compatibility**: Support legacy integrations (wp.*, blogger.*, metaWeblog.*)
4. **Plugin Architecture**: Extensible hook system (actions and filters)
5. **Theme Support**: Template hierarchy and theme customization
6. **Performance**: Optimized for high-traffic sites with caching

---

## Core Features

### 1. Content Types

#### 1.1 Posts
- Standard blog posts with title, content, excerpt
- Post formats: standard, aside, gallery, link, image, quote, status, video, audio, chat
- Post statuses: publish, draft, pending, private, future, trash, auto-draft, inherit
- Sticky posts support
- Password-protected posts
- Scheduled publishing (future posts)
- Revisions and autosave
- Post meta (custom fields)
- Featured images (post thumbnails)

#### 1.2 Pages
- Hierarchical content (parent/child relationships)
- Page templates
- Page order for manual sorting
- Page meta (custom fields)

#### 1.3 Custom Post Types
- Register custom post types dynamically
- Support for all built-in features (title, editor, thumbnail, etc.)
- Custom capabilities
- Custom taxonomies
- REST API support
- Archive pages

#### 1.4 Media Library
- Upload and manage images, videos, audio, documents
- Image sizes: thumbnail, medium, large, full, custom
- Image editing: crop, rotate, flip, scale
- Attachment metadata (EXIF, dimensions, etc.)
- Alt text, captions, descriptions
- Galleries
- Media categories (optional taxonomy)

#### 1.5 Attachments
- File uploads with validation
- MIME type detection
- Secure file storage
- URL generation

### 2. Taxonomies

#### 2.1 Categories
- Hierarchical taxonomy for posts
- Parent/child relationships
- Category descriptions
- Category images (extended)

#### 2.2 Tags
- Flat taxonomy for posts
- Tag descriptions
- Tag clouds

#### 2.3 Custom Taxonomies
- Register custom taxonomies
- Hierarchical or flat
- Associated with any post type
- Custom capabilities

### 3. Users & Authentication

#### 3.1 User Roles
- **Super Admin**: Multisite network admin
- **Administrator**: Full site access
- **Editor**: Manage all content
- **Author**: Manage own content
- **Contributor**: Write but not publish
- **Subscriber**: Read only

#### 3.2 Capabilities
- Granular permission system
- Role-based access control
- Custom capabilities
- Capability mapping

#### 3.3 User Management
- User registration (with/without admin approval)
- User profiles (display name, bio, avatar, social links)
- Password reset via email
- Two-factor authentication (extended)
- Session management
- User meta

#### 3.4 Authentication Methods
- Cookie-based authentication
- Application passwords (REST API)
- OAuth 2.0 (extended)
- JWT tokens (extended)
- XML-RPC authentication

### 4. Comments

#### 4.1 Comment System
- Threaded/nested comments
- Comment moderation (pending, approved, spam, trash)
- Comment author info (name, email, URL)
- Gravatar support
- Comment meta

#### 4.2 Moderation
- Comment blacklist (words, IPs, emails)
- Comment moderation queue
- Bulk actions
- Akismet-compatible spam filtering

#### 4.3 Pingbacks & Trackbacks
- Receive pingbacks
- Send pingbacks
- Trackback support

### 5. Menus

#### 5.1 Navigation Menus
- Multiple menu locations
- Nested menu items
- Menu item types: page, post, category, custom link, post type archive
- Menu item attributes (CSS classes, target, title)
- Menu assignments to theme locations

### 6. Widgets

#### 6.1 Widget System
- Widget areas (sidebars)
- Widget types: text, HTML, categories, recent posts, search, calendar, etc.
- Widget settings
- Widget visibility rules

### 7. Themes

#### 7.1 Theme System
- Theme activation
- Theme customization (Customizer)
- Theme options
- Template hierarchy
- Template parts
- Block themes (Full Site Editing)

#### 7.2 Template Hierarchy
```
index.php
├── home.php
├── front-page.php
├── singular.php
│   ├── single.php
│   │   ├── single-{post-type}.php
│   │   └── single-{post-type}-{slug}.php
│   └── page.php
│       ├── page-{slug}.php
│       └── page-{id}.php
├── archive.php
│   ├── author.php
│   ├── category.php
│   ├── tag.php
│   ├── taxonomy.php
│   └── date.php
├── search.php
├── 404.php
└── attachment.php
```

### 8. Plugins

#### 8.1 Hook System
- Actions: Execute code at specific points
- Filters: Modify data before use
- Priority levels
- Multiple callbacks per hook

#### 8.2 Plugin API
```go
// Register action
AddAction("init", callback, priority)

// Register filter
AddFilter("the_content", callback, priority)

// Execute action
DoAction("init", args...)

// Apply filters
ApplyFilters("the_content", content, args...)
```

### 9. Settings

#### 9.1 General Settings
- Site title and tagline
- WordPress/Site URL
- Admin email
- Membership settings
- Default role
- Site language
- Timezone
- Date/time format

#### 9.2 Writing Settings
- Default category
- Default post format
- Post via email
- Update services

#### 9.3 Reading Settings
- Front page display (latest posts/static page)
- Posts per page
- Search engine visibility
- RSS settings

#### 9.4 Discussion Settings
- Comment settings
- Moderation settings
- Avatar settings

#### 9.5 Media Settings
- Image sizes
- Upload path
- Organize uploads by date

#### 9.6 Permalinks
- Permalink structure
- Category/tag base
- Custom structures

### 10. Multisite

#### 10.1 Network Features
- Multiple sites in one installation
- Network admin dashboard
- Site creation/deletion
- Network-wide plugins
- Network-wide themes
- User role mapping across sites

---

## REST API v2 Specification

### Authentication

```
Authorization: Basic base64(username:password)
Authorization: Basic base64(username:application_password)
X-WP-Nonce: {nonce}
```

### Base URL

```
/wp-json/wp/v2/
```

### Endpoints

#### Posts
```
GET    /wp/v2/posts                 # List posts
POST   /wp/v2/posts                 # Create post
GET    /wp/v2/posts/{id}            # Get post
PUT    /wp/v2/posts/{id}            # Update post
PATCH  /wp/v2/posts/{id}            # Partial update
DELETE /wp/v2/posts/{id}            # Delete post (trash)
DELETE /wp/v2/posts/{id}?force=true # Permanently delete
GET    /wp/v2/posts/{id}/revisions  # List revisions
GET    /wp/v2/posts/{id}/revisions/{rev_id} # Get revision
DELETE /wp/v2/posts/{id}/revisions/{rev_id} # Delete revision
POST   /wp/v2/posts/{id}/autosaves  # Create autosave
GET    /wp/v2/posts/{id}/autosaves  # List autosaves
```

#### Post Schema
```json
{
  "id": 123,
  "date": "2024-01-15T10:30:00",
  "date_gmt": "2024-01-15T18:30:00",
  "guid": {"rendered": "https://example.com/?p=123"},
  "modified": "2024-01-15T10:30:00",
  "modified_gmt": "2024-01-15T18:30:00",
  "slug": "hello-world",
  "status": "publish",
  "type": "post",
  "link": "https://example.com/2024/01/hello-world/",
  "title": {"rendered": "Hello World"},
  "content": {"rendered": "<p>Content</p>", "protected": false},
  "excerpt": {"rendered": "<p>Excerpt</p>", "protected": false},
  "author": 1,
  "featured_media": 456,
  "comment_status": "open",
  "ping_status": "open",
  "sticky": false,
  "template": "",
  "format": "standard",
  "meta": {},
  "categories": [1, 2],
  "tags": [3, 4],
  "_links": {...}
}
```

#### Pages
```
GET    /wp/v2/pages
POST   /wp/v2/pages
GET    /wp/v2/pages/{id}
PUT    /wp/v2/pages/{id}
PATCH  /wp/v2/pages/{id}
DELETE /wp/v2/pages/{id}
```

#### Media
```
GET    /wp/v2/media
POST   /wp/v2/media                 # Upload (multipart/form-data)
GET    /wp/v2/media/{id}
PUT    /wp/v2/media/{id}
PATCH  /wp/v2/media/{id}
DELETE /wp/v2/media/{id}
POST   /wp/v2/media/{id}/edit       # Image editing
```

#### Comments
```
GET    /wp/v2/comments
POST   /wp/v2/comments
GET    /wp/v2/comments/{id}
PUT    /wp/v2/comments/{id}
PATCH  /wp/v2/comments/{id}
DELETE /wp/v2/comments/{id}
```

#### Categories
```
GET    /wp/v2/categories
POST   /wp/v2/categories
GET    /wp/v2/categories/{id}
PUT    /wp/v2/categories/{id}
PATCH  /wp/v2/categories/{id}
DELETE /wp/v2/categories/{id}
```

#### Tags
```
GET    /wp/v2/tags
POST   /wp/v2/tags
GET    /wp/v2/tags/{id}
PUT    /wp/v2/tags/{id}
PATCH  /wp/v2/tags/{id}
DELETE /wp/v2/tags/{id}
```

#### Users
```
GET    /wp/v2/users
POST   /wp/v2/users
GET    /wp/v2/users/{id}
PUT    /wp/v2/users/{id}
PATCH  /wp/v2/users/{id}
DELETE /wp/v2/users/{id}
GET    /wp/v2/users/me              # Current user
PUT    /wp/v2/users/me
DELETE /wp/v2/users/me
```

#### Taxonomies
```
GET    /wp/v2/taxonomies
GET    /wp/v2/taxonomies/{taxonomy}
```

#### Types (Post Types)
```
GET    /wp/v2/types
GET    /wp/v2/types/{type}
```

#### Statuses
```
GET    /wp/v2/statuses
GET    /wp/v2/statuses/{status}
```

#### Settings
```
GET    /wp/v2/settings
PUT    /wp/v2/settings
PATCH  /wp/v2/settings
```

#### Search
```
GET    /wp/v2/search?search={term}&type={post|term|post-format}
```

#### Block Types
```
GET    /wp/v2/block-types
GET    /wp/v2/block-types/{namespace}/{name}
```

#### Blocks
```
GET    /wp/v2/blocks
POST   /wp/v2/blocks
GET    /wp/v2/blocks/{id}
PUT    /wp/v2/blocks/{id}
DELETE /wp/v2/blocks/{id}
```

#### Themes
```
GET    /wp/v2/themes
GET    /wp/v2/themes/{stylesheet}
```

#### Plugins
```
GET    /wp/v2/plugins
POST   /wp/v2/plugins
GET    /wp/v2/plugins/{plugin}
PUT    /wp/v2/plugins/{plugin}
DELETE /wp/v2/plugins/{plugin}
```

#### Sidebars
```
GET    /wp/v2/sidebars
GET    /wp/v2/sidebars/{id}
PUT    /wp/v2/sidebars/{id}
```

#### Widgets
```
GET    /wp/v2/widgets
POST   /wp/v2/widgets
GET    /wp/v2/widgets/{id}
PUT    /wp/v2/widgets/{id}
DELETE /wp/v2/widgets/{id}
```

#### Widget Types
```
GET    /wp/v2/widget-types
GET    /wp/v2/widget-types/{id}
```

#### Menus
```
GET    /wp/v2/menus
POST   /wp/v2/menus
GET    /wp/v2/menus/{id}
PUT    /wp/v2/menus/{id}
DELETE /wp/v2/menus/{id}
```

#### Menu Items
```
GET    /wp/v2/menu-items
POST   /wp/v2/menu-items
GET    /wp/v2/menu-items/{id}
PUT    /wp/v2/menu-items/{id}
DELETE /wp/v2/menu-items/{id}
```

#### Menu Locations
```
GET    /wp/v2/menu-locations
GET    /wp/v2/menu-locations/{location}
```

### Query Parameters

#### Pagination
```
?page=1&per_page=10
```

#### Filtering
```
?status=publish,draft
?author=1,2,3
?author_exclude=4
?categories=1,2
?categories_exclude=3
?tags=1,2
?after=2024-01-01T00:00:00
?before=2024-12-31T23:59:59
?search=keyword
?slug=hello-world
?parent=0
?parent_exclude=1
```

#### Ordering
```
?orderby=date&order=desc
?orderby=title&order=asc
?orderby=id,author&order=asc,desc
```

#### Embedding
```
?_embed=author,wp:featuredmedia,wp:term
?_embed=true
```

#### Fields
```
?_fields=id,title,link
```

#### Context
```
?context=view   # Public data
?context=embed  # Minimal for embedding
?context=edit   # All data (authenticated)
```

### Response Headers
```
X-WP-Total: 100           # Total items
X-WP-TotalPages: 10       # Total pages
Link: <...>; rel="next"   # Pagination links
```

### Error Responses
```json
{
  "code": "rest_post_invalid_id",
  "message": "Invalid post ID.",
  "data": {
    "status": 404
  }
}
```

---

## XML-RPC API Specification

### Endpoint
```
/xmlrpc.php
```

### WordPress API Methods

#### Posts
```
wp.getPost(blog_id, username, password, post_id, fields)
wp.getPosts(blog_id, username, password, filter, fields)
wp.newPost(blog_id, username, password, content)
wp.editPost(blog_id, username, password, post_id, content)
wp.deletePost(blog_id, username, password, post_id)
wp.getPostType(blog_id, username, password, post_type, fields)
wp.getPostTypes(blog_id, username, password, filter, fields)
wp.getPostFormats(blog_id, username, password)
wp.getPostStatusList(blog_id, username, password)
```

#### Taxonomies & Terms
```
wp.getTaxonomy(blog_id, username, password, taxonomy)
wp.getTaxonomies(blog_id, username, password)
wp.getTerm(blog_id, username, password, taxonomy, term_id)
wp.getTerms(blog_id, username, password, taxonomy, filter)
wp.newTerm(blog_id, username, password, content)
wp.editTerm(blog_id, username, password, term_id, content)
wp.deleteTerm(blog_id, username, password, taxonomy, term_id)
```

#### Media
```
wp.getMediaItem(blog_id, username, password, attachment_id)
wp.getMediaLibrary(blog_id, username, password, filter)
wp.uploadFile(blog_id, username, password, data)
```

#### Comments
```
wp.getComment(blog_id, username, password, comment_id)
wp.getComments(blog_id, username, password, filter)
wp.newComment(blog_id, username, password, post_id, content)
wp.editComment(blog_id, username, password, comment_id, content)
wp.deleteComment(blog_id, username, password, comment_id)
wp.getCommentCount(blog_id, username, password, post_id)
wp.getCommentStatusList(blog_id, username, password)
```

#### Options
```
wp.getOptions(blog_id, username, password, options)
wp.setOptions(blog_id, username, password, options)
```

#### Users
```
wp.getUsers(blog_id, username, password, filter)
wp.getUser(blog_id, username, password, user_id, fields)
wp.getProfile(blog_id, username, password, fields)
wp.editProfile(blog_id, username, password, content)
wp.getUsersBlogs(username, password)
```

### Blogger API Methods
```
blogger.getUsersBlogs(appkey, username, password)
blogger.getUserInfo(appkey, username, password)
blogger.getPost(appkey, postid, username, password)
blogger.getRecentPosts(appkey, blogid, username, password, num)
blogger.newPost(appkey, blogid, username, password, content, publish)
blogger.editPost(appkey, postid, username, password, content, publish)
blogger.deletePost(appkey, postid, username, password, publish)
```

### MetaWeblog API Methods
```
metaWeblog.getPost(postid, username, password)
metaWeblog.getRecentPosts(blogid, username, password, num)
metaWeblog.newPost(blogid, username, password, struct, publish)
metaWeblog.editPost(postid, username, password, struct, publish)
metaWeblog.deletePost(appkey, postid, username, password, publish)
metaWeblog.getCategories(blogid, username, password)
metaWeblog.newMediaObject(blogid, username, password, data)
metaWeblog.getUsersBlogs(appkey, username, password)
```

### MovableType API Methods
```
mt.getRecentPostTitles(blogid, username, password, num)
mt.getCategoryList(blogid, username, password)
mt.getPostCategories(postid, username, password)
mt.setPostCategories(postid, username, password, categories)
mt.supportedMethods()
mt.supportedTextFilters()
mt.getTrackbackPings(postid)
mt.publishPost(postid, username, password)
```

### Pingback Methods
```
pingback.ping(sourceURI, targetURI)
pingback.extensions.getPingbacks(url)
```

---

## Database Schema

### Core Tables

```sql
-- Users
CREATE TABLE wp_users (
    ID BIGINT PRIMARY KEY,
    user_login VARCHAR(60) NOT NULL,
    user_pass VARCHAR(255) NOT NULL,
    user_nicename VARCHAR(50) NOT NULL,
    user_email VARCHAR(100) NOT NULL,
    user_url VARCHAR(100) DEFAULT '',
    user_registered TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    user_activation_key VARCHAR(255) DEFAULT '',
    user_status INTEGER DEFAULT 0,
    display_name VARCHAR(250) DEFAULT ''
);
CREATE UNIQUE INDEX idx_user_login ON wp_users(user_login);
CREATE UNIQUE INDEX idx_user_email ON wp_users(user_email);
CREATE INDEX idx_user_nicename ON wp_users(user_nicename);

-- User Meta
CREATE TABLE wp_usermeta (
    umeta_id BIGINT PRIMARY KEY,
    user_id BIGINT NOT NULL,
    meta_key VARCHAR(255),
    meta_value TEXT,
    FOREIGN KEY (user_id) REFERENCES wp_users(ID)
);
CREATE INDEX idx_usermeta_user_id ON wp_usermeta(user_id);
CREATE INDEX idx_usermeta_key ON wp_usermeta(meta_key);

-- Posts (includes pages, attachments, custom post types)
CREATE TABLE wp_posts (
    ID BIGINT PRIMARY KEY,
    post_author BIGINT NOT NULL DEFAULT 0,
    post_date TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    post_date_gmt TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    post_content TEXT NOT NULL,
    post_title TEXT NOT NULL,
    post_excerpt TEXT NOT NULL DEFAULT '',
    post_status VARCHAR(20) NOT NULL DEFAULT 'publish',
    comment_status VARCHAR(20) NOT NULL DEFAULT 'open',
    ping_status VARCHAR(20) NOT NULL DEFAULT 'open',
    post_password VARCHAR(255) NOT NULL DEFAULT '',
    post_name VARCHAR(200) NOT NULL DEFAULT '',
    to_ping TEXT NOT NULL DEFAULT '',
    pinged TEXT NOT NULL DEFAULT '',
    post_modified TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    post_modified_gmt TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    post_content_filtered TEXT NOT NULL DEFAULT '',
    post_parent BIGINT NOT NULL DEFAULT 0,
    guid VARCHAR(255) NOT NULL DEFAULT '',
    menu_order INTEGER NOT NULL DEFAULT 0,
    post_type VARCHAR(20) NOT NULL DEFAULT 'post',
    post_mime_type VARCHAR(100) NOT NULL DEFAULT '',
    comment_count BIGINT NOT NULL DEFAULT 0,
    FOREIGN KEY (post_author) REFERENCES wp_users(ID)
);
CREATE INDEX idx_post_name ON wp_posts(post_name);
CREATE INDEX idx_post_type_status_date ON wp_posts(post_type, post_status, post_date, ID);
CREATE INDEX idx_post_parent ON wp_posts(post_parent);
CREATE INDEX idx_post_author ON wp_posts(post_author);

-- Post Meta
CREATE TABLE wp_postmeta (
    meta_id BIGINT PRIMARY KEY,
    post_id BIGINT NOT NULL DEFAULT 0,
    meta_key VARCHAR(255),
    meta_value TEXT,
    FOREIGN KEY (post_id) REFERENCES wp_posts(ID)
);
CREATE INDEX idx_postmeta_post_id ON wp_postmeta(post_id);
CREATE INDEX idx_postmeta_key ON wp_postmeta(meta_key);

-- Terms (categories, tags, custom taxonomies)
CREATE TABLE wp_terms (
    term_id BIGINT PRIMARY KEY,
    name VARCHAR(200) NOT NULL,
    slug VARCHAR(200) NOT NULL,
    term_group BIGINT NOT NULL DEFAULT 0
);
CREATE INDEX idx_term_slug ON wp_terms(slug);
CREATE INDEX idx_term_name ON wp_terms(name);

-- Term Taxonomy
CREATE TABLE wp_term_taxonomy (
    term_taxonomy_id BIGINT PRIMARY KEY,
    term_id BIGINT NOT NULL DEFAULT 0,
    taxonomy VARCHAR(32) NOT NULL DEFAULT '',
    description TEXT NOT NULL DEFAULT '',
    parent BIGINT NOT NULL DEFAULT 0,
    count BIGINT NOT NULL DEFAULT 0,
    FOREIGN KEY (term_id) REFERENCES wp_terms(term_id)
);
CREATE UNIQUE INDEX idx_term_id_taxonomy ON wp_term_taxonomy(term_id, taxonomy);
CREATE INDEX idx_taxonomy ON wp_term_taxonomy(taxonomy);

-- Term Relationships
CREATE TABLE wp_term_relationships (
    object_id BIGINT NOT NULL DEFAULT 0,
    term_taxonomy_id BIGINT NOT NULL DEFAULT 0,
    term_order INTEGER NOT NULL DEFAULT 0,
    PRIMARY KEY (object_id, term_taxonomy_id),
    FOREIGN KEY (term_taxonomy_id) REFERENCES wp_term_taxonomy(term_taxonomy_id)
);
CREATE INDEX idx_term_taxonomy_id ON wp_term_relationships(term_taxonomy_id);

-- Term Meta
CREATE TABLE wp_termmeta (
    meta_id BIGINT PRIMARY KEY,
    term_id BIGINT NOT NULL DEFAULT 0,
    meta_key VARCHAR(255),
    meta_value TEXT,
    FOREIGN KEY (term_id) REFERENCES wp_terms(term_id)
);
CREATE INDEX idx_termmeta_term_id ON wp_termmeta(term_id);
CREATE INDEX idx_termmeta_key ON wp_termmeta(meta_key);

-- Comments
CREATE TABLE wp_comments (
    comment_ID BIGINT PRIMARY KEY,
    comment_post_ID BIGINT NOT NULL DEFAULT 0,
    comment_author TEXT NOT NULL,
    comment_author_email VARCHAR(100) NOT NULL DEFAULT '',
    comment_author_url VARCHAR(200) NOT NULL DEFAULT '',
    comment_author_IP VARCHAR(100) NOT NULL DEFAULT '',
    comment_date TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    comment_date_gmt TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    comment_content TEXT NOT NULL,
    comment_karma INTEGER NOT NULL DEFAULT 0,
    comment_approved VARCHAR(20) NOT NULL DEFAULT '1',
    comment_agent VARCHAR(255) NOT NULL DEFAULT '',
    comment_type VARCHAR(20) NOT NULL DEFAULT 'comment',
    comment_parent BIGINT NOT NULL DEFAULT 0,
    user_id BIGINT NOT NULL DEFAULT 0,
    FOREIGN KEY (comment_post_ID) REFERENCES wp_posts(ID)
);
CREATE INDEX idx_comment_post_ID ON wp_comments(comment_post_ID);
CREATE INDEX idx_comment_approved_date ON wp_comments(comment_approved, comment_date_gmt);
CREATE INDEX idx_comment_parent ON wp_comments(comment_parent);
CREATE INDEX idx_comment_author_email ON wp_comments(comment_author_email);

-- Comment Meta
CREATE TABLE wp_commentmeta (
    meta_id BIGINT PRIMARY KEY,
    comment_id BIGINT NOT NULL DEFAULT 0,
    meta_key VARCHAR(255),
    meta_value TEXT,
    FOREIGN KEY (comment_id) REFERENCES wp_comments(comment_ID)
);
CREATE INDEX idx_commentmeta_comment_id ON wp_commentmeta(comment_id);
CREATE INDEX idx_commentmeta_key ON wp_commentmeta(meta_key);

-- Options
CREATE TABLE wp_options (
    option_id BIGINT PRIMARY KEY,
    option_name VARCHAR(191) NOT NULL,
    option_value TEXT NOT NULL,
    autoload VARCHAR(20) NOT NULL DEFAULT 'yes'
);
CREATE UNIQUE INDEX idx_option_name ON wp_options(option_name);
CREATE INDEX idx_autoload ON wp_options(autoload);

-- Links (blogroll, deprecated but still supported)
CREATE TABLE wp_links (
    link_id BIGINT PRIMARY KEY,
    link_url VARCHAR(255) NOT NULL DEFAULT '',
    link_name VARCHAR(255) NOT NULL DEFAULT '',
    link_image VARCHAR(255) NOT NULL DEFAULT '',
    link_target VARCHAR(25) NOT NULL DEFAULT '',
    link_description VARCHAR(255) NOT NULL DEFAULT '',
    link_visible VARCHAR(20) NOT NULL DEFAULT 'Y',
    link_owner BIGINT NOT NULL DEFAULT 1,
    link_rating INTEGER NOT NULL DEFAULT 0,
    link_updated TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    link_rel VARCHAR(255) NOT NULL DEFAULT '',
    link_notes TEXT NOT NULL DEFAULT '',
    link_rss VARCHAR(255) NOT NULL DEFAULT ''
);
CREATE INDEX idx_link_visible ON wp_links(link_visible);

-- Sessions (extended for token-based auth)
CREATE TABLE wp_sessions (
    session_id VARCHAR(64) PRIMARY KEY,
    user_id BIGINT NOT NULL,
    token VARCHAR(255) NOT NULL,
    ip_address VARCHAR(45),
    user_agent TEXT,
    payload TEXT,
    last_activity TIMESTAMP NOT NULL,
    expires_at TIMESTAMP NOT NULL,
    FOREIGN KEY (user_id) REFERENCES wp_users(ID)
);
CREATE INDEX idx_session_user ON wp_sessions(user_id);
CREATE INDEX idx_session_token ON wp_sessions(token);

-- Application Passwords
CREATE TABLE wp_application_passwords (
    id BIGINT PRIMARY KEY,
    user_id BIGINT NOT NULL,
    uuid VARCHAR(36) NOT NULL,
    app_id VARCHAR(255),
    name VARCHAR(255) NOT NULL,
    password VARCHAR(255) NOT NULL,
    created TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    last_used TIMESTAMP,
    last_ip VARCHAR(45),
    FOREIGN KEY (user_id) REFERENCES wp_users(ID)
);
CREATE INDEX idx_app_password_user ON wp_application_passwords(user_id);
CREATE UNIQUE INDEX idx_app_password_uuid ON wp_application_passwords(uuid);

-- Menus (nav menus stored in terms, menu items in posts)
-- Menu items use post_type = 'nav_menu_item'
-- Menus use taxonomy = 'nav_menu'

-- Widgets (stored in options as serialized data)
-- widget_* options store widget instances
-- sidebars_widgets option stores sidebar assignments

-- Revisions (stored as posts with post_type = 'revision')
-- post_parent = original post ID

-- Autosaves (stored as posts with post_type = 'revision', post_name = '{parent_id}-autosave-v1')
```

### Multisite Tables (Optional)

```sql
-- Sites
CREATE TABLE wp_blogs (
    blog_id BIGINT PRIMARY KEY,
    site_id BIGINT NOT NULL DEFAULT 1,
    domain VARCHAR(200) NOT NULL DEFAULT '',
    path VARCHAR(100) NOT NULL DEFAULT '/',
    registered TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    last_updated TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    public INTEGER NOT NULL DEFAULT 1,
    archived INTEGER NOT NULL DEFAULT 0,
    mature INTEGER NOT NULL DEFAULT 0,
    spam INTEGER NOT NULL DEFAULT 0,
    deleted INTEGER NOT NULL DEFAULT 0,
    lang_id INTEGER NOT NULL DEFAULT 0
);
CREATE INDEX idx_blog_domain_path ON wp_blogs(domain, path);

-- Site
CREATE TABLE wp_site (
    id BIGINT PRIMARY KEY,
    domain VARCHAR(200) NOT NULL DEFAULT '',
    path VARCHAR(100) NOT NULL DEFAULT '/'
);
CREATE INDEX idx_site_domain ON wp_site(domain, path);

-- Site Meta
CREATE TABLE wp_sitemeta (
    meta_id BIGINT PRIMARY KEY,
    site_id BIGINT NOT NULL DEFAULT 0,
    meta_key VARCHAR(255),
    meta_value TEXT
);
CREATE INDEX idx_sitemeta_site_id ON wp_sitemeta(site_id);
CREATE INDEX idx_sitemeta_key ON wp_sitemeta(meta_key);

-- Blog Versions
CREATE TABLE wp_blog_versions (
    blog_id BIGINT PRIMARY KEY,
    db_version VARCHAR(20) NOT NULL DEFAULT '',
    last_updated TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- Registration Log
CREATE TABLE wp_registration_log (
    ID BIGINT PRIMARY KEY,
    email VARCHAR(255) NOT NULL DEFAULT '',
    IP VARCHAR(30) NOT NULL DEFAULT '',
    blog_id BIGINT NOT NULL DEFAULT 0,
    date_registered TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);
CREATE INDEX idx_registration_ip ON wp_registration_log(IP);

-- Signups
CREATE TABLE wp_signups (
    signup_id BIGINT PRIMARY KEY,
    domain VARCHAR(200) NOT NULL DEFAULT '',
    path VARCHAR(100) NOT NULL DEFAULT '',
    title TEXT NOT NULL,
    user_login VARCHAR(60) NOT NULL DEFAULT '',
    user_email VARCHAR(100) NOT NULL DEFAULT '',
    registered TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    activated TIMESTAMP NOT NULL DEFAULT '0000-00-00 00:00:00',
    active INTEGER NOT NULL DEFAULT 0,
    activation_key VARCHAR(50) NOT NULL DEFAULT '',
    meta TEXT
);
CREATE INDEX idx_signup_activation_key ON wp_signups(activation_key);
CREATE INDEX idx_signup_user ON wp_signups(user_login, user_email);
```

---

## Directory Structure

```
cms/
├── cmd/
│   └── cms/
│       └── main.go                    # CLI entry point
├── cli/
│   ├── root.go                        # Root command
│   ├── serve.go                       # serve command
│   ├── init.go                        # init command (db setup)
│   ├── seed.go                        # seed command (sample data)
│   ├── install.go                     # WordPress-style 5-minute install
│   └── ui.go                          # Terminal UI helpers
├── app/
│   └── web/
│       ├── server.go                  # Server initialization
│       ├── middleware/
│       │   ├── auth.go                # Authentication middleware
│       │   ├── nonce.go               # Nonce verification
│       │   └── capability.go          # Capability checks
│       ├── handler/
│       │   ├── common.go              # Common handlers & response helpers
│       │   ├── rest/                  # REST API v2 handlers
│       │   │   ├── posts.go
│       │   │   ├── pages.go
│       │   │   ├── media.go
│       │   │   ├── comments.go
│       │   │   ├── categories.go
│       │   │   ├── tags.go
│       │   │   ├── users.go
│       │   │   ├── taxonomies.go
│       │   │   ├── types.go
│       │   │   ├── statuses.go
│       │   │   ├── settings.go
│       │   │   ├── search.go
│       │   │   ├── menus.go
│       │   │   ├── widgets.go
│       │   │   ├── themes.go
│       │   │   ├── plugins.go
│       │   │   └── blocks.go
│       │   ├── xmlrpc/                # XML-RPC handlers
│       │   │   ├── handler.go
│       │   │   ├── wp.go              # wp.* methods
│       │   │   ├── blogger.go         # blogger.* methods
│       │   │   ├── metaweblog.go      # metaWeblog.* methods
│       │   │   ├── mt.go              # mt.* methods
│       │   │   └── pingback.go        # pingback.* methods
│       │   ├── admin/                 # Admin dashboard handlers
│       │   │   ├── dashboard.go
│       │   │   ├── posts.go
│       │   │   ├── pages.go
│       │   │   ├── media.go
│       │   │   ├── comments.go
│       │   │   ├── users.go
│       │   │   ├── appearance.go
│       │   │   ├── plugins.go
│       │   │   ├── settings.go
│       │   │   └── tools.go
│       │   └── frontend/              # Frontend theme handlers
│       │       ├── home.go
│       │       ├── single.go
│       │       ├── page.go
│       │       ├── archive.go
│       │       ├── search.go
│       │       ├── feed.go
│       │       └── sitemap.go
│       └── server_test.go
├── feature/
│   ├── accounts/                      # User management
│   │   ├── api.go
│   │   └── service.go
│   ├── posts/                         # Posts, pages, CPT
│   │   ├── api.go
│   │   └── service.go
│   ├── terms/                         # Categories, tags, custom taxonomies
│   │   ├── api.go
│   │   └── service.go
│   ├── comments/                      # Comment system
│   │   ├── api.go
│   │   └── service.go
│   ├── media/                         # Media library
│   │   ├── api.go
│   │   ├── service.go
│   │   └── image.go                   # Image processing
│   ├── menus/                         # Navigation menus
│   │   ├── api.go
│   │   └── service.go
│   ├── widgets/                       # Widget system
│   │   ├── api.go
│   │   └── service.go
│   ├── options/                       # Site options
│   │   ├── api.go
│   │   └── service.go
│   ├── hooks/                         # Actions & filters
│   │   ├── api.go
│   │   └── hooks.go
│   ├── themes/                        # Theme management
│   │   ├── api.go
│   │   └── service.go
│   ├── plugins/                       # Plugin management
│   │   ├── api.go
│   │   └── service.go
│   ├── rewrite/                       # Permalink rewriting
│   │   ├── api.go
│   │   └── service.go
│   └── multisite/                     # Multisite features
│       ├── api.go
│       └── service.go
├── store/
│   └── duckdb/
│       ├── store.go                   # Store initialization
│       ├── schema.sql                 # Full database schema
│       ├── users_store.go
│       ├── usermeta_store.go
│       ├── posts_store.go
│       ├── postmeta_store.go
│       ├── terms_store.go
│       ├── termmeta_store.go
│       ├── term_taxonomy_store.go
│       ├── term_relationships_store.go
│       ├── comments_store.go
│       ├── commentmeta_store.go
│       ├── options_store.go
│       ├── sessions_store.go
│       ├── links_store.go
│       └── multisite_store.go
├── pkg/
│   ├── ulid/                          # ID generation
│   ├── password/                      # Bcrypt hashing (wp_hash_password compat)
│   ├── phpass/                        # PHPass compatibility for legacy passwords
│   ├── xmlrpc/                        # XML-RPC parser/encoder
│   ├── shortcode/                     # Shortcode processor
│   ├── blocks/                        # Block parser (Gutenberg)
│   ├── kses/                          # HTML sanitization (wp_kses)
│   ├── formatting/                    # Text formatting (wptexturize, etc.)
│   ├── media/                         # Image processing
│   ├── feed/                          # RSS/Atom generation
│   ├── sitemap/                       # XML sitemap generation
│   ├── cron/                          # WP-Cron compatible scheduler
│   ├── mail/                          # wp_mail compatible
│   ├── oembed/                        # oEmbed support
│   └── capability/                    # Role & capability helpers
├── assets/
│   ├── static/
│   │   ├── css/
│   │   ├── js/
│   │   └── images/
│   └── views/
│       ├── admin/                     # Admin templates
│       └── themes/
│           └── twentytwentyfive/      # Default theme
├── uploads/                           # Media uploads directory
├── plugins/                           # Plugins directory
├── themes/                            # Themes directory
├── go.mod
├── go.sum
├── Makefile
└── README.md
```

---

## Implementation Phases

### Phase 1: Core Foundation
1. Database schema and store layer
2. User management with WordPress-compatible password hashing
3. Basic authentication (sessions, application passwords)
4. Options system
5. Basic CLI (init, serve)

### Phase 2: Content Management
1. Posts CRUD with all fields
2. Pages with hierarchy
3. Revisions and autosaves
4. Categories and tags
5. Post meta
6. REST API for posts, pages, terms

### Phase 3: Media Library
1. File upload handling
2. Image processing (resize, crop)
3. Attachment metadata
4. Gallery support
5. REST API for media

### Phase 4: Comments
1. Comment CRUD
2. Threaded comments
3. Moderation workflow
4. Comment meta
5. REST API for comments

### Phase 5: REST API Complete
1. All remaining endpoints
2. Query parameters
3. Embedding
4. Authentication methods
5. Error handling

### Phase 6: XML-RPC API
1. XML-RPC parser
2. WordPress API methods
3. Blogger API methods
4. MetaWeblog API methods
5. Pingback support

### Phase 7: Themes & Templates
1. Template hierarchy
2. Theme API
3. Default theme
4. Customizer basics
5. Menus and widgets

### Phase 8: Admin Dashboard
1. Dashboard UI
2. Post editor
3. Media manager
4. User management
5. Settings pages

### Phase 9: Advanced Features
1. Custom post types
2. Custom taxonomies
3. Shortcodes
4. Blocks (Gutenberg)
5. Hooks (actions/filters)
6. Cron system

### Phase 10: Multisite
1. Network installation
2. Site management
3. Network admin
4. Per-site tables
5. Domain mapping

---

## API Compatibility Testing

### REST API Test Suite
- Use official WordPress REST API test cases
- Verify response schemas match WordPress
- Test pagination, filtering, embedding
- Test authentication methods
- Test error responses

### XML-RPC Test Suite
- Use official WordPress XML-RPC test cases
- Test with common blog clients (Windows Live Writer, etc.)
- Test with WordPress mobile apps
- Test pingback functionality

### Integration Testing
- Test with popular WordPress plugins (Jetpack, Yoast, etc.)
- Test with WordPress themes
- Test with headless CMS setups (Next.js, Gatsby)
- Test with WordPress CLI (wp-cli)

---

## Performance Considerations

1. **Caching**
   - Object cache (Redis/Memcached compatible)
   - Transient API
   - Query caching
   - Full page caching

2. **Database**
   - Efficient indexes
   - Query optimization
   - Connection pooling

3. **Media**
   - Lazy loading
   - Responsive images
   - CDN support

4. **API**
   - Response compression
   - Rate limiting
   - Conditional requests (ETag, If-Modified-Since)

---

## Security Considerations

1. **Authentication**
   - Secure session management
   - Password strength requirements
   - Brute force protection
   - Two-factor authentication

2. **Authorization**
   - Capability-based access control
   - Nonce verification
   - CSRF protection

3. **Input Validation**
   - SQL injection prevention (parameterized queries)
   - XSS prevention (wp_kses)
   - File upload validation
   - MIME type verification

4. **Output Encoding**
   - Proper escaping functions
   - Content-Type headers
   - CSP headers

---

## Compatibility Notes

### Password Hashing
WordPress uses PHPass with portable hashes. For compatibility:
- Support both PHPass and bcrypt
- Auto-upgrade PHPass hashes to bcrypt on login
- New passwords use bcrypt

### Serialized Data
WordPress stores serialized PHP arrays in many places:
- Implement PHP serialize/unserialize
- Support meta values as JSON alternative
- Auto-convert on read/write

### Timezone Handling
- Store dates in GMT
- Convert to local timezone for display
- Support timezone_string and gmt_offset options

### Character Encoding
- UTF-8 throughout
- Support mb4 for emoji
- Proper escaping for different contexts
