# FineWiki API Design

## Overview

This document describes the design for adding a JSON API layer to FineWiki with OpenAPI documentation using the mizu contract pattern.

## Goals

1. **API-first endpoints** at `/api/...` for programmatic access
2. **OpenAPI 3.0 spec** at `/openapi.json` for client generation
3. **Interactive docs** at `/docs` using Scalar UI
4. **Best DX** with consistent error responses, proper HTTP methods, and clear schemas

## Current State

FineWiki has two feature services:
- `view.Service` - fetches wiki pages by ID or title
- `search.Service` - searches titles with prefix matching and optional FTS

These use plain Go method signatures that don't match the contract pattern requirement of `(ctx, *In) (*Out, error)`.

## Design

### API Endpoints

| Method | Path | Description |
|--------|------|-------------|
| `GET` | `/api/pages/{id}` | Get page by ID (e.g., `viwiki/123`) |
| `GET` | `/api/pages` | Get page by wiki and title query params |
| `GET` | `/api/search` | Search for pages by title prefix |
| `GET` | `/openapi.json` | OpenAPI 3.0 spec |
| `GET` | `/docs` | Interactive API documentation |

### Contract Interface

Create a new unified API interface in `feature/api/contract.go`:

```go
type WikiAPI interface {
    GetPage(ctx context.Context, in *GetPageIn) (*view.Page, error)
    Search(ctx context.Context, in *SearchIn) (*SearchOut, error)
}

type GetPageIn struct {
    ID       string `json:"id,omitempty"`       // Page ID like "viwiki/123"
    WikiName string `json:"wikiname,omitempty"` // Wiki name like "viwiki"
    Title    string `json:"title,omitempty"`    // Page title
}

type SearchIn struct {
    Text       string `json:"q"`                    // Search query (required)
    WikiName   string `json:"wikiname,omitempty"`   // Filter by wiki
    InLanguage string `json:"in_language,omitempty"`// Filter by language
    Limit      int    `json:"limit,omitempty"`      // Max results (default 20)
    EnableFTS  bool   `json:"fts,omitempty"`        // Enable full-text search
}

type SearchOut struct {
    Results []search.Result `json:"results"`
    Count   int             `json:"count"`
}
```

### HTTP Bindings

```go
contract.WithHTTP(map[string]contract.HTTPBinding{
    "GetPage": {Method: "GET", Path: "/pages"},
    "Search":  {Method: "GET", Path: "/search"},
})
```

For GetPage with ID in path:
- `/api/pages?id=viwiki/123` - by ID
- `/api/pages?wikiname=viwiki&title=Foo` - by wiki/title

### Error Responses

Standard JSON error format:
```json
{
    "error": "page not found",
    "code": "NOT_FOUND"
}
```

### Implementation Plan

1. **Create `feature/api/` package**
   - `contract.go` - Interface definition and input/output types
   - `service.go` - Implementation wrapping view and search services

2. **Update `app/web/server.go`**
   - Register the API contract
   - Mount at `/api` prefix using `rest.MountAt()`
   - Add `/openapi.json` handler
   - Add `/docs` handler using `openapi.NewHandler()`

3. **Add end-to-end tests**
   - `app/web/api_e2e_test.go` - Tests with real DuckDB store
   - Run with `E2E_TEST=1 go test ./app/web -run E2E`

### File Changes

```
blueprints/finewiki/
├── feature/api/
│   ├── contract.go    (new) - Interface + types
│   └── service.go     (new) - Implementation
├── app/web/
│   ├── server.go      (mod) - Mount API, docs
│   └── api_e2e_test.go (new) - E2E tests
└── store/duckdb/
    └── seed.sql       (mod) - Fix duplicate keys (done)
```

### Dependencies

Add to go.mod:
```
github.com/go-mizu/mizu/contract/v2
github.com/go-mizu/mizu/openapi
```

### Testing

E2E tests exercise the full stack:
1. Start server with real DuckDB store
2. Make HTTP requests to API endpoints
3. Verify JSON responses match expected schemas

Run with: `E2E_TEST=1 go test ./app/web -run E2E`
