# 0200: GitHome Git Operations Implementation

This document specifies the Git operations layer for GitHome, implementing the `feature/git` service using the `pkg/git` wrapper around go-git.

## Overview

The Git feature provides low-level Git data access following GitHub's Git Database API patterns. It enables:
- Reading and writing Git blobs, trees, commits, tags, and references
- Direct access to repository objects via SHA
- Creating commits programmatically without working directories

## Architecture

```
HTTP Handler (app/web/handler/api/git.go)
    ↓
Service Layer (feature/git/service.go)
    ↓
Git Wrapper (pkg/git/repository.go)
    ↓
go-git Library (github.com/go-git/go-git/v5)
    ↓
Repository Storage (bare repos on filesystem)
```

## Package Structure

```
pkg/git/
├── repository.go       # Repository wrapper with core operations
├── blob.go            # Blob operations
├── commit.go          # Commit operations
├── tree.go            # Tree operations
├── tag.go             # Tag operations
├── ref.go             # Reference operations
├── errors.go          # Error definitions
├── hash.go            # SHA/hash utilities
└── repository_test.go # Integration tests

feature/git/
├── api.go             # Types, interfaces, errors
├── service.go         # Business logic using pkg/git
└── service_test.go    # Service tests with mocks
```

## Dependencies

Add to `go.mod`:
```go
require (
    github.com/go-git/go-git/v5 v5.13.2
)
```

## pkg/git Package Specification

### Repository Interface

```go
// Repository wraps a git repository for object operations
type Repository struct {
    repo *git.Repository
    path string
}

// Open opens an existing repository
func Open(path string) (*Repository, error)

// Init creates a new bare repository
func Init(path string) (*Repository, error)

// Clone clones a repository
func Clone(url, path string, opts *CloneOptions) (*Repository, error)
```

### Blob Operations

```go
// GetBlob retrieves a blob by SHA
func (r *Repository) GetBlob(sha string) (*Blob, error)

// CreateBlob creates a new blob and returns its SHA
func (r *Repository) CreateBlob(content []byte) (string, error)

// Blob represents a git blob object
type Blob struct {
    SHA      string
    Size     int64
    Content  []byte
}
```

### Commit Operations

```go
// GetCommit retrieves a commit by SHA
func (r *Repository) GetCommit(sha string) (*Commit, error)

// CreateCommit creates a new commit
func (r *Repository) CreateCommit(opts *CreateCommitOpts) (string, error)

// CreateCommitOpts contains options for creating a commit
type CreateCommitOpts struct {
    Message   string
    TreeSHA   string
    Parents   []string
    Author    Signature
    Committer Signature
}

// Commit represents a git commit object
type Commit struct {
    SHA       string
    TreeSHA   string
    Parents   []string
    Author    Signature
    Committer Signature
    Message   string
}

// Signature represents author/committer info
type Signature struct {
    Name  string
    Email string
    When  time.Time
}
```

### Tree Operations

```go
// GetTree retrieves a tree by SHA
func (r *Repository) GetTree(sha string) (*Tree, error)

// GetTreeRecursive retrieves a tree with all nested entries
func (r *Repository) GetTreeRecursive(sha string) (*Tree, error)

// CreateTree creates a new tree
func (r *Repository) CreateTree(opts *CreateTreeOpts) (string, error)

// CreateTreeOpts contains options for creating a tree
type CreateTreeOpts struct {
    BaseSHA string        // Optional base tree to modify
    Entries []TreeEntry
}

// Tree represents a git tree object
type Tree struct {
    SHA       string
    Entries   []TreeEntry
    Truncated bool        // True if entries were limited
}

// TreeEntry represents an entry in a tree
type TreeEntry struct {
    Name   string
    Mode   FileMode
    Type   ObjectType  // blob, tree, commit
    SHA    string
    Size   int64       // Only for blobs
}

// FileMode represents git file modes
type FileMode uint32

const (
    ModeFile       FileMode = 0100644  // Regular file
    ModeExecutable FileMode = 0100755  // Executable
    ModeSymlink    FileMode = 0120000  // Symbolic link
    ModeSubmodule  FileMode = 0160000  // Submodule (gitlink)
    ModeDir        FileMode = 0040000  // Directory
)
```

### Tag Operations

```go
// GetTag retrieves an annotated tag by SHA
func (r *Repository) GetTag(sha string) (*Tag, error)

// CreateTag creates an annotated tag
func (r *Repository) CreateTag(opts *CreateTagOpts) (string, error)

// ListTags returns all tag references
func (r *Repository) ListTags() ([]*TagRef, error)

// CreateTagOpts contains options for creating a tag
type CreateTagOpts struct {
    Name       string
    TargetSHA  string
    TargetType ObjectType
    Message    string
    Tagger     Signature
}

// Tag represents an annotated tag object
type Tag struct {
    SHA        string
    Name       string
    TargetSHA  string
    TargetType ObjectType
    Message    string
    Tagger     Signature
}

// TagRef represents a lightweight tag reference
type TagRef struct {
    Name      string
    CommitSHA string
}
```

### Reference Operations

```go
// GetRef retrieves a reference
func (r *Repository) GetRef(name string) (*Ref, error)

// ListRefs returns references matching a pattern
func (r *Repository) ListRefs(pattern string) ([]*Ref, error)

// CreateRef creates a new reference
func (r *Repository) CreateRef(name, sha string) error

// UpdateRef updates a reference
func (r *Repository) UpdateRef(name, sha string, force bool) error

// DeleteRef deletes a reference
func (r *Repository) DeleteRef(name string) error

// Ref represents a git reference
type Ref struct {
    Name       string      // Full ref name (refs/heads/main)
    SHA        string      // Object SHA
    ObjectType ObjectType  // Type of referenced object
}
```

### Object Types

```go
type ObjectType string

const (
    ObjectBlob   ObjectType = "blob"
    ObjectTree   ObjectType = "tree"
    ObjectCommit ObjectType = "commit"
    ObjectTag    ObjectType = "tag"
)
```

### Error Definitions

```go
var (
    ErrNotFound       = errors.New("object not found")
    ErrInvalidSHA     = errors.New("invalid SHA")
    ErrRefNotFound    = errors.New("reference not found")
    ErrRefExists      = errors.New("reference already exists")
    ErrNotARepository = errors.New("not a git repository")
    ErrEmptyRepository = errors.New("repository is empty")
)
```

## feature/git Service Implementation

### Store Interface Updates

The git store interface is minimal since most operations go through the git library:

```go
type Store interface {
    // Repository path management
    GetRepoPath(ctx context.Context, repoID int64) (string, error)

    // Optional caching for frequently accessed objects
    CacheBlob(ctx context.Context, repoID int64, blob *Blob) error
    GetCachedBlob(ctx context.Context, repoID int64, sha string) (*Blob, error)
}
```

### Service Methods

Each method:
1. Validates repository access via `repoStore.GetByFullName`
2. Gets repository path from `store.GetRepoPath`
3. Opens git repository via `pkg/git.Open`
4. Performs git operation
5. Populates URLs in response
6. Returns result

### URL Generation

URLs follow GitHub API patterns:
```
Base API URL: {baseURL}/api/v3/repos/{owner}/{repo}/git

Blob:   /blobs/{sha}
Commit: /commits/{sha}
Tree:   /trees/{sha}
Tag:    /tags/{sha}
Ref:    /ref/{ref}
```

## Test Cases

### pkg/git Repository Tests

#### Blob Tests
| Test | Description |
|------|-------------|
| `TestRepository_GetBlob` | Get existing blob returns content |
| `TestRepository_GetBlob_NotFound` | Non-existent SHA returns ErrNotFound |
| `TestRepository_GetBlob_InvalidSHA` | Invalid SHA format returns ErrInvalidSHA |
| `TestRepository_CreateBlob` | Create blob returns valid SHA |
| `TestRepository_CreateBlob_Empty` | Empty content creates empty blob |
| `TestRepository_CreateBlob_Binary` | Binary content handled correctly |
| `TestRepository_CreateBlob_Large` | Large content (>1MB) handled correctly |

#### Commit Tests
| Test | Description |
|------|-------------|
| `TestRepository_GetCommit` | Get existing commit returns all fields |
| `TestRepository_GetCommit_NotFound` | Non-existent SHA returns ErrNotFound |
| `TestRepository_GetCommit_WithParents` | Commit with multiple parents |
| `TestRepository_CreateCommit` | Create commit with all fields |
| `TestRepository_CreateCommit_NoParent` | Initial commit (no parents) |
| `TestRepository_CreateCommit_MultipleParents` | Merge commit |
| `TestRepository_CreateCommit_InvalidTree` | Invalid tree SHA returns error |

#### Tree Tests
| Test | Description |
|------|-------------|
| `TestRepository_GetTree` | Get tree returns entries |
| `TestRepository_GetTree_NotFound` | Non-existent SHA returns ErrNotFound |
| `TestRepository_GetTree_Recursive` | Recursive fetch flattens nested trees |
| `TestRepository_GetTree_Truncated` | Large trees marked as truncated |
| `TestRepository_CreateTree` | Create new tree |
| `TestRepository_CreateTree_WithBase` | Modify existing tree |
| `TestRepository_CreateTree_NestedDirs` | Create nested directory structure |
| `TestRepository_CreateTree_Executable` | Executable mode preserved |

#### Tag Tests
| Test | Description |
|------|-------------|
| `TestRepository_GetTag` | Get annotated tag |
| `TestRepository_GetTag_NotFound` | Non-existent SHA returns ErrNotFound |
| `TestRepository_GetTag_NotATag` | Commit SHA returns error |
| `TestRepository_CreateTag` | Create annotated tag |
| `TestRepository_CreateTag_ToTree` | Tag pointing to tree |
| `TestRepository_ListTags` | List all tags |
| `TestRepository_ListTags_Empty` | Empty repo returns empty list |

#### Reference Tests
| Test | Description |
|------|-------------|
| `TestRepository_GetRef` | Get existing reference |
| `TestRepository_GetRef_NotFound` | Non-existent ref returns ErrRefNotFound |
| `TestRepository_GetRef_ShortName` | Short name resolved (heads/main) |
| `TestRepository_ListRefs` | List all refs |
| `TestRepository_ListRefs_Pattern` | Filter by pattern (heads/*) |
| `TestRepository_CreateRef` | Create new reference |
| `TestRepository_CreateRef_Exists` | Existing ref returns ErrRefExists |
| `TestRepository_UpdateRef` | Update reference |
| `TestRepository_UpdateRef_NonFF` | Non-fast-forward without force fails |
| `TestRepository_UpdateRef_Force` | Force update succeeds |
| `TestRepository_DeleteRef` | Delete reference |
| `TestRepository_DeleteRef_NotFound` | Delete non-existent ref returns error |

### feature/git Service Tests

#### Service Setup
```go
func setupTestService(t *testing.T) (*Service, *mockStore, *mockRepoStore, func()) {
    t.Helper()
    // Create temp directory with test repo
    // Return service with mocks
}
```

#### Blob Service Tests
| Test | Description |
|------|-------------|
| `TestService_GetBlob` | Get blob returns populated URLs |
| `TestService_GetBlob_RepoNotFound` | Non-existent repo returns repos.ErrNotFound |
| `TestService_GetBlob_NotFound` | Non-existent blob returns ErrNotFound |
| `TestService_GetBlob_Base64Encoded` | Base64 content decoded |
| `TestService_CreateBlob` | Create blob returns all fields |
| `TestService_CreateBlob_RepoNotFound` | Non-existent repo returns error |
| `TestService_CreateBlob_UTF8Default` | Default encoding is utf-8 |
| `TestService_CreateBlob_Base64` | Base64 encoding handled |

#### Commit Service Tests
| Test | Description |
|------|-------------|
| `TestService_GetGitCommit` | Get commit with full URLs |
| `TestService_GetGitCommit_RepoNotFound` | Non-existent repo returns error |
| `TestService_GetGitCommit_NotFound` | Non-existent commit returns error |
| `TestService_CreateGitCommit` | Create commit with all fields |
| `TestService_CreateGitCommit_DefaultAuthor` | Missing author uses defaults |
| `TestService_CreateGitCommit_CommitterFromAuthor` | Missing committer copies author |
| `TestService_CreateGitCommit_WithSignature` | Signed commit handled |

#### Reference Service Tests
| Test | Description |
|------|-------------|
| `TestService_GetRef` | Get ref with object URLs |
| `TestService_GetRef_RepoNotFound` | Non-existent repo returns error |
| `TestService_GetRef_NotFound` | Non-existent ref returns ErrNotFound |
| `TestService_ListMatchingRefs` | List refs matching pattern |
| `TestService_ListMatchingRefs_Empty` | No matches returns empty list |
| `TestService_CreateRef` | Create ref returns full object |
| `TestService_CreateRef_Exists` | Existing ref returns ErrRefExists |
| `TestService_UpdateRef` | Update ref returns new state |
| `TestService_UpdateRef_Force` | Force update succeeds |
| `TestService_DeleteRef` | Delete ref succeeds |

#### Tree Service Tests
| Test | Description |
|------|-------------|
| `TestService_GetTree` | Get tree with entry URLs |
| `TestService_GetTree_Recursive` | Recursive includes nested entries |
| `TestService_GetTree_RepoNotFound` | Non-existent repo returns error |
| `TestService_CreateTree` | Create tree returns all entries |
| `TestService_CreateTree_WithBase` | Modify base tree |
| `TestService_CreateTree_InlineContent` | Inline blob content creates blob |

#### Tag Service Tests
| Test | Description |
|------|-------------|
| `TestService_GetTag` | Get annotated tag with URLs |
| `TestService_GetTag_RepoNotFound` | Non-existent repo returns error |
| `TestService_GetTag_NotFound` | Non-existent tag returns error |
| `TestService_CreateTag` | Create tag returns full object |
| `TestService_CreateTag_DefaultTagger` | Missing tagger uses defaults |
| `TestService_ListTags` | List lightweight tags |
| `TestService_ListTags_Pagination` | Pagination works correctly |
| `TestService_ListTags_MaxPerPage` | Per page capped at 100 |

## Implementation Notes

### go-git Object Storage

go-git uses plumbing layer for object access:
```go
import (
    "github.com/go-git/go-git/v5"
    "github.com/go-git/go-git/v5/plumbing"
    "github.com/go-git/go-git/v5/plumbing/object"
)

// Get blob
hash := plumbing.NewHash(sha)
blob, err := repo.BlobObject(hash)
reader, err := blob.Reader()
content, err := io.ReadAll(reader)

// Create blob
obj := repo.Storer.NewEncodedObject()
obj.SetType(plumbing.BlobObject)
writer, err := obj.Writer()
writer.Write(content)
writer.Close()
hash, err := repo.Storer.SetEncodedObject(obj)
```

### Tree Building

Building trees requires working with TreeEntry objects:
```go
entries := []object.TreeEntry{
    {
        Name: "file.txt",
        Mode: filemode.Regular,
        Hash: blobHash,
    },
    {
        Name: "dir",
        Mode: filemode.Dir,
        Hash: subtreeHash,
    },
}
tree := &object.Tree{Entries: entries}
encoder := object.NewEncoder(repo.Storer)
hash, err := encoder.Encode(tree)
```

### Reference Management

References are managed through the storer:
```go
// Create ref
ref := plumbing.NewHashReference(
    plumbing.ReferenceName("refs/heads/main"),
    plumbing.NewHash(sha),
)
err := repo.Storer.SetReference(ref)

// Get ref
ref, err := repo.Reference(plumbing.ReferenceName("refs/heads/main"), true)

// Delete ref
err := repo.Storer.RemoveReference(plumbing.ReferenceName("refs/heads/main"))
```

### Bare Repository Considerations

GitHome uses bare repositories:
- No working directory
- Objects stored directly in .git (which is the repo root)
- HEAD points to default branch ref

```go
repo, err := git.PlainInit(path, true) // true = bare
```

## Database Schema

No additional tables needed. Repository paths are derived from existing `repositories` table:

```go
func getRepoPath(baseDir string, ownerLogin, repoName string) string {
    return filepath.Join(baseDir, ownerLogin, repoName+".git")
}
```

## Error Mapping

| pkg/git Error | HTTP Status | API Error |
|---------------|-------------|-----------|
| ErrNotFound | 404 | "Not Found" |
| ErrInvalidSHA | 422 | "Invalid SHA" |
| ErrRefNotFound | 404 | "Reference not found" |
| ErrRefExists | 422 | "Reference already exists" |
| ErrNotARepository | 404 | "Repository not found" |

## Security Considerations

1. **Path Traversal**: Validate repo paths don't escape base directory
2. **SHA Validation**: Validate SHA format before operations
3. **Size Limits**: Enforce blob size limits (100MB default)
4. **Reference Names**: Validate ref names follow git conventions
5. **Permissions**: Check repository access before operations

## Configuration

```go
type Config struct {
    ReposDir     string // Base directory for repositories
    MaxBlobSize  int64  // Maximum blob size in bytes
    MaxTreeDepth int    // Maximum recursive tree depth
}
```
