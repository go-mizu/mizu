# 0199: GitHome DuckDB Store Implementation

This document specifies the DuckDB-based storage layer for GitHome, implementing all feature/* Store interfaces.

## Overview

The `store/duckdb` package provides a unified DuckDB-backed implementation of all GitHome data stores. Following the pattern established in the kanban blueprint, we use:
- Embedded schema.sql for table definitions
- Individual store files per feature domain
- Auto-incrementing BIGINT IDs for all primary keys
- Comprehensive test coverage

## Store Interfaces to Implement

### Core Entities

| Feature | Store Interface | Key Methods |
|---------|----------------|-------------|
| **users** | `users.Store` | Create, GetByID, GetByLogin, GetByEmail, Update, Delete, List, CreateFollow, DeleteFollow, IsFollowing, ListFollowers, ListFollowing, IncrementFollowers, IncrementFollowing |
| **orgs** | `orgs.Store` | Create, GetByLogin, GetByID, Update, Delete, List, ListForUser, AddMember, UpdateMemberRole, RemoveMember, GetMember, ListMembers, ListPublicMembers, IsMember, IsPublicMember, SetMemberPublicity, CountOwners |
| **repos** | `repos.Store` | Create, GetByID, GetByOwnerAndName, GetByFullName, Update, Delete, List, ListByOwner, ListForks, GetTopics, SetTopics, GetLanguages, SetLanguages, IncrementOpenIssues, IncrementStargazers, IncrementWatchers, IncrementForks |
| **teams** | `teams.Store` | Create, GetByID, GetBySlug, Update, Delete, List, ListChildren, AddMember, UpdateMemberRole, RemoveMember, GetMember, ListMembers, IsMember, AddRepo, UpdateRepoPermission, RemoveRepo, GetRepoPermission, ListRepos, IncrementMembers, IncrementRepos |

### Issue Tracking

| Feature | Store Interface | Key Methods |
|---------|----------------|-------------|
| **issues** | `issues.Store` | Create, GetByID, GetByNumber, Update, Delete, List, ListForOrg, ListForUser, NextNumber, SetLocked, AddAssignee, RemoveAssignee, ListAssignees, AddLabel, RemoveLabel, ListLabels, SetLabels, SetMilestone, CreateEvent, ListEvents, IncrementComments |
| **labels** | `labels.Store` | Create, GetByID, GetByName, GetByNames, Update, Delete, List, ListForIssue, AddToIssue, RemoveFromIssue, SetForIssue, RemoveAllFromIssue, ListForMilestone |
| **milestones** | `milestones.Store` | Create, GetByID, GetByNumber, GetByTitle, Update, Delete, List, NextNumber, IncrementOpenIssues, IncrementClosedIssues |
| **comments** | `comments.Store` | CreateIssueComment, GetIssueCommentByID, UpdateIssueComment, DeleteIssueComment, ListIssueCommentsForRepo, ListIssueCommentsForIssue, CreateCommitComment, GetCommitCommentByID, UpdateCommitComment, DeleteCommitComment, ListCommitCommentsForRepo, ListCommitCommentsForCommit |

### Pull Requests

| Feature | Store Interface | Key Methods |
|---------|----------------|-------------|
| **pulls** | `pulls.Store` | Create, GetByID, GetByNumber, Update, Delete, List, NextNumber, SetMerged, CreateReview, GetReviewByID, UpdateReview, SetReviewState, ListReviews, CreateReviewComment, GetReviewCommentByID, UpdateReviewComment, DeleteReviewComment, ListReviewComments, AddRequestedReviewer, RemoveRequestedReviewer, ListRequestedReviewers, AddRequestedTeam, RemoveRequestedTeam, ListRequestedTeams |

### Social Features

| Feature | Store Interface | Key Methods |
|---------|----------------|-------------|
| **stars** | `stars.Store` | Create, Delete, Exists, ListStargazers, ListStargazersWithTimestamps, ListStarredRepos, ListStarredReposWithTimestamps |
| **watches** | `watches.Store` | Create, Update, Delete, Get, ListWatchers, ListWatchedRepos |
| **collaborators** | `collaborators.Store` | Add, Remove, Get, List, UpdatePermission, CreateInvitation, GetInvitationByID, UpdateInvitation, DeleteInvitation, ListInvitationsForRepo, ListInvitationsForUser, AcceptInvitation |
| **reactions** | `reactions.Store` | Create, GetByID, Delete, List, GetByUserAndContent, GetRollup |

### Releases & Activities

| Feature | Store Interface | Key Methods |
|---------|----------------|-------------|
| **releases** | `releases.Store` | Create, GetByID, GetByTag, GetLatest, Update, Delete, List, CreateAsset, GetAssetByID, UpdateAsset, DeleteAsset, ListAssets, IncrementDownloadCount |
| **activities** | `activities.Store` | Create, GetByID, ListPublic, ListForRepo, ListForOrg, ListForUser, ListReceivedByUser |

### Notifications & Webhooks

| Feature | Store Interface | Key Methods |
|---------|----------------|-------------|
| **notifications** | `notifications.Store` | Create, GetByID, MarkAsRead, MarkRepoAsRead, MarkThreadAsRead, Delete, List, ListForRepo, GetSubscription, SetSubscription, DeleteSubscription |
| **webhooks** | `webhooks.Store` | Create, GetByID, Update, Delete, ListByOwner, CreateDelivery, GetDeliveryByID, ListDeliveries |
| **branches** | `branches.Store` | GetProtection, SetProtection, DeleteProtection |

## Database Schema

### Design Principles

1. **ID Generation**: Use `BIGINT GENERATED BY DEFAULT AS IDENTITY` for auto-incrementing IDs
2. **Node IDs**: Generate using base64-encoded type:id format (e.g., `U_1` for User 1)
3. **Timestamps**: Use `TIMESTAMP DEFAULT CURRENT_TIMESTAMP` for created_at
4. **Foreign Keys**: Enforce at application level (DuckDB FK issues with UPDATE operations)
5. **Counters**: Maintain denormalized counts with atomic increments
6. **Pagination**: Support offset/limit via ListOpts

### Tables

#### Core Tables

```sql
-- Users
CREATE TABLE IF NOT EXISTS users (
    id            BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    node_id       VARCHAR NOT NULL,
    login         VARCHAR UNIQUE NOT NULL,
    name          VARCHAR NOT NULL DEFAULT '',
    email         VARCHAR UNIQUE,
    avatar_url    VARCHAR NOT NULL DEFAULT '',
    gravatar_id   VARCHAR NOT NULL DEFAULT '',
    type          VARCHAR NOT NULL DEFAULT 'User',
    site_admin    BOOLEAN NOT NULL DEFAULT FALSE,
    bio           VARCHAR NOT NULL DEFAULT '',
    blog          VARCHAR NOT NULL DEFAULT '',
    location      VARCHAR NOT NULL DEFAULT '',
    company       VARCHAR NOT NULL DEFAULT '',
    hireable      BOOLEAN NOT NULL DEFAULT FALSE,
    twitter_username VARCHAR NOT NULL DEFAULT '',
    public_repos  INTEGER NOT NULL DEFAULT 0,
    public_gists  INTEGER NOT NULL DEFAULT 0,
    followers     INTEGER NOT NULL DEFAULT 0,
    following     INTEGER NOT NULL DEFAULT 0,
    password_hash VARCHAR NOT NULL,
    created_at    TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at    TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- User follows
CREATE TABLE IF NOT EXISTS user_follows (
    follower_id   BIGINT NOT NULL,
    followed_id   BIGINT NOT NULL,
    created_at    TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (follower_id, followed_id)
);

-- Organizations
CREATE TABLE IF NOT EXISTS organizations (
    id            BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    node_id       VARCHAR NOT NULL,
    login         VARCHAR UNIQUE NOT NULL,
    name          VARCHAR NOT NULL DEFAULT '',
    description   VARCHAR NOT NULL DEFAULT '',
    company       VARCHAR NOT NULL DEFAULT '',
    blog          VARCHAR NOT NULL DEFAULT '',
    location      VARCHAR NOT NULL DEFAULT '',
    email         VARCHAR NOT NULL DEFAULT '',
    twitter_username VARCHAR NOT NULL DEFAULT '',
    avatar_url    VARCHAR NOT NULL DEFAULT '',
    is_verified   BOOLEAN NOT NULL DEFAULT FALSE,
    has_organization_projects BOOLEAN NOT NULL DEFAULT TRUE,
    has_repository_projects BOOLEAN NOT NULL DEFAULT TRUE,
    public_repos  INTEGER NOT NULL DEFAULT 0,
    public_gists  INTEGER NOT NULL DEFAULT 0,
    followers     INTEGER NOT NULL DEFAULT 0,
    following     INTEGER NOT NULL DEFAULT 0,
    total_private_repos INTEGER NOT NULL DEFAULT 0,
    owned_private_repos INTEGER NOT NULL DEFAULT 0,
    default_repository_permission VARCHAR NOT NULL DEFAULT 'read',
    members_can_create_repositories BOOLEAN NOT NULL DEFAULT TRUE,
    members_can_create_public_repositories BOOLEAN NOT NULL DEFAULT TRUE,
    members_can_create_private_repositories BOOLEAN NOT NULL DEFAULT TRUE,
    created_at    TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at    TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Organization members
CREATE TABLE IF NOT EXISTS org_members (
    org_id        BIGINT NOT NULL,
    user_id       BIGINT NOT NULL,
    role          VARCHAR NOT NULL DEFAULT 'member',
    is_public     BOOLEAN NOT NULL DEFAULT FALSE,
    state         VARCHAR NOT NULL DEFAULT 'active',
    created_at    TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (org_id, user_id)
);

-- Repositories
CREATE TABLE IF NOT EXISTS repositories (
    id            BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    node_id       VARCHAR NOT NULL,
    name          VARCHAR NOT NULL,
    full_name     VARCHAR UNIQUE NOT NULL,
    owner_id      BIGINT NOT NULL,
    owner_type    VARCHAR NOT NULL DEFAULT 'User',
    private       BOOLEAN NOT NULL DEFAULT FALSE,
    description   VARCHAR NOT NULL DEFAULT '',
    fork          BOOLEAN NOT NULL DEFAULT FALSE,
    parent_id     BIGINT,
    homepage      VARCHAR NOT NULL DEFAULT '',
    language      VARCHAR NOT NULL DEFAULT '',
    forks_count   INTEGER NOT NULL DEFAULT 0,
    stargazers_count INTEGER NOT NULL DEFAULT 0,
    watchers_count INTEGER NOT NULL DEFAULT 0,
    size          INTEGER NOT NULL DEFAULT 0,
    default_branch VARCHAR NOT NULL DEFAULT 'main',
    open_issues_count INTEGER NOT NULL DEFAULT 0,
    is_template   BOOLEAN NOT NULL DEFAULT FALSE,
    has_issues    BOOLEAN NOT NULL DEFAULT TRUE,
    has_projects  BOOLEAN NOT NULL DEFAULT TRUE,
    has_wiki      BOOLEAN NOT NULL DEFAULT TRUE,
    has_pages     BOOLEAN NOT NULL DEFAULT FALSE,
    has_downloads BOOLEAN NOT NULL DEFAULT TRUE,
    has_discussions BOOLEAN NOT NULL DEFAULT FALSE,
    archived      BOOLEAN NOT NULL DEFAULT FALSE,
    disabled      BOOLEAN NOT NULL DEFAULT FALSE,
    visibility    VARCHAR NOT NULL DEFAULT 'public',
    pushed_at     TIMESTAMP,
    allow_rebase_merge BOOLEAN NOT NULL DEFAULT TRUE,
    allow_squash_merge BOOLEAN NOT NULL DEFAULT TRUE,
    allow_merge_commit BOOLEAN NOT NULL DEFAULT TRUE,
    allow_auto_merge BOOLEAN NOT NULL DEFAULT FALSE,
    delete_branch_on_merge BOOLEAN NOT NULL DEFAULT FALSE,
    allow_forking BOOLEAN NOT NULL DEFAULT TRUE,
    web_commit_signoff_required BOOLEAN NOT NULL DEFAULT FALSE,
    created_at    TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at    TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE (owner_id, name)
);

-- Repository topics
CREATE TABLE IF NOT EXISTS repo_topics (
    repo_id       BIGINT NOT NULL,
    topic         VARCHAR NOT NULL,
    PRIMARY KEY (repo_id, topic)
);

-- Repository languages
CREATE TABLE IF NOT EXISTS repo_languages (
    repo_id       BIGINT NOT NULL,
    language      VARCHAR NOT NULL,
    bytes         INTEGER NOT NULL DEFAULT 0,
    PRIMARY KEY (repo_id, language)
);

-- Teams
CREATE TABLE IF NOT EXISTS teams (
    id            BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    node_id       VARCHAR NOT NULL,
    org_id        BIGINT NOT NULL,
    name          VARCHAR NOT NULL,
    slug          VARCHAR NOT NULL,
    description   VARCHAR NOT NULL DEFAULT '',
    privacy       VARCHAR NOT NULL DEFAULT 'closed',
    permission    VARCHAR NOT NULL DEFAULT 'pull',
    parent_id     BIGINT,
    members_count INTEGER NOT NULL DEFAULT 0,
    repos_count   INTEGER NOT NULL DEFAULT 0,
    created_at    TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at    TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE (org_id, slug)
);

-- Team members
CREATE TABLE IF NOT EXISTS team_members (
    team_id       BIGINT NOT NULL,
    user_id       BIGINT NOT NULL,
    role          VARCHAR NOT NULL DEFAULT 'member',
    state         VARCHAR NOT NULL DEFAULT 'active',
    created_at    TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (team_id, user_id)
);

-- Team repositories
CREATE TABLE IF NOT EXISTS team_repos (
    team_id       BIGINT NOT NULL,
    repo_id       BIGINT NOT NULL,
    permission    VARCHAR NOT NULL DEFAULT 'pull',
    PRIMARY KEY (team_id, repo_id)
);
```

#### Issue Tracking Tables

```sql
-- Issues
CREATE TABLE IF NOT EXISTS issues (
    id            BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    node_id       VARCHAR NOT NULL,
    repo_id       BIGINT NOT NULL,
    number        INTEGER NOT NULL,
    state         VARCHAR NOT NULL DEFAULT 'open',
    state_reason  VARCHAR NOT NULL DEFAULT '',
    title         VARCHAR NOT NULL,
    body          VARCHAR NOT NULL DEFAULT '',
    creator_id    BIGINT NOT NULL,
    locked        BOOLEAN NOT NULL DEFAULT FALSE,
    active_lock_reason VARCHAR NOT NULL DEFAULT '',
    comments      INTEGER NOT NULL DEFAULT 0,
    closed_at     TIMESTAMP,
    closed_by_id  BIGINT,
    milestone_id  BIGINT,
    created_at    TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at    TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE (repo_id, number)
);

-- Issue assignees
CREATE TABLE IF NOT EXISTS issue_assignees (
    issue_id      BIGINT NOT NULL,
    user_id       BIGINT NOT NULL,
    PRIMARY KEY (issue_id, user_id)
);

-- Issue labels
CREATE TABLE IF NOT EXISTS issue_labels (
    issue_id      BIGINT NOT NULL,
    label_id      BIGINT NOT NULL,
    PRIMARY KEY (issue_id, label_id)
);

-- Issue events
CREATE TABLE IF NOT EXISTS issue_events (
    id            BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    node_id       VARCHAR NOT NULL,
    issue_id      BIGINT NOT NULL,
    actor_id      BIGINT NOT NULL,
    event         VARCHAR NOT NULL,
    commit_id     VARCHAR NOT NULL DEFAULT '',
    commit_url    VARCHAR NOT NULL DEFAULT '',
    label_id      BIGINT,
    assignee_id   BIGINT,
    assigner_id   BIGINT,
    milestone_id  BIGINT,
    rename_from   VARCHAR,
    rename_to     VARCHAR,
    created_at    TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Labels
CREATE TABLE IF NOT EXISTS labels (
    id            BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    node_id       VARCHAR NOT NULL,
    repo_id       BIGINT NOT NULL,
    name          VARCHAR NOT NULL,
    description   VARCHAR NOT NULL DEFAULT '',
    color         VARCHAR NOT NULL DEFAULT 'ededed',
    is_default    BOOLEAN NOT NULL DEFAULT FALSE,
    UNIQUE (repo_id, name)
);

-- Milestones
CREATE TABLE IF NOT EXISTS milestones (
    id            BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    node_id       VARCHAR NOT NULL,
    repo_id       BIGINT NOT NULL,
    number        INTEGER NOT NULL,
    state         VARCHAR NOT NULL DEFAULT 'open',
    title         VARCHAR NOT NULL,
    description   VARCHAR NOT NULL DEFAULT '',
    creator_id    BIGINT NOT NULL,
    open_issues   INTEGER NOT NULL DEFAULT 0,
    closed_issues INTEGER NOT NULL DEFAULT 0,
    closed_at     TIMESTAMP,
    due_on        TIMESTAMP,
    created_at    TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at    TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE (repo_id, number)
);

-- Issue comments
CREATE TABLE IF NOT EXISTS issue_comments (
    id            BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    node_id       VARCHAR NOT NULL,
    issue_id      BIGINT NOT NULL,
    repo_id       BIGINT NOT NULL,
    creator_id    BIGINT NOT NULL,
    body          VARCHAR NOT NULL,
    created_at    TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at    TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Commit comments
CREATE TABLE IF NOT EXISTS commit_comments (
    id            BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    node_id       VARCHAR NOT NULL,
    repo_id       BIGINT NOT NULL,
    creator_id    BIGINT NOT NULL,
    commit_sha    VARCHAR NOT NULL,
    body          VARCHAR NOT NULL,
    path          VARCHAR NOT NULL DEFAULT '',
    position      INTEGER,
    line          INTEGER,
    created_at    TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at    TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### Pull Request Tables

```sql
-- Pull requests
CREATE TABLE IF NOT EXISTS pull_requests (
    id            BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    node_id       VARCHAR NOT NULL,
    repo_id       BIGINT NOT NULL,
    number        INTEGER NOT NULL,
    state         VARCHAR NOT NULL DEFAULT 'open',
    locked        BOOLEAN NOT NULL DEFAULT FALSE,
    title         VARCHAR NOT NULL,
    body          VARCHAR NOT NULL DEFAULT '',
    creator_id    BIGINT NOT NULL,
    head_ref      VARCHAR NOT NULL,
    head_sha      VARCHAR NOT NULL,
    head_repo_id  BIGINT,
    base_ref      VARCHAR NOT NULL,
    base_sha      VARCHAR NOT NULL,
    draft         BOOLEAN NOT NULL DEFAULT FALSE,
    merged        BOOLEAN NOT NULL DEFAULT FALSE,
    mergeable     BOOLEAN,
    rebaseable    BOOLEAN,
    mergeable_state VARCHAR NOT NULL DEFAULT '',
    merge_commit_sha VARCHAR NOT NULL DEFAULT '',
    merged_at     TIMESTAMP,
    merged_by_id  BIGINT,
    comments      INTEGER NOT NULL DEFAULT 0,
    review_comments INTEGER NOT NULL DEFAULT 0,
    maintainer_can_modify BOOLEAN NOT NULL DEFAULT FALSE,
    commits       INTEGER NOT NULL DEFAULT 0,
    additions     INTEGER NOT NULL DEFAULT 0,
    deletions     INTEGER NOT NULL DEFAULT 0,
    changed_files INTEGER NOT NULL DEFAULT 0,
    closed_at     TIMESTAMP,
    milestone_id  BIGINT,
    created_at    TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at    TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE (repo_id, number)
);

-- PR reviews
CREATE TABLE IF NOT EXISTS pr_reviews (
    id            BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    node_id       VARCHAR NOT NULL,
    pr_id         BIGINT NOT NULL,
    user_id       BIGINT NOT NULL,
    body          VARCHAR NOT NULL DEFAULT '',
    state         VARCHAR NOT NULL DEFAULT 'PENDING',
    commit_id     VARCHAR NOT NULL,
    submitted_at  TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- PR review comments
CREATE TABLE IF NOT EXISTS pr_review_comments (
    id            BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    node_id       VARCHAR NOT NULL,
    pr_id         BIGINT NOT NULL,
    review_id     BIGINT,
    user_id       BIGINT NOT NULL,
    diff_hunk     VARCHAR NOT NULL DEFAULT '',
    path          VARCHAR NOT NULL,
    position      INTEGER,
    original_position INTEGER,
    commit_id     VARCHAR NOT NULL,
    original_commit_id VARCHAR NOT NULL DEFAULT '',
    in_reply_to_id BIGINT,
    body          VARCHAR NOT NULL,
    line          INTEGER,
    original_line INTEGER,
    start_line    INTEGER,
    original_start_line INTEGER,
    side          VARCHAR NOT NULL DEFAULT 'RIGHT',
    start_side    VARCHAR NOT NULL DEFAULT '',
    created_at    TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at    TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Requested reviewers
CREATE TABLE IF NOT EXISTS pr_requested_reviewers (
    pr_id         BIGINT NOT NULL,
    user_id       BIGINT NOT NULL,
    PRIMARY KEY (pr_id, user_id)
);

-- Requested teams
CREATE TABLE IF NOT EXISTS pr_requested_teams (
    pr_id         BIGINT NOT NULL,
    team_id       BIGINT NOT NULL,
    PRIMARY KEY (pr_id, team_id)
);
```

#### Social Feature Tables

```sql
-- Stars
CREATE TABLE IF NOT EXISTS stars (
    user_id       BIGINT NOT NULL,
    repo_id       BIGINT NOT NULL,
    created_at    TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (user_id, repo_id)
);

-- Watches
CREATE TABLE IF NOT EXISTS watches (
    user_id       BIGINT NOT NULL,
    repo_id       BIGINT NOT NULL,
    subscribed    BOOLEAN NOT NULL DEFAULT TRUE,
    ignored       BOOLEAN NOT NULL DEFAULT FALSE,
    created_at    TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (user_id, repo_id)
);

-- Collaborators
CREATE TABLE IF NOT EXISTS collaborators (
    repo_id       BIGINT NOT NULL,
    user_id       BIGINT NOT NULL,
    permission    VARCHAR NOT NULL DEFAULT 'pull',
    created_at    TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (repo_id, user_id)
);

-- Collaboration invitations
CREATE TABLE IF NOT EXISTS collaborator_invitations (
    id            BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    node_id       VARCHAR NOT NULL,
    repo_id       BIGINT NOT NULL,
    invitee_id    BIGINT NOT NULL,
    inviter_id    BIGINT NOT NULL,
    permissions   VARCHAR NOT NULL DEFAULT 'pull',
    expired       BOOLEAN NOT NULL DEFAULT FALSE,
    created_at    TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Reactions
CREATE TABLE IF NOT EXISTS reactions (
    id            BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    node_id       VARCHAR NOT NULL,
    subject_type  VARCHAR NOT NULL,
    subject_id    BIGINT NOT NULL,
    user_id       BIGINT NOT NULL,
    content       VARCHAR NOT NULL,
    created_at    TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE (subject_type, subject_id, user_id, content)
);
```

#### Release & Activity Tables

```sql
-- Releases
CREATE TABLE IF NOT EXISTS releases (
    id            BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    node_id       VARCHAR NOT NULL,
    repo_id       BIGINT NOT NULL,
    tag_name      VARCHAR NOT NULL,
    target_commitish VARCHAR NOT NULL DEFAULT 'main',
    name          VARCHAR NOT NULL DEFAULT '',
    body          VARCHAR NOT NULL DEFAULT '',
    draft         BOOLEAN NOT NULL DEFAULT FALSE,
    prerelease    BOOLEAN NOT NULL DEFAULT FALSE,
    author_id     BIGINT NOT NULL,
    published_at  TIMESTAMP,
    created_at    TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE (repo_id, tag_name)
);

-- Release assets
CREATE TABLE IF NOT EXISTS release_assets (
    id            BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    node_id       VARCHAR NOT NULL,
    release_id    BIGINT NOT NULL,
    uploader_id   BIGINT NOT NULL,
    name          VARCHAR NOT NULL,
    label         VARCHAR NOT NULL DEFAULT '',
    state         VARCHAR NOT NULL DEFAULT 'uploaded',
    content_type  VARCHAR NOT NULL,
    size          INTEGER NOT NULL DEFAULT 0,
    download_count INTEGER NOT NULL DEFAULT 0,
    storage_path  VARCHAR NOT NULL DEFAULT '',
    created_at    TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at    TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Activities/Events
CREATE TABLE IF NOT EXISTS events (
    id            VARCHAR PRIMARY KEY,
    type          VARCHAR NOT NULL,
    actor_id      BIGINT NOT NULL,
    repo_id       BIGINT NOT NULL,
    org_id        BIGINT,
    payload       VARCHAR NOT NULL DEFAULT '{}',
    public        BOOLEAN NOT NULL DEFAULT TRUE,
    created_at    TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Feed subscriptions (for received events)
CREATE TABLE IF NOT EXISTS feed_subscriptions (
    user_id       BIGINT NOT NULL,
    target_id     BIGINT NOT NULL,
    target_type   VARCHAR NOT NULL,
    created_at    TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (user_id, target_id, target_type)
);
```

#### Notification & Webhook Tables

```sql
-- Notifications
CREATE TABLE IF NOT EXISTS notifications (
    id            VARCHAR PRIMARY KEY,
    user_id       BIGINT NOT NULL,
    repo_id       BIGINT NOT NULL,
    unread        BOOLEAN NOT NULL DEFAULT TRUE,
    reason        VARCHAR NOT NULL,
    subject_type  VARCHAR NOT NULL,
    subject_title VARCHAR NOT NULL,
    subject_url   VARCHAR NOT NULL,
    subject_latest_comment_url VARCHAR NOT NULL DEFAULT '',
    last_read_at  TIMESTAMP,
    updated_at    TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Thread subscriptions
CREATE TABLE IF NOT EXISTS thread_subscriptions (
    thread_id     VARCHAR NOT NULL,
    user_id       BIGINT NOT NULL,
    ignored       BOOLEAN NOT NULL DEFAULT FALSE,
    created_at    TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (thread_id, user_id)
);

-- Webhooks
CREATE TABLE IF NOT EXISTS webhooks (
    id            BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    node_id       VARCHAR NOT NULL,
    owner_id      BIGINT NOT NULL,
    owner_type    VARCHAR NOT NULL,
    name          VARCHAR NOT NULL DEFAULT 'web',
    url           VARCHAR NOT NULL,
    content_type  VARCHAR NOT NULL DEFAULT 'json',
    secret        VARCHAR NOT NULL DEFAULT '',
    insecure_ssl  VARCHAR NOT NULL DEFAULT '0',
    events        VARCHAR NOT NULL DEFAULT '["push"]',
    active        BOOLEAN NOT NULL DEFAULT TRUE,
    created_at    TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at    TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Webhook deliveries
CREATE TABLE IF NOT EXISTS webhook_deliveries (
    id            BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    hook_id       BIGINT NOT NULL,
    guid          VARCHAR NOT NULL,
    delivered_at  TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    redelivery    BOOLEAN NOT NULL DEFAULT FALSE,
    duration      DOUBLE NOT NULL DEFAULT 0,
    status        VARCHAR NOT NULL DEFAULT 'pending',
    status_code   INTEGER NOT NULL DEFAULT 0,
    event         VARCHAR NOT NULL,
    action        VARCHAR NOT NULL DEFAULT '',
    request_headers VARCHAR NOT NULL DEFAULT '{}',
    request_payload VARCHAR NOT NULL DEFAULT '{}',
    response_headers VARCHAR NOT NULL DEFAULT '{}',
    response_payload VARCHAR NOT NULL DEFAULT ''
);

-- Branch protection rules
CREATE TABLE IF NOT EXISTS branch_protections (
    repo_id       BIGINT NOT NULL,
    branch        VARCHAR NOT NULL,
    enabled       BOOLEAN NOT NULL DEFAULT TRUE,
    settings_json VARCHAR NOT NULL DEFAULT '{}',
    PRIMARY KEY (repo_id, branch)
);
```

## Package Structure

```
store/duckdb/
├── schema.sql                 # Embedded DDL
├── store.go                   # Main Store struct, New(), Ensure()
├── store_test.go              # Test setup helpers
├── helpers.go                 # Shared SQL helpers (nullString, pagination, etc.)
├── users_store.go
├── users_store_test.go
├── orgs_store.go
├── orgs_store_test.go
├── repos_store.go
├── repos_store_test.go
├── teams_store.go
├── teams_store_test.go
├── issues_store.go
├── issues_store_test.go
├── labels_store.go
├── labels_store_test.go
├── milestones_store.go
├── milestones_store_test.go
├── comments_store.go
├── comments_store_test.go
├── pulls_store.go
├── pulls_store_test.go
├── stars_store.go
├── stars_store_test.go
├── watches_store.go
├── watches_store_test.go
├── collaborators_store.go
├── collaborators_store_test.go
├── reactions_store.go
├── reactions_store_test.go
├── releases_store.go
├── releases_store_test.go
├── activities_store.go
├── activities_store_test.go
├── notifications_store.go
├── notifications_store_test.go
├── webhooks_store.go
├── webhooks_store_test.go
└── branches_store.go
    branches_store_test.go
```

## Implementation Details

### Store Struct

```go
type Store struct {
    db *sql.DB
}

func New(db *sql.DB) (*Store, error) {
    if db == nil {
        return nil, errors.New("duckdb: nil db")
    }
    return &Store{db: db}, nil
}

func (s *Store) Ensure(ctx context.Context) error {
    if _, err := s.db.ExecContext(ctx, schemaDDL); err != nil {
        return fmt.Errorf("duckdb: schema: %w", err)
    }
    return nil
}

func (s *Store) DB() *sql.DB { return s.db }
func (s *Store) Close() error { return s.db.Close() }
```

### Feature Stores

Each feature store embeds a *sql.DB:

```go
type UsersStore struct {
    db *sql.DB
}

func NewUsersStore(db *sql.DB) *UsersStore {
    return &UsersStore{db: db}
}
```

### Node ID Generation

Generate GitHub-compatible node IDs:

```go
func generateNodeID(prefix string, id int64) string {
    return base64.StdEncoding.EncodeToString([]byte(fmt.Sprintf("%s_%d", prefix, id)))
}

// Prefixes:
// U = User
// O = Organization
// R = Repository
// T = Team
// I = Issue
// PR = PullRequest
// L = Label
// M = Milestone
// IC = IssueComment
// CC = CommitComment
// RV = Review
// RC = ReviewComment
// RL = Release
// RA = ReleaseAsset
// WH = Webhook
```

### Pagination Helper

```go
func applyPagination(query string, opts interface{ GetPage, GetPerPage() (int, int) }) string {
    page, perPage := opts.GetPage(), opts.GetPerPage()
    if perPage <= 0 {
        perPage = 30
    }
    if page <= 0 {
        page = 1
    }
    offset := (page - 1) * perPage
    return fmt.Sprintf("%s LIMIT %d OFFSET %d", query, perPage, offset)
}
```

## Testing

Each store test file follows this pattern:

```go
func TestUsersStore_Create(t *testing.T) {
    store, cleanup := setupTestStore(t)
    defer cleanup()

    usersStore := NewUsersStore(store.DB())

    u := &users.User{
        Login:        "testuser",
        Name:         "Test User",
        Email:        "test@example.com",
        PasswordHash: "hashed",
    }

    err := usersStore.Create(context.Background(), u)
    if err != nil {
        t.Fatalf("Create failed: %v", err)
    }

    if u.ID == 0 {
        t.Error("expected ID to be set")
    }

    got, err := usersStore.GetByID(context.Background(), u.ID)
    if err != nil {
        t.Fatalf("GetByID failed: %v", err)
    }
    if got.Login != u.Login {
        t.Errorf("got login %q, want %q", got.Login, u.Login)
    }
}
```

## Usage Example

```go
import (
    "database/sql"
    _ "github.com/duckdb/duckdb-go/v2"
    "github.com/go-mizu/blueprints/githome/store/duckdb"
)

func main() {
    db, _ := sql.Open("duckdb", "githome.db")
    defer db.Close()

    store, _ := duckdb.New(db)
    store.Ensure(context.Background())

    usersStore := duckdb.NewUsersStore(store.DB())
    reposStore := duckdb.NewReposStore(store.DB())
    issuesStore := duckdb.NewIssuesStore(store.DB())
    // ... other stores
}
```
