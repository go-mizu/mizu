# RFC 0152: QR Code Friend Feature

## Summary

Add the ability for users to generate a personal QR code that others can scan to add them as a friend/contact. This feature enables easy friend discovery without typing usernames manually.

## Motivation

Adding friends in messaging apps often requires sharing usernames or phone numbers, which can be error-prone and inconvenient. QR codes provide a fast, accurate way to share contact information, especially in person.

## Design

### User Flow

1. **Generate QR Code**
   - User navigates to "My QR Code" from the sidebar or new chat modal
   - System generates a unique, time-limited friend code for the user
   - QR code is displayed containing a deep link with the friend code
   - User can share/show the QR code to another person

2. **Scan QR Code**
   - User clicks "Scan QR Code" button
   - Camera opens to scan QR code
   - System validates the friend code
   - If valid, shows friend's profile with "Add Friend" button
   - User confirms to add as contact

3. **Share Link**
   - Users can also copy a friend link (for non-camera scenarios)
   - Link format: `https://app.example.com/add-friend/{code}`

### Architecture

#### Database Schema

```sql
-- Friend codes table
CREATE TABLE IF NOT EXISTS friend_codes (
  id          VARCHAR PRIMARY KEY,
  user_id     VARCHAR NOT NULL,
  code        VARCHAR UNIQUE NOT NULL,
  expires_at  TIMESTAMP NOT NULL,
  created_at  TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(id)
);

CREATE INDEX IF NOT EXISTS idx_friend_codes_user_id ON friend_codes(user_id);
CREATE INDEX IF NOT EXISTS idx_friend_codes_code ON friend_codes(code);
CREATE INDEX IF NOT EXISTS idx_friend_codes_expires ON friend_codes(expires_at);
```

#### Feature Layer

**Package: `feature/friendcode`**

```go
// FriendCode represents a shareable friend code.
type FriendCode struct {
    ID        string    `json:"id"`
    UserID    string    `json:"user_id"`
    Code      string    `json:"code"`
    ExpiresAt time.Time `json:"expires_at"`
    CreatedAt time.Time `json:"created_at"`
}

// ResolvedUser contains user info from a friend code.
type ResolvedUser struct {
    ID          string `json:"id"`
    Username    string `json:"username"`
    DisplayName string `json:"display_name"`
    AvatarURL   string `json:"avatar_url,omitempty"`
    Status      string `json:"status,omitempty"`
}

// API defines the friend code service contract.
type API interface {
    // Generate creates or returns existing valid friend code for user
    Generate(ctx context.Context, userID string) (*FriendCode, error)

    // Resolve validates a code and returns the associated user info
    Resolve(ctx context.Context, code string) (*ResolvedUser, error)

    // AddFriend adds a contact using a friend code
    AddFriend(ctx context.Context, userID, code string) (*contacts.Contact, error)

    // Revoke invalidates a user's current friend code
    Revoke(ctx context.Context, userID string) error
}

// Store defines the data access contract.
type Store interface {
    Insert(ctx context.Context, fc *FriendCode) error
    GetByUserID(ctx context.Context, userID string) (*FriendCode, error)
    GetByCode(ctx context.Context, code string) (*FriendCode, error)
    Delete(ctx context.Context, id string) error
    DeleteExpired(ctx context.Context) error
}
```

#### HTTP Endpoints

| Method | Path                       | Description                          |
|--------|----------------------------|--------------------------------------|
| GET    | /api/v1/friend-code        | Get/generate user's QR friend code   |
| GET    | /api/v1/friend-code/{code} | Resolve a friend code to user info   |
| POST   | /api/v1/friend-code/{code} | Add friend using the code            |
| DELETE | /api/v1/friend-code        | Revoke current friend code           |

**Request/Response Examples:**

```json
// GET /api/v1/friend-code
// Response:
{
  "success": true,
  "data": {
    "id": "fc_abc123",
    "code": "MIZU-ABC123XY",
    "expires_at": "2024-01-15T12:00:00Z",
    "qr_data": "https://app.example.com/add-friend/MIZU-ABC123XY"
  }
}

// GET /api/v1/friend-code/MIZU-ABC123XY
// Response:
{
  "success": true,
  "data": {
    "id": "user_xyz",
    "username": "alice",
    "display_name": "Alice",
    "avatar_url": "/avatars/alice.jpg",
    "status": "Available"
  }
}

// POST /api/v1/friend-code/MIZU-ABC123XY
// Response:
{
  "success": true,
  "data": {
    "user_id": "user_me",
    "contact_user_id": "user_xyz",
    "display_name": "Alice",
    "created_at": "2024-01-10T10:00:00Z"
  }
}
```

#### UI Components

1. **QR Code Modal** (`#qr-modal`)
   - Two tabs: "My Code" and "Scan Code"
   - My Code tab shows generated QR with share/copy buttons
   - Scan Code tab activates camera for scanning

2. **QR Code Button** in sidebar header
   - QR icon button next to new chat button
   - Opens QR modal on click

3. **Add Friend Quick Action** in new chat modal
   - "Add by QR Code" button in quick actions

4. **Friend Preview Modal**
   - Shows resolved user info before adding
   - Confirm/Cancel buttons

### Security Considerations

1. **Code Expiration**: Codes expire after 24 hours by default
2. **Rate Limiting**: Limit code generation to 10/hour per user
3. **Code Format**: 12-character alphanumeric (collision-resistant)
4. **Self-Add Prevention**: Cannot add yourself as friend
5. **Duplicate Prevention**: Cannot add existing contacts

### QR Code Generation

Use client-side QR code generation with `qrcode.js` library:
- Include via CDN or embed minimal version
- Generate SVG for crisp display
- Embed deep link URL in QR data

### Implementation Plan

1. **Database Schema** - Add friend_codes table to schema.sql
2. **Store Layer** - Implement DuckDB store for friend codes
3. **Feature Layer** - Create friendcode service with business logic
4. **HTTP Handlers** - Add endpoints to web server
5. **UI Components** - Add QR modal and buttons to app.html
6. **E2E Tests** - Add Playwright tests for the feature

### Dependencies

- `github.com/skip2/go-qrcode` (server-side fallback)
- Client-side: qrcode.js via CDN for rendering

### Test Plan

**E2E Tests (e2e/tests/qr-friend.spec.ts):**

1. `TC-QR-001`: QR modal opens and shows user's code
2. `TC-QR-002`: Copy link button works
3. `TC-QR-003`: Resolve valid friend code shows user info
4. `TC-QR-004`: Add friend via code creates contact
5. `TC-QR-005`: Cannot add self via own code
6. `TC-QR-006`: Cannot add existing contact
7. `TC-QR-007`: Expired code returns error
8. `TC-QR-008`: Invalid code returns error
9. `TC-QR-009`: Revoke code invalidates it

## Alternatives Considered

1. **Phone Number Sharing**: Requires phone verification, privacy concerns
2. **Username Search Only**: Error-prone, requires exact match
3. **NFC Sharing**: Limited device support

## Open Questions

1. Should codes be single-use or multi-use?
   - Decision: Multi-use within expiration period (simpler UX)

2. Code expiration duration?
   - Decision: 24 hours (balance security/convenience)

3. Should we support "permanent" friend links?
   - Decision: Not in v1, can add later if needed
