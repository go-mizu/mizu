# Spec 0130: Homepage Fix and UI Testing

## Problem Analysis

### Root Cause: Template Content Block Collision

The error `template: user.html:16:51: executing "content" at <slice .Data.User.Username 0 1>: error calling slice: slice of untyped nil` occurs on the homepage ("/") because:

1. **All page templates define the same `{{define "content"}}` block**
2. When Go's `template.ParseFS()` loads multiple files, later definitions of the same block **overwrite** earlier ones
3. The load order `pages/*.html` is alphabetical, so `user.html` is loaded after `home.html`
4. This means the "content" block from `user.html` is used for ALL pages
5. When rendering home.html, it actually renders user.html's content block, which expects `.Data.User` to exist

### Files Affected

```
assets/views/pages/
├── all.html          # defines {{define "content"}}
├── board.html        # defines {{define "content"}}
├── bookmarks.html    # defines {{define "content"}}
├── error.html        # defines {{define "content"}}
├── home.html         # defines {{define "content"}}
├── login.html        # defines {{define "content"}}
├── notifications.html # defines {{define "content"}}
├── register.html     # defines {{define "content"}}
├── search.html       # defines {{define "content"}}
├── settings.html     # defines {{define "content"}}
├── submit.html       # defines {{define "content"}}
├── thread.html       # defines {{define "content"}}
└── user.html         # defines {{define "content"}} <-- LAST = WINS
```

## Solution Design

### Option 1: Clone Templates Per Page (Selected)

Create a separate template clone for each page, parsing layout + components + specific page file.

**Pros:**
- Clean isolation between pages
- Each page has its own "content" block
- No changes to template files needed

**Cons:**
- Slightly more memory (negligible)
- Template parsing code changes needed

### Option 2: Page-Specific Content Blocks

Change each page to define unique content blocks like `{{define "content_home"}}`.

**Pros:**
- Simple concept

**Cons:**
- Requires modifying all template files
- Need to dynamically select which content block to render
- More error-prone

### Option 3: Nested Templates with Execute

Use `{{template "page.html" .}}` pattern where each page is a standalone template.

**Pros:**
- Standard Go template pattern

**Cons:**
- Major restructure of all templates
- Breaking change

## Implementation Plan

### Phase 1: Fix Template Loading (assets/embed.go)

Replace single template with per-page template cloning:

```go
// TemplateMap returns templates keyed by page name.
func TemplateMap() (map[string]*template.Template, error) {
    baseTmpl := template.New("")
    baseTmpl = baseTmpl.Funcs(templateFuncs())

    // Parse layouts and components first
    baseTmpl, err := baseTmpl.ParseFS(Views(), "layouts/*.html", "components/*.html")
    if err != nil {
        return nil, err
    }

    // Create a map of page templates
    templates := make(map[string]*template.Template)

    // For each page file, clone the base and parse the page
    pageFiles, _ := fs.Glob(Views(), "pages/*.html")
    for _, pageFile := range pageFiles {
        pageName := filepath.Base(pageFile) // e.g., "home.html"

        // Clone base template
        pageTemplate, err := baseTmpl.Clone()
        if err != nil {
            return nil, err
        }

        // Parse just this page
        pageTemplate, err = pageTemplate.ParseFS(Views(), pageFile)
        if err != nil {
            return nil, err
        }

        templates[pageName] = pageTemplate
    }

    return templates, nil
}
```

### Phase 2: Update Server (app/web/server.go)

Change from single template to template map:

```go
type Server struct {
    // ...
    templates map[string]*template.Template  // Changed from *template.Template
}
```

### Phase 3: Update Handler (app/web/handler/page.go)

Update render function to select correct template:

```go
func (h *Page) render(c *mizu.Ctx, name string, data PageData) error {
    tmpl, ok := h.templates[name]
    if !ok {
        return fmt.Errorf("template %s not found", name)
    }

    c.Writer().Header().Set("Content-Type", "text/html; charset=utf-8")
    // ... get current user ...

    return tmpl.ExecuteTemplate(c.Writer(), name, data)
}
```

### Phase 4: Create Comprehensive UI Tests (server_ui_test.go)

Create tests that:
1. Visit every page route
2. Verify HTTP 200 status
3. Verify no template errors in response body
4. Check for expected content on each page
5. Test with and without authentication
6. Test with test data (boards, threads, users)

Test structure:
```go
func TestUI_AllPagesRender(t *testing.T) {
    // Setup test server with seeded data

    pages := []struct {
        path        string
        requireAuth bool
        contains    []string
        setup       func() // optional setup like creating specific data
    }{
        {"/", false, []string{"<!DOCTYPE html", "Forum"}},
        {"/all", false, []string{"All Posts"}},
        {"/b/testboard", false, []string{"testboard"}},
        {"/u/testuser", false, []string{"testuser"}},
        {"/login", false, []string{"Log In"}},
        {"/register", false, []string{"Sign Up"}},
        {"/search", false, []string{"Search"}},
        {"/settings", true, []string{"Settings"}},
        {"/bookmarks", true, []string{"Bookmarks"}},
        {"/notifications", true, []string{"Notifications"}},
    }

    for _, page := range pages {
        t.Run(page.path, func(t *testing.T) {
            // Make request (with auth if needed)
            // Check status 200
            // Check body contains expected strings
            // Check body does NOT contain "error calling slice" or similar
        })
    }
}
```

### Phase 5: Homepage Enhancement

After fixing the template issue, enhance the homepage to show:

1. **Aggregated Content from All Boards**
   - Hot/trending threads from all boards
   - Recent activity feed
   - Top voted threads of the day/week

2. **Sidebar Widgets**
   - Popular communities (already implemented)
   - Recently active communities
   - Trending topics/tags
   - User statistics (if logged in)

Homepage data structure enhancement:
```go
type HomePageData struct {
    Threads       []*threads.Thread
    PopularBoards []*boards.Board
    ActiveBoards  []*boards.Board  // New
    Stats         *ForumStats      // New
    Sort          string
    TimeRange     string
}

type ForumStats struct {
    TotalUsers   int64
    TotalThreads int64
    TotalBoards  int64
    OnlineNow    int64
}
```

## Test Cases

### Template Rendering Tests

| Test Case | Route | Auth | Expected |
|-----------|-------|------|----------|
| Home page loads | `/` | No | 200, has "Forum" |
| Home page with user | `/` | Yes | 200, has username |
| All page | `/all` | No | 200, has threads |
| Board page exists | `/b/test` | No | 200, has board name |
| Board page 404 | `/b/nonexistent` | No | 200, error message |
| User page exists | `/u/testuser` | No | 200, has username |
| User page 404 | `/u/nobody` | No | 200, error message |
| Thread page | `/b/test/id/slug` | No | 200, thread content |
| Login page | `/login` | No | 200, login form |
| Register page | `/register` | No | 200, register form |
| Search page | `/search` | No | 200, search form |
| Search with query | `/search?q=test` | No | 200, results |
| Settings page | `/settings` | Yes | 200, settings form |
| Settings redirect | `/settings` | No | 302, redirect login |
| Bookmarks page | `/bookmarks` | Yes | 200, bookmarks |
| Notifications page | `/notifications` | Yes | 200, notifications |
| Submit page | `/b/test/submit` | Yes | 200, submit form |

### Error Detection Tests

Each test should verify:
- Response body does NOT contain "error calling"
- Response body does NOT contain "template:" followed by error
- Response body does NOT contain "nil pointer"
- Response body does NOT contain "panic"

## Files to Create/Modify

1. `assets/embed.go` - Template loading refactor
2. `app/web/server.go` - Use template map
3. `app/web/handler/page.go` - Update render function
4. `app/web/server_ui_test.go` - New comprehensive UI tests

## Execution Order

1. Create `server_ui_test.go` with failing tests (TDD)
2. Fix `assets/embed.go` template loading
3. Update `app/web/server.go`
4. Update `app/web/handler/page.go`
5. Run tests - verify all pass
6. Enhance homepage content (optional follow-up)
