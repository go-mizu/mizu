{{define "title"}}Search - Social{{end}}

{{template "base" .}}

{{define "content"}}
<header class="page-header">
    <a href="javascript:history.back()" class="back-btn" title="Back">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
    </a>
    <h1>Search</h1>
</header>

<div style="padding: var(--space-4);">
    <div class="search-box">
        <span class="search-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
        </span>
        <form id="search-form" class="search-form" action="/search" method="get">
            <input type="text" name="q" value="{{.Query}}" placeholder="Search posts, people, or tags..." autofocus>
        </form>
    </div>
</div>

<nav class="search-tabs">
    <button class="search-tab active" data-type="">All</button>
    <button class="search-tab" data-type="accounts">People</button>
    <button class="search-tab" data-type="posts">Posts</button>
    <button class="search-tab" data-type="hashtags">Tags</button>
</nav>

<div id="results">
    {{if .Query}}
    <div class="loading"></div>
    {{else}}
    <div class="empty">
        <div class="icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
        </div>
        <h3>Search Social</h3>
        <p>Find people, posts, and trending topics</p>
    </div>
    {{end}}
</div>
{{end}}

{{define "scripts"}}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const query = new URLSearchParams(window.location.search).get('q');
    if (query) search(query);
    setupTabs();
});

function setupTabs() {
    document.querySelectorAll('.search-tabs .search-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            document.querySelectorAll('.search-tabs .search-tab').forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            const query = document.querySelector('input[name="q"]').value;
            if (query) search(query, this.dataset.type);
        });
    });
}

async function search(query, type = '') {
    const results = document.getElementById('results');
    results.innerHTML = '<div class="loading"></div>';

    try {
        const url = new URL('/api/v1/search', window.location.origin);
        url.searchParams.set('q', query);
        if (type) url.searchParams.set('type', type);

        const res = await fetch(url);
        const data = await res.json();
        renderResults(data, type);
    } catch (err) {
        results.innerHTML = '<div class="empty"><h3>Search failed</h3><p>Please try again.</p></div>';
    }
}

function renderResults(data, type) {
    const results = document.getElementById('results');
    let html = '';

    // Accounts
    if ((!type || type === 'accounts') && data.accounts && data.accounts.length > 0) {
        data.accounts.forEach(a => {
            html += `
                <div class="account-item">
                    <div class="avatar">
                        <a href="/@${a.username}"><img src="${a.avatar_url || '/static/images/default-avatar.png'}" alt="${escapeHtml(a.display_name || a.username)}"></a>
                    </div>
                    <div class="info">
                        <a href="/@${a.username}" class="name">${escapeHtml(a.display_name || a.username)}</a>
                        <span class="handle">@${a.username}</span>
                    </div>
                    <button class="follow-chip" data-id="${a.id}">Follow</button>
                </div>
            `;
        });
    }

    // Hashtags
    if ((!type || type === 'hashtags') && data.hashtags && data.hashtags.length > 0) {
        html += '<div class="trending-chips" style="padding: var(--space-4);">';
        data.hashtags.forEach(t => {
            html += `<a href="/tags/${t.name}" class="trend-chip"><span>#${t.name}</span><span class="count">${t.posts_count}</span></a>`;
        });
        html += '</div>';
    }

    // Posts
    if ((!type || type === 'posts') && data.posts && data.posts.length > 0) {
        html += data.posts.map(renderPost).join('');
    }

    if (!html) {
        html = `
            <div class="empty">
                <h3>No results found</h3>
                <p>Try searching for something else</p>
            </div>
        `;
    }

    results.innerHTML = html;
}

function renderPost(post) {
    const account = post.account || {};
    const avatarUrl = account.avatar_url || '/static/images/default-avatar.png';
    const displayName = escapeHtml(account.display_name || account.username || 'Anonymous');
    const username = account.username || 'anonymous';

    return `
        <article class="content-card" onclick="window.location='/u/${username}/post/${post.id}'">
            <div class="card-main">
                <div class="card-header">
                    <a href="/@${username}" class="card-avatar" onclick="event.stopPropagation()">
                        <img src="${avatarUrl}" alt="${displayName}" loading="lazy">
                    </a>
                    <div class="card-user-info">
                        <div class="card-username">
                            <a href="/@${username}" class="display-name" onclick="event.stopPropagation()">${displayName}</a>
                        </div>
                        <span class="username">@${username}</span>
                    </div>
                </div>
                <div class="card-body">${formatContent(post.content)}</div>
            </div>
        </article>
    `;
}
</script>
{{end}}
