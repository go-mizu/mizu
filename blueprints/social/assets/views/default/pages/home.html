{{define "title"}}Home - Social{{end}}

{{template "base" .}}

{{define "content"}}
<!-- Compose box for creating new posts -->
<div class="compose-box" id="compose-section">
    <form id="compose-form" onsubmit="return submitPost(event)">
        <textarea name="content" placeholder="What's happening?" maxlength="500"></textarea>
        <button type="submit" class="btn-primary">Post</button>
    </form>
</div>

<div class="timeline" id="timeline">
    <div class="loading">Loading posts...</div>
</div>
{{end}}

{{define "scripts"}}
<script>
document.addEventListener('DOMContentLoaded', function() {
    loadTimeline('foryou');
});

window.loadTimeline = async function(type = 'foryou') {
    const timeline = document.getElementById('timeline');
    timeline.innerHTML = '<div class="loading"></div>';

    try {
        let endpoint = '/api/v1/timelines/public';
        if (type === 'following') {
            const res = await fetch('/api/v1/timelines/home');
            if (res.status === 401) {
                // Not logged in, show public timeline
                endpoint = '/api/v1/timelines/public';
            } else {
                const posts = await res.json();
                renderPosts(posts);
                return;
            }
        }
        const res = await fetch(endpoint);
        const posts = await res.json();
        renderPosts(posts);
    } catch (err) {
        console.error('Failed to load timeline:', err);
        timeline.innerHTML = '<div class="empty"><h3>Unable to load posts</h3><p>Please try again later.</p></div>';
    }
};

function renderPosts(posts) {
    const timeline = document.getElementById('timeline');
    if (!posts || posts.length === 0) {
        timeline.innerHTML = `
            <div class="empty">
                <div class="icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                </div>
                <h3>Welcome to your feed</h3>
                <p>When you follow people, their posts will show up here.</p>
            </div>
        `;
        return;
    }
    timeline.innerHTML = posts.map(renderPost).join('');
}

function renderPost(post) {
    const account = post.account || {};
    const avatarUrl = account.avatar_url || '/static/images/default-avatar.png';
    const displayName = escapeHtml(account.display_name || account.username || 'Anonymous');
    const username = account.username || 'anonymous';

    return `
        <article class="content-card" onclick="window.location='/u/${username}/post/${post.id}'">
            <div class="card-main">
                <div class="card-header">
                    <a href="/@${username}" class="card-avatar" onclick="event.stopPropagation()">
                        <img src="${avatarUrl}" alt="${displayName}" loading="lazy">
                    </a>
                    <div class="card-user-info">
                        <div class="card-username">
                            <a href="/@${username}" class="display-name" onclick="event.stopPropagation()">${displayName}</a>
                            ${account.verified ? '<svg class="verified-badge" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>' : ''}
                        </div>
                        <span class="username">@${username} Â· ${formatRelative(post.created_at)}</span>
                    </div>
                </div>
                <div class="card-body">${formatContent(post.content)}</div>
                <div class="card-actions" onclick="event.stopPropagation()">
                    <button class="action-btn comment" data-id="${post.id}" title="Comment">
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                        <span class="count">${post.replies_count || ''}</span>
                    </button>
                    <button class="action-btn repost ${post.reposted ? 'active' : ''}" data-id="${post.id}" title="Repost">
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m17 2 4 4-4 4"/><path d="M3 11v-1a4 4 0 0 1 4-4h14"/><path d="m7 22-4-4 4-4"/><path d="M21 13v1a4 4 0 0 1-4 4H3"/></svg>
                        <span class="count">${post.reposts_count || ''}</span>
                    </button>
                    <button class="action-btn like ${post.liked ? 'active' : ''}" data-id="${post.id}" title="Like">
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="${post.liked ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>
                        <span class="count">${post.likes_count || ''}</span>
                    </button>
                    <button class="action-btn bookmark ${post.bookmarked ? 'active' : ''}" data-id="${post.id}" title="Save">
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="${post.bookmarked ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m19 21-7-4-7 4V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v16z"/></svg>
                    </button>
                </div>
            </div>
        </article>
    `;
}
</script>
{{end}}
