{{define "title"}}Settings - Social{{end}}

{{template "base" .}}

{{define "content"}}
<div class="settings-page">
    <header class="page-header">
        <a href="javascript:history.back()" class="back-btn" title="Back">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
        </a>
        <h1>Settings</h1>
    </header>

    <div class="settings-section">
        <h2>Appearance</h2>
        <div class="settings-item">
            <div class="settings-item-info">
                <h3>Dark Mode</h3>
                <p>Switch between light and dark themes</p>
            </div>
            <label class="toggle">
                <input type="checkbox" id="theme-setting">
                <span class="toggle-slider"></span>
            </label>
        </div>
    </div>

    <div class="settings-section">
        <h2>Profile</h2>
        <form id="profile-form">
            <div class="form-group">
                <label for="display_name">Display Name</label>
                <input type="text" id="display_name" name="display_name" placeholder="Your name">
            </div>
            <div class="form-group">
                <label for="bio">Bio</label>
                <textarea id="bio" name="bio" maxlength="500" rows="3" placeholder="Tell people about yourself"></textarea>
            </div>
            <div class="form-group">
                <label for="location">Location</label>
                <input type="text" id="location" name="location" placeholder="Where are you?">
            </div>
            <div class="form-group">
                <label for="website">Website</label>
                <input type="url" id="website" name="website" placeholder="https://yourwebsite.com">
            </div>
            <button type="submit" class="btn-save">Save Profile</button>
        </form>
    </div>

    <div class="settings-section">
        <h2>Privacy</h2>
        <div class="settings-item">
            <div class="settings-item-info">
                <h3>Private Account</h3>
                <p>Only approved followers can see your posts</p>
            </div>
            <label class="toggle">
                <input type="checkbox" id="private-setting">
                <span class="toggle-slider"></span>
            </label>
        </div>
        <div class="settings-item">
            <div class="settings-item-info">
                <h3>Discoverable</h3>
                <p>Allow your profile in search and suggestions</p>
            </div>
            <label class="toggle">
                <input type="checkbox" id="discoverable-setting" checked>
                <span class="toggle-slider"></span>
            </label>
        </div>
    </div>

    <div class="settings-section">
        <h2>Account</h2>
        <a href="/logout" class="settings-item" style="color: var(--danger);">
            <div class="settings-item-info">
                <h3>Log out</h3>
            </div>
        </a>
    </div>
</div>
{{end}}

{{define "scripts"}}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const theme = localStorage.getItem('theme') || 'light';
    document.getElementById('theme-setting').checked = theme === 'dark';

    document.getElementById('theme-setting').addEventListener('change', function() {
        const newTheme = this.checked ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
    });

    loadProfile();
});

async function loadProfile() {
    try {
        const res = await fetch('/api/v1/accounts/verify_credentials');
        if (res.ok) {
            const account = await res.json();
            document.getElementById('display_name').value = account.display_name || '';
            document.getElementById('bio').value = account.bio || '';
            document.getElementById('location').value = account.location || '';
            document.getElementById('website').value = account.website || '';
            document.getElementById('private-setting').checked = account.private || false;
            document.getElementById('discoverable-setting').checked = account.discoverable !== false;
        }
    } catch (err) {
        console.error('Failed to load profile:', err);
    }
}

document.getElementById('profile-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    const btn = this.querySelector('button[type="submit"]');
    btn.disabled = true;
    btn.textContent = 'Saving...';

    try {
        await fetch('/api/v1/accounts/update_credentials', {
            method: 'PATCH',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                display_name: this.display_name.value,
                bio: this.bio.value,
                location: this.location.value,
                website: this.website.value
            })
        });
        btn.textContent = 'Saved!';
        setTimeout(() => btn.textContent = 'Save Profile', 2000);
    } catch (err) {
        console.error(err);
        btn.textContent = 'Error';
    } finally {
        btn.disabled = false;
    }
});
</script>
{{end}}
