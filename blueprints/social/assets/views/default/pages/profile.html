{{define "title"}}{{if .Account}}{{.Account.DisplayName}} (@{{.Account.Username}}){{else}}Profile{{end}} - Social{{end}}

{{template "base" .}}

{{define "content"}}
<div class="page profile-page">
    {{with .Account}}
    <header class="page-header">
        <a href="javascript:history.back()" class="back-btn" title="Back">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
        </a>
        <div>
            <h1>{{.DisplayName}}</h1>
            <p class="subtitle">{{.PostsCount}} posts</p>
        </div>
    </header>

    <div class="profile-header">
        <div class="profile-cover" style="{{if .HeaderURL}}background-image: url('{{.HeaderURL}}'){{end}}"></div>
        <div class="profile-info">
            <img class="profile-avatar" src="{{if .AvatarURL}}{{.AvatarURL}}{{else}}/static/images/default-avatar.png{{end}}" alt="{{.DisplayName}}">
            <div class="profile-actions">
                <button class="follow-btn" id="follow-btn" data-id="{{.ID}}">Follow</button>
            </div>
        </div>
        <div class="profile-details">
            <h1>{{.DisplayName}}{{if .Verified}} <span class="verified" title="Verified">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
            </span>{{end}}</h1>
            <span class="username">@{{.Username}}</span>
        </div>
        {{if .Bio}}
        <p class="profile-bio">{{.Bio}}</p>
        {{end}}
        <div class="profile-meta">
            {{if .Location}}
            <span class="location">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>
                {{.Location}}
            </span>
            {{end}}
            {{if .Website}}
            <a href="{{.Website}}" class="website" target="_blank" rel="noopener">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
                {{.Website}}
            </a>
            {{end}}
            <span class="joined">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>
                Joined {{formatTime .CreatedAt}}
            </span>
        </div>
        <div class="profile-stats">
            <a href="/@{{.Username}}/following">
                <strong>{{.FollowingCount}}</strong> Following
            </a>
            <a href="/@{{.Username}}/followers">
                <strong>{{.FollowersCount}}</strong> Followers
            </a>
        </div>
    </div>

    <nav class="profile-tabs">
        <button class="tab active" data-tab="posts">Posts</button>
        <button class="tab" data-tab="replies">Replies</button>
        <button class="tab" data-tab="media">Media</button>
        <button class="tab" data-tab="likes">Likes</button>
    </nav>

    <div class="timeline" id="timeline" data-account-id="{{.ID}}" data-username="{{.Username}}">
        <div class="loading">Loading posts...</div>
    </div>
    {{else}}
    <div class="error-page">
        <div class="error-code">404</div>
        <h1>Account not found</h1>
        <p>The account you're looking for doesn't exist or has been removed.</p>
        <a href="/">Go home</a>
    </div>
    {{end}}
</div>
{{end}}

{{define "scripts"}}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const accountId = document.getElementById('timeline')?.dataset?.accountId;
    if (accountId) {
        loadPosts(accountId, 'posts');
        setupTabs(accountId);
        setupFollowButton();
    }
});

function setupTabs(accountId) {
    document.querySelectorAll('.profile-tabs .tab').forEach(tab => {
        tab.addEventListener('click', function() {
            document.querySelectorAll('.profile-tabs .tab').forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            loadPosts(accountId, this.dataset.tab);
        });
    });
}

async function loadPosts(accountId, tab = 'posts') {
    const timeline = document.getElementById('timeline');
    timeline.innerHTML = '<div class="loading">Loading...</div>';

    try {
        let endpoint = `/api/v1/accounts/${accountId}/posts`;
        if (tab === 'replies') endpoint += '?replies=true';
        if (tab === 'media') endpoint += '?media=true';
        if (tab === 'likes') endpoint = `/api/v1/accounts/${accountId}/likes`;

        const res = await fetch(endpoint);
        const posts = await res.json();
        renderPosts(posts, tab);
    } catch (err) {
        console.error('Failed to load posts:', err);
        timeline.innerHTML = '<div class="empty"><h3>Unable to load posts</h3></div>';
    }
}

function renderPosts(posts, tab) {
    const timeline = document.getElementById('timeline');
    if (!posts || posts.length === 0) {
        const messages = {
            posts: 'No posts yet',
            replies: 'No replies yet',
            media: 'No media posts yet',
            likes: 'No liked posts yet'
        };
        timeline.innerHTML = `<div class="empty"><h3>${messages[tab] || 'No posts'}</h3></div>`;
        return;
    }
    timeline.innerHTML = posts.map(renderPost).join('');
}

function renderPost(post) {
    const account = post.account || {};
    const avatarUrl = account.avatar_url || '/static/images/default-avatar.png';
    const displayName = escapeHtml(account.display_name || account.username || 'Anonymous');
    const username = account.username || 'anonymous';

    return `
        <article class="post" data-id="${post.id}" onclick="window.location='/posts/${post.id}'">
            <div class="post-avatar">
                <a href="/@${username}" onclick="event.stopPropagation()">
                    <img src="${avatarUrl}" alt="${displayName}" loading="lazy">
                </a>
            </div>
            <div class="post-content">
                <div class="post-header">
                    <a href="/@${username}" class="display-name" onclick="event.stopPropagation()">${displayName}</a>
                    <span class="username">@${username}</span>
                    <span class="timestamp">${formatRelative(post.created_at)}</span>
                </div>
                <div class="post-body">${formatContent(post.content)}</div>
                <div class="post-actions" onclick="event.stopPropagation()">
                    <button class="action reply" data-id="${post.id}" title="Reply">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                        <span class="count">${post.replies_count || ''}</span>
                    </button>
                    <button class="action repost ${post.reposted ? 'active' : ''}" data-id="${post.id}" title="Repost">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m17 2 4 4-4 4"/><path d="M3 11v-1a4 4 0 0 1 4-4h14"/><path d="m7 22-4-4 4-4"/><path d="M21 13v1a4 4 0 0 1-4 4H3"/></svg>
                        <span class="count">${post.reposts_count || ''}</span>
                    </button>
                    <button class="action like ${post.liked ? 'active' : ''}" data-id="${post.id}" title="Like">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="${post.liked ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>
                        <span class="count">${post.likes_count || ''}</span>
                    </button>
                    <button class="action bookmark ${post.bookmarked ? 'active' : ''}" data-id="${post.id}" title="Bookmark">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="${post.bookmarked ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m19 21-7-4-7 4V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v16z"/></svg>
                    </button>
                </div>
            </div>
        </article>
    `;
}

function setupFollowButton() {
    const btn = document.getElementById('follow-btn');
    if (!btn) return;

    btn.addEventListener('click', async function() {
        const accountId = this.dataset.id;
        const isFollowing = this.classList.contains('following');

        this.disabled = true;
        try {
            const res = await fetch(`/api/v1/accounts/${accountId}/${isFollowing ? 'unfollow' : 'follow'}`, {method: 'POST'});
            if (res.ok) {
                this.classList.toggle('following');
                this.textContent = isFollowing ? 'Follow' : 'Following';
            }
        } catch (err) {
            console.error('Follow failed:', err);
        } finally {
            this.disabled = false;
        }
    });
}

function formatRelative(dateStr) {
    const date = new Date(dateStr);
    const now = new Date();
    const diff = now - date;
    const mins = Math.floor(diff / 60000);
    const hours = Math.floor(diff / 3600000);
    const days = Math.floor(diff / 86400000);

    if (mins < 1) return 'now';
    if (mins < 60) return mins + 'm';
    if (hours < 24) return hours + 'h';
    if (days < 7) return days + 'd';
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}

function formatContent(text) {
    if (!text) return '';
    let html = escapeHtml(text);
    html = html.replace(/#(\w+)/g, '<span class="hashtag">#$1</span>');
    html = html.replace(/@(\w+)/g, '<a href="/@$1" class="mention" onclick="event.stopPropagation()">@$1</a>');
    return html;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{{end}}
