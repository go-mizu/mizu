{{template "layouts/default.html" .}}

{{define "title"}}{{.Thread.Title}} - {{.Forum.Name}} - Mizu Forum{{end}}
{{define "description"}}{{if .Thread.Content}}{{slice .Thread.Content 0 200}}{{else}}{{.Thread.Title}}{{end}}{{end}}

{{define "content"}}
<!-- Breadcrumb -->
<nav class="breadcrumb">
    <div class="breadcrumb__item">
        <a href="/">Home</a>
        <span class="breadcrumb__separator">‚Ä∫</span>
    </div>
    <div class="breadcrumb__item">
        <a href="/f/{{.Forum.Slug}}">{{.Forum.Name}}</a>
        <span class="breadcrumb__separator">‚Ä∫</span>
    </div>
    <div class="breadcrumb__item">
        <span>{{.Thread.Title}}</span>
    </div>
</nav>

<div class="page-layout page-layout--with-sidebar">
    <div class="main-content">
        <!-- Thread Card -->
        <div class="card mb-6">
            <div class="card__body" style="display: flex; gap: var(--space-4);">
                <!-- Vote Controls -->
                <div style="flex-shrink: 0;">
                    {{template "vote_controls" (dict "Type" "thread" "ID" .Thread.ID "Score" .Thread.Score "UserVote" .Thread.UserVote "User" .User)}}
                </div>

                <!-- Thread Content -->
                <div style="flex: 1; min-width: 0;">
                    <h1 style="margin-bottom: var(--space-4);">{{.Thread.Title}}</h1>

                    <div class="flex items-center gap-3 mb-4 text-sm text-muted">
                        <a href="/u/{{.Thread.Account.Username}}" class="user-badge">
                            <span class="user-badge__avatar">{{slice .Thread.Account.Username 0 1 | toUpper}}</span>
                            <span class="user-badge__name">{{.Thread.Account.Username}}</span>
                        </a>
                        <span>¬∑</span>
                        <span>{{.Thread.CreatedAt.Format "2 Jan 2006 15:04"}}</span>
                        <span>¬∑</span>
                        <span>üëÅ {{.Thread.ViewCount}} views</span>
                    </div>

                    {{if .Thread.Tags}}
                    <div class="flex gap-2 mb-4">
                        {{range .Thread.Tags}}
                        <span class="tag">{{.}}</span>
                        {{end}}
                    </div>
                    {{end}}

                    {{if or .Thread.Sticky .Thread.Locked .Thread.NSFW}}
                    <div class="flex gap-2 mb-4">
                        {{if .Thread.Sticky}}<span class="badge badge--sticky">Sticky</span>{{end}}
                        {{if .Thread.Locked}}<span class="badge badge--locked">Locked</span>{{end}}
                        {{if .Thread.NSFW}}<span class="badge badge--nsfw">NSFW</span>{{end}}
                    </div>
                    {{end}}

                    {{if .Thread.Content}}
                    <div class="mb-4" style="line-height: 1.6; white-space: pre-wrap;">{{.Thread.Content}}</div>
                    {{end}}

                    <div class="flex gap-4 text-sm" style="padding-top: var(--space-4); border-top: 1px solid var(--color-border);">
                        {{if .User}}
                            {{if .Thread.IsOwner}}
                            <a href="/f/{{.Forum.Slug}}/t/{{.Thread.ID}}/edit" class="post-card__action">Edit</a>
                            <a href="#" class="post-card__action" data-action="delete-thread">Delete</a>
                            {{end}}
                            <a href="#" class="post-card__action" data-action="save-thread">
                                {{if .Thread.IsSaved}}Unsave{{else}}Save{{end}}
                            </a>
                            <a href="#" class="post-card__action" data-action="subscribe">
                                {{if .Thread.IsSubscribed}}Unsubscribe{{else}}Subscribe{{end}}
                            </a>
                        {{end}}
                        <a href="#" class="post-card__action">Share</a>
                        <a href="#" class="post-card__action" data-action="report-thread">Report</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Comments Section -->
        <div class="card">
            <div class="card__header" style="display: flex; justify-content: space-between; align-items: center;">
                <h2 class="card__title">{{.Thread.PostCount}} Comments</h2>
                <div class="flex gap-2">
                    <a href="?sort=best" class="btn btn--sm {{if eq .Sort "best"}}btn--primary{{else}}btn--secondary{{end}}">Best</a>
                    <a href="?sort=new" class="btn btn--sm {{if eq .Sort "new"}}btn--primary{{else}}btn--secondary{{end}}">New</a>
                    <a href="?sort=old" class="btn btn--sm {{if eq .Sort "old"}}btn--primary{{else}}btn--secondary{{end}}">Old</a>
                    <a href="?sort=controversial" class="btn btn--sm {{if eq .Sort "controversial"}}btn--primary{{else}}btn--secondary{{end}}">Controversial</a>
                </div>
            </div>

            <div class="card__body">
                <!-- Comment Form -->
                {{if .User}}
                    {{if not .Thread.Locked}}
                    <div class="mb-6">
                        <form method="POST" action="/api/v1/threads/{{.Thread.ID}}/posts" class="comment-form">
                            <div class="form-group">
                                <label class="form-label">Add a comment</label>
                                <textarea name="content" class="form-textarea" placeholder="What are your thoughts?" required></textarea>
                                <span class="form-help">Markdown is supported</span>
                            </div>
                            <button type="submit" class="btn btn--primary">Post Comment</button>
                        </form>
                    </div>
                    {{else}}
                    <div class="mb-6 text-center" style="padding: var(--space-6); background: var(--color-bg-alt); border-radius: var(--radius-md);">
                        <p class="text-muted">üîí This thread is locked. No new comments can be added.</p>
                    </div>
                    {{end}}
                {{else}}
                <div class="mb-6 text-center" style="padding: var(--space-6); background: var(--color-bg-alt); border-radius: var(--radius-md);">
                    <p class="text-muted mb-3">Join the discussion!</p>
                    <a href="/login" class="btn btn--primary">Login to Comment</a>
                </div>
                {{end}}

                <!-- Comments List -->
                {{if .Posts}}
                <div class="post-list">
                    {{range .Posts}}
                        {{template "post_card" (dict "ID" .ID "Account" .Account "Content" .Content "Score" .Score "UserVote" .UserVote "Depth" .Depth "CreatedAt" .CreatedAt "EditedAt" .EditedAt "IsBest" .IsBest "IsOwner" .IsOwner "IsSaved" .IsSaved "Children" .Children "User" $.User)}}
                    {{end}}
                </div>
                {{else}}
                <div class="text-center" style="padding: var(--space-8) 0;">
                    <p class="text-muted">No comments yet. Be the first to comment!</p>
                </div>
                {{end}}
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar-content">
        {{template "sidebar" (dict "ShowAbout" true "ShowRules" true "Forum" .Forum "User" .User)}}
    </div>
</div>
{{end}}
