# Production-grade S3-compatible storage services for comprehensive testing
# Use with: docker compose up -d
# Individual services: docker compose up -d minio rustfs

services:
  # ============================================================================
  # MinIO - Industry reference for S3 compatibility (Go)
  # https://github.com/minio/minio
  # ============================================================================
  minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000"   # S3 API
      - "9001:9001"   # Console UI
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    volumes:
      - minio_data:/data
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 5s
      timeout: 5s
      retries: 5

  minio-init:
    image: minio/mc:latest
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      mc alias set myminio http://minio:9000 minioadmin minioadmin;
      mc mb myminio/test-bucket --ignore-existing;
      exit 0;
      "

  # ============================================================================
  # RustFS - High-performance S3 storage (Rust) - 2.3x faster than MinIO
  # https://github.com/rustfs/rustfs
  # ============================================================================
  rustfs:
    image: rustfs/rustfs:latest
    ports:
      - "9100:9000"   # S3 API
      - "9101:9001"   # Console UI
    environment:
      RUSTFS_VOLUMES: /data
      RUSTFS_ACCESS_KEY: rustfsadmin
      RUSTFS_SECRET_KEY: rustfsadmin
      RUSTFS_CONSOLE_ADDRESS: ":9001"
    volumes:
      - rustfs_data:/data
    user: "10001:10001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 15s

  # ============================================================================
  # SeaweedFS - High-performance distributed object storage (Go)
  # https://github.com/seaweedfs/seaweedfs
  # ============================================================================
  seaweedfs-master:
    image: chrislusf/seaweedfs:latest
    command: master -ip=seaweedfs-master -volumeSizeLimitMB=100
    ports:
      - "9333:9333"
    volumes:
      - seaweedfs_master:/data

  seaweedfs-volume:
    image: chrislusf/seaweedfs:latest
    command: volume -mserver="seaweedfs-master:9333" -port=8080 -ip=seaweedfs-volume
    depends_on:
      - seaweedfs-master
    volumes:
      - seaweedfs_volume:/data

  seaweedfs-filer:
    image: chrislusf/seaweedfs:latest
    command: filer -master="seaweedfs-master:9333" -ip=seaweedfs-filer
    depends_on:
      - seaweedfs-master
      - seaweedfs-volume
    ports:
      - "8888:8888"

  seaweedfs-s3:
    image: chrislusf/seaweedfs:latest
    command: s3 -filer="seaweedfs-filer:8888" -port=8333
    depends_on:
      - seaweedfs-filer
    ports:
      - "8333:8333"   # S3 API
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8333/"]
      interval: 10s
      timeout: 10s
      retries: 20
      start_period: 60s

  # ============================================================================
  # Garage - Lightweight decentralized S3 storage (Rust)
  # https://garagehq.deuxfleurs.fr/
  # ============================================================================
  garage:
    image: dxflrs/garage:v0.9.4
    command: server
    ports:
      - "3900:3900"   # S3 API
      - "3902:3902"   # Admin API
    environment:
      GARAGE_ALLOW_WORLD_READABLE_SECRETS: "true"
    volumes:
      - garage_data:/var/lib/garage/data
      - garage_meta:/var/lib/garage/meta
      - ./garage.toml:/etc/garage.toml:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3902/health"]
      interval: 10s
      timeout: 10s
      retries: 30
      start_period: 30s

  # ============================================================================
  # Zenko CloudServer - Scality's S3 server (Node.js)
  # https://github.com/scality/cloudserver
  # ============================================================================
  zenko:
    image: zenko/cloudserver:latest
    ports:
      - "8000:8000"   # S3 API
    environment:
      SCALITY_ACCESS_KEY_ID: accessKey1
      SCALITY_SECRET_ACCESS_KEY: verySecretKey1
      S3DATA: file
      S3BACKEND: file
      REMOTE_MANAGEMENT_DISABLE: "1"
    volumes:
      - zenko_data:/usr/src/app/localData
      - zenko_metadata:/usr/src/app/localMetadata
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/_/healthcheck"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 15s

  # ============================================================================
  # LocalStack - AWS Local Testing (Python)
  # https://github.com/localstack/localstack
  # ============================================================================
  localstack:
    image: localstack/localstack:latest
    ports:
      - "4566:4566"   # S3 API
    environment:
      SERVICES: s3
      DEBUG: 0
      AWS_DEFAULT_REGION: us-east-1
      AWS_ACCESS_KEY_ID: test
      AWS_SECRET_ACCESS_KEY: test
    volumes:
      - localstack_data:/var/lib/localstack
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4566/_localstack/health"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 30s

  localstack-init:
    image: amazon/aws-cli:latest
    depends_on:
      localstack:
        condition: service_healthy
    environment:
      AWS_ACCESS_KEY_ID: test
      AWS_SECRET_ACCESS_KEY: test
      AWS_DEFAULT_REGION: us-east-1
    entrypoint: >
      /bin/sh -c "
      aws --endpoint-url=http://localstack:4566 s3 mb s3://test-bucket || true;
      exit 0;
      "

volumes:
  minio_data:
  rustfs_data:
  seaweedfs_master:
  seaweedfs_volume:
  garage_data:
  garage_meta:
  zenko_data:
  zenko_metadata:
  localstack_data:
