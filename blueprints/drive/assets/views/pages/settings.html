{{define "content"}}
<div class="settings-view">
    <!-- Page Header -->
    <div class="page-header">
        <div class="page-header-icon">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="var(--text-secondary)" stroke-width="2">
                <circle cx="12" cy="12" r="3"/>
                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
            </svg>
        </div>
        <div class="page-header-text">
            <h1>Settings</h1>
        </div>
    </div>

    <!-- Settings Navigation -->
    <div class="settings-layout">
        <nav class="settings-nav">
            <a href="#general" class="settings-nav-item active" data-section="general">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"/>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                </svg>
                General
            </a>
            <a href="#profile" class="settings-nav-item" data-section="profile">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                    <circle cx="12" cy="7" r="4"/>
                </svg>
                Profile
            </a>
            <a href="#notifications" class="settings-nav-item" data-section="notifications">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                    <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                </svg>
                Notifications
            </a>
            <a href="#security" class="settings-nav-item" data-section="security">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                </svg>
                Security
            </a>
            <a href="#sharing" class="settings-nav-item" data-section="sharing">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="18" cy="5" r="3"/>
                    <circle cx="6" cy="12" r="3"/>
                    <circle cx="18" cy="19" r="3"/>
                    <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>
                    <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
                </svg>
                Sharing
            </a>
            <a href="#plan" class="settings-nav-item" data-section="plan">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                </svg>
                Plan & storage
            </a>
        </nav>

        <!-- Settings Content -->
        <div class="settings-content">
            <!-- General Section -->
            <section class="settings-section active" id="general">
                <h2>General</h2>

                <div class="settings-group">
                    <h3>Language & region</h3>
                    <div class="settings-item">
                        <div class="settings-item-info">
                            <label>Language</label>
                            <p>Choose your preferred language</p>
                        </div>
                        <select class="settings-select" id="language-select">
                            <option value="en" {{if eq .User.Language "en"}}selected{{end}}>English</option>
                            <option value="es" {{if eq .User.Language "es"}}selected{{end}}>Español</option>
                            <option value="fr" {{if eq .User.Language "fr"}}selected{{end}}>Français</option>
                            <option value="de" {{if eq .User.Language "de"}}selected{{end}}>Deutsch</option>
                            <option value="ja" {{if eq .User.Language "ja"}}selected{{end}}>日本語</option>
                            <option value="zh" {{if eq .User.Language "zh"}}selected{{end}}>中文</option>
                        </select>
                    </div>
                    <div class="settings-item">
                        <div class="settings-item-info">
                            <label>Date format</label>
                            <p>How dates should be displayed</p>
                        </div>
                        <select class="settings-select" id="date-format-select">
                            <option value="mdy" {{if eq .User.DateFormat "mdy"}}selected{{end}}>MM/DD/YYYY</option>
                            <option value="dmy" {{if eq .User.DateFormat "dmy"}}selected{{end}}>DD/MM/YYYY</option>
                            <option value="ymd" {{if eq .User.DateFormat "ymd"}}selected{{end}}>YYYY-MM-DD</option>
                        </select>
                    </div>
                </div>

                <div class="settings-group">
                    <h3>Appearance</h3>
                    <div class="settings-item">
                        <div class="settings-item-info">
                            <label>Theme</label>
                            <p>Choose your preferred color scheme</p>
                        </div>
                        <div class="theme-selector">
                            <button class="theme-option {{if eq .User.Theme "light"}}active{{end}}" data-theme="light">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="5"/>
                                    <line x1="12" y1="1" x2="12" y2="3"/>
                                    <line x1="12" y1="21" x2="12" y2="23"/>
                                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                                    <line x1="1" y1="12" x2="3" y2="12"/>
                                    <line x1="21" y1="12" x2="23" y2="12"/>
                                    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                                    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                                </svg>
                                Light
                            </button>
                            <button class="theme-option {{if eq .User.Theme "dark"}}active{{end}}" data-theme="dark">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                                </svg>
                                Dark
                            </button>
                            <button class="theme-option {{if eq .User.Theme "auto"}}active{{end}}" data-theme="auto">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="2" y="3" width="20" height="14" rx="2" ry="2"/>
                                    <line x1="8" y1="21" x2="16" y2="21"/>
                                    <line x1="12" y1="17" x2="12" y2="21"/>
                                </svg>
                                System
                            </button>
                        </div>
                    </div>
                    <div class="settings-item">
                        <div class="settings-item-info">
                            <label>Default view</label>
                            <p>How files should be displayed by default</p>
                        </div>
                        <div class="view-selector">
                            <button class="view-option {{if eq .User.DefaultView "grid"}}active{{end}}" data-view="grid">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/>
                                    <rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/>
                                </svg>
                                Grid
                            </button>
                            <button class="view-option {{if eq .User.DefaultView "list"}}active{{end}}" data-view="list">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="8" y1="6" x2="21" y2="6"/>
                                    <line x1="8" y1="12" x2="21" y2="12"/>
                                    <line x1="8" y1="18" x2="21" y2="18"/>
                                    <line x1="3" y1="6" x2="3.01" y2="6"/>
                                    <line x1="3" y1="12" x2="3.01" y2="12"/>
                                    <line x1="3" y1="18" x2="3.01" y2="18"/>
                                </svg>
                                List
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Profile Section -->
            <section class="settings-section" id="profile">
                <h2>Profile</h2>

                <div class="settings-group">
                    <h3>Personal info</h3>
                    <div class="profile-card">
                        <div class="profile-avatar-section">
                            <div class="profile-avatar">
                                <img src="{{.User.Avatar}}" alt="{{.User.Name}}" id="avatar-preview">
                            </div>
                            <div class="profile-avatar-actions">
                                <button class="btn btn-secondary btn-sm" id="change-avatar-btn">Change photo</button>
                                <button class="btn btn-link btn-sm danger" id="remove-avatar-btn">Remove</button>
                                <input type="file" id="avatar-input" accept="image/*" hidden>
                            </div>
                        </div>
                    </div>

                    <div class="settings-item">
                        <div class="settings-item-info">
                            <label for="display-name">Display name</label>
                        </div>
                        <input type="text" id="display-name" class="settings-input" value="{{.User.Name}}">
                    </div>
                    <div class="settings-item">
                        <div class="settings-item-info">
                            <label for="email">Email</label>
                        </div>
                        <input type="email" id="email" class="settings-input" value="{{.User.Email}}" readonly>
                        <button class="btn btn-link btn-sm">Change</button>
                    </div>
                </div>
            </section>

            <!-- Notifications Section -->
            <section class="settings-section" id="notifications">
                <h2>Notifications</h2>

                <div class="settings-group">
                    <h3>Email notifications</h3>
                    <div class="settings-item">
                        <div class="settings-item-info">
                            <label>File activity</label>
                            <p>Get notified when someone shares, comments, or makes changes</p>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" id="notify-file-activity" {{if .User.Notifications.FileActivity}}checked{{end}}>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="settings-item">
                        <div class="settings-item-info">
                            <label>File requests</label>
                            <p>Get notified when someone uploads files to your request</p>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" id="notify-file-requests" {{if .User.Notifications.FileRequests}}checked{{end}}>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="settings-item">
                        <div class="settings-item-info">
                            <label>Comments & mentions</label>
                            <p>Get notified when someone mentions you in a comment</p>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" id="notify-comments" {{if .User.Notifications.Comments}}checked{{end}}>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="settings-item">
                        <div class="settings-item-info">
                            <label>Weekly digest</label>
                            <p>Receive a weekly summary of activity</p>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" id="notify-digest" {{if .User.Notifications.WeeklyDigest}}checked{{end}}>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>

                <div class="settings-group">
                    <h3>Browser notifications</h3>
                    <div class="settings-item">
                        <div class="settings-item-info">
                            <label>Desktop notifications</label>
                            <p>Show browser notifications for important events</p>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" id="notify-desktop" {{if .User.Notifications.Desktop}}checked{{end}}>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </section>

            <!-- Security Section -->
            <section class="settings-section" id="security">
                <h2>Security</h2>

                <div class="settings-group">
                    <h3>Password</h3>
                    <div class="settings-item">
                        <div class="settings-item-info">
                            <label>Change password</label>
                            <p>Last changed {{.User.PasswordChangedAt | formatDate}}</p>
                        </div>
                        <button class="btn btn-secondary" id="change-password-btn">Change password</button>
                    </div>
                </div>

                <div class="settings-group">
                    <h3>Two-factor authentication</h3>
                    <div class="settings-item">
                        <div class="settings-item-info">
                            <label>Status</label>
                            <p>{{if .User.TwoFactorEnabled}}Two-factor authentication is enabled{{else}}Add an extra layer of security to your account{{end}}</p>
                        </div>
                        {{if .User.TwoFactorEnabled}}
                        <button class="btn btn-secondary" id="disable-2fa-btn">Disable</button>
                        {{else}}
                        <button class="btn btn-primary" id="enable-2fa-btn">Enable</button>
                        {{end}}
                    </div>
                </div>

                <div class="settings-group">
                    <h3>Sessions</h3>
                    <p class="settings-description">Devices and browsers where you're currently logged in</p>

                    <div class="sessions-list">
                        {{range .User.Sessions}}
                        <div class="session-item {{if .Current}}current{{end}}" data-id="{{.ID}}">
                            <div class="session-icon">
                                {{if eq .DeviceType "desktop"}}
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="2" y="3" width="20" height="14" rx="2" ry="2"/>
                                    <line x1="8" y1="21" x2="16" y2="21"/>
                                    <line x1="12" y1="17" x2="12" y2="21"/>
                                </svg>
                                {{else if eq .DeviceType "mobile"}}
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="5" y="2" width="14" height="20" rx="2" ry="2"/>
                                    <line x1="12" y1="18" x2="12.01" y2="18"/>
                                </svg>
                                {{else}}
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="2" y="3" width="20" height="14" rx="2" ry="2"/>
                                    <line x1="8" y1="21" x2="16" y2="21"/>
                                    <line x1="12" y1="17" x2="12" y2="21"/>
                                </svg>
                                {{end}}
                            </div>
                            <div class="session-info">
                                <div class="session-name">
                                    {{.Browser}} on {{.OS}}
                                    {{if .Current}}<span class="badge">Current</span>{{end}}
                                </div>
                                <div class="session-meta">
                                    <span>{{.Location}}</span>
                                    <span>Last active {{.LastActive | formatRelativeTime}}</span>
                                </div>
                            </div>
                            {{if not .Current}}
                            <button class="btn btn-link danger btn-sm" data-action="revoke-session">Sign out</button>
                            {{end}}
                        </div>
                        {{end}}
                    </div>

                    <button class="btn btn-link danger" id="sign-out-all-btn">Sign out of all other sessions</button>
                </div>
            </section>

            <!-- Sharing Section -->
            <section class="settings-section" id="sharing">
                <h2>Sharing</h2>

                <div class="settings-group">
                    <h3>Default sharing settings</h3>
                    <div class="settings-item">
                        <div class="settings-item-info">
                            <label>Who can access</label>
                            <p>Default permission for new shares</p>
                        </div>
                        <select class="settings-select" id="default-permission">
                            <option value="view" {{if eq .User.DefaultSharePermission "view"}}selected{{end}}>Can view</option>
                            <option value="edit" {{if eq .User.DefaultSharePermission "edit"}}selected{{end}}>Can edit</option>
                        </select>
                    </div>
                    <div class="settings-item">
                        <div class="settings-item-info">
                            <label>Link expiration</label>
                            <p>Default expiration for shared links</p>
                        </div>
                        <select class="settings-select" id="default-link-expiration">
                            <option value="never" {{if eq .User.DefaultLinkExpiration "never"}}selected{{end}}>Never</option>
                            <option value="7days" {{if eq .User.DefaultLinkExpiration "7days"}}selected{{end}}>7 days</option>
                            <option value="30days" {{if eq .User.DefaultLinkExpiration "30days"}}selected{{end}}>30 days</option>
                            <option value="90days" {{if eq .User.DefaultLinkExpiration "90days"}}selected{{end}}>90 days</option>
                        </select>
                    </div>
                </div>

                <div class="settings-group">
                    <h3>Download permissions</h3>
                    <div class="settings-item">
                        <div class="settings-item-info">
                            <label>Allow downloads</label>
                            <p>People with view access can download files by default</p>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" id="allow-downloads" {{if .User.AllowDownloadsByDefault}}checked{{end}}>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </section>

            <!-- Plan & Storage Section -->
            <section class="settings-section" id="plan">
                <h2>Plan & storage</h2>

                <div class="settings-group">
                    <h3>Current plan</h3>
                    <div class="plan-card">
                        <div class="plan-info">
                            <div class="plan-name">{{.User.Plan.Name}}</div>
                            <div class="plan-description">{{.User.Plan.Description}}</div>
                        </div>
                        {{if not .User.Plan.IsFree}}
                        <div class="plan-billing">
                            <span class="plan-price">{{.User.Plan.Price}}/{{.User.Plan.Period}}</span>
                            <span class="plan-next-billing">Next billing: {{.User.Plan.NextBilling | formatDate}}</span>
                        </div>
                        {{end}}
                        <button class="btn btn-secondary" id="manage-plan-btn">
                            {{if .User.Plan.IsFree}}Upgrade{{else}}Manage plan{{end}}
                        </button>
                    </div>
                </div>

                <div class="settings-group">
                    <h3>Storage</h3>
                    <div class="storage-overview">
                        <div class="storage-bar">
                            <div class="storage-bar-fill" style="width: {{.User.StoragePercent}}%"></div>
                        </div>
                        <div class="storage-info">
                            <span>{{.User.StorageUsed | formatSize}} of {{.User.StorageQuota | formatSize}} used</span>
                            <span>{{.User.StoragePercent}}%</span>
                        </div>
                    </div>

                    <div class="storage-breakdown">
                        <h4>Storage breakdown</h4>
                        <div class="storage-items">
                            {{range .User.StorageBreakdown}}
                            <div class="storage-item">
                                <div class="storage-item-icon" style="background-color: {{.Color}}"></div>
                                <div class="storage-item-name">{{.Category}}</div>
                                <div class="storage-item-size">{{.Size | formatSize}}</div>
                                <div class="storage-item-bar">
                                    <div class="storage-item-bar-fill" style="width: {{.Percent}}%; background-color: {{.Color}}"></div>
                                </div>
                            </div>
                            {{end}}
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>
</div>

<!-- Change Password Modal -->
<div class="modal" id="password-modal">
    <div class="modal-overlay"></div>
    <div class="modal-container">
        <div class="modal-header">
            <h2>Change password</h2>
            <button class="modal-close" data-action="close">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <form id="password-form">
                <div class="form-group">
                    <label for="current-password">Current password</label>
                    <input type="password" id="current-password" name="current_password" required>
                </div>
                <div class="form-group">
                    <label for="new-password">New password</label>
                    <input type="password" id="new-password" name="new_password" required minlength="8">
                    <p class="form-hint">At least 8 characters</p>
                </div>
                <div class="form-group">
                    <label for="confirm-password">Confirm new password</label>
                    <input type="password" id="confirm-password" name="confirm_password" required>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" data-action="close">Cancel</button>
            <button class="btn btn-primary" id="save-password-btn">Change password</button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // Navigation
    document.querySelectorAll('.settings-nav-item').forEach(item => {
        item.addEventListener('click', (e) => {
            e.preventDefault();
            const section = item.dataset.section;

            // Update nav
            document.querySelectorAll('.settings-nav-item').forEach(i => i.classList.remove('active'));
            item.classList.add('active');

            // Update content
            document.querySelectorAll('.settings-section').forEach(s => s.classList.remove('active'));
            document.getElementById(section).classList.add('active');

            // Update URL
            history.pushState(null, '', `#${section}`);
        });
    });

    // Handle initial hash
    if (window.location.hash) {
        const section = window.location.hash.slice(1);
        document.querySelector(`.settings-nav-item[data-section="${section}"]`)?.click();
    }

    // Theme selector
    document.querySelectorAll('.theme-option').forEach(btn => {
        btn.addEventListener('click', async () => {
            const theme = btn.dataset.theme;
            document.querySelectorAll('.theme-option').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            if (theme === 'auto') {
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                document.documentElement.dataset.theme = prefersDark ? 'dark' : 'light';
            } else {
                document.documentElement.dataset.theme = theme;
            }

            try {
                await Drive.api.settings.update({ theme });
            } catch (error) {
                Drive.showToast('Failed to save theme', 'error');
            }
        });
    });

    // View selector
    document.querySelectorAll('.view-option').forEach(btn => {
        btn.addEventListener('click', async () => {
            const view = btn.dataset.view;
            document.querySelectorAll('.view-option').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            try {
                await Drive.api.settings.update({ default_view: view });
            } catch (error) {
                Drive.showToast('Failed to save view preference', 'error');
            }
        });
    });

    // Avatar change
    document.getElementById('change-avatar-btn')?.addEventListener('click', () => {
        document.getElementById('avatar-input').click();
    });

    document.getElementById('avatar-input')?.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append('avatar', file);

        try {
            const result = await Drive.api.settings.updateAvatar(formData);
            document.getElementById('avatar-preview').src = result.avatar_url;
            Drive.showToast('Avatar updated', 'success');
        } catch (error) {
            Drive.showToast('Failed to update avatar', 'error');
        }
    });

    document.getElementById('remove-avatar-btn')?.addEventListener('click', async () => {
        try {
            await Drive.api.settings.removeAvatar();
            document.getElementById('avatar-preview').src = '/static/images/default-avatar.png';
            Drive.showToast('Avatar removed', 'success');
        } catch (error) {
            Drive.showToast('Failed to remove avatar', 'error');
        }
    });

    // Password modal
    const passwordModal = document.getElementById('password-modal');

    document.getElementById('change-password-btn')?.addEventListener('click', () => {
        passwordModal.classList.add('open');
    });

    passwordModal.querySelectorAll('[data-action="close"]').forEach(btn => {
        btn.addEventListener('click', () => passwordModal.classList.remove('open'));
    });

    passwordModal.querySelector('.modal-overlay').addEventListener('click', () => {
        passwordModal.classList.remove('open');
    });

    document.getElementById('save-password-btn')?.addEventListener('click', async () => {
        const form = document.getElementById('password-form');
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const newPassword = document.getElementById('new-password').value;
        const confirmPassword = document.getElementById('confirm-password').value;

        if (newPassword !== confirmPassword) {
            Drive.showToast('Passwords do not match', 'error');
            return;
        }

        try {
            await Drive.api.settings.changePassword({
                current_password: document.getElementById('current-password').value,
                new_password: newPassword,
            });
            passwordModal.classList.remove('open');
            form.reset();
            Drive.showToast('Password changed successfully', 'success');
        } catch (error) {
            Drive.showToast('Failed to change password', 'error');
        }
    });

    // Session management
    document.querySelectorAll('[data-action="revoke-session"]').forEach(btn => {
        btn.addEventListener('click', async () => {
            const item = btn.closest('.session-item');
            const id = item.dataset.id;

            try {
                await Drive.api.settings.revokeSession(id);
                item.remove();
                Drive.showToast('Session revoked', 'success');
            } catch (error) {
                Drive.showToast('Failed to revoke session', 'error');
            }
        });
    });

    document.getElementById('sign-out-all-btn')?.addEventListener('click', async () => {
        if (confirm('Are you sure you want to sign out of all other sessions?')) {
            try {
                await Drive.api.settings.revokeAllSessions();
                document.querySelectorAll('.session-item:not(.current)').forEach(item => item.remove());
                Drive.showToast('Signed out of all other sessions', 'success');
            } catch (error) {
                Drive.showToast('Failed to sign out of sessions', 'error');
            }
        }
    });

    // Notification toggles
    document.querySelectorAll('[id^="notify-"]').forEach(toggle => {
        toggle.addEventListener('change', async () => {
            const setting = toggle.id.replace('notify-', '').replace(/-/g, '_');
            try {
                await Drive.api.settings.updateNotifications({ [setting]: toggle.checked });
            } catch (error) {
                Drive.showToast('Failed to update notification setting', 'error');
                toggle.checked = !toggle.checked;
            }
        });
    });

    // Other setting changes
    const autoSaveSettings = ['language-select', 'date-format-select', 'default-permission', 'default-link-expiration'];
    autoSaveSettings.forEach(id => {
        document.getElementById(id)?.addEventListener('change', async (e) => {
            const setting = id.replace(/-/g, '_').replace('_select', '');
            try {
                await Drive.api.settings.update({ [setting]: e.target.value });
                Drive.showToast('Setting saved', 'success');
            } catch (error) {
                Drive.showToast('Failed to save setting', 'error');
            }
        });
    });

    document.getElementById('allow-downloads')?.addEventListener('change', async (e) => {
        try {
            await Drive.api.settings.update({ allow_downloads_by_default: e.target.checked });
        } catch (error) {
            Drive.showToast('Failed to save setting', 'error');
            e.target.checked = !e.target.checked;
        }
    });

    // Display name save on blur
    document.getElementById('display-name')?.addEventListener('blur', async (e) => {
        try {
            await Drive.api.settings.update({ display_name: e.target.value });
        } catch (error) {
            Drive.showToast('Failed to save name', 'error');
        }
    });
});
</script>
{{end}}
