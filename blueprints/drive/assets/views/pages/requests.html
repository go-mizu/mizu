{{define "content"}}
<div class="requests-view">
    <!-- Page Header -->
    <div class="page-header">
        <div class="page-header-icon">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="var(--primary-color)" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="17 8 12 3 7 8"/>
                <line x1="12" y1="3" x2="12" y2="15"/>
            </svg>
        </div>
        <div class="page-header-text">
            <h1>File requests</h1>
            <p class="page-header-subtitle">Collect files from anyone, even if they don't have an account</p>
        </div>
        <div class="page-header-actions">
            <button class="btn btn-primary" id="new-request-btn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
                New file request
            </button>
        </div>
    </div>

    {{if .Requests}}
    <!-- Requests List -->
    <div class="requests-list">
        {{range .Requests}}
        <div class="request-card" data-id="{{.ID}}" data-status="{{.Status}}">
            <div class="request-card-header">
                <div class="request-card-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="17 8 12 3 7 8"/>
                        <line x1="12" y1="3" x2="12" y2="15"/>
                    </svg>
                </div>
                <div class="request-card-info">
                    <h3 class="request-card-title">{{.Title}}</h3>
                    <p class="request-card-description">{{.Description}}</p>
                </div>
                <div class="request-card-status">
                    {{if eq .Status "open"}}
                    <span class="status-badge open">Open</span>
                    {{else}}
                    <span class="status-badge closed">Closed</span>
                    {{end}}
                </div>
            </div>

            <div class="request-card-meta">
                <div class="request-meta-item">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
                    </svg>
                    <span>Upload to: <a href="/folder/{{.FolderID}}">{{.FolderName}}</a></span>
                </div>
                <div class="request-meta-item">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                        <line x1="16" y1="2" x2="16" y2="6"/>
                        <line x1="8" y1="2" x2="8" y2="6"/>
                        <line x1="3" y1="10" x2="21" y2="10"/>
                    </svg>
                    <span>Created {{.CreatedAt | formatDate}}</span>
                </div>
                {{if .Deadline}}
                <div class="request-meta-item {{if .IsOverdue}}overdue{{end}}">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <polyline points="12 6 12 12 16 14"/>
                    </svg>
                    <span>Deadline: {{.Deadline | formatDate}}</span>
                </div>
                {{end}}
                <div class="request-meta-item">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <polyline points="14 2 14 8 20 8"/>
                    </svg>
                    <span>{{.FileCount}} files received ({{.TotalSize | formatSize}})</span>
                </div>
            </div>

            <div class="request-card-actions">
                <button class="btn btn-secondary btn-sm" data-action="copy-link" data-url="{{.URL}}">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                    </svg>
                    Copy link
                </button>
                <button class="btn btn-secondary btn-sm" data-action="send-email">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                        <polyline points="22,6 12,13 2,6"/>
                    </svg>
                    Send email
                </button>
                <button class="btn btn-secondary btn-sm" data-action="view-files">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                        <circle cx="12" cy="12" r="3"/>
                    </svg>
                    View files
                </button>
                <div class="dropdown">
                    <button class="btn-icon" data-action="more">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/>
                        </svg>
                    </button>
                    <div class="dropdown-menu">
                        <button class="dropdown-item" data-action="edit">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                            </svg>
                            Edit request
                        </button>
                        {{if eq .Status "open"}}
                        <button class="dropdown-item" data-action="close">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                                <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                            </svg>
                            Close request
                        </button>
                        {{else}}
                        <button class="dropdown-item" data-action="reopen">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                                <path d="M7 11V7a5 5 0 0 1 9.9-1"/>
                            </svg>
                            Reopen request
                        </button>
                        {{end}}
                        <hr class="dropdown-divider">
                        <button class="dropdown-item danger" data-action="delete">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"/>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            </svg>
                            Delete request
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {{end}}
    </div>
    {{else}}
    <!-- Empty State -->
    <div class="empty-state">
        <div class="empty-state-icon">
            <svg width="120" height="120" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="17 8 12 3 7 8"/>
                <line x1="12" y1="3" x2="12" y2="15"/>
            </svg>
        </div>
        <h3>No file requests yet</h3>
        <p>Create a file request to collect files from anyone. They can upload files directly to your drive without needing an account.</p>
        <button class="btn btn-primary" id="empty-new-request-btn">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"/>
                <line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
            Create your first file request
        </button>
    </div>
    {{end}}
</div>

<!-- New/Edit File Request Modal -->
<div class="modal" id="request-modal">
    <div class="modal-overlay"></div>
    <div class="modal-container modal-lg">
        <div class="modal-header">
            <h2 id="request-modal-title">New file request</h2>
            <button class="modal-close" data-action="close">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <form id="request-form">
                <input type="hidden" id="request-id" name="id">

                <div class="form-group">
                    <label for="request-title">Title</label>
                    <input type="text" id="request-title" name="title" placeholder="What files are you requesting?" required>
                    <p class="form-hint">This will be shown to people uploading files</p>
                </div>

                <div class="form-group">
                    <label for="request-description">Description (optional)</label>
                    <textarea id="request-description" name="description" rows="3" placeholder="Add more details about what files you need..."></textarea>
                </div>

                <div class="form-group">
                    <label for="request-folder">Upload folder</label>
                    <div class="folder-select" id="folder-select">
                        <button type="button" class="folder-select-btn">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="var(--folder-blue)" stroke="none">
                                <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
                            </svg>
                            <span id="selected-folder-name">Select a folder</span>
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="6 9 12 15 18 9"/>
                            </svg>
                        </button>
                    </div>
                    <input type="hidden" id="request-folder-id" name="folder_id" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="request-deadline">Deadline (optional)</label>
                        <input type="date" id="request-deadline" name="deadline">
                    </div>
                    <div class="form-group">
                        <label>Options</label>
                        <div class="checkbox-group">
                            <label class="checkbox">
                                <input type="checkbox" id="request-notify" name="notify_on_upload" checked>
                                <span>Notify me when files are uploaded</span>
                            </label>
                            <label class="checkbox">
                                <input type="checkbox" id="request-allow-late" name="allow_late_submissions">
                                <span>Allow uploads after deadline</span>
                            </label>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" data-action="close">Cancel</button>
            <button class="btn btn-primary" id="save-request-btn">Create request</button>
        </div>
    </div>
</div>

<!-- Send Email Modal -->
<div class="modal" id="email-modal">
    <div class="modal-overlay"></div>
    <div class="modal-container">
        <div class="modal-header">
            <h2>Send file request</h2>
            <button class="modal-close" data-action="close">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <form id="email-form">
                <input type="hidden" id="email-request-id" name="request_id">

                <div class="form-group">
                    <label for="email-to">To</label>
                    <input type="email" id="email-to" name="to" placeholder="Enter email addresses, separated by commas" required>
                </div>

                <div class="form-group">
                    <label for="email-message">Message (optional)</label>
                    <textarea id="email-message" name="message" rows="4" placeholder="Add a personal message..."></textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" data-action="close">Cancel</button>
            <button class="btn btn-primary" id="send-email-btn">Send</button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const requestModal = document.getElementById('request-modal');
    const emailModal = document.getElementById('email-modal');
    let currentRequestId = null;

    function openRequestModal(request = null) {
        currentRequestId = request?.id || null;
        document.getElementById('request-modal-title').textContent = request ? 'Edit file request' : 'New file request';
        document.getElementById('save-request-btn').textContent = request ? 'Save changes' : 'Create request';

        if (request) {
            document.getElementById('request-id').value = request.id;
            document.getElementById('request-title').value = request.title;
            document.getElementById('request-description').value = request.description || '';
            document.getElementById('request-folder-id').value = request.folderId;
            document.getElementById('selected-folder-name').textContent = request.folderName;
            document.getElementById('request-deadline').value = request.deadline || '';
            document.getElementById('request-notify').checked = request.notifyOnUpload;
            document.getElementById('request-allow-late').checked = request.allowLateSubmissions;
        } else {
            document.getElementById('request-form').reset();
            document.getElementById('selected-folder-name').textContent = 'Select a folder';
        }

        requestModal.classList.add('open');
    }

    function closeRequestModal() {
        requestModal.classList.remove('open');
        currentRequestId = null;
    }

    function openEmailModal(requestId) {
        document.getElementById('email-request-id').value = requestId;
        document.getElementById('email-form').reset();
        emailModal.classList.add('open');
    }

    function closeEmailModal() {
        emailModal.classList.remove('open');
    }

    // New request buttons
    document.getElementById('new-request-btn')?.addEventListener('click', () => openRequestModal());
    document.getElementById('empty-new-request-btn')?.addEventListener('click', () => openRequestModal());

    // Modal close buttons
    requestModal.querySelectorAll('[data-action="close"]').forEach(btn => {
        btn.addEventListener('click', closeRequestModal);
    });
    emailModal.querySelectorAll('[data-action="close"]').forEach(btn => {
        btn.addEventListener('click', closeEmailModal);
    });

    // Close modals on overlay click
    requestModal.querySelector('.modal-overlay').addEventListener('click', closeRequestModal);
    emailModal.querySelector('.modal-overlay').addEventListener('click', closeEmailModal);

    // Save request
    document.getElementById('save-request-btn')?.addEventListener('click', async () => {
        const form = document.getElementById('request-form');
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const data = {
            title: document.getElementById('request-title').value,
            description: document.getElementById('request-description').value,
            folder_id: document.getElementById('request-folder-id').value,
            deadline: document.getElementById('request-deadline').value || null,
            notify_on_upload: document.getElementById('request-notify').checked,
            allow_late_submissions: document.getElementById('request-allow-late').checked,
        };

        try {
            if (currentRequestId) {
                await Drive.api.fileRequests.update(currentRequestId, data);
                Drive.showToast('File request updated', 'success');
            } else {
                await Drive.api.fileRequests.create(data);
                Drive.showToast('File request created', 'success');
            }
            location.reload();
        } catch (error) {
            Drive.showToast('Failed to save file request', 'error');
        }
    });

    // Send email
    document.getElementById('send-email-btn')?.addEventListener('click', async () => {
        const form = document.getElementById('email-form');
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const requestId = document.getElementById('email-request-id').value;
        const data = {
            to: document.getElementById('email-to').value.split(',').map(e => e.trim()),
            message: document.getElementById('email-message').value,
        };

        try {
            await Drive.api.fileRequests.sendEmail(requestId, data);
            Drive.showToast('Email sent', 'success');
            closeEmailModal();
        } catch (error) {
            Drive.showToast('Failed to send email', 'error');
        }
    });

    // Request card actions
    document.querySelectorAll('[data-action="copy-link"]').forEach(btn => {
        btn.addEventListener('click', async () => {
            const url = btn.dataset.url;
            try {
                await navigator.clipboard.writeText(url);
                Drive.showToast('Link copied to clipboard', 'success');
            } catch (error) {
                Drive.showToast('Failed to copy link', 'error');
            }
        });
    });

    document.querySelectorAll('[data-action="send-email"]').forEach(btn => {
        btn.addEventListener('click', () => {
            const card = btn.closest('.request-card');
            openEmailModal(card.dataset.id);
        });
    });

    document.querySelectorAll('[data-action="view-files"]').forEach(btn => {
        btn.addEventListener('click', () => {
            const card = btn.closest('.request-card');
            // Navigate to the folder where files are uploaded
            window.location.href = `/folder/${card.dataset.folderId}`;
        });
    });

    document.querySelectorAll('[data-action="edit"]').forEach(btn => {
        btn.addEventListener('click', async () => {
            const card = btn.closest('.request-card');
            try {
                const request = await Drive.api.fileRequests.get(card.dataset.id);
                openRequestModal(request);
            } catch (error) {
                Drive.showToast('Failed to load request', 'error');
            }
        });
    });

    document.querySelectorAll('[data-action="close"]').forEach(btn => {
        if (btn.closest('.request-card')) {
            btn.addEventListener('click', async () => {
                const card = btn.closest('.request-card');
                try {
                    await Drive.api.fileRequests.close(card.dataset.id);
                    location.reload();
                } catch (error) {
                    Drive.showToast('Failed to close request', 'error');
                }
            });
        }
    });

    document.querySelectorAll('[data-action="reopen"]').forEach(btn => {
        btn.addEventListener('click', async () => {
            const card = btn.closest('.request-card');
            try {
                await Drive.api.fileRequests.reopen(card.dataset.id);
                location.reload();
            } catch (error) {
                Drive.showToast('Failed to reopen request', 'error');
            }
        });
    });

    document.querySelectorAll('[data-action="delete"]').forEach(btn => {
        btn.addEventListener('click', async () => {
            const card = btn.closest('.request-card');
            if (confirm('Are you sure you want to delete this file request? The uploaded files will not be deleted.')) {
                try {
                    await Drive.api.fileRequests.delete(card.dataset.id);
                    card.remove();
                    Drive.showToast('File request deleted', 'success');
                } catch (error) {
                    Drive.showToast('Failed to delete request', 'error');
                }
            }
        });
    });

    // Dropdown menus
    document.querySelectorAll('.request-card [data-action="more"]').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const dropdown = btn.closest('.dropdown');
            dropdown.classList.toggle('open');
        });
    });

    // Close dropdowns on outside click
    document.addEventListener('click', () => {
        document.querySelectorAll('.dropdown.open').forEach(d => d.classList.remove('open'));
    });
});
</script>
{{end}}
