import{u as xe,i as he,a as pe,T as ge,b as fe,c as ye,d as je,e as be,j as e,E as ve}from"./editor-r-fA0-4K.js";import{r}from"./react-vendor-N0awbyme.js";import{e as R,a as we,u as Ce,f as Se,r as Ne,g as ze,h as _e,s as ke,i as A,j as Ae,A as Be}from"./index-DGHfMPvy.js";import{B as Te,w as Ee,U as De,x as Re,L as Le,y as Fe,z as $e,G as Ie,H as Me,J as Ue,K as Ke,N as He,O as Oe,Q as Pe,V as Ve,X as W,p as ie,a as Ge,c as Je}from"./ui-FoIWUG-l.js";import"./sanitizer-HRjpPm7y.js";function d({active:l,onClick:s,children:h,title:y}){return e.jsx("button",{type:"button",onClick:s,title:y,className:`rounded p-1.5 ${l?"bg-gray-200 text-blue-600":"text-gray-600 hover:bg-gray-100"}`,children:h})}function J(){return e.jsx("div",{className:"mx-1 h-5 w-px bg-gray-300"})}function Qe({content:l,onChange:s,placeholder:h,autoFocus:y}){const i=xe({extensions:[he,pe,ye.configure({openOnClick:!1}),je.configure({types:["heading","paragraph"]}),ge,fe,be.configure({placeholder:h||"Compose your email..."})],content:l,onUpdate:({editor:m})=>{s(m.getHTML())},autofocus:y?"end":!1,editorProps:{attributes:{class:"prose prose-sm max-w-none focus:outline-none min-h-[200px] px-4 py-2"}}});return r.useEffect(()=>{i&&l!==i.getHTML()&&i.commands.setContent(l,{emitUpdate:!1})},[l,i]),i?e.jsxs("div",{className:"border-t border-gray-200",children:[e.jsxs("div",{className:"flex items-center gap-0.5 border-b border-gray-100 bg-gray-50 px-2 py-1",children:[e.jsx(d,{active:i.isActive("bold"),onClick:()=>i.chain().focus().toggleBold().run(),title:"Bold",children:e.jsx(Te,{size:16})}),e.jsx(d,{active:i.isActive("italic"),onClick:()=>i.chain().focus().toggleItalic().run(),title:"Italic",children:e.jsx(Ee,{size:16})}),e.jsx(d,{active:i.isActive("underline"),onClick:()=>i.chain().focus().toggleUnderline().run(),title:"Underline",children:e.jsx(De,{size:16})}),e.jsx(d,{active:i.isActive("strike"),onClick:()=>i.chain().focus().toggleStrike().run(),title:"Strikethrough",children:e.jsx(Re,{size:16})}),e.jsx(J,{}),e.jsx(d,{active:i.isActive("bulletList"),onClick:()=>i.chain().focus().toggleBulletList().run(),title:"Bullet List",children:e.jsx(Le,{size:16})}),e.jsx(d,{active:i.isActive("orderedList"),onClick:()=>i.chain().focus().toggleOrderedList().run(),title:"Numbered List",children:e.jsx(Fe,{size:16})}),e.jsx(J,{}),e.jsx(d,{active:i.isActive({textAlign:"left"}),onClick:()=>i.chain().focus().setTextAlign("left").run(),title:"Align Left",children:e.jsx($e,{size:16})}),e.jsx(d,{active:i.isActive({textAlign:"center"}),onClick:()=>i.chain().focus().setTextAlign("center").run(),title:"Align Center",children:e.jsx(Ie,{size:16})}),e.jsx(d,{active:i.isActive({textAlign:"right"}),onClick:()=>i.chain().focus().setTextAlign("right").run(),title:"Align Right",children:e.jsx(Me,{size:16})}),e.jsx(J,{}),e.jsx(d,{active:i.isActive("link"),onClick:()=>{const m=window.prompt("Enter URL");m&&i.chain().focus().setLink({href:m}).run()},title:"Insert Link",children:e.jsx(Ue,{size:16})}),e.jsx("div",{className:"flex-1"}),e.jsx(d,{onClick:()=>i.chain().focus().undo().run(),title:"Undo",children:e.jsx(Ke,{size:16})}),e.jsx(d,{onClick:()=>i.chain().focus().redo().run(),title:"Redo",children:e.jsx(He,{size:16})})]}),e.jsx(ve,{editor:i})]}):null}function We(l){return l<1024?`${l} B`:l<1024*1024?`${(l/1024).toFixed(1)} KB`:`${(l/(1024*1024)).toFixed(1)} MB`}function Q({label:l,field:s,recipients:h,show:y,inputValue:i,activeField:m,suggestions:u,inputRef:C,onInputChange:j,onKeyDown:S,onFocus:b,onBlur:N,onRemove:k,onSelectContact:B,showCc:v,showBcc:T,onShowCc:w,onShowBcc:z}){return y===!1?null:e.jsxs("div",{className:"flex items-start gap-2 border-b border-gray-100 px-4 py-1.5",children:[e.jsx("span",{className:"w-8 pt-1 text-sm text-gray-500",children:l}),e.jsxs("div",{className:"flex flex-1 flex-wrap items-center gap-1",children:[h.map((a,p)=>e.jsxs("span",{className:"inline-flex items-center gap-1 rounded-full bg-gray-100 px-2 py-0.5 text-sm",children:[e.jsx("span",{children:a.name||a.address}),e.jsx("button",{onClick:()=>k(s,p),className:"text-gray-400 hover:text-gray-600",children:e.jsx(W,{size:14})})]},`${a.address}-${p}`)),e.jsxs("div",{className:"relative min-w-[120px] flex-1",children:[e.jsx("input",{ref:s==="to"?C:void 0,type:"text",value:m===s?i:"",onChange:a=>j(a.target.value,s),onKeyDown:a=>S(a,s),onFocus:()=>b(s),onBlur:()=>N(s),className:"w-full bg-transparent py-1 text-sm outline-none",placeholder:""}),m===s&&u.length>0&&e.jsx("div",{className:"absolute left-0 top-full z-50 max-h-48 w-72 overflow-y-auto rounded-lg border border-gray-200 bg-white shadow-lg",children:u.map(a=>e.jsxs("button",{onMouseDown:p=>{p.preventDefault(),B(a,s)},className:"flex w-full items-center gap-2 px-3 py-2 text-left hover:bg-gray-50",children:[e.jsx(Be,{name:a.name||a.email,email:a.email,size:28}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("div",{className:"truncate text-sm font-medium",children:a.name||a.email}),a.name&&e.jsx("div",{className:"truncate text-xs text-gray-500",children:a.email})]})]},a.id))})]})]}),s==="to"&&e.jsxs("div",{className:"flex gap-1 pt-1 text-sm text-gray-500",children:[!v&&e.jsx("button",{onClick:w,className:"hover:text-gray-700",children:"Cc"}),!T&&e.jsx("button",{onClick:z,className:"hover:text-gray-700",children:"Bcc"})]})]})}function tt(){const l=R(t=>t.composeMode),s=R(t=>t.composeData),h=R(t=>t.closeCompose),y=R(t=>t.fetchEmails),{fetchLabels:i}=we(),m=Ce(t=>t.settings),[u,C]=r.useState([]),[j,S]=r.useState([]),[b,N]=r.useState([]),[k,B]=r.useState(""),[v,T]=r.useState(""),[w,z]=r.useState(!1),[a,p]=r.useState(!1),[X,Y]=r.useState(!1),[f,E]=r.useState("normal"),[Z,L]=r.useState([]),[F,_]=r.useState([]),[$,I]=r.useState(null),[x,M]=r.useState(""),q=r.useRef(null),ee=r.useRef(null);r.useEffect(()=>{if(l&&s){C(s.to||[]),S(s.cc||[]),N(s.bcc||[]),B(s.subject||"");let t=s.body_html||"";(!s.mode||s.mode==="new")&&m?.signature&&!t&&(t=`<br/><br/><div style="color:#5f6368">--<br/>${m.signature}</div>`),T(t),z((s.cc||[]).length>0),p((s.bcc||[]).length>0),L([]),E("normal"),(s.to||[]).length===0&&setTimeout(()=>q.current?.focus(),100)}},[l,s,m?.signature]);const te=r.useCallback(async t=>{if(t.length<1){_([]);return}try{const n=await Se(t);_(n.filter(o=>!u.some(c=>c.address===o.email)&&!j.some(c=>c.address===o.email)&&!b.some(c=>c.address===o.email)))}catch{_([])}},[u,j,b]);if(r.useEffect(()=>{const t=setTimeout(()=>{x&&te(x)},200);return()=>clearTimeout(t)},[x,te]),!l)return null;const se=(t,n)=>{const o=n.trim();if(!o)return;const c=o.match(/^(.+?)\s*<(.+?)>$/),g=c&&c[1]&&c[2]?{name:c[1].trim(),address:c[2].trim()}:{address:o};(t==="to"?C:t==="cc"?S:N)(G=>G.some(ue=>ue.address===g.address)?G:[...G,g]),M(""),_([])},U=(t,n)=>{const o={name:t.name,address:t.email};(n==="to"?C:n==="cc"?S:N)(g=>g.some(D=>D.address===o.address)?g:[...g,o]),M(""),_([])},K=(t,n)=>{(t==="to"?C:t==="cc"?S:N)(c=>c.filter((g,D)=>D!==n))},H=(t,n)=>{["Enter","Tab",","].includes(t.key)&&x.trim()&&(t.preventDefault(),se(n,x))},O=(t,n)=>{M(t),I(n)},P=t=>{I(t)},V=t=>{setTimeout(()=>{x.trim()&&se(t,x),_([]),I(null)},200)},ae=()=>ee.current?.click(),ne=async t=>{const n=t.target.files;if(n){for(const o of Array.from(n)){const c={id:`local-${Date.now()}-${o.name}`,email_id:"",filename:o.name,content_type:o.type||"application/octet-stream",size_bytes:o.size,created_at:new Date().toISOString()};L(g=>[...g,c])}t.target.value=""}},oe=async()=>{if(u.length!==0){Y(!0);try{const t=v.replace(/<[^>]*>/g," ").replace(/\s+/g," ").trim(),n={to:u,cc:w?j:[],bcc:a?b:[],subject:k,body_html:v,body_text:t,is_draft:!1,in_reply_to:s?.in_reply_to||"",thread_id:s?.thread_id||""},o=s?.mode||l;o==="reply"&&s?.email_id?await Ne(s.email_id,n):o==="reply-all"&&s?.email_id?await ze(s.email_id,n):o==="forward"&&s?.email_id?await _e(s.email_id,n):await ke(n),A("Message sent",{action:{label:"Undo",onClick:()=>A("Undo not available for this message")}}),h(),y(),i()}catch{A("Failed to send message")}finally{Y(!1)}}},le=()=>{h(),A("Draft discarded")},re=async()=>{try{const t=v.replace(/<[^>]*>/g," ").replace(/\s+/g," ").trim();await Ae({to:u,cc:j,bcc:b,subject:k,body_html:v,body_text:t,is_draft:!0,in_reply_to:s?.in_reply_to||"",thread_id:s?.thread_id||""}),A("Draft saved")}catch{}h()},ce=s?.mode==="reply"||l==="reply"?"Reply":s?.mode==="reply-all"?"Reply All":s?.mode==="forward"||l==="forward"?"Forward":"New Message",de=f==="maximized"?"inset-4":"bottom-0 right-4 w-[560px]",me=f==="minimized"?{height:"auto"}:f==="maximized"?{}:{height:520};return e.jsxs("div",{className:`compose-animate compose-shadow fixed ${de} z-50 flex flex-col rounded-t-lg bg-white`,style:me,children:[e.jsxs("div",{className:"flex cursor-pointer items-center justify-between rounded-t-lg bg-[#404040] px-4 py-2",onClick:()=>f==="minimized"&&E("normal"),children:[e.jsx("span",{className:"text-sm font-medium text-white",children:ce}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:t=>{t.stopPropagation(),E(f==="minimized"?"normal":"minimized")},className:"rounded p-1 text-white hover:bg-white/10",children:e.jsx(Oe,{size:16})}),e.jsx("button",{onClick:t=>{t.stopPropagation(),E(f==="maximized"?"normal":"maximized")},className:"rounded p-1 text-white hover:bg-white/10",children:f==="maximized"?e.jsx(Pe,{size:16}):e.jsx(Ve,{size:16})}),e.jsx("button",{onClick:t=>{t.stopPropagation(),re()},className:"rounded p-1 text-white hover:bg-white/10",children:e.jsx(W,{size:16})})]})]}),f!=="minimized"&&e.jsxs(e.Fragment,{children:[e.jsx(Q,{label:"To",field:"to",recipients:u,inputValue:x,activeField:$,suggestions:F,inputRef:q,onInputChange:O,onKeyDown:H,onFocus:P,onBlur:V,onRemove:K,onSelectContact:U,showCc:w,showBcc:a,onShowCc:()=>z(!0),onShowBcc:()=>p(!0)}),e.jsx(Q,{label:"Cc",field:"cc",recipients:j,show:w,inputValue:x,activeField:$,suggestions:F,onInputChange:O,onKeyDown:H,onFocus:P,onBlur:V,onRemove:K,onSelectContact:U,showCc:w,showBcc:a,onShowCc:()=>z(!0),onShowBcc:()=>p(!0)}),e.jsx(Q,{label:"Bcc",field:"bcc",recipients:b,show:a,inputValue:x,activeField:$,suggestions:F,onInputChange:O,onKeyDown:H,onFocus:P,onBlur:V,onRemove:K,onSelectContact:U,showCc:w,showBcc:a,onShowCc:()=>z(!0),onShowBcc:()=>p(!0)}),e.jsx("input",{type:"text",value:k,onChange:t=>B(t.target.value),placeholder:"Subject",className:"border-b border-gray-100 px-4 py-2 text-sm outline-none"}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:e.jsx(Qe,{content:v,onChange:T,placeholder:"Compose your email...",autoFocus:u.length>0})}),Z.length>0&&e.jsx("div",{className:"flex flex-wrap gap-2 border-t border-gray-100 px-4 py-2",children:Z.map(t=>e.jsxs("div",{className:"flex items-center gap-2 rounded-lg border border-gray-200 bg-gray-50 px-3 py-1.5 text-sm",children:[e.jsx(ie,{size:14,className:"text-gray-400"}),e.jsx("span",{className:"max-w-[150px] truncate",children:t.filename}),e.jsx("span",{className:"text-xs text-gray-400",children:We(t.size_bytes)}),e.jsx("button",{onClick:()=>L(n=>n.filter(o=>o.id!==t.id)),className:"text-gray-400 hover:text-gray-600",children:e.jsx(W,{size:14})})]},t.id))}),e.jsxs("div",{className:"flex items-center gap-2 border-t border-gray-100 px-4 py-2",children:[e.jsxs("button",{onClick:oe,disabled:X||u.length===0,className:"flex items-center gap-2 rounded-full bg-[#1A73E8] px-6 py-2 text-sm font-medium text-white hover:bg-[#1765CC] hover:shadow-md disabled:cursor-not-allowed disabled:opacity-50",children:[X?e.jsx("span",{className:"h-4 w-4 animate-spin rounded-full border-2 border-white/30 border-t-white"}):e.jsx(Ge,{size:16}),"Send"]}),e.jsx("input",{ref:ee,type:"file",multiple:!0,className:"hidden",onChange:ne}),e.jsx("button",{onClick:ae,className:"rounded-full p-2 text-gray-600 hover:bg-gray-100",title:"Attach files",children:e.jsx(ie,{size:20})}),e.jsx("div",{className:"flex-1"}),e.jsx("button",{onClick:le,className:"rounded-full p-2 text-gray-600 hover:bg-gray-100",title:"Discard",children:e.jsx(Je,{size:20})})]})]})]})}export{tt as default};
