import{u as ye,i as je,a as we,T as ve,b as Ce,c as Se,d as Ne,e as _e,j as e,E as ke}from"./editor-r-fA0-4K.js";import{r as c}from"./react-vendor-N0awbyme.js";import{e as F,a as ze,u as Ae,f as De,r as Te,g as Be,h as Ee,s as Re,i as S,j as ie,k as Le,A as $e}from"./index-BV6Ixawy.js";import{B as Fe,x as Me,U as Ie,y as Ue,L as He,z as Oe,G as Ke,H as Pe,J as Ve,K as We,N as Ge,O as Je,Q as Qe,W as Xe,Y as Ye,X as Z,s as oe,a as Ze,e as qe,C as et,c as tt}from"./ui-D0SrvoWH.js";import"./sanitizer-HRjpPm7y.js";function x({active:l,onClick:s,children:g,title:y}){return e.jsx("button",{type:"button",onClick:s,title:y,className:`rounded p-1.5 ${l?"bg-gray-200 text-blue-600":"text-gray-600 hover:bg-gray-100"}`,children:g})}function X(){return e.jsx("div",{className:"mx-1 h-5 w-px bg-gray-300"})}function st({content:l,onChange:s,placeholder:g,autoFocus:y}){const a=ye({extensions:[je,we,Se.configure({openOnClick:!1}),Ne.configure({types:["heading","paragraph"]}),ve,Ce,_e.configure({placeholder:g||"Compose your email..."})],content:l,onUpdate:({editor:h})=>{s(h.getHTML())},autofocus:y?"end":!1,editorProps:{attributes:{class:"prose prose-sm max-w-none focus:outline-none min-h-[200px] px-4 py-2"}}});return c.useEffect(()=>{a&&l!==a.getHTML()&&a.commands.setContent(l,{emitUpdate:!1})},[l,a]),a?e.jsxs("div",{className:"border-t border-gray-200",children:[e.jsxs("div",{className:"flex items-center gap-0.5 border-b border-gray-100 bg-gray-50 px-2 py-1",children:[e.jsx(x,{active:a.isActive("bold"),onClick:()=>a.chain().focus().toggleBold().run(),title:"Bold",children:e.jsx(Fe,{size:16})}),e.jsx(x,{active:a.isActive("italic"),onClick:()=>a.chain().focus().toggleItalic().run(),title:"Italic",children:e.jsx(Me,{size:16})}),e.jsx(x,{active:a.isActive("underline"),onClick:()=>a.chain().focus().toggleUnderline().run(),title:"Underline",children:e.jsx(Ie,{size:16})}),e.jsx(x,{active:a.isActive("strike"),onClick:()=>a.chain().focus().toggleStrike().run(),title:"Strikethrough",children:e.jsx(Ue,{size:16})}),e.jsx(X,{}),e.jsx(x,{active:a.isActive("bulletList"),onClick:()=>a.chain().focus().toggleBulletList().run(),title:"Bullet List",children:e.jsx(He,{size:16})}),e.jsx(x,{active:a.isActive("orderedList"),onClick:()=>a.chain().focus().toggleOrderedList().run(),title:"Numbered List",children:e.jsx(Oe,{size:16})}),e.jsx(X,{}),e.jsx(x,{active:a.isActive({textAlign:"left"}),onClick:()=>a.chain().focus().setTextAlign("left").run(),title:"Align Left",children:e.jsx(Ke,{size:16})}),e.jsx(x,{active:a.isActive({textAlign:"center"}),onClick:()=>a.chain().focus().setTextAlign("center").run(),title:"Align Center",children:e.jsx(Pe,{size:16})}),e.jsx(x,{active:a.isActive({textAlign:"right"}),onClick:()=>a.chain().focus().setTextAlign("right").run(),title:"Align Right",children:e.jsx(Ve,{size:16})}),e.jsx(X,{}),e.jsx(x,{active:a.isActive("link"),onClick:()=>{const h=window.prompt("Enter URL");h&&a.chain().focus().setLink({href:h}).run()},title:"Insert Link",children:e.jsx(We,{size:16})}),e.jsx("div",{className:"flex-1"}),e.jsx(x,{onClick:()=>a.chain().focus().undo().run(),title:"Undo",children:e.jsx(Ge,{size:16})}),e.jsx(x,{onClick:()=>a.chain().focus().redo().run(),title:"Redo",children:e.jsx(Je,{size:16})})]}),e.jsx(ke,{editor:a})]}):null}function at(l){return l<1024?`${l} B`:l<1024*1024?`${(l/1024).toFixed(1)} KB`:`${(l/(1024*1024)).toFixed(1)} MB`}function Y({label:l,field:s,recipients:g,show:y,inputValue:a,activeField:h,suggestions:m,inputRef:N,onInputChange:j,onKeyDown:_,onFocus:w,onBlur:k,onRemove:z,onSelectContact:B,showCc:p,showBcc:E,onShowCc:v,onShowBcc:A}){return y===!1?null:e.jsxs("div",{className:"flex items-start gap-2 border-b border-gray-100 px-4 py-1.5",children:[e.jsx("span",{className:"w-8 pt-1 text-sm text-gray-500",children:l}),e.jsxs("div",{className:"flex flex-1 flex-wrap items-center gap-1",children:[g.map((n,b)=>e.jsxs("span",{className:"inline-flex items-center gap-1 rounded-full bg-gray-100 px-2 py-0.5 text-sm",children:[e.jsx("span",{children:n.name||n.address}),e.jsx("button",{onClick:()=>z(s,b),className:"text-gray-400 hover:text-gray-600",children:e.jsx(Z,{size:14})})]},`${n.address}-${b}`)),e.jsxs("div",{className:"relative min-w-[120px] flex-1",children:[e.jsx("input",{ref:s==="to"?N:void 0,type:"text",value:h===s?a:"",onChange:n=>j(n.target.value,s),onKeyDown:n=>_(n,s),onFocus:()=>w(s),onBlur:()=>k(s),className:"w-full bg-transparent py-1 text-sm outline-none",placeholder:""}),h===s&&m.length>0&&e.jsx("div",{className:"absolute left-0 top-full z-50 max-h-48 w-72 overflow-y-auto rounded-lg border border-gray-200 bg-white shadow-lg",children:m.map(n=>e.jsxs("button",{onMouseDown:b=>{b.preventDefault(),B(n,s)},className:"flex w-full items-center gap-2 px-3 py-2 text-left hover:bg-gray-50",children:[e.jsx($e,{name:n.name||n.email,email:n.email,size:28}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("div",{className:"truncate text-sm font-medium",children:n.name||n.email}),n.name&&e.jsx("div",{className:"truncate text-xs text-gray-500",children:n.email})]})]},n.id))})]})]}),s==="to"&&e.jsxs("div",{className:"flex gap-1 pt-1 text-sm text-gray-500",children:[!p&&e.jsx("button",{onClick:v,className:"hover:text-gray-700",children:"Cc"}),!E&&e.jsx("button",{onClick:A,className:"hover:text-gray-700",children:"Bcc"})]})]})}function dt(){const l=F(t=>t.composeMode),s=F(t=>t.composeData),g=F(t=>t.closeCompose),y=F(t=>t.fetchEmails),{fetchLabels:a}=ze(),h=Ae(t=>t.settings),[m,N]=c.useState([]),[j,_]=c.useState([]),[w,k]=c.useState([]),[z,B]=c.useState(""),[p,E]=c.useState(""),[v,A]=c.useState(!1),[n,b]=c.useState(!1),[M,R]=c.useState(!1),[C,L]=c.useState("normal"),[q,I]=c.useState([]),[U,D]=c.useState([]),[H,O]=c.useState(null),[f,K]=c.useState(""),[le,ee]=c.useState(!1),te=c.useRef(null),se=c.useRef(null),re=c.useRef(null);c.useEffect(()=>{if(l&&s){N(s.to||[]),_(s.cc||[]),k(s.bcc||[]),B(s.subject||"");let t=s.body_html||"";(!s.mode||s.mode==="new")&&h?.signature&&!t&&(t=`<br/><br/><div style="color:#5f6368">--<br/>${h.signature}</div>`),E(t),A((s.cc||[]).length>0),b((s.bcc||[]).length>0),I([]),L("normal"),(s.to||[]).length===0&&setTimeout(()=>te.current?.focus(),100)}},[l,s,h?.signature]);const ae=c.useCallback(async t=>{if(t.length<1){D([]);return}try{const i=await De(t);D(i.filter(o=>!m.some(d=>d.address===o.email)&&!j.some(d=>d.address===o.email)&&!w.some(d=>d.address===o.email)))}catch{D([])}},[m,j,w]);if(c.useEffect(()=>{const t=setTimeout(()=>{f&&ae(f)},200);return()=>clearTimeout(t)},[f,ae]),!l)return null;const ne=(t,i)=>{const o=i.trim();if(!o)return;const d=o.match(/^(.+?)\s*<(.+?)>$/),u=d&&d[1]&&d[2]?{name:d[1].trim(),address:d[2].trim()}:{address:o};(t==="to"?N:t==="cc"?_:k)(T=>T.some($=>$.address===u.address)?T:[...T,u]),K(""),D([])},P=(t,i)=>{const o={name:t.name,address:t.email};(i==="to"?N:i==="cc"?_:k)(u=>u.some(r=>r.address===o.address)?u:[...u,o]),K(""),D([])},V=(t,i)=>{(t==="to"?N:t==="cc"?_:k)(d=>d.filter((u,r)=>r!==i))},W=(t,i)=>{["Enter","Tab",","].includes(t.key)&&f.trim()&&(t.preventDefault(),ne(i,f))},G=(t,i)=>{K(t),O(i)},J=t=>{O(t)},Q=t=>{setTimeout(()=>{f.trim()&&ne(t,f),D([]),O(null)},200)},ce=()=>se.current?.click(),de=async t=>{const i=t.target.files;if(i){for(const o of Array.from(i)){const d={id:`local-${Date.now()}-${o.name}`,email_id:"",filename:o.name,content_type:o.type||"application/octet-stream",size_bytes:o.size,created_at:new Date().toISOString()};I(u=>[...u,d])}t.target.value=""}},me=async()=>{if(m.length!==0){R(!0);try{const t=p.replace(/<[^>]*>/g," ").replace(/\s+/g," ").trim(),i={to:m,cc:v?j:[],bcc:n?w:[],subject:z,body_html:p,body_text:t,is_draft:!1,in_reply_to:s?.in_reply_to||"",thread_id:s?.thread_id||""},o=s?.mode||l;o==="reply"&&s?.email_id?await Te(s.email_id,i):o==="reply-all"&&s?.email_id?await Be(s.email_id,i):o==="forward"&&s?.email_id?await Ee(s.email_id,i):await Re(i),S("Message sent",{action:{label:"Undo",onClick:()=>S("Undo not available for this message")}}),g(),y(),a()}catch{S("Failed to send message")}finally{R(!1)}}},ue=async t=>{if(ee(!1),m.length!==0){R(!0);try{const i=p.replace(/<[^>]*>/g," ").replace(/\s+/g," ").trim(),o={to:m,cc:v?j:[],bcc:n?w:[],subject:z,body_html:p,body_text:i,is_draft:!0,in_reply_to:s?.in_reply_to||"",thread_id:s?.thread_id||""},d=await ie(o),u=new Date;let r;switch(t){case"tomorrow_morning":r=new Date(u),r.setDate(r.getDate()+1),r.setHours(8,0,0,0);break;case"tomorrow_afternoon":r=new Date(u),r.setDate(r.getDate()+1),r.setHours(13,0,0,0);break;case"monday_morning":{r=new Date(u);const be=(1-r.getDay()+7)%7||7;r.setDate(r.getDate()+be),r.setHours(8,0,0,0);break}default:return}const T=d,$=T?.email?.id||T?.id;$&&await Le($,r.toISOString()),S(`Send scheduled for ${r.toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric"})} at ${r.toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit"})}`),g(),y(),a()}catch{S("Failed to schedule send")}finally{R(!1)}}},xe=()=>{g(),S("Draft discarded")},he=async()=>{try{const t=p.replace(/<[^>]*>/g," ").replace(/\s+/g," ").trim();await ie({to:m,cc:j,bcc:w,subject:z,body_html:p,body_text:t,is_draft:!0,in_reply_to:s?.in_reply_to||"",thread_id:s?.thread_id||""}),S("Draft saved")}catch{}g()},ge=s?.mode==="reply"||l==="reply"?"Reply":s?.mode==="reply-all"?"Reply All":s?.mode==="forward"||l==="forward"?"Forward":"New Message",fe=C==="maximized"?"inset-4":"bottom-0 right-4 w-[560px]",pe=C==="minimized"?{height:"auto"}:C==="maximized"?{}:{height:520};return e.jsxs("div",{className:`compose-animate compose-shadow fixed ${fe} z-50 flex flex-col rounded-t-lg bg-white`,style:pe,children:[e.jsxs("div",{className:"flex cursor-pointer items-center justify-between rounded-t-lg bg-[#404040] px-4 py-2",onClick:()=>C==="minimized"&&L("normal"),children:[e.jsx("span",{className:"text-sm font-medium text-white",children:ge}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:t=>{t.stopPropagation(),L(C==="minimized"?"normal":"minimized")},className:"rounded p-1 text-white hover:bg-white/10",children:e.jsx(Qe,{size:16})}),e.jsx("button",{onClick:t=>{t.stopPropagation(),L(C==="maximized"?"normal":"maximized")},className:"rounded p-1 text-white hover:bg-white/10",children:C==="maximized"?e.jsx(Xe,{size:16}):e.jsx(Ye,{size:16})}),e.jsx("button",{onClick:t=>{t.stopPropagation(),he()},className:"rounded p-1 text-white hover:bg-white/10",children:e.jsx(Z,{size:16})})]})]}),C!=="minimized"&&e.jsxs(e.Fragment,{children:[e.jsx(Y,{label:"To",field:"to",recipients:m,inputValue:f,activeField:H,suggestions:U,inputRef:te,onInputChange:G,onKeyDown:W,onFocus:J,onBlur:Q,onRemove:V,onSelectContact:P,showCc:v,showBcc:n,onShowCc:()=>A(!0),onShowBcc:()=>b(!0)}),e.jsx(Y,{label:"Cc",field:"cc",recipients:j,show:v,inputValue:f,activeField:H,suggestions:U,onInputChange:G,onKeyDown:W,onFocus:J,onBlur:Q,onRemove:V,onSelectContact:P,showCc:v,showBcc:n,onShowCc:()=>A(!0),onShowBcc:()=>b(!0)}),e.jsx(Y,{label:"Bcc",field:"bcc",recipients:w,show:n,inputValue:f,activeField:H,suggestions:U,onInputChange:G,onKeyDown:W,onFocus:J,onBlur:Q,onRemove:V,onSelectContact:P,showCc:v,showBcc:n,onShowCc:()=>A(!0),onShowBcc:()=>b(!0)}),e.jsx("input",{type:"text",value:z,onChange:t=>B(t.target.value),placeholder:"Subject",className:"border-b border-gray-100 px-4 py-2 text-sm outline-none"}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:e.jsx(st,{content:p,onChange:E,placeholder:"Compose your email...",autoFocus:m.length>0})}),q.length>0&&e.jsx("div",{className:"flex flex-wrap gap-2 border-t border-gray-100 px-4 py-2",children:q.map(t=>e.jsxs("div",{className:"flex items-center gap-2 rounded-lg border border-gray-200 bg-gray-50 px-3 py-1.5 text-sm",children:[e.jsx(oe,{size:14,className:"text-gray-400"}),e.jsx("span",{className:"max-w-[150px] truncate",children:t.filename}),e.jsx("span",{className:"text-xs text-gray-400",children:at(t.size_bytes)}),e.jsx("button",{onClick:()=>I(i=>i.filter(o=>o.id!==t.id)),className:"text-gray-400 hover:text-gray-600",children:e.jsx(Z,{size:14})})]},t.id))}),e.jsxs("div",{className:"flex items-center gap-2 border-t border-gray-100 px-4 py-2",children:[e.jsxs("div",{className:"relative flex",ref:re,children:[e.jsxs("button",{onClick:me,disabled:M||m.length===0,className:"flex items-center gap-2 rounded-l-full bg-[#1A73E8] px-5 py-2 text-sm font-medium text-white hover:bg-[#1765CC] hover:shadow-md disabled:cursor-not-allowed disabled:opacity-50",children:[M?e.jsx("span",{className:"h-4 w-4 animate-spin rounded-full border-2 border-white/30 border-t-white"}):e.jsx(Ze,{size:16}),"Send"]}),e.jsx("button",{onClick:()=>ee(t=>!t),disabled:M||m.length===0,className:"flex items-center rounded-r-full border-l border-blue-400/30 bg-[#1A73E8] px-2 py-2 text-white hover:bg-[#1765CC] disabled:cursor-not-allowed disabled:opacity-50",title:"Schedule send",children:e.jsx(qe,{size:14})}),le&&e.jsxs("div",{className:"absolute bottom-full left-0 z-50 mb-1 w-56 rounded-lg border border-gray-200 bg-white py-1 shadow-lg",children:[e.jsxs("div",{className:"px-3 py-1.5 text-xs font-medium text-gray-500",children:[e.jsx(et,{size:12,className:"mr-1 inline"}),"Schedule send"]}),[{key:"tomorrow_morning",label:"Tomorrow morning",sub:"8:00 AM"},{key:"tomorrow_afternoon",label:"Tomorrow afternoon",sub:"1:00 PM"},{key:"monday_morning",label:"Monday morning",sub:"8:00 AM"}].map(t=>e.jsxs("button",{onClick:()=>ue(t.key),className:"flex w-full items-center justify-between px-3 py-2 text-sm hover:bg-gray-50",children:[e.jsx("span",{children:t.label}),e.jsx("span",{className:"text-xs text-gray-400",children:t.sub})]},t.key))]})]}),e.jsx("input",{ref:se,type:"file",multiple:!0,className:"hidden",onChange:de}),e.jsx("button",{onClick:ce,className:"rounded-full p-2 text-gray-600 hover:bg-gray-100",title:"Attach files",children:e.jsx(oe,{size:20})}),e.jsx("div",{className:"flex-1"}),e.jsx("button",{onClick:xe,className:"rounded-full p-2 text-gray-600 hover:bg-gray-100",title:"Discard",children:e.jsx(tt,{size:20})})]})]})]})}export{dt as default};
