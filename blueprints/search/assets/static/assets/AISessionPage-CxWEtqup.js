import{j as e}from"./markdown-DRpjVqyA.js";import{r as n,b as G,L}from"./react-vendor-DqWpB-k-.js";import{b as $,a as I}from"./index-B9sQUvT8.js";import{a as B,A as J}from"./AIResponse-HCCGBydo.js";import{M as W,V as Q}from"./VoiceInput-CEKYF9vR.js";import{U as Y,q as ee,X as se,I as te,j as ae,r as ne,D as ie,h as oe,s as re,T as le,t as ce,u as de,H as ue,v as me,w as he,d as P,g as pe,x as xe,y as fe,S as je}from"./ui-DSv63oDG.js";const ve=["image/jpeg","image/png","image/gif","image/webp","application/pdf"],ge=10,be=5;function ke({files:s,onFilesChange:d,maxFiles:m=be,maxSizeMB:u=ge,accept:r=ve,children:l}){const[c,h]=n.useState(!1),[x,o]=n.useState(null),a=n.useRef(null),p=n.useCallback(t=>r.includes(t.type)?t.size>u*1024*1024?`File size exceeds ${u}MB limit`:null:`File type ${t.type} is not supported`,[r,u]),f=n.useCallback(async t=>{const j=p(t);if(j)return o(j),null;const w=t.type.startsWith("image/"),y=w?"image":"pdf";let D;return w&&(D=await new Promise(z=>{const E=new FileReader;E.onload=()=>z(E.result),E.readAsDataURL(t)})),{id:crypto.randomUUID(),file:t,type:y,preview:D}},[p]),g=n.useCallback(async t=>{o(null);const j=[],w=m-s.length;for(let y=0;y<Math.min(t.length,w);y++){const D=(t instanceof FileList,t[y]),z=await f(D);z&&j.push(z)}t.length>w&&o(`Maximum ${m} files allowed`),j.length>0&&d([...s,...j])},[s,m,d,f]),v=n.useCallback(t=>{t.preventDefault(),t.stopPropagation(),h(!0)},[]),S=n.useCallback(t=>{t.preventDefault(),t.stopPropagation(),h(!1)},[]),A=n.useCallback(t=>{t.preventDefault(),t.stopPropagation(),h(!1),g(t.dataTransfer.files)},[g]),U=n.useCallback(t=>{t.target.files&&g(t.target.files),t.target.value=""},[g]),_=n.useCallback(t=>{d(s.filter(j=>j.id!==t))},[s,d]),R=n.useCallback(()=>{a.current?.click()},[]);return e.jsxs("div",{className:`file-upload-zone ${c?"dragging":""}`,onDragOver:v,onDragLeave:S,onDrop:A,children:[e.jsx("input",{ref:a,type:"file",accept:r.join(","),multiple:m>1,onChange:U,className:"file-upload-input"}),c&&e.jsxs("div",{className:"file-upload-overlay",children:[e.jsx(Y,{size:32}),e.jsx("span",{children:"Drop files here"})]}),s.length>0&&e.jsx("div",{className:"file-upload-preview",children:s.map(t=>e.jsxs("div",{className:"file-preview-item",children:[t.type==="image"&&t.preview?e.jsx("img",{src:t.preview,alt:t.file.name,className:"file-preview-image"}):e.jsx("div",{className:"file-preview-icon",children:e.jsx(ee,{size:24})}),e.jsx("span",{className:"file-preview-name",children:t.file.name}),e.jsx("button",{type:"button",onClick:()=>_(t.id),className:"file-preview-remove","aria-label":"Remove file",children:e.jsx(se,{size:14})})]},t.id))}),x&&e.jsx("div",{className:"file-upload-error",children:x}),e.jsx("div",{className:"file-upload-actions",children:e.jsx("button",{type:"button",onClick:R,className:"file-upload-button",title:"Upload images or PDFs",disabled:s.length>=m,children:e.jsx(te,{size:18})})}),l]})}function Ne({sessionId:s,initialMessages:d=[]}){const{mode:m,selectedModelId:u,setSelectedModelId:r,isLoading:l,isStreaming:c,streamingContent:h,streamingThinking:x,setLoading:o,setStreaming:a,appendStreamContent:p,addThinkingStep:f,resetStream:g,setError:v}=$(),[S,A]=n.useState(d),[U,_]=n.useState(""),[R,t]=n.useState([]),[j,w]=n.useState(""),[y,D]=n.useState(null),z=n.useRef(null),E=n.useRef(null),O=()=>{z.current?.scrollIntoView({behavior:"smooth"})};n.useEffect(()=>{O()},[S,h]);const q=n.useCallback(async()=>{const i=[];for(const b of R)if(b.type==="image"&&b.preview)i.push(b.preview);else{const T=await new Promise(C=>{const k=new FileReader;k.onload=()=>C(k.result),k.readAsDataURL(b.file)});i.push(T)}return i},[R]),M=async i=>{if(i.preventDefault(),!U.trim()||l||c)return;const b=await q(),T={id:crypto.randomUUID(),session_id:s,role:"user",content:U.trim(),created_at:new Date().toISOString()};A(C=>[...C,T]),_(""),t([]),w(""),g(),o(!0),v(null);try{a(!0);const C=I.queryStreamFetch({text:T.content,mode:m,model_id:u||void 0,session_id:s,image_urls:b.length>0?b:void 0});let k=null;for await(const N of C)switch(N.type){case"token":N.content&&p(N.content);break;case"thinking":N.thinking&&f(N.thinking);break;case"done":N.response&&(k=N.response,D(k));break;case"error":v(N.error||"An error occurred");break}if(k){const N={id:crypto.randomUUID(),session_id:s,role:"assistant",content:k.text,mode:k.mode,citations:k.citations,created_at:new Date().toISOString()};A(Z=>[...Z,N])}}catch(C){v(C instanceof Error?C.message:"Failed to get response")}finally{o(!1),a(!1),g(),D(null)}},H=i=>{_(i),E.current?.focus()},V=i=>{i.key==="Enter"&&!i.shiftKey&&(i.preventDefault(),M(i))},K=n.useCallback(i=>{_(b=>b+(b?" ":"")+i),w("")},[]),X=n.useCallback(i=>{w(i)},[]);return e.jsxs("div",{className:"ai-chat",children:[e.jsxs("div",{className:"ai-chat-messages",children:[S.map(i=>e.jsx("div",{className:`ai-chat-message ${i.role}`,children:i.role==="user"?e.jsx("div",{className:"ai-chat-user-message",children:i.content}):e.jsx(B,{response:{text:i.content,mode:i.mode||"quick",citations:i.citations||[],follow_ups:[],related_questions:[],images:[],session_id:s,sources_used:i.citations?.length||0},onFollowUp:H})},i.id)),c&&h&&e.jsx("div",{className:"ai-chat-message assistant",children:e.jsx(B,{response:y||{text:h,mode:m,citations:[],follow_ups:[],related_questions:[],images:[],session_id:s,sources_used:0,thinking_steps:x},streamingContent:h,streamingThinking:x,isStreaming:!0})}),e.jsx("div",{ref:z})]}),e.jsxs("div",{className:"ai-chat-input-container",children:[e.jsxs("div",{className:"ai-chat-mode-bar",children:[e.jsx(J,{size:"sm"}),e.jsx(W,{selectedModel:u||void 0,onSelectModel:r,size:"sm"})]}),e.jsx(ke,{files:R,onFilesChange:t,children:e.jsxs("form",{onSubmit:M,className:"ai-chat-form",children:[e.jsxs("div",{className:"ai-chat-input-wrapper",children:[e.jsx("textarea",{ref:E,value:U+(j?` ${j}`:""),onChange:i=>_(i.target.value),onKeyDown:V,placeholder:"Ask a follow-up question...",className:"ai-chat-input",rows:1,disabled:l||c}),j&&e.jsx("span",{className:"ai-chat-interim",children:j})]}),e.jsxs("div",{className:"ai-chat-actions",children:[e.jsx(Q,{onTranscript:K,onInterimTranscript:X,disabled:l||c,size:"sm"}),e.jsx("button",{type:"submit",disabled:!U.trim()||l||c,className:"ai-chat-submit",children:l||c?e.jsx(ae,{size:18,className:"animate-spin"}):e.jsx(ne,{size:18})})]})]})})]})]})}const F={text:e.jsx(he,{size:16}),note:e.jsx(me,{size:16}),heading:e.jsx(ue,{size:16}),divider:e.jsx(de,{size:16}),code:e.jsx(ce,{size:16})};function we({block:s,sessionId:d,onUpdate:m,onDelete:u}){const[r,l]=n.useState(!1),[c,h]=n.useState(s.content),x=async()=>{if(c!==s.content)try{await I.updateBlock(d,s.id,{content:c}),m({...s,content:c})}catch(a){console.error("Failed to update block:",a)}l(!1)},o=async()=>{try{await I.deleteBlock(d,s.id),u()}catch(a){console.error("Failed to delete block:",a)}};return e.jsxs("div",{className:`canvas-block ${s.type}`,children:[e.jsx("div",{className:"canvas-block-drag",children:e.jsx(re,{size:16})}),e.jsx("div",{className:"canvas-block-content",children:r?e.jsx("textarea",{value:c,onChange:a=>h(a.target.value),onBlur:x,autoFocus:!0,className:"canvas-block-editor"}):e.jsx("div",{onClick:()=>l(!0),className:"canvas-block-text",children:s.type==="heading"?e.jsx("h2",{children:s.content}):s.type==="divider"?e.jsx("hr",{}):s.type==="code"?e.jsx("pre",{children:e.jsx("code",{children:s.content})}):e.jsx("p",{children:s.content})})}),e.jsx("button",{type:"button",onClick:o,className:"canvas-block-delete",children:e.jsx(le,{size:14})})]})}function ye({canvas:s,onUpdate:d}){const[m,u]=n.useState(!1),r=s.blocks||[],l=async o=>{try{const{block:a}=await I.addBlock(s.session_id,o,o==="divider"?"":"New block",r.length);d({...s,blocks:[...r,a]}),u(!1)}catch(a){console.error("Failed to add block:",a)}},c=(o,a)=>{const p=[...r];p[o]=a,d({...s,blocks:p})},h=o=>{const a=r.filter((p,f)=>f!==o);d({...s,blocks:a})},x=async o=>{try{const a=await I.exportCanvas(s.session_id,o),p=URL.createObjectURL(a),f=document.createElement("a");f.href=p,f.download=`${s.title||"canvas"}.${o==="markdown"?"md":o}`,document.body.appendChild(f),f.click(),document.body.removeChild(f),URL.revokeObjectURL(p)}catch(a){console.error("Failed to export canvas:",a)}};return e.jsxs("div",{className:"canvas",children:[e.jsxs("div",{className:"canvas-header",children:[e.jsx("h3",{className:"canvas-title",children:s.title||"Research Canvas"}),e.jsx("div",{className:"canvas-actions",children:e.jsxs("div",{className:"canvas-export-dropdown",children:[e.jsxs("button",{type:"button",className:"canvas-export-button",children:[e.jsx(ie,{size:16}),"Export"]}),e.jsxs("div",{className:"canvas-export-menu",children:[e.jsx("button",{type:"button",onClick:()=>x("markdown"),children:"Markdown"}),e.jsx("button",{type:"button",onClick:()=>x("html"),children:"HTML"}),e.jsx("button",{type:"button",onClick:()=>x("json"),children:"JSON"})]})]})})]}),e.jsxs("div",{className:"canvas-blocks",children:[r.map((o,a)=>e.jsx(we,{block:o,sessionId:s.session_id,onUpdate:p=>c(a,p),onDelete:()=>h(a)},o.id)),m?e.jsxs("div",{className:"canvas-add-menu",children:[e.jsxs("button",{type:"button",onClick:()=>l("text"),children:[F.text," Text"]}),e.jsxs("button",{type:"button",onClick:()=>l("heading"),children:[F.heading," Heading"]}),e.jsxs("button",{type:"button",onClick:()=>l("note"),children:[F.note," Note"]}),e.jsxs("button",{type:"button",onClick:()=>l("code"),children:[F.code," Code"]}),e.jsxs("button",{type:"button",onClick:()=>l("divider"),children:[F.divider," Divider"]}),e.jsx("button",{type:"button",onClick:()=>u(!1),children:"Cancel"})]}):e.jsxs("button",{type:"button",onClick:()=>u(!0),className:"canvas-add-button",children:[e.jsx(oe,{size:16}),"Add block"]})]})]})}function _e(){const{id:s}=G(),{setCurrentSessionId:d,currentCanvas:m,setCurrentCanvas:u}=$(),[r,l]=n.useState(null),[c,h]=n.useState(!0),[x,o]=n.useState(null),[a,p]=n.useState(!0);n.useEffect(()=>s?((async()=>{try{h(!0),d(s);const[v,S]=await Promise.allSettled([I.getSession(s),I.getCanvas(s)]);if(v.status==="fulfilled")l(v.value.session);else throw new Error("Session not found");S.status==="fulfilled"&&u(S.value.canvas)}catch(v){o(v instanceof Error?v.message:"Failed to load session")}finally{h(!1)}})(),()=>{d(null),u(null)}):void 0,[s]);const f=g=>{u(g)};return c?e.jsx("div",{className:"min-h-screen bg-white flex items-center justify-center",children:e.jsx("div",{className:"w-8 h-8 border-4 border-[#1a73e8] border-t-transparent rounded-full animate-spin"})}):x||!r?e.jsxs("div",{className:"min-h-screen bg-white",children:[e.jsx("header",{className:"sticky top-0 bg-white border-b border-[#e0e0e0] z-50",children:e.jsx("div",{className:"max-w-7xl mx-auto px-4 py-3",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(L,{to:"/ai/sessions",className:"p-2 text-[#5f6368] hover:bg-[#f1f3f4] rounded-full transition-colors",children:e.jsx(P,{size:20})}),e.jsx("h1",{className:"text-lg font-medium text-[#202124]",children:"Error"})]})})}),e.jsxs("main",{className:"max-w-4xl mx-auto px-4 py-12 text-center",children:[e.jsx("p",{className:"text-red-600 mb-4",children:x||"Session not found"}),e.jsx(L,{to:"/ai/sessions",className:"text-[#1a73e8] hover:underline",children:"Back to sessions"})]})]}):e.jsxs("div",{className:"min-h-screen bg-white flex flex-col",children:[e.jsx("header",{className:"sticky top-0 bg-white border-b border-[#e0e0e0] z-50",children:e.jsx("div",{className:"px-4 py-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(L,{to:"/ai/sessions",className:"p-2 text-[#5f6368] hover:bg-[#f1f3f4] rounded-full transition-colors",children:e.jsx(P,{size:20})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(pe,{size:20,className:"text-[#1a73e8]"}),e.jsx("h1",{className:"text-lg font-medium text-[#202124]",children:r.title||"Research Session"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{type:"button",onClick:()=>p(!a),className:"p-2 text-[#5f6368] hover:bg-[#f1f3f4] rounded-full transition-colors",title:a?"Hide canvas":"Show canvas",children:a?e.jsx(xe,{size:20}):e.jsx(fe,{size:20})}),e.jsx(L,{to:"/settings",className:"p-2 text-[#5f6368] hover:bg-[#f1f3f4] rounded-full transition-colors",children:e.jsx(je,{size:20})})]})]})})}),e.jsxs("main",{className:"flex-1 flex overflow-hidden",children:[e.jsx("div",{className:`flex-1 flex flex-col ${a?"border-r border-[#e0e0e0]":""}`,children:e.jsx(Ne,{sessionId:r.id,initialMessages:r.messages||[]})}),a&&m&&e.jsx("div",{className:"w-96 flex-shrink-0 overflow-auto bg-[#f8f9fa]",children:e.jsx(ye,{canvas:m,onUpdate:f})})]})]})}export{_e as default};
