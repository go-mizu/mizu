import{j as e}from"./markdown-DRpjVqyA.js";import{r as n,b as se,L as P}from"./react-vendor-DqWpB-k-.js";import{a as X,b as E}from"./index-CAplHHN5.js";import{a as H,A as te}from"./AIResponse-BCJIzhT6.js";import{M as ne,V as ae}from"./VoiceInput-UQPjxTqg.js";import{D as ie,H as re,X as oe,I as le,r as ce,J as de,K as ue,n as me,O as he,T as pe,j as xe,Q as fe,W as je,Y as ve,_ as ge,m as K,S as be,$ as ke,a0 as Ne,h as we}from"./ui-DxqIiTN1.js";const ye=["image/jpeg","image/png","image/gif","image/webp","application/pdf"],Ce=10,Se=5;function De({files:s,onFilesChange:d,maxFiles:m=Se,maxSizeMB:u=Ce,accept:o=ye,children:l}){const[c,h]=n.useState(!1),[x,r]=n.useState(null),a=n.useRef(null),p=n.useCallback(t=>o.includes(t.type)?t.size>u*1024*1024?`File size exceeds ${u}MB limit`:null:`File type ${t.type} is not supported`,[o,u]),f=n.useCallback(async t=>{const j=p(t);if(j)return r(j),null;const N=t.type.startsWith("image/"),y=N?"image":"pdf";let D;return N&&(D=await new Promise(R=>{const _=new FileReader;_.onload=()=>R(_.result),_.readAsDataURL(t)})),{id:crypto.randomUUID(),file:t,type:y,preview:D}},[p]),g=n.useCallback(async t=>{r(null);const j=[],N=m-s.length;for(let y=0;y<Math.min(t.length,N);y++){const D=(t instanceof FileList,t[y]),R=await f(D);R&&j.push(R)}t.length>N&&r(`Maximum ${m} files allowed`),j.length>0&&d([...s,...j])},[s,m,d,f]),v=n.useCallback(t=>{t.preventDefault(),t.stopPropagation(),h(!0)},[]),S=n.useCallback(t=>{t.preventDefault(),t.stopPropagation(),h(!1)},[]),B=n.useCallback(t=>{t.preventDefault(),t.stopPropagation(),h(!1),g(t.dataTransfer.files)},[g]),z=n.useCallback(t=>{t.target.files&&g(t.target.files),t.target.value=""},[g]),I=n.useCallback(t=>{d(s.filter(j=>j.id!==t))},[s,d]),T=n.useCallback(()=>{a.current?.click()},[]);return e.jsxs("div",{className:`file-upload-zone ${c?"dragging":""}`,onDragOver:v,onDragLeave:S,onDrop:B,children:[e.jsx("input",{ref:a,type:"file",accept:o.join(","),multiple:m>1,onChange:z,className:"file-upload-input"}),c&&e.jsxs("div",{className:"file-upload-overlay",children:[e.jsx(ie,{size:32}),e.jsx("span",{children:"Drop files here"})]}),s.length>0&&e.jsx("div",{className:"file-upload-preview",children:s.map(t=>e.jsxs("div",{className:"file-preview-item",children:[t.type==="image"&&t.preview?e.jsx("img",{src:t.preview,alt:t.file.name,className:"file-preview-image"}):e.jsx("div",{className:"file-preview-icon",children:e.jsx(re,{size:24})}),e.jsx("span",{className:"file-preview-name",children:t.file.name}),e.jsx("button",{type:"button",onClick:()=>I(t.id),className:"file-preview-remove","aria-label":"Remove file",children:e.jsx(oe,{size:14})})]},t.id))}),x&&e.jsx("div",{className:"file-upload-error",children:x}),e.jsx("div",{className:"file-upload-actions",children:e.jsx("button",{type:"button",onClick:T,className:"file-upload-button",title:"Upload images or PDFs",disabled:s.length>=m,children:e.jsx(le,{size:18})})}),l]})}function Re({sessionId:s,initialMessages:d=[]}){const{mode:m,selectedModelId:u,setSelectedModelId:o,isLoading:l,isStreaming:c,streamingContent:h,streamingThinking:x,setLoading:r,setStreaming:a,appendStreamContent:p,addThinkingStep:f,resetStream:g,setError:v}=X(),[S,B]=n.useState(d),[z,I]=n.useState(""),[T,t]=n.useState([]),[j,N]=n.useState(""),[y,D]=n.useState(null),R=n.useRef(null),_=n.useRef(null),U=n.useRef(null),$=n.useRef(0),O=n.useCallback(()=>{U.current&&(U.current.abort(),U.current=null)},[]);n.useEffect(()=>()=>{O()},[O]);const J=()=>{R.current?.scrollIntoView({behavior:"smooth"})};n.useEffect(()=>{J()},[S,h]);const W=n.useCallback(async()=>{const i=[];for(const w of T)if(w.type==="image"&&w.preview)i.push(w.preview);else{const L=await new Promise(b=>{const A=new FileReader;A.onload=()=>b(A.result),A.readAsDataURL(w.file)});i.push(L)}return i},[T]),q=async i=>{if(i.preventDefault(),!z.trim()||l||c)return;O(),$.current+=1;const w=$.current,L=new AbortController;U.current=L;const b=()=>$.current!==w,A=await W(),V={id:crypto.randomUUID(),session_id:s,role:"user",content:z.trim(),created_at:new Date().toISOString()};B(C=>[...C,V]),I(""),t([]),N(""),g(),r(!0),v(null);try{a(!0);const C=E.queryStreamFetch({text:V.content,mode:m,model_id:u||void 0,session_id:s,image_urls:A.length>0?A:void 0},L.signal);let F=null;for await(const k of C){if(b())break;switch(k.type){case"token":k.content&&!b()&&p(k.content);break;case"thinking":k.thinking&&!b()&&f(k.thinking);break;case"done":k.response&&!b()&&(F=k.response,D(F));break;case"error":b()||v(k.error||"An error occurred");break}}if(F&&!b()){const k={id:crypto.randomUUID(),session_id:s,role:"assistant",content:F.text,mode:F.mode,citations:F.citations,created_at:new Date().toISOString()};B(ee=>[...ee,k])}}catch(C){if(C instanceof Error&&C.name==="AbortError")return;b()||v(C instanceof Error?C.message:"Failed to get response")}finally{b()||(r(!1),a(!1),g(),D(null)),U.current===L&&(U.current=null)}},Z=i=>{I(i),_.current?.focus()},G=i=>{i.key==="Enter"&&!i.shiftKey&&(i.preventDefault(),q(i))},Q=n.useCallback(i=>{I(w=>w+(w?" ":"")+i),N("")},[]),Y=n.useCallback(i=>{N(i)},[]);return e.jsxs("div",{className:"ai-chat",children:[e.jsxs("div",{className:"ai-chat-messages",children:[S.map(i=>e.jsx("div",{className:`ai-chat-message ${i.role}`,children:i.role==="user"?e.jsx("div",{className:"ai-chat-user-message",children:i.content}):e.jsx(H,{response:{text:i.content,mode:i.mode||"quick",citations:i.citations||[],follow_ups:[],related_questions:[],images:[],session_id:s,sources_used:i.citations?.length||0},onFollowUp:Z})},i.id)),c&&h&&e.jsx("div",{className:"ai-chat-message assistant",children:e.jsx(H,{response:y||{text:h,mode:m,citations:[],follow_ups:[],related_questions:[],images:[],session_id:s,sources_used:0,thinking_steps:x},streamingContent:h,streamingThinking:x,isStreaming:!0})}),e.jsx("div",{ref:R})]}),e.jsxs("div",{className:"ai-chat-input-container",children:[e.jsxs("div",{className:"ai-chat-mode-bar",children:[e.jsx(te,{size:"sm"}),e.jsx(ne,{selectedModel:u||void 0,onSelectModel:o,size:"sm"})]}),e.jsx(De,{files:T,onFilesChange:t,children:e.jsxs("form",{onSubmit:q,className:"ai-chat-form",children:[e.jsxs("div",{className:"ai-chat-input-wrapper",children:[e.jsx("textarea",{ref:_,value:z+(j?` ${j}`:""),onChange:i=>I(i.target.value),onKeyDown:G,placeholder:"Ask a follow-up question...",className:"ai-chat-input",rows:1,disabled:l||c}),j&&e.jsx("span",{className:"ai-chat-interim",children:j})]}),e.jsxs("div",{className:"ai-chat-actions",children:[e.jsx(ae,{onTranscript:Q,onInterimTranscript:Y,disabled:l||c,size:"sm"}),e.jsx("button",{type:"submit",disabled:!z.trim()||l||c,className:"ai-chat-submit",children:l||c?e.jsx(ce,{size:18,className:"animate-spin"}):e.jsx(de,{size:18})})]})]})})]})]})}const M={text:e.jsx(ge,{size:16}),note:e.jsx(ve,{size:16}),heading:e.jsx(je,{size:16}),divider:e.jsx(fe,{size:16}),code:e.jsx(xe,{size:16})};function Ee({block:s,sessionId:d,onUpdate:m,onDelete:u}){const[o,l]=n.useState(!1),[c,h]=n.useState(s.content),x=async()=>{if(c!==s.content)try{await E.updateBlock(d,s.id,{content:c}),m({...s,content:c})}catch(a){console.error("Failed to update block:",a)}l(!1)},r=async()=>{try{await E.deleteBlock(d,s.id),u()}catch(a){console.error("Failed to delete block:",a)}};return e.jsxs("div",{className:`canvas-block ${s.type}`,children:[e.jsx("div",{className:"canvas-block-drag",children:e.jsx(he,{size:16})}),e.jsx("div",{className:"canvas-block-content",children:o?e.jsx("textarea",{value:c,onChange:a=>h(a.target.value),onBlur:x,autoFocus:!0,className:"canvas-block-editor"}):e.jsx("div",{onClick:()=>l(!0),className:"canvas-block-text",children:s.type==="heading"?e.jsx("h2",{children:s.content}):s.type==="divider"?e.jsx("hr",{}):s.type==="code"?e.jsx("pre",{children:e.jsx("code",{children:s.content})}):e.jsx("p",{children:s.content})})}),e.jsx("button",{type:"button",onClick:r,className:"canvas-block-delete",children:e.jsx(pe,{size:14})})]})}function ze({canvas:s,onUpdate:d}){const[m,u]=n.useState(!1),o=s.blocks||[],l=async r=>{try{const{block:a}=await E.addBlock(s.session_id,r,r==="divider"?"":"New block",o.length);d({...s,blocks:[...o,a]}),u(!1)}catch(a){console.error("Failed to add block:",a)}},c=(r,a)=>{const p=[...o];p[r]=a,d({...s,blocks:p})},h=r=>{const a=o.filter((p,f)=>f!==r);d({...s,blocks:a})},x=async r=>{try{const a=await E.exportCanvas(s.session_id,r),p=URL.createObjectURL(a),f=document.createElement("a");f.href=p,f.download=`${s.title||"canvas"}.${r==="markdown"?"md":r}`,document.body.appendChild(f),f.click(),document.body.removeChild(f),URL.revokeObjectURL(p)}catch(a){console.error("Failed to export canvas:",a)}};return e.jsxs("div",{className:"canvas",children:[e.jsxs("div",{className:"canvas-header",children:[e.jsx("h3",{className:"canvas-title",children:s.title||"Research Canvas"}),e.jsx("div",{className:"canvas-actions",children:e.jsxs("div",{className:"canvas-export-dropdown",children:[e.jsxs("button",{type:"button",className:"canvas-export-button",children:[e.jsx(ue,{size:16}),"Export"]}),e.jsxs("div",{className:"canvas-export-menu",children:[e.jsx("button",{type:"button",onClick:()=>x("markdown"),children:"Markdown"}),e.jsx("button",{type:"button",onClick:()=>x("html"),children:"HTML"}),e.jsx("button",{type:"button",onClick:()=>x("json"),children:"JSON"})]})]})})]}),e.jsxs("div",{className:"canvas-blocks",children:[o.map((r,a)=>e.jsx(Ee,{block:r,sessionId:s.session_id,onUpdate:p=>c(a,p),onDelete:()=>h(a)},r.id)),m?e.jsxs("div",{className:"canvas-add-menu",children:[e.jsxs("button",{type:"button",onClick:()=>l("text"),children:[M.text," Text"]}),e.jsxs("button",{type:"button",onClick:()=>l("heading"),children:[M.heading," Heading"]}),e.jsxs("button",{type:"button",onClick:()=>l("note"),children:[M.note," Note"]}),e.jsxs("button",{type:"button",onClick:()=>l("code"),children:[M.code," Code"]}),e.jsxs("button",{type:"button",onClick:()=>l("divider"),children:[M.divider," Divider"]}),e.jsx("button",{type:"button",onClick:()=>u(!1),children:"Cancel"})]}):e.jsxs("button",{type:"button",onClick:()=>u(!0),className:"canvas-add-button",children:[e.jsx(me,{size:16}),"Add block"]})]})]})}function Le(){const{id:s}=se(),{setCurrentSessionId:d,currentCanvas:m,setCurrentCanvas:u}=X(),[o,l]=n.useState(null),[c,h]=n.useState(!0),[x,r]=n.useState(null),[a,p]=n.useState(!0);n.useEffect(()=>s?((async()=>{try{h(!0),d(s);const[v,S]=await Promise.allSettled([E.getSession(s),E.getCanvas(s)]);if(v.status==="fulfilled")l(v.value.session);else throw new Error("Session not found");S.status==="fulfilled"&&u(S.value.canvas)}catch(v){r(v instanceof Error?v.message:"Failed to load session")}finally{h(!1)}})(),()=>{d(null),u(null)}):void 0,[s]);const f=g=>{u(g)};return c?e.jsx("div",{className:"min-h-screen bg-white flex items-center justify-center",children:e.jsx("div",{className:"w-8 h-8 border-4 border-[#1a73e8] border-t-transparent rounded-full animate-spin"})}):x||!o?e.jsxs("div",{className:"min-h-screen bg-white",children:[e.jsx("header",{className:"sticky top-0 bg-white border-b border-[#e0e0e0] z-50",children:e.jsx("div",{className:"max-w-7xl mx-auto px-4 py-3",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(P,{to:"/ai/sessions",className:"p-2 text-[#5f6368] hover:bg-[#f1f3f4] rounded-full transition-colors",children:e.jsx(K,{size:20})}),e.jsx("h1",{className:"text-lg font-medium text-[#202124]",children:"Error"})]})})}),e.jsxs("main",{className:"max-w-4xl mx-auto px-4 py-12 text-center",children:[e.jsx("p",{className:"text-red-600 mb-4",children:x||"Session not found"}),e.jsx(P,{to:"/ai/sessions",className:"text-[#1a73e8] hover:underline",children:"Back to sessions"})]})]}):e.jsxs("div",{className:"min-h-screen bg-white flex flex-col",children:[e.jsx("header",{className:"sticky top-0 bg-white border-b border-[#e0e0e0] z-50",children:e.jsx("div",{className:"px-4 py-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(P,{to:"/ai/sessions",className:"p-2 text-[#5f6368] hover:bg-[#f1f3f4] rounded-full transition-colors",children:e.jsx(K,{size:20})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(be,{size:20,className:"text-[#1a73e8]"}),e.jsx("h1",{className:"text-lg font-medium text-[#202124]",children:o.title||"Research Session"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{type:"button",onClick:()=>p(!a),className:"p-2 text-[#5f6368] hover:bg-[#f1f3f4] rounded-full transition-colors",title:a?"Hide canvas":"Show canvas",children:a?e.jsx(ke,{size:20}):e.jsx(Ne,{size:20})}),e.jsx(P,{to:"/settings",className:"p-2 text-[#5f6368] hover:bg-[#f1f3f4] rounded-full transition-colors",children:e.jsx(we,{size:20})})]})]})})}),e.jsxs("main",{className:"flex-1 flex overflow-hidden",children:[e.jsx("div",{className:`flex-1 flex flex-col ${a?"border-r border-[#e0e0e0]":""}`,children:e.jsx(Re,{sessionId:o.id,initialMessages:o.messages||[]})}),a&&m&&e.jsx("div",{className:"w-96 flex-shrink-0 overflow-auto bg-[#f8f9fa]",children:e.jsx(ze,{canvas:m,onUpdate:f})})]})]})}export{Le as default};
