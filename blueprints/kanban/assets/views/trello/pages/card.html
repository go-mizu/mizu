{{define "content"}}
<style>
  .card-page {
    max-width: 768px;
    margin: 0 auto;
    padding: 48px 8px;
    background: var(--trello-neutral-20);
    min-height: calc(100vh - var(--header-height));
  }

  .card-cover {
    height: 116px;
    background: var(--trello-blue-500);
    border-radius: 3px 3px 0 0;
    position: relative;
  }

  .card-header {
    padding: 16px 48px 8px 56px;
    position: relative;
    background: var(--trello-neutral-0);
  }

  .card-header-icon {
    position: absolute;
    left: 16px;
    top: 20px;
    color: var(--trello-neutral-500);
  }

  .card-header-icon svg {
    width: 24px;
    height: 24px;
    fill: currentColor;
  }

  .card-title-input {
    font-size: 20px;
    font-weight: 600;
    color: var(--trello-neutral-800);
    width: 100%;
    padding: 4px 8px;
    margin: -4px -8px;
    border: none;
    background: transparent;
    border-radius: 3px;
    font-family: var(--font-family);
    resize: none;
    overflow: hidden;
  }

  .card-title-input:hover {
    background: rgba(9, 30, 66, 0.04);
  }

  .card-title-input:focus {
    background: var(--trello-neutral-0);
    outline: none;
    box-shadow: inset 0 0 0 2px var(--trello-blue-500);
  }

  .card-list-info {
    font-size: 14px;
    color: var(--trello-neutral-500);
    margin-top: 8px;
  }

  .card-list-info a {
    color: var(--trello-neutral-800);
    text-decoration: underline;
  }

  .card-body {
    display: flex;
    gap: 16px;
    padding: 16px;
    background: var(--trello-neutral-0);
    border-radius: 0 0 3px 3px;
  }

  .card-main {
    flex: 1;
    min-width: 0;
  }

  .card-sidebar {
    width: 168px;
    min-width: 168px;
  }

  .card-section {
    margin-bottom: 24px;
  }

  .card-section-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 8px;
    padding-left: 40px;
    position: relative;
  }

  .card-section-header svg {
    position: absolute;
    left: 0;
    top: 50%;
    transform: translateY(-50%);
    width: 24px;
    height: 24px;
    fill: var(--trello-neutral-500);
  }

  .card-section-title {
    font-size: 16px;
    font-weight: 600;
    color: var(--trello-neutral-800);
  }

  .card-section-content {
    padding-left: 40px;
  }

  /* Labels section */
  .card-labels-list {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
  }

  .card-label-chip {
    display: inline-flex;
    align-items: center;
    height: 32px;
    min-width: 48px;
    padding: 0 12px;
    border-radius: 3px;
    font-size: 14px;
    font-weight: 600;
    color: white;
    cursor: pointer;
  }

  .card-label-green { background: #61bd4f; }
  .card-label-yellow { background: #f2d600; color: var(--trello-neutral-800); }
  .card-label-orange { background: #ff9f1a; }
  .card-label-red { background: #eb5a46; }
  .card-label-purple { background: #c377e0; }
  .card-label-blue { background: #0079bf; }

  .add-label-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    height: 32px;
    width: 32px;
    background: rgba(9, 30, 66, 0.04);
    border: none;
    border-radius: 3px;
    cursor: pointer;
  }

  .add-label-btn:hover {
    background: rgba(9, 30, 66, 0.08);
  }

  .add-label-btn svg {
    width: 20px;
    height: 20px;
    fill: var(--trello-neutral-500);
  }

  /* Members section */
  .card-members-list {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
  }

  .card-member-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: #dfe1e6;
    color: var(--trello-neutral-800);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    font-weight: 700;
    cursor: pointer;
  }

  /* Description */
  .description-placeholder {
    min-height: 56px;
    background: rgba(9, 30, 66, 0.04);
    border-radius: 3px;
    padding: 8px 12px;
    color: var(--trello-neutral-500);
    cursor: pointer;
  }

  .description-placeholder:hover {
    background: rgba(9, 30, 66, 0.08);
  }

  .description-content {
    font-size: 14px;
    line-height: 1.6;
    color: var(--trello-neutral-800);
    white-space: pre-wrap;
  }

  .description-textarea {
    width: 100%;
    min-height: 108px;
    padding: 8px 12px;
    font-size: 14px;
    font-family: var(--font-family);
    line-height: 1.6;
    border: none;
    border-radius: 3px;
    background: var(--trello-neutral-0);
    box-shadow: inset 0 0 0 2px var(--trello-blue-500);
    resize: vertical;
    margin-bottom: 8px;
  }

  .description-textarea:focus {
    outline: none;
  }

  .description-actions {
    display: flex;
    gap: 4px;
  }

  /* Activity / Comments */
  .activity-input-wrapper {
    display: flex;
    gap: 8px;
    align-items: flex-start;
    margin-bottom: 16px;
  }

  .activity-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: var(--trello-blue-600);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    font-weight: 700;
    flex-shrink: 0;
  }

  .activity-input {
    flex: 1;
    padding: 8px 12px;
    font-size: 14px;
    border: none;
    border-radius: 3px;
    background: var(--trello-neutral-0);
    box-shadow: 0 1px 2px rgba(9, 30, 66, 0.25);
  }

  .activity-input:focus {
    outline: none;
    box-shadow: inset 0 0 0 2px var(--trello-blue-500);
  }

  .comment-item {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
  }

  .comment-content {
    flex: 1;
  }

  .comment-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 4px;
  }

  .comment-author {
    font-size: 14px;
    font-weight: 600;
    color: var(--trello-neutral-800);
  }

  .comment-date {
    font-size: 12px;
    color: var(--trello-neutral-500);
  }

  .comment-text {
    font-size: 14px;
    line-height: 1.5;
    color: var(--trello-neutral-800);
    background: var(--trello-neutral-0);
    padding: 8px 12px;
    border-radius: 3px;
    box-shadow: 0 1px 2px rgba(9, 30, 66, 0.25);
  }

  /* Sidebar */
  .sidebar-section {
    margin-bottom: 16px;
  }

  .sidebar-section-title {
    font-size: 12px;
    font-weight: 600;
    color: var(--trello-neutral-500);
    text-transform: uppercase;
    margin-bottom: 8px;
  }

  .sidebar-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    width: 100%;
    padding: 6px 12px;
    font-size: 14px;
    font-family: var(--font-family);
    color: var(--trello-neutral-800);
    background: rgba(9, 30, 66, 0.04);
    border: none;
    border-radius: 3px;
    cursor: pointer;
    text-align: left;
    margin-bottom: 8px;
    transition: background 0.1s;
  }

  .sidebar-btn:hover {
    background: rgba(9, 30, 66, 0.08);
  }

  .sidebar-btn svg {
    width: 16px;
    height: 16px;
    fill: currentColor;
  }

  /* Back button */
  .back-link {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    margin-bottom: 16px;
    font-size: 14px;
    color: var(--trello-neutral-500);
    text-decoration: none;
    border-radius: 3px;
  }

  .back-link:hover {
    background: rgba(9, 30, 66, 0.04);
    color: var(--trello-neutral-800);
  }

  .back-link svg {
    width: 16px;
    height: 16px;
    fill: currentColor;
  }
</style>

<div class="card-page">
  <a href="/t/{{.Workspace.Slug}}/b/{{.Board.ID}}" class="back-link">
    <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
    Back to board
  </a>

  <div style="background: var(--trello-neutral-0); border-radius: 3px; box-shadow: 0 1px 2px rgba(9,30,66,.25);">
    <div class="card-header">
      <div class="card-header-icon">
        <svg viewBox="0 0 24 24"><path d="M19 5v14H5V5h14m0-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/><rect x="7" y="7" width="10" height="2"/><rect x="7" y="11" width="10" height="2"/><rect x="7" y="15" width="7" height="2"/></svg>
      </div>
      <textarea class="card-title-input" rows="1" id="card-title">{{.Card.Title}}</textarea>
      <div class="card-list-info">
        in list <a href="#">{{if .List}}{{.List.Name}}{{end}}</a>
      </div>
    </div>

    <div class="card-body">
      <div class="card-main">
        {{if .AllLabels}}
        <div class="card-section">
          <div class="card-section-header">
            <svg viewBox="0 0 24 24"><path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/></svg>
            <h3 class="card-section-title">Labels</h3>
          </div>
          <div class="card-section-content">
            <div class="card-labels-list">
              {{range .Labels}}
              <div class="card-label-chip card-label-{{.Color}}">{{.Name}}</div>
              {{end}}
              <button class="add-label-btn">
                <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
              </button>
            </div>
          </div>
        </div>
        {{end}}

        {{if .AllMembers}}
        <div class="card-section">
          <div class="card-section-header">
            <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
            <h3 class="card-section-title">Members</h3>
          </div>
          <div class="card-section-content">
            <div class="card-members-list">
              {{range .Members}}
              <div class="card-member-avatar" title="{{.DisplayName}}">{{slice .DisplayName 0 1}}</div>
              {{end}}
              <button class="add-label-btn">
                <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
              </button>
            </div>
          </div>
        </div>
        {{end}}

        <div class="card-section">
          <div class="card-section-header">
            <svg viewBox="0 0 24 24"><path d="M14 17H4v2h10v-2zm6-8H4v2h16V9zM4 15h16v-2H4v2zM4 5v2h16V5H4z"/></svg>
            <h3 class="card-section-title">Description</h3>
          </div>
          <div class="card-section-content">
            <div id="description-view">
              {{if .Card.Description}}
              <div class="description-content">{{.Card.Description}}</div>
              {{else}}
              <div class="description-placeholder">Add a more detailed description...</div>
              {{end}}
            </div>
            <div id="description-edit" style="display: none;">
              <textarea class="description-textarea" id="description-input" placeholder="Add a more detailed description...">{{.Card.Description}}</textarea>
              <div class="description-actions">
                <button class="btn btn-primary" id="save-description">Save</button>
                <button class="btn btn-secondary" id="cancel-description">Cancel</button>
              </div>
            </div>
          </div>
        </div>

        <div class="card-section">
          <div class="card-section-header">
            <svg viewBox="0 0 24 24"><path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/></svg>
            <h3 class="card-section-title">Activity</h3>
          </div>
          <div class="card-section-content">
            <div class="activity-input-wrapper">
              <div class="activity-avatar">{{if .User}}{{slice .User.DisplayName 0 1}}{{end}}</div>
              <input type="text" class="activity-input" placeholder="Write a comment..." id="comment-input">
            </div>

            {{range .CommentList}}
            <div class="comment-item">
              <div class="activity-avatar">{{if .User}}{{slice .User.DisplayName 0 1}}{{end}}</div>
              <div class="comment-content">
                <div class="comment-header">
                  <span class="comment-author">{{if .User}}{{.User.DisplayName}}{{end}}</span>
                  <span class="comment-date">{{.CreatedAt.Format "Jan 2, 2006 at 3:04 PM"}}</span>
                </div>
                <div class="comment-text">{{.Content}}</div>
              </div>
            </div>
            {{end}}
          </div>
        </div>
      </div>

      <div class="card-sidebar">
        <div class="sidebar-section">
          <div class="sidebar-section-title">Add to card</div>
          <button class="sidebar-btn">
            <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
            Members
          </button>
          <button class="sidebar-btn">
            <svg viewBox="0 0 24 24"><path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/></svg>
            Labels
          </button>
          <button class="sidebar-btn">
            <svg viewBox="0 0 24 24"><path d="M9 11H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2zm2-7h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V9h14v11z"/></svg>
            Dates
          </button>
        </div>

        <div class="sidebar-section">
          <div class="sidebar-section-title">Actions</div>
          <button class="sidebar-btn">
            <svg viewBox="0 0 24 24"><path d="M19 19H5V5h7V3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2v-7h-2v7zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3h-7z"/></svg>
            Move
          </button>
          <button class="sidebar-btn" id="delete-card-btn">
            <svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
            Delete
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const cardId = '{{.Card.ID}}';
const cardKey = '{{.Card.Key}}';
const workspaceSlug = '{{.Workspace.Slug}}';
const boardId = '{{.Board.ID}}';

// Auto-resize title textarea
const titleInput = document.getElementById('card-title');
titleInput.style.height = 'auto';
titleInput.style.height = titleInput.scrollHeight + 'px';
titleInput.addEventListener('input', function() {
  this.style.height = 'auto';
  this.style.height = this.scrollHeight + 'px';
});

// Save title on blur
titleInput.addEventListener('blur', async function() {
  const title = this.value.trim();
  if (!title) return;

  try {
    await fetch('/api/v1/issues/' + cardKey, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ title })
    });
  } catch (err) {
    console.error('Failed to update title:', err);
  }
});

// Description edit toggle
const descView = document.getElementById('description-view');
const descEdit = document.getElementById('description-edit');
const descInput = document.getElementById('description-input');

descView.addEventListener('click', function() {
  descView.style.display = 'none';
  descEdit.style.display = 'block';
  descInput.focus();
});

document.getElementById('cancel-description').addEventListener('click', function() {
  descEdit.style.display = 'none';
  descView.style.display = 'block';
  descInput.value = '{{.Card.Description}}';
});

document.getElementById('save-description').addEventListener('click', async function() {
  const description = descInput.value;

  try {
    await fetch('/api/v1/issues/' + cardKey, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ description })
    });
    window.location.reload();
  } catch (err) {
    alert('Failed to save description: ' + err.message);
  }
});

// Add comment
const commentInput = document.getElementById('comment-input');
commentInput.addEventListener('keypress', async function(e) {
  if (e.key === 'Enter') {
    const content = this.value.trim();
    if (!content) return;

    try {
      const res = await fetch('/api/v1/issues/' + cardId + '/comments', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ content })
      });
      const data = await res.json();
      if (data.success) {
        window.location.reload();
      } else {
        alert(data.error || 'Failed to add comment');
      }
    } catch (err) {
      alert('Failed to add comment: ' + err.message);
    }
  }
});

// Delete card
document.getElementById('delete-card-btn').addEventListener('click', async function() {
  if (!confirm('Are you sure you want to delete this card?')) return;

  try {
    const res = await fetch('/api/v1/issues/' + cardKey, {
      method: 'DELETE'
    });
    const data = await res.json();
    if (data.success) {
      window.location.href = '/t/' + workspaceSlug + '/b/' + boardId;
    } else {
      alert(data.error || 'Failed to delete card');
    }
  } catch (err) {
    alert('Failed to delete card: ' + err.message);
  }
});
</script>
{{end}}
