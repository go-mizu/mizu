{{define "content"}}
<!-- Create Issue Box -->
<div class="inbox-create-box">
  <div class="create-box-header">
    <div class="dropdown" id="header-project-dropdown">
      <button type="button" class="create-box-project dropdown-trigger" aria-haspopup="true" aria-expanded="false">
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <rect width="6" height="14" x="4" y="5" rx="2"/>
          <rect width="6" height="10" x="14" y="7" rx="2"/>
        </svg>
        <span id="selected-project-name">{{if .DefaultProject}}{{.DefaultProject.Name}}{{else}}Select Project{{end}}</span>
        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="dropdown-chevron" aria-hidden="true">
          <path d="m6 9 6 6 6-6"/>
        </svg>
      </button>
      <div class="dropdown-menu property-dropdown hidden">
        {{range .Projects}}
        <button type="button" class="dropdown-item header-project-option" data-project-id="{{.ID}}" data-project-name="{{.Name}}" data-project-key="{{.Key}}">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect width="6" height="14" x="4" y="5" rx="2"/>
            <rect width="6" height="10" x="14" y="7" rx="2"/>
          </svg>
          <span>{{.Name}}</span>
          <span class="text-muted text-xs ml-auto">{{.Key}}</span>
        </button>
        {{else}}
        <div class="dropdown-item text-muted">No projects available</div>
        {{end}}
      </div>
    </div>
    <span class="breadcrumb-separator">/</span>
    <span class="text-muted">New issue</span>
  </div>

  <form class="create-issue-form" id="inbox-create-form" data-default-project="{{.DefaultProjectID}}">
    <input
      type="text"
      name="title"
      class="create-box-title"
      placeholder="Issue title"
      autocomplete="off"
      required
    >
    <textarea
      name="description"
      class="create-box-description"
      placeholder="Add description..."
      rows="2"
    ></textarea>

    <div class="create-box-properties">
      <!-- Status Chip -->
      <div class="dropdown property-chip-dropdown" id="status-dropdown">
        <button type="button" class="property-chip dropdown-trigger" id="status-chip">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"/>
            <circle cx="12" cy="12" r="1"/>
          </svg>
          <span>Backlog</span>
        </button>
        <div class="dropdown-menu property-dropdown hidden">
          {{range .Columns}}
          <button type="button" class="dropdown-item status-option" data-column-id="{{.ID}}" data-column-name="{{.Name}}">
            <span class="status-badge {{lower .Name}}">
              {{if eq (lower .Name) "backlog"}}
              <svg class="status-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="8" cy="8" r="6" stroke-dasharray="2 2"/></svg>
              {{else if eq (lower .Name) "todo"}}
              <svg class="status-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="8" cy="8" r="6"/><circle cx="8" cy="8" r="1.5" fill="currentColor"/></svg>
              {{else if or (eq (lower .Name) "in-progress") (eq (lower .Name) "doing")}}
              <svg class="status-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="8" cy="8" r="6"/><path d="M8 2a6 6 0 0 1 6 6" stroke-width="2"/></svg>
              {{else if or (eq (lower .Name) "done") (eq (lower .Name) "completed")}}
              <svg class="status-icon" viewBox="0 0 16 16" fill="currentColor"><circle cx="8" cy="8" r="7"/><path d="M5.5 8l2 2 3.5-3.5" stroke="white" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>
              {{else if or (eq (lower .Name) "canceled") (eq (lower .Name) "cancelled")}}
              <svg class="status-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="8" cy="8" r="6"/><path d="M5.5 5.5l5 5M10.5 5.5l-5 5"/></svg>
              {{else}}
              <svg class="status-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="8" cy="8" r="6"/></svg>
              {{end}}
              {{.Name}}
            </span>
          </button>
          {{else}}
          <div class="dropdown-item text-muted">No statuses available</div>
          {{end}}
        </div>
      </div>

      <!-- Priority Chip -->
      <div class="dropdown property-chip-dropdown" id="priority-dropdown">
        <button type="button" class="property-chip dropdown-trigger" id="priority-chip">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M2 20h.01"/>
            <path d="M7 20v-4"/>
            <path d="M12 20v-8"/>
            <path d="M17 20V8"/>
          </svg>
          <span>Priority</span>
        </button>
        <div class="dropdown-menu property-dropdown hidden">
          <button type="button" class="dropdown-item priority-option" data-priority="0" data-priority-name="No priority">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="priority-icon priority-none">
              <line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
            <span>No priority</span>
          </button>
          <button type="button" class="dropdown-item priority-option" data-priority="1" data-priority-name="Urgent">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="priority-icon priority-urgent">
              <path d="M10.29 3.86 1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
              <line x1="12" y1="9" x2="12" y2="13"/>
              <line x1="12" y1="17" x2="12.01" y2="17"/>
            </svg>
            <span>Urgent</span>
          </button>
          <button type="button" class="dropdown-item priority-option" data-priority="2" data-priority-name="High">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="priority-icon priority-high">
              <path d="M2 20h.01"/><path d="M7 20v-4"/><path d="M12 20v-8"/><path d="M17 20V8"/><path d="M22 4v16"/>
            </svg>
            <span>High</span>
          </button>
          <button type="button" class="dropdown-item priority-option" data-priority="3" data-priority-name="Medium">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="priority-icon priority-medium">
              <path d="M2 20h.01"/><path d="M7 20v-4"/><path d="M12 20v-8"/>
            </svg>
            <span>Medium</span>
          </button>
          <button type="button" class="dropdown-item priority-option" data-priority="4" data-priority-name="Low">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="priority-icon priority-low">
              <path d="M2 20h.01"/><path d="M7 20v-4"/>
            </svg>
            <span>Low</span>
          </button>
        </div>
      </div>

      <!-- Assignee Chip -->
      <div class="dropdown property-chip-dropdown" id="assignee-dropdown">
        <button type="button" class="property-chip dropdown-trigger" id="assignee-chip">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/>
            <circle cx="12" cy="7" r="4"/>
          </svg>
          <span>Assignee</span>
        </button>
        <div class="dropdown-menu property-dropdown hidden">
          <button type="button" class="dropdown-item assignee-option" data-assignee-id="" data-assignee-name="Unassigned">
            <span class="avatar avatar-sm" style="background: hsl(var(--muted)); color: hsl(var(--muted-foreground));">-</span>
            <span>Unassigned</span>
          </button>
          {{range .TeamMembers}}
          <button type="button" class="dropdown-item assignee-option" data-assignee-id="{{.ID}}" data-assignee-name="{{.DisplayName}}">
            <span class="avatar avatar-sm">{{slice .DisplayName 0 1}}</span>
            <span>{{.DisplayName}}</span>
          </button>
          {{else}}
          <div class="dropdown-item text-muted">No team members</div>
          {{end}}
        </div>
      </div>

      <!-- Sprint/Cycle Chip -->
      <div class="dropdown property-chip-dropdown" id="cycle-dropdown">
        <button type="button" class="property-chip dropdown-trigger" id="cycle-chip">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M10 2h4"/>
            <path d="M12 14v-4"/>
            <path d="M4 13a8 8 0 0 1 8-7 8 8 0 1 1-5.3 14L4 17.6"/>
            <path d="M9 17H4v5"/>
          </svg>
          <span>Sprint</span>
        </button>
        <div class="dropdown-menu property-dropdown hidden">
          <button type="button" class="dropdown-item cycle-option" data-cycle-id="" data-cycle-name="No sprint">
            <span class="text-muted">No sprint</span>
          </button>
          {{range .Cycles}}
          <button type="button" class="dropdown-item cycle-option" data-cycle-id="{{.ID}}" data-cycle-name="{{.Name}}">
            <span class="status-badge {{.Status}}">{{.Name}}</span>
          </button>
          {{else}}
          <div class="dropdown-item text-muted">No sprints available</div>
          {{end}}
        </div>
      </div>
    </div>

    <div class="create-box-footer">
      <div></div>
      <button type="submit" class="btn btn-primary">
        Create issue
      </button>
    </div>

    <!-- Hidden fields for selected values -->
    <input type="hidden" name="project_id" id="selected-project-id" value="{{.DefaultProjectID}}">
    <input type="hidden" name="column_id" id="selected-column-id" value="">
    <input type="hidden" name="cycle_id" id="selected-cycle-id" value="">
    <input type="hidden" name="assignee_id" id="selected-assignee-id" value="">
    <input type="hidden" name="priority" id="selected-priority" value="0">
  </form>
</div>

<!-- Tabs -->
<div class="inbox-tabs" role="tablist" aria-label="Issue filters">
  <a href="/w/{{.Workspace.Slug}}/inbox?tab=assigned" class="inbox-tab {{if eq .ActiveTab "assigned"}}is-active{{end}}" role="tab" aria-selected="{{if eq .ActiveTab "assigned"}}true{{else}}false{{end}}">
    Assigned to me
    {{if .AssignedCount}}<span class="tab-count">{{.AssignedCount}}</span>{{end}}
  </a>
  <a href="/w/{{.Workspace.Slug}}/inbox?tab=created" class="inbox-tab {{if eq .ActiveTab "created"}}is-active{{end}}" role="tab" aria-selected="{{if eq .ActiveTab "created"}}true{{else}}false{{end}}">
    Created by me
    {{if .CreatedCount}}<span class="tab-count">{{.CreatedCount}}</span>{{end}}
  </a>
  <a href="/w/{{.Workspace.Slug}}/inbox?tab=all" class="inbox-tab {{if eq .ActiveTab "all"}}is-active{{end}}" role="tab" aria-selected="{{if eq .ActiveTab "all"}}true{{else}}false{{end}}">
    All issues
  </a>
</div>

<!-- Issue List -->
{{if .IssueGroups}}
{{range .IssueGroups}}
{{if .Issues}}
<div class="issue-group">
  <div class="group-header">{{.Label}}</div>
  {{range .Issues}}
  <a href="/w/{{$.Workspace.Slug}}/issue/{{.Key}}" class="inbox-issue">
    <div class="issue-row">
      <span class="issue-key">{{.Key}}</span>
      <span class="issue-title">{{.Title}}</span>
      <div class="issue-meta">
        {{if .Column}}
        <span class="status-badge {{lower .Column.Name}}">{{.Column.Name}}</span>
        {{end}}
        {{if .Project}}
        <span class="issue-project">{{.Project.Name}}</span>
        {{end}}
        <span class="issue-date">{{.UpdatedAt.Format "Jan 2"}}</span>
      </div>
    </div>
  </a>
  {{end}}
</div>
{{end}}
{{end}}
{{else}}
<div class="empty-state card">
  <svg class="empty-state-icon" xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <polyline points="22 12 16 12 14 15 10 15 8 12 2 12"/>
    <path d="M5.45 5.11 2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"/>
  </svg>
  <div class="empty-state-title">Your inbox is empty</div>
  <div class="empty-state-description">
    {{if eq .ActiveTab "assigned"}}
    No issues are assigned to you yet.
    {{else if eq .ActiveTab "created"}}
    You haven't created any issues yet.
    {{else}}
    No issues found in this workspace.
    {{end}}
  </div>
</div>
{{end}}

<script>
const workspaceSlug = '{{.Workspace.Slug}}';

// Inbox create form
const inboxForm = {
  selectedProjectId: '{{.DefaultProjectID}}',
  selectedColumnId: '',
  selectedCycleId: '',
  selectedAssigneeId: '',
  selectedPriority: 0,

  init() {
    this.setupForm();
    this.setupDropdowns();
  },

  setupForm() {
    const form = document.getElementById('inbox-create-form');
    if (!form) return;

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      // Validate project ID
      if (!this.selectedProjectId) {
        alert('Please select a project first');
        return;
      }

      const title = form.title.value.trim();
      if (!title) {
        alert('Please enter a title');
        form.title.focus();
        return;
      }

      const data = {
        title: title,
        description: form.description?.value?.trim() || '',
      };

      if (this.selectedColumnId) {
        data.column_id = this.selectedColumnId;
      }
      if (this.selectedCycleId) {
        data.cycle_id = this.selectedCycleId;
      }
      if (this.selectedPriority > 0) {
        data.priority = this.selectedPriority;
      }

      const submitBtn = form.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Creating...';

      try {
        const issue = await app.api.post(`/projects/${this.selectedProjectId}/issues`, data);

        // Add assignee if selected
        if (this.selectedAssigneeId) {
          try {
            await app.api.post(`/issues/${issue.id}/assignees`, { user_id: this.selectedAssigneeId });
          } catch (assigneeError) {
            console.warn('Failed to add assignee:', assigneeError);
          }
        }

        // Navigate to the newly created issue
        location.href = `/w/${workspaceSlug}/issue/${issue.key}`;
      } catch (error) {
        alert(error.message || 'Failed to create issue');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Create issue';
      }
    });
  },

  resetSelections() {
    this.selectedColumnId = '';
    this.selectedCycleId = '';
    this.selectedAssigneeId = '';
    this.selectedPriority = 0;

    document.getElementById('selected-column-id').value = '';
    document.getElementById('selected-cycle-id').value = '';
    document.getElementById('selected-assignee-id').value = '';
    document.getElementById('selected-priority').value = '0';

    document.querySelector('#status-chip span').textContent = 'Backlog';
    document.querySelector('#priority-chip span').textContent = 'Priority';
    document.querySelector('#assignee-chip span').textContent = 'Assignee';
    document.querySelector('#cycle-chip span').textContent = 'Sprint';

    document.querySelectorAll('.property-chip').forEach(c => c.classList.remove('selected'));
  },

  setupDropdowns() {
    // Header project options
    document.querySelectorAll('.header-project-option').forEach(opt => {
      opt.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        this.selectedProjectId = opt.dataset.projectId;
        document.getElementById('selected-project-id').value = this.selectedProjectId;
        document.getElementById('selected-project-name').textContent = opt.dataset.projectName;
        const projectChip = document.querySelector('#project-chip span');
        if (projectChip) projectChip.textContent = opt.dataset.projectKey;
        this.closeDropdown('header-project-dropdown');
      });
    });

    // Status options
    document.querySelectorAll('.status-option').forEach(opt => {
      opt.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        this.selectedColumnId = opt.dataset.columnId;
        document.getElementById('selected-column-id').value = this.selectedColumnId;
        document.querySelector('#status-chip span').textContent = opt.dataset.columnName;
        document.getElementById('status-chip').classList.add('selected');
        this.closeDropdown('status-dropdown');
      });
    });

    // Assignee options
    document.querySelectorAll('.assignee-option').forEach(opt => {
      opt.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        this.selectedAssigneeId = opt.dataset.assigneeId;
        document.getElementById('selected-assignee-id').value = this.selectedAssigneeId;
        document.querySelector('#assignee-chip span').textContent = opt.dataset.assigneeName;
        if (this.selectedAssigneeId) {
          document.getElementById('assignee-chip').classList.add('selected');
        } else {
          document.getElementById('assignee-chip').classList.remove('selected');
        }
        this.closeDropdown('assignee-dropdown');
      });
    });

    // Cycle options
    document.querySelectorAll('.cycle-option').forEach(opt => {
      opt.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        this.selectedCycleId = opt.dataset.cycleId;
        document.getElementById('selected-cycle-id').value = this.selectedCycleId;
        document.querySelector('#cycle-chip span').textContent = opt.dataset.cycleName;
        if (this.selectedCycleId) {
          document.getElementById('cycle-chip').classList.add('selected');
        } else {
          document.getElementById('cycle-chip').classList.remove('selected');
        }
        this.closeDropdown('cycle-dropdown');
      });
    });

    // Priority options
    document.querySelectorAll('.priority-option').forEach(opt => {
      opt.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        this.selectedPriority = parseInt(opt.dataset.priority);
        document.getElementById('selected-priority').value = this.selectedPriority;
        const priorityName = opt.dataset.priorityName;
        const chipSpan = document.querySelector('#priority-chip span');

        if (chipSpan) {
          chipSpan.textContent = this.selectedPriority === 0 ? 'Priority' : priorityName;
        }
        if (this.selectedPriority > 0) {
          document.getElementById('priority-chip')?.classList.add('selected');
        } else {
          document.getElementById('priority-chip')?.classList.remove('selected');
        }
        this.closeDropdown('priority-dropdown');
      });
    });
  },

  closeDropdown(id) {
    const dropdown = document.getElementById(id);
    if (dropdown) {
      const menu = dropdown.querySelector('.dropdown-menu');
      if (menu) menu.classList.add('hidden');
    }
  }
};

// Toast notification
function showToast(message) {
  const toast = document.createElement('div');
  toast.className = 'toast-notification';
  toast.textContent = message;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}

inboxForm.init();
</script>
{{end}}
