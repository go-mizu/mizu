{{define "content"}}
<div class="flex items-center justify-between mb-6">
  <div>
    <h1 class="text-2xl font-semibold text-zinc-900">Workspace Settings</h1>
    <p class="text-sm text-zinc-500 mt-1">Manage workspace configuration and members</p>
  </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 max-w-4xl">
  <!-- General Settings -->
  <div class="bg-white rounded-lg shadow-sm border border-zinc-200">
    <div class="px-5 py-4 border-b border-zinc-100">
      <h3 class="font-semibold text-zinc-900">General</h3>
    </div>
    <div class="p-5">
      <form id="workspace-settings-form" class="space-y-4">
        <div>
          <label for="workspace-name" class="block text-sm font-medium text-zinc-700 mb-1">Workspace Name</label>
          <input type="text" id="workspace-name" name="name" class="w-full px-3 py-2 text-sm border border-zinc-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent" value="{{.Workspace.Name}}" required>
        </div>
        <div>
          <label for="workspace-slug" class="block text-sm font-medium text-zinc-700 mb-1">Workspace Slug</label>
          <input type="text" id="workspace-slug" name="slug" class="w-full px-3 py-2 text-sm border border-zinc-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent" value="{{.Workspace.Slug}}" required pattern="[a-z0-9-]+">
          <span class="text-xs text-zinc-400 mt-1">URL-friendly identifier (lowercase letters, numbers, hyphens only)</span>
        </div>
        <div class="flex justify-end">
          <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700 transition-colors">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Danger Zone -->
  <div class="bg-white rounded-lg shadow-sm border border-red-200">
    <div class="px-5 py-4 border-b border-red-100">
      <h3 class="font-semibold text-red-600">Danger Zone</h3>
    </div>
    <div class="p-5">
      <p class="text-sm text-zinc-500 mb-4">
        Once you delete a workspace, there is no going back. Please be certain.
      </p>
      <button class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700 transition-colors" data-action="delete-workspace">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M3 6h18"/>
          <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
          <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
        </svg>
        Delete Workspace
      </button>
    </div>
  </div>
</div>

<!-- Members Section -->
<div class="mt-8 max-w-4xl">
  <div class="flex items-center justify-between mb-4">
    <h2 class="text-lg font-semibold text-zinc-900">Members</h2>
    <button class="inline-flex items-center gap-2 px-3 py-1.5 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700 transition-colors" data-modal="invite-member-modal">
      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
        <circle cx="9" cy="7" r="4"/>
        <line x1="19" x2="19" y1="8" y2="14"/>
        <line x1="22" x2="16" y1="11" y2="11"/>
      </svg>
      Invite Member
    </button>
  </div>

  <div class="space-y-2">
    {{range .Members}}
    <div class="flex items-center justify-between bg-white rounded-lg shadow-sm border border-zinc-200 px-4 py-3" data-member-id="{{.Member.ID}}">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-full bg-indigo-500 text-white text-sm flex items-center justify-center font-medium">{{slice .User.DisplayName 0 1}}</div>
        <div>
          <div class="font-medium text-zinc-900">{{.User.DisplayName}}</div>
          <div class="text-sm text-zinc-500">{{.User.Email}}</div>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <span class="px-2 py-1 text-xs font-medium rounded-full {{if eq .Member.Role "owner"}}bg-indigo-100 text-indigo-700{{else}}bg-zinc-100 text-zinc-600{{end}}">{{.Member.Role}}</span>
        {{if ne .Member.Role "owner"}}
        <div class="relative">
          <button class="inline-flex items-center justify-center w-7 h-7 text-zinc-400 hover:text-zinc-600 hover:bg-zinc-100 rounded transition-colors dropdown-trigger">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="1"/>
              <circle cx="12" cy="5" r="1"/>
              <circle cx="12" cy="19" r="1"/>
            </svg>
          </button>
          <div class="absolute right-0 top-full mt-1 w-36 bg-white rounded-lg shadow-lg border border-zinc-200 py-1 z-50 hidden dropdown-menu">
            <button class="flex items-center gap-2 w-full px-3 py-2 text-sm text-left text-zinc-700 hover:bg-zinc-50 transition-colors" data-action="change-role" data-member-id="{{.Member.ID}}" data-role="admin">
              Make Admin
            </button>
            <button class="flex items-center gap-2 w-full px-3 py-2 text-sm text-left text-zinc-700 hover:bg-zinc-50 transition-colors" data-action="change-role" data-member-id="{{.Member.ID}}" data-role="member">
              Make Member
            </button>
            <div class="my-1 border-t border-zinc-100"></div>
            <button class="flex items-center gap-2 w-full px-3 py-2 text-sm text-left text-red-600 hover:bg-red-50 transition-colors" data-action="remove-member" data-member-id="{{.Member.ID}}">
              Remove
            </button>
          </div>
        </div>
        {{end}}
      </div>
    </div>
    {{else}}
    <div class="flex flex-col items-center justify-center py-12 px-8 text-center bg-white rounded-lg shadow-sm border border-zinc-200">
      <svg class="w-10 h-10 mb-4 text-zinc-300" xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
        <circle cx="9" cy="7" r="4"/>
        <path d="M22 21v-2a4 4 0 0 0-3-3.87"/>
        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
      </svg>
      <div class="text-base font-semibold mb-1 text-zinc-900">No members yet</div>
      <div class="text-sm text-zinc-500">Invite team members to collaborate on this workspace</div>
    </div>
    {{end}}
  </div>
</div>

<!-- Invite Member Modal -->
<div id="invite-member-modal" class="fixed inset-0 z-50 hidden">
  <div class="fixed inset-0 bg-black/50" data-close="invite-member-modal"></div>
  <div class="fixed inset-0 flex items-center justify-center p-4">
    <div class="relative w-full max-w-md bg-white rounded-xl shadow-xl">
      <div class="flex items-center justify-between px-6 py-4 border-b border-zinc-200">
        <h2 class="text-lg font-semibold text-zinc-900">Invite Member</h2>
        <button class="text-zinc-400 hover:text-zinc-600 text-2xl transition-colors" data-close="invite-member-modal">&times;</button>
      </div>
      <form id="invite-member-form">
        <div class="px-6 py-4 space-y-4">
          <div>
            <label for="invite-email" class="block text-sm font-medium text-zinc-700 mb-1">Email Address</label>
            <input type="email" id="invite-email" name="email" class="w-full px-3 py-2 text-sm border border-zinc-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="colleague@example.com" required autofocus>
          </div>
          <div>
            <label for="invite-role" class="block text-sm font-medium text-zinc-700 mb-1">Role</label>
            <select id="invite-role" name="role" class="w-full px-3 py-2 text-sm border border-zinc-200 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
              <option value="member">Member</option>
              <option value="admin">Admin</option>
            </select>
          </div>
        </div>
        <div class="flex items-center justify-end gap-2 px-6 py-4 bg-zinc-50 rounded-b-xl border-t border-zinc-100">
          <button type="button" class="px-4 py-2 text-sm font-medium text-zinc-700 bg-white border border-zinc-200 rounded-md hover:bg-zinc-50 transition-colors" data-close="invite-member-modal">Cancel</button>
          <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700 transition-colors">Send Invite</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
document.getElementById('workspace-settings-form')?.addEventListener('submit', async (e) => {
  e.preventDefault();
  const form = e.target;

  const data = {
    name: form.name.value,
    slug: form.slug.value,
  };

  try {
    await app.api.patch('/workspaces/{{.Workspace.Slug}}', data);
    if (data.slug !== '{{.Workspace.Slug}}') {
      location.href = '/w/' + data.slug + '/settings';
    } else {
      alert('Settings saved successfully');
    }
  } catch (error) {
    alert(error.message || 'Failed to save settings');
  }
});

document.addEventListener('click', async (e) => {
  const action = e.target.closest('[data-action]');
  if (!action) return;

  const actionType = action.dataset.action;

  switch (actionType) {
    case 'delete-workspace':
      if (confirm('Are you sure you want to delete this workspace? This action cannot be undone.')) {
        try {
          await app.api.delete('/workspaces/{{.Workspace.Slug}}');
          location.href = '/app';
        } catch (error) {
          alert(error.message || 'Failed to delete workspace');
        }
      }
      break;

    case 'remove-member':
      const memberId = action.dataset.memberId;
      if (confirm('Are you sure you want to remove this member?')) {
        try {
          await app.api.delete('/workspaces/{{.Workspace.Slug}}/members/' + memberId);
          location.reload();
        } catch (error) {
          alert(error.message || 'Failed to remove member');
        }
      }
      break;

    case 'change-role':
      const memberIdToChange = action.dataset.memberId;
      const newRole = action.dataset.role;
      try {
        await app.api.patch('/workspaces/{{.Workspace.Slug}}/members/' + memberIdToChange, { role: newRole });
        location.reload();
      } catch (error) {
        alert(error.message || 'Failed to change role');
      }
      break;
  }
});

document.getElementById('invite-member-form')?.addEventListener('submit', async (e) => {
  e.preventDefault();
  const form = e.target;

  const data = {
    email: form.email.value,
    role: form.role.value,
  };

  try {
    await app.api.post('/workspaces/{{.Workspace.Slug}}/members', data);
    app.modals.close('invite-member-modal');
    location.reload();
  } catch (error) {
    alert(error.message || 'Failed to invite member');
  }
});
</script>
{{end}}
