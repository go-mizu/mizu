{{define "content"}}
<div class="flex items-center justify-between mb-6">
  <div>
    <h1 class="text-xl font-semibold">{{.Project.Name}}</h1>
    <p class="text-sm text-zinc-500">{{.Project.Key}} Board</p>
  </div>
  <div class="flex gap-2">
    <button class="inline-flex items-center gap-2 px-3 py-2 text-sm font-medium text-zinc-700 bg-white border border-zinc-300 hover:bg-zinc-50 rounded-md transition-colors" data-modal="add-column-modal" aria-label="Add new column">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <path d="M5 12h14"/>
        <path d="M12 5v14"/>
      </svg>
      Add Column
    </button>
    <button class="inline-flex items-center gap-2 px-3 py-2 text-sm font-medium text-white bg-zinc-900 hover:bg-zinc-800 rounded-md transition-colors" data-modal="create-issue-modal" aria-label="Create new issue">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <path d="M5 12h14"/>
        <path d="M12 5v14"/>
      </svg>
      New Issue
    </button>
  </div>
</div>

<!-- Kanban Board -->
<div id="board" class="flex gap-4 overflow-x-auto pb-4" data-project-id="{{.Project.ID}}">
  {{range .Columns}}
  <div class="board-column flex-shrink-0 w-72 bg-zinc-100 rounded-lg flex flex-col max-h-[calc(100vh-180px)]" data-column-id="{{.ID}}">
    <div class="column-header flex items-center justify-between px-3 py-2.5 border-b border-zinc-200">
      <div class="column-title flex items-center gap-2">
        <span class="font-medium text-sm">{{.Name}}</span>
        <span class="column-count text-xs text-zinc-500 bg-zinc-200 px-1.5 py-0.5 rounded-full">{{len .Issues}}</span>
      </div>
      <div class="column-actions flex items-center gap-1">
        <button class="w-7 h-7 flex items-center justify-center text-zinc-400 hover:text-zinc-600 hover:bg-zinc-200 rounded transition-colors column-add-btn" data-column-id="{{.ID}}" title="Add issue">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M5 12h14"/>
            <path d="M12 5v14"/>
          </svg>
        </button>
        <div class="dropdown relative">
          <button class="dropdown-trigger w-7 h-7 flex items-center justify-center text-zinc-400 hover:text-zinc-600 hover:bg-zinc-200 rounded transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="1"/>
              <circle cx="12" cy="5" r="1"/>
              <circle cx="12" cy="19" r="1"/>
            </svg>
          </button>
          <div class="dropdown-menu hidden absolute right-0 top-full mt-1 w-44 bg-white border border-zinc-200 rounded-md shadow-lg py-1 z-50">
            <button class="dropdown-item flex items-center gap-2 w-full px-3 py-2 text-sm text-left hover:bg-zinc-100" data-action="rename-column" data-column-id="{{.ID}}">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/>
              </svg>
              Rename
            </button>
            {{if not .IsDefault}}
            <button class="dropdown-item flex items-center gap-2 w-full px-3 py-2 text-sm text-left hover:bg-zinc-100" data-action="set-default" data-column-id="{{.ID}}">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
              </svg>
              Set as Default
            </button>
            {{end}}
            <div class="dropdown-divider border-t border-zinc-200 my-1"></div>
            <button class="dropdown-item destructive flex items-center gap-2 w-full px-3 py-2 text-sm text-left text-red-600 hover:bg-red-50" data-action="delete-column" data-column-id="{{.ID}}">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M3 6h18"/>
                <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
              </svg>
              Delete Column
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="column-body flex-1 overflow-y-auto p-2 space-y-2 scrollbar-thin">
      {{range .Issues}}
      <div class="issue-card bg-white rounded-md shadow-sm border border-zinc-200 p-3 cursor-pointer hover:shadow-md hover:-translate-y-0.5 transition-all" draggable="true" data-issue-id="{{.ID}}" data-issue-key="{{.Key}}" data-position="{{.Position}}">
        <div class="issue-card-header flex items-center justify-between mb-1">
          <span class="issue-key text-xs text-zinc-500 font-medium">{{.Key}}</span>
        </div>
        <div class="issue-card-title text-sm font-medium text-zinc-900 line-clamp-2">{{.Title}}</div>
        <div class="issue-card-meta flex items-center gap-2 mt-2">
          {{if gt .Priority 0}}
          <span class="card-priority flex items-center text-xs {{if eq .Priority 1}}text-red-500{{else if eq .Priority 2}}text-orange-500{{else if eq .Priority 3}}text-yellow-500{{else}}text-blue-500{{end}}" title="Priority">
            <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M2 20h.01"/><path d="M7 20v-4"/>{{if ge .Priority 3}}<path d="M12 20v-8"/>{{end}}{{if ge .Priority 2}}<path d="M17 20V8"/>{{end}}{{if eq .Priority 1}}<path d="M22 4v16"/>{{end}}
            </svg>
          </span>
          {{end}}
          {{if .DueDate}}
          <span class="card-due-date flex items-center gap-1 text-xs text-zinc-500" title="Due {{.DueDate.Format "Jan 2, 2006"}}">
            <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M8 2v4"/>
              <path d="M16 2v4"/>
              <rect width="18" height="18" x="3" y="4" rx="2"/>
              <path d="M3 10h18"/>
            </svg>
            {{.DueDate.Format "Jan 2"}}
          </span>
          {{end}}
        </div>
      </div>
      {{end}}
    </div>

    <div class="column-footer p-2 border-t border-zinc-200">
      <form class="quick-add-form flex items-center gap-2" data-column-id="{{.ID}}">
        <input type="text" class="flex-1 px-2 py-1.5 text-sm bg-transparent border-none outline-none placeholder-zinc-400" placeholder="Add issue..." name="title" aria-label="Quick add issue">
        <button type="submit" class="w-7 h-7 flex items-center justify-center text-zinc-400 hover:text-zinc-600 hover:bg-zinc-200 rounded transition-colors" aria-label="Add issue">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M5 12h14"/>
            <path d="M12 5v14"/>
          </svg>
        </button>
      </form>
    </div>
  </div>
  {{end}}

  <!-- Add Column Button -->
  <div class="flex-shrink-0 w-72 min-h-48 bg-transparent border-2 border-dashed border-zinc-300 rounded-lg cursor-pointer flex items-center justify-center hover:border-zinc-400 hover:bg-zinc-50 transition-colors" data-modal="add-column-modal">
    <div class="empty-state flex flex-col items-center gap-2 text-zinc-400 p-8">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M5 12h14"/>
        <path d="M12 5v14"/>
      </svg>
      <span class="text-sm">Add Column</span>
    </div>
  </div>
</div>

<!-- Create Issue Modal -->
<div id="create-issue-modal" class="modal hidden fixed inset-0 z-50">
  <div class="modal-backdrop absolute inset-0 bg-black/50 backdrop-blur-sm"></div>
  <div class="modal-content absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-xl bg-white rounded-lg shadow-xl">
    <div class="modal-header flex items-center justify-between px-4 py-3 border-b border-zinc-200">
      <div class="flex items-center gap-2">
        <span class="text-sm text-zinc-500">{{.Project.Key}}</span>
        <span class="text-zinc-300">/</span>
        <span class="font-medium">New issue</span>
      </div>
      <button class="modal-close w-8 h-8 flex items-center justify-center text-zinc-400 hover:text-zinc-600 hover:bg-zinc-100 rounded transition-colors">&times;</button>
    </div>
    <form id="create-issue-form" data-project-id="{{.Project.ID}}">
      <div class="modal-body p-4">
        <input type="text" id="issue-title" name="title" class="w-full text-lg font-medium border-none outline-none placeholder-zinc-400 mb-2" placeholder="Issue title" required autofocus>
        <textarea id="issue-description" name="description" class="w-full text-sm border-none outline-none resize-none placeholder-zinc-400 mb-4" placeholder="Add description..." rows="3"></textarea>

        <div class="create-box-properties flex flex-wrap gap-2">
          <button type="button" class="property-chip inline-flex items-center gap-1.5 px-2.5 py-1.5 text-sm bg-zinc-100 hover:bg-zinc-200 rounded-full transition-colors" id="modal-status-chip">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"/>
              <circle cx="12" cy="12" r="1"/>
            </svg>
            <span>Backlog</span>
          </button>
          <button type="button" class="property-chip inline-flex items-center gap-1.5 px-2.5 py-1.5 text-sm bg-zinc-100 hover:bg-zinc-200 rounded-full transition-colors" id="modal-priority-chip">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M2 20h.01"/>
              <path d="M7 20v-4"/>
              <path d="M12 20v-8"/>
              <path d="M17 20V8"/>
            </svg>
            <span>Priority</span>
          </button>
        </div>

        <input type="hidden" name="column_id" id="modal-column-id" value="">
        <input type="hidden" name="priority" id="modal-priority" value="0">
      </div>
      <div class="modal-footer flex items-center justify-between px-4 py-3 border-t border-zinc-200 bg-zinc-50 rounded-b-lg">
        <label class="create-more-toggle flex items-center gap-2 text-sm text-zinc-600 cursor-pointer">
          <input type="checkbox" id="create-more-checkbox" class="w-4 h-4 rounded border-zinc-300">
          Create more
        </label>
        <div class="flex gap-2">
          <button type="button" class="modal-close px-4 py-2 text-sm font-medium text-zinc-700 hover:bg-zinc-200 rounded-md transition-colors">Cancel</button>
          <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-zinc-900 hover:bg-zinc-800 rounded-md transition-colors">Create issue</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Modal Status Dropdown -->
<div id="modal-status-selector" class="property-dropdown hidden fixed min-w-48 bg-white border border-zinc-200 rounded-md shadow-lg py-1 z-50">
  {{range .Columns}}
  <button type="button" class="dropdown-item modal-status-option flex items-center gap-2 w-full px-3 py-2 text-sm text-left hover:bg-zinc-100" data-column-id="{{.ID}}" data-column-name="{{.Name}}">
    {{.Name}}
  </button>
  {{end}}
</div>

<!-- Modal Priority Dropdown -->
<div id="modal-priority-selector" class="property-dropdown hidden fixed min-w-48 bg-white border border-zinc-200 rounded-md shadow-lg py-1 z-50">
  <button type="button" class="dropdown-item modal-priority-option flex items-center gap-2 w-full px-3 py-2 text-sm text-left hover:bg-zinc-100" data-priority="0" data-priority-name="No priority">No priority</button>
  <button type="button" class="dropdown-item modal-priority-option flex items-center gap-2 w-full px-3 py-2 text-sm text-left hover:bg-zinc-100" data-priority="1" data-priority-name="Urgent"><span class="text-red-500">Urgent</span></button>
  <button type="button" class="dropdown-item modal-priority-option flex items-center gap-2 w-full px-3 py-2 text-sm text-left hover:bg-zinc-100" data-priority="2" data-priority-name="High"><span class="text-orange-500">High</span></button>
  <button type="button" class="dropdown-item modal-priority-option flex items-center gap-2 w-full px-3 py-2 text-sm text-left hover:bg-zinc-100" data-priority="3" data-priority-name="Medium"><span class="text-yellow-500">Medium</span></button>
  <button type="button" class="dropdown-item modal-priority-option flex items-center gap-2 w-full px-3 py-2 text-sm text-left hover:bg-zinc-100" data-priority="4" data-priority-name="Low"><span class="text-blue-500">Low</span></button>
</div>

<!-- Add Column Modal -->
<div id="add-column-modal" class="modal hidden fixed inset-0 z-50" role="dialog" aria-modal="true" aria-labelledby="add-column-title">
  <div class="modal-backdrop absolute inset-0 bg-black/50 backdrop-blur-sm"></div>
  <div class="modal-content absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-md bg-white rounded-lg shadow-xl">
    <div class="modal-header flex items-center justify-between px-4 py-3 border-b border-zinc-200">
      <h2 id="add-column-title" class="modal-title font-medium">Add Column</h2>
      <button class="modal-close w-8 h-8 flex items-center justify-center text-zinc-400 hover:text-zinc-600 hover:bg-zinc-100 rounded transition-colors" aria-label="Close modal">&times;</button>
    </div>
    <form id="add-column-form" data-project-id="{{.Project.ID}}">
      <div class="modal-body p-4">
        <div class="form-group mb-4">
          <label for="column-name" class="block text-sm font-medium text-zinc-700 mb-1">Column Name</label>
          <input type="text" id="column-name" name="name" class="w-full px-3 py-2 text-sm border border-zinc-300 rounded-md focus:outline-none focus:ring-2 focus:ring-zinc-900 focus:border-transparent" placeholder="e.g., In Review" required autofocus>
        </div>
      </div>
      <div class="modal-footer flex items-center justify-end gap-2 px-4 py-3 border-t border-zinc-200 bg-zinc-50 rounded-b-lg">
        <button type="button" class="modal-close px-4 py-2 text-sm font-medium text-zinc-700 hover:bg-zinc-200 rounded-md transition-colors">Cancel</button>
        <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-zinc-900 hover:bg-zinc-800 rounded-md transition-colors">Add Column</button>
      </div>
    </form>
  </div>
</div>

<!-- Rename Column Modal -->
<div id="rename-column-modal" class="modal hidden fixed inset-0 z-50" role="dialog" aria-modal="true" aria-labelledby="rename-column-title">
  <div class="modal-backdrop absolute inset-0 bg-black/50 backdrop-blur-sm"></div>
  <div class="modal-content absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-md bg-white rounded-lg shadow-xl">
    <div class="modal-header flex items-center justify-between px-4 py-3 border-b border-zinc-200">
      <h2 id="rename-column-title" class="modal-title font-medium">Rename Column</h2>
      <button class="modal-close w-8 h-8 flex items-center justify-center text-zinc-400 hover:text-zinc-600 hover:bg-zinc-100 rounded transition-colors" aria-label="Close modal">&times;</button>
    </div>
    <form id="rename-column-form">
      <div class="modal-body p-4">
        <div class="form-group mb-4">
          <label for="rename-column-name" class="block text-sm font-medium text-zinc-700 mb-1">Column Name</label>
          <input type="text" id="rename-column-name" name="name" class="w-full px-3 py-2 text-sm border border-zinc-300 rounded-md focus:outline-none focus:ring-2 focus:ring-zinc-900 focus:border-transparent" placeholder="Column name" required autofocus>
        </div>
      </div>
      <div class="modal-footer flex items-center justify-end gap-2 px-4 py-3 border-t border-zinc-200 bg-zinc-50 rounded-b-lg">
        <button type="button" class="modal-close px-4 py-2 text-sm font-medium text-zinc-700 hover:bg-zinc-200 rounded-md transition-colors">Cancel</button>
        <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-zinc-900 hover:bg-zinc-800 rounded-md transition-colors">Rename</button>
      </div>
    </form>
  </div>
</div>

<script>
let columnToRename = null;

document.addEventListener('click', async (e) => {
  const action = e.target.closest('[data-action]');
  if (!action) return;

  const actionType = action.dataset.action;
  const columnId = action.dataset.columnId;
  const issueKey = action.dataset.issueKey;

  switch (actionType) {
    case 'rename-column':
      columnToRename = columnId;
      const column = document.querySelector(`.board-column[data-column-id="${columnId}"]`);
      const currentName = column?.querySelector('.column-title span:first-child')?.textContent || '';
      document.getElementById('rename-column-name').value = currentName;
      app.modals.open('rename-column-modal');
      break;

    case 'delete-column':
      if (confirm('Are you sure you want to delete this column? Issues will be moved to the default column.')) {
        try {
          await app.api.delete(`/columns/${columnId}`);
          location.reload();
        } catch (error) {
          alert(error.message || 'Failed to delete column');
        }
      }
      break;

    case 'set-default':
      try {
        await app.api.post(`/projects/{{.Project.ID}}/columns/${columnId}/default`);
        location.reload();
      } catch (error) {
        alert(error.message || 'Failed to set default column');
      }
      break;

    case 'open-issue':
      location.href = `/w/{{.Workspace.Slug}}/issue/${issueKey}`;
      break;

    case 'delete-issue':
      if (confirm('Are you sure you want to delete this issue?')) {
        try {
          await app.api.delete(`/issues/${issueKey}`);
          const card = document.querySelector(`[data-issue-key="${issueKey}"]`);
          if (card) card.remove();
          app.kanban.updateColumnCounts();
        } catch (error) {
          alert(error.message || 'Failed to delete issue');
        }
      }
      break;
  }
});

document.getElementById('rename-column-form')?.addEventListener('submit', async (e) => {
  e.preventDefault();
  if (!columnToRename) return;

  const newName = document.getElementById('rename-column-name').value.trim();
  if (!newName) return;

  try {
    await app.api.patch(`/columns/${columnToRename}`, { name: newName });
    app.modals.close('rename-column-modal');
    const column = document.querySelector(`.board-column[data-column-id="${columnToRename}"]`);
    const nameSpan = column?.querySelector('.column-title span:first-child');
    if (nameSpan) nameSpan.textContent = newName;
    columnToRename = null;
  } catch (error) {
    alert(error.message || 'Failed to rename column');
  }
});

document.querySelectorAll('.quick-add-form').forEach(form => {
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const input = form.querySelector('input[name="title"]');
    const title = input.value.trim();
    if (!title) return;

    const columnId = form.dataset.columnId;

    try {
      const issue = await app.api.post(`/projects/{{.Project.ID}}/issues`, {
        title,
        column_id: columnId,
      });

      const column = form.closest('.board-column');
      const columnBody = column.querySelector('.column-body');

      const card = document.createElement('div');
      card.className = 'issue-card bg-white rounded-md shadow-sm border border-zinc-200 p-3 cursor-pointer hover:shadow-md hover:-translate-y-0.5 transition-all';
      card.draggable = true;
      card.dataset.issueId = issue.id;
      card.dataset.issueKey = issue.key;
      card.innerHTML = `
        <div class="issue-card-header flex items-center justify-between mb-1">
          <span class="issue-key text-xs text-zinc-500 font-medium">${issue.key}</span>
        </div>
        <div class="issue-card-title text-sm font-medium text-zinc-900 line-clamp-2">${title}</div>
        <div class="issue-card-meta flex items-center gap-2 mt-2"></div>
      `;
      columnBody.appendChild(card);

      input.value = '';
      app.kanban.updateColumnCounts();
    } catch (error) {
      alert(error.message || 'Failed to create issue');
    }
  });
});

const modalForm = {
  selectedColumnId: '',
  selectedPriority: 0,

  init() {
    this.setupChips();
    this.setupDropdowns();
    this.setupForm();
  },

  setupChips() {
    document.getElementById('modal-status-chip')?.addEventListener('click', (e) => {
      e.preventDefault();
      this.showDropdown('modal-status-selector', e.currentTarget);
    });
    document.getElementById('modal-priority-chip')?.addEventListener('click', (e) => {
      e.preventDefault();
      this.showDropdown('modal-priority-selector', e.currentTarget);
    });
  },

  setupDropdowns() {
    document.querySelectorAll('.modal-status-option').forEach(opt => {
      opt.addEventListener('click', () => {
        this.selectedColumnId = opt.dataset.columnId;
        document.getElementById('modal-column-id').value = this.selectedColumnId;
        document.querySelector('#modal-status-chip span').textContent = opt.dataset.columnName;
        document.getElementById('modal-status-chip').classList.add('bg-zinc-200');
        this.hideAllDropdowns();
      });
    });

    document.querySelectorAll('.modal-priority-option').forEach(opt => {
      opt.addEventListener('click', () => {
        this.selectedPriority = parseInt(opt.dataset.priority);
        document.getElementById('modal-priority').value = this.selectedPriority;
        const chipSpan = document.querySelector('#modal-priority-chip span');
        if (chipSpan) {
          chipSpan.textContent = this.selectedPriority === 0 ? 'Priority' : opt.dataset.priorityName;
        }
        if (this.selectedPriority > 0) {
          document.getElementById('modal-priority-chip')?.classList.add('bg-zinc-200');
        } else {
          document.getElementById('modal-priority-chip')?.classList.remove('bg-zinc-200');
        }
        this.hideAllDropdowns();
      });
    });

    document.addEventListener('click', (e) => {
      if (!e.target.closest('.property-chip') && !e.target.closest('.property-dropdown')) {
        this.hideAllDropdowns();
      }
    });
  },

  setupForm() {
    const form = document.getElementById('create-issue-form');
    if (!form) return;

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const title = form.title.value.trim();
      if (!title) return;

      const data = {
        title,
        description: form.description?.value?.trim() || '',
      };

      if (this.selectedColumnId) {
        data.column_id = this.selectedColumnId;
      }
      if (this.selectedPriority > 0) {
        data.priority = this.selectedPriority;
      }

      const submitBtn = form.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Creating...';

      try {
        const issue = await app.api.post(`/projects/{{.Project.ID}}/issues`, data);

        const createMore = document.getElementById('create-more-checkbox')?.checked;
        if (createMore) {
          form.reset();
          this.selectedColumnId = '';
          this.selectedPriority = 0;
          document.querySelector('#modal-status-chip span').textContent = 'Backlog';
          document.querySelector('#modal-priority-chip span').textContent = 'Priority';
          document.querySelectorAll('.property-chip').forEach(c => c.classList.remove('bg-zinc-200'));
          location.reload();
        } else {
          location.href = `/w/{{.Workspace.Slug}}/issue/${issue.key}`;
        }
      } catch (error) {
        alert(error.message || 'Failed to create issue');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Create issue';
      }
    });
  },

  showDropdown(id, anchor) {
    this.hideAllDropdowns();
    const dropdown = document.getElementById(id);
    if (!dropdown) return;

    const rect = anchor.getBoundingClientRect();
    dropdown.style.top = `${rect.bottom + 4}px`;
    dropdown.style.left = `${rect.left}px`;
    dropdown.style.minWidth = '200px';
    dropdown.classList.remove('hidden');
  },

  hideAllDropdowns() {
    document.querySelectorAll('.property-dropdown').forEach(d => d.classList.add('hidden'));
  }
};

modalForm.init();

document.querySelectorAll('.column-add-btn').forEach(btn => {
  btn.addEventListener('click', (e) => {
    e.stopPropagation();
    const columnId = btn.dataset.columnId;
    const column = document.querySelector(`.board-column[data-column-id="${columnId}"]`);
    const input = column?.querySelector('.quick-add-form input');
    if (input) {
      input.focus();
      input.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  });
});

document.querySelectorAll('.issue-card').forEach(card => {
  card.addEventListener('click', (e) => {
    if (e.target.closest('.dropdown')) return;
    const key = card.dataset.issueKey;
    if (key) {
      location.href = `/w/{{.Workspace.Slug}}/issue/${key}`;
    }
  });
});
</script>
{{end}}
