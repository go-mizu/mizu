{{define "content"}}
<style>
  /* Drag and drop styles */
  .issue-card.dragging {
    opacity: 0.4;
    cursor: grabbing;
  }
  .issue-card {
    cursor: grab;
  }
  .column-body.drag-over {
    background: rgba(0, 0, 0, 0.02);
    border-radius: 8px;
  }
  .drop-placeholder {
    background: rgba(24, 24, 27, 0.08);
    border-radius: 8px;
    margin-bottom: 8px;
    border: 2px dashed #d4d4d8;
    transition: height 0.15s ease;
  }
</style>

<div class="flex items-center justify-between mb-6">
  <div class="flex items-center gap-4">
    <h1 class="text-2xl font-semibold text-zinc-900">{{.Project.Name}}</h1>
    <div class="flex items-center bg-zinc-100 rounded-lg p-1" role="group" aria-label="View options">
      <a href="/w/{{.Workspace.Slug}}/issues?view=list" class="flex items-center justify-center w-8 h-8 rounded-md text-zinc-500 hover:text-zinc-900 hover:bg-white transition-colors" aria-label="List view">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <line x1="8" x2="21" y1="6" y2="6"/>
          <line x1="8" x2="21" y1="12" y2="12"/>
          <line x1="8" x2="21" y1="18" y2="18"/>
          <line x1="3" x2="3.01" y1="6" y2="6"/>
          <line x1="3" x2="3.01" y1="12" y2="12"/>
          <line x1="3" x2="3.01" y1="18" y2="18"/>
        </svg>
      </a>
      <span class="flex items-center justify-center w-8 h-8 rounded-md bg-white shadow-sm text-zinc-900" aria-label="Board view" aria-current="page">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <rect width="6" height="14" x="4" y="5"/>
          <rect width="6" height="10" x="14" y="7"/>
        </svg>
      </span>
      <a href="/w/{{.Workspace.Slug}}/issues?view=calendar" class="flex items-center justify-center w-8 h-8 rounded-md text-zinc-500 hover:text-zinc-900 hover:bg-white transition-colors" aria-label="Calendar view">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <path d="M8 2v4"/>
          <path d="M16 2v4"/>
          <rect width="18" height="18" x="3" y="4"/>
          <path d="M3 10h18"/>
        </svg>
      </a>
      <a href="/w/{{.Workspace.Slug}}/issues?view=gantt" class="flex items-center justify-center w-8 h-8 rounded-md text-zinc-500 hover:text-zinc-900 hover:bg-white transition-colors" aria-label="Gantt chart view">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <path d="M3 3v18h18"/>
          <rect x="7" y="6" width="10" height="3"/>
          <rect x="5" y="12" width="8" height="3"/>
          <rect x="9" y="18" width="6" height="3"/>
        </svg>
      </a>
    </div>
  </div>
  <p class="text-sm text-zinc-500">{{.Project.Key}} Board</p>
</div>

<!-- Kanban Board -->
<div id="board" class="flex gap-6 overflow-x-auto pb-4" data-project-id="{{.Project.ID}}">
  {{range .Columns}}
  <div class="board-column flex-shrink-0 w-72 flex flex-col" data-column-id="{{.ID}}">
    <div class="column-header flex items-center gap-2 px-1 py-2 mb-3">
      <!-- Status Icon -->
      <span class="{{if eq (lower .Name) "done"}}text-green-600{{else if or (eq (lower .Name) "in-progress") (eq (lower .Name) "doing")}}text-blue-600{{else if eq (lower .Name) "todo"}}text-zinc-600{{else}}text-zinc-400{{end}}">
        {{if eq (lower .Name) "backlog"}}
        <svg class="w-4 h-4" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="8" cy="8" r="6" stroke-dasharray="2 2"/></svg>
        {{else if eq (lower .Name) "todo"}}
        <svg class="w-4 h-4" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="8" cy="8" r="6"/><circle cx="8" cy="8" r="1.5" fill="currentColor"/></svg>
        {{else if or (eq (lower .Name) "in-progress") (eq (lower .Name) "doing")}}
        <svg class="w-4 h-4" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="8" cy="8" r="6"/><path d="M8 2a6 6 0 0 1 6 6" stroke-width="2"/></svg>
        {{else if or (eq (lower .Name) "done") (eq (lower .Name) "completed")}}
        <svg class="w-4 h-4" viewBox="0 0 16 16" fill="currentColor"><circle cx="8" cy="8" r="7"/><path d="M5.5 8l2 2 3.5-3.5" stroke="white" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>
        {{else if or (eq (lower .Name) "canceled") (eq (lower .Name) "cancelled")}}
        <svg class="w-4 h-4" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="8" cy="8" r="6"/><path d="M5.5 5.5l5 5M10.5 5.5l-5 5"/></svg>
        {{else}}
        <svg class="w-4 h-4" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="8" cy="8" r="6"/></svg>
        {{end}}
      </span>
      <span class="font-medium text-sm text-zinc-700">{{.Name}}</span>
      <span class="column-count text-xs text-zinc-400">{{len .Issues}}</span>
    </div>

    <div class="column-body flex-1 space-y-2 min-h-[100px] p-1 -m-1" data-column-id="{{.ID}}">
      {{range .Issues}}
      <div class="issue-card block bg-white rounded-lg border border-zinc-200 p-3 hover:border-zinc-300 hover:shadow-sm transition-all" data-issue-id="{{.ID}}" data-issue-key="{{.Key}}" data-position="{{.Position}}">
        <div class="flex items-start gap-2 mb-2">
          <!-- Priority indicator -->
          <div class="w-4 flex-shrink-0 mt-0.5">
            {{if eq .Priority 1}}
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-500" title="Urgent">
              <path d="M10.29 3.86 1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
              <line x1="12" y1="9" x2="12" y2="13"/>
              <line x1="12" y1="17" x2="12.01" y2="17"/>
            </svg>
            {{else if eq .Priority 2}}
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 16 16" class="text-orange-500" title="High"><rect x="2" y="2" width="3" height="12" fill="currentColor"/><rect x="6.5" y="5" width="3" height="9" fill="currentColor"/><rect x="11" y="8" width="3" height="6" fill="currentColor"/></svg>
            {{else if eq .Priority 3}}
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 16 16" class="text-yellow-500" title="Medium"><rect x="2" y="5" width="3" height="9" fill="currentColor"/><rect x="6.5" y="8" width="3" height="6" fill="currentColor"/></svg>
            {{else if eq .Priority 4}}
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 16 16" class="text-blue-500" title="Low"><rect x="2" y="8" width="3" height="6" fill="currentColor"/></svg>
            {{else}}
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-zinc-300"><line x1="5" y1="12" x2="19" y2="12"/></svg>
            {{end}}
          </div>
          <div class="flex-1 min-w-0">
            <div class="issue-card-title text-sm font-medium text-zinc-900 line-clamp-2">{{.Title}}</div>
          </div>
        </div>
        <div class="flex items-center justify-between text-xs">
          <span class="font-medium text-zinc-400 font-mono">{{.Key}}</span>
          <div class="flex items-center gap-2">
            {{if .DueDate}}
            <span class="flex items-center gap-1 text-zinc-400" title="Due {{.DueDate.Format "Jan 2, 2006"}}">
              <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M8 2v4"/>
                <path d="M16 2v4"/>
                <rect width="18" height="18" x="3" y="4" rx="2"/>
                <path d="M3 10h18"/>
              </svg>
              {{.DueDate.Format "Jan 2"}}
            </span>
            {{end}}
          </div>
        </div>
      </div>
      {{end}}
    </div>
  </div>
  {{end}}
</div>

<!-- Create Issue Modal -->
<div id="create-issue-modal" class="modal hidden fixed inset-0 z-50">
  <div class="modal-backdrop absolute inset-0 bg-black/50 backdrop-blur-sm"></div>
  <div class="modal-content absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-xl bg-white rounded-lg shadow-xl">
    <div class="modal-header flex items-center justify-between px-4 py-3 border-b border-zinc-200">
      <div class="flex items-center gap-2">
        <span class="text-sm text-zinc-500">{{.Project.Key}}</span>
        <span class="text-zinc-300">/</span>
        <span class="font-medium">New issue</span>
      </div>
      <button class="modal-close w-8 h-8 flex items-center justify-center text-zinc-400 hover:text-zinc-600 hover:bg-zinc-100 rounded transition-colors">&times;</button>
    </div>
    <form id="create-issue-form" data-project-id="{{.Project.ID}}">
      <div class="modal-body p-4">
        <input type="text" id="issue-title" name="title" class="w-full text-lg font-medium border-none outline-none placeholder-zinc-400 mb-2" placeholder="Issue title" required autofocus>
        <textarea id="issue-description" name="description" class="w-full text-sm border-none outline-none resize-none placeholder-zinc-400 mb-4" placeholder="Add description..." rows="3"></textarea>

        <div class="create-box-properties flex flex-wrap gap-2">
          <button type="button" class="property-chip inline-flex items-center gap-1.5 px-2.5 py-1.5 text-sm bg-zinc-100 hover:bg-zinc-200 rounded-full transition-colors" id="modal-status-chip">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"/>
              <circle cx="12" cy="12" r="1"/>
            </svg>
            <span>Backlog</span>
          </button>
          <button type="button" class="property-chip inline-flex items-center gap-1.5 px-2.5 py-1.5 text-sm bg-zinc-100 hover:bg-zinc-200 rounded-full transition-colors" id="modal-priority-chip">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M2 20h.01"/>
              <path d="M7 20v-4"/>
              <path d="M12 20v-8"/>
              <path d="M17 20V8"/>
            </svg>
            <span>Priority</span>
          </button>
        </div>

        <input type="hidden" name="column_id" id="modal-column-id" value="">
        <input type="hidden" name="priority" id="modal-priority" value="0">
      </div>
      <div class="modal-footer flex items-center justify-between px-4 py-3 border-t border-zinc-200 bg-zinc-50 rounded-b-lg">
        <label class="create-more-toggle flex items-center gap-2 text-sm text-zinc-600 cursor-pointer">
          <input type="checkbox" id="create-more-checkbox" class="w-4 h-4 rounded border-zinc-300">
          Create more
        </label>
        <div class="flex gap-2">
          <button type="button" class="modal-close px-4 py-2 text-sm font-medium text-zinc-700 hover:bg-zinc-200 rounded-md transition-colors">Cancel</button>
          <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-zinc-900 hover:bg-zinc-800 rounded-md transition-colors">Create issue</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Modal Status Dropdown -->
<div id="modal-status-selector" class="property-dropdown hidden fixed min-w-48 bg-white border border-zinc-200 rounded-md shadow-lg py-1 z-50">
  {{range .Columns}}
  <button type="button" class="dropdown-item modal-status-option flex items-center gap-2 w-full px-3 py-2 text-sm text-left hover:bg-zinc-100" data-column-id="{{.ID}}" data-column-name="{{.Name}}">
    {{.Name}}
  </button>
  {{end}}
</div>

<!-- Modal Priority Dropdown -->
<div id="modal-priority-selector" class="property-dropdown hidden fixed min-w-48 bg-white border border-zinc-200 rounded-md shadow-lg py-1 z-50">
  <button type="button" class="dropdown-item modal-priority-option flex items-center gap-2 w-full px-3 py-2 text-sm text-left hover:bg-zinc-100" data-priority="0" data-priority-name="No priority">No priority</button>
  <button type="button" class="dropdown-item modal-priority-option flex items-center gap-2 w-full px-3 py-2 text-sm text-left hover:bg-zinc-100" data-priority="1" data-priority-name="Urgent"><span class="text-red-500">Urgent</span></button>
  <button type="button" class="dropdown-item modal-priority-option flex items-center gap-2 w-full px-3 py-2 text-sm text-left hover:bg-zinc-100" data-priority="2" data-priority-name="High"><span class="text-orange-500">High</span></button>
  <button type="button" class="dropdown-item modal-priority-option flex items-center gap-2 w-full px-3 py-2 text-sm text-left hover:bg-zinc-100" data-priority="3" data-priority-name="Medium"><span class="text-yellow-500">Medium</span></button>
  <button type="button" class="dropdown-item modal-priority-option flex items-center gap-2 w-full px-3 py-2 text-sm text-left hover:bg-zinc-100" data-priority="4" data-priority-name="Low"><span class="text-blue-500">Low</span></button>
</div>

<!-- Add Column Modal -->
<div id="add-column-modal" class="modal hidden fixed inset-0 z-50" role="dialog" aria-modal="true" aria-labelledby="add-column-title">
  <div class="modal-backdrop absolute inset-0 bg-black/50 backdrop-blur-sm"></div>
  <div class="modal-content absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-md bg-white rounded-lg shadow-xl">
    <div class="modal-header flex items-center justify-between px-4 py-3 border-b border-zinc-200">
      <h2 id="add-column-title" class="modal-title font-medium">Add Column</h2>
      <button class="modal-close w-8 h-8 flex items-center justify-center text-zinc-400 hover:text-zinc-600 hover:bg-zinc-100 rounded transition-colors" aria-label="Close modal">&times;</button>
    </div>
    <form id="add-column-form" data-project-id="{{.Project.ID}}">
      <div class="modal-body p-4">
        <div class="form-group mb-4">
          <label for="column-name" class="block text-sm font-medium text-zinc-700 mb-1">Column Name</label>
          <input type="text" id="column-name" name="name" class="w-full px-3 py-2 text-sm border border-zinc-300 rounded-md focus:outline-none focus:ring-2 focus:ring-zinc-900 focus:border-transparent" placeholder="e.g., In Review" required autofocus>
        </div>
      </div>
      <div class="modal-footer flex items-center justify-end gap-2 px-4 py-3 border-t border-zinc-200 bg-zinc-50 rounded-b-lg">
        <button type="button" class="modal-close px-4 py-2 text-sm font-medium text-zinc-700 hover:bg-zinc-200 rounded-md transition-colors">Cancel</button>
        <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-zinc-900 hover:bg-zinc-800 rounded-md transition-colors">Add Column</button>
      </div>
    </form>
  </div>
</div>

<!-- Rename Column Modal -->
<div id="rename-column-modal" class="modal hidden fixed inset-0 z-50" role="dialog" aria-modal="true" aria-labelledby="rename-column-title">
  <div class="modal-backdrop absolute inset-0 bg-black/50 backdrop-blur-sm"></div>
  <div class="modal-content absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-md bg-white rounded-lg shadow-xl">
    <div class="modal-header flex items-center justify-between px-4 py-3 border-b border-zinc-200">
      <h2 id="rename-column-title" class="modal-title font-medium">Rename Column</h2>
      <button class="modal-close w-8 h-8 flex items-center justify-center text-zinc-400 hover:text-zinc-600 hover:bg-zinc-100 rounded transition-colors" aria-label="Close modal">&times;</button>
    </div>
    <form id="rename-column-form">
      <div class="modal-body p-4">
        <div class="form-group mb-4">
          <label for="rename-column-name" class="block text-sm font-medium text-zinc-700 mb-1">Column Name</label>
          <input type="text" id="rename-column-name" name="name" class="w-full px-3 py-2 text-sm border border-zinc-300 rounded-md focus:outline-none focus:ring-2 focus:ring-zinc-900 focus:border-transparent" placeholder="Column name" required autofocus>
        </div>
      </div>
      <div class="modal-footer flex items-center justify-end gap-2 px-4 py-3 border-t border-zinc-200 bg-zinc-50 rounded-b-lg">
        <button type="button" class="modal-close px-4 py-2 text-sm font-medium text-zinc-700 hover:bg-zinc-200 rounded-md transition-colors">Cancel</button>
        <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-zinc-900 hover:bg-zinc-800 rounded-md transition-colors">Rename</button>
      </div>
    </form>
  </div>
</div>

<script>
// ==========================================
// DRAG AND DROP
// ==========================================
let draggedCard = null;
let draggedCardHeight = 40;
let dragStartColumn = null;
let currentPlaceholder = null;
let lastTargetContainer = null;
let lastAfterElement = null;

function createPlaceholder(height) {
  const placeholder = document.createElement('div');
  placeholder.className = 'drop-placeholder';
  placeholder.style.height = height + 'px';
  return placeholder;
}

function removePlaceholder() {
  if (currentPlaceholder && currentPlaceholder.parentNode) {
    currentPlaceholder.parentNode.removeChild(currentPlaceholder);
  }
  currentPlaceholder = null;
}

function getDragAfterElement(container, y) {
  const draggableElements = [...container.querySelectorAll('.issue-card:not(.dragging)')];

  return draggableElements.reduce((closest, child) => {
    const box = child.getBoundingClientRect();
    const offset = y - box.top - box.height / 2;

    if (offset < 0 && offset > closest.offset) {
      return { offset: offset, element: child };
    } else {
      return closest;
    }
  }, { offset: Number.NEGATIVE_INFINITY }).element;
}

function updateColumnCounts() {
  document.querySelectorAll('.board-column').forEach(column => {
    const count = column.querySelectorAll('.issue-card').length;
    const countEl = column.querySelector('.column-count');
    if (countEl) countEl.textContent = count;
  });
}

function initDragAndDrop() {
  document.querySelectorAll('.issue-card').forEach(card => {
    card.setAttribute('draggable', 'true');

    card.addEventListener('dragstart', (e) => {
      draggedCard = card;
      draggedCardHeight = card.offsetHeight;
      dragStartColumn = card.closest('.column-body');

      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', card.dataset.issueKey);

      requestAnimationFrame(() => {
        card.classList.add('dragging');
      });
    });

    card.addEventListener('dragend', (e) => {
      card.classList.remove('dragging');
      document.querySelectorAll('.column-body.drag-over').forEach(el => {
        el.classList.remove('drag-over');
      });
      removePlaceholder();

      draggedCard = null;
      dragStartColumn = null;
      lastTargetContainer = null;
      lastAfterElement = null;
    });

    // Click to navigate
    card.addEventListener('click', (e) => {
      if (card.dataset.wasDragged === 'true') {
        card.dataset.wasDragged = '';
        return;
      }
      const key = card.dataset.issueKey;
      if (key) {
        location.href = `/w/{{.Workspace.Slug}}/issue/${key}`;
      }
    });
  });

  document.querySelectorAll('.column-body').forEach(container => {
    container.addEventListener('dragover', (e) => {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';

      if (!draggedCard) return;

      const afterElement = getDragAfterElement(container, e.clientY);

      if (container === lastTargetContainer && afterElement === lastAfterElement) {
        return;
      }

      lastTargetContainer = container;
      lastAfterElement = afterElement;

      document.querySelectorAll('.column-body.drag-over').forEach(el => {
        if (el !== container) el.classList.remove('drag-over');
      });
      container.classList.add('drag-over');

      removePlaceholder();
      currentPlaceholder = createPlaceholder(draggedCardHeight);

      if (afterElement) {
        container.insertBefore(currentPlaceholder, afterElement);
      } else {
        container.appendChild(currentPlaceholder);
      }
    });

    container.addEventListener('dragleave', (e) => {
      const rect = container.getBoundingClientRect();
      const x = e.clientX;
      const y = e.clientY;

      if (x < rect.left || x > rect.right || y < rect.top || y > rect.bottom) {
        container.classList.remove('drag-over');
        if (lastTargetContainer === container) {
          removePlaceholder();
          lastTargetContainer = null;
          lastAfterElement = null;
        }
      }
    });

    container.addEventListener('drop', async (e) => {
      e.preventDefault();
      container.classList.remove('drag-over');

      const cardKey = e.dataTransfer.getData('text/plain');

      const insertBeforeElement = currentPlaceholder ? currentPlaceholder.nextElementSibling : null;
      removePlaceholder();

      if (!draggedCard || !cardKey) return;

      draggedCard.classList.remove('dragging');

      if (insertBeforeElement) {
        container.insertBefore(draggedCard, insertBeforeElement);
      } else {
        container.appendChild(draggedCard);
      }

      draggedCard.dataset.wasDragged = 'true';

      const newColumnId = container.dataset.columnId;
      const oldColumnId = dragStartColumn ? dragStartColumn.dataset.columnId : null;

      updateColumnCounts();

      if (newColumnId !== oldColumnId) {
        try {
          const res = await fetch('/api/v1/issues/' + cardKey + '/move', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ column_id: newColumnId })
          });
          const data = await res.json();
          if (!data.success) {
            console.error('Failed to move card:', data.error);
            window.location.reload();
          }
        } catch (err) {
          console.error('Failed to move card:', err);
          window.location.reload();
        }
      }
    });
  });
}

initDragAndDrop();

// ==========================================
// MODAL FORM
// ==========================================
const modalForm = {
  selectedColumnId: '',
  selectedPriority: 0,

  init() {
    this.setupChips();
    this.setupDropdowns();
    this.setupForm();
  },

  setupChips() {
    document.getElementById('modal-status-chip')?.addEventListener('click', (e) => {
      e.preventDefault();
      this.showDropdown('modal-status-selector', e.currentTarget);
    });
    document.getElementById('modal-priority-chip')?.addEventListener('click', (e) => {
      e.preventDefault();
      this.showDropdown('modal-priority-selector', e.currentTarget);
    });
  },

  setupDropdowns() {
    document.querySelectorAll('.modal-status-option').forEach(opt => {
      opt.addEventListener('click', () => {
        this.selectedColumnId = opt.dataset.columnId;
        document.getElementById('modal-column-id').value = this.selectedColumnId;
        document.querySelector('#modal-status-chip span').textContent = opt.dataset.columnName;
        document.getElementById('modal-status-chip').classList.add('bg-zinc-200');
        this.hideAllDropdowns();
      });
    });

    document.querySelectorAll('.modal-priority-option').forEach(opt => {
      opt.addEventListener('click', () => {
        this.selectedPriority = parseInt(opt.dataset.priority);
        document.getElementById('modal-priority').value = this.selectedPriority;
        const chipSpan = document.querySelector('#modal-priority-chip span');
        if (chipSpan) {
          chipSpan.textContent = this.selectedPriority === 0 ? 'Priority' : opt.dataset.priorityName;
        }
        if (this.selectedPriority > 0) {
          document.getElementById('modal-priority-chip')?.classList.add('bg-zinc-200');
        } else {
          document.getElementById('modal-priority-chip')?.classList.remove('bg-zinc-200');
        }
        this.hideAllDropdowns();
      });
    });

    document.addEventListener('click', (e) => {
      if (!e.target.closest('.property-chip') && !e.target.closest('.property-dropdown')) {
        this.hideAllDropdowns();
      }
    });
  },

  setupForm() {
    const form = document.getElementById('create-issue-form');
    if (!form) return;

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const title = form.title.value.trim();
      if (!title) return;

      const data = {
        title,
        description: form.description?.value?.trim() || '',
      };

      if (this.selectedColumnId) {
        data.column_id = this.selectedColumnId;
      }
      if (this.selectedPriority > 0) {
        data.priority = this.selectedPriority;
      }

      const submitBtn = form.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Creating...';

      try {
        const issue = await app.api.post(`/projects/{{.Project.ID}}/issues`, data);

        const createMore = document.getElementById('create-more-checkbox')?.checked;
        if (createMore) {
          form.reset();
          this.selectedColumnId = '';
          this.selectedPriority = 0;
          document.querySelector('#modal-status-chip span').textContent = 'Backlog';
          document.querySelector('#modal-priority-chip span').textContent = 'Priority';
          document.querySelectorAll('.property-chip').forEach(c => c.classList.remove('bg-zinc-200'));
          location.reload();
        } else {
          location.href = `/w/{{.Workspace.Slug}}/issue/${issue.key}`;
        }
      } catch (error) {
        alert(error.message || 'Failed to create issue');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Create issue';
      }
    });
  },

  showDropdown(id, anchor) {
    this.hideAllDropdowns();
    const dropdown = document.getElementById(id);
    if (!dropdown) return;

    const rect = anchor.getBoundingClientRect();
    dropdown.style.top = `${rect.bottom + 4}px`;
    dropdown.style.left = `${rect.left}px`;
    dropdown.style.minWidth = '200px';
    dropdown.classList.remove('hidden');
  },

  hideAllDropdowns() {
    document.querySelectorAll('.property-dropdown').forEach(d => d.classList.add('hidden'));
  }
};

modalForm.init();
</script>
{{end}}
