{{define "content"}}
<div class="mb-4">
  <a href="/w/{{.Workspace.Slug}}/issues" class="inline-flex items-center justify-center w-8 h-8 text-zinc-500 hover:text-zinc-900 hover:bg-zinc-100 rounded-md transition-colors" aria-label="Back to issues list">
    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <path d="m12 19-7-7 7-7"/>
      <path d="M19 12H5"/>
    </svg>
  </a>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
  <!-- Main Content -->
  <div class="lg:col-span-2 space-y-6">
    <div class="bg-white rounded-lg shadow-sm border border-zinc-200 p-6">
      <div class="flex items-center gap-2 mb-3">
        <span class="px-2 py-1 text-xs font-semibold text-zinc-500 bg-zinc-100 rounded font-mono">{{.Issue.Key}}</span>
        <button class="inline-flex items-center justify-center w-7 h-7 text-zinc-400 hover:text-zinc-600 hover:bg-zinc-100 rounded transition-colors copy-link-btn" data-action="copy-link" title="Copy link">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="copy-icon">
            <rect width="14" height="14" x="8" y="8" rx="2" ry="2"/>
            <path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/>
          </svg>
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="check-icon hidden">
            <polyline points="20 6 9 17 4 12"/>
          </svg>
        </button>
      </div>
      <h1
        id="issue-title"
        class="text-xl font-semibold text-zinc-900 outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 rounded px-1 -mx-1"
        contenteditable="true"
        data-issue-key="{{.Issue.Key}}"
        data-field="title"
      >{{.Issue.Title}}</h1>
    </div>

    <!-- Description -->
    <div class="bg-white rounded-lg shadow-sm border border-zinc-200 p-6">
      <h3 class="text-sm font-medium text-zinc-500 mb-3">Description</h3>
      <div
        id="issue-description"
        class="text-sm text-zinc-700 min-h-[60px] outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 rounded px-1 -mx-1"
        contenteditable="true"
        data-issue-key="{{.Issue.Key}}"
        data-field="description"
      >{{if .Issue.Description}}{{.Issue.Description}}{{else}}<span class="text-zinc-400">Add a description...</span>{{end}}</div>
    </div>

    <!-- Activity / Comments -->
    <div class="bg-white rounded-lg shadow-sm border border-zinc-200 p-6">
      <h3 class="text-sm font-medium text-zinc-900 mb-4">Activity</h3>

      <!-- Comments List -->
      <div class="space-y-4 mb-6">
        {{range .Comments}}
        <div class="flex gap-3">
          <div class="w-8 h-8 rounded-full bg-indigo-500 text-white text-sm flex items-center justify-center font-medium flex-shrink-0">{{slice .Author.DisplayName 0 1}}</div>
          <div class="flex-1 min-w-0">
            <div class="flex items-center gap-2 mb-1">
              <span class="text-sm font-medium text-zinc-900">{{.Author.DisplayName}}</span>
              <span class="text-xs text-zinc-400">{{.CreatedAt.Format "Jan 2, 2006"}}</span>
            </div>
            <div class="text-sm text-zinc-700">{{.Content}}</div>
          </div>
        </div>
        {{else}}
        <p class="text-sm text-zinc-400 mb-4">No activity yet</p>
        {{end}}
      </div>

      <!-- Comment Form -->
      <form class="flex gap-3" data-issue-id="{{.Issue.ID}}">
        <div class="w-8 h-8 rounded-full bg-indigo-500 text-white text-sm flex items-center justify-center font-medium flex-shrink-0">{{slice .User.DisplayName 0 1}}</div>
        <div class="flex-1 flex gap-2">
          <textarea
            name="body"
            class="flex-1 px-3 py-2 text-sm border border-zinc-200 rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
            placeholder="Write a comment..."
            rows="1"
            aria-label="Write a comment"
          ></textarea>
          <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 transition-colors">Send</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Sidebar -->
  <div class="space-y-0 bg-white rounded-lg shadow-sm border border-zinc-200 divide-y divide-zinc-100">
    <!-- Status -->
    <div class="p-4">
      <div class="text-xs font-semibold uppercase tracking-wide text-zinc-400 mb-2">Status</div>
      <div class="relative" id="status-dropdown-wrapper">
        <button class="flex items-center justify-between w-full px-3 py-2 text-sm text-zinc-900 bg-zinc-50 hover:bg-zinc-100 rounded-lg cursor-pointer transition-colors dropdown-trigger" id="status-trigger" data-issue-key="{{.Issue.Key}}">
          <span class="flex items-center gap-2" id="current-status">
            {{range .Columns}}{{if eq .ID $.Issue.ColumnID}}
            <span class="inline-flex items-center gap-1.5 {{if eq (lower .Name) "done"}}text-green-600{{else if eq (lower .Name) "in-progress"}}text-blue-600{{else if eq (lower .Name) "todo"}}text-zinc-600{{else}}text-zinc-500{{end}}">
              {{if eq (lower .Name) "backlog"}}
              <svg class="w-4 h-4" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="8" cy="8" r="6" stroke-dasharray="2 2"/></svg>
              {{else if eq (lower .Name) "todo"}}
              <svg class="w-4 h-4" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="8" cy="8" r="6"/><circle cx="8" cy="8" r="1.5" fill="currentColor"/></svg>
              {{else if or (eq (lower .Name) "in-progress") (eq (lower .Name) "doing")}}
              <svg class="w-4 h-4" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="8" cy="8" r="6"/><path d="M8 2a6 6 0 0 1 6 6" stroke-width="2"/></svg>
              {{else if or (eq (lower .Name) "done") (eq (lower .Name) "completed")}}
              <svg class="w-4 h-4" viewBox="0 0 16 16" fill="currentColor"><circle cx="8" cy="8" r="7"/><path d="M5.5 8l2 2 3.5-3.5" stroke="white" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>
              {{else if or (eq (lower .Name) "canceled") (eq (lower .Name) "cancelled")}}
              <svg class="w-4 h-4" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="8" cy="8" r="6"/><path d="M5.5 5.5l5 5M10.5 5.5l-5 5"/></svg>
              {{else}}
              <svg class="w-4 h-4" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="8" cy="8" r="6"/></svg>
              {{end}}
              {{.Name}}
            </span>
            {{end}}{{end}}
          </span>
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-zinc-400">
            <path d="m6 9 6 6 6-6"/>
          </svg>
        </button>
        <div class="absolute left-0 right-0 top-full mt-1 bg-white rounded-lg shadow-lg border border-zinc-200 py-1 z-50 hidden dropdown-menu">
          {{range .Columns}}
          <button class="flex items-center gap-2 w-full px-3 py-2 text-sm text-left hover:bg-zinc-50 transition-colors issue-status-option {{if eq .ID $.Issue.ColumnID}}bg-zinc-50{{end}}" data-column-id="{{.ID}}" data-column-name="{{.Name}}">
            <span class="inline-flex items-center gap-1.5 {{if eq (lower .Name) "done"}}text-green-600{{else if eq (lower .Name) "in-progress"}}text-blue-600{{else if eq (lower .Name) "todo"}}text-zinc-600{{else}}text-zinc-500{{end}}">
              {{if eq (lower .Name) "backlog"}}
              <svg class="w-4 h-4" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="8" cy="8" r="6" stroke-dasharray="2 2"/></svg>
              {{else if eq (lower .Name) "todo"}}
              <svg class="w-4 h-4" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="8" cy="8" r="6"/><circle cx="8" cy="8" r="1.5" fill="currentColor"/></svg>
              {{else if or (eq (lower .Name) "in-progress") (eq (lower .Name) "doing")}}
              <svg class="w-4 h-4" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="8" cy="8" r="6"/><path d="M8 2a6 6 0 0 1 6 6" stroke-width="2"/></svg>
              {{else if or (eq (lower .Name) "done") (eq (lower .Name) "completed")}}
              <svg class="w-4 h-4" viewBox="0 0 16 16" fill="currentColor"><circle cx="8" cy="8" r="7"/><path d="M5.5 8l2 2 3.5-3.5" stroke="white" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>
              {{else if or (eq (lower .Name) "canceled") (eq (lower .Name) "cancelled")}}
              <svg class="w-4 h-4" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="8" cy="8" r="6"/><path d="M5.5 5.5l5 5M10.5 5.5l-5 5"/></svg>
              {{else}}
              <svg class="w-4 h-4" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="8" cy="8" r="6"/></svg>
              {{end}}
              {{.Name}}
            </span>
          </button>
          {{end}}
        </div>
      </div>
    </div>

    <!-- Priority -->
    <div class="p-4">
      <div class="text-xs font-semibold uppercase tracking-wide text-zinc-400 mb-2">Priority</div>
      <div class="relative" id="priority-dropdown-wrapper">
        <button class="flex items-center justify-between w-full px-3 py-2 text-sm text-zinc-900 bg-zinc-50 hover:bg-zinc-100 rounded-lg cursor-pointer transition-colors dropdown-trigger" id="priority-trigger" data-issue-key="{{.Issue.Key}}">
          <span class="flex items-center gap-2" id="current-priority">
            {{if eq .Issue.Priority 0}}
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-zinc-400"><line x1="5" y1="12" x2="19" y2="12"/></svg>
            <span>No priority</span>
            {{else if eq .Issue.Priority 1}}
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-500"><path d="M2 20h.01"/><path d="M7 20v-4"/><path d="M12 20v-8"/><path d="M17 20V8"/><path d="M22 4v16"/></svg>
            <span>Urgent</span>
            {{else if eq .Issue.Priority 2}}
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-orange-500"><path d="M2 20h.01"/><path d="M7 20v-4"/><path d="M12 20v-8"/><path d="M17 20V8"/></svg>
            <span>High</span>
            {{else if eq .Issue.Priority 3}}
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-yellow-500"><path d="M2 20h.01"/><path d="M7 20v-4"/><path d="M12 20v-8"/></svg>
            <span>Medium</span>
            {{else if eq .Issue.Priority 4}}
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-500"><path d="M2 20h.01"/><path d="M7 20v-4"/></svg>
            <span>Low</span>
            {{end}}
          </span>
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-zinc-400">
            <path d="m6 9 6 6 6-6"/>
          </svg>
        </button>
        <div class="absolute left-0 right-0 top-full mt-1 bg-white rounded-lg shadow-lg border border-zinc-200 py-1 z-50 hidden dropdown-menu">
          <button class="flex items-center gap-2 w-full px-3 py-2 text-sm text-left hover:bg-zinc-50 transition-colors issue-priority-option {{if eq .Issue.Priority 0}}bg-zinc-50{{end}}" data-priority="0" data-priority-name="No priority">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-zinc-400"><line x1="5" y1="12" x2="19" y2="12"/></svg>
            <span>No priority</span>
          </button>
          <button class="flex items-center gap-2 w-full px-3 py-2 text-sm text-left hover:bg-zinc-50 transition-colors issue-priority-option {{if eq .Issue.Priority 1}}bg-zinc-50{{end}}" data-priority="1" data-priority-name="Urgent">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-500"><path d="M2 20h.01"/><path d="M7 20v-4"/><path d="M12 20v-8"/><path d="M17 20V8"/><path d="M22 4v16"/></svg>
            <span>Urgent</span>
          </button>
          <button class="flex items-center gap-2 w-full px-3 py-2 text-sm text-left hover:bg-zinc-50 transition-colors issue-priority-option {{if eq .Issue.Priority 2}}bg-zinc-50{{end}}" data-priority="2" data-priority-name="High">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-orange-500"><path d="M2 20h.01"/><path d="M7 20v-4"/><path d="M12 20v-8"/><path d="M17 20V8"/></svg>
            <span>High</span>
          </button>
          <button class="flex items-center gap-2 w-full px-3 py-2 text-sm text-left hover:bg-zinc-50 transition-colors issue-priority-option {{if eq .Issue.Priority 3}}bg-zinc-50{{end}}" data-priority="3" data-priority-name="Medium">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-yellow-500"><path d="M2 20h.01"/><path d="M7 20v-4"/><path d="M12 20v-8"/></svg>
            <span>Medium</span>
          </button>
          <button class="flex items-center gap-2 w-full px-3 py-2 text-sm text-left hover:bg-zinc-50 transition-colors issue-priority-option {{if eq .Issue.Priority 4}}bg-zinc-50{{end}}" data-priority="4" data-priority-name="Low">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-500"><path d="M2 20h.01"/><path d="M7 20v-4"/></svg>
            <span>Low</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Sprint (Cycle) -->
    <div class="p-4">
      <div class="text-xs font-semibold uppercase tracking-wide text-zinc-400 mb-2">Sprint</div>
      <div class="relative" id="cycle-dropdown">
        <button class="flex items-center justify-between w-full px-3 py-2 text-sm text-zinc-900 bg-zinc-50 hover:bg-zinc-100 rounded-lg cursor-pointer transition-colors dropdown-trigger" data-issue-key="{{.Issue.Key}}">
          <span class="flex items-center gap-2">
            {{if .Issue.CycleID}}
              {{range .Cycles}}{{if eq .ID $.Issue.CycleID}}
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-500">
                  <path d="M10 2h4"/><path d="M12 14v-4"/><path d="M4 13a8 8 0 0 1 8-7 8 8 0 1 1-5.3 14L4 17.6"/><path d="M9 17H4v5"/>
                </svg>
                <span>{{.Name}}</span>
              {{end}}{{end}}
            {{else}}
              <span class="text-zinc-400">No sprint</span>
            {{end}}
          </span>
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-zinc-400">
            <path d="m6 9 6 6 6-6"/>
          </svg>
        </button>
        <div class="absolute left-0 right-0 top-full mt-1 bg-white rounded-lg shadow-lg border border-zinc-200 py-1 z-50 hidden dropdown-menu">
          <button class="flex items-center gap-2 w-full px-3 py-2 text-sm text-left hover:bg-zinc-50 transition-colors" data-action="set-cycle" data-cycle-id="">
            <span class="text-zinc-400">No sprint</span>
          </button>
          {{range .Cycles}}
          <button class="flex items-center gap-2 w-full px-3 py-2 text-sm text-left hover:bg-zinc-50 transition-colors {{if eq .ID $.Issue.CycleID}}bg-zinc-50{{end}}" data-action="set-cycle" data-cycle-id="{{.ID}}">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-500">
              <path d="M10 2h4"/><path d="M12 14v-4"/><path d="M4 13a8 8 0 0 1 8-7 8 8 0 1 1-5.3 14L4 17.6"/><path d="M9 17H4v5"/>
            </svg>
            <span>{{.Name}}</span>
          </button>
          {{end}}
        </div>
      </div>
    </div>

    <!-- Assignees -->
    <div class="p-4">
      <div class="text-xs font-semibold uppercase tracking-wide text-zinc-400 mb-2">Assignees</div>
      <div class="relative" id="assignees-dropdown-wrapper">
        <button class="flex items-center justify-between w-full px-3 py-2 text-sm text-zinc-900 bg-zinc-50 hover:bg-zinc-100 rounded-lg cursor-pointer transition-colors dropdown-trigger" id="assignees-trigger" data-issue-key="{{.Issue.Key}}">
          <span class="flex items-center gap-2" id="assignees-display">
            <span class="text-zinc-400">Select assignees</span>
          </span>
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-zinc-400">
            <path d="m6 9 6 6 6-6"/>
          </svg>
        </button>
        <div class="absolute left-0 right-0 top-full mt-1 bg-white rounded-lg shadow-lg border border-zinc-200 py-1 z-50 hidden dropdown-menu">
          {{range .TeamMembers}}
          <label class="flex items-center gap-2 w-full px-3 py-2 text-sm cursor-pointer hover:bg-zinc-50 transition-colors">
            <input type="checkbox" class="w-4 h-4 text-indigo-600 border-zinc-300 rounded focus:ring-indigo-500 assignee-checkbox" data-user-id="{{.ID}}" data-user-name="{{.DisplayName}}">
            <span class="w-6 h-6 rounded-full bg-indigo-500 text-white text-xs flex items-center justify-center font-medium">{{slice .DisplayName 0 1}}</span>
            <span>{{.DisplayName}}</span>
          </label>
          {{end}}
        </div>
      </div>
    </div>

    <!-- Start Date -->
    <div class="p-4">
      <div class="text-xs font-semibold uppercase tracking-wide text-zinc-400 mb-2">Start Date</div>
      <input type="date" id="start-date-input" class="w-full px-3 py-2 text-sm text-zinc-900 bg-zinc-50 hover:bg-zinc-100 rounded-lg cursor-pointer transition-colors border-none outline-none focus:ring-2 focus:ring-indigo-500" value="{{if .Issue.StartDate}}{{.Issue.StartDate.Format "2006-01-02"}}{{end}}" data-issue-key="{{.Issue.Key}}">
    </div>

    <!-- Due Date -->
    <div class="p-4">
      <div class="text-xs font-semibold uppercase tracking-wide text-zinc-400 mb-2">Due Date</div>
      <input type="date" id="due-date-input" class="w-full px-3 py-2 text-sm text-zinc-900 bg-zinc-50 hover:bg-zinc-100 rounded-lg cursor-pointer transition-colors border-none outline-none focus:ring-2 focus:ring-indigo-500" value="{{if .Issue.DueDate}}{{.Issue.DueDate.Format "2006-01-02"}}{{end}}" data-issue-key="{{.Issue.Key}}">
    </div>

    <!-- Project -->
    <div class="p-4">
      <div class="text-xs font-semibold uppercase tracking-wide text-zinc-400 mb-2">Project</div>
      <div class="text-sm text-zinc-900">
        <a href="/w/{{.Workspace.Slug}}/board/{{.Project.ID}}" class="hover:text-indigo-600 transition-colors">
          {{.Project.Name}}
        </a>
      </div>
    </div>
  </div>
</div>

<script>
// Start Date handler
document.getElementById('start-date-input')?.addEventListener('change', async (e) => {
  const value = e.target.value;
  try {
    await app.api.patch(`/issues/{{.Issue.Key}}`, { start_date: value || null });
  } catch (error) {
    console.error('Failed to update start date:', error);
    alert(error.message || 'Failed to update start date');
  }
});

// Due Date handler
document.getElementById('due-date-input')?.addEventListener('change', async (e) => {
  const value = e.target.value;
  try {
    await app.api.patch(`/issues/{{.Issue.Key}}`, { due_date: value || null });
  } catch (error) {
    console.error('Failed to update due date:', error);
    alert(error.message || 'Failed to update due date');
  }
});

// Copy link
document.querySelectorAll('[data-action="copy-link"]').forEach(btn => {
  btn.addEventListener('click', async () => {
    try {
      await navigator.clipboard.writeText(location.href);
      const copyIcon = btn.querySelector('.copy-icon');
      const checkIcon = btn.querySelector('.check-icon');
      copyIcon.classList.add('hidden');
      checkIcon.classList.remove('hidden');
      setTimeout(() => {
        copyIcon.classList.remove('hidden');
        checkIcon.classList.add('hidden');
      }, 2000);
    } catch (error) {
      console.error('Failed to copy:', error);
    }
  });
});

// Status dropdown handler
document.querySelectorAll('.issue-status-option').forEach(opt => {
  opt.addEventListener('click', async () => {
    const columnId = opt.dataset.columnId;
    const columnName = opt.dataset.columnName;
    try {
      await app.api.post(`/issues/{{.Issue.Key}}/move`, { column_id: columnId, position: 0 });
      location.reload();
    } catch (error) {
      console.error('Failed to update status:', error);
      alert(error.message || 'Failed to update status');
    }
  });
});

// Priority dropdown handler
document.querySelectorAll('.issue-priority-option').forEach(opt => {
  opt.addEventListener('click', async () => {
    const priority = parseInt(opt.dataset.priority);
    try {
      await app.api.patch(`/issues/{{.Issue.Key}}`, { priority: priority });
      location.reload();
    } catch (error) {
      console.error('Failed to update priority:', error);
      alert(error.message || 'Failed to update priority');
    }
  });
});

// Assignees dropdown handler
document.querySelectorAll('.assignee-checkbox').forEach(checkbox => {
  checkbox.addEventListener('change', async () => {
    const userId = checkbox.dataset.userId;
    try {
      if (checkbox.checked) {
        await app.api.post(`/issues/{{.Issue.ID}}/assignees`, { user_id: userId });
      } else {
        await app.api.delete(`/issues/{{.Issue.ID}}/assignees/${userId}`);
      }
      updateAssigneesDisplay();
    } catch (error) {
      checkbox.checked = !checkbox.checked;
      alert(error.message || 'Failed to update assignee');
    }
  });
});

function updateAssigneesDisplay() {
  const checked = document.querySelectorAll('.assignee-checkbox:checked');
  const display = document.getElementById('assignees-display');
  if (checked.length === 0) {
    display.innerHTML = '<span class="text-zinc-400">Select assignees</span>';
  } else {
    const avatars = Array.from(checked).map(c =>
      `<span class="w-6 h-6 rounded-full bg-indigo-500 text-white text-xs flex items-center justify-center font-medium">${c.dataset.userName.charAt(0)}</span>`
    ).join('');
    display.innerHTML = `<div class="flex items-center gap-1">${avatars}<span class="ml-1 text-zinc-600">${checked.length} assigned</span></div>`;
  }
}

// Cycle dropdown handler
document.querySelectorAll('[data-action="set-cycle"]').forEach(item => {
  item.addEventListener('click', async () => {
    const cycleId = item.dataset.cycleId;
    try {
      if (cycleId) {
        await app.api.post(`/issues/{{.Issue.Key}}/cycle`, { cycle_id: cycleId });
      } else {
        await app.api.delete(`/issues/{{.Issue.Key}}/cycle`);
      }
      location.reload();
    } catch (error) {
      console.error('Failed to update cycle:', error);
      alert(error.message || 'Failed to update cycle');
    }
  });
});

// Inline editing for title
const titleEl = document.getElementById('issue-title');
let originalTitle = titleEl?.textContent;

titleEl?.addEventListener('focus', () => {
  originalTitle = titleEl.textContent;
});

titleEl?.addEventListener('blur', async () => {
  const newTitle = titleEl.textContent.trim();
  if (newTitle === originalTitle || !newTitle) {
    titleEl.textContent = originalTitle;
    return;
  }

  try {
    await app.api.patch(`/issues/{{.Issue.Key}}`, { title: newTitle });
  } catch (error) {
    titleEl.textContent = originalTitle;
    alert(error.message || 'Failed to update title');
  }
});

titleEl?.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    titleEl.blur();
  } else if (e.key === 'Escape') {
    titleEl.textContent = originalTitle;
    titleEl.blur();
  }
});
</script>
{{end}}
