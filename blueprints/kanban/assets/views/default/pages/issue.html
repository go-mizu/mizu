{{define "content"}}
<div class="mb-4">
  <a href="/w/{{.Workspace.Slug}}/issues" class="btn btn-ghost btn-icon" aria-label="Back to issues list">
    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <path d="m12 19-7-7 7-7"/>
      <path d="M19 12H5"/>
    </svg>
  </a>
</div>

<div class="issue-detail">
  <!-- Main Content -->
  <div class="issue-main">
    <div class="issue-header">
      <div class="flex items-center gap-2 mb-2">
        <span class="issue-key">{{.Issue.Key}}</span>
        <button class="btn btn-ghost btn-icon btn-sm" data-action="copy-link" title="Copy link">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
            <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
          </svg>
        </button>
      </div>
      <h1
        id="issue-title"
        class="issue-title-editable"
        contenteditable="true"
        data-issue-key="{{.Issue.Key}}"
        data-field="title"
      >{{.Issue.Title}}</h1>
    </div>

    <!-- Description -->
    <div class="mb-6">
      <h3 class="text-sm font-medium text-muted mb-2">Description</h3>
      <div
        id="issue-description"
        class="issue-description prose"
        contenteditable="true"
        data-issue-key="{{.Issue.Key}}"
        data-field="description"
      ><span class="text-muted">Add a description...</span></div>
    </div>

    <!-- Activity / Comments -->
    <div class="activity-section">
      <h3 class="text-sm font-medium mb-4">Activity</h3>

      <!-- Comments List (above form) -->
      <div class="comment-list mb-4">
        {{range .Comments}}
        <div class="comment-item">
          <div class="avatar avatar-sm">{{slice .Author.DisplayName 0 1}}</div>
          <div class="comment-content">
            <div class="comment-header">
              <span class="comment-author">{{.Author.DisplayName}}</span>
              <span class="comment-time">{{.CreatedAt.Format "Jan 2, 2006"}}</span>
            </div>
            <div class="comment-body">{{.Content}}</div>
          </div>
        </div>
        {{else}}
        <p class="text-muted text-sm mb-4">No activity yet</p>
        {{end}}
      </div>

      <!-- Comment Form (bottom) -->
      <form class="comment-form-inline" data-issue-id="{{.Issue.ID}}">
        <div class="avatar avatar-sm">{{slice .User.DisplayName 0 1}}</div>
        <div class="comment-input-wrapper">
          <textarea
            name="body"
            class="comment-input-seamless"
            placeholder="Write a comment..."
            rows="1"
            aria-label="Write a comment"
          ></textarea>
          <button type="submit" class="btn btn-primary btn-sm">Send</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Sidebar -->
  <div class="issue-sidebar">
    <!-- Status -->
    <div class="card property-card">
      <div class="property-label">Status</div>
      <div class="property-chips status-chips" id="status-chips" data-issue-key="{{.Issue.Key}}" role="group" aria-label="Issue status">
        {{range .Columns}}
        <button class="property-chip status-{{lower .Name}} {{if eq .ID $.Issue.ColumnID}}is-active{{end}}" data-value="{{.ID}}" title="{{.Name}}" aria-pressed="{{if eq .ID $.Issue.ColumnID}}true{{else}}false{{end}}">
          {{if eq (lower .Name) "backlog"}}
          <svg class="status-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="8" cy="8" r="6" stroke-dasharray="2 2"/></svg>
          {{else if eq (lower .Name) "todo"}}
          <svg class="status-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="8" cy="8" r="6"/><circle cx="8" cy="8" r="1.5" fill="currentColor"/></svg>
          {{else if or (eq (lower .Name) "in-progress") (eq (lower .Name) "doing")}}
          <svg class="status-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="8" cy="8" r="6"/><path d="M8 2a6 6 0 0 1 6 6" stroke-width="2"/></svg>
          {{else if or (eq (lower .Name) "done") (eq (lower .Name) "completed")}}
          <svg class="status-icon" viewBox="0 0 16 16" fill="currentColor"><circle cx="8" cy="8" r="7"/><path d="M5.5 8l2 2 3.5-3.5" stroke="white" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>
          {{else if or (eq (lower .Name) "canceled") (eq (lower .Name) "cancelled")}}
          <svg class="status-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="8" cy="8" r="6"/><path d="M5.5 5.5l5 5M10.5 5.5l-5 5"/></svg>
          {{else}}
          <svg class="status-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="8" cy="8" r="6"/></svg>
          {{end}}
          <span>{{.Name}}</span>
        </button>
        {{end}}
      </div>
    </div>

    <!-- Priority -->
    <div class="card property-card">
      <div class="property-label">Priority</div>
      <div class="property-chips" id="priority-chips" data-issue-key="{{.Issue.Key}}" role="group" aria-label="Issue priority">
        <button class="property-chip {{if eq .Issue.Priority 0}}is-active{{end}}" data-value="0" title="No priority" aria-pressed="{{if eq .Issue.Priority 0}}true{{else}}false{{end}}">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M5 12h14"/>
          </svg>
          <span>None</span>
        </button>
        <button class="property-chip priority-urgent {{if eq .Issue.Priority 1}}is-active{{end}}" data-value="1" title="Urgent" aria-pressed="{{if eq .Issue.Priority 1}}true{{else}}false{{end}}">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M2 20h.01"/><path d="M7 20v-4"/><path d="M12 20v-8"/><path d="M17 20V8"/><path d="M22 4v16"/>
          </svg>
          <span>Urgent</span>
        </button>
        <button class="property-chip priority-high {{if eq .Issue.Priority 2}}is-active{{end}}" data-value="2" title="High" aria-pressed="{{if eq .Issue.Priority 2}}true{{else}}false{{end}}">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M2 20h.01"/><path d="M7 20v-4"/><path d="M12 20v-8"/><path d="M17 20V8"/>
          </svg>
          <span>High</span>
        </button>
        <button class="property-chip priority-medium {{if eq .Issue.Priority 3}}is-active{{end}}" data-value="3" title="Medium" aria-pressed="{{if eq .Issue.Priority 3}}true{{else}}false{{end}}">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M2 20h.01"/><path d="M7 20v-4"/><path d="M12 20v-8"/>
          </svg>
          <span>Medium</span>
        </button>
        <button class="property-chip priority-low {{if eq .Issue.Priority 4}}is-active{{end}}" data-value="4" title="Low" aria-pressed="{{if eq .Issue.Priority 4}}true{{else}}false{{end}}">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M2 20h.01"/><path d="M7 20v-4"/>
          </svg>
          <span>Low</span>
        </button>
      </div>
    </div>

    <!-- Sprint (Cycle) -->
    <div class="card property-card">
      <div class="property-label">Sprint</div>
      <div class="dropdown w-full" id="cycle-dropdown">
        <button class="dropdown-trigger property-select w-full" data-issue-key="{{.Issue.Key}}">
          <span class="property-select-value">
            {{if .Issue.CycleID}}
              {{range .Cycles}}{{if eq .ID $.Issue.CycleID}}
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M10 2h4"/><path d="M12 14v-4"/><path d="M4 13a8 8 0 0 1 8-7 8 8 0 1 1-5.3 14L4 17.6"/><path d="M9 17H4v5"/>
                </svg>
                <span>{{.Name}}</span>
              {{end}}{{end}}
            {{else}}
              <span class="text-muted">No sprint</span>
            {{end}}
          </span>
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="m6 9 6 6 6-6"/>
          </svg>
        </button>
        <div class="dropdown-menu hidden" style="width: 100%; margin-top: 0.25rem;">
          <button class="dropdown-item" data-action="set-cycle" data-cycle-id="">
            <span class="text-muted">No sprint</span>
          </button>
          {{range .Cycles}}
          <button class="dropdown-item {{if eq .ID $.Issue.CycleID}}active{{end}}" data-action="set-cycle" data-cycle-id="{{.ID}}">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M10 2h4"/><path d="M12 14v-4"/><path d="M4 13a8 8 0 0 1 8-7 8 8 0 1 1-5.3 14L4 17.6"/><path d="M9 17H4v5"/>
            </svg>
            <span>{{.Name}}</span>
          </button>
          {{end}}
        </div>
      </div>
    </div>

    <!-- Custom Fields -->
    {{if .Fields}}
    {{range .Fields}}
    {{if not .IsArchived}}
    <div class="card property-card" data-field-id="{{.ID}}">
      <div class="property-label">{{.Name}}{{if .IsRequired}} *{{end}}</div>
      {{if eq .Kind "text"}}
      <input type="text" class="form-control custom-field-input" data-field-id="{{.ID}}" data-kind="text" placeholder="Enter value...">
      {{else if eq .Kind "number"}}
      <input type="number" class="form-control custom-field-input" data-field-id="{{.ID}}" data-kind="number" placeholder="Enter number...">
      {{else if eq .Kind "bool"}}
      <label class="form-check">
        <input type="checkbox" class="custom-field-input" data-field-id="{{.ID}}" data-kind="bool">
        <span class="text-sm">Yes</span>
      </label>
      {{else if eq .Kind "date"}}
      <input type="date" class="form-control custom-field-input" data-field-id="{{.ID}}" data-kind="date">
      {{else if eq .Kind "select"}}
      <select class="form-control form-select custom-field-input" data-field-id="{{.ID}}" data-kind="select">
        <option value="">Select...</option>
        <!-- Options loaded from settings_json -->
      </select>
      {{else if eq .Kind "user"}}
      <select class="form-control form-select custom-field-input" data-field-id="{{.ID}}" data-kind="user">
        <option value="">Select user...</option>
        {{range $.TeamMembers}}
        <option value="{{.ID}}">{{.DisplayName}}</option>
        {{end}}
      </select>
      {{end}}
    </div>
    {{end}}
    {{end}}
    {{end}}

    <!-- Assignees -->
    <div class="card property-card">
      <div class="property-label flex items-center justify-between">
        <span>Assignees</span>
        <button class="btn btn-ghost btn-icon btn-sm" data-modal="assign-modal">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M5 12h14"/>
            <path d="M12 5v14"/>
          </svg>
        </button>
      </div>
      <div class="property-value" id="assignees-list">
        <span class="text-muted">No assignees</span>
      </div>
    </div>

    <!-- Project -->
    <div class="card property-card">
      <div class="property-label">Project</div>
      <div class="property-value">
        <a href="/w/{{.Workspace.Slug}}/board/{{.Project.ID}}" class="text-sm hover:underline">
          {{.Project.Name}}
        </a>
      </div>
    </div>

    <!-- Created -->
    <div class="card property-card">
      <div class="property-label">Created</div>
      <div class="property-value text-sm text-muted">{{.Issue.CreatedAt}}</div>
    </div>

    <!-- Actions -->
    <div class="card property-card">
      <div class="dropdown w-full">
        <button class="dropdown-trigger btn btn-secondary w-full">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="1"/>
            <circle cx="12" cy="5" r="1"/>
            <circle cx="12" cy="19" r="1"/>
          </svg>
          More Actions
        </button>
        <div class="dropdown-menu hidden" style="width: 100%; position: relative; margin-top: 0.5rem;">
          <button class="dropdown-item" data-action="copy-link">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
              <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
            </svg>
            Copy Link
          </button>
          <div class="dropdown-divider"></div>
          <button class="dropdown-item destructive" data-action="delete-issue" data-issue-key="{{.Issue.Key}}">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M3 6h18"/>
              <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
              <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
            </svg>
            Delete Issue
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Assign Modal -->
<div id="assign-modal" class="modal hidden">
  <div class="modal-backdrop"></div>
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">Add Assignee</h2>
      <button class="modal-close">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="label">Team Members</label>
        <div class="members-list">
          {{range .TeamMembers}}
          <button class="member-item" data-action="assign" data-user-id="{{.ID}}">
            <div class="avatar avatar-sm">{{slice .DisplayName 0 1}}</div>
            <div class="member-info">
              <div class="member-name">{{.DisplayName}}</div>
              <div class="member-email">{{.Email}}</div>
            </div>
          </button>
          {{end}}
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Delete issue
document.querySelector('[data-action="delete-issue"]')?.addEventListener('click', async () => {
  if (!confirm('Are you sure you want to delete this issue?')) return;

  try {
    await app.api.delete(`/issues/{{.Issue.Key}}`);
    location.href = `/w/{{.Workspace.Slug}}/issues`;
  } catch (error) {
    alert(error.message || 'Failed to delete issue');
  }
});

// Copy link
document.querySelector('[data-action="copy-link"]')?.addEventListener('click', async () => {
  try {
    await navigator.clipboard.writeText(location.href);
    alert('Link copied to clipboard!');
  } catch (error) {
    console.error('Failed to copy:', error);
  }
});

// Assign user
document.querySelectorAll('[data-action="assign"]').forEach(btn => {
  btn.addEventListener('click', async () => {
    const userId = btn.dataset.userId;
    try {
      await app.api.post(`/issues/{{.Issue.ID}}/assignees`, { user_id: userId });
      app.modals.close('assign-modal');
      location.reload();
    } catch (error) {
      alert(error.message || 'Failed to assign user');
    }
  });
});

// Remove assignee
document.querySelectorAll('.remove-assignee').forEach(btn => {
  btn.addEventListener('click', async (e) => {
    e.stopPropagation();
    const userId = btn.dataset.userId;
    try {
      await app.api.delete(`/issues/{{.Issue.ID}}/assignees/${userId}`);
      // Remove from DOM
      const assigneeItem = btn.closest('.assignee-item');
      if (assigneeItem) {
        assigneeItem.remove();
        // Check if no more assignees
        const remaining = document.querySelectorAll('.assignee-item');
        if (remaining.length === 0) {
          document.getElementById('assignees-list').innerHTML = '<span class="text-muted">No assignees</span>';
        }
      }
    } catch (error) {
      alert(error.message || 'Failed to remove assignee');
    }
  });
});

// Status chips click handler
document.querySelectorAll('#status-chips .property-chip').forEach(chip => {
  chip.addEventListener('click', async () => {
    const columnId = chip.dataset.value;
    try {
      await app.api.post(`/issues/{{.Issue.Key}}/move`, { column_id: columnId, position: 0 });
      // Update active state
      document.querySelectorAll('#status-chips .property-chip').forEach(c => {
        c.classList.remove('is-active');
        c.setAttribute('aria-pressed', 'false');
      });
      chip.classList.add('is-active');
      chip.setAttribute('aria-pressed', 'true');
    } catch (error) {
      console.error('Failed to update status:', error);
      alert(error.message || 'Failed to update status');
    }
  });
});

// Priority chips click handler
document.querySelectorAll('#priority-chips .property-chip').forEach(chip => {
  chip.addEventListener('click', async () => {
    const priority = parseInt(chip.dataset.value);
    try {
      await app.api.patch(`/issues/{{.Issue.Key}}`, { priority: priority });
      // Update active state
      document.querySelectorAll('#priority-chips .property-chip').forEach(c => {
        c.classList.remove('is-active');
        c.setAttribute('aria-pressed', 'false');
      });
      chip.classList.add('is-active');
      chip.setAttribute('aria-pressed', 'true');
    } catch (error) {
      console.error('Failed to update priority:', error);
      alert(error.message || 'Failed to update priority');
    }
  });
});

// Cycle dropdown handler
const cycleDropdown = document.getElementById('cycle-dropdown');
cycleDropdown?.querySelector('.dropdown-trigger')?.addEventListener('click', () => {
  const menu = cycleDropdown.querySelector('.dropdown-menu');
  menu.classList.toggle('hidden');
});

document.querySelectorAll('[data-action="set-cycle"]').forEach(item => {
  item.addEventListener('click', async () => {
    const cycleId = item.dataset.cycleId;
    const menu = cycleDropdown.querySelector('.dropdown-menu');
    try {
      if (cycleId) {
        await app.api.post(`/issues/{{.Issue.Key}}/cycle`, { cycle_id: cycleId });
      } else {
        await app.api.delete(`/issues/{{.Issue.Key}}/cycle`);
      }
      // Update UI
      const valueSpan = cycleDropdown.querySelector('.property-select-value');
      if (cycleId) {
        const selectedItem = item.cloneNode(true);
        valueSpan.innerHTML = selectedItem.innerHTML;
      } else {
        valueSpan.innerHTML = '<span class="text-muted">No sprint</span>';
      }
      // Update active state
      document.querySelectorAll('[data-action="set-cycle"]').forEach(i => i.classList.remove('active'));
      item.classList.add('active');
      menu.classList.add('hidden');
    } catch (error) {
      console.error('Failed to update cycle:', error);
      alert(error.message || 'Failed to update cycle');
    }
  });
});

// Close dropdown when clicking outside
document.addEventListener('click', (e) => {
  if (!cycleDropdown?.contains(e.target)) {
    cycleDropdown?.querySelector('.dropdown-menu')?.classList.add('hidden');
  }
});

// Inline editing for title
const titleEl = document.getElementById('issue-title');
let originalTitle = titleEl?.textContent;

titleEl?.addEventListener('focus', () => {
  originalTitle = titleEl.textContent;
});

titleEl?.addEventListener('blur', async () => {
  const newTitle = titleEl.textContent.trim();
  if (newTitle === originalTitle || !newTitle) {
    titleEl.textContent = originalTitle;
    return;
  }

  try {
    await app.api.patch(`/issues/{{.Issue.Key}}`, { title: newTitle });
  } catch (error) {
    titleEl.textContent = originalTitle;
    alert(error.message || 'Failed to update title');
  }
});

titleEl?.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    titleEl.blur();
  } else if (e.key === 'Escape') {
    titleEl.textContent = originalTitle;
    titleEl.blur();
  }
});

// Custom field value updates
document.querySelectorAll('.custom-field-input').forEach(input => {
  const updateField = async () => {
    const fieldId = input.dataset.fieldId;
    const kind = input.dataset.kind;
    let value = {};

    switch (kind) {
      case 'text':
        value = { value_text: input.value || null };
        break;
      case 'number':
        value = { value_num: input.value ? parseFloat(input.value) : null };
        break;
      case 'bool':
        value = { value_bool: input.checked };
        break;
      case 'date':
        value = { value_date: input.value || null };
        break;
      case 'select':
      case 'user':
        value = { value_ref: input.value || null };
        break;
    }

    try {
      await app.api.put(`/issues/{{.Issue.ID}}/values/${fieldId}`, value);
    } catch (error) {
      console.error('Failed to update field value:', error);
    }
  };

  if (input.type === 'checkbox') {
    input.addEventListener('change', updateField);
  } else if (input.tagName === 'SELECT') {
    input.addEventListener('change', updateField);
  } else {
    input.addEventListener('blur', updateField);
  }
});
</script>
{{end}}
