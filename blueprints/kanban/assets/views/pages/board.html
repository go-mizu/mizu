{{define "pages/board.html"}}
{{template "layouts/default.html" .}}
{{define "title"}}{{.Project.Name}} - Board{{end}}
{{define "content"}}
<div class="board-header">
    <div class="board-header-left">
        <h1 class="board-title">{{.Project.Name}}</h1>
        <span class="board-key">{{.Project.Key}}</span>
    </div>
    <div class="board-header-right">
        <button class="btn btn-primary btn-sm" onclick="createIssue()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            New Issue
        </button>
    </div>
</div>

<div class="board" id="board">
    {{range .Statuses}}
    {{$status := .}}
    {{$issues := index $.IssuesByStatus $status}}
    <div class="board-column" data-status="{{$status}}">
        <div class="board-column-header">
            <span class="board-column-title">{{statusLabel $status}}</span>
            <span class="board-column-count">{{if $issues}}{{len $issues}}{{else}}0{{end}}</span>
        </div>
        <div class="board-column-content" data-status="{{$status}}">
            {{if $issues}}
            {{range $issues}}
            {{template "issue_card" .}}
            {{end}}
            {{end}}
        </div>
        <button class="board-column-add" onclick="createIssue('{{$status}}')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            Add issue
        </button>
    </div>
    {{end}}
</div>

<script>
const projectId = '{{.Project.ID}}';
const workspaceSlug = '{{.Workspace.Slug}}';
const projectKey = '{{.Project.Key}}';

function createIssue(status = 'backlog') {
    const title = prompt('Issue title:');
    if (!title) return;

    fetch('/api/v1/projects/' + projectId + '/issues', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title, status })
    }).then(res => {
        if (res.ok) {
            window.location.reload();
        }
    });
}

// Initialize drag and drop
document.addEventListener('DOMContentLoaded', () => {
    initBoard();
});

function initBoard() {
    const columns = document.querySelectorAll('.board-column-content');
    const cards = document.querySelectorAll('.issue-card');

    cards.forEach(card => {
        card.addEventListener('dragstart', handleDragStart);
        card.addEventListener('dragend', handleDragEnd);
    });

    columns.forEach(column => {
        column.addEventListener('dragover', handleDragOver);
        column.addEventListener('drop', handleDrop);
        column.addEventListener('dragleave', handleDragLeave);
    });
}

let draggedCard = null;

function handleDragStart(e) {
    draggedCard = e.target;
    e.target.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
}

function handleDragEnd(e) {
    e.target.classList.remove('dragging');
    document.querySelectorAll('.board-column-content').forEach(col => {
        col.classList.remove('drag-over');
    });
}

function handleDragOver(e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    e.currentTarget.classList.add('drag-over');
}

function handleDragLeave(e) {
    e.currentTarget.classList.remove('drag-over');
}

function handleDrop(e) {
    e.preventDefault();
    const column = e.currentTarget;
    column.classList.remove('drag-over');

    if (draggedCard) {
        const newStatus = column.dataset.status;
        const issueKey = draggedCard.dataset.issueKey;

        column.appendChild(draggedCard);

        // Update on server
        fetch('/api/v1/issues/' + issueKey + '/move', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status: newStatus, position: 0 })
        }).then(res => {
            if (!res.ok) {
                window.location.reload();
            } else {
                // Update column counts
                updateColumnCounts();
            }
        });
    }
}

function updateColumnCounts() {
    document.querySelectorAll('.board-column').forEach(col => {
        const count = col.querySelector('.board-column-content').children.length;
        col.querySelector('.board-column-count').textContent = count;
    });
}

// Issue card click handler
document.querySelectorAll('.issue-card').forEach(card => {
    card.addEventListener('click', (e) => {
        if (!e.target.closest('.dragging')) {
            const issueKey = card.dataset.issueKey;
            window.location.href = '/' + workspaceSlug + '/issue/' + issueKey;
        }
    });
});
</script>
{{end}}
{{end}}
