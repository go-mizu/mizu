import{a as t,j as s,M as T,b as D}from"./markdown-Bs6XdLEX.js";import{c as K}from"./utils-BuvrnUzC.js";import{u as F,I as x}from"./index-BMNYCodQ.js";import"./react-vendor-ZmPOmYi1.js";function P(c){const o=[];for(const i of c){const d=o[o.length-1];d&&d.role===i.role?d.messages.push(i):o.push({role:i.role,messages:[i]})}return o}function Y({gw:c}){const{toast:o}=F(),[i,d]=t.useState([]),[u,M]=t.useState(""),[N,l]=t.useState([]),[m,S]=t.useState(""),[h,f]=t.useState(!1),[p,j]=t.useState(!1),C=t.useRef(null),k=t.useRef(null),w=t.useCallback(async()=>{try{const r=(await c.rpc("sessions.list",{limit:50})).sessions??[];d(r)}catch{}},[c]),E=t.useCallback(async e=>{if(!e){l([]);return}try{const a=(await c.rpc("chat.history",{sessionId:e,limit:50})).messages??[];l(a)}catch{l([])}},[c]);t.useEffect(()=>{w()},[w]),t.useEffect(()=>{E(u)},[u,E]),t.useEffect(()=>{var e;(e=C.current)==null||e.scrollIntoView({behavior:"smooth"})},[N,h,p]);const g=t.useCallback(async()=>{var a;const e=m.trim();if(!e||h)return;const r={role:"user",content:e};l(n=>[...n,r]),S(""),f(!0),j(!0);try{const n=await c.rpc("chat.send",{sessionId:u,message:e}),v={role:"assistant",content:n.content??n.message??n.response??""};l(A=>[...A,v])}catch(n){const b={role:"assistant",content:`Error: ${n instanceof Error?n.message:"unknown error"}`};l(v=>[...v,b])}finally{f(!1),j(!1),(a=k.current)==null||a.focus()}},[m,h,c,u]),I=t.useCallback(async()=>{try{await c.rpc("chat.abort")}catch{}j(!1),f(!1)},[c]),$=t.useCallback(e=>{e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),g())},[g]),R=t.useCallback(async e=>{try{await K(e),o("Copied!","success")}catch{o("Failed to copy","error")}},[o]),z=t.useCallback(e=>{const r=e.target.value;l([]),M(r)},[]),y=P(N);return s.jsxs("div",{className:"chat-page",children:[s.jsxs("div",{className:"chat-session-bar",children:[s.jsx("label",{htmlFor:"session-select",children:"Session:"}),s.jsxs("select",{id:"session-select",value:u,onChange:z,children:[s.jsx("option",{value:"",children:"New conversation"}),i.map(e=>s.jsx("option",{value:e.id,children:e.displayName||e.title||e.id},e.id))]})]}),s.jsxs("div",{className:"chat-messages",children:[y.length===0&&!h&&s.jsxs("div",{className:"chat-empty",children:[s.jsx(x,{name:"messageSquare",size:48}),s.jsx("p",{children:"No messages yet. Start a conversation below."})]}),y.map((e,r)=>s.jsxs("div",{className:`chat-group chat-group--${e.role}`,children:[s.jsx("div",{className:"chat-group-label",children:e.role==="user"?"You":"Assistant"}),e.messages.map((a,n)=>{const b=p&&a.role==="assistant"&&r===y.length-1&&n===e.messages.length-1;return s.jsx("div",{className:"chat-bubble-wrapper",children:s.jsxs("div",{className:`chat-bubble chat-bubble--${a.role}${b?" streaming":""}`,children:[a.role==="assistant"?s.jsx(T,{remarkPlugins:[D],children:a.content}):s.jsx("span",{children:a.content}),s.jsx("button",{className:"chat-copy-btn",onClick:()=>R(a.content),title:"Copy to clipboard",children:s.jsx(x,{name:"copy",size:14})})]})},`${r}-${n}`)})]},r)),p&&s.jsxs("div",{className:"chat-group chat-group--assistant",children:[s.jsx("div",{className:"chat-group-label",children:"Assistant"}),s.jsx("div",{className:"chat-bubble-wrapper",children:s.jsx("div",{className:"chat-bubble streaming",children:s.jsxs("span",{className:"chat-reading-dots",children:[s.jsx("span",{}),s.jsx("span",{}),s.jsx("span",{})]})})})]}),s.jsx("div",{ref:C})]}),s.jsxs("div",{className:"chat-input-bar",children:[s.jsx("textarea",{ref:k,className:"chat-textarea",value:m,onChange:e=>S(e.target.value),onKeyDown:$,placeholder:"Type a message... (Enter to send, Shift+Enter for newline)",rows:2,disabled:h}),p?s.jsxs("button",{className:"chat-send-btn chat-abort-btn",onClick:I,title:"Stop generation",children:[s.jsx(x,{name:"x",size:18}),s.jsx("span",{children:"Stop"})]}):s.jsx("button",{className:"chat-send-btn",onClick:g,disabled:h||!m.trim(),title:"Send message",children:s.jsx(x,{name:"send",size:18})})]})]})}export{Y as ChatPage};
