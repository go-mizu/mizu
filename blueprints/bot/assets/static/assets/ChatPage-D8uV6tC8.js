import{a as c,j as e,M as q,b as F}from"./markdown-Bs6XdLEX.js";import{c as H}from"./utils-BuvrnUzC.js";import{u as J,I as v}from"./index-CaXNju9V.js";import"./react-vendor-ZmPOmYi1.js";function $(n){if(!n)return"";const l=n.content;return typeof l=="string"?l:Array.isArray(l)?l.filter(u=>u.type==="text").map(u=>u.text).join(""):""}function O(n){const l=[];for(const u of n){const N=l[l.length-1];N&&N.role===u.role?N.messages.push(u):l.push({role:u.role,messages:[u]})}return l}function Q(n,l){const u=l?new Date(l):n?new Date(n):null;if(!u)return"";try{return u.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}catch{return""}}function ee({gw:n}){const{toast:l}=J(),[u,N]=c.useState([]),[h,C]=c.useState(""),[b,T]=c.useState("agent:main:main"),[E,m]=c.useState([]),[k,z]=c.useState(""),[g,A]=c.useState(!1),[S,f]=c.useState(!1),[y,x]=c.useState(""),L=c.useRef(null),K=c.useRef(null),j=c.useCallback(async()=>{try{const i=(await n.rpc("sessions.list",{limit:50})).sessions??[];N(i)}catch{}},[n]),P=c.useCallback(async(s,i)=>{if(!s&&!i){m([]);return}try{const o={limit:200};i&&(o.sessionKey=i),s&&(o.sessionId=s);const p=await n.rpc("chat.history",o),t=(p.messages??[]).map(a=>{const d=typeof a.content=="string"?a.content:$(a);return{role:a.role,content:d,timestamp:a.timestamp,createdAt:a.createdAt,stopReason:a.stopReason}});m(t),p.sessionId&&!s&&C(p.sessionId)}catch{m([])}},[n]);c.useEffect(()=>{j()},[j]),c.useEffect(()=>{P(h,b)},[h,b,P]),c.useEffect(()=>{var s;(s=L.current)==null||s.scrollIntoView({behavior:"smooth"})},[E,g,S,y]),c.useEffect(()=>{const s=n.on("event:chat",r=>{const t=r;if(t&&!(t.sessionKey&&t.sessionKey!==b))switch(t.state){case"delta":{const a=$(t.message);a&&(x(a),f(!0));break}case"final":{const a=t.message;if(a){const d=$(a),I=a.role||"assistant";d&&m(w=>{const D=w[w.length-1];return D&&D.role===I&&D.content===d?w:[...w,{role:I,content:d,timestamp:a.timestamp,stopReason:a.stopReason}]})}x(""),f(!1);break}case"aborted":x(""),f(!1);break;case"error":{x(""),f(!1);const a=t.errorMessage||"Chat request failed";m(d=>[...d,{role:"assistant",content:`Error: ${a}`}]);break}}}),i=n.on("event:chat.message",r=>{const t=r;t!=null&&t.message&&(t.sessionId===h||!h)&&m(a=>t.message.id&&a.some(d=>d.id===t.message.id)?a:[...a,t.message])}),o=n.on("event:chat.typing",r=>{const t=r;((t==null?void 0:t.sessionId)===h||!h)&&f(!0)}),p=n.on("event:chat.done",r=>{const t=r;((t==null?void 0:t.sessionId)===h||!h)&&f(!1)});return()=>{s(),i(),o(),p()}},[n,h,b]);const M=c.useCallback(async()=>{var p;const s=k.trim();if(!s||g)return;const i={role:"user",content:s,timestamp:Date.now()};m(r=>[...r,i]),z(""),A(!0),f(!0);const o=crypto.randomUUID();try{const r=await n.rpc("chat.send",{sessionKey:b,message:s,idempotencyKey:o,agentId:"main"});r.sessionId&&!h&&(C(r.sessionId),j());const t=r.content??"";t&&m(a=>{if(r.messageId&&a.some(I=>I.id===r.messageId))return a;const d=a[a.length-1];return d&&d.role==="assistant"&&d.content===t?a:[...a,{id:r.messageId,role:"assistant",content:t}]})}catch(r){const t={role:"assistant",content:`Error: ${r instanceof Error?r.message:"unknown error"}`};m(a=>[...a,t])}finally{A(!1),f(!1),x(""),(p=K.current)==null||p.focus()}},[k,g,n,h,b,j]),U=c.useCallback(async()=>{try{await n.rpc("chat.abort",{sessionKey:b})}catch{}f(!1),A(!1),x("")},[n,b]),G=c.useCallback(async()=>{var s;try{await n.rpc("chat.new",{agentId:"main"})}catch{}C(""),T("agent:main:main"),m([]),x(""),j(),(s=K.current)==null||s.focus()},[n,j]),V=c.useCallback(s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),M())},[M]),Y=c.useCallback(async s=>{try{await H(s),l("Copied!","success")}catch{l("Failed to copy","error")}},[l]),B=c.useCallback(s=>{const i=s.target.value;m([]),x(""),C(i),T(i?"agent:main:"+i:"agent:main:main")},[]),R=O(E);return e.jsxs("div",{className:"chat-page",children:[e.jsxs("div",{className:"chat-session-bar",children:[e.jsx("label",{htmlFor:"session-select",children:"Session:"}),e.jsxs("select",{id:"session-select",value:h,onChange:B,children:[e.jsx("option",{value:"",children:"New conversation"}),u.map(s=>e.jsxs("option",{value:s.id,children:[s.displayName||s.title||s.id,s.channelType&&s.channelType!=="webhook"?` [${s.channelType}]`:""]},s.id))]}),e.jsxs("button",{className:"btn btn--sm chat-new-btn",onClick:G,title:"Start a new conversation",children:[e.jsx(v,{name:"plus",size:14}),e.jsx("span",{children:"New"})]})]}),e.jsxs("div",{className:"chat-messages",children:[R.length===0&&!g&&!y&&e.jsxs("div",{className:"chat-empty",children:[e.jsx(v,{name:"messageSquare",size:48}),e.jsx("p",{children:"No messages yet. Start a conversation below."})]}),R.map((s,i)=>e.jsxs("div",{className:`chat-group chat-group--${s.role}`,children:[e.jsx("div",{className:"chat-group-label",children:s.role==="user"?"You":"Assistant"}),s.messages.map((o,p)=>{const r=S&&!y&&o.role==="assistant"&&i===R.length-1&&p===s.messages.length-1;return e.jsxs("div",{className:"chat-bubble-wrapper",children:[e.jsxs("div",{className:`chat-bubble chat-bubble--${o.role}${r?" streaming":""}`,children:[o.role==="assistant"?e.jsx(q,{remarkPlugins:[F],children:o.content}):e.jsx("span",{children:o.content}),e.jsx("button",{className:"chat-copy-btn",onClick:()=>Y(o.content),title:"Copy to clipboard",children:e.jsx(v,{name:"copy",size:14})})]}),(o.createdAt||o.timestamp)&&e.jsx("div",{className:"chat-stamp",children:Q(o.createdAt,o.timestamp)})]},o.id||`${i}-${p}`)})]},i)),S&&y&&e.jsxs("div",{className:"chat-group chat-group--assistant",children:[e.jsx("div",{className:"chat-group-label",children:"Assistant"}),e.jsx("div",{className:"chat-bubble-wrapper",children:e.jsx("div",{className:"chat-bubble chat-bubble--assistant streaming",children:e.jsx(q,{remarkPlugins:[F],children:y})})})]}),S&&!y&&E.length>0&&e.jsxs("div",{className:"chat-group chat-group--assistant",children:[e.jsx("div",{className:"chat-group-label",children:"Assistant"}),e.jsx("div",{className:"chat-bubble-wrapper",children:e.jsx("div",{className:"chat-bubble streaming",children:e.jsxs("span",{className:"chat-reading-dots",children:[e.jsx("span",{}),e.jsx("span",{}),e.jsx("span",{})]})})})]}),e.jsx("div",{ref:L})]}),e.jsxs("div",{className:"chat-input-bar",children:[e.jsx("textarea",{ref:K,className:"chat-textarea",value:k,onChange:s=>z(s.target.value),onKeyDown:V,placeholder:"Type a message... (Enter to send, Shift+Enter for newline)",rows:2,disabled:g}),S?e.jsxs("button",{className:"chat-send-btn chat-abort-btn",onClick:U,title:"Stop generation",children:[e.jsx(v,{name:"x",size:18}),e.jsx("span",{children:"Stop"})]}):e.jsx("button",{className:"chat-send-btn",onClick:M,disabled:g||!k.trim(),title:"Send message",children:e.jsx(v,{name:"send",size:18})})]})]})}export{ee as ChatPage};
