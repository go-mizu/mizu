import{a as n,j as e}from"./markdown-Bs6XdLEX.js";import{f as _}from"./utils-BuvrnUzC.js";import{u as G,I as c}from"./index-h92Apb6x.js";import"./react-vendor-ZmPOmYi1.js";function Z({gw:l}){const{toast:t}=G(),[o,F]=n.useState({enabled:!1,jobs:0}),[m,I]=n.useState([]),[b,f]=n.useState(!0),[d,C]=n.useState(""),[h,S]=n.useState(""),[r,L]=n.useState("every"),[x,O]=n.useState(5),[u,B]=n.useState("minutes"),[p,D]=n.useState("09:00"),[j,k]=n.useState(""),[v,H]=n.useState("systemEvent"),[y,T]=n.useState(""),[E,R]=n.useState(!1),[g,J]=n.useState(null),[w,N]=n.useState([]),[M,A]=n.useState(!1),i=n.useCallback(async()=>{f(!0);try{const[s,a]=await Promise.all([l.rpc("cron.status"),l.rpc("cron.list")]);F({enabled:s.enabled??!1,jobs:s.jobs??0}),I(a.jobs??[])}catch(s){t("Failed to load cron data: "+(s instanceof Error?s.message:"unknown"),"error")}finally{f(!1)}},[l,t]);n.useEffect(()=>{i()},[i]);const U=n.useCallback(async()=>{if(!d.trim()){t("Job name is required","error");return}R(!0);let s;r==="every"?s={type:"every",interval:x,unit:u}:r==="at"?s={type:"at",time:p}:s={type:"cron",expression:j};const a={type:v,text:y};try{await l.rpc("cron.add",{name:d.trim(),description:h.trim(),schedule:JSON.stringify(s),payload:JSON.stringify(a)}),t("Job added","success"),C(""),S(""),k(""),T(""),await i()}catch(P){t("Failed to add job: "+(P instanceof Error?P.message:"unknown"),"error")}finally{R(!1)}},[l,t,i,d,h,r,x,u,p,j,v,y]),q=n.useCallback(async s=>{try{await l.rpc("cron.update",{id:s.id,enabled:!s.enabled}),t(s.enabled?"Job disabled":"Job enabled","success"),await i()}catch(a){t("Toggle failed: "+(a instanceof Error?a.message:"unknown"),"error")}},[l,t,i]),z=n.useCallback(async s=>{try{await l.rpc("cron.run",{id:s}),t("Job triggered","success")}catch(a){t("Run failed: "+(a instanceof Error?a.message:"unknown"),"error")}},[l,t]),W=n.useCallback(async s=>{try{await l.rpc("cron.remove",{id:s}),t("Job removed","success"),await i()}catch(a){t("Remove failed: "+(a instanceof Error?a.message:"unknown"),"error")}},[l,t,i]),Y=n.useCallback(async s=>{if(g===s){J(null),N([]);return}J(s),A(!0);try{const a=await l.rpc("cron.runs",{id:s,limit:10});N(a.runs??[])}catch(a){t("Failed to load runs: "+(a instanceof Error?a.message:"unknown"),"error"),N([])}finally{A(!1)}},[l,t,g]);return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-2",children:[e.jsxs("div",{className:"card",children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"flex-start"},children:[e.jsx("div",{className:"card-title",children:"Scheduler"}),e.jsxs("button",{className:"btn btn--sm",onClick:i,disabled:b,children:[e.jsx(c,{name:"refresh"}),e.jsx("span",{children:"Refresh"})]})]}),e.jsxs("div",{className:"stat-grid",style:{marginTop:16},children:[e.jsxs("div",{className:"stat",children:[e.jsx("div",{className:"stat-label",children:"ENABLED"}),e.jsx("div",{className:"stat-value"+(o.enabled?" ok":" warn"),children:o.enabled?"Yes":"No"})]}),e.jsxs("div",{className:"stat",children:[e.jsx("div",{className:"stat-label",children:"JOBS"}),e.jsx("div",{className:"stat-value",children:o.jobs})]})]})]}),e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-title",children:"New Job"}),e.jsx("div",{className:"card-sub",children:"Create a new scheduled job."}),e.jsxs("div",{className:"form-grid",style:{marginTop:12},children:[e.jsxs("div",{className:"field",children:[e.jsx("span",{children:"Name"}),e.jsx("input",{type:"text",value:d,onChange:s=>C(s.target.value),placeholder:"my-task"})]}),e.jsxs("div",{className:"field",children:[e.jsx("span",{children:"Description"}),e.jsx("input",{type:"text",value:h,onChange:s=>S(s.target.value),placeholder:"Brief description"})]})]}),e.jsxs("div",{className:"form-grid",style:{marginTop:12},children:[e.jsxs("div",{className:"field",children:[e.jsx("span",{children:"Schedule Type"}),e.jsxs("select",{value:r,onChange:s=>L(s.target.value),children:[e.jsx("option",{value:"every",children:"Every (interval)"}),e.jsx("option",{value:"at",children:"At (fixed time)"}),e.jsx("option",{value:"cron",children:"Cron expression"})]})]}),r==="every"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"field",children:[e.jsx("span",{children:"Interval"}),e.jsx("input",{type:"number",min:1,value:x,onChange:s=>O(Number(s.target.value))})]}),e.jsxs("div",{className:"field",children:[e.jsx("span",{children:"Unit"}),e.jsxs("select",{value:u,onChange:s=>B(s.target.value),children:[e.jsx("option",{value:"minutes",children:"minutes"}),e.jsx("option",{value:"hours",children:"hours"}),e.jsx("option",{value:"days",children:"days"})]})]})]}),r==="at"&&e.jsxs("div",{className:"field",children:[e.jsx("span",{children:"Time (HH:MM)"}),e.jsx("input",{type:"text",value:p,onChange:s=>D(s.target.value),placeholder:"09:00"})]}),r==="cron"&&e.jsxs("div",{className:"field",children:[e.jsx("span",{children:"Cron Expression"}),e.jsx("input",{type:"text",value:j,onChange:s=>k(s.target.value),placeholder:"*/5 * * * *"})]})]}),e.jsxs("div",{className:"form-grid",style:{marginTop:12},children:[e.jsxs("div",{className:"field",children:[e.jsx("span",{children:"Payload Type"}),e.jsxs("select",{value:v,onChange:s=>H(s.target.value),children:[e.jsx("option",{value:"systemEvent",children:"System Event"}),e.jsx("option",{value:"agentTurn",children:"Agent Turn"})]})]}),e.jsxs("div",{className:"field",children:[e.jsx("span",{children:"Payload Text"}),e.jsx("input",{type:"text",value:y,onChange:s=>T(s.target.value),placeholder:"Payload content"})]})]}),e.jsx("div",{style:{marginTop:16},children:e.jsxs("button",{className:"btn primary",onClick:U,disabled:E,children:[e.jsx(c,{name:"plus"}),e.jsx("span",{children:E?"Adding...":"Add Job"})]})})]})]}),e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-title",children:"Jobs"}),e.jsx("div",{className:"card-sub",children:"All scheduled jobs."}),b&&m.length===0?e.jsx("div",{className:"empty-state",children:e.jsx("div",{className:"spinner"})}):m.length===0?e.jsxs("div",{className:"empty-state",children:[e.jsx("div",{className:"empty-state-icon",children:e.jsx(c,{name:"loader",size:36})}),e.jsx("div",{children:"No cron jobs configured."})]}):e.jsx("div",{className:"list",style:{marginTop:16},children:m.map(s=>e.jsxs("div",{children:[e.jsxs("div",{className:"list-item",children:[e.jsxs("div",{className:"list-main",children:[e.jsx("div",{className:"list-title",children:s.name}),e.jsx("div",{className:"list-sub",children:s.description}),e.jsxs("div",{className:"chip-row",style:{marginTop:6},children:[e.jsx("span",{className:"chip "+(s.enabled?"chip-ok":"chip-warn"),children:s.enabled?"enabled":"disabled"}),s.lastStatus&&e.jsx("span",{className:"chip",children:s.lastStatus}),s.agent&&e.jsx("span",{className:"chip",children:s.agent})]})]}),e.jsx("div",{className:"list-meta",children:e.jsxs("div",{className:"row",style:{justifyContent:"flex-end",flexWrap:"wrap"},children:[e.jsxs("label",{className:"toggle",children:[e.jsx("input",{type:"checkbox",checked:s.enabled,onChange:()=>q(s)}),e.jsx("span",{className:"toggle-track",children:e.jsx("span",{className:"toggle-thumb"})})]}),e.jsxs("button",{className:"btn btn--sm",onClick:()=>z(s.id),children:[e.jsx(c,{name:"play"}),e.jsx("span",{children:"Run"})]}),e.jsxs("button",{className:"btn btn--sm danger",onClick:()=>W(s.id),children:[e.jsx(c,{name:"trash"}),e.jsx("span",{children:"Remove"})]}),e.jsxs("button",{className:"btn btn--sm",onClick:()=>Y(s.id),children:[e.jsx(c,{name:"chevronDown"}),e.jsx("span",{children:"Runs"})]})]})})]}),g===s.id&&e.jsx("div",{style:{padding:"8px 12px",borderLeft:"2px solid var(--border)",marginLeft:12,marginBottom:8},children:M?e.jsx("div",{className:"empty-state",style:{padding:16},children:e.jsx("div",{className:"spinner"})}):w.length===0?e.jsx("div",{className:"label",style:{padding:"8px 0"},children:"No runs recorded."}):e.jsx("div",{className:"list",children:w.map(a=>e.jsxs("div",{className:"list-item",style:{padding:"8px 10px"},children:[e.jsx("div",{className:"list-main",children:e.jsxs("div",{className:"list-sub",children:[e.jsx("span",{className:"chip "+(a.status==="ok"?"chip-ok":a.status==="error"?"chip-danger":""),style:{marginRight:8},children:a.status}),a.summary]})}),e.jsxs("div",{className:"list-meta",children:[e.jsx("div",{className:"label",children:_(a.started_at)}),e.jsx("div",{className:"label",children:a.duration})]})]},a.id))})})]},s.id))})]})]})}export{Z as CronPage};
