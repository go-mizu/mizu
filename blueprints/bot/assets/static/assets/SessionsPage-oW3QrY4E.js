import{a as i,j as e}from"./markdown-Bs6XdLEX.js";import{t as j,f as w}from"./utils-BuvrnUzC.js";import{u as M,I as c}from"./index-CaXNju9V.js";import"./react-vendor-ZmPOmYi1.js";function J({gw:o}){const[f,g]=i.useState([]),[N,v]=i.useState(!0),[d,E]=i.useState(""),[t,b]=i.useState(null),[y,h]=i.useState([]),[F,k]=i.useState(!1),[D,p]=i.useState(null),[C,u]=i.useState(""),{toast:a}=M();function P(s){p(s.id),u(s.displayName||"")}function S(){p(null),u("")}function L(s){o.rpc("sessions.patch",{key:s,label:C}).then(()=>{a("Label updated.","success"),p(null),u(""),r()}).catch(n=>{a("Failed to update label: "+n.message,"error")})}const r=i.useCallback(()=>{v(!0),o.rpc("sessions.list",{limit:50}).then(s=>{g(s.sessions||[])}).catch(s=>{a("Failed to load sessions: "+s.message,"error")}).finally(()=>v(!1))},[o,a]);i.useEffect(()=>{r()},[r]);const T=f.filter(s=>{if(!d)return!0;const n=d.toLowerCase();return(s.displayName||"").toLowerCase().includes(n)||(s.channelType||"").toLowerCase().includes(n)||(s.peerId||"").toLowerCase().includes(n)});function z(s){b(s),h([]),k(!0),o.rpc("sessions.preview",{key:s.id,limit:20}).then(n=>{h(n.messages||[])}).catch(n=>{a("Failed to load messages: "+n.message,"error")}).finally(()=>k(!1))}function x(){b(null),h([])}function R(s){confirm("Delete this session? This cannot be undone.")&&o.rpc("sessions.delete",{key:s}).then(()=>{g(n=>n.filter(l=>l.id!==s)),a("Session deleted.","success"),(t==null?void 0:t.id)===s&&x()}).catch(n=>{a("Delete failed: "+n.message,"error")})}function A(s){confirm("Reset this session? A new session will be created with the same settings.")&&o.rpc("sessions.reset",{key:s}).then(n=>{a("Session reset. New ID: "+(n.sessionId||"created"),"success"),r()}).catch(n=>{a("Reset failed: "+n.message,"error")})}function B(s){o.rpc("sessions.compact",{key:s}).then(n=>{a("Session compacted. Count: "+(n.compactionCount||0),"success"),r()}).catch(n=>{a("Compact failed: "+n.message,"error")})}function I(s){let n=s.inputTokens??null,l=s.outputTokens??null;if(n==null&&l==null&&s.metadata)try{const m=JSON.parse(s.metadata);typeof m.inputTokens=="number"&&(n=m.inputTokens),typeof m.outputTokens=="number"&&(l=m.outputTokens)}catch{}return{input:n,output:l}}return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"card",children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"flex-start"},children:[e.jsxs("div",{children:[e.jsx("div",{className:"card-title",children:"Sessions"}),e.jsx("div",{className:"card-sub",children:"Inspect active sessions and adjust per-session defaults."})]}),e.jsxs("div",{style:{display:"flex",gap:8},children:[e.jsxs("button",{className:"btn btn--sm primary",onClick:()=>{window.location.hash="chat"},children:[e.jsx(c,{name:"plus"}),e.jsx("span",{children:"New Chat"})]}),e.jsxs("button",{className:"btn btn--sm",onClick:r,disabled:N,children:[e.jsx(c,{name:"refresh"}),e.jsx("span",{children:"Refresh"})]})]})]}),e.jsx("div",{className:"filters",style:{marginTop:16},children:e.jsx("div",{className:"field",style:{flex:1,maxWidth:320},children:e.jsx("input",{type:"text",placeholder:"Filter by name, channel, or peer...",value:d,onChange:s=>E(s.target.value)})})}),N&&f.length===0?e.jsx("div",{className:"empty-state",children:e.jsx("div",{className:"spinner"})}):T.length===0?e.jsxs("div",{className:"empty-state",children:[e.jsx("div",{className:"empty-state-icon",children:e.jsx(c,{name:"fileText",size:36})}),e.jsx("div",{children:d?"No sessions match your filter.":"No sessions found."})]}):e.jsxs("div",{className:"table sessions-table",style:{marginTop:12},children:[e.jsxs("div",{className:"table-head",children:[e.jsx("span",{children:"Session"}),e.jsx("span",{children:"Channel"}),e.jsx("span",{children:"Peer"}),e.jsx("span",{children:"Status"}),e.jsx("span",{children:"In Tokens"}),e.jsx("span",{children:"Out Tokens"}),e.jsx("span",{children:"Updated"}),e.jsx("span",{children:"Actions"})]}),T.map(s=>{const n=I(s);return e.jsxs("div",{className:"table-row",children:[e.jsx("div",{children:D===s.id?e.jsxs("div",{style:{display:"flex",gap:4,alignItems:"center"},children:[e.jsx("input",{type:"text",value:C,onChange:l=>u(l.target.value),onKeyDown:l=>{l.key==="Enter"&&L(s.id),l.key==="Escape"&&S()},autoFocus:!0,style:{flex:1,minWidth:0,padding:"2px 6px",fontSize:13}}),e.jsx("button",{className:"btn btn--sm",onClick:()=>L(s.id),title:"Save",children:e.jsx(c,{name:"check"})}),e.jsx("button",{className:"btn btn--sm",onClick:S,title:"Cancel",children:e.jsx(c,{name:"x"})})]}):e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"session-link",onClick:()=>z(s),children:s.displayName||j(s.id,24)}),(s.tokenCount!=null||s.messageCount!=null)&&e.jsxs("div",{className:"label",style:{marginTop:4},children:[s.messageCount!=null&&e.jsxs("span",{children:[s.messageCount," msgs"]}),s.messageCount!=null&&s.tokenCount!=null&&e.jsx("span",{children:" / "}),s.tokenCount!=null&&e.jsxs("span",{children:[s.tokenCount.toLocaleString()," tokens"]})]})]})}),e.jsx("div",{children:e.jsx("span",{className:"chip",children:s.channelType})}),e.jsx("div",{className:"mono",style:{fontSize:12},children:j(s.peerId,20)}),e.jsx("div",{children:e.jsx("span",{className:"chip "+(s.status==="active"?"chip-ok":s.status==="error"?"chip-danger":"chip-warn"),children:s.status})}),e.jsx("div",{className:"mono",style:{fontSize:12},children:n.input!=null?n.input.toLocaleString():"--"}),e.jsx("div",{className:"mono",style:{fontSize:12},children:n.output!=null?n.output.toLocaleString():"--"}),e.jsx("div",{className:"label",children:w(s.updatedAt)}),e.jsxs("div",{style:{display:"flex",gap:4},children:[e.jsx("button",{className:"btn btn--sm",onClick:()=>P(s),title:"Edit label",children:e.jsx(c,{name:"pencil"})}),e.jsx("button",{className:"btn btn--sm danger",onClick:()=>R(s.id),title:"Delete session",children:e.jsx(c,{name:"trash"})}),e.jsx("button",{className:"btn btn--sm",onClick:()=>A(s.id),title:"Reset session",children:e.jsx(c,{name:"refresh"})}),e.jsx("button",{className:"btn btn--sm",onClick:()=>B(s.id),title:"Compact session",children:e.jsx(c,{name:"minus"})})]})]},s.id)})]})]}),t&&e.jsx("div",{className:"modal-overlay",onClick:x,children:e.jsxs("div",{className:"modal-card",onClick:s=>s.stopPropagation(),children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("div",{className:"modal-title",children:t.displayName||j(t.id,32)}),e.jsx("button",{className:"btn btn--sm",onClick:x,children:e.jsx(c,{name:"x"})})]}),e.jsxs("div",{className:"chip-row",style:{marginBottom:16},children:[e.jsx("span",{className:"chip",children:t.channelType}),e.jsx("span",{className:"chip "+(t.status==="active"?"chip-ok":t.status==="error"?"chip-danger":"chip-warn"),children:t.status}),t.agentId&&e.jsx("span",{className:"chip",children:t.agentId})]}),(t.model||t.thinkingLevel)&&e.jsxs("div",{className:"chip-row",style:{marginBottom:8},children:[t.model&&e.jsxs("span",{className:"chip",children:["Model: ",t.model]}),t.thinkingLevel&&e.jsxs("span",{className:"chip",children:["Thinking: ",t.thinkingLevel]}),t.compactionCount!=null&&t.compactionCount>0&&e.jsxs("span",{className:"chip",children:["Compactions: ",t.compactionCount]})]}),(()=>{const s=I(t);return t.tokenCount!=null||t.messageCount!=null||s.input!=null||s.output!=null?e.jsxs("div",{className:"label",style:{marginBottom:12},children:[t.messageCount!=null&&e.jsxs("span",{children:[t.messageCount," messages"]}),t.messageCount!=null&&t.tokenCount!=null&&e.jsx("span",{children:" / "}),t.tokenCount!=null&&e.jsxs("span",{children:[t.tokenCount.toLocaleString()," tokens"]}),(s.input!=null||s.output!=null)&&e.jsxs("span",{style:{marginLeft:t.tokenCount!=null||t.messageCount!=null?8:0},children:[s.input!=null&&e.jsxs("span",{children:["In: ",s.input.toLocaleString()]}),s.input!=null&&s.output!=null&&e.jsx("span",{children:" / "}),s.output!=null&&e.jsxs("span",{children:["Out: ",s.output.toLocaleString()]})]})]}):null})(),F?e.jsx("div",{className:"empty-state",children:e.jsx("div",{className:"spinner"})}):y.length===0?e.jsx("div",{className:"empty-state",children:e.jsx("div",{children:"No messages in this session."})}):e.jsx("div",{style:{display:"flex",flexDirection:"column",gap:8},children:y.map((s,n)=>e.jsx("div",{className:"chat-line "+(s.role==="user"?"user":"assistant"),children:e.jsxs("div",{className:"chat-msg",children:[e.jsx("div",{className:"chat-bubble",children:e.jsx("div",{className:"chat-text",children:s.content})}),e.jsx("div",{className:"chat-stamp",children:w(s.timestamp)})]})},n))})]})})]})}export{J as SessionsPage};
