import{a as n,j as e,M as U,b as H}from"./markdown-Bs6XdLEX.js";import{c as _}from"./utils-BuvrnUzC.js";import{u as ee,I as S}from"./index-DVYE_7Vo.js";import"./react-vendor-ZmPOmYi1.js";function R(o){if(!o)return"";const l=o.content;return typeof l=="string"?l:Array.isArray(l)?l.filter(u=>u.type==="text").map(u=>u.text).join(""):""}function se(o){const l=[];for(const u of o){const C=l[l.length-1];C&&C.role===u.role?C.messages.push(u):l.push({role:u.role,messages:[u]})}return l}function te(o,l){const u=l?new Date(l):o?new Date(o):null;if(!u)return"";try{return u.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}catch{return""}}function ie({gw:o}){const{toast:l}=ee(),[u,C]=n.useState([]),[d,T]=n.useState(""),[g,M]=n.useState("agent:main:main"),[K,m]=n.useState([]),[E,F]=n.useState(""),[j,L]=n.useState(!1),[I,p]=n.useState(!1),[y,x]=n.useState(""),[b,Y]=n.useState(()=>localStorage.getItem("openbot-chat-focus")==="true"),[A,G]=n.useState("default"),q=n.useRef(null),w=n.useRef(null),v=n.useCallback(async()=>{try{const c=(await o.rpc("sessions.list",{limit:50})).sessions??[];C(c)}catch{}},[o]),P=n.useCallback(async(s,c)=>{if(!s&&!c){m([]);return}try{const i={limit:200};c&&(i.sessionKey=c),s&&(i.sessionId=s);const f=await o.rpc("chat.history",i),t=(f.messages??[]).map(a=>{const h=typeof a.content=="string"?a.content:R(a);return{role:a.role,content:h,timestamp:a.timestamp,createdAt:a.createdAt,stopReason:a.stopReason}});m(t),f.sessionId&&!s&&T(f.sessionId)}catch{m([])}},[o]);n.useEffect(()=>{v()},[v]),n.useEffect(()=>{P(d,g)},[d,g,P]),n.useEffect(()=>{var s;(s=q.current)==null||s.scrollIntoView({behavior:"smooth"})},[K,j,I,y]),n.useEffect(()=>{const s=document.querySelector(".shell");return s&&(b?s.classList.add("shell--chat-focus"):s.classList.remove("shell--chat-focus")),localStorage.setItem("openbot-chat-focus",String(b)),()=>{const c=document.querySelector(".shell");c&&c.classList.remove("shell--chat-focus")}},[b]);const V=n.useCallback(s=>{F(s.target.value);const c=s.target;c.style.height="auto",c.style.height=Math.min(c.scrollHeight,150)+"px"},[]),B=n.useCallback(()=>{Y(s=>!s)},[]),J=n.useCallback(s=>{G(s.target.value)},[]);n.useEffect(()=>{const s=o.on("event:chat",r=>{const t=r;if(t&&!(t.sessionKey&&t.sessionKey!==g))switch(t.state){case"delta":{const a=R(t.message);a&&(x(a),p(!0));break}case"final":{const a=t.message;if(a){const h=R(a),N=a.role||"assistant";h&&m(k=>{const D=k[k.length-1];return D&&D.role===N&&D.content===h?k:[...k,{role:N,content:h,timestamp:a.timestamp,stopReason:a.stopReason}]})}x(""),p(!1);break}case"aborted":x(""),p(!1);break;case"error":{x(""),p(!1);const a=t.errorMessage||"Chat request failed";m(h=>[...h,{role:"assistant",content:`Error: ${a}`}]);break}}}),c=o.on("event:chat.message",r=>{const t=r;t!=null&&t.message&&(t.sessionId===d||!d)&&m(a=>t.message.id&&a.some(h=>h.id===t.message.id)?a:[...a,t.message])}),i=o.on("event:chat.typing",r=>{const t=r;((t==null?void 0:t.sessionId)===d||!d)&&p(!0)}),f=o.on("event:chat.done",r=>{const t=r;((t==null?void 0:t.sessionId)===d||!d)&&p(!1)});return()=>{s(),c(),i(),f()}},[o,d,g]);const $=n.useCallback(async()=>{var f;const s=E.trim();if(!s||j)return;const c={role:"user",content:s,timestamp:Date.now()};m(r=>[...r,c]),F(""),L(!0),p(!0),w.current&&(w.current.style.height="auto");const i=crypto.randomUUID();try{const r={sessionKey:g,message:s,idempotencyKey:i,agentId:"main"};A!=="default"&&(r.thinkingLevel=A);const t=await o.rpc("chat.send",r);t.sessionId&&!d&&(T(t.sessionId),v());const a=t.content??"";a&&m(h=>{if(t.messageId&&h.some(k=>k.id===t.messageId))return h;const N=h[h.length-1];return N&&N.role==="assistant"&&N.content===a?h:[...h,{id:t.messageId,role:"assistant",content:a}]})}catch(r){const t={role:"assistant",content:`Error: ${r instanceof Error?r.message:"unknown error"}`};m(a=>[...a,t])}finally{L(!1),p(!1),x(""),(f=w.current)==null||f.focus()}},[E,j,o,d,g,v,A]),O=n.useCallback(async()=>{try{await o.rpc("chat.abort",{sessionKey:g})}catch{}p(!1),L(!1),x("")},[o,g]),Q=n.useCallback(async()=>{var s;try{await o.rpc("chat.new",{agentId:"main"})}catch{}T(""),M("agent:main:main"),m([]),x(""),v(),(s=w.current)==null||s.focus()},[o,v]),W=n.useCallback(s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),$())},[$]),X=n.useCallback(async s=>{try{await _(s),l("Copied!","success")}catch{l("Failed to copy","error")}},[l]),Z=n.useCallback(s=>{const c=s.target.value;m([]),x(""),T(c),M(c?"agent:main:"+c:"agent:main:main")},[]),z=se(K);return e.jsxs("div",{className:"chat-page",children:[e.jsxs("div",{className:"chat-session-bar",children:[e.jsx("label",{htmlFor:"session-select",children:"Session:"}),e.jsxs("select",{id:"session-select",value:d,onChange:Z,children:[e.jsx("option",{value:"",children:"New conversation"}),u.map(s=>e.jsxs("option",{value:s.id,children:[s.displayName||s.title||s.id,s.channelType&&s.channelType!=="webhook"?` [${s.channelType}]`:""]},s.id))]}),e.jsxs("button",{className:"btn btn--sm chat-new-btn",onClick:Q,title:"Start a new conversation",children:[e.jsx(S,{name:"plus",size:14}),e.jsx("span",{children:"New"})]}),e.jsxs("select",{className:"chat-thinking-select",value:A,onChange:J,title:"Thinking level",children:[e.jsx("option",{value:"default",children:"Thinking: Default"}),e.jsx("option",{value:"low",children:"Thinking: Low"}),e.jsx("option",{value:"medium",children:"Thinking: Medium"}),e.jsx("option",{value:"high",children:"Thinking: High"})]}),e.jsxs("button",{className:`chat-focus-btn${b?" active":""}`,onClick:B,title:b?"Exit focus mode":"Enter focus mode",children:[e.jsx(S,{name:b?"minimize":"maximize",size:14}),e.jsx("span",{children:b?"Unfocus":"Focus"})]})]}),e.jsxs("div",{className:"chat-messages",children:[z.length===0&&!j&&!y&&e.jsxs("div",{className:"chat-empty",children:[e.jsx(S,{name:"messageSquare",size:48}),e.jsx("p",{children:"No messages yet. Start a conversation below."})]}),z.map((s,c)=>e.jsxs("div",{className:`chat-group chat-group--${s.role}`,children:[e.jsx("div",{className:"chat-group-label",children:s.role==="user"?"You":"Assistant"}),e.jsxs("div",{className:"chat-group-row",children:[e.jsx("div",{className:`chat-avatar ${s.role}`,children:s.role==="user"?"Y":"AI"}),e.jsx("div",{className:"chat-group-content",children:s.messages.map((i,f)=>{const r=I&&!y&&i.role==="assistant"&&c===z.length-1&&f===s.messages.length-1;return e.jsxs("div",{className:"chat-bubble-wrapper",children:[e.jsxs("div",{className:`chat-bubble chat-bubble--${i.role}${r?" streaming":""}`,children:[i.role==="assistant"?e.jsx(U,{remarkPlugins:[H],children:i.content}):e.jsx("span",{children:i.content}),e.jsx("button",{className:"chat-copy-btn",onClick:()=>X(i.content),title:"Copy to clipboard",children:e.jsx(S,{name:"copy",size:14})})]}),(i.createdAt||i.timestamp)&&e.jsx("div",{className:"chat-stamp",children:te(i.createdAt,i.timestamp)})]},i.id||`${c}-${f}`)})})]})]},c)),I&&y&&e.jsxs("div",{className:"chat-group chat-group--assistant",children:[e.jsx("div",{className:"chat-group-label",children:"Assistant"}),e.jsxs("div",{className:"chat-group-row",children:[e.jsx("div",{className:"chat-avatar assistant",children:"AI"}),e.jsx("div",{className:"chat-group-content",children:e.jsx("div",{className:"chat-bubble-wrapper",children:e.jsx("div",{className:"chat-bubble chat-bubble--assistant streaming",children:e.jsx(U,{remarkPlugins:[H],children:y})})})})]})]}),I&&!y&&K.length>0&&e.jsxs("div",{className:"chat-group chat-group--assistant",children:[e.jsx("div",{className:"chat-group-label",children:"Assistant"}),e.jsxs("div",{className:"chat-group-row",children:[e.jsx("div",{className:"chat-avatar assistant",children:"AI"}),e.jsx("div",{className:"chat-group-content",children:e.jsx("div",{className:"chat-bubble-wrapper",children:e.jsx("div",{className:"chat-bubble streaming",children:e.jsxs("span",{className:"chat-reading-dots",children:[e.jsx("span",{}),e.jsx("span",{}),e.jsx("span",{})]})})})})]})]}),e.jsx("div",{ref:q})]}),e.jsxs("div",{className:"chat-input-bar",children:[e.jsx("textarea",{ref:w,className:"chat-textarea",value:E,onChange:V,onKeyDown:W,placeholder:"Type a message... (Enter to send, Shift+Enter for newline)",rows:1,disabled:j}),I?e.jsxs("button",{className:"chat-send-btn chat-abort-btn",onClick:O,title:"Stop generation",children:[e.jsx(S,{name:"x",size:18}),e.jsx("span",{children:"Stop"})]}):e.jsx("button",{className:"chat-send-btn",onClick:$,disabled:j||!E.trim(),title:"Send message",children:e.jsx(S,{name:"send",size:18})})]})]})}export{ie as ChatPage};
