<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>OpenBot Control</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
/* === OpenClaw Design System === */
:root {
  --bg: #12141a;
  --bg-accent: #14161d;
  --bg-elevated: #1a1d25;
  --bg-hover: #262a35;
  --bg-muted: #262a35;
  --card: #181b22;
  --card-foreground: #f4f4f5;
  --card-highlight: rgba(255,255,255,0.05);
  --panel: #12141a;
  --text: #e4e4e7;
  --text-strong: #fafafa;
  --muted: #71717a;
  --muted-strong: #52525b;
  --border: #27272a;
  --border-strong: #3f3f46;
  --border-hover: #52525b;
  --input: #27272a;
  --ring: #ff5c5c;
  --accent: #ff5c5c;
  --accent-hover: #ff7070;
  --accent-subtle: rgba(255,92,92,0.15);
  --accent-foreground: #fafafa;
  --accent-glow: rgba(255,92,92,0.25);
  --primary: #ff5c5c;
  --primary-foreground: #ffffff;
  --secondary: #1e2028;
  --secondary-foreground: #f4f4f5;
  --ok: #22c55e;
  --ok-subtle: rgba(34,197,94,0.12);
  --warn: #f59e0b;
  --warn-subtle: rgba(245,158,11,0.12);
  --danger: #ef4444;
  --danger-subtle: rgba(239,68,68,0.12);
  --info: #3b82f6;
  --font-body: "Space Grotesk",-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
  --mono: "JetBrains Mono",ui-monospace,SFMono-Regular,"SF Mono",Menlo,Monaco,Consolas,monospace;
  --shadow-sm: 0 1px 2px rgba(0,0,0,0.2);
  --shadow-md: 0 4px 12px rgba(0,0,0,0.25),0 0 0 1px rgba(255,255,255,0.03);
  --shadow-lg: 0 12px 28px rgba(0,0,0,0.35);
  --radius-sm: 6px;
  --radius-md: 8px;
  --radius-lg: 12px;
  --radius-xl: 16px;
  --radius-full: 9999px;
  --ease-out: cubic-bezier(0.16,1,0.3,1);
  --ease-spring: cubic-bezier(0.34,1.56,0.64,1);
  --duration-fast: 120ms;
  --duration-normal: 200ms;
  color-scheme: dark;
}
*,*::before,*::after{box-sizing:border-box}
html,body{height:100%;margin:0}
body{font:400 14px/1.55 var(--font-body);letter-spacing:-0.02em;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
a{color:var(--accent);text-decoration:none}
a:hover{text-decoration:underline}
button,input,textarea,select{font:inherit;color:inherit}
::selection{background:var(--accent-subtle);color:var(--text-strong)}
::-webkit-scrollbar{width:8px;height:8px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:var(--radius-full)}
::-webkit-scrollbar-thumb:hover{background:var(--border-strong)}

@keyframes rise{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
@keyframes fade-in{from{opacity:0}to{opacity:1}}
@keyframes pulse-subtle{0%,100%{opacity:1}50%{opacity:0.7}}
@keyframes dashboard-enter{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes chatReadingDot{0%,80%,100%{opacity:0.4;transform:translateY(0)}40%{opacity:1;transform:translateY(-3px)}}

/* Shell */
.shell{height:100vh;display:grid;grid-template-columns:220px minmax(0,1fr);grid-template-rows:56px 1fr;grid-template-areas:"topbar topbar" "nav content";gap:0;animation:dashboard-enter 0.4s var(--ease-out);overflow:hidden}
@supports(height:100dvh){.shell{height:100dvh}}
.shell--chat{min-height:100vh;height:100vh;overflow:hidden}

/* Topbar */
.topbar{grid-area:topbar;position:sticky;top:0;z-index:40;display:flex;justify-content:space-between;align-items:center;gap:16px;padding:0 20px;height:56px;border-bottom:1px solid var(--border);background:var(--bg)}
.topbar-left{display:flex;align-items:center;gap:12px}
.brand{display:flex;align-items:center;gap:10px}
.brand-text{display:flex;flex-direction:column;gap:1px}
.brand-title{font-size:16px;font-weight:700;letter-spacing:-0.03em;line-height:1.1;color:var(--text-strong)}
.brand-sub{font-size:10px;font-weight:500;color:var(--muted);letter-spacing:0.05em;text-transform:uppercase;line-height:1}
.topbar-status{display:flex;align-items:center;gap:8px}

/* Nav */
.nav{grid-area:nav;overflow-y:auto;overflow-x:hidden;padding:16px 12px;background:var(--bg);scrollbar-width:none;min-height:0}
.nav::-webkit-scrollbar{display:none}
.nav-group{margin-bottom:20px;display:grid;gap:2px}
.nav-group:last-child{margin-bottom:0}
.nav-group__items{display:grid;gap:1px}
.nav-label{display:flex;align-items:center;gap:8px;width:100%;padding:6px 10px;font-size:11px;font-weight:500;color:var(--muted);margin-bottom:4px;background:transparent;border:none;cursor:default;text-align:left;border-radius:var(--radius-sm)}
.nav-item{position:relative;display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:var(--radius-md);border:1px solid transparent;background:transparent;color:var(--muted);cursor:pointer;text-decoration:none;transition:border-color var(--duration-fast) ease,background var(--duration-fast) ease,color var(--duration-fast) ease;width:100%;text-align:left;font-size:13px;font-weight:500}
.nav-item:hover{color:var(--text);background:var(--bg-hover);text-decoration:none}
.nav-item.active{color:var(--text-strong);background:var(--accent-subtle)}
.nav-item.active .nav-icon{color:var(--accent)}
.nav-icon{width:16px;height:16px;display:flex;align-items:center;justify-content:center;flex-shrink:0;opacity:0.7}
.nav-item:hover .nav-icon,.nav-item.active .nav-icon{opacity:1}
.nav-icon svg{width:16px;height:16px;stroke:currentColor;fill:none;stroke-width:1.5px;stroke-linecap:round;stroke-linejoin:round}

/* Content */
.content{grid-area:content;padding:12px 16px 32px;display:flex;flex-direction:column;gap:24px;min-height:0;overflow-y:auto;overflow-x:hidden}
.content--chat{overflow:hidden;padding-bottom:0}
.content-header{display:flex;align-items:flex-end;justify-content:space-between;gap:16px;padding:4px 8px}
.page-title{font-size:26px;font-weight:700;letter-spacing:-0.035em;line-height:1.15;color:var(--text-strong)}
.page-sub{color:var(--muted);font-size:14px;font-weight:400;margin-top:6px;letter-spacing:-0.01em}
.page-meta{display:flex;gap:8px}

/* Cards */
.card{border:1px solid var(--border);background:var(--card);border-radius:var(--radius-lg);padding:20px;animation:rise 0.35s var(--ease-out) backwards;transition:border-color var(--duration-normal) var(--ease-out),box-shadow var(--duration-normal) var(--ease-out);box-shadow:var(--shadow-sm),inset 0 1px 0 var(--card-highlight)}
.card:hover{border-color:var(--border-strong)}
.card-title{font-size:15px;font-weight:600;letter-spacing:-0.02em;color:var(--text-strong)}
.card-sub{color:var(--muted);font-size:13px;margin-top:6px;line-height:1.5}

/* Stats */
.stat{background:var(--card);border-radius:var(--radius-md);padding:14px 16px;border:1px solid var(--border);box-shadow:inset 0 1px 0 var(--card-highlight);transition:border-color var(--duration-normal) var(--ease-out)}
.stat:hover{border-color:var(--border-strong)}
.stat-label{color:var(--muted);font-size:11px;font-weight:500;text-transform:uppercase;letter-spacing:0.04em}
.stat-value{font-size:24px;font-weight:700;margin-top:6px;letter-spacing:-0.03em;line-height:1.1}
.stat-value.ok{color:var(--ok)}
.stat-value.warn{color:var(--warn)}
.stat-grid{display:grid;gap:14px;grid-template-columns:repeat(auto-fit,minmax(150px,1fr))}
.stat-card{display:grid;gap:6px}

/* Grids */
.grid{display:grid;gap:20px}
.grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
.grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
.row{display:flex;gap:12px;align-items:center}
.stack{display:grid;gap:12px;grid-template-columns:minmax(0,1fr)}
.filters{display:flex;flex-wrap:wrap;gap:8px;align-items:center}

/* Buttons */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;border:1px solid var(--border);background:var(--bg-elevated);padding:9px 16px;border-radius:var(--radius-md);font-size:13px;font-weight:500;letter-spacing:-0.01em;cursor:pointer;transition:border-color var(--duration-fast) var(--ease-out),background var(--duration-fast) var(--ease-out),box-shadow var(--duration-fast) var(--ease-out),transform var(--duration-fast) var(--ease-out)}
.btn:hover{background:var(--bg-hover);border-color:var(--border-strong);transform:translateY(-1px);box-shadow:var(--shadow-sm)}
.btn:active{transform:translateY(0);box-shadow:none}
.btn:disabled{opacity:0.5;cursor:not-allowed;transform:none}
.btn.primary{border-color:var(--accent);background:var(--accent);color:var(--primary-foreground);box-shadow:0 1px 2px rgba(0,0,0,0.2)}
.btn.primary:hover{background:var(--accent-hover);border-color:var(--accent-hover);box-shadow:var(--shadow-md),0 0 20px var(--accent-glow)}
.btn.danger{border-color:transparent;background:var(--danger-subtle);color:var(--danger)}
.btn.danger:hover{background:rgba(239,68,68,0.15)}
.btn--sm{padding:6px 10px;font-size:12px}
.btn svg{width:16px;height:16px;stroke:currentColor;fill:none;stroke-width:1.5;stroke-linecap:round;stroke-linejoin:round;flex-shrink:0}

/* Pills */
.pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);padding:6px 12px;border-radius:var(--radius-full);background:var(--secondary);font-size:13px;font-weight:500;transition:border-color var(--duration-fast) ease}
.pill:hover{border-color:var(--border-strong)}

/* Status dot */
.statusDot{width:8px;height:8px;border-radius:var(--radius-full);background:var(--danger);box-shadow:0 0 8px rgba(239,68,68,0.5);animation:pulse-subtle 2s ease-in-out infinite}
.statusDot.ok{background:var(--ok);box-shadow:0 0 8px rgba(34,197,94,0.5);animation:none}

/* Form fields */
.field{display:grid;gap:6px}
.field span{color:var(--muted);font-size:13px;font-weight:500}
.field input,.field textarea,.field select{border:1px solid var(--input);background:var(--card);border-radius:var(--radius-md);padding:8px 12px;outline:none;box-shadow:inset 0 1px 0 var(--card-highlight);transition:border-color var(--duration-fast) ease,box-shadow var(--duration-fast) ease}
.field input:focus,.field textarea:focus,.field select:focus{border-color:var(--ring);box-shadow:0 0 0 2px var(--bg),0 0 0 4px var(--ring)}
.field textarea{font-family:var(--mono);min-height:120px;resize:vertical;white-space:pre;line-height:1.5}
.field select{appearance:none;padding-right:36px;cursor:pointer}
.form-grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(200px,1fr))}

/* Lists */
.list{display:grid;gap:8px;container-type:inline-size}
.list-item{display:grid;grid-template-columns:minmax(0,1fr) minmax(200px,260px);gap:16px;align-items:start;border:1px solid var(--border);border-radius:var(--radius-md);padding:12px;background:var(--card);transition:border-color var(--duration-fast) ease}
.list-item:hover{border-color:var(--border-strong)}
.list-main{display:grid;gap:4px;min-width:0}
.list-title{font-weight:500}
.list-sub{color:var(--muted);font-size:12px}
.list-meta{text-align:right;color:var(--muted);font-size:12px;display:grid;gap:4px;min-width:200px}

/* Chips */
.chip-row{display:flex;flex-wrap:wrap;gap:8px}
.chip{font-size:12px;font-weight:500;border:1px solid var(--border);border-radius:var(--radius-full);padding:5px 12px;color:var(--muted);background:var(--secondary);transition:border-color var(--duration-fast) var(--ease-out)}
.chip:hover{border-color:var(--border-strong)}
.chip-ok{color:var(--ok);border-color:rgba(34,197,94,0.3);background:var(--ok-subtle)}
.chip-warn{color:var(--warn);border-color:rgba(245,158,11,0.3);background:var(--warn-subtle)}
.chip-danger{color:var(--danger);border-color:rgba(239,68,68,0.3);background:var(--danger-subtle)}
.chip input{margin-right:6px}

/* Tables */
.table{display:grid;gap:6px}
.table-head,.table-row{display:grid;gap:12px;align-items:center}
.table-head{font-size:12px;font-weight:500;color:var(--muted);padding:0 12px}
.table-row{border:1px solid var(--border);padding:10px 12px;border-radius:var(--radius-md);background:var(--card);transition:border-color var(--duration-fast) ease}
.table-row:hover{border-color:var(--border-strong)}

/* Log stream */
.log-stream{border:1px solid var(--border);border-radius:var(--radius-md);background:var(--card);max-height:500px;overflow:auto}
.log-row{display:grid;grid-template-columns:90px 70px minmax(140px,200px) minmax(0,1fr);gap:12px;align-items:start;padding:8px 12px;border-bottom:1px solid var(--border);font-size:12px;transition:background var(--duration-fast) ease}
.log-row:hover{background:var(--bg-hover)}
.log-row:last-child{border-bottom:none}
.log-time{color:var(--muted);font-family:var(--mono)}
.log-level{font-size:11px;font-weight:500;border:1px solid var(--border);border-radius:var(--radius-sm);padding:2px 6px;width:fit-content}
.log-level.info{color:var(--info);border-color:rgba(59,130,246,0.3)}
.log-level.warn{color:var(--warn);border-color:var(--warn-subtle)}
.log-level.error,.log-level.fatal{color:var(--danger);border-color:var(--danger-subtle)}
.log-level.debug,.log-level.trace{color:var(--muted)}
.log-subsystem{color:var(--muted);font-family:var(--mono)}
.log-message{white-space:pre-wrap;word-break:break-word;font-family:var(--mono)}

/* Callouts */
.callout{padding:14px 16px;border-radius:var(--radius-md);background:var(--secondary);border:1px solid var(--border);font-size:13px;line-height:1.5}
.callout.danger{border-color:rgba(239,68,68,0.25);background:linear-gradient(135deg,rgba(239,68,68,0.08) 0%,rgba(239,68,68,0.04) 100%);color:var(--danger)}
.callout.info{border-color:rgba(59,130,246,0.25);background:linear-gradient(135deg,rgba(59,130,246,0.08) 0%,rgba(59,130,246,0.04) 100%);color:var(--info)}
.callout.success{border-color:rgba(34,197,94,0.25);background:linear-gradient(135deg,rgba(34,197,94,0.08) 0%,rgba(34,197,94,0.04) 100%);color:var(--ok)}

/* Code block */
.code-block{font-family:var(--mono);font-size:13px;line-height:1.5;background:var(--secondary);padding:12px;border-radius:var(--radius-md);border:1px solid var(--border);max-height:360px;overflow:auto;white-space:pre-wrap;word-break:break-word}
.mono{font-family:var(--mono)}
.label{color:var(--muted);font-size:12px;font-weight:500}

/* Chat */
.chat{display:flex;flex-direction:column;min-height:0;flex:1}
.chat-thread{display:flex;flex-direction:column;gap:12px;flex:1;min-height:0;overflow-y:auto;overflow-x:hidden;padding:16px 12px;min-width:0}
.chat-line{display:flex}
.chat-line.user{justify-content:flex-end}
.chat-line.assistant{justify-content:flex-start}
.chat-msg{display:grid;gap:6px;max-width:min(700px,82%)}
.chat-line.user .chat-msg{justify-items:end}
.chat-bubble{border:1px solid transparent;background:var(--card);border-radius:var(--radius-lg);padding:10px 14px;min-width:0}
.chat-line.user .chat-bubble{background:var(--accent-subtle)}
.chat-line.assistant .chat-bubble{background:var(--secondary)}
.chat-text{overflow-wrap:anywhere;word-break:break-word;color:var(--text);line-height:1.5}
.chat-text pre{margin-top:0.75em;padding:10px 12px;border-radius:var(--radius-md);border:1px solid var(--border);background:var(--secondary);overflow:auto}
.chat-text code{font-family:var(--mono);font-size:0.9em}
.chat-text :not(pre)>code{padding:0.15em 0.35em;border-radius:var(--radius-sm);border:1px solid var(--border);background:var(--secondary)}
.chat-stamp{font-size:11px;color:var(--muted)}
.chat-line.user .chat-stamp{text-align:right}
.chat-compose{margin-top:12px;display:flex;flex-direction:column;gap:10px;position:sticky;bottom:0;z-index:5;padding-top:12px;background:linear-gradient(180deg,transparent 0%,var(--bg) 40%)}
.chat-compose textarea{min-height:72px;padding:10px 14px;border-radius:var(--radius-lg);resize:vertical;font-family:var(--font-body);line-height:1.5;border:1px solid var(--input);background:var(--card);box-shadow:inset 0 1px 0 var(--card-highlight);outline:none;width:100%;transition:border-color var(--duration-fast) ease}
.chat-compose textarea:focus{border-color:var(--ring);box-shadow:0 0 0 2px var(--bg),0 0 0 4px var(--ring)}
.chat-compose .row{justify-content:flex-end}

/* Config layout */
.config-layout{display:grid;grid-template-columns:260px minmax(0,1fr);gap:0;height:calc(100vh - 160px);margin:-16px;border-radius:var(--radius-xl);overflow:hidden;border:1px solid var(--border);background:var(--panel)}
.config-sidebar{display:flex;flex-direction:column;background:var(--bg-accent);border-right:1px solid var(--border);min-height:0;overflow:hidden}
.config-sidebar__header{display:flex;align-items:center;justify-content:space-between;padding:18px;border-bottom:1px solid var(--border)}
.config-sidebar__title{font-weight:600;font-size:14px}
.config-nav{flex:1;overflow-y:auto;padding:10px}
.config-nav__item{display:flex;align-items:center;gap:12px;width:100%;padding:11px 14px;border:none;border-radius:var(--radius-md);background:transparent;color:var(--muted);font-size:13px;font-weight:500;text-align:left;cursor:pointer;transition:background var(--duration-fast) ease,color var(--duration-fast) ease}
.config-nav__item:hover{background:var(--bg-hover);color:var(--text)}
.config-nav__item.active{background:var(--accent-subtle);color:var(--accent)}
.config-main{display:flex;flex-direction:column;min-height:0;min-width:0;background:var(--panel);overflow:hidden}
.config-actions{display:flex;align-items:center;justify-content:space-between;gap:14px;padding:14px 22px;background:var(--bg-accent);border-bottom:1px solid var(--border)}
.config-content{flex:1;overflow-y:auto;padding:22px}

/* Reading indicator */
.reading-dots{display:inline-flex;align-items:center;gap:4px;height:12px}
.reading-dots span{display:inline-block;width:6px;height:6px;border-radius:var(--radius-full);background:var(--muted);opacity:0.6;animation:chatReadingDot 1.2s ease-in-out infinite}
.reading-dots span:nth-child(2){animation-delay:0.15s}
.reading-dots span:nth-child(3){animation-delay:0.3s}

/* Session table columns */
.sessions-table .table-head,.sessions-table .table-row{grid-template-columns:1.4fr 1fr 0.8fr 0.8fr 0.8fr 0.6fr}
.session-link{text-decoration:none;color:var(--accent);font-weight:500;cursor:pointer;background:none;border:none;padding:0;font:inherit;text-align:left}
.session-link:hover{text-decoration:underline}

/* Responsive */
@media(max-width:1100px){
  .shell{grid-template-columns:1fr;grid-template-rows:auto auto 1fr;grid-template-areas:"topbar" "nav" "content"}
  .nav{position:static;display:flex;gap:6px;overflow-x:auto;border-bottom:1px solid var(--border);padding:10px 14px}
  .nav-group{grid-auto-flow:column;margin-bottom:0}
  .grid-cols-2,.grid-cols-3{grid-template-columns:1fr}
  .sessions-table .table-head,.sessions-table .table-row{grid-template-columns:1fr}
  .config-layout{grid-template-columns:1fr}
}

/* Empty state */
.empty-state{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;padding:48px 24px;color:var(--muted);text-align:center}
.empty-state-icon{font-size:36px;opacity:0.4}

/* Loading spinner */
.spinner{width:32px;height:32px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:var(--radius-full);animation:spin 0.75s linear infinite}

/* Status list */
.status-list{display:grid;gap:8px}
.status-list div{display:flex;justify-content:space-between;gap:12px;padding:8px 0;border-bottom:1px solid var(--border)}
.status-list div:last-child{border-bottom:none}

/* Session preview modal */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;padding:24px;z-index:200}
.modal-card{width:min(640px,100%);max-height:80vh;background:var(--card);border:1px solid var(--border);border-radius:var(--radius-lg);padding:20px;overflow-y:auto;animation:rise 0.2s var(--ease-out)}
.modal-header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:16px}
.modal-title{font-size:16px;font-weight:600;color:var(--text-strong)}
</style>
</head>
<body>
<div id="root"></div>
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script>
"use strict";
const { useState, useEffect, useRef, useCallback, useMemo, Fragment } = React;
const h = React.createElement;

// ===================== Gateway WebSocket Client =====================

class Gateway {
  constructor() {
    this.ws = null;
    this.connected = false;
    this.hello = null;
    this._rid = 0;
    this._pending = {};
    this._handlers = {};
  }

  connect(url) {
    return new Promise((resolve, reject) => {
      try { this.ws = new WebSocket(url); } catch(e) { reject(e); return; }
      this.ws.onopen = () => {
        this.ws.send(JSON.stringify({ type: "hello", token: "" }));
      };
      this.ws.onmessage = (evt) => {
        let msg;
        try { msg = JSON.parse(evt.data); } catch(e) { return; }
        if (msg.type === "hello-ok") {
          this.connected = true;
          this.hello = msg;
          this._emit("connected", msg);
          resolve(msg);
          return;
        }
        if (msg.type === "hello-error") {
          reject(new Error(msg.error || "auth failed"));
          return;
        }
        if (msg.type === "event") {
          this._emit("event", msg);
          this._emit("event:" + msg.event, msg.payload);
          return;
        }
        if (msg.id && this._pending[msg.id]) {
          const { resolve: res, reject: rej } = this._pending[msg.id];
          delete this._pending[msg.id];
          if (msg.error) rej(new Error(msg.error));
          else res(msg.result);
        }
      };
      this.ws.onclose = () => {
        this.connected = false;
        this._emit("disconnected");
      };
      this.ws.onerror = () => {
        this.connected = false;
        reject(new Error("connection failed"));
      };
    });
  }

  rpc(method, params) {
    return new Promise((resolve, reject) => {
      if (!this.ws || this.ws.readyState !== 1) {
        reject(new Error("not connected"));
        return;
      }
      const id = "r-" + (++this._rid);
      this._pending[id] = { resolve, reject };
      this.ws.send(JSON.stringify({ id, method, params: params || {} }));
      setTimeout(() => {
        if (this._pending[id]) {
          delete this._pending[id];
          reject(new Error("timeout"));
        }
      }, 15000);
    });
  }

  on(event, handler) {
    if (!this._handlers[event]) this._handlers[event] = [];
    this._handlers[event].push(handler);
    return () => {
      this._handlers[event] = this._handlers[event].filter(h => h !== handler);
    };
  }

  _emit(event, data) {
    (this._handlers[event] || []).forEach(h => h(data));
  }

  close() {
    if (this.ws) this.ws.close();
  }
}

// ===================== Icons (Lucide-based SVGs) =====================

function Icon({ name, size }) {
  const s = size || 16;
  const paths = {
    messageSquare: "M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z",
    barChart: "M12 20V10M18 20V4M6 20v-4",
    link: "M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71",
    radio: "M12 12m-2 0a2 2 0 1 0 4 0a2 2 0 1 0-4 0M16.24 7.76a6 6 0 0 1 0 8.49m-8.48-.01a6 6 0 0 1 0-8.49m11.31-2.82a10 10 0 0 1 0 14.14m-14.14 0a10 10 0 0 1 0-14.14",
    fileText: "M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8zM14 2v6h6M16 13H8M16 17H8M10 9H8",
    loader: "M12 2v4m0 12v4m-7.07-15.07 2.83 2.83m8.48 8.48 2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48 2.83-2.83",
    zap: "M13 2 3 14h9l-1 8 10-12h-9l1-8z",
    monitor: "M2 3h20v14H2zM8 21h8M12 17v4",
    settings: "M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2zM12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6z",
    bug: "m8 2 1.88 1.88M14.12 3.88 16 2M9 7.13v-1a3.003 3.003 0 1 1 6 0v1M12 20c-3.3 0-6-2.7-6-6v-3a4 4 0 0 1 4-4h4a4 4 0 0 1 4 4v3c0 3.3-2.7 6-6 6M12 20v-9M6.53 9C4.6 8.8 3 7.1 3 5M6 13H2M22 13h-4M17.47 9c1.93-.2 3.53-1.9 3.53-4M9.5 16a.5.5 0 1 0 1 0 .5.5 0 0 0-1 0M13.5 16a.5.5 0 1 0 1 0 .5.5 0 0 0-1 0",
    scrollText: "M8 21h12a2 2 0 0 0 2-2v-2H10v2a2 2 0 1 1-4 0V5a2 2 0 1 0-4 0v3h4M19 17V5a2 2 0 0 0-2-2H4M15 8h-5M15 12h-5",
    refresh: "M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8M21 3v5h-5M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16M3 21v-5h5",
    x: "M18 6 6 18M6 6l12 12",
    play: "m5 3 14 9-14 9V3z",
    trash: "M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2",
    plus: "M12 5v14M5 12h14",
    send: "m22 2-7 20-4-9-9-4z",
    eye: "M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7z M12 12m-3 0a3 3 0 1 0 6 0 3 3 0 1 0-6 0",
    folder: "M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z",
    search: "M11 11m-8 0a8 8 0 1 0 16 0 8 8 0 1 0-16 0M21 21l-4.35-4.35",
    save: "M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2zM17 21v-8H7v8M7 3v5h8",
  };
  const d = paths[name] || paths.folder;
  return h("svg", { width: s, height: s, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "1.5", strokeLinecap: "round", strokeLinejoin: "round" },
    d.split(/(?=[Mm])/).filter(Boolean).map((seg, i) => h("path", { key: i, d: seg.trim() }))
  );
}

// ===================== Navigation Config =====================

const TAB_GROUPS = [
  { label: "Chat", tabs: ["chat"] },
  { label: "Control", tabs: ["overview", "channels", "instances", "sessions", "cron"] },
  { label: "Agent", tabs: ["skills", "nodes"] },
  { label: "Settings", tabs: ["config", "debug", "logs"] },
];

const TAB_META = {
  chat:      { title: "Chat", sub: "Direct gateway chat session for quick interventions.", icon: "messageSquare" },
  overview:  { title: "Overview", sub: "Gateway status, entry points, and a fast health read.", icon: "barChart" },
  channels:  { title: "Channels", sub: "Manage channels and settings.", icon: "link" },
  instances: { title: "Instances", sub: "Presence beacons from connected clients and nodes.", icon: "radio" },
  sessions:  { title: "Sessions", sub: "Inspect active sessions and adjust per-session defaults.", icon: "fileText" },
  cron:      { title: "Cron Jobs", sub: "Schedule wakeups and recurring agent runs.", icon: "loader" },
  skills:    { title: "Skills", sub: "Manage skill availability and API key injection.", icon: "zap" },
  nodes:     { title: "Nodes", sub: "Paired devices, capabilities, and command exposure.", icon: "monitor" },
  config:    { title: "Config", sub: "Edit configuration safely.", icon: "settings" },
  debug:     { title: "Debug", sub: "Gateway snapshots, events, and manual RPC calls.", icon: "bug" },
  logs:      { title: "Logs", sub: "Live tail of the gateway logs.", icon: "scrollText" },
};

// ===================== Utility Functions =====================

function formatAgo(ts) {
  if (!ts) return "n/a";
  const d = new Date(ts);
  if (isNaN(d.getTime())) return "n/a";
  const sec = Math.floor((Date.now() - d.getTime()) / 1000);
  if (sec < 60) return sec + "s ago";
  if (sec < 3600) return Math.floor(sec/60) + "m ago";
  if (sec < 86400) return Math.floor(sec/3600) + "h ago";
  return Math.floor(sec/86400) + "d ago";
}

function formatTime(ts) {
  if (!ts) return "";
  const d = new Date(ts);
  if (isNaN(d.getTime())) return ts;
  return d.toLocaleTimeString();
}

function truncate(s, n) {
  if (!s) return "";
  return s.length > n ? s.slice(0, n) + "..." : s;
}

// ===================== Topbar Component =====================

function Topbar({ connected }) {
  return h("div", { className: "topbar" },
    h("div", { className: "topbar-left" },
      h("div", { className: "brand" },
        h("div", { className: "brand-text" },
          h("div", { className: "brand-title" }, "OpenBot"),
          h("div", { className: "brand-sub" }, "Control Dashboard")
        )
      )
    ),
    h("div", { className: "topbar-status" },
      h("div", { className: "pill" },
        h("span", { className: "statusDot" + (connected ? " ok" : "") }),
        h("span", { className: "mono" }, connected ? "Connected" : "Disconnected")
      )
    )
  );
}

// ===================== Nav Component =====================

function Nav({ tab, onNavigate }) {
  return h("nav", { className: "nav" },
    TAB_GROUPS.map(function(group) {
      return h("div", { className: "nav-group", key: group.label },
        h("div", { className: "nav-label" },
          h("span", null, group.label)
        ),
        h("div", { className: "nav-group__items" },
          group.tabs.map(function(t) {
            var meta = TAB_META[t];
            return h("button", {
              key: t,
              className: "nav-item" + (tab === t ? " active" : ""),
              onClick: function() { onNavigate(t); }
            },
              h("span", { className: "nav-icon" }, h(Icon, { name: meta.icon })),
              h("span", null, meta.title)
            );
          })
        )
      );
    })
  );
}

// ===================== Content Header =====================

function ContentHeader({ tab }) {
  var meta = TAB_META[tab] || {};
  return h("div", { className: "content-header" },
    h("div", null,
      h("h1", { className: "page-title" }, meta.title || ""),
      h("p", { className: "page-sub" }, meta.sub || "")
    )
  );
}

// ===================== Overview View =====================

function OverviewView({ gw }) {
  var _s = useState(null), status = _s[0], setStatus = _s[1];
  var _h = useState(null), health = _h[0], setHealth = _h[1];
  var _c = useState(null), cron = _c[0], setCron = _c[1];
  var _l = useState(true), loading = _l[0], setLoading = _l[1];

  var load = useCallback(function() {
    setLoading(true);
    Promise.all([
      gw.rpc("system.status").catch(function() { return null; }),
      gw.rpc("health.check").catch(function() { return null; }),
      gw.rpc("cron.status").catch(function() { return null; }),
    ]).then(function(res) {
      setStatus(res[0]); setHealth(res[1]); setCron(res[2]);
      setLoading(false);
    });
  }, [gw]);

  useEffect(function() { load(); }, [load]);

  var st = status || {};
  var hl = health || {};
  return h(Fragment, null,
    h("section", { className: "card" },
      h("div", { className: "row", style: { justifyContent: "space-between" } },
        h("div", null,
          h("div", { className: "card-title" }, "Gateway Status"),
          h("div", { className: "card-sub" }, "Core runtime metrics and entry points.")
        ),
        h("button", { className: "btn", disabled: loading, onClick: load }, loading ? "Loading..." : "Refresh")
      ),
      h("div", { className: "stat-grid", style: { marginTop: 16 } },
        h("div", { className: "stat" }, h("div", { className: "stat-label" }, "STATUS"), h("div", { className: "stat-value ok" }, hl.status || st.status?.status || "n/a")),
        h("div", { className: "stat" }, h("div", { className: "stat-label" }, "UPTIME"), h("div", { className: "stat-value" }, hl.uptime || st.uptime || "n/a")),
        h("div", { className: "stat" }, h("div", { className: "stat-label" }, "DATABASE"), h("div", { className: "stat-value" }, hl.database || "sqlite")),
        h("div", { className: "stat" }, h("div", { className: "stat-label" }, "GO VERSION"), h("div", { className: "stat-value" }, st.go || "n/a")),
        h("div", { className: "stat" }, h("div", { className: "stat-label" }, "SESSIONS"), h("div", { className: "stat-value" }, st.status?.sessions ?? "n/a")),
        h("div", { className: "stat" }, h("div", { className: "stat-label" }, "MESSAGES"), h("div", { className: "stat-value" }, st.status?.messages ?? "n/a"))
      )
    ),
    h("section", { className: "grid grid-cols-2" },
      h("div", { className: "card" },
        h("div", { className: "card-title" }, "Health"),
        h("div", { className: "card-sub" }, "Runtime memory and goroutine stats."),
        hl.memory ? h("div", { className: "status-list", style: { marginTop: 12 } },
          h("div", null, h("span", null, "Alloc MB"), h("span", { className: "mono" }, (hl.memory.allocMB || 0).toFixed(1))),
          h("div", null, h("span", null, "Sys MB"), h("span", { className: "mono" }, (hl.memory.sysMB || 0).toFixed(1))),
          h("div", null, h("span", null, "Goroutines"), h("span", { className: "mono" }, hl.memory.goroutines || 0))
        ) : h("div", { className: "muted", style: { marginTop: 12 } }, "No health data")
      ),
      h("div", { className: "card" },
        h("div", { className: "card-title" }, "Scheduler"),
        h("div", { className: "card-sub" }, "Cron scheduler overview."),
        cron ? h("div", { className: "status-list", style: { marginTop: 12 } },
          h("div", null, h("span", null, "Enabled"), h("span", { className: "mono" }, cron.enabled ? "Yes" : "No")),
          h("div", null, h("span", null, "Jobs"), h("span", { className: "mono" }, cron.jobs || 0))
        ) : h("div", { className: "muted", style: { marginTop: 12 } }, "No scheduler data")
      )
    )
  );
}

// ===================== Chat View =====================

function ChatView({ gw }) {
  var _m = useState([]), messages = _m[0], setMessages = _m[1];
  var _t = useState(""), text = _t[0], setText = _t[1];
  var _s = useState(false), sending = _s[0], setSending = _s[1];
  var threadRef = useRef(null);

  function scrollToBottom() {
    if (threadRef.current) threadRef.current.scrollTop = threadRef.current.scrollHeight;
  }

  useEffect(scrollToBottom, [messages]);

  function sendMessage() {
    if (!text.trim() || sending) return;
    var userMsg = { role: "user", content: text.trim(), createdAt: new Date().toISOString() };
    setMessages(function(prev) { return prev.concat([userMsg]); });
    setText("");
    setSending(true);
    gw.rpc("chat.send", { message: userMsg.content }).then(function(res) {
      var aiMsg = { role: "assistant", content: res.response || "No response", createdAt: new Date().toISOString() };
      setMessages(function(prev) { return prev.concat([aiMsg]); });
    }).catch(function(err) {
      var errMsg = { role: "assistant", content: "Error: " + err.message, createdAt: new Date().toISOString() };
      setMessages(function(prev) { return prev.concat([errMsg]); });
    }).finally(function() { setSending(false); });
  }

  function onKeyDown(e) {
    if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); sendMessage(); }
  }

  return h("div", { className: "chat" },
    h("div", { className: "chat-thread", ref: threadRef },
      messages.length === 0 ?
        h("div", { className: "empty-state" },
          h("div", { className: "empty-state-icon" }, h(Icon, { name: "messageSquare", size: 36 })),
          h("div", null, "Start a conversation with the gateway.")
        ) :
        messages.map(function(msg, i) {
          return h("div", { key: i, className: "chat-line " + msg.role },
            h("div", { className: "chat-msg" },
              h("div", { className: "chat-bubble" },
                h("div", { className: "chat-text" }, msg.content)
              ),
              h("div", { className: "chat-stamp" }, formatTime(msg.createdAt))
            )
          );
        }),
      sending ? h("div", { className: "chat-line assistant" },
        h("div", { className: "chat-msg" },
          h("div", { className: "chat-bubble" },
            h("div", { className: "reading-dots" }, h("span"), h("span"), h("span"))
          )
        )
      ) : null
    ),
    h("div", { className: "chat-compose" },
      h("textarea", {
        value: text,
        onChange: function(e) { setText(e.target.value); },
        onKeyDown: onKeyDown,
        placeholder: "Type a message... (Enter to send, Shift+Enter for newline)",
        disabled: sending
      }),
      h("div", { className: "row" },
        h("button", { className: "btn primary", onClick: sendMessage, disabled: sending || !text.trim() },
          h(Icon, { name: "send" }), "Send"
        )
      )
    )
  );
}

// ===================== Channels View =====================

function ChannelsView({ gw }) {
  var _d = useState([]), channels = _d[0], setChannels = _d[1];
  var _l = useState(true), loading = _l[0], setLoading = _l[1];

  var load = useCallback(function() {
    setLoading(true);
    gw.rpc("channels.status").then(function(res) {
      setChannels(res.channels || []);
    }).catch(function() {}).finally(function() { setLoading(false); });
  }, [gw]);

  useEffect(function() { load(); }, [load]);

  return h("section", { className: "card" },
    h("div", { className: "row", style: { justifyContent: "space-between" } },
      h("div", null,
        h("div", { className: "card-title" }, "Channels"),
        h("div", { className: "card-sub" }, "Connected messaging platform integrations.")
      ),
      h("button", { className: "btn", disabled: loading, onClick: load }, loading ? "Loading..." : "Refresh")
    ),
    channels.length === 0 ?
      h("div", { className: "empty-state" }, h("div", null, "No channels configured.")) :
      h("div", { className: "list", style: { marginTop: 16 } },
        channels.map(function(ch) {
          return h("div", { key: ch.id, className: "list-item" },
            h("div", { className: "list-main" },
              h("div", { className: "list-title" }, ch.name),
              h("div", { className: "list-sub" }, ch.id),
              h("div", { className: "chip-row", style: { marginTop: 6 } },
                h("span", { className: "chip" }, ch.type),
                h("span", { className: "chip " + (ch.status === "connected" ? "chip-ok" : "chip-warn") }, ch.status)
              )
            ),
            h("div", { className: "list-meta" },
              h("div", null, "Created: " + formatAgo(ch.createdAt))
            )
          );
        })
      )
  );
}

// ===================== Instances View =====================

function InstancesView({ gw }) {
  var _d = useState([]), instances = _d[0], setInstances = _d[1];
  var _l = useState(true), loading = _l[0], setLoading = _l[1];

  var load = useCallback(function() {
    setLoading(true);
    gw.rpc("system.presence").then(function(res) {
      setInstances(res.instances || []);
    }).catch(function() {}).finally(function() { setLoading(false); });
  }, [gw]);

  useEffect(function() { load(); }, [load]);

  return h("section", { className: "card" },
    h("div", { className: "row", style: { justifyContent: "space-between" } },
      h("div", null,
        h("div", { className: "card-title" }, "Connected Instances"),
        h("div", { className: "card-sub" }, "Dashboard clients and nodes connected to this gateway.")
      ),
      h("button", { className: "btn", disabled: loading, onClick: load }, loading ? "Loading..." : "Refresh")
    ),
    instances.length === 0 ?
      h("div", { className: "empty-state" }, h("div", null, "No instances connected.")) :
      h("div", { className: "list", style: { marginTop: 16 } },
        instances.map(function(inst) {
          return h("div", { key: inst.id, className: "list-item" },
            h("div", { className: "list-main" },
              h("div", { className: "list-title" }, inst.id),
              h("div", { className: "list-sub" }, inst.remoteAddr),
              h("div", { className: "chip-row", style: { marginTop: 6 } },
                h("span", { className: "chip chip-ok" }, inst.role || "operator")
              )
            ),
            h("div", { className: "list-meta" },
              h("div", null, "Connected: " + formatAgo(inst.connectedAt ? new Date(inst.connectedAt).toISOString() : null)),
              inst.userAgent ? h("div", { className: "mono", style: { fontSize: 11 } }, truncate(inst.userAgent, 40)) : null
            )
          );
        })
      )
  );
}

// ===================== Sessions View =====================

function SessionsView({ gw }) {
  var _d = useState([]), sessions = _d[0], setSessions = _d[1];
  var _l = useState(true), loading = _l[0], setLoading = _l[1];
  var _p = useState(null), preview = _p[0], setPreview = _p[1];
  var _pm = useState([]), previewMsgs = _pm[0], setPreviewMsgs = _pm[1];

  var load = useCallback(function() {
    setLoading(true);
    gw.rpc("sessions.list", { limit: 50 }).then(function(res) {
      setSessions(res.sessions || []);
    }).catch(function() {}).finally(function() { setLoading(false); });
  }, [gw]);

  useEffect(function() { load(); }, [load]);

  function openPreview(session) {
    setPreview(session);
    gw.rpc("sessions.preview", { key: session.id, limit: 20 }).then(function(res) {
      setPreviewMsgs(res.messages || []);
    }).catch(function() { setPreviewMsgs([]); });
  }

  function deleteSession(id) {
    gw.rpc("sessions.delete", { key: id }).then(function() { load(); });
  }

  return h(Fragment, null,
    h("section", { className: "card" },
      h("div", { className: "row", style: { justifyContent: "space-between" } },
        h("div", null,
          h("div", { className: "card-title" }, "Sessions"),
          h("div", { className: "card-sub" }, "Active session keys and per-session details.")
        ),
        h("button", { className: "btn", disabled: loading, onClick: load }, loading ? "Loading..." : "Refresh")
      ),
      sessions.length === 0 ?
        h("div", { className: "empty-state" }, h("div", null, "No sessions found.")) :
        h("div", { className: "table sessions-table", style: { marginTop: 16 } },
          h("div", { className: "table-head" },
            h("div", null, "Session"), h("div", null, "Channel"), h("div", null, "Peer"),
            h("div", null, "Status"), h("div", null, "Updated"), h("div", null, "Actions")
          ),
          sessions.map(function(s) {
            return h("div", { key: s.id, className: "table-row" },
              h("div", null, h("button", { className: "session-link", onClick: function() { openPreview(s); } }, truncate(s.displayName || s.id, 24))),
              h("div", { className: "mono", style: { fontSize: 12 } }, s.channelType),
              h("div", { className: "mono", style: { fontSize: 12 } }, truncate(s.peerId, 20)),
              h("div", null, h("span", { className: "chip " + (s.status === "active" ? "chip-ok" : "chip-warn") }, s.status)),
              h("div", { className: "muted", style: { fontSize: 12 } }, formatAgo(s.updatedAt)),
              h("div", null, h("button", { className: "btn btn--sm danger", onClick: function() { deleteSession(s.id); } }, "Delete"))
            );
          })
        )
    ),
    preview ? h("div", { className: "modal-overlay", onClick: function(e) { if (e.target === e.currentTarget) setPreview(null); } },
      h("div", { className: "modal-card" },
        h("div", { className: "modal-header" },
          h("div", { className: "modal-title" }, "Session: " + (preview.displayName || preview.id)),
          h("button", { className: "btn btn--sm", onClick: function() { setPreview(null); } }, h(Icon, { name: "x" }))
        ),
        h("div", { className: "chip-row", style: { marginBottom: 12 } },
          h("span", { className: "chip" }, preview.channelType),
          h("span", { className: "chip " + (preview.status === "active" ? "chip-ok" : "chip-warn") }, preview.status),
          h("span", { className: "chip" }, "Agent: " + preview.agentId)
        ),
        previewMsgs.length === 0 ?
          h("div", { className: "muted" }, "No messages in this session.") :
          h("div", { style: { display: "grid", gap: 8, maxHeight: 400, overflowY: "auto" } },
            previewMsgs.map(function(msg, i) {
              return h("div", { key: i, className: "chat-line " + msg.role },
                h("div", { className: "chat-msg", style: { maxWidth: "100%" } },
                  h("div", { className: "chat-bubble" },
                    h("div", { className: "chat-text" }, msg.content)
                  ),
                  h("div", { className: "chat-stamp" }, formatTime(msg.createdAt))
                )
              );
            })
          )
      )
    ) : null
  );
}

// ===================== Cron View =====================

function CronView({ gw }) {
  var _st = useState(null), status = _st[0], setStatus = _st[1];
  var _j = useState([]), jobs = _j[0], setJobs = _j[1];
  var _l = useState(true), loading = _l[0], setLoading = _l[1];
  var _f = useState({ name: "", description: "", schedule: '{"kind":"every","interval":5,"unit":"minutes"}', payload: '{"kind":"systemEvent","text":""}' }),
    form = _f[0], setForm = _f[1];

  var load = useCallback(function() {
    setLoading(true);
    Promise.all([
      gw.rpc("cron.status").catch(function() { return null; }),
      gw.rpc("cron.list").catch(function() { return { jobs: [] }; }),
    ]).then(function(res) {
      setStatus(res[0]); setJobs(res[1]?.jobs || []);
      setLoading(false);
    });
  }, [gw]);

  useEffect(function() { load(); }, [load]);

  function addJob() {
    if (!form.name.trim()) return;
    gw.rpc("cron.add", form).then(function() {
      setForm({ name: "", description: "", schedule: '{"kind":"every","interval":5,"unit":"minutes"}', payload: '{"kind":"systemEvent","text":""}' });
      load();
    });
  }

  function removeJob(id) {
    gw.rpc("cron.remove", { id: id }).then(load);
  }

  function runJob(id) {
    gw.rpc("cron.run", { id: id }).then(load);
  }

  return h(Fragment, null,
    h("section", { className: "grid grid-cols-2" },
      h("div", { className: "card" },
        h("div", { className: "card-title" }, "Scheduler"),
        h("div", { className: "card-sub" }, "Gateway-owned cron scheduler status."),
        h("div", { className: "stat-grid", style: { marginTop: 16 } },
          h("div", { className: "stat" }, h("div", { className: "stat-label" }, "ENABLED"), h("div", { className: "stat-value" }, status ? (status.enabled ? "Yes" : "No") : "n/a")),
          h("div", { className: "stat" }, h("div", { className: "stat-label" }, "JOBS"), h("div", { className: "stat-value" }, status?.jobs ?? "n/a"))
        ),
        h("div", { className: "row", style: { marginTop: 12 } },
          h("button", { className: "btn", disabled: loading, onClick: load }, loading ? "Refreshing..." : "Refresh")
        )
      ),
      h("div", { className: "card" },
        h("div", { className: "card-title" }, "New Job"),
        h("div", { className: "card-sub" }, "Create a scheduled wakeup or agent run."),
        h("div", { className: "form-grid", style: { marginTop: 16 } },
          h("label", { className: "field" }, h("span", null, "Name"), h("input", { value: form.name, onChange: function(e) { setForm(Object.assign({}, form, { name: e.target.value })); } })),
          h("label", { className: "field" }, h("span", null, "Description"), h("input", { value: form.description, onChange: function(e) { setForm(Object.assign({}, form, { description: e.target.value })); } }))
        ),
        h("div", { className: "form-grid", style: { marginTop: 12 } },
          h("label", { className: "field" }, h("span", null, "Schedule (JSON)"), h("input", { value: form.schedule, onChange: function(e) { setForm(Object.assign({}, form, { schedule: e.target.value })); } })),
          h("label", { className: "field" }, h("span", null, "Payload (JSON)"), h("input", { value: form.payload, onChange: function(e) { setForm(Object.assign({}, form, { payload: e.target.value })); } }))
        ),
        h("div", { className: "row", style: { marginTop: 12 } },
          h("button", { className: "btn primary", onClick: addJob, disabled: !form.name.trim() }, h(Icon, { name: "plus" }), "Add Job")
        )
      )
    ),
    h("section", { className: "card" },
      h("div", { className: "card-title" }, "Jobs"),
      h("div", { className: "card-sub" }, "All registered cron jobs."),
      jobs.length === 0 ?
        h("div", { className: "empty-state" }, h("div", null, "No cron jobs configured.")) :
        h("div", { className: "list", style: { marginTop: 16 } },
          jobs.map(function(job) {
            return h("div", { key: job.id, className: "list-item" },
              h("div", { className: "list-main" },
                h("div", { className: "list-title" }, job.name),
                h("div", { className: "list-sub" }, job.description || job.id),
                h("div", { className: "chip-row", style: { marginTop: 6 } },
                  h("span", { className: "chip " + (job.enabled ? "chip-ok" : "chip-warn") }, job.enabled ? "enabled" : "disabled"),
                  job.lastStatus ? h("span", { className: "chip" }, "Last: " + job.lastStatus) : null,
                  h("span", { className: "chip" }, "Agent: " + (job.agentId || "main"))
                )
              ),
              h("div", { className: "list-meta" },
                h("div", null, "Schedule: " + truncate(job.schedule, 30)),
                job.lastRunAt ? h("div", null, "Last run: " + formatAgo(job.lastRunAt)) : null,
                h("div", { className: "row", style: { justifyContent: "flex-end", marginTop: 6 } },
                  h("button", { className: "btn btn--sm", onClick: function() { runJob(job.id); } }, h(Icon, { name: "play" }), "Run"),
                  h("button", { className: "btn btn--sm danger", onClick: function() { removeJob(job.id); } }, h(Icon, { name: "trash" }), "Remove")
                )
              )
            );
          })
        )
    )
  );
}

// ===================== Skills View =====================

function SkillsView({ gw }) {
  var _d = useState([]), skills = _d[0], setSkills = _d[1];
  var _l = useState(true), loading = _l[0], setLoading = _l[1];
  var _f = useState(""), filter = _f[0], setFilter = _f[1];

  var load = useCallback(function() {
    setLoading(true);
    gw.rpc("skills.status").then(function(res) {
      setSkills(res.skills || []);
    }).catch(function() {}).finally(function() { setLoading(false); });
  }, [gw]);

  useEffect(function() { load(); }, [load]);

  var filtered = useMemo(function() {
    var needle = filter.trim().toLowerCase();
    if (!needle) return skills;
    return skills.filter(function(s) {
      return [s.name, s.description, s.source].join(" ").toLowerCase().includes(needle);
    });
  }, [skills, filter]);

  return h("section", { className: "card" },
    h("div", { className: "row", style: { justifyContent: "space-between" } },
      h("div", null,
        h("div", { className: "card-title" }, "Skills"),
        h("div", { className: "card-sub" }, "Bundled, managed, and workspace skills.")
      ),
      h("button", { className: "btn", disabled: loading, onClick: load }, loading ? "Loading..." : "Refresh")
    ),
    h("div", { className: "filters", style: { marginTop: 14 } },
      h("label", { className: "field", style: { flex: 1 } },
        h("span", null, "Filter"),
        h("input", { value: filter, onChange: function(e) { setFilter(e.target.value); }, placeholder: "Search skills" })
      ),
      h("div", { className: "muted" }, filtered.length + " shown")
    ),
    filtered.length === 0 ?
      h("div", { className: "muted", style: { marginTop: 16 } }, "No skills found.") :
      h("div", { className: "list", style: { marginTop: 16 } },
        filtered.map(function(skill) {
          return h("div", { key: skill.key, className: "list-item" },
            h("div", { className: "list-main" },
              h("div", { className: "list-title" }, (skill.emoji ? skill.emoji + " " : "") + skill.name),
              h("div", { className: "list-sub" }, truncate(skill.description, 140)),
              h("div", { className: "chip-row", style: { marginTop: 6 } },
                h("span", { className: "chip" }, skill.source),
                h("span", { className: "chip " + (skill.eligible ? "chip-ok" : "chip-warn") }, skill.eligible ? "eligible" : "blocked"),
                skill.userInvocable ? h("span", { className: "chip" }, "user-invocable") : null
              )
            ),
            h("div", { className: "list-meta" },
              h("div", null, skill.enabled ? "Enabled" : "Disabled"),
              skill.missingBins && skill.missingBins.length > 0 ? h("div", { className: "muted" }, "Missing: " + skill.missingBins.join(", ")) : null
            )
          );
        })
      )
  );
}

// ===================== Nodes View =====================

function NodesView({ gw }) {
  var _d = useState([]), instances = _d[0], setInstances = _d[1];
  var _l = useState(true), loading = _l[0], setLoading = _l[1];

  var load = useCallback(function() {
    setLoading(true);
    gw.rpc("system.presence").then(function(res) {
      setInstances(res.instances || []);
    }).catch(function() {}).finally(function() { setLoading(false); });
  }, [gw]);

  useEffect(function() { load(); }, [load]);

  return h("section", { className: "card" },
    h("div", { className: "row", style: { justifyContent: "space-between" } },
      h("div", null,
        h("div", { className: "card-title" }, "Nodes"),
        h("div", { className: "card-sub" }, "Paired devices and command exposure.")
      ),
      h("button", { className: "btn", disabled: loading, onClick: load }, loading ? "Loading..." : "Refresh")
    ),
    instances.length === 0 ?
      h("div", { className: "empty-state" }, h("div", null, "No nodes connected.")) :
      h("div", { className: "list", style: { marginTop: 16 } },
        instances.map(function(inst) {
          return h("div", { key: inst.id, className: "list-item" },
            h("div", { className: "list-main" },
              h("div", { className: "list-title" }, inst.id),
              h("div", { className: "list-sub" }, inst.remoteAddr || "Unknown"),
              h("div", { className: "chip-row", style: { marginTop: 6 } },
                h("span", { className: "chip chip-ok" }, inst.role || "operator"),
                h("span", { className: "chip" }, "Connected")
              )
            ),
            h("div", { className: "list-meta" },
              inst.userAgent ? h("div", { className: "mono", style: { fontSize: 11 } }, truncate(inst.userAgent, 50)) : null
            )
          );
        })
      )
  );
}

// ===================== Config View =====================

function ConfigView({ gw }) {
  var _r = useState(""), raw = _r[0], setRaw = _r[1];
  var _v = useState(true), valid = _v[0], setValid = _v[1];
  var _l = useState(true), loading = _l[0], setLoading = _l[1];
  var _s = useState(null), saveMsg = _s[0], setSaveMsg = _s[1];
  var _m = useState("form"), mode = _m[0], setMode = _m[1];

  var load = useCallback(function() {
    setLoading(true);
    gw.rpc("config.read").then(function(res) {
      setRaw(res.raw || "{}");
      setValid(res.valid !== false);
    }).catch(function() {}).finally(function() { setLoading(false); });
  }, [gw]);

  useEffect(function() { load(); }, [load]);

  function save() {
    setSaveMsg(null);
    try { JSON.parse(raw); } catch(e) { setSaveMsg("Invalid JSON: " + e.message); return; }
    gw.rpc("config.write", { raw: raw }).then(function() {
      setSaveMsg("Saved successfully");
      setTimeout(function() { setSaveMsg(null); }, 3000);
    }).catch(function(err) { setSaveMsg("Error: " + err.message); });
  }

  var parsed = useMemo(function() {
    try { return JSON.parse(raw); } catch(e) { return null; }
  }, [raw]);

  var sections = useMemo(function() {
    if (!parsed || typeof parsed !== "object") return [];
    return Object.keys(parsed);
  }, [parsed]);

  var _active = useState(null), activeSection = _active[0], setActiveSection = _active[1];

  return h("div", { className: "config-layout" },
    h("div", { className: "config-sidebar" },
      h("div", { className: "config-sidebar__header" },
        h("span", { className: "config-sidebar__title" }, "Configuration"),
        h("div", { className: "row", style: { gap: 4 } },
          h("button", { className: "btn btn--sm" + (mode === "form" ? " primary" : ""), onClick: function() { setMode("form"); } }, "Form"),
          h("button", { className: "btn btn--sm" + (mode === "raw" ? " primary" : ""), onClick: function() { setMode("raw"); } }, "Raw")
        )
      ),
      h("div", { className: "config-nav" },
        mode === "form" ? sections.map(function(key) {
          return h("button", {
            key: key,
            className: "config-nav__item" + (activeSection === key ? " active" : ""),
            onClick: function() { setActiveSection(key); }
          }, key);
        }) : h("button", { className: "config-nav__item active" }, "Raw JSON")
      )
    ),
    h("div", { className: "config-main" },
      h("div", { className: "config-actions" },
        h("div", { className: "row" },
          h("button", { className: "btn", disabled: loading, onClick: load }, loading ? "Loading..." : "Reload"),
          saveMsg ? h("span", { className: "muted", style: { fontSize: 13 } }, saveMsg) : null
        ),
        h("button", { className: "btn primary", onClick: save, disabled: !valid }, h(Icon, { name: "save" }), "Save")
      ),
      h("div", { className: "config-content" },
        mode === "raw" ?
          h("label", { className: "field" },
            h("span", null, "Raw JSON Configuration"),
            h("textarea", {
              value: raw,
              onChange: function(e) {
                setRaw(e.target.value);
                try { JSON.parse(e.target.value); setValid(true); } catch(x) { setValid(false); }
              },
              style: { minHeight: 500 }
            })
          ) :
          (activeSection && parsed && parsed[activeSection] ?
            h("div", null,
              h("h3", { style: { fontSize: 16, fontWeight: 600, marginBottom: 16, color: "var(--text-strong)" } }, activeSection),
              h("pre", { className: "code-block" }, JSON.stringify(parsed[activeSection], null, 2))
            ) :
            h("div", { className: "empty-state" },
              h("div", { className: "empty-state-icon" }, h(Icon, { name: "settings", size: 36 })),
              h("div", null, "Select a section from the sidebar.")
            )
          )
      )
    )
  );
}

// ===================== Debug View =====================

function DebugView({ gw }) {
  var _st = useState(null), status = _st[0], setStatus = _st[1];
  var _h = useState(null), health = _h[0], setHealth = _h[1];
  var _l = useState(true), loading = _l[0], setLoading = _l[1];
  var _cm = useState(""), callMethod = _cm[0], setCallMethod = _cm[1];
  var _cp = useState("{}"), callParams = _cp[0], setCallParams = _cp[1];
  var _cr = useState(null), callResult = _cr[0], setCallResult = _cr[1];
  var _ce = useState(null), callError = _ce[0], setCallError = _ce[1];

  var load = useCallback(function() {
    setLoading(true);
    Promise.all([
      gw.rpc("system.status").catch(function() { return null; }),
      gw.rpc("health.check").catch(function() { return null; }),
    ]).then(function(res) {
      setStatus(res[0]); setHealth(res[1]);
      setLoading(false);
    });
  }, [gw]);

  useEffect(function() { load(); }, [load]);

  function doCall() {
    if (!callMethod.trim()) return;
    setCallResult(null); setCallError(null);
    var params;
    try { params = JSON.parse(callParams); } catch(e) { setCallError("Invalid JSON params: " + e.message); return; }
    gw.rpc(callMethod.trim(), params).then(function(res) {
      setCallResult(JSON.stringify(res, null, 2));
    }).catch(function(err) { setCallError(err.message); });
  }

  return h(Fragment, null,
    h("section", { className: "grid grid-cols-2" },
      h("div", { className: "card" },
        h("div", { className: "row", style: { justifyContent: "space-between" } },
          h("div", null,
            h("div", { className: "card-title" }, "Snapshots"),
            h("div", { className: "card-sub" }, "Status, health, and runtime data.")
          ),
          h("button", { className: "btn", disabled: loading, onClick: load }, loading ? "Refreshing..." : "Refresh")
        ),
        h("div", { className: "stack", style: { marginTop: 12 } },
          h("div", null,
            h("div", { className: "muted" }, "System Status"),
            h("pre", { className: "code-block" }, JSON.stringify(status || {}, null, 2))
          ),
          h("div", null,
            h("div", { className: "muted" }, "Health Check"),
            h("pre", { className: "code-block" }, JSON.stringify(health || {}, null, 2))
          )
        )
      ),
      h("div", { className: "card" },
        h("div", { className: "card-title" }, "Manual RPC"),
        h("div", { className: "card-sub" }, "Send a raw gateway method with JSON params."),
        h("div", { className: "form-grid", style: { marginTop: 16 } },
          h("label", { className: "field" },
            h("span", null, "Method"),
            h("input", { value: callMethod, onChange: function(e) { setCallMethod(e.target.value); }, placeholder: "e.g. system.status" })
          ),
          h("label", { className: "field" },
            h("span", null, "Params (JSON)"),
            h("textarea", { value: callParams, onChange: function(e) { setCallParams(e.target.value); }, rows: 4, style: { minHeight: 80 } })
          )
        ),
        h("div", { className: "row", style: { marginTop: 12 } },
          h("button", { className: "btn primary", onClick: doCall }, "Call")
        ),
        callError ? h("div", { className: "callout danger", style: { marginTop: 12 } }, callError) : null,
        callResult ? h("div", { style: { marginTop: 12 } },
          h("div", { className: "muted" }, "Result"),
          h("pre", { className: "code-block" }, callResult)
        ) : null
      )
    )
  );
}

// ===================== Logs View =====================

function LogsView({ gw }) {
  var _e = useState([]), entries = _e[0], setEntries = _e[1];
  var _l = useState(true), loading = _l[0], setLoading = _l[1];
  var _f = useState(""), filter = _f[0], setFilter = _f[1];
  var _levels = useState({ trace: true, debug: true, info: true, warn: true, error: true, fatal: true }),
    levels = _levels[0], setLevels = _levels[1];
  var _auto = useState(true), autoFollow = _auto[0], setAutoFollow = _auto[1];
  var streamRef = useRef(null);

  var load = useCallback(function() {
    setLoading(true);
    gw.rpc("logs.tail", { limit: 200 }).then(function(res) {
      setEntries(res.entries || []);
    }).catch(function() {}).finally(function() { setLoading(false); });
  }, [gw]);

  useEffect(function() { load(); }, [load]);

  useEffect(function() {
    if (autoFollow && streamRef.current) {
      streamRef.current.scrollTop = streamRef.current.scrollHeight;
    }
  }, [entries, autoFollow]);

  var filtered = useMemo(function() {
    var needle = filter.trim().toLowerCase();
    return entries.filter(function(e) {
      if (e.level && !levels[e.level]) return false;
      if (!needle) return true;
      return [e.message, e.subsystem].join(" ").toLowerCase().includes(needle);
    });
  }, [entries, filter, levels]);

  var LEVEL_NAMES = ["trace", "debug", "info", "warn", "error", "fatal"];

  return h("section", { className: "card" },
    h("div", { className: "row", style: { justifyContent: "space-between" } },
      h("div", null,
        h("div", { className: "card-title" }, "Logs"),
        h("div", { className: "card-sub" }, "Gateway log entries.")
      ),
      h("button", { className: "btn", disabled: loading, onClick: load }, loading ? "Loading..." : "Refresh")
    ),
    h("div", { className: "filters", style: { marginTop: 14 } },
      h("label", { className: "field", style: { minWidth: 220 } },
        h("span", null, "Filter"),
        h("input", { value: filter, onChange: function(e) { setFilter(e.target.value); }, placeholder: "Search logs" })
      ),
      h("label", { className: "field", style: { flexDirection: "row", alignItems: "center", gap: 6 } },
        h("input", { type: "checkbox", checked: autoFollow, onChange: function(e) { setAutoFollow(e.target.checked); } }),
        h("span", null, "Auto-follow")
      )
    ),
    h("div", { className: "chip-row", style: { marginTop: 12 } },
      LEVEL_NAMES.map(function(level) {
        return h("label", { key: level, className: "chip log-chip " + level, style: { cursor: "pointer" } },
          h("input", { type: "checkbox", checked: levels[level],
            onChange: function(e) {
              var next = Object.assign({}, levels);
              next[level] = e.target.checked;
              setLevels(next);
            }
          }),
          level
        );
      })
    ),
    h("div", { className: "muted", style: { marginTop: 8, fontSize: 12 } }, filtered.length + " entries"),
    h("div", { className: "log-stream", style: { marginTop: 12 }, ref: streamRef },
      filtered.length === 0 ?
        h("div", { style: { padding: 24, textAlign: "center", color: "var(--muted)" } }, "No log entries.") :
        filtered.map(function(entry, i) {
          return h("div", { key: i, className: "log-row" },
            h("div", { className: "log-time" }, formatTime(entry.timestamp)),
            h("div", null, h("span", { className: "log-level " + (entry.level || "info") }, entry.level || "info")),
            h("div", { className: "log-subsystem" }, entry.subsystem || ""),
            h("div", { className: "log-message" }, entry.message || "")
          );
        })
    )
  );
}

// ===================== App Root =====================

function App() {
  var _t = useState(window.location.hash.slice(1) || "overview"),
    tab = _t[0], setTab = _t[1];
  var _c = useState(false), connected = _c[0], setConnected = _c[1];
  var _e = useState(null), error = _e[0], setError = _e[1];
  var gwRef = useRef(null);
  var _retry = useState(0), retry = _retry[0], setRetry = _retry[1];

  // Create gateway once
  if (!gwRef.current) gwRef.current = new Gateway();
  var gw = gwRef.current;

  // Connect on mount
  useEffect(function() {
    var cancelled = false;
    function connect() {
      var proto = window.location.protocol === "https:" ? "wss:" : "ws:";
      var url = proto + "//" + window.location.host + "/ws";
      gw.connect(url).then(function() {
        if (!cancelled) {
          setConnected(true);
          setError(null);
        }
      }).catch(function(err) {
        if (!cancelled) {
          setConnected(false);
          setError(err.message);
          // Auto-retry
          setTimeout(function() { if (!cancelled) setRetry(function(r) { return r + 1; }); }, 3000);
        }
      });
    }
    connect();
    var unsub = gw.on("disconnected", function() {
      if (!cancelled) {
        setConnected(false);
        setTimeout(function() { if (!cancelled) setRetry(function(r) { return r + 1; }); }, 3000);
      }
    });
    return function() { cancelled = true; unsub(); };
  }, [retry]);

  // Hash-based routing
  function navigate(t) {
    setTab(t);
    window.location.hash = t;
  }

  useEffect(function() {
    function onHash() { setTab(window.location.hash.slice(1) || "overview"); }
    window.addEventListener("hashchange", onHash);
    return function() { window.removeEventListener("hashchange", onHash); };
  }, []);

  // View routing
  function renderView() {
    if (!connected) {
      return h("div", { className: "empty-state", style: { paddingTop: 80 } },
        h("div", { className: "spinner" }),
        h("div", null, error ? "Connection failed: " + error : "Connecting to gateway..."),
        h("button", { className: "btn", style: { marginTop: 12 }, onClick: function() { setRetry(function(r) { return r + 1; }); } }, "Retry")
      );
    }
    switch (tab) {
      case "chat": return h(ChatView, { gw: gw });
      case "overview": return h(OverviewView, { gw: gw });
      case "channels": return h(ChannelsView, { gw: gw });
      case "instances": return h(InstancesView, { gw: gw });
      case "sessions": return h(SessionsView, { gw: gw });
      case "cron": return h(CronView, { gw: gw });
      case "skills": return h(SkillsView, { gw: gw });
      case "nodes": return h(NodesView, { gw: gw });
      case "config": return h(ConfigView, { gw: gw });
      case "debug": return h(DebugView, { gw: gw });
      case "logs": return h(LogsView, { gw: gw });
      default: return h(OverviewView, { gw: gw });
    }
  }

  return h("div", { className: "shell" + (tab === "chat" ? " shell--chat" : "") },
    h(Topbar, { connected: connected }),
    h(Nav, { tab: tab, onNavigate: navigate }),
    h("div", { className: "content" + (tab === "chat" ? " content--chat" : "") },
      tab !== "chat" ? h(ContentHeader, { tab: tab }) : null,
      renderView()
    )
  );
}

// ===================== Mount =====================

ReactDOM.createRoot(document.getElementById("root")).render(h(App));
</script>
</body>
</html>
