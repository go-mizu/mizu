{{define "register.html"}}
{{template "default.html" .}}
{{end}}

{{define "content"}}
<div class="min-h-screen flex items-center justify-center p-4 bg-white">
    <div class="w-full max-w-sm">
        <!-- Logo & Header -->
        <div class="text-center mb-8">
            <div class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-gpt-accent mb-5">
                <svg class="w-6 h-6 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                </svg>
            </div>
            <h1 class="text-2xl font-semibold text-gpt-text mb-2">Create your account</h1>
            <p class="text-sm text-gpt-text-secondary">Get started with Mizu Chat</p>
        </div>

        <!-- Register Form -->
        <form id="register-form" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gpt-text mb-2">Email</label>
                <input
                    type="email"
                    id="email"
                    name="email"
                    required
                    autofocus
                    autocomplete="email"
                    placeholder="you@example.com"
                    class="w-full px-4 py-3 rounded-xl text-sm outline-none transition-all bg-gpt-input-bg border border-gpt-border text-gpt-text focus:ring-2 focus:ring-gpt-accent placeholder:text-gpt-text-muted"
                >
            </div>

            <div>
                <label class="block text-sm font-medium text-gpt-text mb-2">Display Name</label>
                <input
                    type="text"
                    id="display_name"
                    name="display_name"
                    required
                    maxlength="32"
                    placeholder="How others will see you"
                    class="w-full px-4 py-3 rounded-xl text-sm outline-none transition-all bg-gpt-input-bg border border-gpt-border text-gpt-text focus:ring-2 focus:ring-gpt-accent placeholder:text-gpt-text-muted"
                >
            </div>

            <div>
                <label class="block text-sm font-medium text-gpt-text mb-2">Username</label>
                <input
                    type="text"
                    id="username"
                    name="username"
                    required
                    maxlength="32"
                    pattern="[a-zA-Z0-9_]+"
                    autocomplete="username"
                    placeholder="your_username"
                    class="w-full px-4 py-3 rounded-xl text-sm outline-none transition-all bg-gpt-input-bg border border-gpt-border text-gpt-text focus:ring-2 focus:ring-gpt-accent placeholder:text-gpt-text-muted"
                >
                <p class="mt-1.5 text-xs text-gpt-text-muted">Letters, numbers, and underscores only</p>
            </div>

            <div>
                <label class="block text-sm font-medium text-gpt-text mb-2">Password</label>
                <input
                    type="password"
                    id="password"
                    name="password"
                    required
                    minlength="8"
                    autocomplete="new-password"
                    placeholder="At least 8 characters"
                    class="w-full px-4 py-3 rounded-xl text-sm outline-none transition-all bg-gpt-input-bg border border-gpt-border text-gpt-text focus:ring-2 focus:ring-gpt-accent placeholder:text-gpt-text-muted"
                >
            </div>

            <div>
                <label class="block text-sm font-medium text-gpt-text mb-2">Confirm Password</label>
                <input
                    type="password"
                    id="confirm_password"
                    name="confirm_password"
                    required
                    autocomplete="new-password"
                    placeholder="Confirm your password"
                    class="w-full px-4 py-3 rounded-xl text-sm outline-none transition-all bg-gpt-input-bg border border-gpt-border text-gpt-text focus:ring-2 focus:ring-gpt-accent placeholder:text-gpt-text-muted"
                >
            </div>

            <!-- Error Message -->
            <div id="error-message" class="hidden text-sm text-red-600 bg-red-50 px-4 py-3 rounded-xl border border-red-200"></div>

            <!-- Submit Button -->
            <button
                type="submit"
                id="submit-btn"
                class="w-full py-3 px-4 rounded-xl text-sm font-medium text-white transition-all btn-transition bg-gpt-accent hover:opacity-90 disabled:opacity-50"
            >
                <span id="btn-text">Create Account</span>
                <svg id="btn-spinner" class="hidden w-5 h-5 mx-auto animate-spin" viewBox="0 0 24 24" fill="none">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"/>
                </svg>
            </button>

            <!-- Sign In Link -->
            <p class="text-center text-sm pt-2 text-gpt-text-secondary">
                Already have an account?
                <a href="/login" class="text-gpt-accent hover:underline font-medium">Sign in</a>
            </p>
        </form>
    </div>
</div>

<script>
document.getElementById('register-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target;
    const btn = document.getElementById('submit-btn');
    const btnText = document.getElementById('btn-text');
    const btnSpinner = document.getElementById('btn-spinner');
    const errorEl = document.getElementById('error-message');

    // Validate passwords match
    if (form.password.value !== form.confirm_password.value) {
        errorEl.textContent = 'Passwords do not match';
        errorEl.classList.remove('hidden');
        return;
    }

    btn.disabled = true;
    btnText.classList.add('hidden');
    btnSpinner.classList.remove('hidden');
    errorEl.classList.add('hidden');

    try {
        const res = await fetch('/api/v1/auth/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                email: form.email.value,
                display_name: form.display_name.value,
                username: form.username.value,
                password: form.password.value
            })
        });

        if (res.ok) {
            // Auto-login after registration
            const loginRes = await fetch('/api/v1/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    login: form.email.value,
                    password: form.password.value
                })
            });

            if (loginRes.ok) {
                window.location.href = '/';
            } else {
                window.location.href = '/login';
            }
        } else {
            const json = await res.json();
            errorEl.textContent = json.error?.message || 'Registration failed';
            errorEl.classList.remove('hidden');
            btn.disabled = false;
            btnText.classList.remove('hidden');
            btnSpinner.classList.add('hidden');
        }
    } catch (err) {
        errorEl.textContent = 'Unable to connect. Please try again.';
        errorEl.classList.remove('hidden');
        btn.disabled = false;
        btnText.classList.remove('hidden');
        btnSpinner.classList.add('hidden');
    }
});
</script>
{{end}}
