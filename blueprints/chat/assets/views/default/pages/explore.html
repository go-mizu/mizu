{{define "explore.html"}}
{{template "default.html" .}}
{{end}}

{{define "content"}}
<div class="explore">
    <header class="explore-header">
        <div class="explore-nav">
            <a href="/" class="landing-logo">
                <svg viewBox="0 0 48 48" width="40" height="40" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect width="48" height="48" rx="12" fill="url(#explore-logo-gradient)"/>
                    <path d="M14 34V14h5l5 12 5-12h5v20h-4V22l-4.5 10h-3L18 22v12h-4z" fill="white"/>
                    <defs>
                        <linearGradient id="explore-logo-gradient" x1="0" y1="0" x2="48" y2="48" gradientUnits="userSpaceOnUse">
                            <stop stop-color="#6366f1"/>
                            <stop offset="0.5" stop-color="#a855f7"/>
                            <stop offset="1" stop-color="#ec4899"/>
                        </linearGradient>
                    </defs>
                </svg>
                Mizu
            </a>
            <nav class="landing-nav">
                {{if .User}}
                    <a href="/" class="btn btn-primary">Open App</a>
                {{else}}
                    <a href="/login" class="btn btn-ghost">Login</a>
                    <a href="/register" class="btn btn-primary">Sign Up</a>
                {{end}}
            </nav>
        </div>

        <h1>Find your community</h1>
        <p class="explore-header-subtitle">
            From gaming, to music, to learning, there's a place for you.
        </p>

        <div class="explore-search">
            <input type="text" placeholder="Search for servers..." id="search-input" autocomplete="off">
            <button class="btn btn-primary" onclick="performSearch()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
                Search
            </button>
        </div>

        <div class="explore-tabs">
            <button class="explore-tab active" data-category="all">All</button>
            <button class="explore-tab" data-category="gaming">Gaming</button>
            <button class="explore-tab" data-category="music">Music</button>
            <button class="explore-tab" data-category="education">Education</button>
            <button class="explore-tab" data-category="science">Science & Tech</button>
            <button class="explore-tab" data-category="entertainment">Entertainment</button>
            <button class="explore-tab" data-category="creative">Creative</button>
        </div>
    </header>

    <div class="explore-content">
        <div class="flex justify-between items-center mb-4">
            <h2 class="explore-section-title" id="section-title">Popular Servers</h2>
            <div style="display: flex; gap: 0.5rem; align-items: center;">
                <span style="color: var(--text-muted); font-size: var(--font-size-sm);">Sort by:</span>
                <select id="sort-select" class="form-input" style="width: auto; padding: 0.5rem 1rem;">
                    <option value="popular">Most Popular</option>
                    <option value="newest">Newest</option>
                    <option value="members">Most Members</option>
                    <option value="alphabetical">A-Z</option>
                </select>
            </div>
        </div>

        <div class="server-grid" id="server-grid">
            {{range .Data.servers}}
            <article class="server-card" data-category="{{.Category}}" onclick="window.location.href='/channels/{{.ID}}/{{.DefaultChannel}}'">
                <div class="server-card-banner">
                    {{if .BannerURL}}
                        <img src="{{.BannerURL}}" alt="">
                    {{end}}
                    <div class="server-card-icon">
                        {{if .IconURL}}
                            <img src="{{.IconURL}}" alt="{{.Name}}">
                        {{else}}
                            {{slice .Name 0 1}}
                        {{end}}
                    </div>
                </div>
                <div class="server-card-body">
                    <h3 class="server-card-name">{{.Name}}</h3>
                    <p class="server-card-description">
                        {{if .Description}}{{.Description}}{{else}}A wonderful community awaits!{{end}}
                    </p>
                    <div class="server-card-meta">
                        <span class="online-dot"></span>
                        <span>{{.OnlineCount}} online</span>
                        <span style="margin-left: 0.5rem;">{{.MemberCount}} members</span>
                    </div>
                </div>
                <div class="server-card-footer">
                    <button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); joinServer('{{.ID}}')">Join</button>
                </div>
            </article>
            {{else}}
            <div class="server-grid-empty" id="empty-state" style="grid-column: 1 / -1; text-align: center; padding: var(--space-12);">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="margin: 0 auto var(--space-4); color: var(--text-muted); opacity: 0.5;">
                    <circle cx="11" cy="11" r="8"/>
                    <path d="m21 21-4.35-4.35"/>
                </svg>
                <h3 style="font-size: var(--font-size-xl); margin-bottom: var(--space-2);">No servers found</h3>
                <p style="color: var(--text-muted); margin-bottom: var(--space-6);">Be the first to create a public server and build your community!</p>
                {{if .User}}
                <button class="btn btn-primary" onclick="showCreateServerModal()">Create Server</button>
                {{else}}
                <a href="/register" class="btn btn-primary">Sign Up to Create</a>
                {{end}}
            </div>
            {{end}}
        </div>

        <div id="loading-state" class="hidden" style="text-align: center; padding: var(--space-8); color: var(--text-muted);">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite;">
                <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
            </svg>
            <p style="margin-top: var(--space-2);">Loading servers...</p>
        </div>
    </div>
</div>

<!-- Create Server Modal -->
<div class="modal-overlay" id="create-server-modal">
    <div class="modal">
        <div class="modal-header">
            <h2>Create a Server</h2>
            <p>Give your server a name and start building your community.</p>
        </div>
        <div class="modal-body">
            <form id="create-server-form">
                <div class="form-group">
                    <label class="form-label required" for="server-name">Server Name</label>
                    <input class="form-input" type="text" id="server-name" name="name" required maxlength="100" placeholder="My Awesome Server">
                </div>
                <div class="form-group">
                    <label class="form-label" for="server-description">Description</label>
                    <textarea class="form-input" id="server-description" name="description" rows="3" maxlength="1024" placeholder="What's your server about?"></textarea>
                </div>
                <label class="form-checkbox">
                    <input type="checkbox" name="is_public" checked>
                    <span class="form-checkbox-label">Make this server public (visible in Explore)</span>
                </label>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeCreateServerModal()">Cancel</button>
            <button class="btn btn-primary" onclick="createServer()">Create Server</button>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toast-container"></div>

<script>
let currentCategory = 'all';
let currentSearch = '';
let currentSort = 'popular';

// Category tabs
document.querySelectorAll('.explore-tab').forEach(tab => {
    tab.addEventListener('click', () => {
        document.querySelectorAll('.explore-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        currentCategory = tab.dataset.category;
        updateSectionTitle();
        filterServers();
    });
});

// Sort select
document.getElementById('sort-select')?.addEventListener('change', (e) => {
    currentSort = e.target.value;
    filterServers();
});

// Search input
document.getElementById('search-input')?.addEventListener('input', debounce((e) => {
    currentSearch = e.target.value.toLowerCase();
    filterServers();
}, 300));

document.getElementById('search-input')?.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
        e.preventDefault();
        performSearch();
    }
});

function updateSectionTitle() {
    const titles = {
        all: 'Popular Servers',
        gaming: 'Gaming Servers',
        music: 'Music Servers',
        education: 'Education Servers',
        science: 'Science & Tech Servers',
        entertainment: 'Entertainment Servers',
        creative: 'Creative Servers'
    };
    const el = document.getElementById('section-title');
    if (el) el.textContent = currentSearch ? `Search Results` : titles[currentCategory] || 'Servers';
}

function filterServers() {
    const cards = document.querySelectorAll('.server-card');
    let visibleCount = 0;

    cards.forEach(card => {
        const category = card.dataset.category || 'all';
        const name = card.querySelector('.server-card-name')?.textContent.toLowerCase() || '';
        const desc = card.querySelector('.server-card-description')?.textContent.toLowerCase() || '';

        const matchesCategory = currentCategory === 'all' || category === currentCategory;
        const matchesSearch = !currentSearch || name.includes(currentSearch) || desc.includes(currentSearch);

        if (matchesCategory && matchesSearch) {
            card.style.display = '';
            visibleCount++;
        } else {
            card.style.display = 'none';
        }
    });

    // Show/hide empty state
    const emptyState = document.getElementById('empty-state');
    if (emptyState) {
        emptyState.style.display = visibleCount === 0 ? '' : 'none';
    }
}

function performSearch() {
    currentSearch = document.getElementById('search-input')?.value.toLowerCase() || '';
    updateSectionTitle();
    filterServers();
}

function debounce(fn, delay) {
    let timeout;
    return (...args) => {
        clearTimeout(timeout);
        timeout = setTimeout(() => fn(...args), delay);
    };
}

// Create server modal
function showCreateServerModal() {
    document.getElementById('create-server-modal')?.classList.add('open');
}

function closeCreateServerModal() {
    document.getElementById('create-server-modal')?.classList.remove('open');
    document.getElementById('create-server-form')?.reset();
}

async function createServer() {
    const form = document.getElementById('create-server-form');
    if (!form) return;

    const name = form.querySelector('#server-name').value.trim();
    const description = form.querySelector('#server-description').value.trim();
    const isPublic = form.querySelector('[name="is_public"]').checked;

    if (!name) {
        showToast('Please enter a server name', 'error');
        return;
    }

    try {
        const res = await fetch('/api/v1/servers', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, description, is_public: isPublic })
        });

        if (res.ok) {
            const data = await res.json();
            showToast('Server created!', 'success');
            setTimeout(() => {
                window.location.href = `/channels/${data.data.id}/${data.data.default_channel}`;
            }, 500);
        } else {
            const json = await res.json();
            showToast(json.error?.message || 'Failed to create server', 'error');
        }
    } catch (err) {
        showToast('Failed to create server', 'error');
    }
}

// Join server
async function joinServer(serverId) {
    try {
        const res = await fetch(`/api/v1/servers/${serverId}/join`, { method: 'POST' });

        if (res.ok) {
            const data = await res.json();
            showToast('Joined server!', 'success');
            setTimeout(() => {
                window.location.href = `/channels/${data.data.id}/${data.data.default_channel}`;
            }, 500);
        } else {
            const json = await res.json();
            if (json.error?.code === 'ALREADY_MEMBER') {
                window.location.href = `/channels/${serverId}`;
            } else {
                showToast(json.error?.message || 'Failed to join server', 'error');
            }
        }
    } catch (err) {
        showToast('Failed to join server', 'error');
    }
}

// Toast
function showToast(message, type = 'info') {
    const container = document.getElementById('toast-container');
    if (!container) return;
    const icons = {
        success: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>',
        error: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>',
        info: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>'
    };
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.innerHTML = `<span class="toast-icon">${icons[type]}</span><div class="toast-content"><div class="toast-message">${message}</div></div><button class="toast-close" onclick="this.parentElement.remove()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>`;
    container.appendChild(toast);
    setTimeout(() => toast.remove(), 5000);
}

// Keyboard shortcuts
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        closeCreateServerModal();
    }
});

// Close modal on backdrop click
document.getElementById('create-server-modal')?.addEventListener('click', (e) => {
    if (e.target.id === 'create-server-modal') {
        closeCreateServerModal();
    }
});
</script>
{{end}}
