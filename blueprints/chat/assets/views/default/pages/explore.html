{{define "explore.html"}}
{{template "default.html" .}}
{{end}}

{{define "content"}}
<div class="min-h-screen bg-white">
    {{if .Data.isLoggedIn}}
    <!-- Logged in: Show with sidebar -->
    <div class="flex h-screen">
        {{template "channel_list.html" .}}
        <div class="flex-1 flex flex-col min-w-0">
            <header class="h-14 flex items-center justify-between px-6 border-b border-gpt-border shrink-0">
                <h1 class="font-semibold text-gpt-text">Explore</h1>
            </header>
            <div class="flex-1 overflow-y-auto scrollbar-thin">
                {{template "explore_content" .}}
            </div>
        </div>
    </div>
    {{else}}
    <!-- Public: Show with navbar -->
    <nav class="sticky top-0 z-50 bg-white/80 backdrop-blur-md border-b border-gpt-border">
        <div class="max-w-5xl mx-auto px-6 h-14 flex items-center justify-between">
            <a href="/" class="flex items-center gap-2">
                <div class="w-7 h-7 rounded-lg bg-gpt-accent flex items-center justify-center">
                    <svg class="w-4 h-4 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                    </svg>
                </div>
                <span class="font-semibold text-gpt-text">Mizu</span>
            </a>
            <div class="flex items-center gap-3">
                <a href="/login" class="px-4 py-2 text-sm font-medium text-gpt-text hover:text-gpt-text-secondary transition-colors">Log in</a>
                <a href="/register" class="px-4 py-2 rounded-full text-sm font-medium text-white bg-gpt-accent hover:opacity-90 transition-opacity">Sign up</a>
            </div>
        </div>
    </nav>
    <div class="overflow-y-auto">
        {{template "explore_content" .}}
    </div>
    {{end}}
</div>

<script>
// Search
const searchInput = document.getElementById('search-input');
const serverCards = document.querySelectorAll('[data-server-name]');
const serverCount = document.getElementById('server-count');
const noResults = document.getElementById('no-results');
const serverGrid = document.getElementById('server-grid');

searchInput?.addEventListener('input', (e) => {
    const query = e.target.value.toLowerCase().trim();
    let visible = 0;

    serverCards.forEach(card => {
        const name = card.dataset.serverName.toLowerCase();
        const match = name.includes(query);
        card.style.display = match ? '' : 'none';
        if (match) visible++;
    });

    if (serverCount) serverCount.textContent = visible;
    if (noResults) noResults.classList.toggle('hidden', visible > 0);
    if (serverGrid) serverGrid.classList.toggle('hidden', visible === 0);
});

// Join
async function joinServer(id) {
    {{if not .Data.isLoggedIn}}
    window.location.href = '/login';
    return;
    {{end}}

    const btn = event.currentTarget;
    btn.disabled = true;
    btn.textContent = 'Joining...';

    try {
        const res = await fetch(`/api/v1/servers/${id}/join`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        if (res.ok) {
            const data = await res.json();
            window.location.href = `/channels/${id}/${data.data?.default_channel || ''}`;
        } else {
            const err = await res.json();
            if (err.error?.includes('already')) {
                window.location.href = `/channels/${id}/`;
            } else {
                btn.disabled = false;
                btn.textContent = 'Join';
            }
        }
    } catch {
        btn.disabled = false;
        btn.textContent = 'Join';
    }
}
</script>
{{end}}

{{define "explore_content"}}
<div class="max-w-3xl mx-auto px-6 py-10">
    <!-- Header -->
    <div class="mb-8">
        <h2 class="text-2xl font-semibold text-gpt-text mb-2">Discover communities</h2>
        <p class="text-gpt-text-secondary">Find and join public communities on Mizu.</p>
    </div>

    <!-- Search -->
    <div class="relative mb-8">
        <svg class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gpt-text-muted pointer-events-none" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"/>
            <path d="m21 21-4.35-4.35"/>
        </svg>
        <input
            type="text"
            id="search-input"
            placeholder="Search communities..."
            class="w-full pl-12 pr-4 py-3 rounded-xl text-base bg-gpt-sidebar border border-gpt-border text-gpt-text placeholder:text-gpt-text-muted outline-none focus:border-gpt-text-muted transition-colors"
        >
    </div>

    {{if .Data.publicServers}}
    <!-- Count -->
    <p class="text-sm text-gpt-text-muted mb-4"><span id="server-count">{{len .Data.publicServers}}</span> communities</p>

    <!-- Server List -->
    <div class="space-y-3" id="server-grid">
        {{range .Data.publicServers}}
        <a
            href="/channels/{{.ID}}/"
            data-server-name="{{.Name}}"
            class="group flex items-center gap-4 p-4 rounded-xl border border-gpt-border bg-white hover:border-gpt-text-muted hover:shadow-sm transition-all cursor-pointer"
        >
            <!-- Icon -->
            <div class="w-12 h-12 rounded-xl bg-gpt-sidebar flex items-center justify-center text-lg font-medium shrink-0 overflow-hidden">
                {{if .IconURL}}
                <img src="{{.IconURL}}" alt="" class="w-full h-full object-cover">
                {{else}}
                <span class="text-gpt-text-secondary">{{slice .Name 0 1}}</span>
                {{end}}
            </div>

            <!-- Info -->
            <div class="flex-1 min-w-0">
                <div class="flex items-center gap-1.5 mb-0.5">
                    <h3 class="font-medium text-gpt-text truncate">{{.Name}}</h3>
                    {{if .IsVerified}}
                    <svg class="w-4 h-4 text-blue-500 shrink-0" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                    </svg>
                    {{end}}
                </div>
                <p class="text-sm text-gpt-text-secondary truncate">{{if .Description}}{{.Description}}{{else}}A community on Mizu{{end}}</p>
            </div>

            <!-- Stats -->
            <div class="hidden sm:flex items-center gap-1.5 text-sm text-gpt-text-muted shrink-0">
                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                    <circle cx="9" cy="7" r="4"/>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/>
                </svg>
                <span>{{.MemberCount}}</span>
            </div>

            <!-- Join Button -->
            <button
                onclick="event.preventDefault(); joinServer('{{.ID}}')"
                class="px-4 py-2 rounded-lg text-sm font-medium bg-gpt-accent text-white hover:opacity-90 active:scale-95 transition-all shrink-0"
            >
                Join
            </button>
        </a>
        {{end}}
    </div>

    <!-- No Results -->
    <div id="no-results" class="hidden py-16 text-center">
        <p class="text-gpt-text-secondary">No communities found</p>
    </div>

    {{else}}
    <!-- Empty State -->
    <div class="py-16 text-center">
        <div class="w-14 h-14 rounded-xl bg-gpt-sidebar flex items-center justify-center mx-auto mb-4">
            <svg class="w-7 h-7 text-gpt-text-muted" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <circle cx="12" cy="12" r="10"/>
                <path d="M8 12h8M12 8v8"/>
            </svg>
        </div>
        <h3 class="font-medium text-gpt-text mb-1">No communities yet</h3>
        <p class="text-sm text-gpt-text-secondary mb-6">Be the first to create one.</p>
        {{if .Data.isLoggedIn}}
        <button onclick="openCreateServerModal()" class="px-5 py-2.5 rounded-lg text-sm font-medium bg-gpt-accent text-white hover:opacity-90 transition-opacity">
            Create community
        </button>
        {{else}}
        <a href="/register" class="inline-block px-5 py-2.5 rounded-lg text-sm font-medium bg-gpt-accent text-white hover:opacity-90 transition-opacity">
            Get started
        </a>
        {{end}}
    </div>
    {{end}}

    {{if and .Data.publicServers .Data.isLoggedIn}}
    <!-- Create CTA -->
    <div class="mt-10 pt-8 border-t border-gpt-border text-center">
        <p class="text-sm text-gpt-text-secondary mb-4">Don't see what you're looking for?</p>
        <button onclick="openCreateServerModal()" class="px-5 py-2.5 rounded-lg text-sm font-medium border border-gpt-border text-gpt-text hover:bg-gpt-sidebar transition-colors">
            Create your own
        </button>
    </div>
    {{end}}
</div>
{{end}}
