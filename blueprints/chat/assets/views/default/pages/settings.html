{{define "settings.html"}}
{{template "default.html" .}}
{{end}}

{{define "content"}}
<div class="settings">
    <aside class="settings-sidebar">
        <div class="settings-nav-category">User Settings</div>
        <nav class="settings-nav">
            <a href="/settings" class="settings-nav-item active">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                </svg>
                My Account
            </a>
            <a href="/settings/profile" class="settings-nav-item">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 3c1.93 0 3.5 1.57 3.5 3.5S13.93 13 12 13s-3.5-1.57-3.5-3.5S10.07 6 12 6zm7 13H5v-.23c0-.62.28-1.2.76-1.58C7.47 15.82 9.64 15 12 15s4.53.82 6.24 2.19c.48.38.76.97.76 1.58V19z"/>
                </svg>
                Profile
            </a>
            <a href="/settings/appearance" class="settings-nav-item">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9c.83 0 1.5-.67 1.5-1.5 0-.39-.15-.74-.39-1.01-.23-.26-.38-.61-.38-.99 0-.83.67-1.5 1.5-1.5H16c2.76 0 5-2.24 5-5 0-4.42-4.03-8-9-8zm-5.5 9c-.83 0-1.5-.67-1.5-1.5S5.67 9 6.5 9 8 9.67 8 10.5 7.33 12 6.5 12zm3-4C8.67 8 8 7.33 8 6.5S8.67 5 9.5 5s1.5.67 1.5 1.5S10.33 8 9.5 8zm5 0c-.83 0-1.5-.67-1.5-1.5S13.67 5 14.5 5s1.5.67 1.5 1.5S15.33 8 14.5 8zm3 4c-.83 0-1.5-.67-1.5-1.5S16.67 9 17.5 9s1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/>
                </svg>
                Appearance
            </a>
        </nav>

        <div class="settings-nav-category">App Settings</div>
        <nav class="settings-nav">
            <a href="/settings/notifications" class="settings-nav-item">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.89 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/>
                </svg>
                Notifications
            </a>
            <a href="/settings/privacy" class="settings-nav-item">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/>
                </svg>
                Privacy & Safety
            </a>
        </nav>

        <div class="settings-nav" style="margin-top: auto; border-top: 1px solid var(--divider); padding-top: 1rem;">
            <button onclick="logout()" class="settings-nav-item" style="color: var(--text-danger); width: 100%; text-align: left;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/>
                </svg>
                Log Out
            </button>
        </div>
    </aside>

    <main class="settings-content">
        <a href="/" class="settings-close" title="Close">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 6L6 18M6 6l12 12"/>
            </svg>
        </a>

        <section class="settings-section">
            <h2>My Account</h2>

            <div style="background: var(--bg-secondary); border-radius: var(--radius-lg); padding: var(--space-4); margin-bottom: var(--space-6);">
                <div style="display: flex; align-items: center; gap: var(--space-4);">
                    <div class="user-avatar" style="width: 80px; height: 80px; font-size: 2rem;">
                        {{if .User.AvatarURL}}
                            <img src="{{.User.AvatarURL}}" alt="{{.User.DisplayName}}">
                        {{else}}
                            <span>{{userInitials .User.DisplayName}}</span>
                        {{end}}
                    </div>
                    <div style="flex: 1;">
                        <h3 style="font-size: var(--font-size-xl); margin-bottom: var(--space-1);">{{.User.DisplayName}}</h3>
                        <p style="color: var(--text-muted);">{{.User.Username}}#{{.User.Discriminator}}</p>
                    </div>
                    <button class="btn btn-secondary">Edit User Profile</button>
                </div>
            </div>

            <h3>Profile</h3>
            <form id="profile-form">
                <div class="form-group">
                    <label class="form-label" for="display_name">Display Name</label>
                    <input class="form-input" type="text" id="display_name" name="display_name" value="{{.User.DisplayName}}">
                </div>

                <div class="form-group">
                    <label class="form-label" for="bio">About Me</label>
                    <textarea class="form-input" id="bio" name="bio" rows="4" style="resize: vertical;" placeholder="Tell us about yourself...">{{.User.Bio}}</textarea>
                </div>

                <div id="save-message" class="form-hint hidden" style="color: var(--text-positive);"></div>

                <button type="submit" class="btn btn-primary" id="save-btn">Save Changes</button>
            </form>
        </section>
    </main>
</div>

<script>
document.getElementById('profile-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target;
    const btn = document.getElementById('save-btn');
    const msg = document.getElementById('save-message');

    btn.disabled = true;
    btn.textContent = 'Saving...';

    try {
        const res = await fetch('/api/v1/auth/me', {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                display_name: form.display_name.value,
                bio: form.bio.value
            })
        });

        if (res.ok) {
            msg.textContent = 'Changes saved successfully!';
            msg.classList.remove('hidden');
            setTimeout(() => msg.classList.add('hidden'), 3000);
        } else {
            const json = await res.json();
            alert(json.error?.message || 'Failed to save changes');
        }
    } catch (err) {
        alert('Failed to save changes');
    } finally {
        btn.disabled = false;
        btn.textContent = 'Save Changes';
    }
});

async function logout() {
    await fetch('/api/v1/auth/logout', { method: 'POST' });
    window.location.href = '/';
}
</script>
{{end}}
