{{define "settings.html"}}
{{template "default.html" .}}
{{end}}

{{define "content"}}
<div class="min-h-screen flex bg-white">
    <!-- Sidebar Navigation -->
    <aside class="w-64 shrink-0 p-4 border-r border-gpt-border bg-gpt-sidebar">
        <div class="mb-6">
            <a href="/" class="sidebar-item flex items-center gap-2 text-sm font-medium px-3 py-2.5 rounded-lg text-gpt-text">
                <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="15 18 9 12 15 6"/>
                </svg>
                Back to app
            </a>
        </div>

        <nav class="space-y-1">
            <span class="block text-xs font-medium uppercase tracking-wider px-3 py-2 text-gpt-text-muted">User Settings</span>

            <a href="#profile" class="nav-link sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm active" data-section="profile">
                <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                    <circle cx="12" cy="7" r="4"/>
                </svg>
                Profile
            </a>

            <a href="#password" class="nav-link sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm" data-section="password">
                <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                    <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                </svg>
                Password
            </a>

            <div class="pt-4">
                <button onclick="logout()" class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm w-full text-left text-red-500 hover:bg-red-50">
                    <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                        <polyline points="16 17 21 12 16 7"/>
                        <line x1="21" y1="12" x2="9" y2="12"/>
                    </svg>
                    Log Out
                </button>
            </div>
        </nav>
    </aside>

    <!-- Content Area -->
    <main class="flex-1 p-8 overflow-y-auto">
        <div class="max-w-2xl">
            <!-- Profile Section -->
            <section id="profile" class="mb-12">
                <h2 class="text-xl font-semibold text-gpt-text mb-6">Profile</h2>

                <!-- Avatar -->
                <div class="flex items-center gap-5 mb-8 p-4 rounded-2xl bg-gpt-sidebar border border-gpt-border">
                    <div class="w-20 h-20 rounded-full flex items-center justify-center text-2xl font-semibold overflow-hidden bg-gpt-sidebar-hover">
                        {{if .User.AvatarURL}}
                            <img src="{{.User.AvatarURL}}" alt="{{.User.DisplayName}}" class="w-full h-full object-cover">
                        {{else}}
                            <span class="text-gpt-text">{{userInitials .User.DisplayName}}</span>
                        {{end}}
                    </div>
                    <div>
                        <label class="inline-flex items-center gap-2 px-4 py-2.5 rounded-lg text-sm font-medium cursor-pointer transition-colors btn-transition bg-gpt-accent hover:opacity-90 text-white">
                            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="17 8 12 3 7 8"/>
                                <line x1="12" y1="3" x2="12" y2="15"/>
                            </svg>
                            Upload Photo
                            <input type="file" id="avatar-upload" accept="image/*" class="hidden" onchange="uploadAvatar(this)">
                        </label>
                        <p class="mt-2 text-xs text-gpt-text-muted">JPG, PNG or GIF. Max 5MB.</p>
                    </div>
                </div>

                <!-- Profile Form -->
                <form id="profile-form" class="space-y-5">
                    <div>
                        <label class="block text-sm font-medium text-gpt-text mb-2">Display Name</label>
                        <input
                            type="text"
                            id="display_name"
                            name="display_name"
                            value="{{.User.DisplayName}}"
                            maxlength="32"
                            class="w-full px-4 py-3 rounded-xl text-sm outline-none transition-all bg-gpt-input-bg border border-gpt-border text-gpt-text focus:ring-2 focus:ring-gpt-accent"
                        >
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gpt-text mb-2">Bio</label>
                        <textarea
                            id="bio"
                            name="bio"
                            rows="3"
                            maxlength="190"
                            placeholder="Tell us about yourself..."
                            class="w-full px-4 py-3 rounded-xl text-sm outline-none resize-none transition-all bg-gpt-input-bg border border-gpt-border text-gpt-text focus:ring-2 focus:ring-gpt-accent placeholder:text-gpt-text-muted"
                        >{{.User.Bio}}</textarea>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gpt-text-muted mb-2">Email</label>
                            <p class="text-sm px-4 py-3 rounded-xl bg-gpt-sidebar border border-gpt-border text-gpt-text">{{.User.Email}}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gpt-text-muted mb-2">Username</label>
                            <p class="text-sm px-4 py-3 rounded-xl bg-gpt-sidebar border border-gpt-border text-gpt-text">@{{.User.Username}}</p>
                        </div>
                    </div>

                    <div id="profile-message" class="hidden text-sm text-green-600 bg-green-50 px-4 py-3 rounded-xl border border-green-200"></div>

                    <button
                        type="submit"
                        class="px-5 py-2.5 rounded-lg text-sm font-medium text-white transition-colors btn-transition bg-gpt-accent hover:opacity-90"
                    >
                        Save Changes
                    </button>
                </form>
            </section>

            <!-- Password Section -->
            <section id="password" class="mb-12 pt-8 border-t border-gpt-border">
                <h2 class="text-xl font-semibold text-gpt-text mb-6">Password</h2>

                <form id="password-form" class="space-y-5 max-w-md">
                    <div>
                        <label class="block text-sm font-medium text-gpt-text mb-2">Current Password</label>
                        <input
                            type="password"
                            id="current_password"
                            name="current_password"
                            required
                            autocomplete="current-password"
                            class="w-full px-4 py-3 rounded-xl text-sm outline-none transition-all bg-gpt-input-bg border border-gpt-border text-gpt-text focus:ring-2 focus:ring-gpt-accent"
                        >
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gpt-text mb-2">New Password</label>
                        <input
                            type="password"
                            id="new_password"
                            name="new_password"
                            required
                            minlength="8"
                            autocomplete="new-password"
                            class="w-full px-4 py-3 rounded-xl text-sm outline-none transition-all bg-gpt-input-bg border border-gpt-border text-gpt-text focus:ring-2 focus:ring-gpt-accent"
                        >
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gpt-text mb-2">Confirm New Password</label>
                        <input
                            type="password"
                            id="confirm_new_password"
                            name="confirm_new_password"
                            required
                            autocomplete="new-password"
                            class="w-full px-4 py-3 rounded-xl text-sm outline-none transition-all bg-gpt-input-bg border border-gpt-border text-gpt-text focus:ring-2 focus:ring-gpt-accent"
                        >
                    </div>

                    <div id="password-error" class="hidden text-sm text-red-600 bg-red-50 px-4 py-3 rounded-xl border border-red-200"></div>
                    <div id="password-success" class="hidden text-sm text-green-600 bg-green-50 px-4 py-3 rounded-xl border border-green-200"></div>

                    <button
                        type="submit"
                        class="px-5 py-2.5 rounded-lg text-sm font-medium text-white transition-colors btn-transition bg-gpt-accent hover:opacity-90"
                    >
                        Change Password
                    </button>
                </form>
            </section>

            <!-- Danger Zone -->
            <section class="pt-8 border-t border-gpt-border">
                <h2 class="text-xl font-semibold text-red-500 mb-2">Danger Zone</h2>
                <p class="text-sm text-gpt-text-secondary mb-5">Permanently delete your account and all of your data. This action cannot be undone.</p>
                <button
                    onclick="showDeleteModal()"
                    class="px-5 py-2.5 rounded-lg text-sm font-medium text-white bg-red-500 hover:bg-red-600 transition-colors btn-transition"
                >
                    Delete Account
                </button>
            </section>
        </div>
    </main>
</div>

<!-- Delete Account Modal -->
<div id="delete-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop bg-black/50">
    <div class="w-full max-w-md mx-4 rounded-2xl p-6 animate-slide-up bg-white border border-gpt-border shadow-xl">
        <div class="flex items-center gap-3 mb-4">
            <div class="w-10 h-10 rounded-full flex items-center justify-center bg-red-50">
                <svg class="w-5 h-5 text-red-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                    <line x1="12" y1="9" x2="12" y2="13"/>
                    <line x1="12" y1="17" x2="12.01" y2="17"/>
                </svg>
            </div>
            <div>
                <h2 class="text-lg font-semibold text-red-500">Delete Account</h2>
            </div>
        </div>
        <p class="text-sm text-gpt-text-secondary mb-6">This action is permanent and cannot be undone. All your data will be deleted.</p>

        <div class="mb-6">
            <label class="block text-sm font-medium text-gpt-text mb-2">Type DELETE to confirm</label>
            <input
                type="text"
                id="delete-confirm"
                placeholder="DELETE"
                class="w-full px-4 py-3 rounded-xl text-sm outline-none transition-all bg-gpt-input-bg border border-gpt-border text-gpt-text focus:ring-2 focus:ring-red-500"
            >
        </div>

        <div class="flex gap-3 justify-end">
            <button
                onclick="closeDeleteModal()"
                class="px-4 py-2.5 rounded-lg text-sm font-medium text-gpt-text hover:bg-gpt-sidebar-hover transition-colors btn-transition"
            >
                Cancel
            </button>
            <button
                id="delete-btn"
                onclick="deleteAccount()"
                disabled
                class="px-4 py-2.5 rounded-lg text-sm font-medium text-white bg-red-500 hover:bg-red-600 transition-colors btn-transition disabled:opacity-50 disabled:cursor-not-allowed"
            >
                Delete Account
            </button>
        </div>
    </div>
</div>

<script>
// Navigation active state
function updateNavigation() {
    const hash = window.location.hash || '#profile';
    document.querySelectorAll('.nav-link').forEach(link => {
        const section = link.dataset.section;
        if ('#' + section === hash) {
            link.classList.add('active', 'bg-gpt-sidebar-active', 'text-gpt-text');
            link.classList.remove('text-gpt-text-secondary');
        } else {
            link.classList.remove('active', 'bg-gpt-sidebar-active', 'text-gpt-text');
            link.classList.add('text-gpt-text-secondary');
        }
    });
}

// Profile form
document.getElementById('profile-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target;
    const msg = document.getElementById('profile-message');
    const btn = form.querySelector('[type="submit"]');

    btn.disabled = true;
    btn.textContent = 'Saving...';

    try {
        const res = await fetch('/api/v1/auth/me', {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                display_name: form.display_name.value,
                bio: form.bio.value
            })
        });

        if (res.ok) {
            msg.textContent = 'Changes saved successfully!';
            msg.classList.remove('hidden');
            setTimeout(() => msg.classList.add('hidden'), 3000);
        }
    } catch (err) {
        console.error('Failed to save');
    }

    btn.disabled = false;
    btn.textContent = 'Save Changes';
});

// Password form
document.getElementById('password-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target;
    const errorEl = document.getElementById('password-error');
    const successEl = document.getElementById('password-success');
    const btn = form.querySelector('[type="submit"]');

    errorEl.classList.add('hidden');
    successEl.classList.add('hidden');

    if (form.new_password.value !== form.confirm_new_password.value) {
        errorEl.textContent = 'Passwords do not match';
        errorEl.classList.remove('hidden');
        return;
    }

    btn.disabled = true;
    btn.textContent = 'Changing...';

    try {
        const res = await fetch('/api/v1/auth/change-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                current_password: form.current_password.value,
                new_password: form.new_password.value
            })
        });

        if (res.ok) {
            successEl.textContent = 'Password changed successfully!';
            successEl.classList.remove('hidden');
            form.reset();
            setTimeout(() => successEl.classList.add('hidden'), 3000);
        } else {
            const json = await res.json();
            errorEl.textContent = json.error?.message || 'Failed to change password';
            errorEl.classList.remove('hidden');
        }
    } catch (err) {
        errorEl.textContent = 'Failed to change password';
        errorEl.classList.remove('hidden');
    }

    btn.disabled = false;
    btn.textContent = 'Change Password';
});

// Avatar upload
async function uploadAvatar(input) {
    if (!input.files?.[0]) return;

    const formData = new FormData();
    formData.append('avatar', input.files[0]);

    try {
        const res = await fetch('/api/v1/auth/avatar', {
            method: 'POST',
            body: formData
        });

        if (res.ok) {
            location.reload();
        }
    } catch (err) {
        console.error('Failed to upload avatar');
    }
}

// Delete account
function showDeleteModal() {
    document.getElementById('delete-modal')?.classList.remove('hidden');
    document.getElementById('delete-modal')?.classList.add('flex');
    document.getElementById('delete-confirm')?.focus();
}

function closeDeleteModal() {
    document.getElementById('delete-modal')?.classList.add('hidden');
    document.getElementById('delete-modal')?.classList.remove('flex');
    document.getElementById('delete-confirm').value = '';
    document.getElementById('delete-btn').disabled = true;
}

document.getElementById('delete-confirm')?.addEventListener('input', (e) => {
    document.getElementById('delete-btn').disabled = e.target.value !== 'DELETE';
});

async function deleteAccount() {
    const btn = document.getElementById('delete-btn');
    btn.disabled = true;
    btn.textContent = 'Deleting...';

    try {
        const res = await fetch('/api/v1/auth/delete', { method: 'DELETE' });
        if (res.ok) {
            window.location.href = '/login';
        }
    } catch (err) {
        console.error('Failed to delete account');
        btn.disabled = false;
        btn.textContent = 'Delete Account';
    }
}

// Logout
async function logout() {
    await fetch('/api/v1/auth/logout', { method: 'POST' });
    window.location.href = '/login';
}

// Initialize
updateNavigation();

window.addEventListener('hashchange', updateNavigation);

document.getElementById('delete-modal')?.addEventListener('click', (e) => {
    if (e.target.id === 'delete-modal') closeDeleteModal();
});

document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeDeleteModal();
});
</script>
{{end}}
