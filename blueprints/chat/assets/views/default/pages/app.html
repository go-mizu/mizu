{{define "app.html"}}
{{template "default.html" .}}
{{end}}

{{define "content"}}
<div class="flex h-screen bg-white">
    <!-- Sidebar -->
    {{template "channel_list.html" .}}

    <!-- Main Chat Area -->
    <div class="flex-1 flex flex-col min-w-0">
        <!-- Header -->
        <header class="h-14 flex items-center justify-between px-4 border-b border-gpt-border shrink-0">
            <div class="flex items-center gap-2">
                <!-- Sidebar toggle for mobile -->
                <button id="sidebar-toggle" class="p-2 -ml-2 rounded-lg hover:bg-gpt-sidebar-hover lg:hidden">
                    <svg class="w-5 h-5 text-gpt-text" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                        <line x1="9" y1="3" x2="9" y2="21"/>
                    </svg>
                </button>
                <!-- Model selector -->
                <button class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg hover:bg-gpt-sidebar-hover transition-colors">
                    <span class="font-semibold text-gpt-text">Mizu Chat</span>
                    <svg class="w-4 h-4 text-gpt-text-secondary" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6 9 12 15 18 9"/>
                    </svg>
                </button>
            </div>
            <div class="flex items-center gap-1">
                {{if .Data.currentChannel}}
                <button class="flex items-center gap-2 px-3 py-1.5 rounded-lg text-sm text-gpt-text-secondary hover:bg-gpt-sidebar-hover transition-colors">
                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/>
                        <polyline points="16 6 12 2 8 6"/>
                        <line x1="12" y1="2" x2="12" y2="15"/>
                    </svg>
                    Share
                </button>
                {{end}}
                <a href="/settings" class="p-2 rounded-lg text-gpt-text-secondary hover:bg-gpt-sidebar-hover transition-colors" title="Settings">
                    <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="1"/>
                        <circle cx="19" cy="12" r="1"/>
                        <circle cx="5" cy="12" r="1"/>
                    </svg>
                </a>
            </div>
        </header>

        {{if .Data.currentChannel}}
        <!-- Messages Container -->
        <div class="flex-1 overflow-y-auto scrollbar-thin" id="messages">
            <div class="max-w-chat mx-auto px-4 py-6">
                {{if .Data.messages}}
                    {{range .Data.messages}}
                    <div class="message-wrapper mb-8 animate-fade-in group" data-message-id="{{.ID}}" data-author-id="{{if .Author}}{{.Author.ID}}{{end}}">
                        {{if and .Author (eq .Author.ID $.User.ID)}}
                        <!-- User message - right aligned bubble -->
                        <div class="flex justify-end">
                            <div class="user-message max-w-[85%]">
                                <div class="prose-chat text-gpt-text" data-markdown="{{.Content}}"></div>
                            </div>
                        </div>
                        {{else}}
                        <!-- Assistant/Other message - ChatGPT style -->
                        <div class="flex gap-4">
                            <!-- Avatar -->
                            <div class="w-7 h-7 rounded-full flex items-center justify-center text-sm font-medium shrink-0 overflow-hidden bg-black">
                                {{if .Author}}
                                    {{if .Author.AvatarURL}}
                                        <img src="{{.Author.AvatarURL}}" alt="{{.Author.DisplayName}}" class="w-full h-full object-cover">
                                    {{else}}
                                        <svg class="w-4 h-4 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M12 8V4M12 8C9.79 8 8 9.79 8 12M12 8C14.21 8 16 9.79 16 12M8 12H4M8 12C8 14.21 9.79 16 12 16M16 12H20M16 12C16 14.21 14.21 16 12 16M12 16V20"/>
                                        </svg>
                                    {{end}}
                                {{else}}
                                    <svg class="w-4 h-4 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M12 8V4M12 8C9.79 8 8 9.79 8 12M12 8C14.21 8 16 9.79 16 12M8 12H4M8 12C8 14.21 9.79 16 12 16M16 12H20M16 12C16 14.21 14.21 16 12 16M12 16V20"/>
                                    </svg>
                                {{end}}
                            </div>
                            <!-- Message Content -->
                            <div class="flex-1 min-w-0 pt-0">
                                <div class="font-semibold text-sm text-gpt-text mb-1.5">{{if .Author}}{{.Author.DisplayName}}{{else}}Assistant{{end}}</div>
                                <div class="prose-chat text-gpt-text" data-markdown="{{.Content}}"></div>
                                <!-- Message Actions -->
                                <div class="message-actions mt-2 -ml-1.5">
                                    <button class="message-action-btn copy-message-btn" title="Copy message">
                                        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                                        </svg>
                                    </button>
                                    <button class="message-action-btn" title="Good response">
                                        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"/>
                                        </svg>
                                    </button>
                                    <button class="message-action-btn" title="Bad response">
                                        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M10 15v4a3 3 0 0 0 3 3l4-9V2H5.72a2 2 0 0 0-2 1.7l-1.38 9a2 2 0 0 0 2 2.3zm7-13h2.67A2.31 2.31 0 0 1 22 4v7a2.31 2.31 0 0 1-2.33 2H17"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                        {{end}}
                    </div>
                    {{end}}
                {{else}}
                    <!-- Empty State -->
                    <div class="flex flex-col items-center justify-center py-20 text-center">
                        <div class="w-16 h-16 rounded-full flex items-center justify-center mb-6 bg-gpt-sidebar border border-gpt-border">
                            <svg class="w-8 h-8 text-gpt-text" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                            </svg>
                        </div>
                        <h3 class="text-xl font-semibold text-gpt-text mb-2">Start a conversation</h3>
                        <p class="text-gpt-text-secondary max-w-md">Send a message to begin chatting.</p>
                    </div>
                {{end}}
            </div>
        </div>

        <!-- Scroll to bottom indicator -->
        <div id="scroll-indicator" class="hidden absolute bottom-32 left-1/2 -translate-x-1/2">
            <button onclick="scrollToBottom()" class="p-2 rounded-full bg-white border border-gpt-border shadow-lg hover:bg-gpt-sidebar transition-colors">
                <svg class="w-5 h-5 text-gpt-text" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 12 15 18 9"/>
                </svg>
            </button>
        </div>

        <!-- Message Input -->
        <div class="shrink-0 px-4 pb-4">
            <div class="max-w-chat mx-auto">
                <form id="message-form" class="relative">
                    <div class="relative flex items-end rounded-3xl bg-gpt-input-bg border border-gpt-border shadow-sm">
                        <!-- Attachment button -->
                        <button type="button" class="p-3 text-gpt-text-secondary hover:text-gpt-text transition-colors">
                            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19"/>
                                <line x1="5" y1="12" x2="19" y2="12"/>
                            </svg>
                        </button>
                        <textarea
                            id="message-input"
                            name="content"
                            placeholder="Ask anything"
                            rows="1"
                            class="flex-1 py-3 pr-3 bg-transparent text-gpt-text outline-none resize-none scrollbar-hide placeholder:text-gpt-text-muted"
                            style="max-height: 200px;"
                        ></textarea>
                        <!-- Voice button -->
                        <button type="button" class="p-3 text-gpt-text-secondary hover:text-gpt-text transition-colors">
                            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
                                <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                                <line x1="12" y1="19" x2="12" y2="23"/>
                                <line x1="8" y1="23" x2="16" y2="23"/>
                            </svg>
                        </button>
                        <!-- Send button -->
                        <button
                            type="submit"
                            id="send-btn"
                            disabled
                            class="p-2 m-1.5 rounded-full transition-all btn-transition disabled:opacity-30 bg-gpt-accent disabled:bg-gpt-text-muted"
                        >
                            <svg class="w-5 h-5 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="19" x2="12" y2="5"/>
                                <polyline points="5 12 12 5 19 12"/>
                            </svg>
                        </button>
                    </div>
                </form>
                <p class="text-xs text-center text-gpt-text-muted mt-2">Mizu Chat can make mistakes. Check important info.</p>
            </div>
        </div>
        {{else}}
        <!-- No Channel Selected -->
        <div class="flex-1 flex flex-col items-center justify-center text-center p-6">
            <div class="w-20 h-20 rounded-full flex items-center justify-center mb-6 bg-gpt-sidebar border border-gpt-border">
                <svg class="w-10 h-10 text-gpt-text" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                </svg>
            </div>
            <h2 class="text-2xl font-semibold text-gpt-text mb-3">How can I help you today?</h2>
            <p class="text-gpt-text-secondary max-w-md mb-6">Select a conversation from the sidebar or start a new chat.</p>
            <button onclick="document.getElementById('new-chat-btn')?.click()" class="px-4 py-2.5 rounded-full text-sm font-medium text-white bg-gpt-accent hover:opacity-90 transition-opacity btn-transition">
                New Chat
            </button>
        </div>
        {{end}}
    </div>
</div>

<script>
const CONFIG = {
    userId: '{{.User.ID}}',
    serverId: {{if .Data.currentServer}}'{{.Data.currentServer.ID}}'{{else}}null{{end}},
    channelId: {{if .Data.currentChannel}}'{{.Data.currentChannel.ID}}'{{else}}null{{end}},
    channelName: {{if .Data.currentChannel}}'{{.Data.currentChannel.Name}}'{{else}}''{{end}}
};

let ws = null;
let reconnectTimeout = null;

// Configure marked.js
marked.setOptions({
    gfm: true,
    breaks: true,
    highlight: function(code, lang) {
        if (lang && hljs.getLanguage(lang)) {
            try {
                return hljs.highlight(code, { language: lang }).value;
            } catch (e) {}
        }
        return hljs.highlightAuto(code).value;
    }
});

// Custom renderer for code blocks with ChatGPT-style wrapper
const renderer = {
    code(token) {
        // marked v5+ passes an object with text and lang properties
        const code = typeof token === 'string' ? token : (token.text || '');
        const lang = (typeof token === 'object' ? token.lang : null) || 'plaintext';
        let highlighted = '';

        try {
            if (typeof hljs !== 'undefined') {
                if (lang && lang !== 'plaintext' && hljs.getLanguage(lang)) {
                    highlighted = hljs.highlight(code, { language: lang }).value;
                } else {
                    highlighted = hljs.highlightAuto(code).value;
                }
            } else {
                highlighted = code.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            }
        } catch (e) {
            console.error('Highlight error:', e);
            highlighted = code.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }

        const safeLang = lang.replace(/[<>"'&]/g, '');
        return `<div class="code-block-wrapper">
            <div class="code-block-header">
                <span class="code-block-lang">${safeLang}</span>
                <button class="code-block-copy" onclick="copyCode(this)">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                    </svg>
                    <span>Copy code</span>
                </button>
            </div>
            <pre><code class="hljs language-${safeLang}">${highlighted}</code></pre>
        </div>`;
    }
};
marked.use({ renderer });

// Render markdown content
function renderMarkdown(content) {
    if (!content) return '';
    return marked.parse(content);
}

// Render all messages with markdown
function renderAllMessages() {
    document.querySelectorAll('[data-markdown]').forEach(el => {
        const content = el.getAttribute('data-markdown');
        if (content) {
            el.innerHTML = renderMarkdown(content);
            el.removeAttribute('data-markdown');
        }
    });
}

// Copy code to clipboard
function copyCode(btn) {
    const wrapper = btn.closest('.code-block-wrapper');
    const code = wrapper.querySelector('code').textContent;
    navigator.clipboard.writeText(code).then(() => {
        btn.classList.add('copied');
        btn.querySelector('span').textContent = 'Copied!';
        setTimeout(() => {
            btn.classList.remove('copied');
            btn.querySelector('span').textContent = 'Copy code';
        }, 2000);
    });
}

// Copy entire message
function copyMessage(btn) {
    const wrapper = btn.closest('.message-wrapper');
    const proseEl = wrapper.querySelector('.prose-chat');
    const text = proseEl.innerText;
    navigator.clipboard.writeText(text).then(() => {
        const svg = btn.querySelector('svg');
        const originalPath = svg.innerHTML;
        svg.innerHTML = '<path d="M20 6L9 17l-5-5" stroke="currentColor" stroke-width="2" fill="none"/>';
        setTimeout(() => {
            svg.innerHTML = originalPath;
        }, 2000);
    });
}

// Initialize WebSocket
function initWebSocket() {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const token = document.cookie.split('; ').find(row => row.startsWith('session='))?.split('=')[1];
    if (!token) return;

    ws = new WebSocket(`${protocol}//${window.location.host}/ws?token=${token}`);

    ws.onopen = () => {
        if (reconnectTimeout) {
            clearTimeout(reconnectTimeout);
            reconnectTimeout = null;
        }
    };

    ws.onclose = () => {
        reconnectTimeout = setTimeout(initWebSocket, 3000);
    };

    ws.onerror = (err) => console.error('WebSocket error:', err);

    ws.onmessage = (event) => {
        try {
            handleWSMessage(JSON.parse(event.data));
        } catch (err) {}
    };
}

function handleWSMessage(msg) {
    if (msg.op !== 0) return;
    const data = msg.d;

    switch (msg.t) {
        case 'MESSAGE_CREATE':
            if (data.channel_id === CONFIG.channelId) appendMessage(data);
            break;
        case 'MESSAGE_UPDATE':
            updateMessage(data);
            break;
        case 'MESSAGE_DELETE':
            removeMessage(data.id);
            break;
    }
}

function appendMessage(msg) {
    const container = document.getElementById('messages');
    if (!container) return;

    const wrapper = container.querySelector('.max-w-chat');
    if (!wrapper) return;

    const wasAtBottom = container.scrollHeight - container.scrollTop <= container.clientHeight + 100;

    // Remove empty state if present
    const emptyState = wrapper.querySelector('.py-20');
    if (emptyState) emptyState.remove();

    const isCurrentUser = msg.author?.id === CONFIG.userId;
    const div = document.createElement('div');
    div.className = 'message-wrapper mb-8 animate-slide-up group';
    div.dataset.messageId = msg.id;
    div.dataset.authorId = msg.author?.id || '';

    // Render markdown content
    const renderedContent = renderMarkdown(msg.content);

    if (isCurrentUser) {
        // User message - right aligned bubble
        div.innerHTML = `
            <div class="flex justify-end">
                <div class="user-message max-w-[85%]">
                    <div class="prose-chat text-gpt-text">${renderedContent}</div>
                </div>
            </div>
        `;
    } else {
        // Assistant/Other message - ChatGPT style
        div.innerHTML = `
            <div class="flex gap-4">
                <div class="w-7 h-7 rounded-full flex items-center justify-center text-sm font-medium shrink-0 overflow-hidden bg-black">
                    ${msg.author?.avatar_url
                        ? `<img src="${escapeHtml(msg.author.avatar_url)}" alt="" class="w-full h-full object-cover">`
                        : `<svg class="w-4 h-4 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 8V4M12 8C9.79 8 8 9.79 8 12M12 8C14.21 8 16 9.79 16 12M8 12H4M8 12C8 14.21 9.79 16 12 16M16 12H20M16 12C16 14.21 14.21 16 12 16M12 16V20"/></svg>`
                    }
                </div>
                <div class="flex-1 min-w-0 pt-0">
                    <div class="font-semibold text-sm text-gpt-text mb-1.5">${escapeHtml(msg.author?.display_name || 'Assistant')}</div>
                    <div class="prose-chat text-gpt-text">${renderedContent}</div>
                    <div class="message-actions mt-2 -ml-1.5">
                        <button class="message-action-btn copy-message-btn" onclick="copyMessage(this)" title="Copy message">
                            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                            </svg>
                        </button>
                        <button class="message-action-btn" title="Good response">
                            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"/>
                            </svg>
                        </button>
                        <button class="message-action-btn" title="Bad response">
                            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M10 15v4a3 3 0 0 0 3 3l4-9V2H5.72a2 2 0 0 0-2 1.7l-1.38 9a2 2 0 0 0 2 2.3zm7-13h2.67A2.31 2.31 0 0 1 22 4v7a2.31 2.31 0 0 1-2.33 2H17"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    wrapper.appendChild(div);
    if (wasAtBottom) container.scrollTop = container.scrollHeight;
}

function updateMessage(msg) {
    const el = document.querySelector(`[data-message-id="${msg.id}"]`);
    if (!el) return;
    const body = el.querySelector('.prose-chat');
    if (body) body.innerHTML = renderMarkdown(msg.content);
}

function removeMessage(id) {
    const el = document.querySelector(`[data-message-id="${id}"]`);
    if (el) {
        el.style.opacity = '0';
        el.style.transform = 'translateY(-8px)';
        el.style.transition = 'opacity 0.2s ease, transform 0.2s ease';
        setTimeout(() => el.remove(), 200);
    }
}

async function sendMessage(content) {
    if (!content || !CONFIG.channelId) return false;
    try {
        const res = await fetch(`/api/v1/channels/${CONFIG.channelId}/messages`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content })
        });
        return res.ok;
    } catch (err) {
        return false;
    }
}

function formatTimestamp(iso) {
    const date = new Date(iso);
    const now = new Date();
    const isToday = date.toDateString() === now.toDateString();
    const isYesterday = new Date(now - 86400000).toDateString() === date.toDateString();
    const time = date.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });

    if (isToday) return `Today at ${time}`;
    if (isYesterday) return `Yesterday at ${time}`;
    return date.toLocaleDateString([], { month: 'short', day: 'numeric' }) + ' at ' + time;
}

function escapeHtml(str) {
    if (!str) return '';
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

function scrollToBottom() {
    const messages = document.getElementById('messages');
    if (messages) {
        messages.scrollTo({ top: messages.scrollHeight, behavior: 'smooth' });
    }
}

// Auto-resize textarea
function autoResize(textarea) {
    textarea.style.height = 'auto';
    textarea.style.height = Math.min(textarea.scrollHeight, 200) + 'px';
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    // Render all markdown messages on page load
    renderAllMessages();

    initWebSocket();

    const form = document.getElementById('message-form');
    const input = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');

    // Attach copy handlers to message copy buttons
    document.querySelectorAll('.copy-message-btn').forEach(btn => {
        btn.addEventListener('click', () => copyMessage(btn));
    });

    if (input) {
        // Auto-resize on input
        input.addEventListener('input', () => {
            autoResize(input);
            // Enable/disable send button
            const hasContent = input.value.trim().length > 0;
            sendBtn.disabled = !hasContent;
        });

        // Submit on Enter (without Shift)
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                form.dispatchEvent(new Event('submit'));
            }
        });
    }

    if (form) {
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const content = input.value.trim();
            if (content) {
                input.value = '';
                autoResize(input);
                sendBtn.disabled = true;
                await sendMessage(content);
            }
        });
    }

    // Scroll to bottom
    const messages = document.getElementById('messages');
    if (messages) {
        messages.scrollTop = messages.scrollHeight;

        // Show/hide scroll indicator
        messages.addEventListener('scroll', () => {
            const indicator = document.getElementById('scroll-indicator');
            if (indicator) {
                const isNearBottom = messages.scrollHeight - messages.scrollTop <= messages.clientHeight + 200;
                indicator.classList.toggle('hidden', isNearBottom);
            }
        });
    }

    // Focus input
    input?.focus();

    // Sidebar toggle
    document.getElementById('sidebar-toggle')?.addEventListener('click', () => {
        const sidebar = document.getElementById('sidebar');
        sidebar?.classList.toggle('-translate-x-full');
    });
});
</script>
{{end}}
