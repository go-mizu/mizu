{{define "app.html"}}
{{template "default.html" .}}
{{end}}

{{define "content"}}
<div class="flex flex-col h-screen bg-white">
    {{if not .Data.isLoggedIn}}
    <!-- Public navbar for non-authenticated users -->
    <nav class="sticky top-0 z-50 bg-white/80 backdrop-blur-md border-b border-gpt-border shrink-0">
        <div class="max-w-full mx-auto px-4 h-14 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <a href="/" class="flex items-center gap-2">
                    <div class="w-7 h-7 rounded-lg bg-gpt-accent flex items-center justify-center">
                        <svg class="w-4 h-4 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                        </svg>
                    </div>
                    <span class="font-semibold text-gpt-text">Mizu</span>
                </a>
                {{if .Data.currentServer}}
                <span class="text-gpt-text-muted">/</span>
                <span class="font-medium text-gpt-text">{{.Data.currentServer.Name}}</span>
                {{if .Data.currentChannel}}
                <span class="text-gpt-text-muted">/</span>
                <span class="text-gpt-text-secondary">#{{.Data.currentChannel.Name}}</span>
                {{end}}
                {{end}}
            </div>
            <div class="flex items-center gap-3">
                <a href="/login" class="px-4 py-2 text-sm font-medium text-gpt-text hover:text-gpt-text-secondary transition-colors">Log in</a>
                <a href="/register" class="px-4 py-2 rounded-full text-sm font-medium text-white bg-gpt-accent hover:opacity-90 transition-opacity">Sign up</a>
            </div>
        </div>
    </nav>
    {{end}}

    <div class="flex flex-1 min-h-0">
    {{if .Data.isLoggedIn}}
    <!-- Left Sidebar (only for logged-in users) -->
    {{template "channel_list.html" .}}
    {{end}}

    <!-- Main Content Area (Chat + Right Sidebar) -->
    <div class="flex-1 flex min-w-0">
        <!-- Chat Area -->
        <div class="flex-1 flex flex-col min-w-0">
        {{if .Data.isLoggedIn}}
        <!-- Header (logged-in users) -->
        <header class="h-14 flex items-center justify-between px-4 border-b border-gpt-border shrink-0">
            <div class="flex items-center gap-2">
                <!-- Sidebar toggle for mobile -->
                <button id="sidebar-toggle" class="p-2 -ml-2 rounded-lg hover:bg-gpt-sidebar-hover lg:hidden">
                    <svg class="w-5 h-5 text-gpt-text" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                        <line x1="9" y1="3" x2="9" y2="21"/>
                    </svg>
                </button>
                <!-- Breadcrumb Navigation: Server > Channel -->
                <nav class="flex items-center gap-1">
                    <!-- Server Dropdown -->
                    <div class="relative" id="server-dropdown-container">
                        <button id="server-dropdown-btn" class="flex items-center gap-1 px-2 py-1.5 rounded-lg hover:bg-gpt-sidebar-hover transition-colors">
                            <span class="font-semibold text-gpt-text text-sm">{{if .Data.currentServer}}{{.Data.currentServer.Name}}{{else}}Select Server{{end}}</span>
                            <svg class="w-3.5 h-3.5 text-gpt-text-secondary" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="6 9 12 15 18 9"/>
                            </svg>
                        </button>
                        <div id="server-dropdown-menu" class="absolute left-0 top-full mt-1 w-48 bg-white border border-gpt-border rounded-lg shadow-lg py-1 hidden z-50">
                            {{if .Data.servers}}
                                {{range .Data.servers}}
                                <a href="/channels/{{.ID}}/{{.DefaultChannel}}" class="flex items-center gap-2 px-3 py-2 text-sm hover:bg-gpt-sidebar-hover transition-colors {{if and $.Data.currentServer (eq .ID $.Data.currentServer.ID)}}bg-gpt-sidebar-active{{end}}">
                                    <div class="w-5 h-5 rounded flex items-center justify-center text-xs font-medium bg-gpt-sidebar-hover shrink-0">
                                        {{if .IconURL}}<img src="{{.IconURL}}" class="w-full h-full object-cover rounded">{{else}}{{slice .Name 0 1}}{{end}}
                                    </div>
                                    <span class="truncate">{{.Name}}</span>
                                </a>
                                {{end}}
                            {{else}}
                                <div class="px-3 py-2 text-sm text-gpt-text-muted">No servers</div>
                            {{end}}
                            <div class="border-t border-gpt-border mt-1 pt-1">
                                <a href="/explore" class="flex items-center gap-2 px-3 py-2 text-sm text-gpt-text-secondary hover:bg-gpt-sidebar-hover transition-colors">
                                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="10"/><polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"/>
                                    </svg>
                                    Explore servers
                                </a>
                            </div>
                        </div>
                    </div>

                    {{if .Data.currentServer}}
                    <!-- Separator -->
                    <svg class="w-4 h-4 text-gpt-text-muted" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="9 18 15 12 9 6"/>
                    </svg>

                    <!-- Channel Dropdown -->
                    <div class="relative" id="channel-dropdown-container">
                        <button id="channel-dropdown-btn" class="flex items-center gap-1 px-2 py-1.5 rounded-lg hover:bg-gpt-sidebar-hover transition-colors">
                            <span class="text-gpt-text-muted">#</span>
                            <span class="font-medium text-gpt-text text-sm">{{if .Data.currentChannel}}{{.Data.currentChannel.Name}}{{else}}Select Channel{{end}}</span>
                            <svg class="w-3.5 h-3.5 text-gpt-text-secondary" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="6 9 12 15 18 9"/>
                            </svg>
                        </button>
                        <div id="channel-dropdown-menu" class="absolute left-0 top-full mt-1 w-48 bg-white border border-gpt-border rounded-lg shadow-lg py-1 hidden z-50">
                            {{if .Data.channels}}
                                {{range .Data.channels}}
                                <a href="/channels/{{$.Data.currentServer.ID}}/{{.ID}}" class="flex items-center gap-2 px-3 py-2 text-sm hover:bg-gpt-sidebar-hover transition-colors {{if and $.Data.currentChannel (eq .ID $.Data.currentChannel.ID)}}bg-gpt-sidebar-active{{end}}">
                                    <span class="text-gpt-text-muted">#</span>
                                    <span class="truncate">{{.Name}}</span>
                                </a>
                                {{end}}
                            {{else}}
                                <div class="px-3 py-2 text-sm text-gpt-text-muted">No channels</div>
                            {{end}}
                            <div class="border-t border-gpt-border mt-1 pt-1">
                                <button onclick="openCreateChannelModal(); closeAllDropdowns();" class="flex items-center gap-2 px-3 py-2 text-sm text-gpt-text-secondary hover:bg-gpt-sidebar-hover transition-colors w-full text-left">
                                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
                                    </svg>
                                    New channel
                                </button>
                            </div>
                        </div>
                    </div>
                    {{end}}
                </nav>
            </div>
            <div class="flex items-center gap-1">
                <!-- WebSocket Status Indicator -->
                <div class="flex items-center gap-1.5 px-2" title="WebSocket Status">
                    <div id="ws-status" class="w-2 h-2 rounded-full bg-gray-400"></div>
                </div>
                {{if .Data.currentServer}}
                <!-- Members sidebar toggle -->
                <button id="users-toggle" class="p-2 rounded-lg text-gpt-text-secondary hover:bg-gpt-sidebar-hover transition-colors" title="Show members">
                    <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                    </svg>
                </button>
                {{end}}
                {{if .Data.currentChannel}}
                <button class="flex items-center gap-2 px-3 py-1.5 rounded-lg text-sm text-gpt-text-secondary hover:bg-gpt-sidebar-hover transition-colors">
                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/>
                        <polyline points="16 6 12 2 8 6"/>
                        <line x1="12" y1="2" x2="12" y2="15"/>
                    </svg>
                    Share
                </button>
                {{end}}
                <a href="/settings" class="p-2 rounded-lg text-gpt-text-secondary hover:bg-gpt-sidebar-hover transition-colors" title="Settings">
                    <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="1"/>
                        <circle cx="19" cy="12" r="1"/>
                        <circle cx="5" cy="12" r="1"/>
                    </svg>
                </a>
            </div>
        </header>
        {{else}}
        <!-- Simplified header for public viewing -->
        <header class="h-12 flex items-center justify-between px-4 border-b border-gpt-border shrink-0 bg-gpt-sidebar">
            <div class="flex items-center gap-3">
                {{if .Data.channels}}
                <div class="flex items-center gap-1 overflow-x-auto scrollbar-hide">
                    {{range .Data.channels}}
                    <a href="/channels/{{$.Data.currentServer.ID}}/{{.ID}}"
                       class="flex items-center gap-1 px-3 py-1.5 rounded-full text-sm whitespace-nowrap transition-colors {{if and $.Data.currentChannel (eq .ID $.Data.currentChannel.ID)}}bg-white text-gpt-text shadow-sm{{else}}text-gpt-text-secondary hover:bg-white/50{{end}}">
                        <span class="opacity-50">#</span>
                        <span>{{.Name}}</span>
                    </a>
                    {{end}}
                </div>
                {{end}}
            </div>
            <div class="flex items-center gap-2 text-sm text-gpt-text-muted shrink-0">
                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                    <circle cx="9" cy="7" r="4"/>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/>
                </svg>
                <span>{{.Data.currentServer.MemberCount}} members</span>
            </div>
        </header>
        {{end}}

        {{if .Data.currentChannel}}
        <!-- Messages Container -->
        <div class="flex-1 overflow-y-auto scrollbar-thin" id="messages">
            <div class="max-w-chat mx-auto px-4 py-6">
                {{if .Data.messages}}
                    {{range .Data.messages}}
                    <div class="message-wrapper mb-8 animate-fade-in group" data-message-id="{{.ID}}" data-author-id="{{if .Author}}{{.Author.ID}}{{end}}">
                        <!-- Message - unified style for all users -->
                        <div class="flex gap-4">
                            <!-- Avatar -->
                            <div class="w-7 h-7 rounded-full flex items-center justify-center text-sm font-medium shrink-0 overflow-hidden bg-black">
                                {{if .Author}}
                                    {{if .Author.AvatarURL}}
                                        <img src="{{.Author.AvatarURL}}" alt="{{.Author.DisplayName}}" class="w-full h-full object-cover">
                                    {{else}}
                                        <span class="text-white text-xs font-semibold">{{slice .Author.DisplayName 0 1}}</span>
                                    {{end}}
                                {{else}}
                                    <svg class="w-4 h-4 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M12 8V4M12 8C9.79 8 8 9.79 8 12M12 8C14.21 8 16 9.79 16 12M8 12H4M8 12C8 14.21 9.79 16 12 16M16 12H20M16 12C16 14.21 14.21 16 12 16M12 16V20"/>
                                    </svg>
                                {{end}}
                            </div>
                            <!-- Message Content -->
                            <div class="flex-1 min-w-0 pt-0">
                                <div class="flex items-baseline gap-2 mb-1.5">
                                    <span class="font-semibold text-sm text-gpt-text">{{if .Author}}{{.Author.DisplayName}}{{if and $.User (eq .Author.ID $.User.ID)}} (you){{end}}{{else}}Unknown{{end}}</span>
                                    <span class="text-xs text-gpt-text-muted" data-timestamp="{{.CreatedAt.Format "2006-01-02T15:04:05Z07:00"}}"></span>
                                </div>
                                <div class="prose-chat text-gpt-text" data-markdown="{{.Content}}"></div>
                                {{if $.Data.isLoggedIn}}
                                <!-- Message Actions (only for logged-in users) -->
                                <div class="message-actions mt-2 -ml-1.5">
                                    <button class="message-action-btn copy-message-btn" title="Copy message">
                                        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                                        </svg>
                                    </button>
                                    <button class="message-action-btn" title="Good response">
                                        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"/>
                                        </svg>
                                    </button>
                                    <button class="message-action-btn" title="Bad response">
                                        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M10 15v4a3 3 0 0 0 3 3l4-9V2H5.72a2 2 0 0 0-2 1.7l-1.38 9a2 2 0 0 0 2 2.3zm7-13h2.67A2.31 2.31 0 0 1 22 4v7a2.31 2.31 0 0 1-2.33 2H17"/>
                                        </svg>
                                    </button>
                                </div>
                                {{end}}
                            </div>
                        </div>
                    </div>
                    {{end}}
                {{else}}
                    <!-- Empty State -->
                    <div class="flex flex-col items-center justify-center py-20 text-center">
                        <div class="w-16 h-16 rounded-full flex items-center justify-center mb-6 bg-gpt-sidebar border border-gpt-border">
                            <svg class="w-8 h-8 text-gpt-text" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                            </svg>
                        </div>
                        <h3 class="text-xl font-semibold text-gpt-text mb-2">Start a conversation</h3>
                        <p class="text-gpt-text-secondary max-w-md">Send a message to begin chatting.</p>
                    </div>
                {{end}}
            </div>
        </div>

        <!-- Scroll to bottom indicator -->
        <div id="scroll-indicator" class="hidden absolute bottom-32 left-1/2 -translate-x-1/2">
            <button onclick="scrollToBottom()" class="p-2 rounded-full bg-white border border-gpt-border shadow-lg hover:bg-gpt-sidebar transition-colors">
                <svg class="w-5 h-5 text-gpt-text" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 12 15 18 9"/>
                </svg>
            </button>
        </div>

        {{if .Data.isLoggedIn}}
        <!-- Message Input (logged-in users) -->
        <div class="shrink-0 px-4 pb-4">
            <div class="max-w-chat mx-auto">
                <form id="message-form" class="relative">
                    <div class="relative flex items-end rounded-3xl bg-gpt-input-bg border border-gpt-border shadow-sm">
                        <!-- Attachment button -->
                        <button type="button" class="p-3 text-gpt-text-secondary hover:text-gpt-text transition-colors">
                            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19"/>
                                <line x1="5" y1="12" x2="19" y2="12"/>
                            </svg>
                        </button>
                        <textarea
                            id="message-input"
                            name="content"
                            placeholder="Ask anything"
                            rows="1"
                            class="flex-1 py-3 pr-3 bg-transparent text-gpt-text outline-none resize-none scrollbar-hide placeholder:text-gpt-text-muted"
                            style="max-height: 200px;"
                        ></textarea>
                        <!-- Voice button -->
                        <button type="button" class="p-3 text-gpt-text-secondary hover:text-gpt-text transition-colors">
                            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
                                <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                                <line x1="12" y1="19" x2="12" y2="23"/>
                                <line x1="8" y1="23" x2="16" y2="23"/>
                            </svg>
                        </button>
                        <!-- Send button -->
                        <button
                            type="submit"
                            id="send-btn"
                            disabled
                            class="p-2 m-1.5 rounded-full transition-all btn-transition disabled:opacity-30 bg-gpt-accent disabled:bg-gpt-text-muted"
                        >
                            <svg class="w-5 h-5 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="19" x2="12" y2="5"/>
                                <polyline points="5 12 12 5 19 12"/>
                            </svg>
                        </button>
                    </div>
                </form>
                <p class="text-xs text-center text-gpt-text-muted mt-2">Mizu Chat can make mistakes. Check important info.</p>
            </div>
        </div>
        {{else}}
        <!-- Join Banner (public viewers) -->
        <div class="shrink-0 border-t border-gpt-border bg-gradient-to-t from-gpt-sidebar to-transparent">
            <div class="max-w-chat mx-auto px-4 py-6">
                <div class="flex flex-col sm:flex-row items-center justify-between gap-4 p-4 rounded-2xl bg-white border border-gpt-border shadow-sm">
                    <div class="text-center sm:text-left">
                        <h3 class="font-semibold text-gpt-text mb-1">Join the conversation</h3>
                        <p class="text-sm text-gpt-text-secondary">Sign in to send messages and participate in this community.</p>
                    </div>
                    <div class="flex items-center gap-3 shrink-0">
                        <a href="/login" class="px-4 py-2 text-sm font-medium text-gpt-text hover:text-gpt-text-secondary transition-colors">Log in</a>
                        <a href="/register" class="px-5 py-2.5 rounded-full text-sm font-medium text-white bg-gpt-accent hover:opacity-90 transition-opacity">Sign up free</a>
                    </div>
                </div>
            </div>
        </div>
        {{end}}
        {{else}}
        <!-- No Channel Selected -->
        <div class="flex-1 flex flex-col items-center justify-center text-center p-6">
            <div class="w-20 h-20 rounded-full flex items-center justify-center mb-6 bg-gpt-sidebar border border-gpt-border">
                <span class="text-4xl font-medium text-gpt-text opacity-40">#</span>
            </div>
            {{if .Data.isLoggedIn}}
            <h2 class="text-2xl font-semibold text-gpt-text mb-3">Welcome!</h2>
            <p class="text-gpt-text-secondary max-w-md mb-6">Select a channel from the sidebar or create a new one to start chatting.</p>
            <button onclick="document.getElementById('new-chat-btn')?.click()" class="px-4 py-2.5 rounded-full text-sm font-medium text-white bg-gpt-accent hover:opacity-90 transition-opacity btn-transition">
                Create Channel
            </button>
            {{else}}
            <h2 class="text-2xl font-semibold text-gpt-text mb-3">Welcome to {{if .Data.currentServer}}{{.Data.currentServer.Name}}{{else}}this community{{end}}</h2>
            <p class="text-gpt-text-secondary max-w-md mb-6">Select a channel above to browse the conversation, or sign in to participate.</p>
            <div class="flex items-center gap-3">
                <a href="/login" class="px-4 py-2 text-sm font-medium text-gpt-text hover:text-gpt-text-secondary transition-colors">Log in</a>
                <a href="/register" class="px-5 py-2.5 rounded-full text-sm font-medium text-white bg-gpt-accent hover:opacity-90 transition-opacity">Sign up free</a>
            </div>
            {{end}}
        </div>
        {{end}}
        </div>

        <!-- Right Sidebar - Members (collapsed by default, only for logged-in users) -->
        {{if and .Data.currentServer .Data.isLoggedIn}}
        <div id="right-sidebar" class="w-60 border-l border-gpt-border bg-gpt-sidebar flex-col hidden" data-expanded="false">
            <div class="h-14 flex items-center justify-between px-4 border-b border-gpt-border">
                <h3 class="font-semibold text-sm text-gpt-text">Members</h3>
                <button id="close-right-sidebar" class="p-1 rounded hover:bg-gpt-sidebar-hover transition-colors">
                    <svg class="w-4 h-4 text-gpt-text-secondary" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto scrollbar-thin p-3">
                <!-- Online Users Section -->
                <div class="mb-4">
                    <h4 class="text-xs font-semibold text-gpt-text-muted uppercase tracking-wider mb-2 flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-green-500"></span>
                        Online — <span id="online-count">0</span>
                    </h4>
                    <div id="online-users-list" class="space-y-1">
                        <!-- Online users will be inserted here -->
                    </div>
                </div>
                <!-- Offline Users Section -->
                <div>
                    <h4 class="text-xs font-semibold text-gpt-text-muted uppercase tracking-wider mb-2 flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-gray-400"></span>
                        Offline — <span id="offline-count">0</span>
                    </h4>
                    <div id="offline-users-list" class="space-y-1">
                        <!-- Offline users will be inserted here -->
                    </div>
                </div>
            </div>
        </div>
        {{end}}
    </div>
</div>

<script>
const CONFIG = {
    userId: {{if .User}}'{{.User.ID}}'{{else}}null{{end}},
    serverId: {{if .Data.currentServer}}'{{.Data.currentServer.ID}}'{{else}}null{{end}},
    channelId: {{if .Data.currentChannel}}'{{.Data.currentChannel.ID}}'{{else}}null{{end}},
    channelName: {{if .Data.currentChannel}}'{{.Data.currentChannel.Name}}'{{else}}''{{end}},
    isLoggedIn: {{if .Data.isLoggedIn}}true{{else}}false{{end}}
};

let ws = null;
let reconnectTimeout = null;
let wsConnected = false;
let pendingMessages = new Map(); // For optimistic updates

// Configure marked.js
marked.setOptions({
    gfm: true,
    breaks: true,
    highlight: function(code, lang) {
        if (lang && hljs.getLanguage(lang)) {
            try {
                return hljs.highlight(code, { language: lang }).value;
            } catch (e) {}
        }
        return hljs.highlightAuto(code).value;
    }
});

// Custom renderer for code blocks with ChatGPT-style wrapper
const renderer = {
    code(token) {
        // marked v5+ passes an object with text and lang properties
        const code = typeof token === 'string' ? token : (token.text || '');
        const lang = (typeof token === 'object' ? token.lang : null) || 'plaintext';
        let highlighted = '';

        try {
            if (typeof hljs !== 'undefined') {
                if (lang && lang !== 'plaintext' && hljs.getLanguage(lang)) {
                    highlighted = hljs.highlight(code, { language: lang }).value;
                } else {
                    highlighted = hljs.highlightAuto(code).value;
                }
            } else {
                highlighted = code.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            }
        } catch (e) {
            console.error('Highlight error:', e);
            highlighted = code.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }

        const safeLang = lang.replace(/[<>"'&]/g, '');
        return `<div class="code-block-wrapper">
            <div class="code-block-header">
                <span class="code-block-lang">${safeLang}</span>
                <button class="code-block-copy" onclick="copyCode(this)">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                    </svg>
                    <span>Copy code</span>
                </button>
            </div>
            <pre><code class="hljs language-${safeLang}">${highlighted}</code></pre>
        </div>`;
    }
};
marked.use({ renderer });

// Render markdown content
function renderMarkdown(content) {
    if (!content) return '';
    return marked.parse(content);
}

// Render all messages with markdown
function renderAllMessages() {
    document.querySelectorAll('[data-markdown]').forEach(el => {
        const content = el.getAttribute('data-markdown');
        if (content) {
            el.innerHTML = renderMarkdown(content);
            el.removeAttribute('data-markdown');
        }
    });
}

// Format all timestamps
function formatAllTimestamps() {
    document.querySelectorAll('[data-timestamp]').forEach(el => {
        const iso = el.getAttribute('data-timestamp');
        if (iso) {
            el.textContent = formatTimestamp(iso);
            el.removeAttribute('data-timestamp');
        }
    });
}

// Copy code to clipboard
function copyCode(btn) {
    const wrapper = btn.closest('.code-block-wrapper');
    const code = wrapper.querySelector('code').textContent;
    navigator.clipboard.writeText(code).then(() => {
        btn.classList.add('copied');
        btn.querySelector('span').textContent = 'Copied!';
        setTimeout(() => {
            btn.classList.remove('copied');
            btn.querySelector('span').textContent = 'Copy code';
        }, 2000);
    });
}

// Copy entire message
function copyMessage(btn) {
    const wrapper = btn.closest('.message-wrapper');
    const proseEl = wrapper.querySelector('.prose-chat');
    const text = proseEl.innerText;
    navigator.clipboard.writeText(text).then(() => {
        const svg = btn.querySelector('svg');
        const originalPath = svg.innerHTML;
        svg.innerHTML = '<path d="M20 6L9 17l-5-5" stroke="currentColor" stroke-width="2" fill="none"/>';
        setTimeout(() => {
            svg.innerHTML = originalPath;
        }, 2000);
    });
}

// Get cookie value by name (handles values containing '=')
function getCookie(name) {
    const cookies = document.cookie.split('; ');
    for (const cookie of cookies) {
        const idx = cookie.indexOf('=');
        if (idx > 0 && cookie.substring(0, idx) === name) {
            return cookie.substring(idx + 1);
        }
    }
    return null;
}

// Initialize WebSocket (only for logged-in users)
function initWebSocket() {
    if (!CONFIG.isLoggedIn) {
        console.log('[WS] Skipping WebSocket for public viewer');
        return;
    }

    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const token = getCookie('session');
    console.log('[WS] Session token found:', !!token, token ? token.substring(0, 10) + '...' : 'none');
    if (!token) {
        console.warn('[WS] No session token found, skipping WebSocket connection');
        updateWSStatus(false);
        return;
    }

    const wsUrl = `${protocol}//${window.location.host}/ws?token=${encodeURIComponent(token)}`;
    console.log('[WS] Connecting to:', wsUrl.substring(0, 50) + '...');
    ws = new WebSocket(wsUrl);

    ws.onopen = () => {
        console.log('[WS] Connected');
        wsConnected = true;
        updateWSStatus(true);
        if (reconnectTimeout) {
            clearTimeout(reconnectTimeout);
            reconnectTimeout = null;
        }
    };

    ws.onclose = (event) => {
        console.log('[WS] Disconnected, code:', event.code);
        wsConnected = false;
        updateWSStatus(false);
        reconnectTimeout = setTimeout(initWebSocket, 3000);
    };

    ws.onerror = (err) => {
        console.error('[WS] Error:', err);
        wsConnected = false;
        updateWSStatus(false);
    };

    ws.onmessage = (event) => {
        try {
            // Handle multiple messages in one frame (newline separated)
            const messages = event.data.split('\n').filter(Boolean);
            for (const msg of messages) {
                handleWSMessage(JSON.parse(msg));
            }
        } catch (err) {
            console.error('[WS] Parse error:', err);
        }
    };
}

// Update WebSocket connection status indicator
function updateWSStatus(connected) {
    const indicator = document.getElementById('ws-status');
    if (indicator) {
        indicator.className = connected
            ? 'w-2 h-2 rounded-full bg-green-500'
            : 'w-2 h-2 rounded-full bg-red-500 animate-pulse';
        indicator.title = connected ? 'Connected' : 'Disconnected';
    }
}

function handleWSMessage(msg) {
    console.log('[WS] Received:', msg.t, msg.d?.id || '');

    // Handle non-dispatch messages
    if (msg.op === 10) { // HELLO
        console.log('[WS] Hello received, heartbeat interval:', msg.d?.heartbeat_interval);
        return;
    }
    if (msg.op === 11) { // HEARTBEAT_ACK
        return;
    }
    if (msg.op !== 0) return; // Only handle dispatches

    const data = msg.d;

    switch (msg.t) {
        case 'READY':
            console.log('[WS] Ready event received');
            break;
        case 'MESSAGE_CREATE':
            if (data.channel_id === CONFIG.channelId) {
                // Check if this is a message we sent optimistically
                const tempId = pendingMessages.get(data.content);
                if (tempId) {
                    // Replace optimistic message with real one
                    console.log('[WS] Replacing optimistic message:', tempId, '->', data.id);
                    const tempEl = document.querySelector(`[data-message-id="${tempId}"]`);
                    if (tempEl) {
                        tempEl.dataset.messageId = data.id;
                        tempEl.classList.remove('opacity-70');
                    }
                    pendingMessages.delete(data.content);
                } else {
                    // New message from another user
                    console.log('[WS] New message from:', data.author?.display_name || data.author_id);
                    appendMessage(data);
                }
            }
            break;
        case 'MESSAGE_UPDATE':
            updateMessage(data);
            break;
        case 'MESSAGE_DELETE':
            removeMessage(data.id);
            break;
        case 'TYPING_START':
            console.log('[WS] Typing:', data.user_id);
            break;
        case 'PRESENCE_UPDATE':
            console.log('[WS] Presence update:', data.user_id, data.status);
            handlePresenceUpdate(data);
            break;
    }
}

function appendMessage(msg, isOptimistic = false) {
    const container = document.getElementById('messages');
    if (!container) return;

    const wrapper = container.querySelector('.max-w-chat');
    if (!wrapper) return;

    const wasAtBottom = container.scrollHeight - container.scrollTop <= container.clientHeight + 100;

    // Remove empty state if present
    const emptyState = wrapper.querySelector('.py-20');
    if (emptyState) emptyState.remove();

    const isCurrentUser = msg.author?.id === CONFIG.userId;
    const div = document.createElement('div');
    div.className = 'message-wrapper mb-8 animate-slide-up group' + (isOptimistic ? ' opacity-70' : '');
    div.dataset.messageId = msg.id;
    div.dataset.authorId = msg.author?.id || '';

    // Render markdown content
    const renderedContent = renderMarkdown(msg.content);

    const timestamp = formatTimestamp(msg.created_at || new Date().toISOString());

    // Unified message style for all users
    const avatarBg = 'bg-black';
    const displayName = msg.author?.display_name || 'Unknown';
    const initial = displayName.charAt(0).toUpperCase();
    const youLabel = isCurrentUser ? ' (you)' : '';

    div.innerHTML = `
        <div class="flex gap-4">
            <div class="w-7 h-7 rounded-full flex items-center justify-center text-sm font-medium shrink-0 overflow-hidden ${avatarBg}">
                ${msg.author?.avatar_url
                    ? `<img src="${escapeHtml(msg.author.avatar_url)}" alt="" class="w-full h-full object-cover">`
                    : `<span class="text-white text-xs font-semibold">${escapeHtml(initial)}</span>`
                }
            </div>
            <div class="flex-1 min-w-0 pt-0">
                <div class="flex items-baseline gap-2 mb-1.5">
                    <span class="font-semibold text-sm text-gpt-text">${escapeHtml(displayName)}${youLabel}</span>
                    <span class="text-xs text-gpt-text-muted">${escapeHtml(timestamp)}</span>
                </div>
                <div class="prose-chat text-gpt-text">${renderedContent}</div>
                <div class="message-actions mt-2 -ml-1.5">
                    <button class="message-action-btn copy-message-btn" onclick="copyMessage(this)" title="Copy message">
                        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                        </svg>
                    </button>
                    <button class="message-action-btn" title="Good response">
                        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"/>
                        </svg>
                    </button>
                    <button class="message-action-btn" title="Bad response">
                        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M10 15v4a3 3 0 0 0 3 3l4-9V2H5.72a2 2 0 0 0-2 1.7l-1.38 9a2 2 0 0 0 2 2.3zm7-13h2.67A2.31 2.31 0 0 1 22 4v7a2.31 2.31 0 0 1-2.33 2H17"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    `;

    wrapper.appendChild(div);
    if (wasAtBottom) container.scrollTop = container.scrollHeight;
}

function updateMessage(msg) {
    const el = document.querySelector(`[data-message-id="${msg.id}"]`);
    if (!el) return;
    const body = el.querySelector('.prose-chat');
    if (body) body.innerHTML = renderMarkdown(msg.content);
}

function removeMessage(id) {
    const el = document.querySelector(`[data-message-id="${id}"]`);
    if (el) {
        el.style.opacity = '0';
        el.style.transform = 'translateY(-8px)';
        el.style.transition = 'opacity 0.2s ease, transform 0.2s ease';
        setTimeout(() => el.remove(), 200);
    }
}

async function sendMessage(content) {
    if (!content || !CONFIG.channelId) return false;

    // Optimistic update: show message immediately
    const tempId = 'temp-' + Date.now();
    const optimisticMsg = {
        id: tempId,
        content: content,
        author: {
            id: CONFIG.userId,
            display_name: 'You'
        },
        created_at: new Date().toISOString()
    };

    // Store pending message to reconcile with server response
    pendingMessages.set(content, tempId);

    // Add message optimistically with slight opacity
    appendMessage(optimisticMsg, true);
    console.log('[MSG] Added optimistic message:', tempId);

    try {
        const res = await fetch(`/api/v1/channels/${CONFIG.channelId}/messages`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content })
        });

        if (!res.ok) {
            // Remove optimistic message on failure
            console.error('[MSG] Send failed, removing optimistic message');
            removeMessage(tempId);
            pendingMessages.delete(content);
            return false;
        }

        console.log('[MSG] Send successful, waiting for WebSocket confirmation');
        return true;
    } catch (err) {
        console.error('[MSG] Send error:', err);
        removeMessage(tempId);
        pendingMessages.delete(content);
        return false;
    }
}

function formatTimestamp(iso) {
    const date = new Date(iso);
    const now = new Date();
    const isToday = date.toDateString() === now.toDateString();
    const isYesterday = new Date(now - 86400000).toDateString() === date.toDateString();
    const time = date.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });

    if (isToday) return `Today at ${time}`;
    if (isYesterday) return `Yesterday at ${time}`;
    return date.toLocaleDateString([], { month: 'short', day: 'numeric' }) + ' at ' + time;
}

function escapeHtml(str) {
    if (!str) return '';
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

function scrollToBottom() {
    const messages = document.getElementById('messages');
    if (messages) {
        messages.scrollTo({ top: messages.scrollHeight, behavior: 'smooth' });
    }
}

// Auto-resize textarea
function autoResize(textarea) {
    textarea.style.height = 'auto';
    textarea.style.height = Math.min(textarea.scrollHeight, 200) + 'px';
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    // Render all markdown messages on page load
    renderAllMessages();
    // Format all timestamps
    formatAllTimestamps();

    initWebSocket();

    const form = document.getElementById('message-form');
    const input = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');

    // Attach copy handlers to message copy buttons
    document.querySelectorAll('.copy-message-btn').forEach(btn => {
        btn.addEventListener('click', () => copyMessage(btn));
    });

    if (input) {
        // Auto-resize on input
        input.addEventListener('input', () => {
            autoResize(input);
            // Enable/disable send button
            const hasContent = input.value.trim().length > 0;
            sendBtn.disabled = !hasContent;
        });

        // Submit on Enter (without Shift)
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                form.dispatchEvent(new Event('submit'));
            }
        });
    }

    if (form) {
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const content = input.value.trim();
            if (content) {
                input.value = '';
                autoResize(input);
                sendBtn.disabled = true;
                await sendMessage(content);
            }
        });
    }

    // Scroll to bottom
    const messages = document.getElementById('messages');
    if (messages) {
        messages.scrollTop = messages.scrollHeight;

        // Show/hide scroll indicator
        messages.addEventListener('scroll', () => {
            const indicator = document.getElementById('scroll-indicator');
            if (indicator) {
                const isNearBottom = messages.scrollHeight - messages.scrollTop <= messages.clientHeight + 200;
                indicator.classList.toggle('hidden', isNearBottom);
            }
        });
    }

    // Focus input
    input?.focus();

    // Left sidebar toggle (mobile)
    document.getElementById('sidebar-toggle')?.addEventListener('click', () => {
        const sidebar = document.getElementById('sidebar');
        sidebar?.classList.toggle('-translate-x-full');
    });

    // Sidebar collapse button (desktop)
    document.getElementById('sidebar-collapse')?.addEventListener('click', () => {
        const sidebar = document.getElementById('sidebar');
        if (sidebar) {
            sidebar.classList.toggle('lg:w-0');
            sidebar.classList.toggle('lg:overflow-hidden');
            sidebar.classList.toggle('lg:border-0');
        }
    });

    // Breadcrumb dropdown handlers
    function closeAllDropdowns() {
        document.getElementById('server-dropdown-menu')?.classList.add('hidden');
        document.getElementById('channel-dropdown-menu')?.classList.add('hidden');
    }

    document.getElementById('server-dropdown-btn')?.addEventListener('click', (e) => {
        e.stopPropagation();
        const menu = document.getElementById('server-dropdown-menu');
        const channelMenu = document.getElementById('channel-dropdown-menu');
        channelMenu?.classList.add('hidden');
        menu?.classList.toggle('hidden');
    });

    document.getElementById('channel-dropdown-btn')?.addEventListener('click', (e) => {
        e.stopPropagation();
        const menu = document.getElementById('channel-dropdown-menu');
        const serverMenu = document.getElementById('server-dropdown-menu');
        serverMenu?.classList.add('hidden');
        menu?.classList.toggle('hidden');
    });

    // Close dropdowns when clicking outside
    document.addEventListener('click', (e) => {
        if (!e.target.closest('#server-dropdown-container') && !e.target.closest('#channel-dropdown-container')) {
            closeAllDropdowns();
        }
    });

    // Close dropdowns on Escape
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            closeAllDropdowns();
        }
    });

    // Expose closeAllDropdowns globally for inline handlers
    window.closeAllDropdowns = closeAllDropdowns;

    // Right sidebar (online users) toggle
    const usersToggle = document.getElementById('users-toggle');
    const rightSidebar = document.getElementById('right-sidebar');
    const closeRightSidebar = document.getElementById('close-right-sidebar');

    console.log('[Sidebar] usersToggle:', !!usersToggle, 'rightSidebar:', !!rightSidebar);

    if (usersToggle && rightSidebar) {
        console.log('[Sidebar] Adding click listener to users toggle');
        usersToggle.addEventListener('click', () => {
            console.log('[Sidebar] Toggle clicked');
            const isExpanded = rightSidebar.dataset.expanded === 'true';
            if (isExpanded) {
                rightSidebar.classList.add('hidden');
                rightSidebar.classList.remove('flex');
                rightSidebar.dataset.expanded = 'false';
            } else {
                rightSidebar.classList.remove('hidden');
                rightSidebar.classList.add('flex');
                rightSidebar.dataset.expanded = 'true';
                fetchOnlineUsers();
            }
        });

        closeRightSidebar?.addEventListener('click', () => {
            rightSidebar.classList.add('hidden');
            rightSidebar.classList.remove('flex');
            rightSidebar.dataset.expanded = 'false';
        });
    }

    // Fetch online users periodically if sidebar is open
    if (CONFIG.serverId) {
        setInterval(() => {
            if (rightSidebar?.dataset.expanded === 'true') {
                fetchOnlineUsers();
            }
        }, 30000); // Refresh every 30 seconds
    }
});

// Online users state
let onlineUsersCache = new Map();

// Fetch online users from API
async function fetchOnlineUsers() {
    console.log('[Users] Fetching online users for server:', CONFIG.serverId);
    if (!CONFIG.serverId) {
        console.log('[Users] No server ID, skipping fetch');
        return;
    }

    try {
        const res = await fetch(`/api/v1/servers/${CONFIG.serverId}/online`);
        console.log('[Users] Fetch response:', res.status);
        if (!res.ok) {
            console.error('[Users] Fetch failed:', res.status, res.statusText);
            return;
        }

        const data = await res.json();
        console.log('[Users] Data:', data);
        updateOnlineUsersList(data.data?.online || [], data.data?.offline || []);
    } catch (err) {
        console.error('[Users] Fetch error:', err);
    }
}

// Update the online users list in the sidebar
function updateOnlineUsersList(onlineUsers, offlineUsers) {
    const onlineList = document.getElementById('online-users-list');
    const offlineList = document.getElementById('offline-users-list');
    const onlineCount = document.getElementById('online-count');
    const offlineCount = document.getElementById('offline-count');

    if (!onlineList || !offlineList) return;

    // Update counts
    if (onlineCount) onlineCount.textContent = onlineUsers.length;
    if (offlineCount) offlineCount.textContent = offlineUsers.length;

    // Update cache
    onlineUsersCache.clear();
    onlineUsers.forEach(u => onlineUsersCache.set(u.id, true));

    // Render online users
    onlineList.innerHTML = onlineUsers.map(user => renderUserItem(user, true)).join('');

    // Render offline users
    offlineList.innerHTML = offlineUsers.map(user => renderUserItem(user, false)).join('');
}

// Render a single user item
function renderUserItem(user, isOnline) {
    const initial = (user.display_name || user.username || 'U').charAt(0).toUpperCase();
    const statusColor = isOnline ? 'bg-green-500' : 'bg-gray-400';
    const isCurrentUser = user.id === CONFIG.userId;

    return `
        <div class="flex items-center gap-2 p-2 rounded-lg hover:bg-gpt-sidebar-hover transition-colors cursor-pointer">
            <div class="relative">
                <div class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium overflow-hidden bg-black">
                    ${user.avatar_url
                        ? `<img src="${escapeHtml(user.avatar_url)}" alt="" class="w-full h-full object-cover">`
                        : `<span class="text-white text-xs font-semibold">${escapeHtml(initial)}</span>`
                    }
                </div>
                <div class="absolute -bottom-0.5 -right-0.5 w-3 h-3 rounded-full border-2 border-gpt-sidebar ${statusColor}"></div>
            </div>
            <div class="flex-1 min-w-0">
                <div class="text-sm font-medium text-gpt-text truncate">
                    ${escapeHtml(user.display_name || user.username)}${isCurrentUser ? ' (you)' : ''}
                </div>
            </div>
        </div>
    `;
}

// Handle presence updates from WebSocket
function handlePresenceUpdate(data) {
    const { user_id, status } = data;
    const isOnline = status === 'online';
    onlineUsersCache.set(user_id, isOnline);

    // Refresh the list if sidebar is open
    if (document.getElementById('right-sidebar')?.dataset.expanded === 'true') {
        fetchOnlineUsers();
    }
}
</script>
{{end}}
