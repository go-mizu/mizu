{{define "channel_list.html"}}
<aside id="sidebar" class="w-64 flex flex-col shrink-0 h-full bg-gpt-sidebar border-r border-gpt-border lg:relative fixed inset-y-0 left-0 z-40 transition-transform lg:translate-x-0">
    <!-- Header with sidebar toggle -->
    <div class="h-14 flex items-center justify-between px-3 shrink-0">
        <button id="sidebar-collapse" class="p-2 rounded-lg hover:bg-gpt-sidebar-hover transition-colors">
            <svg class="w-5 h-5 text-gpt-text" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                <line x1="9" y1="3" x2="9" y2="21"/>
            </svg>
        </button>
        <button id="new-chat-btn" class="p-2 rounded-lg hover:bg-gpt-sidebar-hover transition-colors" title="New chat">
            <svg class="w-5 h-5 text-gpt-text" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 20h9"/>
                <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/>
            </svg>
        </button>
    </div>

    <!-- Navigation -->
    <div class="px-2 mb-2">
        <a href="/" class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm text-gpt-text">
            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"/>
                <path d="m21 21-4.35-4.35"/>
            </svg>
            Search chats
        </a>
    </div>

    <!-- Scrollable content -->
    <div class="flex-1 overflow-y-auto scrollbar-thin px-2">
        {{if .Data.servers}}
        <!-- Projects Section -->
        <div class="mb-4">
            <button class="flex items-center justify-between w-full px-3 py-2 text-sm text-gpt-text-secondary hover:text-gpt-text transition-colors" onclick="toggleSection('projects')">
                <span class="font-medium">Projects</span>
                <svg id="projects-chevron" class="w-4 h-4 transition-transform" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="9 18 15 12 9 6"/>
                </svg>
            </button>
            <div id="projects-content" class="hidden">
                {{range .Data.servers}}
                <a
                    href="/channels/{{.ID}}/{{.DefaultChannel}}"
                    class="sidebar-item flex items-center gap-3 px-3 py-2 rounded-lg text-sm {{if and $.Data.currentServer (eq .ID $.Data.currentServer.ID)}}bg-gpt-sidebar-active text-gpt-text{{else}}text-gpt-text-secondary{{end}}"
                >
                    <div class="w-5 h-5 rounded flex items-center justify-center text-xs font-medium bg-gpt-sidebar-hover">
                        {{if .IconURL}}
                            <img src="{{.IconURL}}" alt="{{.Name}}" class="w-full h-full object-cover rounded">
                        {{else}}
                            {{slice .Name 0 1}}
                        {{end}}
                    </div>
                    <span class="truncate">{{.Name}}</span>
                </a>
                {{end}}
                <button
                    onclick="openCreateServerModal()"
                    class="sidebar-item flex items-center gap-3 px-3 py-2 rounded-lg text-sm text-gpt-text-secondary w-full text-left"
                >
                    <div class="w-5 h-5 rounded flex items-center justify-center bg-gpt-sidebar-hover">
                        <svg class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"/>
                            <line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                    </div>
                    <span>New project</span>
                </button>
            </div>
        </div>
        {{end}}

        <!-- Your chats Section -->
        <div class="mb-4">
            <div class="px-3 py-2 text-xs font-medium text-gpt-text-muted uppercase tracking-wider">Your chats</div>
            {{if .Data.channels}}
                {{range .Data.channels}}
                <a
                    href="/channels/{{if $.Data.currentServer}}{{$.Data.currentServer.ID}}{{else}}@me{{end}}/{{.ID}}"
                    class="sidebar-item group flex items-center gap-3 px-3 py-2 rounded-lg text-sm {{if eq .ID $.Data.channelID}}bg-gpt-sidebar-active text-gpt-text{{else}}text-gpt-text-secondary{{end}}"
                >
                    <svg class="w-5 h-5 shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                    </svg>
                    <span class="truncate flex-1">{{.Name}}</span>
                    <button class="opacity-0 group-hover:opacity-100 p-1 rounded hover:bg-gpt-sidebar-hover transition-all" title="More options">
                        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="1"/>
                            <circle cx="12" cy="5" r="1"/>
                            <circle cx="12" cy="19" r="1"/>
                        </svg>
                    </button>
                </a>
                {{end}}
            {{else}}
                <div class="px-3 py-4 text-sm text-gpt-text-muted text-center">
                    No chats yet
                </div>
            {{end}}
        </div>
    </div>

    <!-- User Panel -->
    {{template "user_panel.html" .}}
</aside>

<!-- Create Server/Project Modal -->
<div id="create-server-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop bg-black/50">
    <div class="w-full max-w-md mx-4 rounded-2xl p-6 animate-slide-up bg-white border border-gpt-border shadow-xl">
        <h2 class="text-xl font-semibold text-gpt-text mb-1">Create a Project</h2>
        <p class="text-sm text-gpt-text-secondary mb-6">Give your project a name to get started.</p>

        <form id="create-server-form" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gpt-text mb-2">Project Name</label>
                <input
                    type="text"
                    id="server-name"
                    name="name"
                    required
                    maxlength="100"
                    placeholder="My Project"
                    class="w-full px-4 py-3 rounded-xl text-sm outline-none transition-all bg-gpt-input-bg border border-gpt-border text-gpt-text focus:ring-2 focus:ring-gpt-accent"
                >
            </div>

            <div class="flex gap-3 justify-end pt-2">
                <button
                    type="button"
                    onclick="closeCreateServerModal()"
                    class="px-4 py-2.5 rounded-lg text-sm font-medium text-gpt-text hover:bg-gpt-sidebar-hover transition-colors btn-transition"
                >
                    Cancel
                </button>
                <button
                    type="submit"
                    class="px-4 py-2.5 rounded-lg text-sm font-medium text-white bg-gpt-accent hover:opacity-90 transition-opacity btn-transition"
                >
                    Create Project
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Create Channel Modal -->
<div id="create-channel-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop bg-black/50">
    <div class="w-full max-w-md mx-4 rounded-2xl p-6 animate-slide-up bg-white border border-gpt-border shadow-xl">
        <h2 class="text-xl font-semibold text-gpt-text mb-1">New Chat</h2>
        <p class="text-sm text-gpt-text-secondary mb-6">Create a new conversation.</p>

        <form id="create-channel-form" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gpt-text mb-2">Chat Name</label>
                <input
                    type="text"
                    id="channel-name"
                    name="name"
                    required
                    maxlength="100"
                    placeholder="general"
                    class="w-full px-4 py-3 rounded-xl text-sm outline-none transition-all bg-gpt-input-bg border border-gpt-border text-gpt-text focus:ring-2 focus:ring-gpt-accent"
                >
            </div>

            <div class="flex gap-3 justify-end pt-2">
                <button
                    type="button"
                    onclick="closeCreateChannelModal()"
                    class="px-4 py-2.5 rounded-lg text-sm font-medium text-gpt-text hover:bg-gpt-sidebar-hover transition-colors btn-transition"
                >
                    Cancel
                </button>
                <button
                    type="submit"
                    class="px-4 py-2.5 rounded-lg text-sm font-medium text-white bg-gpt-accent hover:opacity-90 transition-opacity btn-transition"
                >
                    Create Chat
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// Toggle section visibility
function toggleSection(section) {
    const content = document.getElementById(`${section}-content`);
    const chevron = document.getElementById(`${section}-chevron`);
    if (content && chevron) {
        content.classList.toggle('hidden');
        chevron.classList.toggle('rotate-90');
    }
}

// Server modal
function openCreateServerModal() {
    document.getElementById('create-server-modal')?.classList.remove('hidden');
    document.getElementById('create-server-modal')?.classList.add('flex');
    document.getElementById('server-name')?.focus();
}

function closeCreateServerModal() {
    const modal = document.getElementById('create-server-modal');
    modal?.classList.add('hidden');
    modal?.classList.remove('flex');
    document.getElementById('create-server-form')?.reset();
}

document.getElementById('create-server-modal')?.addEventListener('click', (e) => {
    if (e.target.id === 'create-server-modal') closeCreateServerModal();
});

document.getElementById('create-server-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const name = document.getElementById('server-name')?.value.trim();
    if (!name) return;

    const btn = e.target.querySelector('[type="submit"]');
    btn.disabled = true;
    btn.textContent = 'Creating...';

    try {
        const res = await fetch('/api/v1/servers', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name })
        });

        if (res.ok) {
            const data = await res.json();
            window.location.href = `/channels/${data.data.id}/${data.data.default_channel}`;
        } else {
            btn.disabled = false;
            btn.textContent = 'Create Project';
        }
    } catch (err) {
        console.error('Failed to create project');
        btn.disabled = false;
        btn.textContent = 'Create Project';
    }
});

// Channel modal
function openCreateChannelModal() {
    document.getElementById('create-channel-modal')?.classList.remove('hidden');
    document.getElementById('create-channel-modal')?.classList.add('flex');
    document.getElementById('channel-name')?.focus();
}

function closeCreateChannelModal() {
    const modal = document.getElementById('create-channel-modal');
    modal?.classList.add('hidden');
    modal?.classList.remove('flex');
    document.getElementById('create-channel-form')?.reset();
}

document.getElementById('create-channel-modal')?.addEventListener('click', (e) => {
    if (e.target.id === 'create-channel-modal') closeCreateChannelModal();
});

document.getElementById('create-channel-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const name = document.getElementById('channel-name')?.value.trim().toLowerCase().replace(/\s+/g, '-');
    if (!name) return;

    const serverId = '{{if .Data.currentServer}}{{.Data.currentServer.ID}}{{end}}';
    if (!serverId) return;

    const btn = e.target.querySelector('[type="submit"]');
    btn.disabled = true;
    btn.textContent = 'Creating...';

    try {
        const res = await fetch(`/api/v1/servers/${serverId}/channels`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, type: 'text' })
        });

        if (res.ok) {
            const data = await res.json();
            window.location.href = `/channels/${serverId}/${data.data.id}`;
        } else {
            btn.disabled = false;
            btn.textContent = 'Create Chat';
        }
    } catch (err) {
        console.error('Failed to create chat');
        btn.disabled = false;
        btn.textContent = 'Create Chat';
    }
});

// New chat button
document.getElementById('new-chat-btn')?.addEventListener('click', () => {
    {{if .Data.currentServer}}
    openCreateChannelModal();
    {{else}}
    openCreateServerModal();
    {{end}}
});

// Keyboard shortcuts
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        closeCreateServerModal();
        closeCreateChannelModal();
    }
});
</script>
{{end}}
