{{define "channel_list.html"}}
<!-- ChatGPT-style sidebar -->
<aside id="sidebar" class="w-64 flex flex-col shrink-0 h-full bg-gpt-sidebar border-r border-gpt-border lg:relative fixed inset-y-0 left-0 z-40 transition-transform lg:translate-x-0">
    <!-- Header -->
    <div class="h-14 flex items-center justify-between px-3 border-b border-gpt-border shrink-0">
        <button id="sidebar-collapse" class="p-2 rounded-lg hover:bg-gpt-sidebar-hover transition-colors">
            <svg class="w-5 h-5 text-gpt-text" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                <line x1="9" y1="3" x2="9" y2="21"/>
            </svg>
        </button>
        <button onclick="openCreateChannelModal()" class="p-2 rounded-lg hover:bg-gpt-sidebar-hover transition-colors" title="New channel">
            <svg class="w-5 h-5 text-gpt-text" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 20h9"/>
                <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/>
            </svg>
        </button>
    </div>

    <!-- Scrollable content -->
    <div class="flex-1 overflow-y-auto scrollbar-thin">
        <!-- Servers Section -->
        {{if .Data.servers}}
        <div class="p-2">
            <button onclick="toggleSection('servers')" class="flex items-center justify-between w-full px-2 py-1.5 text-xs font-medium text-gpt-text-muted uppercase tracking-wider hover:text-gpt-text transition-colors rounded">
                <span>Servers</span>
                <svg id="servers-chevron" class="w-3.5 h-3.5 transition-transform rotate-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 12 15 18 9"/>
                </svg>
            </button>
            <div id="servers-content" class="mt-1 space-y-0.5">
                {{range .Data.servers}}
                <a
                    href="/channels/{{.ID}}/{{.DefaultChannel}}"
                    class="sidebar-item group flex items-center gap-3 px-2 py-2 rounded-lg text-sm transition-colors {{if and $.Data.currentServer (eq .ID $.Data.currentServer.ID)}}bg-gpt-sidebar-active text-gpt-text{{else}}text-gpt-text-secondary hover:bg-gpt-sidebar-hover hover:text-gpt-text{{end}}"
                >
                    <div class="w-6 h-6 rounded-md flex items-center justify-center text-xs font-medium bg-gpt-sidebar-hover shrink-0 overflow-hidden">
                        {{if .IconURL}}
                            <img src="{{.IconURL}}" alt="" class="w-full h-full object-cover">
                        {{else}}
                            <span class="text-gpt-text-secondary">{{slice .Name 0 1}}</span>
                        {{end}}
                    </div>
                    <span class="truncate flex-1">{{.Name}}</span>
                </a>
                {{end}}
            </div>
        </div>
        {{end}}

        <!-- Channels Section (when server selected) -->
        {{if .Data.currentServer}}
        <div class="p-2 border-t border-gpt-border">
            <div class="flex items-center justify-between px-2 py-1.5">
                <span class="text-xs font-medium text-gpt-text-muted uppercase tracking-wider">Channels</span>
                <button onclick="openCreateChannelModal()" class="p-1 rounded hover:bg-gpt-sidebar-hover transition-colors" title="Create channel">
                    <svg class="w-3.5 h-3.5 text-gpt-text-muted hover:text-gpt-text" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"/>
                        <line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                </button>
            </div>
            <div class="mt-1 space-y-0.5">
                {{if .Data.channels}}
                    {{range .Data.channels}}
                    <a
                        href="/channels/{{$.Data.currentServer.ID}}/{{.ID}}"
                        class="sidebar-item group flex items-center gap-2 px-2 py-1.5 rounded-lg text-sm transition-colors {{if eq .ID $.Data.channelID}}bg-gpt-sidebar-active text-gpt-text{{else}}text-gpt-text-secondary hover:bg-gpt-sidebar-hover hover:text-gpt-text{{end}}"
                    >
                        <span class="text-base opacity-50">#</span>
                        <span class="truncate flex-1">{{.Name}}</span>
                    </a>
                    {{end}}
                {{else}}
                    <div class="px-2 py-3 text-sm text-gpt-text-muted text-center">
                        No channels yet
                    </div>
                {{end}}
            </div>
        </div>
        {{end}}

        <!-- Explore Section -->
        <div class="p-2 {{if or .Data.servers .Data.currentServer}}border-t border-gpt-border{{end}}">
            <a
                href="/explore"
                class="sidebar-item flex items-center gap-3 px-2 py-2 rounded-lg text-sm transition-colors {{if .Data.isExplorePage}}bg-gpt-sidebar-active text-gpt-text{{else}}text-gpt-text-secondary hover:bg-gpt-sidebar-hover hover:text-gpt-text{{end}}"
            >
                <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"/>
                </svg>
                <span>Explore servers</span>
            </a>
            <button
                onclick="openCreateServerModal()"
                class="sidebar-item flex items-center gap-3 px-2 py-2 rounded-lg text-sm text-gpt-text-secondary hover:bg-gpt-sidebar-hover hover:text-gpt-text transition-colors w-full text-left mt-0.5"
            >
                <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
                <span>Add a server</span>
            </button>
        </div>
    </div>

    <!-- User Panel -->
    {{template "user_panel.html" .}}
</aside>

<!-- Create Server Modal -->
<div id="create-server-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop bg-black/50">
    <div class="w-full max-w-md mx-4 rounded-2xl p-6 animate-slide-up bg-white border border-gpt-border shadow-xl">
        <h2 class="text-lg font-semibold text-gpt-text mb-1">Create a server</h2>
        <p class="text-sm text-gpt-text-secondary mb-5">Give your server a name to get started.</p>

        <form id="create-server-form" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gpt-text mb-1.5">Server name</label>
                <input
                    type="text"
                    id="server-name"
                    name="name"
                    required
                    maxlength="100"
                    placeholder="My Server"
                    class="w-full px-3 py-2 rounded-lg text-sm outline-none transition-all bg-white border border-gpt-border text-gpt-text focus:border-gpt-text placeholder:text-gpt-text-muted"
                >
            </div>

            <div class="flex gap-2 justify-end pt-2">
                <button
                    type="button"
                    onclick="closeCreateServerModal()"
                    class="px-4 py-2 rounded-lg text-sm font-medium text-gpt-text hover:bg-gpt-sidebar-hover transition-colors"
                >
                    Cancel
                </button>
                <button
                    type="submit"
                    class="px-4 py-2 rounded-lg text-sm font-medium text-white bg-gpt-accent hover:opacity-90 transition-opacity"
                >
                    Create
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Create Channel Modal -->
<div id="create-channel-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop bg-black/50">
    <div class="w-full max-w-md mx-4 rounded-2xl p-6 animate-slide-up bg-white border border-gpt-border shadow-xl">
        <h2 class="text-lg font-semibold text-gpt-text mb-1">Create a channel</h2>
        <p class="text-sm text-gpt-text-secondary mb-5">Channels are where conversations happen.</p>

        <form id="create-channel-form" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gpt-text mb-1.5">Channel name</label>
                <div class="relative">
                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gpt-text-muted">#</span>
                    <input
                        type="text"
                        id="channel-name"
                        name="name"
                        required
                        maxlength="100"
                        placeholder="general"
                        class="w-full pl-7 pr-3 py-2 rounded-lg text-sm outline-none transition-all bg-white border border-gpt-border text-gpt-text focus:border-gpt-text placeholder:text-gpt-text-muted"
                    >
                </div>
            </div>

            <div class="flex gap-2 justify-end pt-2">
                <button
                    type="button"
                    onclick="closeCreateChannelModal()"
                    class="px-4 py-2 rounded-lg text-sm font-medium text-gpt-text hover:bg-gpt-sidebar-hover transition-colors"
                >
                    Cancel
                </button>
                <button
                    type="submit"
                    class="px-4 py-2 rounded-lg text-sm font-medium text-white bg-gpt-accent hover:opacity-90 transition-opacity"
                >
                    Create
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// Toggle section visibility
function toggleSection(section) {
    const content = document.getElementById(`${section}-content`);
    const chevron = document.getElementById(`${section}-chevron`);
    if (content && chevron) {
        content.classList.toggle('hidden');
        chevron.classList.toggle('rotate-180');
    }
}

// Server modal
function openCreateServerModal() {
    document.getElementById('create-server-modal')?.classList.remove('hidden');
    document.getElementById('create-server-modal')?.classList.add('flex');
    document.getElementById('server-name')?.focus();
}

function closeCreateServerModal() {
    const modal = document.getElementById('create-server-modal');
    modal?.classList.add('hidden');
    modal?.classList.remove('flex');
    document.getElementById('create-server-form')?.reset();
}

document.getElementById('create-server-modal')?.addEventListener('click', (e) => {
    if (e.target.id === 'create-server-modal') closeCreateServerModal();
});

document.getElementById('create-server-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const name = document.getElementById('server-name')?.value.trim();
    if (!name) return;

    const btn = e.target.querySelector('[type="submit"]');
    btn.disabled = true;
    btn.textContent = 'Creating...';

    try {
        const res = await fetch('/api/v1/servers', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name })
        });

        if (res.ok) {
            const data = await res.json();
            window.location.href = `/channels/${data.data.id}/${data.data.default_channel}`;
        } else {
            btn.disabled = false;
            btn.textContent = 'Create';
        }
    } catch (err) {
        console.error('Failed to create server');
        btn.disabled = false;
        btn.textContent = 'Create';
    }
});

// Channel modal
function openCreateChannelModal() {
    document.getElementById('create-channel-modal')?.classList.remove('hidden');
    document.getElementById('create-channel-modal')?.classList.add('flex');
    document.getElementById('channel-name')?.focus();
}

function closeCreateChannelModal() {
    const modal = document.getElementById('create-channel-modal');
    modal?.classList.add('hidden');
    modal?.classList.remove('flex');
    document.getElementById('create-channel-form')?.reset();
}

document.getElementById('create-channel-modal')?.addEventListener('click', (e) => {
    if (e.target.id === 'create-channel-modal') closeCreateChannelModal();
});

document.getElementById('create-channel-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const name = document.getElementById('channel-name')?.value.trim().toLowerCase().replace(/\s+/g, '-');
    if (!name) return;

    const serverId = '{{if .Data.currentServer}}{{.Data.currentServer.ID}}{{end}}';
    if (!serverId) return;

    const btn = e.target.querySelector('[type="submit"]');
    btn.disabled = true;
    btn.textContent = 'Creating...';

    try {
        const res = await fetch(`/api/v1/servers/${serverId}/channels`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, type: 'text' })
        });

        if (res.ok) {
            const data = await res.json();
            window.location.href = `/channels/${serverId}/${data.data.id}`;
        } else {
            btn.disabled = false;
            btn.textContent = 'Create';
        }
    } catch (err) {
        console.error('Failed to create channel');
        btn.disabled = false;
        btn.textContent = 'Create';
    }
});

// Keyboard shortcuts
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        closeCreateServerModal();
        closeCreateChannelModal();
    }
});
</script>
{{end}}
