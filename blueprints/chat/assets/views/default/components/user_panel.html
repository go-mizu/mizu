{{define "user_panel.html"}}
<div class="user-panel" id="user-panel">
    <div class="user-panel-info" onclick="showUserMenu()">
        <div class="user-avatar">
            {{if .User.AvatarURL}}
                <img src="{{.User.AvatarURL}}" alt="{{.User.Username}}">
            {{else}}
                <span>{{userInitials .User.DisplayName}}</span>
            {{end}}
            <span class="status-dot {{statusClass .User.Status}}" id="user-status-dot"></span>
        </div>
        <div class="user-info">
            <div class="user-name">{{.User.DisplayName}}</div>
            <div class="user-tag">
                {{if .User.CustomStatus}}
                    {{.User.CustomStatus}}
                {{else}}
                    #{{.User.Discriminator}}
                {{end}}
            </div>
        </div>
    </div>
    <div class="user-actions">
        <button class="user-action" title="Mute" id="mute-btn" onclick="toggleMute()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" id="mute-icon">
                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
                <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                <line x1="12" y1="19" x2="12" y2="23"/>
                <line x1="8" y1="23" x2="16" y2="23"/>
            </svg>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" id="mute-icon-off" class="hidden">
                <line x1="1" y1="1" x2="23" y2="23"/>
                <path d="M9 9v3a3 3 0 0 0 5.12 2.12M15 9.34V4a3 3 0 0 0-5.94-.6"/>
                <path d="M17 16.95A7 7 0 0 1 5 12v-2m14 0v2c0 1.02-.22 2-.6 2.88"/>
                <line x1="12" y1="19" x2="12" y2="23"/>
                <line x1="8" y1="23" x2="16" y2="23"/>
            </svg>
        </button>
        <button class="user-action" title="Deafen" id="deafen-btn" onclick="toggleDeafen()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" id="deafen-icon">
                <path d="M3 18v-6a9 9 0 0 1 18 0v6"/>
                <path d="M21 19a2 2 0 0 1-2 2h-1a2 2 0 0 1-2-2v-3a2 2 0 0 1 2-2h3zM3 19a2 2 0 0 0 2 2h1a2 2 0 0 0 2-2v-3a2 2 0 0 0-2-2H3z"/>
            </svg>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" id="deafen-icon-off" class="hidden">
                <line x1="1" y1="1" x2="23" y2="23"/>
                <path d="M9 9.64A9 9 0 0 1 21 12v6"/>
                <path d="M3 12a9 9 0 0 1 2.08-5.74"/>
                <path d="M21 19a2 2 0 0 1-2 2h-1a2 2 0 0 1-2-2v-3a2 2 0 0 1 2-2h3z"/>
                <path d="M3 19a2 2 0 0 0 2 2h1a2 2 0 0 0 2-2v-3a2 2 0 0 0-2-2H3z"/>
            </svg>
        </button>
        <a href="/settings" class="user-action" title="User Settings">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="3"/>
                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
            </svg>
        </a>
    </div>
</div>

<!-- User Menu / Status Picker -->
<div class="user-menu" id="user-menu">
    <div class="user-menu-header">
        <div class="user-avatar" style="width: 80px; height: 80px; font-size: 2rem;">
            {{if .User.AvatarURL}}
                <img src="{{.User.AvatarURL}}" alt="{{.User.Username}}">
            {{else}}
                <span>{{userInitials .User.DisplayName}}</span>
            {{end}}
        </div>
        <div class="user-menu-name">{{.User.DisplayName}}</div>
        <div class="user-menu-tag">{{.User.Username}}#{{.User.Discriminator}}</div>
    </div>

    <div class="user-menu-section">
        <div class="user-menu-section-title">Set Status</div>
        <button class="user-menu-status" data-status="online" onclick="setStatus('online')">
            <span class="status-dot online"></span>
            <span>Online</span>
            {{if eq .User.Status "online"}}<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>{{end}}
        </button>
        <button class="user-menu-status" data-status="idle" onclick="setStatus('idle')">
            <span class="status-dot idle"></span>
            <span>Idle</span>
            {{if eq .User.Status "idle"}}<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>{{end}}
        </button>
        <button class="user-menu-status" data-status="dnd" onclick="setStatus('dnd')">
            <span class="status-dot dnd"></span>
            <span>Do Not Disturb</span>
            {{if eq .User.Status "dnd"}}<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>{{end}}
        </button>
        <button class="user-menu-status" data-status="invisible" onclick="setStatus('invisible')">
            <span class="status-dot offline"></span>
            <span>Invisible</span>
            {{if eq .User.Status "invisible"}}<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>{{end}}
        </button>
    </div>

    <div class="user-menu-divider"></div>

    <div class="user-menu-section">
        <button class="user-menu-item" onclick="showCustomStatus()">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <path d="M8 14s1.5 2 4 2 4-2 4-2"/>
                <line x1="9" y1="9" x2="9.01" y2="9"/>
                <line x1="15" y1="9" x2="15.01" y2="9"/>
            </svg>
            <span>Set Custom Status</span>
        </button>
    </div>

    <div class="user-menu-divider"></div>

    <div class="user-menu-section">
        <button class="user-menu-item" onclick="toggleTheme()">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" id="theme-icon-moon">
                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
            </svg>
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" id="theme-icon-sun" class="hidden">
                <circle cx="12" cy="12" r="5"/>
                <line x1="12" y1="1" x2="12" y2="3"/>
                <line x1="12" y1="21" x2="12" y2="23"/>
                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                <line x1="1" y1="12" x2="3" y2="12"/>
                <line x1="21" y1="12" x2="23" y2="12"/>
                <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
            </svg>
            <span id="theme-label">Switch to Light Mode</span>
        </button>
        <button class="user-menu-item" onclick="copyUserId()">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
            </svg>
            <span>Copy User ID</span>
        </button>
    </div>
</div>

<!-- Custom Status Modal -->
<div class="modal-overlay" id="custom-status-modal">
    <div class="modal" style="max-width: 400px;">
        <div class="modal-header">
            <h2>Set Custom Status</h2>
        </div>
        <div class="modal-body">
            <form id="custom-status-form">
                <div class="form-group">
                    <label class="form-label">What's on your mind?</label>
                    <div class="custom-status-input-wrapper">
                        <button type="button" class="custom-status-emoji" id="status-emoji-btn" onclick="toggleStatusEmojiPicker()">
                            <span id="status-emoji">ðŸ˜€</span>
                        </button>
                        <input class="form-input" type="text" id="custom-status-text" maxlength="128" placeholder="Support has arrived!" value="{{.User.CustomStatus}}">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Clear after</label>
                    <select class="form-input" id="status-clear-after">
                        <option value="0">Don't clear</option>
                        <option value="1800">30 minutes</option>
                        <option value="3600">1 hour</option>
                        <option value="14400">4 hours</option>
                        <option value="86400">Today</option>
                    </select>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            {{if .User.CustomStatus}}
            <button class="btn btn-ghost text-danger" onclick="clearCustomStatus()" style="margin-right: auto;">Clear Status</button>
            {{end}}
            <button class="btn btn-ghost" onclick="closeCustomStatusModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveCustomStatus()">Save</button>
        </div>
    </div>
</div>

<script>
let userMenuOpen = false;
let isMuted = false;
let isDeafened = false;

// User menu
function showUserMenu() {
    const menu = document.getElementById('user-menu');
    userMenuOpen = !userMenuOpen;

    if (userMenuOpen) {
        menu?.classList.add('open');
        updateThemeIcon();
        document.addEventListener('click', closeUserMenuOnOutsideClick);
    } else {
        menu?.classList.remove('open');
        document.removeEventListener('click', closeUserMenuOnOutsideClick);
    }
}

function closeUserMenuOnOutsideClick(e) {
    const menu = document.getElementById('user-menu');
    const panel = document.getElementById('user-panel');
    if (!menu?.contains(e.target) && !panel?.contains(e.target)) {
        userMenuOpen = false;
        menu?.classList.remove('open');
        document.removeEventListener('click', closeUserMenuOnOutsideClick);
    }
}

// Status
async function setStatus(status) {
    try {
        const res = await fetch('/api/v1/auth/me', {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status })
        });

        if (res.ok) {
            // Update UI
            const dot = document.getElementById('user-status-dot');
            if (dot) {
                dot.className = `status-dot ${status === 'invisible' ? 'offline' : status}`;
            }

            // Update menu checkmarks
            document.querySelectorAll('.user-menu-status svg').forEach(svg => svg.remove());
            const activeBtn = document.querySelector(`.user-menu-status[data-status="${status}"]`);
            if (activeBtn) {
                activeBtn.innerHTML += '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>';
            }
        }
    } catch (err) {
        console.error('Failed to update status');
    }
}

// Mute/Deafen
function toggleMute() {
    isMuted = !isMuted;
    const btn = document.getElementById('mute-btn');
    const iconOn = document.getElementById('mute-icon');
    const iconOff = document.getElementById('mute-icon-off');

    if (isMuted) {
        btn?.classList.add('active');
        iconOn?.classList.add('hidden');
        iconOff?.classList.remove('hidden');
    } else {
        btn?.classList.remove('active');
        iconOn?.classList.remove('hidden');
        iconOff?.classList.add('hidden');
    }

    // Notify voice system
    if (window.voiceConnection) {
        window.voiceConnection.setMuted(isMuted);
    }
}

function toggleDeafen() {
    isDeafened = !isDeafened;
    const btn = document.getElementById('deafen-btn');
    const iconOn = document.getElementById('deafen-icon');
    const iconOff = document.getElementById('deafen-icon-off');

    if (isDeafened) {
        btn?.classList.add('active');
        iconOn?.classList.add('hidden');
        iconOff?.classList.remove('hidden');
        // Deafen also mutes
        if (!isMuted) toggleMute();
    } else {
        btn?.classList.remove('active');
        iconOn?.classList.remove('hidden');
        iconOff?.classList.add('hidden');
    }

    // Notify voice system
    if (window.voiceConnection) {
        window.voiceConnection.setDeafened(isDeafened);
    }
}

// Theme toggle
function toggleTheme() {
    const html = document.documentElement;
    const currentTheme = html.getAttribute('data-theme') || 'dark';
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

    html.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
    updateThemeIcon();
}

function updateThemeIcon() {
    const currentTheme = document.documentElement.getAttribute('data-theme') || 'dark';
    const moonIcon = document.getElementById('theme-icon-moon');
    const sunIcon = document.getElementById('theme-icon-sun');
    const label = document.getElementById('theme-label');

    if (currentTheme === 'dark') {
        moonIcon?.classList.remove('hidden');
        sunIcon?.classList.add('hidden');
        if (label) label.textContent = 'Switch to Light Mode';
    } else {
        moonIcon?.classList.add('hidden');
        sunIcon?.classList.remove('hidden');
        if (label) label.textContent = 'Switch to Dark Mode';
    }
}

// Copy user ID
function copyUserId() {
    const userId = '{{.User.ID}}';
    navigator.clipboard.writeText(userId);

    // Show feedback
    const item = event.target.closest('.user-menu-item');
    const originalText = item?.querySelector('span')?.textContent;
    if (item) {
        item.querySelector('span').textContent = 'Copied!';
        setTimeout(() => {
            item.querySelector('span').textContent = originalText;
        }, 2000);
    }
}

// Custom status
function showCustomStatus() {
    document.getElementById('user-menu')?.classList.remove('open');
    userMenuOpen = false;
    document.getElementById('custom-status-modal')?.classList.add('open');
}

function closeCustomStatusModal() {
    document.getElementById('custom-status-modal')?.classList.remove('open');
}

async function saveCustomStatus() {
    const text = document.getElementById('custom-status-text')?.value.trim();
    const emoji = document.getElementById('status-emoji')?.textContent;
    const clearAfter = parseInt(document.getElementById('status-clear-after')?.value || '0');

    try {
        const res = await fetch('/api/v1/auth/me', {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                custom_status: text,
                custom_status_emoji: emoji,
                custom_status_expires_at: clearAfter ? new Date(Date.now() + clearAfter * 1000).toISOString() : null
            })
        });

        if (res.ok) {
            closeCustomStatusModal();
            // Update user tag display
            const userTag = document.querySelector('.user-tag');
            if (userTag && text) {
                userTag.textContent = text;
            }
        }
    } catch (err) {
        console.error('Failed to save custom status');
    }
}

async function clearCustomStatus() {
    try {
        const res = await fetch('/api/v1/auth/me', {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                custom_status: '',
                custom_status_emoji: null,
                custom_status_expires_at: null
            })
        });

        if (res.ok) {
            closeCustomStatusModal();
            // Reset user tag display
            const userTag = document.querySelector('.user-tag');
            if (userTag) {
                userTag.textContent = '#{{.User.Discriminator}}';
            }
        }
    } catch (err) {
        console.error('Failed to clear custom status');
    }
}

// Emoji picker for custom status (simplified version)
let statusEmojiPickerOpen = false;

function toggleStatusEmojiPicker() {
    // For now, cycle through some common emojis
    const emojis = ['ðŸ˜€', 'ðŸ˜Ž', 'ðŸŽ®', 'ðŸŽ§', 'ðŸ’»', 'ðŸ“š', 'ðŸŽ¨', 'ðŸŽµ', 'âš¡', 'ðŸ”¥', 'ðŸ’¡', 'ðŸš€'];
    const emojiSpan = document.getElementById('status-emoji');
    if (emojiSpan) {
        const currentIndex = emojis.indexOf(emojiSpan.textContent);
        const nextIndex = (currentIndex + 1) % emojis.length;
        emojiSpan.textContent = emojis[nextIndex];
    }
}

// Modal close handlers
document.getElementById('custom-status-modal')?.addEventListener('click', (e) => {
    if (e.target.id === 'custom-status-modal') {
        closeCustomStatusModal();
    }
});

document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        if (userMenuOpen) {
            document.getElementById('user-menu')?.classList.remove('open');
            userMenuOpen = false;
        }
        closeCustomStatusModal();
    }
});

// Initialize theme on load
document.addEventListener('DOMContentLoaded', () => {
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme) {
        document.documentElement.setAttribute('data-theme', savedTheme);
    }
});
</script>
{{end}}
