{{define "server_list.html"}}
<nav class="server-list" id="server-list">
    <!-- Home Button with DM badge -->
    <div class="server-icon-wrapper">
        <a href="/" class="server-icon home{{if not .Data.currentServer}} active{{end}}" title="Direct Messages">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                <polyline points="9 22 9 12 15 12 15 22"/>
            </svg>
        </a>
        {{if .Data.unreadDMs}}
        <span class="server-badge">{{if gt .Data.unreadDMs 99}}99+{{else}}{{.Data.unreadDMs}}{{end}}</span>
        {{end}}
        <span class="server-pill{{if not .Data.currentServer}} active{{end}}"></span>
    </div>

    <div class="server-separator"></div>

    <!-- Server List -->
    {{range .Data.servers}}
    <div class="server-icon-wrapper">
        <a href="/channels/{{.ID}}/{{.DefaultChannel}}"
           class="server-icon{{if and $.Data.currentServer (eq .ID $.Data.currentServer.ID)}} active{{end}}"
           title="{{.Name}}"
           data-server-id="{{.ID}}">
            {{if .IconURL}}
                <img src="{{.IconURL}}" alt="{{.Name}}" loading="lazy">
            {{else}}
                <span class="server-initial">{{slice .Name 0 1}}</span>
            {{end}}
        </a>
        {{if .UnreadCount}}
        <span class="server-badge">{{if gt .UnreadCount 99}}99+{{else}}{{.UnreadCount}}{{end}}</span>
        {{end}}
        {{if .HasMention}}
        <span class="server-mention"></span>
        {{end}}
        <span class="server-pill{{if and $.Data.currentServer (eq .ID $.Data.currentServer.ID)}} active{{else if .UnreadCount}} unread{{end}}"></span>
    </div>
    {{end}}

    <div class="server-separator"></div>

    <!-- Add Server Button -->
    <div class="server-icon-wrapper">
        <button class="server-icon server-add" title="Add a Server" data-action="create-server">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="12" y1="5" x2="12" y2="19"/>
                <line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
        </button>
        <span class="server-pill"></span>
    </div>

    <!-- Explore Button -->
    <div class="server-icon-wrapper">
        <button class="server-icon server-explore" title="Explore Public Servers" onclick="window.location.href='/explore'">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"/>
                <polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"/>
            </svg>
        </button>
        <span class="server-pill"></span>
    </div>
</nav>

<!-- Create/Join Server Modal -->
<div class="modal-overlay" id="add-server-modal">
    <div class="modal">
        <div class="modal-header">
            <h2>Add a Server</h2>
            <p>Create your own server or join an existing one.</p>
        </div>
        <div class="modal-body" style="display: flex; flex-direction: column; gap: var(--space-3);">
            <button class="btn btn-lg" style="justify-content: flex-start; gap: var(--space-3); padding: var(--space-4);" onclick="showCreateServerForm()">
                <div style="width: 48px; height: 48px; border-radius: var(--radius-full); background: var(--primary); display: flex; align-items: center; justify-content: center;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"/>
                        <line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                </div>
                <div style="text-align: left;">
                    <div style="font-weight: 600;">Create My Own</div>
                    <div style="font-size: var(--font-size-sm); color: var(--text-muted);">Start fresh with a new server</div>
                </div>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-left: auto;">
                    <polyline points="9 18 15 12 9 6"/>
                </svg>
            </button>
            <button class="btn btn-lg" style="justify-content: flex-start; gap: var(--space-3); padding: var(--space-4);" onclick="showJoinServerForm()">
                <div style="width: 48px; height: 48px; border-radius: var(--radius-full); background: var(--bg-tertiary); display: flex; align-items: center; justify-content: center;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/>
                        <polyline points="10 17 15 12 10 7"/>
                        <line x1="15" y1="12" x2="3" y2="12"/>
                    </svg>
                </div>
                <div style="text-align: left;">
                    <div style="font-weight: 600;">Join a Server</div>
                    <div style="font-size: var(--font-size-sm); color: var(--text-muted);">Enter an invite link to join</div>
                </div>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-left: auto;">
                    <polyline points="9 18 15 12 9 6"/>
                </svg>
            </button>
        </div>
        <div class="modal-footer" style="justify-content: center; border-top: none; padding-top: 0;">
            <button class="btn btn-ghost" onclick="closeAddServerModal()">Cancel</button>
        </div>
    </div>
</div>

<!-- Create Server Form Modal -->
<div class="modal-overlay" id="create-server-modal">
    <div class="modal">
        <div class="modal-header">
            <h2>Create Your Server</h2>
            <p>Give your new server a personality with a name and an icon.</p>
        </div>
        <div class="modal-body">
            <form id="create-server-form">
                <div class="form-group" style="text-align: center;">
                    <div class="avatar-upload" id="server-icon-upload">
                        <input type="file" accept="image/*" id="server-icon-input" hidden>
                        <div class="avatar-upload-preview" id="server-icon-preview">
                            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                <circle cx="8.5" cy="8.5" r="1.5"/>
                                <polyline points="21 15 16 10 5 21"/>
                            </svg>
                            <span>Upload</span>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label required" for="new-server-name">Server Name</label>
                    <input class="form-input" type="text" id="new-server-name" name="name" required maxlength="100" placeholder="My Awesome Server">
                </div>
                <div class="form-group">
                    <label class="form-label" for="new-server-description">Description</label>
                    <textarea class="form-input" id="new-server-description" name="description" rows="3" maxlength="1024" placeholder="What's your server about?"></textarea>
                </div>
                <label class="form-checkbox">
                    <input type="checkbox" name="is_public" id="new-server-public">
                    <span class="form-checkbox-label">Make this server public (visible in Explore)</span>
                </label>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-ghost" onclick="backToAddServer()">Back</button>
            <button class="btn btn-primary" onclick="createNewServer()">Create</button>
        </div>
    </div>
</div>

<!-- Join Server Form Modal -->
<div class="modal-overlay" id="join-server-modal">
    <div class="modal">
        <div class="modal-header">
            <h2>Join a Server</h2>
            <p>Enter an invite below to join an existing server.</p>
        </div>
        <div class="modal-body">
            <form id="join-server-form">
                <div class="form-group">
                    <label class="form-label required" for="invite-link">Invite Link</label>
                    <input class="form-input" type="text" id="invite-link" name="invite" required placeholder="https://mizu.app/invite/abc123">
                    <p class="form-hint">
                        <strong>Invites should look like:</strong><br>
                        mizu.app/invite/abc123<br>
                        abc123
                    </p>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-ghost" onclick="backToAddServer()">Back</button>
            <button class="btn btn-primary" onclick="joinServerByInvite()">Join Server</button>
        </div>
    </div>
</div>

<script>
// Server list functionality
document.querySelector('[data-action="create-server"]')?.addEventListener('click', () => {
    document.getElementById('add-server-modal')?.classList.add('open');
});

function closeAddServerModal() {
    document.getElementById('add-server-modal')?.classList.remove('open');
}

function showCreateServerForm() {
    document.getElementById('add-server-modal')?.classList.remove('open');
    document.getElementById('create-server-modal')?.classList.add('open');
}

function showJoinServerForm() {
    document.getElementById('add-server-modal')?.classList.remove('open');
    document.getElementById('join-server-modal')?.classList.add('open');
}

function backToAddServer() {
    document.getElementById('create-server-modal')?.classList.remove('open');
    document.getElementById('join-server-modal')?.classList.remove('open');
    document.getElementById('add-server-modal')?.classList.add('open');
}

// Server icon upload
document.getElementById('server-icon-upload')?.addEventListener('click', () => {
    document.getElementById('server-icon-input')?.click();
});

document.getElementById('server-icon-input')?.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const preview = document.getElementById('server-icon-preview');
            if (preview) {
                preview.innerHTML = `<img src="${e.target.result}" alt="Server icon">`;
                preview.classList.add('has-image');
            }
        };
        reader.readAsDataURL(file);
    }
});

async function createNewServer() {
    const name = document.getElementById('new-server-name')?.value.trim();
    const description = document.getElementById('new-server-description')?.value.trim();
    const isPublic = document.getElementById('new-server-public')?.checked;

    if (!name) {
        alert('Please enter a server name');
        return;
    }

    try {
        const res = await fetch('/api/v1/servers', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, description, is_public: isPublic })
        });

        if (res.ok) {
            const data = await res.json();
            window.location.href = `/channels/${data.data.id}/${data.data.default_channel}`;
        } else {
            const json = await res.json();
            alert(json.error?.message || 'Failed to create server');
        }
    } catch (err) {
        alert('Failed to create server');
    }
}

async function joinServerByInvite() {
    const invite = document.getElementById('invite-link')?.value.trim();

    if (!invite) {
        alert('Please enter an invite link');
        return;
    }

    // Extract invite code from various formats
    let code = invite;
    if (invite.includes('/')) {
        code = invite.split('/').pop();
    }

    try {
        const res = await fetch(`/api/v1/invites/${code}/join`, { method: 'POST' });

        if (res.ok) {
            const data = await res.json();
            window.location.href = `/channels/${data.data.server_id}/${data.data.default_channel}`;
        } else {
            const json = await res.json();
            alert(json.error?.message || 'Invalid or expired invite');
        }
    } catch (err) {
        alert('Failed to join server');
    }
}

// Close modals on backdrop click
['add-server-modal', 'create-server-modal', 'join-server-modal'].forEach(id => {
    document.getElementById(id)?.addEventListener('click', (e) => {
        if (e.target.id === id) {
            document.getElementById(id)?.classList.remove('open');
        }
    });
});

// Close modals on Escape
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        ['add-server-modal', 'create-server-modal', 'join-server-modal'].forEach(id => {
            document.getElementById(id)?.classList.remove('open');
        });
    }
});

// Server context menu
document.querySelectorAll('.server-icon[data-server-id]').forEach(icon => {
    icon.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        const serverId = icon.dataset.serverId;
        // Could implement server context menu here (leave, mark as read, etc.)
    });
});
</script>
{{end}}
