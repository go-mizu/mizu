{{define "app.html"}}
{{template "base.html" .}}
{{end}}

{{define "content"}}
<div class="app" id="app">
  <!-- Server List -->
  <nav class="server-list" id="server-list">
    <a href="/" class="server-icon" title="Home">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
        <path d="M12 2L2 7v10l10 5 10-5V7L12 2zm0 2.18l6.9 3.45L12 11.09 5.1 7.63 12 4.18zM4 8.82l7 3.5v6.86l-7-3.5V8.82zm9 10.36v-6.86l7-3.5v6.86l-7 3.5z"/>
      </svg>
    </a>
    <div class="server-separator"></div>
    {{range .Data.servers}}
    <a href="/channels/{{.ID}}/{{.DefaultChannel}}" class="server-icon{{if eq .ID $.Data.currentServer.ID}} active{{end}}" title="{{.Name}}">
      {{if .IconURL}}
        <img src="{{.IconURL}}" alt="{{.Name}}">
      {{else}}
        {{slice .Name 0 1}}
      {{end}}
    </a>
    {{end}}
    <button class="server-icon server-add" title="Add a Server" onclick="showCreateServer()">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
        <path d="M12 5v14m-7-7h14" stroke="currentColor" stroke-width="2" fill="none"/>
      </svg>
    </button>
  </nav>

  <!-- Channel Sidebar -->
  <aside class="channel-sidebar" id="channel-sidebar">
    {{if .Data.currentServer}}
    <header class="server-header">
      <span>{{.Data.currentServer.Name}}</span>
    </header>
    {{else}}
    <header class="server-header">
      <span>Direct Messages</span>
    </header>
    {{end}}

    <div class="channel-list" id="channel-list">
      <!-- Channels loaded via JS -->
    </div>

    <div class="user-panel">
      <div class="user-avatar">
        {{if .User.AvatarURL}}
          <img src="{{.User.AvatarURL}}" alt="{{.User.Username}}">
        {{else}}
          {{slice .User.Username 0 1}}
        {{end}}
        <span class="status-indicator online"></span>
      </div>
      <div class="user-info">
        <div class="username">{{.User.DisplayName}}</div>
        <div class="user-status">Online</div>
      </div>
      <div class="user-actions">
        <button class="user-action" title="Settings" onclick="window.location.href='/settings'">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 15a3 3 0 100-6 3 3 0 000 6z"/>
            <path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/>
          </svg>
        </button>
      </div>
    </div>
  </aside>

  <!-- Chat Area -->
  <main class="chat-area" id="chat-area">
    <header class="chat-header" id="chat-header">
      <span class="chat-header-icon">#</span>
      <span class="chat-header-name" id="channel-name">general</span>
      <span class="chat-header-divider"></span>
      <span class="chat-header-topic" id="channel-topic">Welcome to the server!</span>
    </header>

    <div class="messages" id="messages">
      <!-- Messages loaded via JS -->
    </div>

    <div class="typing-indicator hidden" id="typing-indicator">
      <div class="typing-dots">
        <span></span>
        <span></span>
        <span></span>
      </div>
      <span id="typing-users">Someone is typing...</span>
    </div>

    <div class="message-input-wrapper">
      <div class="message-input">
        <button class="input-action" title="Attach file">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 5v14m-7-7h14" stroke="currentColor" stroke-width="2" fill="none"/>
          </svg>
        </button>
        <input type="text" id="message-input" placeholder="Message #general" autocomplete="off">
        <button class="input-action" title="Send" onclick="sendMessage()">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <path d="M2 21l21-9L2 3v7l15 2-15 2v7z"/>
          </svg>
        </button>
      </div>
    </div>
  </main>

  <!-- Member Sidebar -->
  <aside class="member-sidebar" id="member-sidebar">
    <div class="member-category">Online - <span id="online-count">0</span></div>
    <div id="online-members">
      <!-- Members loaded via JS -->
    </div>

    <div class="member-category">Offline - <span id="offline-count">0</span></div>
    <div id="offline-members">
      <!-- Members loaded via JS -->
    </div>
  </aside>
</div>

<script>
// App state
const state = {
  user: {{.User}},
  servers: {{.Data.servers}},
  currentServer: {{if .Data.currentServer}}{{.Data.currentServer}}{{else}}null{{end}},
  currentChannel: {{if .Data.channelID}}"{{.Data.channelID}}"{{else}}null{{end}},
  messages: [],
  members: [],
  ws: null
};

// Initialize app
document.addEventListener('DOMContentLoaded', () => {
  initWebSocket();
  loadChannels();
  if (state.currentChannel) {
    loadMessages(state.currentChannel);
    loadMembers();
  }

  // Message input
  document.getElementById('message-input').addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });
});

// WebSocket
function initWebSocket() {
  const token = document.cookie.split('; ').find(row => row.startsWith('session='))?.split('=')[1];
  if (!token) return;

  const ws = new WebSocket(`ws://${window.location.host}/ws?token=${token}`);
  state.ws = ws;

  ws.onopen = () => console.log('WebSocket connected');
  ws.onclose = () => {
    console.log('WebSocket disconnected');
    setTimeout(initWebSocket, 3000);
  };
  ws.onmessage = (e) => {
    const msg = JSON.parse(e.data);
    handleWSMessage(msg);
  };
}

function handleWSMessage(msg) {
  if (msg.op === 0) { // Dispatch
    const data = msg.d;
    switch (msg.t) {
      case 'MESSAGE_CREATE':
        if (data.channel_id === state.currentChannel) {
          appendMessage(data);
        }
        break;
      case 'MESSAGE_UPDATE':
        updateMessage(data);
        break;
      case 'MESSAGE_DELETE':
        removeMessage(data.id);
        break;
      case 'TYPING_START':
        showTyping(data.user_id);
        break;
      case 'PRESENCE_UPDATE':
        updatePresence(data);
        break;
    }
  }
}

// API calls
async function loadChannels() {
  if (!state.currentServer) return;
  try {
    const res = await fetch(`/api/v1/servers/${state.currentServer.id}/channels`);
    const json = await res.json();
    renderChannels(json.data || []);
  } catch (err) {
    console.error('Failed to load channels:', err);
  }
}

async function loadMessages(channelId) {
  try {
    const res = await fetch(`/api/v1/channels/${channelId}/messages`);
    const json = await res.json();
    state.messages = json.data || [];
    renderMessages();
  } catch (err) {
    console.error('Failed to load messages:', err);
  }
}

async function loadMembers() {
  if (!state.currentServer) return;
  try {
    const res = await fetch(`/api/v1/servers/${state.currentServer.id}/members`);
    const json = await res.json();
    state.members = json.data || [];
    renderMembers();
  } catch (err) {
    console.error('Failed to load members:', err);
  }
}

async function sendMessage() {
  const input = document.getElementById('message-input');
  const content = input.value.trim();
  if (!content || !state.currentChannel) return;

  input.value = '';

  try {
    await fetch(`/api/v1/channels/${state.currentChannel}/messages`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ content })
    });
  } catch (err) {
    console.error('Failed to send message:', err);
    input.value = content;
  }
}

// Rendering
function renderChannels(channels) {
  const list = document.getElementById('channel-list');
  list.innerHTML = channels.map(ch => `
    <a href="/channels/${state.currentServer.id}/${ch.id}"
       class="channel${ch.id === state.currentChannel ? ' active' : ''}">
      <span class="channel-icon">#</span>
      <span class="channel-name">${ch.name}</span>
    </a>
  `).join('');
}

function renderMessages() {
  const container = document.getElementById('messages');
  container.innerHTML = state.messages.reverse().map(msg => `
    <div class="message" data-id="${msg.id}">
      <div class="message-avatar">${msg.author_id.slice(0, 1).toUpperCase()}</div>
      <div class="message-content">
        <div class="message-header">
          <span class="message-author">${msg.author_id}</span>
          <span class="message-timestamp">${formatTime(msg.created_at)}</span>
        </div>
        <div class="message-text">${msg.content_html || escapeHtml(msg.content)}</div>
        ${msg.reactions?.length ? `<div class="message-reactions">${msg.reactions.map(r => `
          <span class="reaction">${r.emoji} ${r.count}</span>
        `).join('')}</div>` : ''}
      </div>
    </div>
  `).join('');
  container.scrollTop = container.scrollHeight;
}

function renderMembers() {
  const online = state.members.filter(m => true); // TODO: check presence
  const offline = [];

  document.getElementById('online-count').textContent = online.length;
  document.getElementById('offline-count').textContent = offline.length;

  document.getElementById('online-members').innerHTML = online.map(m => `
    <div class="member online">
      <div class="member-avatar">${m.user_id.slice(0, 1).toUpperCase()}</div>
      <span class="member-name">${m.nickname || m.user_id}</span>
    </div>
  `).join('');
}

function appendMessage(msg) {
  state.messages.push(msg);
  const container = document.getElementById('messages');
  const wasAtBottom = container.scrollHeight - container.scrollTop === container.clientHeight;

  container.innerHTML += `
    <div class="message" data-id="${msg.id}">
      <div class="message-avatar">${msg.author_id.slice(0, 1).toUpperCase()}</div>
      <div class="message-content">
        <div class="message-header">
          <span class="message-author">${msg.author_id}</span>
          <span class="message-timestamp">${formatTime(msg.created_at)}</span>
        </div>
        <div class="message-text">${msg.content_html || escapeHtml(msg.content)}</div>
      </div>
    </div>
  `;

  if (wasAtBottom) container.scrollTop = container.scrollHeight;
}

function updateMessage(msg) {
  const el = document.querySelector(`.message[data-id="${msg.id}"]`);
  if (el) {
    el.querySelector('.message-text').innerHTML = msg.content_html || escapeHtml(msg.content);
  }
}

function removeMessage(id) {
  document.querySelector(`.message[data-id="${id}"]`)?.remove();
}

function showTyping(userId) {
  const el = document.getElementById('typing-indicator');
  el.classList.remove('hidden');
  setTimeout(() => el.classList.add('hidden'), 5000);
}

function updatePresence(data) {
  // TODO: Update member list presence
}

// Utilities
function formatTime(iso) {
  const d = new Date(iso);
  return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}

function escapeHtml(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

function showCreateServer() {
  const name = prompt('Server name:');
  if (!name) return;

  fetch('/api/v1/servers', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ name })
  }).then(res => {
    if (res.ok) window.location.reload();
    else alert('Failed to create server');
  });
}
</script>
{{end}}
