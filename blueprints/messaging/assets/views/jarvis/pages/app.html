{{define "content"}}
<!-- JARVIS HUD Overlay Elements -->
<div class="jarvis-hex-grid"></div>

<!-- Westworld Grid Overlay -->
<div class="westworld-grid-overlay"></div>

<!-- Cross Markers - Westworld Style -->
<div class="ww-cross-marker pos-1">+</div>
<div class="ww-cross-marker pos-2">+</div>
<div class="ww-cross-marker pos-3">+</div>

<!-- Floating Particles -->
<div class="jarvis-particles">
    <div class="jarvis-particle"></div>
    <div class="jarvis-particle"></div>
    <div class="jarvis-particle"></div>
    <div class="jarvis-particle"></div>
    <div class="jarvis-particle"></div>
    <div class="jarvis-particle"></div>
    <div class="jarvis-particle"></div>
    <div class="jarvis-particle"></div>
    <div class="jarvis-particle"></div>
    <div class="jarvis-particle"></div>
</div>

<!-- Data Streams -->
<div class="jarvis-data-stream"></div>
<div class="jarvis-data-stream"></div>
<div class="jarvis-data-stream"></div>
<div class="jarvis-data-stream"></div>
<div class="jarvis-data-stream"></div>

<!-- HUD Corner Frames -->
<div class="jarvis-hud-frame top-left"></div>
<div class="jarvis-hud-frame top-right"></div>
<div class="jarvis-hud-frame bottom-left"></div>
<div class="jarvis-hud-frame bottom-right"></div>

<!-- System Readout - Enhanced Westworld Style -->
<div class="jarvis-data-readout ww-boot-text" id="jarvis-readout"></div>

<!-- Additional Data Readout - Left Side -->
<div class="jarvis-data-readout" style="left: auto; right: 110px; top: 30px;">
    <span style="opacity: 0.5;">BUILD</span> <span style="color: var(--holo-teal);">3.14.159</span> // <span style="opacity: 0.5;">HOST</span> <span style="color: var(--holo-cyan);">ONLINE</span>
</div>

<!-- System Status - Westworld Style -->
<div class="jarvis-system-status ww-info-panel" style="padding: 8px 12px; position: fixed; bottom: 30px; right: 110px;">
    <div class="jarvis-status-item">
        <span class="jarvis-status-dot"></span>
        <span>CORE</span>
    </div>
    <div class="jarvis-status-item">
        <span class="jarvis-status-dot"></span>
        <span>COMM</span>
    </div>
    <div class="jarvis-status-item">
        <span class="jarvis-status-dot"></span>
        <span>SEC</span>
    </div>
    <div class="jarvis-status-item">
        <span class="jarvis-status-dot"></span>
        <span>SYNC</span>
    </div>
    <div class="ww-sync-indicator" style="margin-left: 12px;">
        <div class="ww-sync-dot"></div>
        <div class="ww-sync-dot"></div>
        <div class="ww-sync-dot"></div>
    </div>
</div>

<div class="neural-app">
    <!-- Contact List Sidebar -->
    <div id="contact-list-window" class="neural-window neural-sidebar">
        <!-- Header -->
        <div class="neural-header">
            <div class="neural-header-icon">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                </svg>
            </div>
            <span class="neural-header-title">J.A.R.V.I.S.</span>
            <div class="neural-header-controls">
                <button class="neural-ctrl-btn minimize ui-disabled" title="Minimize"></button>
                <button class="neural-ctrl-btn maximize ui-disabled" title="Maximize"></button>
                <button class="neural-ctrl-btn close ui-disabled" title="Close"></button>
            </div>
        </div>

        <!-- User Panel - Westworld Enhanced -->
        <div class="neural-user-panel ww-corner-frame">
            <span class="ww-corner-bl"></span>
            <span class="ww-corner-br"></span>
            <div class="neural-avatar ww-avatar">
                <div class="neural-avatar-ring"></div>
                <div class="neural-avatar-image">
                    <svg viewBox="0 0 48 48">
                        <circle cx="24" cy="18" r="10"/>
                        <ellipse cx="24" cy="42" rx="16" ry="14"/>
                    </svg>
                </div>
                <div class="neural-status-indicator" id="user-status-indicator"></div>
                <div class="ww-host-status"></div>
            </div>
            <div class="neural-user-info">
                <div class="neural-user-name" id="user-displayname"></div>
                <div class="neural-user-status">
                    <select class="neural-select" id="status-select" style="padding: 4px 8px; font-size: 11px; width: auto;">
                        <option value="online">Online</option>
                        <option value="busy">Busy</option>
                        <option value="away">Away</option>
                        <option value="invisible">Invisible</option>
                    </select>
                </div>
                <!-- Westworld-style micro progress bar -->
                <div class="ww-progress-bar" style="margin-top: 6px; height: 3px;">
                    <div class="ww-progress-segment active"></div>
                    <div class="ww-progress-segment active"></div>
                    <div class="ww-progress-segment active"></div>
                    <div class="ww-progress-segment active"></div>
                    <div class="ww-progress-segment"></div>
                </div>
            </div>
        </div>

        <!-- Westworld System Infographic Panel -->
        <div class="ww-system-panel">
            <div class="ww-system-header">
                <span class="ww-system-title">SYSTEM METRICS</span>
                <span class="ww-system-id">HOST.001</span>
            </div>
            <div class="ww-system-grid">
                <div class="ww-metric-item">
                    <div class="ww-metric-circle">
                        <svg viewBox="0 0 36 36">
                            <path class="ww-metric-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                            <path class="ww-metric-fill cyan" stroke-dasharray="85, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                        </svg>
                        <span class="ww-metric-value">85</span>
                    </div>
                    <span class="ww-metric-label">SYNC</span>
                </div>
                <div class="ww-metric-item">
                    <div class="ww-metric-circle">
                        <svg viewBox="0 0 36 36">
                            <path class="ww-metric-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                            <path class="ww-metric-fill teal" stroke-dasharray="92, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                        </svg>
                        <span class="ww-metric-value">92</span>
                    </div>
                    <span class="ww-metric-label">CONN</span>
                </div>
                <div class="ww-metric-item">
                    <div class="ww-metric-circle">
                        <svg viewBox="0 0 36 36">
                            <path class="ww-metric-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                            <path class="ww-metric-fill purple" stroke-dasharray="67, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                        </svg>
                        <span class="ww-metric-value">67</span>
                    </div>
                    <span class="ww-metric-label">MEM</span>
                </div>
            </div>
            <div class="ww-data-stream-mini">
                <div class="ww-stream-bar"></div>
                <div class="ww-stream-bar"></div>
                <div class="ww-stream-bar"></div>
                <div class="ww-stream-bar"></div>
                <div class="ww-stream-bar"></div>
                <div class="ww-stream-bar"></div>
                <div class="ww-stream-bar"></div>
                <div class="ww-stream-bar"></div>
            </div>
        </div>

        <!-- Search -->
        <div class="neural-search">
            <div class="neural-search-wrapper">
                <input type="text" class="neural-search-input" placeholder="Search contacts..." oninput="filterContacts(this.value)">
            </div>
        </div>

        <!-- Contact List -->
        <div class="neural-contacts" style="flex: 1; overflow-y: auto;">
            <div class="neural-contact-category">
                <div class="neural-category-header" onclick="toggleCategory(this)">
                    <span class="neural-category-icon">-</span>
                    <span>Contacts</span>
                    <span class="neural-category-count">(<span class="online-count">0</span>/<span class="total-count">0</span>)</span>
                </div>
                <div class="neural-category-content" id="contacts-list">
                    <!-- Contacts loaded dynamically -->
                </div>
            </div>
        </div>

        <!-- Action Bar - Westworld Enhanced -->
        <div class="neural-action-bar ww-enhanced">
            <!-- Message Button -->
            <button class="ww-action-btn message" onclick="showNewChatModal()" title="New Message">
                <span class="ww-action-stat">TX</span>
                <span class="ww-notification"></span>
                <div class="ww-action-icon">
                    <div class="ww-action-progress-arc"></div>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/>
                        <circle cx="12" cy="12" r="1" fill="currentColor"/>
                        <circle cx="8" cy="12" r="1" fill="currentColor"/>
                        <circle cx="16" cy="12" r="1" fill="currentColor"/>
                    </svg>
                    <div class="ww-micro-gauge"></div>
                </div>
                <span class="ww-action-label">Transmit</span>
                <div class="ww-action-data">
                    <div class="ww-action-data-bar active"></div>
                    <div class="ww-action-data-bar active"></div>
                    <div class="ww-action-data-bar active"></div>
                    <div class="ww-action-data-bar"></div>
                    <div class="ww-action-data-bar"></div>
                </div>
            </button>

            <!-- Add Contact Button -->
            <button class="ww-action-btn add" onclick="showQRModal()" title="Add Contact">
                <span class="ww-action-stat">ID+</span>
                <div class="ww-action-icon">
                    <div class="ww-action-progress-arc"></div>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M12 2a5 5 0 1 0 0 10 5 5 0 0 0 0-10z"/>
                        <path d="M12 12c-5.33 0-8 2.67-8 8h16c0-5.33-2.67-8-8-8z"/>
                        <line x1="20" y1="8" x2="20" y2="14"/>
                        <line x1="17" y1="11" x2="23" y2="11"/>
                    </svg>
                    <div class="ww-micro-gauge"></div>
                </div>
                <span class="ww-action-label">Add Host</span>
                <div class="ww-action-data">
                    <div class="ww-action-data-bar active"></div>
                    <div class="ww-action-data-bar active"></div>
                    <div class="ww-action-data-bar"></div>
                    <div class="ww-action-data-bar"></div>
                    <div class="ww-action-data-bar"></div>
                </div>
            </button>

            <!-- Settings Button -->
            <button class="ww-action-btn settings" onclick="window.location.href='/settings'" title="Settings">
                <span class="ww-action-stat">CFG</span>
                <div class="ww-action-icon">
                    <div class="ww-action-progress-arc"></div>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M12 1v2m0 18v2M4.22 4.22l1.42 1.42m12.72 12.72l1.42 1.42M1 12h2m18 0h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
                        <circle cx="12" cy="12" r="8" stroke-dasharray="4 2"/>
                    </svg>
                    <div class="ww-micro-gauge"></div>
                </div>
                <span class="ww-action-label">Configure</span>
                <div class="ww-action-data">
                    <div class="ww-action-data-bar active"></div>
                    <div class="ww-action-data-bar active"></div>
                    <div class="ww-action-data-bar active"></div>
                    <div class="ww-action-data-bar active"></div>
                    <div class="ww-action-data-bar"></div>
                </div>
            </button>

            <!-- Logout Button -->
            <button class="ww-action-btn logout" onclick="logout()" title="Disconnect">
                <span class="ww-action-stat">EXIT</span>
                <div class="ww-action-icon">
                    <div class="ww-action-progress-arc"></div>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                        <polyline points="16 17 21 12 16 7"/>
                        <line x1="21" y1="12" x2="9" y2="12"/>
                        <circle cx="12" cy="12" r="10" stroke-dasharray="2 3" opacity="0.3"/>
                    </svg>
                    <div class="ww-micro-gauge"></div>
                </div>
                <span class="ww-action-label">Terminate</span>
                <div class="ww-action-data">
                    <div class="ww-action-data-bar"></div>
                    <div class="ww-action-data-bar"></div>
                    <div class="ww-action-data-bar"></div>
                    <div class="ww-action-data-bar"></div>
                    <div class="ww-action-data-bar"></div>
                </div>
            </button>
        </div>

        <!-- Status Bar -->
        <div class="neural-statusbar">
            <div class="neural-statusbar-item" id="connection-status">Initializing J.A.R.V.I.S...</div>
        </div>
    </div>

    <!-- Chat Window (shown when chat selected) -->
    <div id="chat-window" class="neural-window neural-main" style="display: none;">
        <!-- Header -->
        <div class="neural-header">
            <div class="neural-header-icon">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                </svg>
            </div>
            <span class="neural-header-title" id="chat-title">J.A.R.V.I.S. Link Active</span>
            <div class="neural-header-controls">
                <button class="neural-ctrl-btn minimize ui-disabled" title="Minimize"></button>
                <button class="neural-ctrl-btn maximize ui-disabled" title="Maximize"></button>
                <button class="neural-ctrl-btn close" onclick="closeChat()" title="Close"></button>
            </div>
        </div>

        <!-- Chat Header -->
        <div class="neural-chat-header">
            <div class="neural-chat-avatar">
                <svg viewBox="0 0 48 48">
                    <circle cx="24" cy="18" r="10" fill="currentColor"/>
                    <ellipse cx="24" cy="42" rx="16" ry="14" fill="currentColor"/>
                </svg>
            </div>
            <div class="neural-chat-info">
                <div class="neural-chat-name" id="chat-contact-name"></div>
                <div class="neural-chat-status" id="chat-contact-status">Connected</div>
            </div>
            <div class="neural-chat-actions">
                <button class="neural-chat-action-btn ui-disabled" title="Voice Link (Coming soon)">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                    </svg>
                </button>
                <button class="neural-chat-action-btn ui-disabled" title="Holo-Link (Coming soon)">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="23 7 16 12 23 17 23 7"/>
                        <rect x="1" y="5" width="15" height="14" rx="2" ry="2"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Message Area -->
        <div class="neural-messages" id="messages" style="flex: 1; min-height: 0;">
            <!-- Messages loaded dynamically -->
        </div>

        <!-- Input Area -->
        <div class="neural-input-area" id="message-input-area">
            <div class="neural-input-label">NEURAL INPUT</div>

            <!-- Toolbar -->
            <div class="neural-input-toolbar" id="neural-picker-wrapper">
                <input type="file" id="media-file-input" style="display: none;" multiple accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.zip" onchange="handleFileSelect(event)">
                <button class="neural-toolbar-btn" onclick="document.getElementById('media-file-input').click()" title="Upload File">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/>
                    </svg>
                </button>
                <button class="neural-toolbar-btn" onclick="toggleEmojiPicker(this, document.getElementById('message-input'))" id="emoji-btn" title="Emojis">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M8 14s1.5 2 4 2 4-2 4-2"/>
                        <line x1="9" y1="9" x2="9.01" y2="9"/>
                        <line x1="15" y1="9" x2="15.01" y2="9"/>
                    </svg>
                </button>
                <button class="neural-toolbar-btn" onclick="toggleStickerPicker(this, handleSendSticker)" id="sticker-btn" title="Stickers">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2a10 10 0 0 1 10 10c0 5.52-4.48 10-10 10S2 17.52 2 12 6.48 2 12 2z"/>
                        <path d="M12 12h10"/>
                        <path d="M12 12v10"/>
                    </svg>
                </button>
                <button class="neural-toolbar-btn voice-record-btn" id="voice-record-btn" onclick="handleVoiceRecord()" title="Voice Message">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
                        <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                        <line x1="12" y1="19" x2="12" y2="23"/>
                        <line x1="8" y1="23" x2="16" y2="23"/>
                    </svg>
                </button>
                <span id="char-count" style="margin-left: auto; font-size: 10px; color: rgba(255,255,255,0.3);">0 chars</span>
            </div>

            <!-- Input Wrapper -->
            <div class="neural-input-wrapper" id="neural-input-wrapper">
                <textarea id="message-input" class="neural-textarea" placeholder="Transmit your message..." onkeydown="handleKeyDown(event)" oninput="updateCharCount()"></textarea>
                <button class="neural-send-btn" onclick="sendMessage()" title="Transmit">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="22" y1="2" x2="11" y2="13"/>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Voice Recording Container -->
        <div id="voice-recording-container" class="hidden" style="padding: 12px;"></div>

        <!-- Status Bar -->
        <div class="neural-statusbar">
            <div class="neural-statusbar-item" id="typing-status">Standing by, Sir</div>
        </div>
    </div>

    <!-- Empty State -->
    <div id="empty-state" class="neural-window neural-main" style="display: flex;">
        <div class="neural-header">
            <div class="neural-header-icon">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                </svg>
            </div>
            <span class="neural-header-title">J.A.R.V.I.S. AI Interface</span>
        </div>
        <div class="neural-empty-state">
            <div class="neural-empty-icon jarvis-arc-reactor">
                <!-- Westworld Orbital Rings -->
                <div class="ww-orbital-ring ring-1"></div>
                <div class="ww-orbital-ring ring-2"></div>
                <div class="ww-orbital-ring ring-3"></div>
                <!-- Arc Reactor Icon -->
                <svg viewBox="0 0 100 100" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="50" cy="50" r="45" stroke="var(--holo-cyan)" stroke-width="2" opacity="0.3"/>
                    <circle cx="50" cy="50" r="35" stroke="var(--holo-cyan)" stroke-width="2" opacity="0.5"/>
                    <circle cx="50" cy="50" r="25" stroke="var(--holo-cyan)" stroke-width="3" opacity="0.7"/>
                    <circle cx="50" cy="50" r="15" fill="var(--holo-cyan)" opacity="0.8"/>
                    <circle cx="50" cy="50" r="8" fill="white"/>
                </svg>
            </div>
            <div class="neural-empty-title">Awaiting Your Command, Sir</div>
            <div class="neural-empty-text">Select a contact to establish a secure J.A.R.V.I.S. connection</div>
            <button class="neural-btn neural-btn-primary" onclick="showNewChatModal()" style="margin-top: 24px;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                </svg>
                Initialize J.A.R.V.I.S. Link
            </button>
        </div>
    </div>
</div>

<!-- New Chat Modal -->
<div id="new-chat-modal" class="neural-modal-overlay">
    <div class="neural-modal" style="width: 400px;">
        <div class="neural-modal-header">
            <span class="neural-modal-title">New Neural Link</span>
            <button class="neural-modal-close" onclick="hideNewChatModal()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        </div>
        <div class="neural-modal-body">
            <div class="neural-form-group">
                <label class="neural-label">Target Identity</label>
                <input type="text" id="contact-search" class="neural-input" placeholder="Search neural network..." oninput="searchUsers(this.value)">
            </div>
            <div style="font-size: 11px; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 8px;">Recent Connections:</div>
            <div id="contact-list" class="neural-new-chat-users">
                <div style="padding: 16px; color: var(--text-muted); text-align: center;">Enter identity to search...</div>
            </div>
        </div>
        <div class="neural-modal-footer">
            <button class="neural-btn neural-btn-secondary" onclick="hideNewChatModal()">Cancel</button>
        </div>
    </div>
</div>

<!-- QR/Friend Code Modal -->
<div id="qr-modal" class="neural-modal-overlay">
    <div class="neural-modal" style="width: 420px;">
        <div class="neural-modal-header">
            <span class="neural-modal-title">Neural ID Exchange</span>
            <button class="neural-modal-close" onclick="hideQRModal()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        </div>
        <div class="neural-modal-body">
            <!-- Tabs -->
            <div class="neural-picker-header" style="padding: 0; margin-bottom: 16px;">
                <button class="neural-picker-tab active" onclick="switchQRTab('my-code')" id="qr-tab-my-code">My Neural ID</button>
                <button class="neural-picker-tab" onclick="switchQRTab('scan')" id="qr-tab-scan">Add Contact</button>
            </div>

            <!-- My Code Tab -->
            <div id="qr-my-code-content">
                <div style="text-align: center; color: var(--text-secondary); margin-bottom: 16px;">
                    Share this quantum signature to allow others to connect:
                </div>
                <div id="qr-code-container" class="neural-qr-container">
                    <div class="neural-qr-code" style="background: #fff; padding: 16px; border-radius: 8px;">
                        Loading...
                    </div>
                </div>
                <div style="text-align: center; margin-top: 16px;">
                    <div id="qr-code-text" style="font-family: 'JetBrains Mono', monospace !important; font-size: 16px; font-weight: bold; color: var(--holo-cyan);"></div>
                </div>
                <div style="display: flex; gap: 12px; justify-content: center; margin-top: 20px;">
                    <button class="neural-btn neural-btn-secondary" onclick="copyFriendCode()">Copy Code</button>
                    <button class="neural-btn neural-btn-secondary" onclick="copyFriendLink()">Copy Link</button>
                </div>
            </div>

            <!-- Add Friend Tab -->
            <div id="qr-scan-content" style="display: none;">
                <div style="color: var(--text-secondary); margin-bottom: 16px;">Enter a neural ID to establish connection:</div>
                <input type="text" id="friend-code-input" class="neural-input" style="text-align: center; font-family: 'JetBrains Mono', monospace !important;" placeholder="MIZU-XXXXXXXX" oninput="this.value = this.value.toUpperCase()">
                <button class="neural-btn neural-btn-primary" onclick="lookupFriendCode()" style="width: 100%; margin-top: 16px;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                        <circle cx="11" cy="11" r="8"/>
                        <path d="m21 21-4.35-4.35"/>
                    </svg>
                    Locate Identity
                </button>
                <div id="friend-code-result" style="margin-top: 16px; display: none;"></div>
            </div>
        </div>
        <div class="neural-modal-footer">
            <button class="neural-btn neural-btn-secondary" onclick="hideQRModal()">Close</button>
        </div>
    </div>
</div>

<!-- Friend Preview Modal -->
<div id="friend-preview-modal" class="neural-modal-overlay">
    <div class="neural-modal" style="width: 340px;">
        <div class="neural-modal-header">
            <span class="neural-modal-title">New Contact</span>
            <button class="neural-modal-close" onclick="hideFriendPreviewModal()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        </div>
        <div class="neural-modal-body" style="text-align: center;">
            <div class="neural-avatar" style="width: 80px; height: 80px; margin: 0 auto 16px;">
                <div class="neural-avatar-ring"></div>
                <div class="neural-avatar-image">
                    <svg viewBox="0 0 48 48">
                        <circle cx="24" cy="18" r="10"/>
                        <ellipse cx="24" cy="42" rx="16" ry="14"/>
                    </svg>
                </div>
            </div>
            <div id="friend-preview-name" style="font-size: 18px; font-weight: 600; color: var(--text-primary);"></div>
            <div id="friend-preview-username" style="color: var(--text-tertiary); margin-top: 4px; font-family: 'JetBrains Mono', monospace !important;"></div>
            <div id="friend-preview-status" style="margin-top: 12px; color: var(--holo-teal); display: flex; align-items: center; justify-content: center; gap: 8px;">
                <span style="width: 8px; height: 8px; border-radius: 50%; background: currentColor;"></span>
                Online
            </div>
        </div>
        <div class="neural-modal-footer" style="justify-content: center;">
            <button class="neural-btn neural-btn-primary" onclick="confirmAddFriend()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                    <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                    <circle cx="9" cy="7" r="4"/>
                    <line x1="19" y1="8" x2="19" y2="14"/>
                    <line x1="16" y1="11" x2="22" y2="11"/>
                </svg>
                Add to Network
            </button>
            <button class="neural-btn neural-btn-secondary" onclick="hideFriendPreviewModal()">Cancel</button>
        </div>
    </div>
</div>

<form id="message-form" style="display: none;"></form>

<!-- Theme Switcher FAB -->
<div id="theme-switcher-fab" class="theme-switcher-fab" title="Switch Theme" style="position: fixed; bottom: 20px; right: 20px; width: 48px; height: 48px; border-radius: 50%; background: var(--glass-bg); border: 1px solid var(--glass-border); cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--holo-cyan); transition: all 0.2s ease; z-index: 1000;">
    <div class="theme-switcher-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
            <circle cx="12" cy="12" r="5"/>
            <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
        </svg>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="/static/js/emoji-data.js"></script>
<script src="/static/js/sticker-data.js"></script>
<script src="/static/js/media.js"></script>
<script>
// App state
let currentUser = null;
let currentChat = null;
let chats = [];
let messages = [];
let ws = null;
let typingTimeout = null;

// Initialize app
document.addEventListener('DOMContentLoaded', async () => {
    await loadCurrentUser();
    await ensureUserChats();
    await loadChats();
    connectWebSocket();

    // Initialize theme switcher
    document.getElementById('theme-switcher-fab').onclick = cycleToNextTheme;

    // Add holographic ripple effect on clicks
    document.addEventListener('click', (e) => {
        if (e.target.closest('.neural-btn, .neural-action-btn, .neural-send-btn, .neural-contact')) {
            createRipple(e);
        }
    });

    // Update data readout periodically
    updateDataReadout();
    setInterval(updateDataReadout, 5000);
});

// Create ripple effect
function createRipple(e) {
    const ripple = document.createElement('div');
    ripple.className = 'jarvis-ripple';
    ripple.style.left = e.clientX + 'px';
    ripple.style.top = e.clientY + 'px';
    document.body.appendChild(ripple);
    setTimeout(() => ripple.remove(), 600);
}

// Update data readout
function updateDataReadout() {
    const readout = document.getElementById('jarvis-readout');
    if (readout) {
        const time = new Date().toLocaleTimeString('en-US', { hour12: false });
        const date = new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        readout.textContent = `${time} // ${date.toUpperCase()}`;
    }
}

// Ensure user has default chats
async function ensureUserChats() {
    try {
        await fetch('/api/v1/users/ensure-chats', { method: 'POST' });
    } catch (err) {
        console.error('Failed to ensure user chats:', err);
    }
}

// Load current user
async function loadCurrentUser() {
    try {
        const res = await fetch('/api/v1/users/me');
        const data = await res.json();
        if (data.success && data.data) {
            currentUser = data.data;
            document.getElementById('user-displayname').textContent = currentUser.display_name || currentUser.username;
        } else {
            window.location.href = '/login';
        }
    } catch (err) {
        console.error('Failed to load user:', err);
        window.location.href = '/login';
    }
}

// Load chats
async function loadChats() {
    try {
        const res = await fetch('/api/v1/chats');
        const data = await res.json();
        if (data.success) {
            chats = data.data || [];
            renderContactList();
        }
    } catch (err) {
        console.error('Failed to load chats:', err);
    }
}

// Render contact list
function renderContactList() {
    const container = document.getElementById('contacts-list');
    const onlineCount = chats.filter(c => c.type === 'direct').length;

    document.querySelector('.online-count').textContent = onlineCount;
    document.querySelector('.total-count').textContent = chats.length;

    if (chats.length === 0) {
        container.innerHTML = '<div style="padding: 16px; color: var(--text-muted); text-align: center; font-style: italic;">No neural links established</div>';
        return;
    }

    container.innerHTML = chats.map(chat => {
        const isSelfChat = chat.type === 'direct' && chat.other_user?.id === currentUser?.id;
        const isAgent = chat.type === 'direct' && chat.other_user?.username === 'mizu-agent';
        const isGroup = chat.type === 'group';

        let name, statusClass, avatarSvg;
        if (isSelfChat) {
            name = 'Personal Log';
            statusClass = 'away';
            // Brain icon for personal log
            avatarSvg = `<svg viewBox="0 0 32 32" fill="currentColor">
                <path d="M16 4C10 4 6 8 6 14c0 4 2 7 5 9v5h10v-5c3-2 5-5 5-9 0-6-4-10-10-10z"/>
                <circle cx="12" cy="12" r="2"/><circle cx="20" cy="12" r="2"/>
            </svg>`;
        } else if (isAgent) {
            name = chat.other_user?.display_name || 'J.A.R.V.I.S. AI';
            statusClass = 'online';
            // AI/Robot icon
            avatarSvg = `<svg viewBox="0 0 32 32" fill="currentColor">
                <rect x="6" y="8" width="20" height="16" rx="3"/>
                <circle cx="12" cy="16" r="3"/><circle cx="20" cy="16" r="3"/>
                <rect x="14" y="4" width="4" height="4"/>
                <line x1="16" y1="0" x2="16" y2="4" stroke="currentColor" stroke-width="2"/>
            </svg>`;
        } else if (isGroup) {
            name = chat.group_name || chat.name;
            statusClass = '';
            // Group/Network icon
            avatarSvg = `<svg viewBox="0 0 32 32" fill="currentColor">
                <circle cx="16" cy="8" r="5"/>
                <circle cx="6" cy="20" r="4"/>
                <circle cx="26" cy="20" r="4"/>
                <circle cx="16" cy="26" r="4"/>
                <line x1="16" y1="13" x2="6" y2="16" stroke="currentColor" stroke-width="1.5"/>
                <line x1="16" y1="13" x2="26" y2="16" stroke="currentColor" stroke-width="1.5"/>
                <line x1="16" y1="13" x2="16" y2="22" stroke="currentColor" stroke-width="1.5"/>
            </svg>`;
        } else {
            name = chat.other_user?.display_name || chat.other_user?.username;
            statusClass = '';
            // Default user icon
            avatarSvg = `<svg viewBox="0 0 32 32">
                <circle cx="16" cy="12" r="7"/>
                <ellipse cx="16" cy="28" rx="11" ry="10"/>
            </svg>`;
        }

        const isActive = currentChat?.id === chat.id;
        const unread = chat.unread_count || 0;

        return `
            <div class="neural-contact ${isActive ? 'active' : ''}" onclick="selectChat('${chat.id}')">
                <div class="neural-contact-avatar ${isAgent ? 'ai-avatar' : ''} ${isGroup ? 'group-avatar' : ''}">
                    ${avatarSvg}
                    <div class="neural-contact-status ${statusClass}"></div>
                </div>
                <div class="neural-contact-info">
                    <div class="neural-contact-name">${escapeHtml(name)}</div>
                    <div class="neural-contact-message">${isAgent ? 'AI Online' : isGroup ? 'Group Channel' : 'Connected'}</div>
                </div>
                ${unread > 0 ? `<span class="neural-contact-badge">${unread}</span>` : ''}
            </div>
        `;
    }).join('');
}

// Filter contacts
function filterContacts(query) {
    const q = query.toLowerCase();
    document.querySelectorAll('.neural-contact').forEach(contact => {
        const name = contact.querySelector('.neural-contact-name').textContent.toLowerCase();
        contact.style.display = name.includes(q) ? 'flex' : 'none';
    });
}

// Toggle category
function toggleCategory(el) {
    el.classList.toggle('collapsed');
    const content = el.nextElementSibling;
    const icon = el.querySelector('.neural-category-icon');
    if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.textContent = '-';
    } else {
        content.style.display = 'none';
        icon.textContent = '+';
    }
}

// Select a chat
async function selectChat(chatId) {
    currentChat = chats.find(c => c.id === chatId);
    if (!currentChat) return;

    document.getElementById('empty-state').style.display = 'none';
    document.getElementById('chat-window').style.display = 'flex';

    const isSelfChat = currentChat.type === 'direct' && currentChat.other_user?.id === currentUser?.id;
    const isAgent = currentChat.type === 'direct' && currentChat.other_user?.username === 'mizu-agent';
    let name;
    if (isSelfChat) {
        name = 'Personal Log';
    } else if (isAgent) {
        name = currentChat.other_user?.display_name || 'AI Assistant';
    } else if (currentChat.type === 'direct') {
        name = currentChat.other_user?.display_name || currentChat.other_user?.username;
    } else {
        name = currentChat.group_name || currentChat.name;
    }

    document.getElementById('chat-title').textContent = 'LINK: ' + name.toUpperCase();
    document.getElementById('chat-contact-name').textContent = name;

    renderContactList();
    await loadMessages(chatId);
    markAsRead(chatId);
}

// Close chat
function closeChat() {
    currentChat = null;
    document.getElementById('chat-window').style.display = 'none';
    document.getElementById('empty-state').style.display = 'flex';
    renderContactList();
}

// Load messages
async function loadMessages(chatId) {
    const container = document.getElementById('messages');
    container.innerHTML = '<div style="padding: 24px; color: var(--text-muted); text-align: center;"><div class="neural-loading"></div><div style="margin-top: 12px;">Synchronizing neural data...</div></div>';

    try {
        const res = await fetch(`/api/v1/chats/${chatId}/messages`);
        const data = await res.json();
        if (data.success) {
            messages = data.data || [];
            renderMessages();
        } else {
            messages = [];
            renderMessages();
        }
    } catch (err) {
        console.error('Failed to load messages:', err);
        messages = [];
        renderMessages();
    }
}

// Render messages
function renderMessages() {
    const container = document.getElementById('messages');
    if (messages.length === 0) {
        container.innerHTML = '<div style="padding: 32px; color: var(--text-muted); text-align: center;"><div style="font-size: 12px; text-transform: uppercase; letter-spacing: 0.15em;">No transmissions</div><div style="margin-top: 8px; font-size: 13px;">Begin neural communication</div></div>';
        return;
    }

    container.innerHTML = messages.map(msg => {
        const isSent = msg.sender_id === currentUser?.id;
        const senderName = isSent ? (currentUser.display_name || currentUser.username) : (msg.sender_name || 'Unknown');
        const time = new Date(msg.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });

        // Check for nudge
        if (msg.content === '[[NUDGE]]') {
            return `<div class="neural-message system"><div class="neural-message-bubble"><div class="neural-message-content">${escapeHtml(senderName)} sent a neural pulse</div></div></div>`;
        }

        // Handle sticker messages
        if (msg.type === 'sticker' && msg.sticker_pack_id && msg.sticker_id) {
            const stickerContent = renderStickerMessage(msg.sticker_pack_id, msg.sticker_id);
            return `
                <div class="neural-message ${isSent ? 'sent' : 'received'}" data-message-id="${msg.id}">
                    <div class="neural-message-bubble">
                        <div class="neural-media-message">${stickerContent}</div>
                        <div class="neural-message-meta">
                            <span class="neural-message-time">${time}</span>
                        </div>
                    </div>
                    ${renderReactions(msg)}
                </div>
            `;
        }

        // Check for media
        const isMedia = msg.media_id || msg.media_url || ['image', 'video', 'audio', 'voice', 'document'].includes(msg.type);
        let contentHtml = '';
        if (isMedia) {
            contentHtml = renderMediaContent(msg);
            if (msg.content) {
                contentHtml += `<div style="margin-top: 8px;">${convertEmoticons(escapeHtml(msg.content))}</div>`;
            }
        } else {
            contentHtml = convertEmoticons(escapeHtml(msg.content));
        }

        return `
            <div class="neural-message ${isSent ? 'sent' : 'received'}" data-message-id="${msg.id}">
                <div class="neural-message-bubble">
                    <div class="neural-message-content">${contentHtml}</div>
                    <div class="neural-message-meta">
                        <span class="neural-message-time">${time}</span>
                    </div>
                </div>
                ${renderReactions(msg)}
            </div>
        `;
    }).join('');

    container.scrollTop = container.scrollHeight;
}

// Render reactions
function renderReactions(msg) {
    if (!Array.isArray(msg.reactions) || msg.reactions.length === 0) return '';

    const reactionCounts = {};
    msg.reactions.forEach(r => {
        if (!reactionCounts[r.emoji]) {
            reactionCounts[r.emoji] = { count: 0, users: [], hasOwn: false };
        }
        reactionCounts[r.emoji].count++;
        reactionCounts[r.emoji].users.push(r.user_id);
        if (r.user_id === currentUser?.id) {
            reactionCounts[r.emoji].hasOwn = true;
        }
    });

    return `<div class="neural-reactions">
        ${Object.entries(reactionCounts).map(([emoji, data]) => `
            <span class="neural-reaction ${data.hasOwn ? 'own' : ''}"
                  onclick="handleReactionClick('${msg.id}', '${emoji}')"
                  title="${data.count} reaction${data.count > 1 ? 's' : ''}">
                ${emoji} ${data.count}
            </span>
        `).join('')}
    </div>`;
}

// Render media content in a message
function renderMediaContent(msg) {
    if (!msg.media_url && !msg.media_id) return '';

    const mediaType = msg.media_type || msg.type;
    const url = msg.media_url || `/api/v1/media/${msg.media_id}/download`;
    const thumbnailUrl = msg.media_thumbnail_url || url;
    const filename = msg.media_filename || 'file';
    const size = msg.media_size || 0;

    switch (mediaType) {
        case 'image':
            const imageMediaObj = JSON.stringify({type: 'image', url: url, original_filename: filename}).replace(/'/g, "\\'");
            return `
                <div class="neural-media neural-image" onclick="window.MediaUpload?.showLightbox([${imageMediaObj}], 0)">
                    <img src="${thumbnailUrl}" alt="${escapeHtml(filename)}" loading="lazy">
                </div>
            `;
        case 'video':
            return `
                <div class="neural-media neural-video">
                    <video controls preload="metadata" poster="${thumbnailUrl}">
                        <source src="${url}" type="${msg.media_content_type || 'video/mp4'}">
                    </video>
                </div>
            `;
        case 'voice':
            const voiceDuration = msg.media_duration || 0;
            const voiceUrl = msg.media_url || `/api/v1/media/${msg.media_id}/stream`;
            const voiceId = msg.media_id || msg.id;
            return renderJarvisVoicePlayer(voiceId, voiceUrl, voiceDuration);
        case 'audio':
            const audioDuration = msg.media_duration || 0;
            const audioUrl = msg.media_url || `/api/v1/media/${msg.media_id}/stream`;
            const audioId = msg.media_id || msg.id;
            return renderJarvisAudioPlayer(audioId, audioUrl, audioDuration, filename);
        case 'document':
        default:
            const sizeStr = formatFileSize(size);
            const ext = filename.split('.').pop().toUpperCase();
            return `
                <div class="neural-media neural-document">
                    <a href="${url}" download="${escapeHtml(filename)}" style="display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(0, 212, 255, 0.1); border: 1px solid rgba(0, 212, 255, 0.3); border-radius: 8px; text-decoration: none; color: inherit;">
                        <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #00D4FF, #0066FF); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; color: #000;">
                            ${ext}
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="color: #00D4FF; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(filename)}</div>
                            <div style="font-size: 11px; color: rgba(0, 212, 255, 0.6);">${sizeStr}</div>
                        </div>
                        <svg style="width: 20px; height: 20px; color: #00D4FF;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                        </svg>
                    </a>
                </div>
            `;
    }
}

// Render Jarvis-style voice player
function renderJarvisVoicePlayer(id, url, duration) {
    const durationStr = formatDuration(duration);
    const waveformBars = generateWaveformBars(20);
    return `
        <div class="jarvis-voice-player" data-audio-id="${id}" data-audio-url="${url}">
            <button class="jarvis-voice-btn" onclick="toggleJarvisAudio('${id}', '${url}')">
                <svg class="play-icon" viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                <svg class="pause-icon" style="display:none" viewBox="0 0 24 24"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>
            </button>
            <div class="jarvis-voice-wave" id="wave-${id}">
                ${waveformBars}
            </div>
            <span class="jarvis-voice-duration" id="time-${id}">${durationStr}</span>
        </div>
        <audio id="audio-${id}" src="${url}" preload="metadata" style="display:none"></audio>
    `;
}

// Render Jarvis-style audio player (for music/audio files)
function renderJarvisAudioPlayer(id, url, duration, filename) {
    const durationStr = formatDuration(duration);
    return `
        <div class="jarvis-audio-player" data-audio-id="${id}" data-audio-url="${url}">
            <button class="jarvis-audio-btn" onclick="toggleJarvisAudio('${id}', '${url}')">
                <svg class="play-icon" viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                <svg class="pause-icon" style="display:none" viewBox="0 0 24 24"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>
            </button>
            <div class="jarvis-audio-waveform">
                <div class="jarvis-audio-progress" onclick="seekJarvisAudio(event, '${id}')">
                    <div class="jarvis-audio-progress-fill" id="progress-${id}"></div>
                </div>
                <div class="jarvis-audio-time">
                    <span id="current-${id}">0:00</span>
                    <span id="duration-${id}">${durationStr}</span>
                </div>
            </div>
            <div class="jarvis-audio-info">
                <span class="jarvis-audio-label">AUDIO</span>
                <span class="jarvis-audio-duration">${durationStr}</span>
            </div>
        </div>
        <audio id="audio-${id}" src="${url}" preload="metadata" style="display:none"></audio>
    `;
}

// Generate waveform bars
function generateWaveformBars(count) {
    let bars = '';
    for (let i = 0; i < count; i++) {
        const height = 20 + Math.random() * 80;
        bars += `<div class="jarvis-voice-wave-bar" style="height: ${height}%"></div>`;
    }
    return bars;
}

// Format duration in mm:ss
function formatDuration(seconds) {
    if (!seconds || seconds === 0) return '0:00';
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs.toString().padStart(2, '0')}`;
}

// Audio playback state
const jarvisAudioPlayers = {};

// Toggle Jarvis audio playback
function toggleJarvisAudio(id, url) {
    let audio = document.getElementById(`audio-${id}`);
    if (!audio) return;

    const player = audio.closest('.jarvis-voice-player, .jarvis-audio-player');
    const playBtn = player?.querySelector('.jarvis-voice-btn, .jarvis-audio-btn');
    const playIcon = playBtn?.querySelector('.play-icon');
    const pauseIcon = playBtn?.querySelector('.pause-icon');

    // Pause all other audio
    document.querySelectorAll('audio').forEach(a => {
        if (a.id !== `audio-${id}` && !a.paused) {
            a.pause();
            const otherId = a.id.replace('audio-', '');
            const otherPlayer = a.closest('.jarvis-voice-player, .jarvis-audio-player');
            if (otherPlayer) {
                otherPlayer.querySelector('.play-icon').style.display = '';
                otherPlayer.querySelector('.pause-icon').style.display = 'none';
                otherPlayer.querySelector('.jarvis-voice-btn, .jarvis-audio-btn')?.classList.remove('playing');
            }
        }
    });

    if (audio.paused) {
        audio.play();
        if (playIcon) playIcon.style.display = 'none';
        if (pauseIcon) pauseIcon.style.display = '';
        playBtn?.classList.add('playing');

        // Update waveform animation for voice
        const waveContainer = document.getElementById(`wave-${id}`);
        if (waveContainer) {
            waveContainer.querySelectorAll('.jarvis-voice-wave-bar').forEach(bar => {
                bar.classList.add('active');
            });
        }

        // Set up progress updates
        if (!jarvisAudioPlayers[id]) {
            jarvisAudioPlayers[id] = true;
            audio.addEventListener('timeupdate', () => updateJarvisProgress(id, audio));
            audio.addEventListener('ended', () => endJarvisAudio(id));
        }
    } else {
        audio.pause();
        if (playIcon) playIcon.style.display = '';
        if (pauseIcon) pauseIcon.style.display = 'none';
        playBtn?.classList.remove('playing');

        // Stop waveform animation
        const waveContainer = document.getElementById(`wave-${id}`);
        if (waveContainer) {
            waveContainer.querySelectorAll('.jarvis-voice-wave-bar').forEach(bar => {
                bar.classList.remove('active');
            });
        }
    }
}

// Update progress bar
function updateJarvisProgress(id, audio) {
    const progress = document.getElementById(`progress-${id}`);
    const currentTime = document.getElementById(`current-${id}`);
    const timeDisplay = document.getElementById(`time-${id}`);

    if (audio.duration) {
        const percent = (audio.currentTime / audio.duration) * 100;
        if (progress) progress.style.width = `${percent}%`;
        if (currentTime) currentTime.textContent = formatDuration(audio.currentTime);
        if (timeDisplay) timeDisplay.textContent = formatDuration(audio.currentTime);
    }
}

// Handle audio ended
function endJarvisAudio(id) {
    const audio = document.getElementById(`audio-${id}`);
    const player = audio?.closest('.jarvis-voice-player, .jarvis-audio-player');
    const playBtn = player?.querySelector('.jarvis-voice-btn, .jarvis-audio-btn');
    const playIcon = playBtn?.querySelector('.play-icon');
    const pauseIcon = playBtn?.querySelector('.pause-icon');

    if (playIcon) playIcon.style.display = '';
    if (pauseIcon) pauseIcon.style.display = 'none';
    playBtn?.classList.remove('playing');

    const progress = document.getElementById(`progress-${id}`);
    if (progress) progress.style.width = '0%';

    const waveContainer = document.getElementById(`wave-${id}`);
    if (waveContainer) {
        waveContainer.querySelectorAll('.jarvis-voice-wave-bar').forEach(bar => {
            bar.classList.remove('active');
        });
    }
}

// Seek audio
function seekJarvisAudio(event, id) {
    const audio = document.getElementById(`audio-${id}`);
    if (!audio || !audio.duration) return;

    const progressBar = event.currentTarget;
    const rect = progressBar.getBoundingClientRect();
    const percent = (event.clientX - rect.left) / rect.width;
    audio.currentTime = percent * audio.duration;
}

// Format file size
function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}

// Handle sending sticker
async function handleSendSticker(packId, stickerId) {
    if (!currentChat) return;

    try {
        const packs = window.STICKER_PACKS || {};
        const pack = packs[packId];
        const sticker = pack?.stickers.find(s => s.id === stickerId);

        const res = await fetch(`/api/v1/chats/${currentChat.id}/messages`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                type: 'sticker',
                content: sticker ? sticker.name : stickerId,
                sticker_pack_id: packId,
                sticker_id: stickerId,
            })
        });

        const data = await res.json();
        if (data.success && data.data) {
            messages.push(data.data);
            renderMessages();
            if (typeof addRecentSticker === 'function') {
                addRecentSticker(packId, stickerId);
            }
        }
    } catch (err) {
        console.error('Failed to send sticker:', err);
    }
}

// Convert emoticons
function convertEmoticons(text) {
    const emoticons = {
        ':)': '&#128522;', ':D': '&#128516;', ';)': '&#128521;',
        ':P': '&#128523;', ':O': '&#128558;', ':(': '&#128532;',
        ':\'(': '&#128546;', 'X(': '&#128544;', ':|': '&#128528;',
        ':*': '&#128536;', 'B)': '&#128526;', 'O:)': '&#128519;',
        '>:)': '&#128520;', '(L)': '&#10084;&#65039;',
        '(Y)': '&#128077;', '(N)': '&#128078;',
    };

    let result = text;
    for (const [code, emoji] of Object.entries(emoticons)) {
        result = result.split(code).join(emoji);
    }
    return result;
}

// Update char count
function updateCharCount() {
    const input = document.getElementById('message-input');
    document.getElementById('char-count').textContent = input.value.length + ' chars';
}

// Mark as read
async function markAsRead(chatId) {
    try {
        await fetch(`/api/v1/chats/${chatId}/read`, { method: 'POST' });
        const chat = chats.find(c => c.id === chatId);
        if (chat) chat.unread_count = 0;
        renderContactList();
    } catch (err) {
        console.error('Failed to mark as read:', err);
    }
}

// Send message
async function sendMessage() {
    const input = document.getElementById('message-input');
    const content = input.value.trim();

    if (!content || !currentChat) return;

    input.value = '';
    document.getElementById('char-count').textContent = '0 chars';

    try {
        const res = await fetch(`/api/v1/chats/${currentChat.id}/messages`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content })
        });

        const data = await res.json();
        if (data.success && data.data) {
            messages.push(data.data);
            renderMessages();
            currentChat.last_message = data.data;
            renderContactList();
        }
    } catch (err) {
        console.error('Failed to send message:', err);
    }
}

// Handle Enter key
function handleKeyDown(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
}

// WebSocket connection
function connectWebSocket() {
    const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
    ws = new WebSocket(`${protocol}//${location.host}/ws`);

    ws.onopen = () => {
        document.getElementById('connection-status').textContent = 'J.A.R.V.I.S. Online - All Systems Operational';
    };

    ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        handleWebSocketMessage(data);
    };

    ws.onclose = () => {
        document.getElementById('connection-status').textContent = 'Re-establishing secure connection...';
        setTimeout(connectWebSocket, 3000);
    };

    ws.onerror = (err) => console.error('WebSocket error:', err);
}

function handleWebSocketMessage(data) {
    switch(data.type) {
        case 'new_message':
            handleNewMessage(data.message);
            break;
        case 'typing':
            handleTyping(data);
            break;
    }
}

function handleNewMessage(message) {
    const chatIndex = chats.findIndex(c => c.id === message.chat_id);
    if (chatIndex !== -1) {
        chats[chatIndex].last_message = message;
        if (currentChat?.id !== message.chat_id) {
            chats[chatIndex].unread_count = (chats[chatIndex].unread_count || 0) + 1;
        }
    }

    if (currentChat?.id === message.chat_id) {
        messages.push(message);
        renderMessages();
    }

    renderContactList();
}

function handleTyping(data) {
    if (currentChat?.id === data.chat_id && data.user_id !== currentUser?.id) {
        const status = document.getElementById('typing-status');
        status.textContent = data.username + ' is composing...';
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
            status.textContent = 'Standing by, Sir';
        }, 3000);
    }
}

// Logout
async function logout() {
    try {
        await fetch('/api/logout', { method: 'POST' });
    } catch (err) {}
    localStorage.removeItem('token');
    localStorage.removeItem('user');
    window.location.href = '/login';
}

// Modal handlers
function showNewChatModal() {
    document.getElementById('new-chat-modal').classList.add('active');
}

function hideNewChatModal() {
    document.getElementById('new-chat-modal').classList.remove('active');
}

function showQRModal() {
    document.getElementById('qr-modal').classList.add('active');
    generateQRCode();
}

function hideQRModal() {
    document.getElementById('qr-modal').classList.remove('active');
}

function hideFriendPreviewModal() {
    document.getElementById('friend-preview-modal').classList.remove('active');
}

function switchQRTab(tab) {
    document.querySelectorAll('.neural-picker-tab').forEach(t => t.classList.remove('active'));
    document.getElementById('qr-tab-' + (tab === 'my-code' ? 'my-code' : 'scan')).classList.add('active');
    document.getElementById('qr-my-code-content').style.display = tab === 'my-code' ? 'block' : 'none';
    document.getElementById('qr-scan-content').style.display = tab === 'scan' ? 'block' : 'none';
}

// QR Code generation
function generateQRCode() {
    if (!currentUser) return;
    const container = document.querySelector('#qr-code-container .neural-qr-code');
    container.innerHTML = '';
    const friendCode = 'MIZU-' + currentUser.id.substring(0, 8).toUpperCase();
    new QRCode(container, {
        text: `${window.location.origin}/add/${friendCode}`,
        width: 180,
        height: 180,
        colorDark: '#0a0a0f',
        colorLight: '#ffffff',
    });
    document.getElementById('qr-code-text').textContent = friendCode;
}

function copyFriendCode() {
    const code = document.getElementById('qr-code-text').textContent;
    navigator.clipboard.writeText(code);
}

function copyFriendLink() {
    const code = document.getElementById('qr-code-text').textContent;
    navigator.clipboard.writeText(`${window.location.origin}/add/${code}`);
}

// Search users
async function searchUsers(query) {
    if (query.length < 2) {
        document.getElementById('contact-list').innerHTML = '<div style="padding: 16px; color: var(--text-muted); text-align: center;">Enter identity to search...</div>';
        return;
    }

    try {
        const res = await fetch(`/api/v1/users/search?q=${encodeURIComponent(query)}`);
        const data = await res.json();
        if (data.success && data.data) {
            const users = data.data.filter(u => u.id !== currentUser?.id);
            if (users.length === 0) {
                document.getElementById('contact-list').innerHTML = '<div style="padding: 16px; color: var(--text-muted); text-align: center;">No identities found</div>';
                return;
            }
            document.getElementById('contact-list').innerHTML = users.map(u => `
                <div class="neural-new-chat-user" onclick="startChatWith('${u.id}')">
                    <div class="neural-contact-avatar" style="width: 40px; height: 40px;">
                        <svg viewBox="0 0 32 32">
                            <circle cx="16" cy="12" r="7"/>
                            <ellipse cx="16" cy="28" rx="11" ry="10"/>
                        </svg>
                    </div>
                    <div class="neural-contact-info">
                        <div class="neural-contact-name">${escapeHtml(u.display_name || u.username)}</div>
                        <div class="neural-contact-message">@${escapeHtml(u.username)}</div>
                    </div>
                </div>
            `).join('');
        }
    } catch (err) {
        console.error('Search failed:', err);
    }
}

// Start chat with user
async function startChatWith(userId) {
    try {
        const res = await fetch('/api/v1/chats', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ type: 'direct', user_id: userId })
        });
        const data = await res.json();
        if (data.success && data.data) {
            hideNewChatModal();
            await loadChats();
            selectChat(data.data.id);
        }
    } catch (err) {
        console.error('Failed to start chat:', err);
    }
}

// Friend code lookup
let pendingFriendUser = null;
async function lookupFriendCode() {
    const code = document.getElementById('friend-code-input').value.trim();
    if (!code) return;

    try {
        const res = await fetch(`/api/v1/users/lookup?code=${encodeURIComponent(code)}`);
        const data = await res.json();
        if (data.success && data.data) {
            pendingFriendUser = data.data;
            document.getElementById('friend-preview-name').textContent = data.data.display_name || data.data.username;
            document.getElementById('friend-preview-username').textContent = '@' + data.data.username;
            hideQRModal();
            document.getElementById('friend-preview-modal').classList.add('active');
        } else {
            document.getElementById('friend-code-result').innerHTML = '<div class="neural-error">Neural ID not found</div>';
            document.getElementById('friend-code-result').style.display = 'block';
        }
    } catch (err) {
        console.error('Lookup failed:', err);
    }
}

async function confirmAddFriend() {
    if (!pendingFriendUser) return;
    await startChatWith(pendingFriendUser.id);
    hideFriendPreviewModal();
    pendingFriendUser = null;
}

// Handle reaction click
async function handleReactionClick(messageId, emoji) {
    if (!currentChat) return;

    const msg = messages.find(m => m.id === messageId);
    const hasOwn = msg?.reactions?.some(r => r.emoji === emoji && r.user_id === currentUser?.id);

    try {
        if (hasOwn) {
            await fetch(`/api/v1/chats/${currentChat.id}/messages/${messageId}/react`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ emoji })
            });
        } else {
            await fetch(`/api/v1/chats/${currentChat.id}/messages/${messageId}/react`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ emoji })
            });
        }
        await loadMessages(currentChat.id);
    } catch (err) {
        console.error('Failed to toggle reaction:', err);
    }
}

// Escape HTML
function escapeHtml(str) {
    if (!str) return '';
    return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

// Show error notification
function showError(message) {
    const errorDiv = document.createElement('div');
    errorDiv.className = 'neural-notification error';
    errorDiv.innerHTML = `<span style="color: #FF4444;"> ${escapeHtml(message)}</span>`;
    errorDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; padding: 12px 20px; background: rgba(255, 68, 68, 0.1); border: 1px solid #FF4444; border-radius: 8px; z-index: 9999; color: #FF4444; font-family: monospace;';
    document.body.appendChild(errorDiv);
    setTimeout(() => errorDiv.remove(), 3000);
}

// =========================================
// Media Upload Features
// =========================================

// Handle file input selection
function handleFileSelect(event) {
    const files = event.target.files;
    if (files && files.length > 0) {
        uploadAndSendMedia(Array.from(files));
    }
    event.target.value = ''; // Reset for next selection
}

// Upload files and send as messages
async function uploadAndSendMedia(files) {
    if (!currentChat) {
        showError('Please select a chat first');
        return;
    }

    for (const file of files) {
        try {
            // Show preview modal
            if (window.MediaUpload && window.MediaUpload.showMediaPreview) {
                const proceed = await new Promise((resolve) => {
                    window.MediaUpload.showMediaPreview(file, async (shouldSend, caption) => {
                        if (shouldSend) {
                            await sendMediaMessage(file, caption);
                        }
                        resolve(shouldSend);
                    });
                });
            } else {
                // Fallback: send directly without preview
                await sendMediaMessage(file, '');
            }
        } catch (err) {
            console.error('Failed to upload media:', err);
            showError('Failed to upload: ' + file.name);
        }
    }
}

// Send a single media message
async function sendMediaMessage(file, caption) {
    if (!currentChat) return;

    try {
        // Upload the file
        const result = await window.MediaUpload.uploadMedia(file, (progress) => {
            console.log('Upload progress:', progress);
        });

        if (result && result.id) {
            // Send message with media attachment
            const res = await fetch(`/api/v1/chats/${currentChat.id}/messages`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    content: caption || '',
                    type: result.type || 'media',
                    media_id: result.id,
                    media_url: result.url,
                    media_type: result.type,
                    media_content_type: result.content_type,
                    media_filename: result.original_filename,
                    media_size: result.size,
                    media_width: result.width,
                    media_height: result.height,
                    media_duration: result.duration,
                    media_thumbnail_url: result.thumbnail_url
                })
            });

            const data = await res.json();
            if (data.success && data.data) {
                messages.push(data.data);
                renderMessages();
                currentChat.last_message = data.data;
                renderContactList();
            }
        }
    } catch (err) {
        console.error('Failed to send media:', err);
        showError('Failed to send media');
    }
}

// Initialize drag-drop for chat view
function initMediaDragDrop() {
    const chatView = document.getElementById('neural-chat-container');
    if (!chatView || !window.MediaUpload) return;

    window.MediaUpload.initDragDrop(chatView, (files) => {
        uploadAndSendMedia(files);
    });
}

// Initialize clipboard paste for message input
function initMediaClipboardPaste() {
    const messageInput = document.getElementById('message-input');
    if (!messageInput || !window.MediaUpload) return;

    window.MediaUpload.initClipboardPaste(messageInput, (files) => {
        uploadAndSendMedia(files);
    });
}

// =========================================
// Voice Recording Features
// =========================================

let isRecordingVoice = false;

// Voice recording state
let voiceRecordingStartTime = null;
let voiceRecordingInterval = null;
let voiceMediaRecorder = null;
let voiceChunks = [];

// Handle voice record button click
function handleVoiceRecord() {
    if (!currentChat) {
        showError('Please select a chat first');
        return;
    }

    if (!navigator.mediaDevices?.getUserMedia) {
        showError('Voice recording is not supported in your browser');
        return;
    }

    if (isRecordingVoice) return;
    startJarvisVoiceRecording();
}

// Start Jarvis-style voice recording
async function startJarvisVoiceRecording() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        voiceMediaRecorder = new MediaRecorder(stream);
        voiceChunks = [];

        voiceMediaRecorder.ondataavailable = (e) => {
            if (e.data.size > 0) voiceChunks.push(e.data);
        };

        voiceMediaRecorder.onstop = async () => {
            stream.getTracks().forEach(track => track.stop());
            if (voiceChunks.length > 0) {
                const blob = new Blob(voiceChunks, { type: 'audio/webm' });
                const duration = (Date.now() - voiceRecordingStartTime) / 1000;
                await sendVoiceMessage(blob, duration);
            }
        };

        voiceMediaRecorder.start();
        isRecordingVoice = true;
        voiceRecordingStartTime = Date.now();

        // Show Jarvis recording UI
        const inputWrapper = document.getElementById('neural-input-wrapper');
        const container = document.getElementById('voice-recording-container');
        if (inputWrapper) inputWrapper.style.display = 'none';
        container.classList.remove('hidden');
        container.innerHTML = `
            <div class="jarvis-recording-ui">
                <div class="jarvis-recording-indicator"></div>
                <span class="jarvis-recording-time" id="recording-time">0:00</span>
                <div class="jarvis-recording-wave">
                    <span></span><span></span><span></span><span></span><span></span><span></span><span></span>
                </div>
                <div class="jarvis-recording-actions">
                    <button class="jarvis-record-cancel" onclick="cancelJarvisRecording()" title="Cancel">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                    <button class="jarvis-record-send" onclick="sendJarvisRecording()" title="Send">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="22" y1="2" x2="11" y2="13"/>
                            <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                        </svg>
                    </button>
                </div>
            </div>
        `;

        // Update recording time
        voiceRecordingInterval = setInterval(() => {
            const elapsed = (Date.now() - voiceRecordingStartTime) / 1000;
            const timeEl = document.getElementById('recording-time');
            if (timeEl) timeEl.textContent = formatDuration(elapsed);
        }, 100);

    } catch (err) {
        console.error('Failed to start recording:', err);
        showError('Could not access microphone');
    }
}

// Cancel voice recording
function cancelJarvisRecording() {
    if (voiceMediaRecorder && voiceMediaRecorder.state !== 'inactive') {
        voiceChunks = []; // Clear chunks so nothing gets sent
        voiceMediaRecorder.stop();
    }
    clearInterval(voiceRecordingInterval);
    isRecordingVoice = false;

    const inputWrapper = document.getElementById('neural-input-wrapper');
    const container = document.getElementById('voice-recording-container');
    if (inputWrapper) inputWrapper.style.display = '';
    container.classList.add('hidden');
    container.innerHTML = '';
}

// Send voice recording
function sendJarvisRecording() {
    if (voiceMediaRecorder && voiceMediaRecorder.state !== 'inactive') {
        voiceMediaRecorder.stop();
    }
    clearInterval(voiceRecordingInterval);
    isRecordingVoice = false;

    const inputWrapper = document.getElementById('neural-input-wrapper');
    const container = document.getElementById('voice-recording-container');
    if (inputWrapper) inputWrapper.style.display = '';
    container.classList.add('hidden');
    container.innerHTML = '';
}

// Send voice message
async function sendVoiceMessage(blob, duration) {
    try {
        // Upload the voice file
        const formData = new FormData();
        formData.append('file', blob, 'voice.webm');
        formData.append('type', 'voice');

        const uploadRes = await fetch('/api/v1/media/upload', {
            method: 'POST',
            body: formData
        });
        const uploadData = await uploadRes.json();

        if (uploadData.success && uploadData.data) {
            const media = uploadData.data;

            // Send message with voice attachment
            const res = await fetch(`/api/v1/chats/${currentChat.id}/messages`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    type: 'voice',
                    content: '',
                    media_id: media.id,
                    media_url: media.url,
                    media_type: 'voice',
                    media_duration: duration
                })
            });

            const data = await res.json();
            if (data.success && data.data) {
                messages.push(data.data);
                renderMessages();
                currentChat.last_message = data.data;
                renderContactList();
            }
        }
    } catch (err) {
        console.error('Failed to send voice message:', err);
        showError('Failed to send voice message');
    }
}

// Initialize media features when DOM is ready
document.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
        initMediaDragDrop();
        initMediaClipboardPaste();
    }, 100);
});
</script>
{{end}}
