{{define "content"}}
<div style="min-height: 100vh; padding: 24px; max-width: 900px; margin: 0 auto;">
    <!-- Header -->
    <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 32px;">
        <a href="/app" class="neural-btn neural-btn-secondary" style="padding: 8px 12px; min-width: auto;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M15 18l-6-6 6-6"/>
            </svg>
        </a>
        <h1 style="font-family: 'Orbitron', sans-serif !important; font-size: 24px; letter-spacing: 0.2em; color: var(--holo-cyan);">SYSTEM CONFIGURATION</h1>
    </div>

    <!-- Profile Section -->
    <div class="neural-window" style="margin-bottom: 24px;">
        <div class="neural-header">
            <div class="neural-header-icon">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                    <circle cx="12" cy="7" r="4"/>
                </svg>
            </div>
            <span class="neural-header-title">Neural Profile</span>
        </div>

        <div style="padding: 24px;">
            <!-- Profile Card -->
            <div class="neural-profile-card">
                <div class="neural-profile-avatar">
                    <div class="neural-profile-avatar-image" id="avatar-preview">
                        <svg viewBox="0 0 48 48">
                            <circle cx="24" cy="18" r="10"/>
                            <ellipse cx="24" cy="42" rx="16" ry="14"/>
                        </svg>
                    </div>
                    <button class="neural-profile-avatar-edit" title="Change Avatar">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                        </svg>
                    </button>
                </div>
                <div class="neural-profile-info">
                    <div class="neural-profile-name" id="profile-display-name"></div>
                    <div class="neural-profile-status">Neural Link Active</div>
                </div>
            </div>

            <!-- Profile Form -->
            <form id="profile-form">
                <div class="neural-form-group">
                    <label class="neural-label" for="display_name">Display Designation</label>
                    <input type="text" id="display_name" name="display_name" class="neural-input" placeholder="Your visible name">
                </div>

                <div class="neural-form-group">
                    <label class="neural-label" for="username">Identity Code</label>
                    <input type="text" id="username" name="username" class="neural-input" placeholder="Your neural ID" readonly style="opacity: 0.6;">
                    <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">Identity code cannot be modified</div>
                </div>

                <div class="neural-form-group">
                    <label class="neural-label" for="email">Communication Address</label>
                    <input type="email" id="email" name="email" class="neural-input" placeholder="neural@network.3000">
                </div>

                <div class="neural-form-group">
                    <label class="neural-label" for="bio">Status Broadcast</label>
                    <textarea id="bio" name="bio" class="neural-textarea" style="min-height: 80px;" placeholder="Share your neural state..."></textarea>
                </div>

                <div id="profile-message" class="hidden" style="margin-bottom: 16px;"></div>

                <button type="submit" class="neural-btn neural-btn-primary" style="width: 100%;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                        <polyline points="17 21 17 13 7 13 7 21"/>
                        <polyline points="7 3 7 8 15 8"/>
                    </svg>
                    Save Configuration
                </button>
            </form>
        </div>
    </div>

    <!-- Appearance Section -->
    <div class="neural-window" style="margin-bottom: 24px;">
        <div class="neural-header">
            <div class="neural-header-icon">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <circle cx="12" cy="12" r="5"/>
                    <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
                </svg>
            </div>
            <span class="neural-header-title">Interface Configuration</span>
        </div>

        <div style="padding: 24px;">
            <div style="margin-bottom: 20px;">
                <div style="font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">Visual Theme</div>
                <div style="font-size: 12px; color: var(--text-tertiary);">Select your preferred interface aesthetic</div>
            </div>

            <!-- Theme Grid -->
            <div class="neural-theme-grid">
                <!-- Modern Dark -->
                <label class="neural-theme-option">
                    <input type="radio" name="theme" value="dark">
                    <div class="neural-theme-preview" style="background: #09090b;">
                        <div style="padding: 6px;">
                            <div style="height: 6px; background: #18181b; border-radius: 3px; margin-bottom: 4px;"></div>
                            <div style="height: 4px; background: #27272a; border-radius: 2px; width: 60%;"></div>
                        </div>
                    </div>
                    <div class="neural-theme-name">Dark Mode</div>
                </label>

                <!-- Modern Light -->
                <label class="neural-theme-option">
                    <input type="radio" name="theme" value="light">
                    <div class="neural-theme-preview" style="background: #ffffff;">
                        <div style="padding: 6px;">
                            <div style="height: 6px; background: #f4f4f5; border-radius: 3px; margin-bottom: 4px;"></div>
                            <div style="height: 4px; background: #e4e4e7; border-radius: 2px; width: 60%;"></div>
                        </div>
                    </div>
                    <div class="neural-theme-name">Light Mode</div>
                </label>

                <!-- J.A.R.V.I.S. -->
                <label class="neural-theme-option">
                    <input type="radio" name="theme" value="jarvis">
                    <div class="neural-theme-preview" style="background: #0a0a0f; border: 1px solid rgba(0, 212, 255, 0.3);">
                        <div style="padding: 6px;">
                            <div style="height: 6px; background: linear-gradient(90deg, #00d4ff, #0066ff); border-radius: 3px; margin-bottom: 4px; opacity: 0.5;"></div>
                            <div style="height: 4px; background: rgba(0, 212, 255, 0.2); border-radius: 2px; width: 60%;"></div>
                        </div>
                    </div>
                    <div class="neural-theme-name">J.A.R.V.I.S.</div>
                </label>

                <!-- AIM 1.0 -->
                <label class="neural-theme-option">
                    <input type="radio" name="theme" value="aim1.0">
                    <div class="neural-theme-preview" style="background: #008080;">
                        <div style="background: #c0c0c0; height: 100%; border: 2px solid; border-color: #dfdfdf #404040 #404040 #dfdfdf;">
                            <div style="height: 10px; background: linear-gradient(90deg, #000080, #1084d0);"></div>
                        </div>
                    </div>
                    <div class="neural-theme-name">AIM 1.0</div>
                </label>

                <!-- Yahoo Messenger -->
                <label class="neural-theme-option">
                    <input type="radio" name="theme" value="ymxp">
                    <div class="neural-theme-preview" style="background: #5C7EC0;">
                        <div style="background: #ECE9D8; height: 100%;">
                            <div style="height: 10px; background: linear-gradient(180deg, #3168D8, #1941A3);"></div>
                        </div>
                    </div>
                    <div class="neural-theme-name">Yahoo! XP</div>
                </label>

                <!-- MSN Messenger -->
                <label class="neural-theme-option">
                    <input type="radio" name="theme" value="msn">
                    <div class="neural-theme-preview" style="background: linear-gradient(180deg, #0a1628, #1c3a50);">
                        <div style="background: rgba(30, 35, 45, 0.9); height: 100%; border-radius: 2px;">
                            <div style="height: 10px; background: linear-gradient(180deg, rgba(60, 65, 75, 0.95), rgba(45, 50, 60, 0.95)); border-radius: 2px 2px 0 0;"></div>
                        </div>
                    </div>
                    <div class="neural-theme-name">MSN Vista</div>
                </label>

                <!-- iMessage -->
                <label class="neural-theme-option">
                    <input type="radio" name="theme" value="im26">
                    <div class="neural-theme-preview" style="background: #f5f5f7;">
                        <div style="padding: 6px;">
                            <div style="display: flex; gap: 2px; margin-bottom: 6px;">
                                <div style="width: 5px; height: 5px; border-radius: 50%; background: #FF5F57;"></div>
                                <div style="width: 5px; height: 5px; border-radius: 50%; background: #FFBD2E;"></div>
                                <div style="width: 5px; height: 5px; border-radius: 50%; background: #28C840;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="neural-theme-name">iMessage</div>
                </label>

                <!-- Mac OS 9 -->
                <label class="neural-theme-option">
                    <input type="radio" name="theme" value="imos9">
                    <div class="neural-theme-preview" style="background: #666699;">
                        <div style="background: #DDDDDD; height: 100%; border: 2px solid; border-color: #FFFFFF #888888 #888888 #FFFFFF;">
                            <div style="height: 10px; background: linear-gradient(180deg, #CCCCCC, #AAAAAA);"></div>
                        </div>
                    </div>
                    <div class="neural-theme-name">Mac OS 9</div>
                </label>

                <!-- Mac OS X -->
                <label class="neural-theme-option">
                    <input type="radio" name="theme" value="imosx">
                    <div class="neural-theme-preview" style="background: linear-gradient(180deg, #a8c0e8, #6e90c0);">
                        <div style="background: rgba(255,255,255,0.9); height: 100%; border-radius: 4px;">
                            <div style="height: 10px; background: linear-gradient(180deg, #e8e8e8, #c0c0c0); border-radius: 4px 4px 0 0;"></div>
                        </div>
                    </div>
                    <div class="neural-theme-name">Mac OS X</div>
                </label>

                <!-- Teams -->
                <label class="neural-theme-option">
                    <input type="radio" name="theme" value="team11">
                    <div class="neural-theme-preview" style="background: #f5f5f5;">
                        <div style="padding: 6px;">
                            <div style="height: 6px; background: #6264A7; border-radius: 3px; margin-bottom: 4px;"></div>
                            <div style="height: 4px; background: #e0e0e0; border-radius: 2px; width: 60%;"></div>
                        </div>
                    </div>
                    <div class="neural-theme-name">Teams</div>
                </label>
            </div>
        </div>
    </div>

    <!-- Security Section -->
    <div class="neural-window" style="margin-bottom: 24px;">
        <div class="neural-header">
            <div class="neural-header-icon">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                    <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                </svg>
            </div>
            <span class="neural-header-title">Security Protocols</span>
        </div>

        <div style="padding: 24px;">
            <div class="neural-settings-row">
                <div class="neural-settings-label">
                    <div class="neural-settings-label-text">Quantum Encryption</div>
                    <div class="neural-settings-label-desc">End-to-end quantum-resistant encryption for all transmissions</div>
                </div>
                <div class="neural-settings-control">
                    <div style="display: flex; align-items: center; gap: 8px; color: var(--holo-teal);">
                        <span style="width: 8px; height: 8px; border-radius: 50%; background: currentColor;"></span>
                        <span style="font-size: 12px; text-transform: uppercase; letter-spacing: 0.1em;">Active</span>
                    </div>
                </div>
            </div>

            <div class="neural-settings-row">
                <div class="neural-settings-label">
                    <div class="neural-settings-label-text">Neural Firewall</div>
                    <div class="neural-settings-label-desc">Advanced threat detection and prevention system</div>
                </div>
                <div class="neural-settings-control">
                    <div style="display: flex; align-items: center; gap: 8px; color: var(--holo-teal);">
                        <span style="width: 8px; height: 8px; border-radius: 50%; background: currentColor;"></span>
                        <span style="font-size: 12px; text-transform: uppercase; letter-spacing: 0.1em;">Enabled</span>
                    </div>
                </div>
            </div>

            <div style="margin-top: 20px;">
                <button type="button" class="neural-btn neural-btn-secondary" style="width: 100%;" onclick="changePassword()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                        <path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/>
                    </svg>
                    Change Access Key
                </button>
            </div>
        </div>
    </div>

    <!-- Danger Zone -->
    <div class="neural-window" style="border-color: var(--holo-orange);">
        <div class="neural-header" style="background: linear-gradient(180deg, rgba(255, 107, 53, 0.1) 0%, transparent 100%);">
            <div class="neural-header-icon" style="background: var(--holo-orange) !important;">
                <svg viewBox="0 0 24 24" fill="currentColor" style="fill: #0a0a0f !important;">
                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                    <line x1="12" y1="9" x2="12" y2="13" stroke="#0a0a0f" stroke-width="2"/>
                    <line x1="12" y1="17" x2="12.01" y2="17" stroke="#0a0a0f" stroke-width="2"/>
                </svg>
            </div>
            <span class="neural-header-title" style="color: var(--holo-orange);">Critical Zone</span>
        </div>

        <div style="padding: 24px;">
            <div class="neural-settings-row" style="border: none;">
                <div class="neural-settings-label">
                    <div class="neural-settings-label-text" style="color: var(--holo-orange);">Terminate Session</div>
                    <div class="neural-settings-label-desc">Disconnect from the neural network and purge local data</div>
                </div>
                <div class="neural-settings-control">
                    <button class="neural-btn neural-btn-danger" onclick="logout()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                            <polyline points="16 17 21 12 16 7"/>
                            <line x1="21" y1="12" x2="9" y2="12"/>
                        </svg>
                        Disconnect
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Load user data on page load
document.addEventListener('DOMContentLoaded', async () => {
    await loadUserProfile();
    initThemeSelector();
});

// Load user profile
async function loadUserProfile() {
    try {
        const res = await fetch('/api/v1/users/me');
        const data = await res.json();
        if (data.success && data.data) {
            const user = data.data;
            document.getElementById('display_name').value = user.display_name || '';
            document.getElementById('username').value = user.username || '';
            document.getElementById('email').value = user.email || '';
            document.getElementById('bio').value = user.bio || '';
            document.getElementById('profile-display-name').textContent = user.display_name || user.username;
        } else {
            window.location.href = '/login';
        }
    } catch (err) {
        console.error('Failed to load profile:', err);
        window.location.href = '/login';
    }
}

// Initialize theme selector
function initThemeSelector() {
    const currentTheme = getTheme();
    const themeInputs = document.querySelectorAll('input[name="theme"]');

    themeInputs.forEach(input => {
        if (input.value === currentTheme) {
            input.checked = true;
            input.closest('.neural-theme-option').classList.add('active');
        }

        input.addEventListener('change', (e) => {
            document.querySelectorAll('.neural-theme-option').forEach(opt => opt.classList.remove('active'));
            e.target.closest('.neural-theme-option').classList.add('active');
            setTheme(e.target.value);
        });
    });
}

// Profile form submission
document.getElementById('profile-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const messageEl = document.getElementById('profile-message');
    messageEl.className = 'hidden';

    const formData = {
        display_name: document.getElementById('display_name').value,
        email: document.getElementById('email').value,
        bio: document.getElementById('bio').value,
    };

    try {
        const res = await fetch('/api/v1/users/me', {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        });

        const data = await res.json();
        if (data.success) {
            messageEl.textContent = 'Configuration saved successfully';
            messageEl.className = 'neural-success';
            document.getElementById('profile-display-name').textContent = formData.display_name;
        } else {
            messageEl.textContent = data.error || 'Failed to save configuration';
            messageEl.className = 'neural-error';
        }
    } catch (err) {
        messageEl.textContent = 'Connection error. Please try again.';
        messageEl.className = 'neural-error';
    }
});

// Change password
function changePassword() {
    alert('Password change functionality coming soon');
}

// Logout
async function logout() {
    if (!confirm('Terminate neural connection?')) return;

    try {
        await fetch('/api/logout', { method: 'POST' });
    } catch (err) {}
    localStorage.removeItem('token');
    localStorage.removeItem('user');
    window.location.href = '/login';
}
</script>
{{end}}
