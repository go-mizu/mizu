{{define "content"}}
<div class="teams-app">
    <!-- Sidebar -->
    <aside id="sidebar" class="teams-sidebar">
        <!-- Header -->
        <div class="teams-sidebar-header">
            <div class="teams-user-info">
                <div id="user-avatar" class="teams-avatar">
                    <span class="teams-presence"></span>
                </div>
                <span id="user-name" class="teams-user-name"></span>
            </div>
            <div class="teams-header-actions">
                <button onclick="showNewChatModal()" class="teams-icon-btn" title="New chat">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                </button>
                <button onclick="showQRModal()" class="teams-icon-btn" title="QR Code">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"/>
                    </svg>
                </button>
                <a href="/settings" class="teams-icon-btn" title="Settings">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                </a>
                <button onclick="logout()" class="teams-icon-btn logout-btn" title="Sign out">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Search -->
        <div class="teams-search">
            <div class="teams-search-wrapper">
                <svg class="teams-search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                </svg>
                <input
                    id="search-input"
                    type="text"
                    class="teams-search-input"
                    placeholder="Search..."
                    oninput="filterChats(this.value)"
                >
            </div>
        </div>

        <!-- Chat List -->
        <div id="chat-list" class="teams-chat-list">
            <!-- Chats will be populated here -->
        </div>
    </aside>

    <!-- Main Content -->
    <main class="teams-main">
        <!-- Empty State -->
        <div id="empty-state" class="teams-empty-state">
            <svg class="teams-empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
            </svg>
            <h2 class="teams-empty-title">Welcome to Teams</h2>
            <p class="teams-empty-description">Select a chat from the sidebar or start a new conversation to get started.</p>
            <div style="display: flex; gap: 12px;">
                <button onclick="showNewChatModal()" class="teams-btn teams-btn-primary">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    New Chat
                </button>
                <button onclick="openSavedMessages()" class="teams-btn teams-btn-secondary">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/>
                    </svg>
                    Saved Messages
                </button>
            </div>
        </div>

        <!-- Chat View (hidden initially) -->
        <div id="chat-view" class="hidden" style="display: flex; flex-direction: column; height: 100%;">
            <!-- Chat Header -->
            <div class="teams-chat-header-bar">
                <div class="teams-chat-info">
                    <button id="back-btn" class="teams-icon-btn teams-back-btn" onclick="closeChat()">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                        </svg>
                    </button>
                    <div id="chat-avatar" class="teams-avatar">
                        <span class="teams-presence"></span>
                    </div>
                    <div>
                        <div id="chat-name" class="teams-chat-title"></div>
                        <div id="chat-status" class="teams-chat-subtitle"></div>
                    </div>
                </div>
                <div class="teams-chat-actions">
                    <button class="teams-icon-btn ui-disabled" title="Voice call (Coming soon)">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                        </svg>
                    </button>
                    <button class="teams-icon-btn ui-disabled" title="Video call (Coming soon)">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                        </svg>
                    </button>
                    <button class="teams-icon-btn ui-disabled" title="More options (Coming soon)">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"/>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Messages Area -->
            <div id="messages" class="teams-messages">
                <!-- Messages will be populated here -->
            </div>

            <!-- Typing Indicator -->
            <div id="typing-indicator" class="teams-typing hidden">
                <span id="typing-users"></span> is typing...
            </div>

            <!-- Compose Area -->
            <div class="teams-compose">
                <form id="message-form" class="teams-compose-container">
                    <input type="file" id="media-file-input" class="hidden" multiple accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.zip" onchange="handleFileSelect(event)">
                    <div class="teams-compose-actions">
                        <button type="button" class="teams-icon-btn" title="Attach file" onclick="document.getElementById('media-file-input').click()">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/>
                            </svg>
                        </button>
                    </div>
                    <div class="teams-compose-input-wrapper">
                        <textarea
                            id="message-input"
                            class="teams-compose-input"
                            rows="1"
                            placeholder="Type a new message"
                            oninput="autoResize(this); sendTyping(); updateVoiceButtonVisibility()"
                            onkeydown="handleKeyDown(event)"
                        ></textarea>
                    </div>
                    <div class="teams-compose-right">
                        <button type="button" class="teams-icon-btn input-emoji-btn" onclick="toggleEmojiPicker(this, document.getElementById('message-input'))" title="Emoji">
                            <span style="font-size: 18px;">ðŸ˜€</span>
                        </button>
                        <button type="button" class="teams-icon-btn input-sticker-btn" onclick="toggleStickerPicker(this, handleSendSticker)" title="Stickers">
                            <span style="font-size: 18px;">ðŸŽ¨</span>
                        </button>
                        <button type="button" id="voice-record-btn" class="teams-icon-btn voice-record-btn" title="Record voice message" onclick="handleVoiceRecord()">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/>
                            </svg>
                        </button>
                        <button type="submit" id="send-btn" class="teams-send-btn hidden">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                            </svg>
                        </button>
                    </div>
                </form>
                <div id="voice-recording-container" class="hidden" style="margin-top: 12px;"></div>
            </div>
        </div>
    </main>
</div>

<!-- New Chat Modal -->
<div id="new-chat-modal" class="teams-modal-overlay hidden">
    <div class="teams-modal">
        <div class="teams-modal-header">
            <h2 class="teams-modal-title">New Chat</h2>
            <button onclick="hideNewChatModal()" class="teams-icon-btn">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <div class="teams-modal-body">
            <!-- Quick Actions -->
            <div style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 16px;">
                <button onclick="hideNewChatModal(); openSavedMessages();" class="teams-btn teams-btn-secondary teams-btn-block" style="justify-content: flex-start; padding: 12px;">
                    <div class="teams-avatar" style="width: 32px; height: 32px; background-color: var(--info);">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/>
                        </svg>
                    </div>
                    <div style="text-align: left;">
                        <div style="font-weight: 600;">Saved Messages</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">Save notes to yourself</div>
                    </div>
                </button>
                <button onclick="showNewGroupModal()" class="teams-btn teams-btn-secondary teams-btn-block" style="justify-content: flex-start; padding: 12px;">
                    <div class="teams-avatar" style="width: 32px; height: 32px; background-color: var(--success);">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                        </svg>
                    </div>
                    <div style="text-align: left;">
                        <div style="font-weight: 600;">New Group</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">Create a group chat</div>
                    </div>
                </button>
            </div>

            <div style="border-top: 1px solid var(--border); padding-top: 16px;">
                <input
                    type="text"
                    id="contact-search"
                    class="teams-input"
                    style="width: 100%; margin-bottom: 12px;"
                    placeholder="Search users..."
                    oninput="searchUsers(this.value)"
                >
                <div id="contact-list" style="max-height: 240px; overflow-y: auto;">
                    <div style="text-align: center; color: var(--text-secondary); padding: 16px;">
                        Type to search for users
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- QR Code Modal -->
<div id="qr-modal" class="teams-modal-overlay hidden">
    <div class="teams-modal">
        <div class="teams-modal-header">
            <h2 class="teams-modal-title">QR Code</h2>
            <button onclick="hideQRModal()" class="teams-icon-btn">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <div class="teams-modal-body">
            <!-- Tabs -->
            <div style="display: flex; border-bottom: 1px solid var(--border); margin-bottom: 16px;">
                <button id="qr-tab-my-code" onclick="switchQRTab('my-code')" style="flex: 1; padding: 12px; border: none; background: none; cursor: pointer; border-bottom: 2px solid var(--teams-brand-primary); color: var(--text-primary); font-weight: 600;">My Code</button>
                <button id="qr-tab-scan" onclick="switchQRTab('scan')" style="flex: 1; padding: 12px; border: none; background: none; cursor: pointer; border-bottom: 2px solid transparent; color: var(--text-secondary);">Add Friend</button>
            </div>

            <!-- My Code Tab -->
            <div id="qr-my-code-content">
                <p style="text-align: center; color: var(--text-secondary); font-size: 14px; margin-bottom: 16px;">Share this QR code to let others add you as a friend</p>
                <div id="qr-code-container" style="background: white; padding: 24px; border-radius: 8px; width: 256px; height: 256px; margin: 0 auto; display: flex; align-items: center; justify-content: center;">
                    <div style="color: var(--text-muted);">Loading...</div>
                </div>
                <p id="qr-code-text" style="text-align: center; font-family: monospace; font-size: 14px; color: var(--text-secondary); margin-top: 12px;"></p>
                <div style="display: flex; gap: 8px; justify-content: center; margin-top: 16px;">
                    <button onclick="copyFriendCode()" class="teams-btn teams-btn-secondary">Copy Code</button>
                    <button onclick="copyFriendLink()" class="teams-btn teams-btn-secondary">Copy Link</button>
                </div>
            </div>

            <!-- Scan/Add Friend Tab -->
            <div id="qr-scan-content" class="hidden">
                <p style="text-align: center; color: var(--text-secondary); font-size: 14px; margin-bottom: 16px;">Enter a friend code to add someone as a friend</p>
                <input
                    type="text"
                    id="friend-code-input"
                    class="teams-input"
                    style="width: 100%; margin-bottom: 12px; text-align: center; font-family: monospace; text-transform: uppercase;"
                    placeholder="Enter friend code (e.g., MIZU-ABCD1234)"
                    oninput="this.value = this.value.toUpperCase()"
                >
                <button onclick="lookupFriendCode()" class="teams-btn teams-btn-primary teams-btn-block">Look Up Code</button>
                <div id="friend-code-result" class="hidden" style="margin-top: 16px;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Friend Preview Modal -->
<div id="friend-preview-modal" class="teams-modal-overlay hidden">
    <div class="teams-modal" style="max-width: 360px; text-align: center;">
        <div class="teams-modal-body" style="padding: 32px;">
            <div id="friend-preview-avatar" class="teams-avatar teams-avatar-xl" style="margin: 0 auto 16px;"></div>
            <h3 id="friend-preview-name" style="font-size: 20px; font-weight: 600; margin-bottom: 4px;"></h3>
            <p id="friend-preview-username" style="color: var(--text-secondary); margin-bottom: 8px;"></p>
            <p id="friend-preview-status" style="font-size: 14px; color: var(--text-muted); margin-bottom: 24px;"></p>
            <div style="display: flex; gap: 12px;">
                <button onclick="hideFriendPreviewModal()" class="teams-btn teams-btn-secondary" style="flex: 1;">Cancel</button>
                <button onclick="confirmAddFriend()" class="teams-btn teams-btn-primary" style="flex: 1;">Add Friend</button>
            </div>
        </div>
    </div>
</div>

<!-- Theme Switcher FAB -->
<div id="theme-switcher-fab" class="theme-switcher-fab" title="Switch Theme">
    <div class="theme-switcher-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="5"/>
            <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
        </svg>
    </div>
    <div class="theme-switcher-tooltip">Theme: <span id="current-theme-name"></span></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="/static/js/emoji-data.js"></script>
<script src="/static/js/sticker-data.js"></script>
<script src="/static/js/media.js"></script>
<script>
// App state
let currentUser = null;
let currentChat = null;
let chats = [];
let messages = [];
let ws = null;
let typingTimeout = null;

// Initialize app
document.addEventListener('DOMContentLoaded', async () => {
    await loadCurrentUser();
    await ensureUserChats();
    await loadChats();
    connectWebSocket();
});

// Ensure user has default chats
async function ensureUserChats() {
    try {
        await fetch('/api/v1/users/ensure-chats', { method: 'POST' });
    } catch (err) {
        console.error('Failed to ensure user chats:', err);
    }
}

// Load current user
async function loadCurrentUser() {
    try {
        const res = await fetch('/api/v1/users/me');
        const data = await res.json();
        if (data.success && data.data) {
            currentUser = data.data;
            document.getElementById('user-name').textContent = currentUser.display_name || currentUser.username;
            document.getElementById('user-avatar').textContent = (currentUser.display_name || currentUser.username).charAt(0).toUpperCase();
        } else {
            window.location.href = '/login';
        }
    } catch (err) {
        console.error('Failed to load user:', err);
        window.location.href = '/login';
    }
}

// Load chats
async function loadChats() {
    const chatList = document.getElementById('chat-list');
    chatList.innerHTML = '<div style="padding: 16px; text-align: center; color: var(--text-muted);">Loading...</div>';

    try {
        const res = await fetch('/api/v1/chats');
        const data = await res.json();
        if (data.success) {
            chats = data.data || [];
            renderChatList();
        } else {
            showError('Failed to load chats');
        }
    } catch (err) {
        console.error('Failed to load chats:', err);
        showError('Failed to load chats');
    }
}

// Show error notification
function showError(message) {
    const errorDiv = document.createElement('div');
    errorDiv.style.cssText = 'position: fixed; top: 16px; right: 16px; background: var(--error); color: white; padding: 12px 16px; border-radius: 4px; z-index: 1000; font-size: 14px;';
    errorDiv.textContent = message;
    document.body.appendChild(errorDiv);
    setTimeout(() => errorDiv.remove(), 3000);
}

// Render chat list
function renderChatList() {
    const chatList = document.getElementById('chat-list');
    if (chats.length === 0) {
        chatList.innerHTML = '<div style="padding: 16px; text-align: center; color: var(--text-muted);">No chats yet. Start a new conversation!</div>';
        return;
    }

    chatList.innerHTML = chats.map(chat => {
        const isSelfChat = chat.type === 'direct' && chat.other_user?.id === currentUser?.id;
        const isAgent = chat.type === 'direct' && chat.other_user?.username === 'mizu-agent';

        let name, avatarContent, avatarStyle;
        if (isSelfChat) {
            name = 'Saved Messages';
            avatarContent = '<svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/></svg>';
            avatarStyle = 'background-color: var(--info);';
        } else if (isAgent) {
            name = chat.other_user?.display_name || 'Mizu Agent';
            avatarContent = '<svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>';
            avatarStyle = 'background-color: #9333EA;';
        } else if (chat.type === 'direct') {
            name = chat.other_user?.display_name || chat.other_user?.username;
            avatarContent = name ? name.charAt(0).toUpperCase() : '?';
            avatarStyle = '';
        } else {
            name = chat.group_name || chat.name;
            avatarContent = name ? name.charAt(0).toUpperCase() : '?';
            avatarStyle = '';
        }

        const lastMsg = chat.last_message;
        const time = lastMsg ? formatTime(lastMsg.created_at) : '';
        const unread = chat.unread_count || 0;
        const isActive = currentChat?.id === chat.id;

        return `
            <div class="teams-chat-item ${isActive ? 'active' : ''}" onclick="selectChat('${chat.id}')">
                <div class="teams-avatar" style="${avatarStyle}">${avatarContent}</div>
                <div class="teams-chat-content">
                    <div class="teams-chat-header">
                        <span class="teams-chat-name">${escapeHtml(name)}</span>
                        <span class="teams-chat-time">${time}</span>
                    </div>
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <span class="teams-chat-preview">${lastMsg ? escapeHtml(lastMsg.content || 'Media') : 'No messages yet'}</span>
                        ${unread > 0 ? `<span class="teams-unread-badge">${unread > 99 ? '99+' : unread}</span>` : ''}
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

// Filter chats
function filterChats(query) {
    const q = query.toLowerCase();
    const items = document.querySelectorAll('.teams-chat-item');
    items.forEach(item => {
        const name = item.querySelector('.teams-chat-name')?.textContent.toLowerCase() || '';
        item.style.display = name.includes(q) ? 'flex' : 'none';
    });
}

// Select a chat
async function selectChat(chatId) {
    currentChat = chats.find(c => c.id === chatId);
    if (!currentChat) return;

    document.getElementById('empty-state').classList.add('hidden');
    document.getElementById('chat-view').classList.remove('hidden');
    document.getElementById('chat-view').style.display = 'flex';

    const isSelfChat = currentChat.type === 'direct' && currentChat.other_user?.id === currentUser?.id;
    const isAgent = currentChat.type === 'direct' && currentChat.other_user?.username === 'mizu-agent';

    let name, status;
    const avatarEl = document.getElementById('chat-avatar');

    if (isSelfChat) {
        name = 'Saved Messages';
        avatarEl.innerHTML = '<svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/></svg>';
        avatarEl.style.backgroundColor = 'var(--info)';
        status = 'Your personal notes';
    } else if (isAgent) {
        name = currentChat.other_user?.display_name || 'Mizu Agent';
        avatarEl.innerHTML = '<svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>';
        avatarEl.style.backgroundColor = '#9333EA';
        status = 'AI Assistant';
    } else if (currentChat.type === 'direct') {
        name = currentChat.other_user?.display_name || currentChat.other_user?.username;
        avatarEl.textContent = name ? name.charAt(0).toUpperCase() : '?';
        avatarEl.style.backgroundColor = '';
        status = 'Online';
    } else {
        name = currentChat.group_name || currentChat.name;
        avatarEl.textContent = name ? name.charAt(0).toUpperCase() : '?';
        avatarEl.style.backgroundColor = '';
        status = `${currentChat.participant_count || 0} members`;
    }

    document.getElementById('chat-name').textContent = name;
    document.getElementById('chat-status').textContent = status;

    renderChatList();
    await loadMessages(chatId);
    markAsRead(chatId);
}

// Open Saved Messages
async function openSavedMessages() {
    const savedChat = chats.find(c => c.type === 'direct' && c.other_user?.id === currentUser?.id);
    if (savedChat) {
        selectChat(savedChat.id);
        return;
    }

    try {
        const res = await fetch('/api/v1/chats', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ type: 'direct', recipient_id: currentUser.id })
        });
        const data = await res.json();
        if (data.success && data.data) {
            await loadChats();
            selectChat(data.data.id);
        }
    } catch (err) {
        console.error('Failed to create saved messages:', err);
    }
}

// Close chat (mobile)
function closeChat() {
    currentChat = null;
    document.getElementById('empty-state').classList.remove('hidden');
    document.getElementById('chat-view').classList.add('hidden');
    renderChatList();
}

// Load messages
async function loadMessages(chatId) {
    const container = document.getElementById('messages');
    container.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%;"><div style="color: var(--text-muted);">Loading messages...</div></div>';

    try {
        const res = await fetch(`/api/v1/chats/${chatId}/messages`);
        const data = await res.json();
        if (data.success) {
            messages = data.data || [];
            renderMessages();
            scrollToBottom();
        } else {
            messages = [];
            renderMessages();
        }
    } catch (err) {
        console.error('Failed to load messages:', err);
        messages = [];
        renderMessages();
    }
}

// Render messages
function renderMessages() {
    const container = document.getElementById('messages');
    if (messages.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 32px;">No messages yet. Start the conversation!</div>';
        return;
    }

    let lastDate = null;
    container.innerHTML = messages.map(msg => {
        const isSent = msg.sender_id === currentUser?.id;
        const msgDate = new Date(msg.created_at).toLocaleDateString();
        let dateHeader = '';

        if (msgDate !== lastDate) {
            lastDate = msgDate;
            dateHeader = `<div class="teams-date-divider"><span>${formatDate(msg.created_at)}</span></div>`;
        }

        const statusClass = msg.status === 'read' ? 'teams-status-read' : msg.status === 'delivered' ? 'teams-status-delivered' : 'teams-status-sent';

        const isSticker = msg.type === 'sticker';
        const isMedia = msg.media_id || msg.media_url || ['image', 'video', 'audio', 'voice', 'document'].includes(msg.type);
        let contentHtml = '';

        if (isSticker && msg.sticker_pack_id && msg.sticker_id) {
            contentHtml = renderStickerMessage(msg.sticker_pack_id, msg.sticker_id);
        } else if (isMedia) {
            contentHtml = renderMediaContent(msg);
            if (msg.content) {
                contentHtml += `<div class="teams-message-text" style="margin-top: 8px;">${escapeHtml(msg.content)}</div>`;
            }
        } else {
            contentHtml = `<div class="teams-message-text">${escapeHtml(msg.content)}</div>`;
        }

        const reactionsHtml = msg.reactions ? renderReactions(msg.reactions, msg.id, currentUser?.id) : '';

        return `
            ${dateHeader}
            <div class="teams-message ${isSent ? 'sent' : 'received'}">
                <div class="teams-message-content message-wrapper" data-message-id="${msg.id}" data-chat-id="${msg.chat_id}">
                    <div class="message-actions">
                        <button class="message-action-btn" onclick="handleReaction('${msg.id}')" title="React">ðŸ˜€</button>
                    </div>
                    <div class="teams-bubble ${isSent ? 'sent' : 'received'} ${isSticker ? 'teams-sticker-message' : ''}">
                        ${!isSent && currentChat?.type === 'group' ? `<div class="teams-message-sender">${escapeHtml(msg.sender_name || 'Unknown')}</div>` : ''}
                        ${contentHtml}
                        <div class="teams-message-meta">
                            <span class="teams-message-time">${formatTime(msg.created_at)}</span>
                            ${isSent ? `<span class="teams-message-status ${statusClass}"></span>` : ''}
                        </div>
                    </div>
                    ${reactionsHtml}
                </div>
            </div>
        `;
    }).join('');

    container.querySelectorAll('.reaction-badge').forEach(badge => {
        badge.addEventListener('click', () => {
            const msgId = badge.dataset.messageId;
            const emoji = badge.dataset.emoji;
            handleReactionClick(msgId, emoji);
        });
    });
}

// Scroll to bottom
function scrollToBottom() {
    const container = document.getElementById('messages');
    container.scrollTop = container.scrollHeight;
}

// Mark as read
async function markAsRead(chatId) {
    try {
        await fetch(`/api/v1/chats/${chatId}/read`, { method: 'POST' });
        const chat = chats.find(c => c.id === chatId);
        if (chat) chat.unread_count = 0;
        renderChatList();
    } catch (err) {
        console.error('Failed to mark as read:', err);
    }
}

// Handle form submission
document.getElementById('message-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const input = document.getElementById('message-input');
    const content = input.value.trim();
    if (!content || !currentChat) return;

    input.value = '';
    autoResize(input);

    try {
        const res = await fetch(`/api/v1/chats/${currentChat.id}/messages`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content })
        });
        const data = await res.json();
        if (data.success && data.data) {
            messages.push(data.data);
            renderMessages();
            scrollToBottom();
            currentChat.last_message = data.data;
            renderChatList();
        }
    } catch (err) {
        console.error('Failed to send message:', err);
    }
});

// Handle key down
function handleKeyDown(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        document.getElementById('message-form').dispatchEvent(new Event('submit'));
    }
}

// Auto resize textarea
function autoResize(el) {
    el.style.height = 'auto';
    el.style.height = Math.min(el.scrollHeight, 200) + 'px';
}

// WebSocket
function connectWebSocket() {
    const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
    ws = new WebSocket(`${protocol}//${location.host}/ws`);

    ws.onopen = () => console.log('WebSocket connected');
    ws.onmessage = (event) => handleWebSocketMessage(JSON.parse(event.data));
    ws.onclose = () => { console.log('WebSocket disconnected'); setTimeout(connectWebSocket, 3000); };
    ws.onerror = (err) => console.error('WebSocket error:', err);
}

function handleWebSocketMessage(data) {
    switch(data.type) {
        case 'new_message': handleNewMessage(data.message); break;
        case 'message_status': handleMessageStatus(data); break;
        case 'typing': handleTyping(data); break;
        case 'presence': handlePresence(data); break;
    }
}

function handleNewMessage(msg) {
    const chat = chats.find(c => c.id === msg.chat_id);
    if (chat) {
        chat.last_message = msg;
        if (currentChat?.id !== msg.chat_id) chat.unread_count = (chat.unread_count || 0) + 1;
        chats = [chat, ...chats.filter(c => c.id !== chat.id)];
        renderChatList();
    }
    if (currentChat?.id === msg.chat_id) {
        messages.push(msg);
        renderMessages();
        scrollToBottom();
        markAsRead(msg.chat_id);
    }
}

function handleMessageStatus(data) {
    if (currentChat?.id === data.chat_id) {
        const msg = messages.find(m => m.id === data.message_id);
        if (msg) { msg.status = data.status; renderMessages(); }
    }
}

function handleTyping(data) {
    if (currentChat?.id === data.chat_id && data.user_id !== currentUser?.id) {
        const indicator = document.getElementById('typing-indicator');
        document.getElementById('typing-users').textContent = data.user_name || 'Someone';
        indicator.classList.remove('hidden');
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => indicator.classList.add('hidden'), 3000);
    }
}

function handlePresence(data) {
    if (currentChat?.type === 'direct' && currentChat?.other_user?.id === data.user_id) {
        document.getElementById('chat-status').textContent = data.online ? 'Online' : 'Offline';
    }
}

let lastTypingSent = 0;
function sendTyping() {
    if (!currentChat || !ws || ws.readyState !== WebSocket.OPEN) return;
    const now = Date.now();
    if (now - lastTypingSent > 2000) {
        lastTypingSent = now;
        ws.send(JSON.stringify({ type: 'typing', chat_id: currentChat.id }));
    }
}

// Modal functions
function showNewChatModal() {
    document.getElementById('new-chat-modal').classList.remove('hidden');
    document.getElementById('contact-search').value = '';
    showRecentContacts();
}

function showRecentContacts() {
    const list = document.getElementById('contact-list');
    const recentUsers = [];
    const seenIds = new Set();

    for (const chat of chats) {
        if (chat.type === 'direct' && chat.other_user && chat.other_user.id !== currentUser?.id && !seenIds.has(chat.other_user.id)) {
            seenIds.add(chat.other_user.id);
            recentUsers.push(chat.other_user);
        }
    }

    if (recentUsers.length === 0) {
        list.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 16px;">Type to search for users</div>';
        return;
    }

    list.innerHTML = '<div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 8px;">Recent</div>' +
        recentUsers.slice(0, 5).map(user => `
            <div class="teams-chat-item" onclick="startChat('${user.id}')">
                <div class="teams-avatar">${(user.display_name || user.username || '?').charAt(0).toUpperCase()}</div>
                <div>
                    <div style="font-weight: 600;">${escapeHtml(user.display_name || user.username)}</div>
                    ${user.display_name ? `<div style="font-size: 12px; color: var(--text-secondary);">@${escapeHtml(user.username)}</div>` : ''}
                </div>
            </div>
        `).join('');
}

function hideNewChatModal() { document.getElementById('new-chat-modal').classList.add('hidden'); }
function showNewGroupModal() { alert('Group creation coming soon!'); }

let searchTimeout = null;
async function searchUsers(query) {
    clearTimeout(searchTimeout);
    const list = document.getElementById('contact-list');
    if (query.trim().length < 2) {
        list.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 16px;">Type to search for users</div>';
        return;
    }
    list.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 16px;">Searching...</div>';
    searchTimeout = setTimeout(async () => {
        try {
            const res = await fetch(`/api/v1/users/search?q=${encodeURIComponent(query)}`);
            const data = await res.json();
            if (data.success) renderUserList(data.data || []);
        } catch (err) {
            list.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 16px;">Search failed</div>';
        }
    }, 300);
}

function renderUserList(users) {
    const list = document.getElementById('contact-list');
    const filtered = users.filter(u => u.id !== currentUser?.id);
    if (filtered.length === 0) {
        list.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 16px;">No users found</div>';
        return;
    }
    list.innerHTML = filtered.map(user => `
        <div class="teams-chat-item" onclick="startChat('${user.id}')">
            <div class="teams-avatar">${(user.display_name || user.username || '?').charAt(0).toUpperCase()}</div>
            <div>
                <div style="font-weight: 600;">${escapeHtml(user.display_name || user.username)}</div>
                ${user.display_name ? `<div style="font-size: 12px; color: var(--text-secondary);">@${escapeHtml(user.username)}</div>` : ''}
            </div>
        </div>
    `).join('');
}

async function startChat(contactId) {
    try {
        const res = await fetch('/api/v1/chats', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ type: 'direct', recipient_id: contactId })
        });
        const data = await res.json();
        if (data.success && data.data) {
            hideNewChatModal();
            if (!chats.find(c => c.id === data.data.id)) chats.unshift(data.data);
            renderChatList();
            selectChat(data.data.id);
        }
    } catch (err) {
        console.error('Failed to create chat:', err);
    }
}

// Utilities
function escapeHtml(str) {
    if (!str) return '';
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

function formatTime(dateStr) {
    return new Date(dateStr).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}

function formatDate(dateStr) {
    const date = new Date(dateStr);
    const today = new Date();
    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);

    if (date.toDateString() === today.toDateString()) return 'Today';
    if (date.toDateString() === yesterday.toDateString()) return 'Yesterday';
    return date.toLocaleDateString([], { weekday: 'long', month: 'short', day: 'numeric' });
}

// QR Code functions
let currentFriendCode = null;
let pendingFriendUser = null;
let pendingFriendCodeToAdd = null;

document.addEventListener('DOMContentLoaded', () => {
    const params = new URLSearchParams(window.location.search);
    const addFriendCode = params.get('add-friend');
    if (addFriendCode) {
        window.history.replaceState({}, document.title, '/app');
        setTimeout(() => processAddFriendCode(addFriendCode), 500);
    }
});

async function processAddFriendCode(code) {
    try {
        const res = await fetch(`/api/v1/friend-code/${encodeURIComponent(code)}`);
        const data = await res.json();
        if (data.success && data.data) {
            pendingFriendUser = data.data;
            pendingFriendCodeToAdd = code;
            showFriendPreviewModal(data.data);
        } else {
            showError(data.error || 'Invalid or expired friend code');
        }
    } catch (err) {
        showError('Failed to process friend code');
    }
}

function showQRModal() {
    document.getElementById('qr-modal').classList.remove('hidden');
    switchQRTab('my-code');
    loadMyFriendCode();
}

function hideQRModal() { document.getElementById('qr-modal').classList.add('hidden'); }

function switchQRTab(tab) {
    const myCodeTab = document.getElementById('qr-tab-my-code');
    const scanTab = document.getElementById('qr-tab-scan');
    const myCodeContent = document.getElementById('qr-my-code-content');
    const scanContent = document.getElementById('qr-scan-content');

    if (tab === 'my-code') {
        myCodeTab.style.borderBottomColor = 'var(--teams-brand-primary)';
        myCodeTab.style.color = 'var(--text-primary)';
        scanTab.style.borderBottomColor = 'transparent';
        scanTab.style.color = 'var(--text-secondary)';
        myCodeContent.classList.remove('hidden');
        scanContent.classList.add('hidden');
    } else {
        scanTab.style.borderBottomColor = 'var(--teams-brand-primary)';
        scanTab.style.color = 'var(--text-primary)';
        myCodeTab.style.borderBottomColor = 'transparent';
        myCodeTab.style.color = 'var(--text-secondary)';
        scanContent.classList.remove('hidden');
        myCodeContent.classList.add('hidden');
        document.getElementById('friend-code-input').focus();
    }
}

async function loadMyFriendCode() {
    const container = document.getElementById('qr-code-container');
    const codeText = document.getElementById('qr-code-text');
    container.innerHTML = '<div style="color: var(--text-muted);">Generating...</div>';
    codeText.textContent = '';

    try {
        const res = await fetch('/api/v1/friend-code');
        const data = await res.json();
        if (data.success && data.data) {
            currentFriendCode = data.data;
            codeText.textContent = data.data.code;
            container.innerHTML = '';
            if (typeof QRCode !== 'undefined') {
                new QRCode(container, { text: data.data.qr_data, width: 200, height: 200, colorDark: '#000000', colorLight: '#ffffff', correctLevel: QRCode.CorrectLevel.M });
            } else {
                container.innerHTML = `<div style="font-family: monospace; font-size: 18px; font-weight: bold;">${escapeHtml(data.data.code)}</div>`;
            }
        } else {
            container.innerHTML = '<div style="color: var(--error);">Failed to generate code</div>';
        }
    } catch (err) {
        container.innerHTML = '<div style="color: var(--error);">Failed to generate code</div>';
    }
}

function copyFriendCode() {
    if (currentFriendCode?.code) {
        navigator.clipboard.writeText(currentFriendCode.code).then(() => showSuccess('Code copied!')).catch(() => showError('Failed to copy'));
    }
}

function copyFriendLink() {
    if (currentFriendCode?.qr_data) {
        const link = currentFriendCode.qr_data.startsWith('http') ? currentFriendCode.qr_data : window.location.origin + currentFriendCode.qr_data;
        navigator.clipboard.writeText(link).then(() => showSuccess('Link copied!')).catch(() => showError('Failed to copy'));
    }
}

async function lookupFriendCode() {
    const code = document.getElementById('friend-code-input').value.trim();
    if (!code) { showError('Please enter a friend code'); return; }
    const resultDiv = document.getElementById('friend-code-result');
    resultDiv.classList.remove('hidden');
    resultDiv.innerHTML = '<div style="text-align: center; color: var(--text-secondary);">Looking up...</div>';

    try {
        const res = await fetch(`/api/v1/friend-code/${encodeURIComponent(code)}`);
        const data = await res.json();
        if (data.success && data.data) {
            pendingFriendUser = data.data;
            pendingFriendCodeToAdd = code;
            hideQRModal();
            showFriendPreviewModal(data.data);
            resultDiv.classList.add('hidden');
            document.getElementById('friend-code-input').value = '';
        } else {
            resultDiv.innerHTML = `<div style="text-align: center; color: var(--error);">${escapeHtml(data.error || 'Invalid code')}</div>`;
        }
    } catch (err) {
        resultDiv.innerHTML = '<div style="text-align: center; color: var(--error);">Failed to look up code</div>';
    }
}

function showFriendPreviewModal(user) {
    document.getElementById('friend-preview-avatar').textContent = (user.display_name || user.username || '?').charAt(0).toUpperCase();
    document.getElementById('friend-preview-name').textContent = user.display_name || user.username;
    document.getElementById('friend-preview-username').textContent = '@' + user.username;
    document.getElementById('friend-preview-status').textContent = user.status || 'No status';
    document.getElementById('friend-preview-modal').classList.remove('hidden');
}

function hideFriendPreviewModal() {
    document.getElementById('friend-preview-modal').classList.add('hidden');
    pendingFriendUser = null;
    pendingFriendCodeToAdd = null;
}

async function confirmAddFriend() {
    if (!pendingFriendCodeToAdd) { showError('No friend code to add'); return; }
    try {
        const res = await fetch(`/api/v1/friend-code/${encodeURIComponent(pendingFriendCodeToAdd)}`, { method: 'POST' });
        const data = await res.json();
        if (data.success) {
            hideFriendPreviewModal();
            showSuccess('Friend added!');
            if (pendingFriendUser?.id) startChat(pendingFriendUser.id);
        } else {
            showError(data.error || 'Failed to add friend');
        }
    } catch (err) {
        showError('Failed to add friend');
    }
}

function showSuccess(message) {
    const div = document.createElement('div');
    div.style.cssText = 'position: fixed; top: 16px; right: 16px; background: var(--success); color: white; padding: 12px 16px; border-radius: 4px; z-index: 1000; font-size: 14px;';
    div.textContent = message;
    document.body.appendChild(div);
    setTimeout(() => div.remove(), 3000);
}

// Sticker & Emoji
async function handleSendSticker(packId, stickerId) {
    if (!currentChat) { showError('Please select a chat first'); return; }
    try {
        const packs = window.STICKER_PACKS || {};
        const pack = packs[packId];
        const sticker = pack?.stickers.find(s => s.id === stickerId);
        const res = await fetch(`/api/v1/chats/${currentChat.id}/messages`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ type: 'sticker', content: sticker ? sticker.name : stickerId, sticker_pack_id: packId, sticker_id: stickerId })
        });
        const data = await res.json();
        if (data.success && data.data) {
            messages.push(data.data);
            renderMessages();
            scrollToBottom();
            currentChat.last_message = data.data;
            renderChatList();
        }
    } catch (err) {
        showError('Failed to send sticker');
    }
}

function handleReaction(messageId) {
    const wrapper = document.querySelector(`[data-message-id="${messageId}"]`);
    if (wrapper) {
        showReactionPicker(wrapper, messageId, async (msgId, emoji) => {
            if (currentChat) {
                const success = await addReaction(currentChat.id, msgId, emoji);
                if (success) {
                    const msg = messages.find(m => m.id === msgId);
                    if (msg) {
                        if (!msg.reactions) msg.reactions = [];
                        const existing = msg.reactions.find(r => r.emoji === emoji);
                        if (existing) { if (!existing.me) { existing.count++; existing.me = true; } }
                        else { msg.reactions.push({ emoji, count: 1, me: true }); }
                        renderMessages();
                    }
                }
            }
        });
    }
}

async function handleReactionClick(messageId, emoji) {
    if (!currentChat) return;
    const msg = messages.find(m => m.id === messageId);
    if (!msg || !msg.reactions) return;
    const reaction = msg.reactions.find(r => r.emoji === emoji);
    if (!reaction) return;

    if (reaction.me) {
        const success = await removeReaction(currentChat.id, messageId);
        if (success) {
            reaction.count--;
            reaction.me = false;
            if (reaction.count <= 0) msg.reactions = msg.reactions.filter(r => r.emoji !== emoji);
            renderMessages();
        }
    } else {
        const success = await addReaction(currentChat.id, messageId, emoji);
        if (success) { reaction.count++; reaction.me = true; renderMessages(); }
    }
}

// Media
function handleFileSelect(event) {
    const files = event.target.files;
    if (files && files.length > 0) uploadAndSendMedia(Array.from(files));
    event.target.value = '';
}

async function uploadAndSendMedia(files) {
    if (!currentChat) { showError('Please select a chat first'); return; }
    for (const file of files) {
        try {
            if (window.MediaUpload && window.MediaUpload.showMediaPreview) {
                await new Promise((resolve) => {
                    window.MediaUpload.showMediaPreview(file, async (shouldSend, caption) => {
                        if (shouldSend) await sendMediaMessage(file, caption);
                        resolve(shouldSend);
                    });
                });
            } else {
                await sendMediaMessage(file, '');
            }
        } catch (err) {
            showError('Failed to upload: ' + file.name);
        }
    }
}

async function sendMediaMessage(file, caption) {
    if (!currentChat) return;
    try {
        const result = await window.MediaUpload.uploadMedia(file);
        if (result && result.id) {
            const res = await fetch(`/api/v1/chats/${currentChat.id}/messages`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    content: caption || '', type: result.type || 'media', media_id: result.id, media_url: result.url,
                    media_type: result.type, media_content_type: result.content_type, media_filename: result.original_filename,
                    media_size: result.size, media_width: result.width, media_height: result.height,
                    media_duration: result.duration, media_thumbnail_url: result.thumbnail_url
                })
            });
            const data = await res.json();
            if (data.success && data.data) {
                messages.push(data.data);
                renderMessages();
                scrollToBottom();
                currentChat.last_message = data.data;
                renderChatList();
            }
        }
    } catch (err) {
        showError('Failed to send media');
    }
}

function renderMediaContent(msg) {
    if (!msg.media_url && !msg.media_id) return '';
    const mediaType = msg.media_type || msg.type;
    const url = msg.media_url || `/api/v1/media/${msg.media_id}/download`;
    const thumbnailUrl = msg.media_thumbnail_url || url;
    const filename = msg.media_filename || 'file';
    const size = msg.media_size || 0;

    switch (mediaType) {
        case 'image':
            return `<div class="teams-media-message"><img src="${thumbnailUrl}" alt="${escapeHtml(filename)}" loading="lazy" style="cursor: pointer;" onclick="window.MediaUpload?.showLightbox([{type: 'image', url: '${url}'}], 0)"></div>`;
        case 'video':
            return `<div class="teams-media-message"><video controls preload="metadata" poster="${thumbnailUrl}"><source src="${url}" type="${msg.media_content_type || 'video/mp4'}"></video></div>`;
        case 'voice':
            if (window.MediaUpload?.renderVoiceMessage) {
                return window.MediaUpload.renderVoiceMessage(msg.media_id, msg.media_url || `/api/v1/media/${msg.media_id}/stream`, msg.media_duration || 0, msg.media_waveform || '[]');
            }
            return `<div class="teams-voice-message"><audio controls src="${url}" preload="metadata"></audio></div>`;
        case 'audio':
            return `<audio controls preload="metadata" style="max-width: 240px;"><source src="${url}" type="${msg.media_content_type || 'audio/mpeg'}"></audio>`;
        default:
            const ext = filename.split('.').pop().toUpperCase();
            return `
                <div class="teams-document-message">
                    <a href="${url}" download="${escapeHtml(filename)}" style="display: flex; align-items: center; gap: 12px; text-decoration: none; color: inherit;">
                        <div class="teams-document-icon">${ext}</div>
                        <div class="teams-document-info">
                            <div class="teams-document-name">${escapeHtml(filename)}</div>
                            <div class="teams-document-size">${formatFileSize(size)}</div>
                        </div>
                    </a>
                </div>
            `;
    }
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}

// Voice
let isRecordingVoice = false;

function updateVoiceButtonVisibility() {
    const input = document.getElementById('message-input');
    const voiceBtn = document.getElementById('voice-record-btn');
    const sendBtn = document.getElementById('send-btn');
    if (!input || !voiceBtn || !sendBtn) return;
    const hasText = input.value.trim().length > 0;
    voiceBtn.classList.toggle('hidden', hasText);
    sendBtn.classList.toggle('hidden', !hasText);
}

function handleVoiceRecord() {
    if (!currentChat) { showError('Please select a chat first'); return; }
    if (!window.MediaUpload?.supportsVoiceRecording()) { showError('Voice recording not supported'); return; }
    if (isRecordingVoice) return;
    isRecordingVoice = true;

    const form = document.getElementById('message-form');
    const container = document.getElementById('voice-recording-container');
    form.classList.add('hidden');
    container.classList.remove('hidden');

    window.MediaUpload.startVoiceRecording(container, async (blob, duration, waveform) => {
        form.classList.remove('hidden');
        container.classList.add('hidden');
        isRecordingVoice = false;

        try {
            const media = await window.MediaUpload.uploadVoiceMessage(blob, duration, waveform);
            const res = await fetch(`/api/v1/chats/${currentChat.id}/messages`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type: 'voice', content: '', media_id: media.id, media_url: media.url, media_type: 'voice', media_duration: duration, media_waveform: JSON.stringify(waveform) })
            });
            const data = await res.json();
            if (data.success && data.data) {
                messages.push(data.data);
                renderMessages();
                scrollToBottom();
                currentChat.last_message = data.data;
                renderChatList();
            }
        } catch (err) {
            showError('Failed to send voice message');
        }
    }, (err) => {
        form.classList.remove('hidden');
        container.classList.add('hidden');
        isRecordingVoice = false;
        if (err?.message) showError(err.message);
    });
}

document.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
        if (window.MediaUpload) {
            const chatView = document.getElementById('chat-view');
            if (chatView) window.MediaUpload.initDragDrop(chatView, uploadAndSendMedia);
            const messageInput = document.getElementById('message-input');
            if (messageInput) window.MediaUpload.initClipboardPaste(messageInput, uploadAndSendMedia);
        }
        updateVoiceButtonVisibility();
    }, 100);
});
</script>
{{end}}
