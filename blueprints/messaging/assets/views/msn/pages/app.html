{{define "content"}}
<div style="display: flex; height: 100vh; padding: 8px; gap: 8px;">
    <!-- Contact List Window -->
    <div id="contact-list-window" class="msn-window" style="width: 260px; display: flex; flex-direction: column;">
        <!-- Title Bar -->
        <div class="msn-titlebar">
            <div class="msn-butterfly"></div>
            <span class="msn-titlebar-text">Windows Live Messenger</span>
            <div class="msn-titlebar-buttons">
                <button class="msn-btn-minimize ui-disabled" title="Minimize (Not available)"></button>
                <button class="msn-btn-maximize ui-disabled" title="Maximize (Not available)"></button>
                <button class="msn-btn-close ui-disabled" title="Close (Not available)"></button>
            </div>
        </div>

        <!-- User Panel -->
        <div class="msn-user-panel">
            <div class="msn-user-avatar">
                <svg viewBox="0 0 48 48" width="44" height="44">
                    <circle cx="24" cy="18" r="10" fill="#606570"/>
                    <ellipse cx="24" cy="42" rx="16" ry="14" fill="#606570"/>
                </svg>
            </div>
            <div class="msn-user-info">
                <div class="msn-user-name" id="user-displayname"></div>
                <div class="msn-user-status-row">
                    <div class="msn-status-orb msn-status-online"></div>
                    <select class="msn-select" id="status-select">
                        <option value="online">Available</option>
                        <option value="busy">Busy</option>
                        <option value="away">Away</option>
                        <option value="invisible">Appear Offline</option>
                    </select>
                </div>
                <div class="msn-personal-message" id="user-status-msg">Share what's on your mind</div>
            </div>
        </div>

        <!-- Search Bar -->
        <div class="msn-search-bar">
            <input type="text" class="msn-search-input" placeholder="Search contacts..." oninput="filterContacts(this.value)">
        </div>

        <!-- Contact List -->
        <div class="msn-contact-list" style="flex: 1; overflow-y: auto;">
            <div id="contact-categories">
                <!-- Favorites -->
                <div class="msn-category" onclick="toggleCategory(this)">
                    <span class="msn-category-icon">-</span>
                    <span>Contacts</span>
                    <span class="msn-category-count">(<span class="online-count">0</span>/<span class="total-count">0</span>)</span>
                </div>
                <div class="msn-category-content" id="contacts-list">
                    <!-- Contacts loaded dynamically -->
                </div>
            </div>
        </div>

        <!-- Action Bar -->
        <div class="msn-action-bar">
            <button class="msn-action-btn" onclick="showNewChatModal()" title="Send an Instant Message">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                </svg>
                <span>Message</span>
            </button>
            <button class="msn-action-btn" onclick="showQRModal()" title="Add a Contact">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                    <circle cx="9" cy="7" r="4"/>
                    <line x1="19" y1="8" x2="19" y2="14"/>
                    <line x1="16" y1="11" x2="22" y2="11"/>
                </svg>
                <span>Add</span>
            </button>
            <button class="msn-action-btn" onclick="window.location.href='/settings'" title="Settings">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"/>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                </svg>
                <span>Settings</span>
            </button>
            <button class="msn-action-btn logout-btn" onclick="logout()" title="Sign Out">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                    <polyline points="16 17 21 12 16 7"/>
                    <line x1="21" y1="12" x2="9" y2="12"/>
                </svg>
                <span>Sign Out</span>
            </button>
        </div>

        <!-- Status Bar -->
        <div class="msn-statusbar">
            <div class="msn-statusbar-panel" id="connection-status">Online</div>
        </div>
    </div>

    <!-- Chat Window (shown when chat selected) -->
    <div id="chat-window" class="msn-window" style="flex: 1; display: none; flex-direction: column; min-height: 0;">
        <!-- Title Bar -->
        <div class="msn-titlebar">
            <div class="msn-butterfly"></div>
            <span class="msn-titlebar-text" id="chat-title">Conversation</span>
            <div class="msn-titlebar-buttons">
                <button class="msn-btn-minimize ui-disabled" title="Minimize (Not available)"></button>
                <button class="msn-btn-maximize ui-disabled" title="Maximize (Not available)"></button>
                <button class="msn-btn-close" onclick="closeChat()" title="Close"></button>
            </div>
        </div>

        <!-- Chat Header -->
        <div class="msn-chat-header">
            <div class="msn-chat-avatar">
                <svg viewBox="0 0 48 48" width="36" height="36">
                    <circle cx="24" cy="18" r="10" fill="#606570"/>
                    <ellipse cx="24" cy="42" rx="16" ry="14" fill="#606570"/>
                </svg>
            </div>
            <div class="msn-chat-info">
                <div class="msn-chat-name" id="chat-contact-name"></div>
                <div class="msn-chat-status">
                    <div class="msn-status-orb msn-status-online" style="width: 8px; height: 8px;"></div>
                    <span id="chat-contact-status">Available</span>
                </div>
            </div>
            <div class="msn-chat-actions">
                <button class="msn-chat-action-btn ui-disabled" title="Voice Call (Coming soon)">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                    </svg>
                </button>
                <button class="msn-chat-action-btn ui-disabled" title="Video Call (Coming soon)">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="23 7 16 12 23 17 23 7"/>
                        <rect x="1" y="5" width="15" height="14" rx="2" ry="2"/>
                    </svg>
                </button>
                <button class="msn-chat-action-btn nudge ui-disabled" onclick="sendNudge()" title="Nudge (Coming soon)">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Message Area -->
        <div class="msn-message-area" id="messages" style="flex: 1; min-height: 0; overflow-y: auto;">
            <!-- Messages will be loaded here -->
        </div>

        <!-- Input Area -->
        <div class="msn-input-area" id="message-input-area">
            <!-- Formatting Toolbar -->
            <div class="msn-format-toolbar">
                <button class="msn-format-btn" title="Bold" style="font-weight: bold;">B</button>
                <button class="msn-format-btn" title="Italic" style="font-style: italic;">I</button>
                <button class="msn-format-btn" title="Underline" style="text-decoration: underline;">U</button>
                <div class="msn-toolbar-separator"></div>
                <select class="msn-select" style="width: 90px; height: 22px; font-size: 10px;">
                    <option>Segoe UI</option>
                    <option>Arial</option>
                    <option>Tahoma</option>
                    <option>Verdana</option>
                </select>
                <select class="msn-select" style="width: 45px; height: 22px; font-size: 10px;">
                    <option>10</option>
                    <option selected>11</option>
                    <option>12</option>
                    <option>14</option>
                </select>
            </div>

            <!-- Text Area -->
            <textarea id="message-input" class="msn-textarea" placeholder="Type a message..." onkeydown="handleKeyDown(event)" oninput="updateCharCount()"></textarea>

            <!-- Bottom Toolbar -->
            <div class="msn-bottom-toolbar">
                <input type="file" id="media-file-input" style="display: none;" multiple accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.zip" onchange="handleFileSelect(event)">
                <div style="display: flex; align-items: center; gap: 4px; position: relative;" id="msn-picker-wrapper">
                    <button class="msn-emoticon-btn" onclick="document.getElementById('media-file-input').click()" title="Send File">
                        <span class="msn-icon">&#128206;</span>
                        <span>File</span>
                    </button>
                    <button class="msn-emoticon-btn" onclick="toggleEmojiPicker(this, document.getElementById('message-input'))" id="emoji-btn" title="Insert Emoticon">
                        <span class="msn-icon">&#128522;</span>
                        <span>Emoticon</span>
                    </button>
                    <button class="msn-emoticon-btn" onclick="toggleStickerPicker(this, handleSendSticker)" id="sticker-btn" title="Send Sticker">
                        <span class="msn-icon">&#127912;</span>
                        <span>Sticker</span>
                    </button>
                    <button class="msn-emoticon-btn voice-record-btn" id="voice-record-btn" onclick="handleVoiceRecord()" title="Record Voice">
                        <span class="msn-icon">&#127908;</span>
                        <span>Voice</span>
                    </button>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span id="char-count" style="font-size: 10px; color: var(--text-muted);">0 chars</span>
                    <button class="msn-button msn-button-primary" onclick="sendMessage()" style="min-width: 70px;">Send</button>
                </div>
            </div>
        </div>

        <!-- Voice Recording UI Container -->
        <div id="voice-recording-container" class="hidden" style="padding: 8px;"></div>

        <!-- Status Bar -->
        <div class="msn-statusbar">
            <div class="msn-statusbar-panel" id="typing-status" style="flex: 2;">Ready</div>
            <div class="msn-statusbar-panel" style="flex: 1; text-align: right;">Windows Live Messenger</div>
        </div>
    </div>

    <!-- Empty State (no chat selected) -->
    <div id="empty-state" class="msn-window" style="flex: 1; display: flex; flex-direction: column;">
        <!-- Title Bar -->
        <div class="msn-titlebar">
            <div class="msn-butterfly"></div>
            <span class="msn-titlebar-text">Windows Live Messenger</span>
            <div class="msn-titlebar-buttons">
                <button class="msn-btn-minimize ui-disabled" title="Minimize"></button>
                <button class="msn-btn-maximize ui-disabled" title="Maximize"></button>
            </div>
        </div>
        <div class="msn-empty-state">
            <div class="msn-empty-state-icon">
                <svg viewBox="0 0 100 100" width="80" height="80">
                    <defs>
                        <linearGradient id="msn-empty-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#7FBA00"/>
                            <stop offset="50%" style="stop-color:#9AD200"/>
                            <stop offset="100%" style="stop-color:#FF8C00"/>
                        </linearGradient>
                    </defs>
                    <ellipse cx="30" cy="35" rx="22" ry="28" fill="url(#msn-empty-gradient)" opacity="0.6"/>
                    <ellipse cx="70" cy="35" rx="22" ry="28" fill="url(#msn-empty-gradient)" opacity="0.6"/>
                    <ellipse cx="28" cy="70" rx="18" ry="20" fill="url(#msn-empty-gradient)" opacity="0.5"/>
                    <ellipse cx="72" cy="70" rx="18" ry="20" fill="url(#msn-empty-gradient)" opacity="0.5"/>
                    <ellipse cx="50" cy="50" rx="6" ry="35" fill="#2a2a2c" opacity="0.6"/>
                    <circle cx="50" cy="18" r="8" fill="#2a2a2c" opacity="0.6"/>
                </svg>
            </div>
            <div class="msn-empty-state-title">Welcome!</div>
            <div class="msn-empty-state-text">Double-click a contact to start chatting</div>
            <button class="msn-button msn-button-primary" onclick="showNewChatModal()">
                Send an Instant Message
            </button>
        </div>
    </div>
</div>

<!-- New Chat Modal -->
<div id="new-chat-modal" class="msn-dialog-overlay" style="display: none;">
    <div class="msn-dialog" style="width: 350px;">
        <div class="msn-titlebar">
            <span class="msn-titlebar-text">Send an Instant Message</span>
            <div class="msn-titlebar-buttons">
                <button class="msn-btn-close" onclick="hideNewChatModal()"></button>
            </div>
        </div>
        <div class="msn-dialog-content">
            <div style="margin-bottom: 12px;">
                <label class="msn-form-label">To:</label>
                <input type="text" id="contact-search" class="msn-input" placeholder="Enter contact name or email" oninput="searchUsers(this.value)">
            </div>
            <div style="margin-bottom: 8px; font-size: 10px; color: var(--text-muted);">Recent Contacts:</div>
            <div id="contact-list" class="msn-listbox" style="height: 150px; overflow-y: auto;">
                <div style="padding: 8px; color: var(--text-muted);">Type to search for contacts...</div>
            </div>
        </div>
        <div class="msn-dialog-buttons">
            <button class="msn-button" onclick="hideNewChatModal()">Cancel</button>
        </div>
    </div>
</div>

<!-- QR/Friend Code Modal -->
<div id="qr-modal" class="msn-dialog-overlay" style="display: none;">
    <div class="msn-dialog" style="width: 380px;">
        <div class="msn-titlebar">
            <span class="msn-titlebar-text">Add a Contact</span>
            <div class="msn-titlebar-buttons">
                <button class="msn-btn-close" onclick="hideQRModal()"></button>
            </div>
        </div>
        <div class="msn-dialog-content">
            <!-- Tabs -->
            <div class="msn-tabs">
                <div class="msn-tab active" onclick="switchQRTab('my-code')" id="qr-tab-my-code">My Code</div>
                <div class="msn-tab" onclick="switchQRTab('scan')" id="qr-tab-scan">Add Friend</div>
            </div>
            <div class="msn-tab-content">
                <!-- My Code Tab -->
                <div id="qr-my-code-content">
                    <div style="text-align: center; margin-bottom: 12px; color: var(--text-secondary);">
                        Share this code to let others add you:
                    </div>
                    <div id="qr-code-container" style="background: #fff; padding: 12px; margin: 0 auto; width: fit-content; border-radius: 4px;">
                        Loading...
                    </div>
                    <div style="text-align: center; margin-top: 12px;">
                        <div id="qr-code-text" style="font-family: 'Consolas', 'Courier New', monospace !important; font-size: 14px; font-weight: bold; color: var(--msn-blue-light);"></div>
                    </div>
                    <div style="margin-top: 16px; display: flex; gap: 8px; justify-content: center;">
                        <button class="msn-button" onclick="copyFriendCode()">Copy Code</button>
                        <button class="msn-button" onclick="copyFriendLink()">Copy Link</button>
                    </div>
                </div>
                <!-- Add Friend Tab -->
                <div id="qr-scan-content" style="display: none;">
                    <div style="margin-bottom: 12px; color: var(--text-secondary);">Enter a friend code to add a contact:</div>
                    <input type="text" id="friend-code-input" class="msn-input" style="text-align: center; font-family: 'Consolas', 'Courier New', monospace !important; font-size: 13px;" placeholder="MIZU-XXXXXXXX" oninput="this.value = this.value.toUpperCase()">
                    <div style="margin-top: 12px;">
                        <button class="msn-button msn-button-primary" onclick="lookupFriendCode()" style="width: 100%;">Find Contact</button>
                    </div>
                    <div id="friend-code-result" style="margin-top: 12px; display: none;"></div>
                </div>
            </div>
        </div>
        <div class="msn-dialog-buttons">
            <button class="msn-button" onclick="hideQRModal()">Close</button>
        </div>
    </div>
</div>

<!-- Friend Preview Modal -->
<div id="friend-preview-modal" class="msn-dialog-overlay" style="display: none;">
    <div class="msn-dialog" style="width: 300px;">
        <div class="msn-titlebar">
            <span class="msn-titlebar-text">Add Contact</span>
            <div class="msn-titlebar-buttons">
                <button class="msn-btn-close" onclick="hideFriendPreviewModal()"></button>
            </div>
        </div>
        <div class="msn-dialog-content" style="text-align: center;">
            <div style="margin-bottom: 12px;">
                <svg viewBox="0 0 64 64" width="64" height="64">
                    <circle cx="32" cy="24" r="14" fill="#606570"/>
                    <ellipse cx="32" cy="56" rx="22" ry="18" fill="#606570"/>
                </svg>
            </div>
            <div id="friend-preview-name" style="font-weight: bold; font-size: 14px; color: var(--text-primary);"></div>
            <div id="friend-preview-username" style="color: var(--text-secondary); margin-top: 4px;"></div>
            <div id="friend-preview-status" style="margin-top: 8px; color: var(--status-online);">Online</div>
        </div>
        <div class="msn-dialog-buttons">
            <button class="msn-button msn-button-primary" onclick="confirmAddFriend()">Add Contact</button>
            <button class="msn-button" onclick="hideFriendPreviewModal()">Cancel</button>
        </div>
    </div>
</div>

<form id="message-form" style="display: none;"></form>

<!-- Theme Switcher FAB -->
<div id="theme-switcher-fab" class="theme-switcher-fab" title="Switch Theme">
    <div class="theme-switcher-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="5"/>
            <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
        </svg>
    </div>
    <div class="theme-switcher-tooltip">Theme: <span id="current-theme-name"></span></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="/static/js/emoji-data.js"></script>
<script src="/static/js/sticker-data.js"></script>
<script src="/static/js/media.js"></script>
<script>
// App state
let currentUser = null;
let currentChat = null;
let chats = [];
let messages = [];
let ws = null;
let typingTimeout = null;

// Initialize app
document.addEventListener('DOMContentLoaded', async () => {
    await loadCurrentUser();
    await ensureUserChats();
    await loadChats();
    connectWebSocket();
});

// Ensure user has default chats
async function ensureUserChats() {
    try {
        await fetch('/api/v1/users/ensure-chats', { method: 'POST' });
    } catch (err) {
        console.error('Failed to ensure user chats:', err);
    }
}

// Load current user
async function loadCurrentUser() {
    try {
        const res = await fetch('/api/v1/users/me');
        const data = await res.json();
        if (data.success && data.data) {
            currentUser = data.data;
            document.getElementById('user-displayname').textContent = currentUser.display_name || currentUser.username;
        } else {
            window.location.href = '/login';
        }
    } catch (err) {
        console.error('Failed to load user:', err);
        window.location.href = '/login';
    }
}

// Load chats
async function loadChats() {
    try {
        const res = await fetch('/api/v1/chats');
        const data = await res.json();
        if (data.success) {
            chats = data.data || [];
            renderContactList();
        }
    } catch (err) {
        console.error('Failed to load chats:', err);
    }
}

// Render contact list
function renderContactList() {
    const container = document.getElementById('contacts-list');
    const onlineCount = chats.filter(c => c.type === 'direct').length;

    document.querySelector('.online-count').textContent = onlineCount;
    document.querySelector('.total-count').textContent = chats.length;

    if (chats.length === 0) {
        container.innerHTML = '<div style="padding: 8px 24px; color: var(--text-muted); font-style: italic;">No contacts yet</div>';
        return;
    }

    container.innerHTML = chats.map(chat => {
        const isSelfChat = chat.type === 'direct' && chat.other_user?.id === currentUser?.id;
        const isAgent = chat.type === 'direct' && chat.other_user?.username === 'mizu-agent';

        let name, statusClass;
        if (isSelfChat) {
            name = 'Notes (Me)';
            statusClass = 'msn-status-away';
        } else if (isAgent) {
            name = chat.other_user?.display_name || 'Messenger Assistant';
            statusClass = 'msn-status-online';
        } else if (chat.type === 'direct') {
            name = chat.other_user?.display_name || chat.other_user?.username;
            statusClass = 'msn-status-online';
        } else {
            name = chat.group_name || chat.name;
            statusClass = 'msn-status-online';
        }

        const isActive = currentChat?.id === chat.id;
        const unread = chat.unread_count || 0;

        return `
            <div class="msn-contact ${isActive ? 'selected' : ''}" ondblclick="selectChat('${chat.id}')">
                <div class="msn-contact-avatar">
                    <svg viewBox="0 0 32 32" width="28" height="28">
                        <circle cx="16" cy="12" r="7" fill="#606570"/>
                        <ellipse cx="16" cy="28" rx="11" ry="10" fill="#606570"/>
                    </svg>
                    <div class="msn-contact-status-indicator ${statusClass}"></div>
                </div>
                <div class="msn-contact-info">
                    <div class="msn-contact-name">${escapeHtml(name)}</div>
                    <div class="msn-contact-status-text">Available</div>
                </div>
                ${unread > 0 ? `<span class="msn-contact-unread">${unread}</span>` : ''}
            </div>
        `;
    }).join('');
}

// Filter contacts
function filterContacts(query) {
    const q = query.toLowerCase();
    document.querySelectorAll('.msn-contact').forEach(contact => {
        const name = contact.querySelector('.msn-contact-name').textContent.toLowerCase();
        contact.style.display = name.includes(q) ? 'flex' : 'none';
    });
}

// Toggle category expand/collapse
function toggleCategory(el) {
    const icon = el.querySelector('.msn-category-icon');
    const content = el.nextElementSibling;
    if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.textContent = '-';
    } else {
        content.style.display = 'none';
        icon.textContent = '+';
    }
}

// Select a chat
async function selectChat(chatId) {
    currentChat = chats.find(c => c.id === chatId);
    if (!currentChat) return;

    // Show chat window, hide empty state
    document.getElementById('empty-state').style.display = 'none';
    document.getElementById('chat-window').style.display = 'flex';

    // Update title and header
    const isSelfChat = currentChat.type === 'direct' && currentChat.other_user?.id === currentUser?.id;
    const isAgent = currentChat.type === 'direct' && currentChat.other_user?.username === 'mizu-agent';
    let name;
    if (isSelfChat) {
        name = 'Notes (Me)';
    } else if (isAgent) {
        name = currentChat.other_user?.display_name || 'Messenger Assistant';
    } else if (currentChat.type === 'direct') {
        name = currentChat.other_user?.display_name || currentChat.other_user?.username;
    } else {
        name = currentChat.group_name || currentChat.name;
    }

    document.getElementById('chat-title').textContent = name + ' - Conversation';
    document.getElementById('chat-contact-name').textContent = name;

    renderContactList();
    await loadMessages(chatId);
    markAsRead(chatId);
}

// Close chat
function closeChat() {
    currentChat = null;
    document.getElementById('chat-window').style.display = 'none';
    document.getElementById('empty-state').style.display = 'flex';
    renderContactList();
}

// Load messages
async function loadMessages(chatId) {
    const container = document.getElementById('messages');
    container.innerHTML = '<div style="padding: 16px; color: var(--text-muted); text-align: center;">Loading messages...</div>';

    try {
        const res = await fetch(`/api/v1/chats/${chatId}/messages`);
        const data = await res.json();
        if (data.success) {
            messages = data.data || [];
            renderMessages();
        } else {
            messages = [];
            renderMessages();
        }
    } catch (err) {
        console.error('Failed to load messages:', err);
        messages = [];
        renderMessages();
    }
}

// Render messages
function renderMessages() {
    const container = document.getElementById('messages');
    if (messages.length === 0) {
        container.innerHTML = '<div style="padding: 24px; color: var(--text-muted); text-align: center; font-style: italic;">No messages yet. Say hello!</div>';
        return;
    }

    container.innerHTML = messages.map(msg => {
        const isSent = msg.sender_id === currentUser?.id;
        const senderName = isSent ? (currentUser.display_name || currentUser.username) : (msg.sender_name || 'Unknown');
        const time = new Date(msg.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

        // Check for nudge
        if (msg.content === '[[NUDGE]]') {
            return `<div class="msn-nudge-message">&#128276; ${escapeHtml(senderName)} sent you a Nudge!</div>`;
        }

        // Handle sticker messages
        if (msg.type === 'sticker' && msg.sticker_pack_id && msg.sticker_id) {
            const stickerContent = renderStickerMessage(msg.sticker_pack_id, msg.sticker_id);
            return `
                <div class="msn-message ${isSent ? 'sent' : 'received'}" data-message-id="${msg.id}">
                    <div class="msn-message-header ${isSent ? 'sent' : 'received'}">
                        ${escapeHtml(senderName)} <span class="msn-message-time">(${time})</span>
                    </div>
                    <div class="msn-message-sticker">${stickerContent}</div>
                    ${renderReactions(msg)}
                    <div class="msn-message-actions">
                        <button class="msn-react-btn" onclick="showReactionPicker(event, '${msg.id}')" title="React">&#128522;</button>
                    </div>
                </div>
            `;
        }

        // Check if it's a media message
        const isMedia = msg.media_id || msg.media_url || ['image', 'video', 'audio', 'voice', 'document'].includes(msg.type);
        let contentHtml = '';
        if (isMedia) {
            contentHtml = renderMediaContent(msg);
            if (msg.content) {
                contentHtml += `<div style="margin-top: 8px;">${convertEmoticons(escapeHtml(msg.content))}</div>`;
            }
        } else {
            contentHtml = convertEmoticons(escapeHtml(msg.content));
        }

        return `
            <div class="msn-message ${isSent ? 'sent' : 'received'}" data-message-id="${msg.id}">
                <div class="msn-message-header ${isSent ? 'sent' : 'received'}">
                    ${escapeHtml(senderName)} <span class="msn-message-time">(${time})</span>
                </div>
                <div class="msn-message-content">${contentHtml}</div>
                ${renderReactions(msg)}
                <div class="msn-message-actions">
                    <button class="msn-react-btn" onclick="showReactionPicker(event, '${msg.id}')" title="React">&#128522;</button>
                </div>
            </div>
        `;
    }).join('');

    container.scrollTop = container.scrollHeight;
}

// Render reactions for a message
function renderReactions(msg) {
    if (!Array.isArray(msg.reactions) || msg.reactions.length === 0) return '';

    const reactionCounts = {};
    msg.reactions.forEach(r => {
        if (!reactionCounts[r.emoji]) {
            reactionCounts[r.emoji] = { count: 0, users: [], hasOwn: false };
        }
        reactionCounts[r.emoji].count++;
        reactionCounts[r.emoji].users.push(r.user_id);
        if (r.user_id === currentUser?.id) {
            reactionCounts[r.emoji].hasOwn = true;
        }
    });

    return `<div class="msn-message-reactions">
        ${Object.entries(reactionCounts).map(([emoji, data]) => `
            <span class="msn-reaction-badge ${data.hasOwn ? 'own' : ''}"
                  onclick="handleReactionClick('${msg.id}', '${emoji}')"
                  title="${data.count} reaction${data.count > 1 ? 's' : ''}">
                ${emoji} ${data.count}
            </span>
        `).join('')}
    </div>`;
}

// Show reaction picker
let activeReactionPicker = null;
function showReactionPicker(event, messageId) {
    event.stopPropagation();
    closeReactionPicker();

    const quickReactions = typeof QUICK_REACTIONS !== 'undefined' ? QUICK_REACTIONS : ['ðŸ‘', 'â¤ï¸', 'ðŸ˜‚', 'ðŸ˜®', 'ðŸ˜¢', 'ðŸ™'];

    const picker = document.createElement('div');
    picker.className = 'msn-reaction-picker';
    picker.innerHTML = quickReactions.map(emoji =>
        `<span class="msn-reaction-option" onclick="handleReaction('${messageId}', '${emoji}')">${emoji}</span>`
    ).join('');

    const btn = event.target.closest('.msn-react-btn');
    btn.parentElement.appendChild(picker);
    activeReactionPicker = picker;

    setTimeout(() => {
        document.addEventListener('click', closeReactionPicker, { once: true });
    }, 0);
}

function closeReactionPicker() {
    if (activeReactionPicker) {
        activeReactionPicker.remove();
        activeReactionPicker = null;
    }
}

// Handle adding a reaction
async function handleReaction(messageId, emoji) {
    closeReactionPicker();
    if (!currentChat) return;

    try {
        await fetch(`/api/v1/chats/${currentChat.id}/messages/${messageId}/react`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ emoji })
        });
        await loadMessages(currentChat.id);
    } catch (err) {
        console.error('Failed to add reaction:', err);
    }
}

// Handle clicking on a reaction (toggle)
async function handleReactionClick(messageId, emoji) {
    if (!currentChat) return;

    const msg = messages.find(m => m.id === messageId);
    const hasOwn = msg?.reactions?.some(r => r.emoji === emoji && r.user_id === currentUser?.id);

    try {
        if (hasOwn) {
            await fetch(`/api/v1/chats/${currentChat.id}/messages/${messageId}/react`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ emoji })
            });
        } else {
            await fetch(`/api/v1/chats/${currentChat.id}/messages/${messageId}/react`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ emoji })
            });
        }
        await loadMessages(currentChat.id);
    } catch (err) {
        console.error('Failed to toggle reaction:', err);
    }
}

// Handle sending a sticker
async function handleSendSticker(packId, stickerId) {
    if (!currentChat) return;

    try {
        const packs = window.STICKER_PACKS || {};
        const pack = packs[packId];
        const sticker = pack?.stickers.find(s => s.id === stickerId);

        const res = await fetch(`/api/v1/chats/${currentChat.id}/messages`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                type: 'sticker',
                content: sticker ? sticker.name : stickerId,
                sticker_pack_id: packId,
                sticker_id: stickerId,
            })
        });

        const data = await res.json();
        if (data.success && data.data) {
            messages.push(data.data);
            renderMessages();
            if (typeof addRecentSticker === 'function') {
                addRecentSticker(packId, stickerId);
            }
        }
    } catch (err) {
        console.error('Failed to send sticker:', err);
    }
}

// Convert emoticons to emoji
function convertEmoticons(text) {
    const emoticons = {
        ':)': '&#128522;',
        ':D': '&#128516;',
        ';)': '&#128521;',
        ':P': '&#128523;',
        ':O': '&#128558;',
        ':(': '&#128532;',
        ':\'(': '&#128546;',
        'X(': '&#128544;',
        ':|': '&#128528;',
        ':*': '&#128536;',
        'B)': '&#128526;',
        'O:)': '&#128519;',
        '>:)': '&#128520;',
        '(L)': '&#10084;&#65039;',
        '(Y)': '&#128077;',
        '(N)': '&#128078;',
    };

    let result = text;
    for (const [code, emoji] of Object.entries(emoticons)) {
        result = result.split(code).join(emoji);
    }
    return result;
}

// Update char count
function updateCharCount() {
    const input = document.getElementById('message-input');
    document.getElementById('char-count').textContent = input.value.length + ' chars';
}

// Mark as read
async function markAsRead(chatId) {
    try {
        await fetch(`/api/v1/chats/${chatId}/read`, { method: 'POST' });
        const chat = chats.find(c => c.id === chatId);
        if (chat) chat.unread_count = 0;
        renderContactList();
    } catch (err) {
        console.error('Failed to mark as read:', err);
    }
}

// Send message
async function sendMessage() {
    const input = document.getElementById('message-input');
    const content = input.value.trim();

    if (!content || !currentChat) return;

    input.value = '';
    document.getElementById('char-count').textContent = '0 chars';

    try {
        const res = await fetch(`/api/v1/chats/${currentChat.id}/messages`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content })
        });

        const data = await res.json();
        if (data.success && data.data) {
            messages.push(data.data);
            renderMessages();
            currentChat.last_message = data.data;
            renderContactList();
        }
    } catch (err) {
        console.error('Failed to send message:', err);
    }
}

// Handle Enter key
function handleKeyDown(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
}

// Send Nudge
async function sendNudge() {
    if (!currentChat) return;

    // Trigger local nudge animation
    const chatWindow = document.getElementById('chat-window');
    chatWindow.classList.add('msn-nudge-active');
    setTimeout(() => chatWindow.classList.remove('msn-nudge-active'), 500);

    // Send nudge message
    try {
        await fetch(`/api/v1/chats/${currentChat.id}/messages`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content: '[[NUDGE]]' })
        });
        await loadMessages(currentChat.id);
    } catch (err) {
        console.error('Failed to send nudge:', err);
    }
}

// WebSocket connection
function connectWebSocket() {
    const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
    ws = new WebSocket(`${protocol}//${location.host}/ws`);

    ws.onopen = () => {
        document.getElementById('connection-status').textContent = 'Online';
    };

    ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        handleWebSocketMessage(data);
    };

    ws.onclose = () => {
        document.getElementById('connection-status').textContent = 'Reconnecting...';
        setTimeout(connectWebSocket, 3000);
    };

    ws.onerror = (err) => console.error('WebSocket error:', err);
}

function handleWebSocketMessage(data) {
    switch(data.type) {
        case 'new_message':
            handleNewMessage(data.message);
            break;
        case 'typing':
            handleTyping(data);
            break;
    }
}

function handleNewMessage(msg) {
    const chat = chats.find(c => c.id === msg.chat_id);
    if (chat) {
        chat.last_message = msg;
        if (currentChat?.id !== msg.chat_id) {
            chat.unread_count = (chat.unread_count || 0) + 1;
        }
        chats = [chat, ...chats.filter(c => c.id !== chat.id)];
        renderContactList();
    }

    if (currentChat?.id === msg.chat_id) {
        messages.push(msg);
        renderMessages();
        markAsRead(msg.chat_id);

        // Check for nudge
        if (msg.content === '[[NUDGE]]' && msg.sender_id !== currentUser?.id) {
            const chatWindow = document.getElementById('chat-window');
            chatWindow.classList.add('msn-nudge-active');
            setTimeout(() => chatWindow.classList.remove('msn-nudge-active'), 500);
        }
    }
}

function handleTyping(data) {
    if (currentChat?.id === data.chat_id && data.user_id !== currentUser?.id) {
        document.getElementById('typing-status').textContent = (data.user_name || 'User') + ' is typing...';
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
            document.getElementById('typing-status').textContent = 'Ready';
        }, 3000);
    }
}

// Modal functions
function showNewChatModal() {
    document.getElementById('new-chat-modal').style.display = 'flex';
    document.getElementById('contact-search').value = '';
    document.getElementById('contact-search').focus();
    showRecentContacts();
}

function hideNewChatModal() {
    document.getElementById('new-chat-modal').style.display = 'none';
}

function showRecentContacts() {
    const list = document.getElementById('contact-list');
    const recentUsers = [];
    const seenIds = new Set();

    for (const chat of chats) {
        if (chat.type === 'direct' && chat.other_user) {
            const user = chat.other_user;
            if (user.id !== currentUser?.id && !seenIds.has(user.id)) {
                seenIds.add(user.id);
                recentUsers.push(user);
            }
        }
    }

    if (recentUsers.length === 0) {
        list.innerHTML = '<div style="padding: 8px; color: var(--text-muted);">Type to search for contacts...</div>';
        return;
    }

    list.innerHTML = recentUsers.slice(0, 5).map(user => `
        <div class="msn-listbox-item" ondblclick="startChat('${user.id}')">
            ${escapeHtml(user.display_name || user.username)}
        </div>
    `).join('');
}

let searchTimeout = null;
async function searchUsers(query) {
    clearTimeout(searchTimeout);
    const list = document.getElementById('contact-list');

    if (query.trim().length < 2) {
        showRecentContacts();
        return;
    }

    list.innerHTML = '<div style="padding: 8px; color: var(--text-muted);">Searching...</div>';

    searchTimeout = setTimeout(async () => {
        try {
            const res = await fetch(`/api/v1/users/search?q=${encodeURIComponent(query)}`);
            const data = await res.json();
            if (data.success) {
                const users = (data.data || []).filter(u => u.id !== currentUser?.id);
                if (users.length === 0) {
                    list.innerHTML = '<div style="padding: 8px; color: var(--text-muted);">No contacts found</div>';
                } else {
                    list.innerHTML = users.map(user => `
                        <div class="msn-listbox-item" ondblclick="startChat('${user.id}')">
                            ${escapeHtml(user.display_name || user.username)}
                        </div>
                    `).join('');
                }
            }
        } catch (err) {
            console.error('Search failed:', err);
        }
    }, 300);
}

async function startChat(contactId) {
    try {
        const res = await fetch('/api/v1/chats', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ type: 'direct', recipient_id: contactId })
        });

        const data = await res.json();
        if (data.success && data.data) {
            hideNewChatModal();
            if (!chats.find(c => c.id === data.data.id)) {
                chats.unshift(data.data);
            }
            renderContactList();
            selectChat(data.data.id);
        }
    } catch (err) {
        console.error('Failed to create chat:', err);
    }
}

// QR Modal functions
let currentFriendCode = null;
let pendingFriendUser = null;
let pendingFriendCodeToAdd = null;

function showQRModal() {
    document.getElementById('qr-modal').style.display = 'flex';
    switchQRTab('my-code');
    loadMyFriendCode();
}

function hideQRModal() {
    document.getElementById('qr-modal').style.display = 'none';
}

function switchQRTab(tab) {
    document.querySelectorAll('.msn-tab').forEach(t => t.classList.remove('active'));

    if (tab === 'my-code') {
        document.getElementById('qr-tab-my-code').classList.add('active');
        document.getElementById('qr-my-code-content').style.display = 'block';
        document.getElementById('qr-scan-content').style.display = 'none';
    } else {
        document.getElementById('qr-tab-scan').classList.add('active');
        document.getElementById('qr-my-code-content').style.display = 'none';
        document.getElementById('qr-scan-content').style.display = 'block';
        document.getElementById('friend-code-input').focus();
    }
}

async function loadMyFriendCode() {
    const container = document.getElementById('qr-code-container');
    const codeText = document.getElementById('qr-code-text');

    container.innerHTML = 'Generating...';
    codeText.textContent = '';

    try {
        const res = await fetch('/api/v1/friend-code');
        const data = await res.json();
        if (data.success && data.data) {
            currentFriendCode = data.data;
            codeText.textContent = data.data.code;

            container.innerHTML = '';
            if (typeof QRCode !== 'undefined') {
                new QRCode(container, {
                    text: data.data.qr_data,
                    width: 120,
                    height: 120,
                    colorDark: '#0078D4',
                    colorLight: '#ffffff',
                    correctLevel: QRCode.CorrectLevel.M
                });
            }
        }
    } catch (err) {
        console.error('Failed to load friend code:', err);
        container.innerHTML = 'Error loading code';
    }
}

function copyFriendCode() {
    if (currentFriendCode?.code) {
        navigator.clipboard.writeText(currentFriendCode.code);
        alert('Friend code copied!');
    }
}

function copyFriendLink() {
    if (currentFriendCode?.qr_data) {
        const link = currentFriendCode.qr_data.startsWith('http') ? currentFriendCode.qr_data : window.location.origin + currentFriendCode.qr_data;
        navigator.clipboard.writeText(link);
        alert('Link copied!');
    }
}

async function lookupFriendCode() {
    const code = document.getElementById('friend-code-input').value.trim();
    const resultDiv = document.getElementById('friend-code-result');

    if (!code) {
        alert('Please enter a friend code');
        return;
    }

    resultDiv.style.display = 'block';
    resultDiv.innerHTML = '<div style="color: var(--text-muted);">Looking up...</div>';

    try {
        const res = await fetch(`/api/v1/friend-code/${encodeURIComponent(code)}`);
        const data = await res.json();

        if (data.success && data.data) {
            pendingFriendUser = data.data;
            pendingFriendCodeToAdd = code;
            hideQRModal();
            showFriendPreviewModal(data.data);
        } else {
            resultDiv.innerHTML = '<div style="color: var(--status-busy);">Invalid or expired code</div>';
        }
    } catch (err) {
        resultDiv.innerHTML = '<div style="color: var(--status-busy);">Error looking up code</div>';
    }
}

function showFriendPreviewModal(user) {
    document.getElementById('friend-preview-name').textContent = user.display_name || user.username;
    document.getElementById('friend-preview-username').textContent = '@' + user.username;
    document.getElementById('friend-preview-status').textContent = user.status || 'Online';
    document.getElementById('friend-preview-modal').style.display = 'flex';
}

function hideFriendPreviewModal() {
    document.getElementById('friend-preview-modal').style.display = 'none';
    pendingFriendUser = null;
    pendingFriendCodeToAdd = null;
}

async function confirmAddFriend() {
    if (!pendingFriendCodeToAdd) return;

    try {
        const res = await fetch(`/api/v1/friend-code/${encodeURIComponent(pendingFriendCodeToAdd)}`, { method: 'POST' });
        const data = await res.json();

        if (data.success) {
            hideFriendPreviewModal();
            alert('Contact added successfully!');
            if (pendingFriendUser?.id) {
                startChat(pendingFriendUser.id);
            }
        } else {
            alert(data.error || 'Failed to add contact');
        }
    } catch (err) {
        alert('Error adding contact');
    }
}

// Utility
function escapeHtml(str) {
    if (!str) return '';
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

// =========================================
// Media Upload Features
// =========================================

function handleFileSelect(event) {
    const files = event.target.files;
    if (files && files.length > 0) {
        uploadAndSendMedia(Array.from(files));
    }
    event.target.value = '';
}

async function uploadAndSendMedia(files) {
    if (!currentChat) {
        alert('Please select a contact first');
        return;
    }

    for (const file of files) {
        try {
            if (window.MediaUpload && window.MediaUpload.showMediaPreview) {
                await new Promise((resolve) => {
                    window.MediaUpload.showMediaPreview(file, async (shouldSend, caption) => {
                        if (shouldSend) {
                            await sendMediaMessage(file, caption);
                        }
                        resolve(shouldSend);
                    });
                });
            } else {
                await sendMediaMessage(file, '');
            }
        } catch (err) {
            console.error('Failed to upload media:', err);
            alert('Failed to upload: ' + file.name);
        }
    }
}

async function sendMediaMessage(file, caption) {
    if (!currentChat) return;

    try {
        const result = await window.MediaUpload.uploadMedia(file, (progress) => {
            document.getElementById('typing-status').textContent = 'Uploading... ' + progress + '%';
        });

        if (result && result.id) {
            const res = await fetch(`/api/v1/chats/${currentChat.id}/messages`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    content: caption || '',
                    type: result.type || 'media',
                    media_id: result.id,
                    media_url: result.url,
                    media_type: result.type,
                    media_content_type: result.content_type,
                    media_filename: result.original_filename,
                    media_size: result.size,
                    media_width: result.width,
                    media_height: result.height,
                    media_duration: result.duration,
                    media_thumbnail_url: result.thumbnail_url
                })
            });

            const data = await res.json();
            if (data.success && data.data) {
                messages.push(data.data);
                renderMessages();
                currentChat.last_message = data.data;
                renderContactList();
            }
            document.getElementById('typing-status').textContent = 'Ready';
        }
    } catch (err) {
        console.error('Failed to send media:', err);
        document.getElementById('typing-status').textContent = 'Upload failed';
        setTimeout(() => {
            document.getElementById('typing-status').textContent = 'Ready';
        }, 3000);
    }
}

function renderMediaContent(msg) {
    if (!msg.media_url && !msg.media_id) return '';

    const mediaType = msg.media_type || msg.type;
    const url = msg.media_url || `/api/v1/media/${msg.media_id}/download`;
    const thumbnailUrl = msg.media_thumbnail_url || url;
    const filename = msg.media_filename || 'file';
    const size = msg.media_size || 0;

    switch (mediaType) {
        case 'image':
            const imageMediaObj = JSON.stringify({type: 'image', url: url, original_filename: filename}).replace(/'/g, "\\'");
            return `
                <div class="msn-message-media msn-message-image" onclick="window.MediaUpload?.showLightbox([${imageMediaObj}], 0)">
                    <img src="${thumbnailUrl}" alt="${escapeHtml(filename)}">
                </div>
            `;
        case 'video':
            return `
                <div class="msn-message-media msn-message-video">
                    <video controls poster="${thumbnailUrl}">
                        <source src="${url}" type="${msg.media_content_type || 'video/mp4'}">
                    </video>
                </div>
            `;
        case 'voice':
            if (window.MediaUpload?.renderVoiceMessage) {
                const streamUrl = msg.media_url || `/api/v1/media/${msg.media_id}/stream`;
                return `<div class="msn-message-media">${window.MediaUpload.renderVoiceMessage(
                    msg.media_id,
                    streamUrl,
                    msg.media_duration || 0,
                    msg.media_waveform || '[]'
                )}</div>`;
            }
            return `
                <div class="msn-message-media msn-message-audio">
                    <audio controls>
                        <source src="${url}" type="${msg.media_content_type || 'audio/webm'}">
                    </audio>
                </div>
            `;
        case 'audio':
            return `
                <div class="msn-message-media msn-message-audio">
                    <audio controls>
                        <source src="${url}" type="${msg.media_content_type || 'audio/mpeg'}">
                    </audio>
                </div>
            `;
        case 'document':
        default:
            const sizeStr = formatFileSize(size);
            return `
                <div class="msn-message-media msn-message-document">
                    <a href="${url}" download="${escapeHtml(filename)}" class="msn-doc-link">
                        <span class="msn-doc-icon">&#128196;</span>
                        <div class="msn-doc-info">
                            <div class="msn-doc-name">${escapeHtml(filename)}</div>
                            <div class="msn-doc-size">${sizeStr}</div>
                        </div>
                    </a>
                </div>
            `;
    }
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}

// Initialize drag-drop and clipboard paste
document.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
        const chatWindow = document.getElementById('chat-window');
        const messageInput = document.getElementById('message-input');

        if (chatWindow && window.MediaUpload) {
            window.MediaUpload.initDragDrop(chatWindow, (files) => {
                uploadAndSendMedia(files);
            });
        }

        if (messageInput && window.MediaUpload) {
            window.MediaUpload.initClipboardPaste(messageInput, (files) => {
                uploadAndSendMedia(files);
            });
        }
    }, 100);
});

// =========================================
// Voice Recording Features
// =========================================

let isRecordingVoice = false;

function handleVoiceRecord() {
    if (!currentChat) {
        alert('Please open a conversation first');
        return;
    }

    if (!window.MediaUpload?.supportsVoiceRecording()) {
        alert('Voice recording is not supported in your browser');
        return;
    }

    if (isRecordingVoice) return;
    isRecordingVoice = true;

    const inputArea = document.getElementById('message-input-area');
    const container = document.getElementById('voice-recording-container');
    inputArea.classList.add('hidden');
    container.classList.remove('hidden');

    window.MediaUpload.startVoiceRecording(
        container,
        async (blob, duration, waveform) => {
            inputArea.classList.remove('hidden');
            container.classList.add('hidden');
            isRecordingVoice = false;

            try {
                const media = await window.MediaUpload.uploadVoiceMessage(blob, duration, waveform);

                const res = await fetch(`/api/v1/chats/${currentChat.id}/messages`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        type: 'voice',
                        content: '',
                        media_id: media.id,
                        media_url: media.url,
                        media_type: 'voice',
                        media_duration: duration,
                        media_waveform: JSON.stringify(waveform)
                    })
                });

                const data = await res.json();
                if (data.success && data.data) {
                    messages.push(data.data);
                    renderMessages();
                    currentChat.last_message = data.data;
                    renderContactList();
                }
            } catch (err) {
                console.error('Failed to send voice message:', err);
                alert('Failed to send voice message');
            }
        },
        (err) => {
            inputArea.classList.remove('hidden');
            container.classList.add('hidden');
            isRecordingVoice = false;

            if (err && err.message) {
                console.error('Voice recording error:', err.message);
            }
        }
    );
}
</script>
{{end}}
