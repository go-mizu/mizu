{{define "content"}}
<div class="im-window">
    <!-- Title Bar -->
    <div class="im-titlebar">
        <div class="im-traffic-lights">
            <button class="im-traffic-btn im-traffic-close" title="Close"></button>
            <button class="im-traffic-btn im-traffic-minimize" title="Minimize"></button>
            <button class="im-traffic-btn im-traffic-maximize" title="Maximize"></button>
        </div>
        <span class="im-title">Messages</span>
        <div class="im-titlebar-actions">
            <button class="im-titlebar-btn" onclick="showNewChatModal()" title="New Message">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 20h9"/>
                    <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/>
                </svg>
            </button>
            <button class="im-titlebar-btn" onclick="showQRModal()" title="Friend Code">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="3" width="7" height="7"/>
                    <rect x="14" y="3" width="7" height="7"/>
                    <rect x="3" y="14" width="7" height="7"/>
                    <rect x="14" y="14" width="7" height="7"/>
                </svg>
            </button>
            <a href="/settings" class="im-titlebar-btn" title="Settings">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="3"/>
                    <path d="M12 1v4M12 19v4M4.22 4.22l2.83 2.83M16.95 16.95l2.83 2.83M1 12h4M19 12h4M4.22 19.78l2.83-2.83M16.95 7.05l2.83-2.83"/>
                </svg>
            </a>
            <button onclick="logout()" class="im-titlebar-btn logout-btn" title="Sign out">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                </svg>
            </button>
        </div>
    </div>

    <!-- Main Layout -->
    <div class="im-main">
        <!-- Sidebar -->
        <div class="im-sidebar">
            <!-- Search -->
            <div class="im-search">
                <input type="text" class="im-search-input" placeholder="Search" id="search-input" oninput="filterConversations(this.value)">
            </div>

            <!-- Conversations List -->
            <div class="im-conversations" id="conversations-list">
                <!-- Conversations will be loaded dynamically -->
            </div>
        </div>

        <!-- Content Area -->
        <div class="im-content" id="content-area">
            <!-- Empty State -->
            <div class="im-empty-state" id="empty-state">
                <div class="im-empty-icon">
                    <svg viewBox="0 0 80 80" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="8" y="8" width="64" height="64" rx="14" fill="currentColor" opacity="0.1"/>
                        <path d="M40 20C28.954 20 20 27.835 20 37.5C20 42.186 22.298 46.426 26 49.41V60L35.677 54.307C37.059 54.538 38.5 54.667 40 54.667C51.046 54.667 60 46.832 60 37.333C60 27.835 51.046 20 40 20Z" fill="currentColor" opacity="0.2"/>
                    </svg>
                </div>
                <h2 class="im-empty-title">No Conversation Selected</h2>
                <p class="im-empty-text">Choose a conversation from the sidebar or start a new one.</p>
                <button class="im-btn im-btn-primary" onclick="showNewChatModal()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 20h9"/>
                        <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/>
                    </svg>
                    New Message
                </button>
            </div>

            <!-- Chat View (hidden by default) -->
            <div id="chat-view" class="hidden" style="display: flex; flex-direction: column; height: 100%;">
                <!-- Chat Header -->
                <div class="im-content-header">
                    <div style="display: flex; align-items: center; gap: var(--space-3);">
                        <div class="im-avatar sm" id="chat-avatar"></div>
                        <span class="im-content-title" id="chat-title"></span>
                    </div>
                </div>

                <!-- Messages -->
                <div class="im-messages" id="messages-container">
                    <!-- Messages will be loaded dynamically -->
                </div>

                <!-- Input Area -->
                <div class="im-input-area">
                    <div class="im-input-actions">
                        <input type="file" id="media-file-input" style="display: none;" multiple accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.zip" onchange="handleFileSelect(event)">
                        <button class="im-input-btn" onclick="document.getElementById('media-file-input').click()" title="Attach">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M12 8v8"/>
                                <path d="M8 12h8"/>
                            </svg>
                        </button>
                    </div>
                    <div class="im-input-wrapper" id="im-picker-wrapper">
                        <textarea
                            id="message-input"
                            class="im-input"
                            placeholder="iMessage"
                            rows="1"
                            onkeydown="handleKeyDown(event)"
                            oninput="autoResize(this)"
                        ></textarea>
                    </div>
                    <div class="im-input-actions">
                        <button class="im-input-btn" onclick="toggleEmojiPicker(this, document.getElementById('message-input'))" title="Emoji">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M8 14s1.5 2 4 2 4-2 4-2"/>
                                <line x1="9" y1="9" x2="9.01" y2="9"/>
                                <line x1="15" y1="9" x2="15.01" y2="9"/>
                            </svg>
                        </button>
                        <button class="im-input-btn" onclick="toggleStickerPicker(this, handleSendSticker)" title="Stickers">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="3" y="3" width="18" height="18" rx="2"/>
                                <circle cx="8.5" cy="8.5" r="1.5"/>
                                <path d="m21 15-5-5L5 21"/>
                            </svg>
                        </button>
                        <button class="im-input-btn voice-record-btn" id="voice-record-btn" onclick="handleVoiceRecord()" title="Voice">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
                                <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                                <line x1="12" y1="19" x2="12" y2="23"/>
                                <line x1="8" y1="23" x2="16" y2="23"/>
                            </svg>
                        </button>
                    </div>
                    <button class="im-send-btn" id="send-btn" onclick="sendMessage()" title="Send">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 19V5"/>
                            <path d="m5 12 7-7 7 7"/>
                        </svg>
                    </button>
                </div>

                <!-- Voice Recording Container -->
                <div id="voice-recording-container" class="hidden"></div>
            </div>
        </div>
    </div>
</div>

<!-- New Message Modal -->
<div id="new-chat-modal" class="im-modal-overlay">
    <div class="im-modal">
        <div class="im-modal-header">
            <span class="im-modal-title">New Message</span>
            <button class="im-modal-close" onclick="hideNewChatModal()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M18 6 6 18"/>
                    <path d="m6 6 12 12"/>
                </svg>
            </button>
        </div>
        <div class="im-modal-body">
            <div class="im-form-group">
                <label class="im-label">To:</label>
                <input type="text" id="contact-search" class="im-input-field" placeholder="Enter a name or username" oninput="searchUsers(this.value)">
            </div>
            <div id="contact-list" style="max-height: 200px; overflow-y: auto;">
                <div style="padding: var(--space-4); text-align: center; color: var(--text-tertiary); font-size: 13px;">
                    Type to search for users...
                </div>
            </div>
        </div>
    </div>
</div>

<!-- QR/Friend Code Modal -->
<div id="qr-modal" class="im-modal-overlay">
    <div class="im-modal" style="max-width: 360px;">
        <div class="im-modal-header">
            <span class="im-modal-title">Your Friend Code</span>
            <button class="im-modal-close" onclick="hideQRModal()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M18 6 6 18"/>
                    <path d="m6 6 12 12"/>
                </svg>
            </button>
        </div>
        <div class="im-modal-body" style="text-align: center;">
            <!-- Tabs -->
            <div class="im-tabs" style="margin-bottom: var(--space-4);">
                <button class="im-tab active" onclick="switchQRTab('my-code')" id="qr-tab-my-code">My Code</button>
                <button class="im-tab" onclick="switchQRTab('scan')" id="qr-tab-scan">Add Friend</button>
            </div>

            <!-- My Code Tab -->
            <div id="qr-my-code-content">
                <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: var(--space-4);">
                    Share this code with friends to let them add you.
                </p>
                <div id="qr-code-container" style="background: white; padding: var(--space-4); border-radius: var(--radius-lg); display: inline-block; margin-bottom: var(--space-3);">
                    Loading...
                </div>
                <div id="qr-code-text" style="font-family: var(--font-mono); font-size: 16px; font-weight: 600; margin-bottom: var(--space-4);"></div>
                <div style="display: flex; gap: var(--space-2); justify-content: center;">
                    <button class="im-btn im-btn-secondary" onclick="copyFriendCode()">Copy Code</button>
                    <button class="im-btn im-btn-secondary" onclick="copyFriendLink()">Copy Link</button>
                </div>
            </div>

            <!-- Add Friend Tab -->
            <div id="qr-scan-content" class="hidden">
                <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: var(--space-4);">
                    Enter a friend code to add someone.
                </p>
                <div class="im-form-group">
                    <input type="text" id="friend-code-input" class="im-input-field" style="text-align: center; font-family: var(--font-mono);" placeholder="MIZU-XXXXXXXX" oninput="this.value = this.value.toUpperCase()">
                </div>
                <button class="im-btn im-btn-primary im-btn-block" onclick="lookupFriendCode()">Look Up</button>
                <div id="friend-code-result" class="hidden" style="margin-top: var(--space-4);"></div>
            </div>
        </div>
    </div>
</div>

<!-- Friend Preview Modal -->
<div id="friend-preview-modal" class="im-modal-overlay">
    <div class="im-modal" style="max-width: 300px;">
        <div class="im-modal-header">
            <span class="im-modal-title">Add Friend</span>
            <button class="im-modal-close" onclick="hideFriendPreviewModal()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M18 6 6 18"/>
                    <path d="m6 6 12 12"/>
                </svg>
            </button>
        </div>
        <div class="im-modal-body" style="text-align: center;">
            <div class="im-avatar" style="width: 64px; height: 64px; font-size: 24px; margin: 0 auto var(--space-3);"></div>
            <div id="friend-preview-name" style="font-size: 17px; font-weight: 600;"></div>
            <div id="friend-preview-username" style="font-size: 13px; color: var(--text-secondary);"></div>
            <div id="friend-preview-status" style="font-size: 13px; color: var(--text-tertiary); margin-top: var(--space-2);"></div>
        </div>
        <div class="im-modal-footer">
            <button class="im-btn im-btn-secondary" onclick="hideFriendPreviewModal()">Cancel</button>
            <button class="im-btn im-btn-primary" onclick="confirmAddFriend()">Add Friend</button>
        </div>
    </div>
</div>

<form id="message-form" style="display: none;"></form>

<!-- Theme Switcher FAB -->
<div id="theme-switcher-fab" class="theme-switcher-fab" title="Switch Theme">
    <div class="theme-switcher-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="5"/>
            <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
        </svg>
    </div>
    <div class="theme-switcher-tooltip">Theme: <span id="current-theme-name"></span></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="/static/js/emoji-data.js"></script>
<script src="/static/js/sticker-data.js"></script>
<script src="/static/js/media.js"></script>

<script>
// App state
let currentUser = null;
let currentChat = null;
let chats = [];
let messages = [];
let ws = null;
let typingTimeout = null;

// Initialize
document.addEventListener('DOMContentLoaded', async () => {
    await loadCurrentUser();
    await ensureUserChats();
    await loadChats();
    connectWebSocket();
});

// Ensure user has default chats
async function ensureUserChats() {
    try {
        await fetch('/api/v1/users/ensure-chats', { method: 'POST' });
    } catch (err) {
        console.error('Failed to ensure user chats:', err);
    }
}

// Load current user
async function loadCurrentUser() {
    try {
        const res = await fetch('/api/v1/users/me');
        const data = await res.json();
        if (data.success && data.data) {
            currentUser = data.data;
        } else {
            window.location.href = '/login';
        }
    } catch (err) {
        console.error('Failed to load user:', err);
        window.location.href = '/login';
    }
}

// Load chats
async function loadChats() {
    try {
        const res = await fetch('/api/v1/chats');
        const data = await res.json();
        if (data.success) {
            chats = data.data || [];
            renderConversations();
        }
    } catch (err) {
        console.error('Failed to load chats:', err);
    }
}

// Render conversations in sidebar
function renderConversations() {
    const container = document.getElementById('conversations-list');

    if (chats.length === 0) {
        container.innerHTML = `
            <div style="padding: var(--space-6); text-align: center;">
                <p style="font-size: 13px; color: var(--text-tertiary);">No conversations yet</p>
                <button class="im-btn im-btn-link" onclick="showNewChatModal()" style="margin-top: var(--space-2);">Start a new one</button>
            </div>
        `;
        return;
    }

    container.innerHTML = chats.map(chat => {
        const isSelfChat = chat.type === 'direct' && chat.other_user?.id === currentUser?.id;
        const isAgent = chat.type === 'direct' && chat.other_user?.username === 'mizu-agent';

        let name, initial;
        if (isSelfChat) {
            name = 'Saved Messages';
            initial = 'S';
        } else if (isAgent) {
            name = chat.other_user?.display_name || 'Mizu Agent';
            initial = 'M';
        } else if (chat.type === 'direct') {
            name = chat.other_user?.display_name || chat.other_user?.username;
            initial = (name || '?').charAt(0).toUpperCase();
        } else {
            name = chat.group_name || chat.name;
            initial = (name || '?').charAt(0).toUpperCase();
        }

        const isActive = currentChat?.id === chat.id;
        const unread = chat.unread_count || 0;
        const preview = chat.last_message?.content || 'No messages yet';
        const time = chat.last_message?.created_at ? formatTime(chat.last_message.created_at) : '';
        const gradientClass = `gradient-${(chat.id.charCodeAt(0) % 5) + 1}`;

        return `
            <div class="im-conversation ${isActive ? 'active' : ''}" onclick="selectChat('${chat.id}')">
                <div class="im-avatar ${gradientClass}">${initial}</div>
                <div class="im-conversation-content">
                    <div class="im-conversation-header">
                        <span class="im-conversation-name">${escapeHtml(name)}</span>
                        <span class="im-conversation-time">${time}</span>
                    </div>
                    <div class="im-conversation-preview">${escapeHtml(truncate(preview, 40))}</div>
                </div>
                ${unread > 0 ? '<div class="im-conversation-unread"></div>' : ''}
            </div>
        `;
    }).join('');
}

// Filter conversations
function filterConversations(query) {
    const items = document.querySelectorAll('.im-conversation');
    const q = query.toLowerCase();

    items.forEach(item => {
        const name = item.querySelector('.im-conversation-name').textContent.toLowerCase();
        item.style.display = name.includes(q) ? '' : 'none';
    });
}

// Select chat
async function selectChat(chatId) {
    currentChat = chats.find(c => c.id === chatId);
    if (!currentChat) return;

    // Update UI
    document.getElementById('empty-state').classList.add('hidden');
    document.getElementById('chat-view').classList.remove('hidden');
    document.getElementById('chat-view').style.display = 'flex';

    // Update header
    const isSelfChat = currentChat.type === 'direct' && currentChat.other_user?.id === currentUser?.id;
    const isAgent = currentChat.type === 'direct' && currentChat.other_user?.username === 'mizu-agent';
    let name, initial;

    if (isSelfChat) {
        name = 'Saved Messages';
        initial = 'S';
    } else if (isAgent) {
        name = currentChat.other_user?.display_name || 'Mizu Agent';
        initial = 'M';
    } else if (currentChat.type === 'direct') {
        name = currentChat.other_user?.display_name || currentChat.other_user?.username;
        initial = (name || '?').charAt(0).toUpperCase();
    } else {
        name = currentChat.group_name || currentChat.name;
        initial = (name || '?').charAt(0).toUpperCase();
    }

    document.getElementById('chat-title').textContent = name;
    document.getElementById('chat-avatar').textContent = initial;

    renderConversations();
    await loadMessages(chatId);
    markAsRead(chatId);
}

// Load messages
async function loadMessages(chatId) {
    const container = document.getElementById('messages-container');
    container.innerHTML = '<div style="padding: var(--space-4); text-align: center; color: var(--text-tertiary);">Loading...</div>';

    try {
        const res = await fetch(`/api/v1/chats/${chatId}/messages`);
        const data = await res.json();
        if (data.success) {
            messages = data.data || [];
            renderMessages();
        } else {
            messages = [];
            renderMessages();
        }
    } catch (err) {
        console.error('Failed to load messages:', err);
        messages = [];
        renderMessages();
    }
}

// Render messages
function renderMessages() {
    const container = document.getElementById('messages-container');

    if (messages.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 60px 20px;">
                <p style="font-size: 13px; color: var(--text-tertiary);">No messages yet. Say hello!</p>
            </div>
        `;
        return;
    }

    container.innerHTML = messages.map((msg, idx) => {
        const isSent = msg.sender_id === currentUser?.id;
        const senderName = isSent ? (currentUser.display_name || currentUser.username) : (msg.sender_name || 'Unknown');
        const time = formatTime(msg.created_at);
        const prevMsg = messages[idx - 1];
        const sameSender = prevMsg && prevMsg.sender_id === msg.sender_id;

        // Handle sticker messages
        if (msg.type === 'sticker' && msg.sticker_pack_id && msg.sticker_id) {
            const stickerContent = renderStickerMessage(msg.sticker_pack_id, msg.sticker_id);
            return `
                <div class="im-message-wrapper ${isSent ? 'sent' : 'received'}" data-message-id="${msg.id}">
                    <div class="im-message im-message-sticker ${isSent ? 'sent' : 'received'}">${stickerContent}</div>
                    <div class="im-message-time">${time}</div>
                    ${renderReactions(msg)}
                </div>
            `;
        }

        // Check if it's a media message
        const isMedia = msg.media_id || msg.media_url || ['image', 'video', 'audio', 'voice', 'document'].includes(msg.type);
        let contentHtml = '';

        if (isMedia) {
            contentHtml = renderMediaContent(msg);
            if (msg.content) {
                contentHtml += `<div style="margin-top: var(--space-2);">${escapeHtml(msg.content)}</div>`;
            }
        } else {
            contentHtml = escapeHtml(msg.content);
        }

        return `
            <div class="im-message-wrapper ${isSent ? 'sent' : 'received'}" data-message-id="${msg.id}">
                <div class="im-message ${isSent ? 'sent' : 'received'}">${contentHtml}</div>
                <div class="im-message-time">${time}</div>
                ${renderReactions(msg)}
            </div>
        `;
    }).join('');

    container.scrollTop = container.scrollHeight;
}

// Render reactions
function renderReactions(msg) {
    if (!Array.isArray(msg.reactions) || msg.reactions.length === 0) return '';

    const reactionCounts = {};
    msg.reactions.forEach(r => {
        if (!reactionCounts[r.emoji]) {
            reactionCounts[r.emoji] = { count: 0, hasOwn: false };
        }
        reactionCounts[r.emoji].count++;
        if (r.user_id === currentUser?.id) {
            reactionCounts[r.emoji].hasOwn = true;
        }
    });

    return `<div class="im-reactions">
        ${Object.entries(reactionCounts).map(([emoji, data]) => `
            <span class="im-reaction ${data.hasOwn ? 'own' : ''}" onclick="handleReactionClick('${msg.id}', '${emoji}')">
                <span class="im-reaction-emoji">${emoji}</span>
                <span class="im-reaction-count">${data.count}</span>
            </span>
        `).join('')}
    </div>`;
}

// Get sticker by ID
function getStickerById(stickerId) {
    if (typeof STICKER_PACKS === 'undefined') return null;
    for (const pack of STICKER_PACKS) {
        const sticker = pack.stickers.find(s => s.id === stickerId);
        if (sticker) return sticker;
    }
    return null;
}

// Handle reaction click
async function handleReactionClick(messageId, emoji) {
    if (!currentChat) return;

    const msg = messages.find(m => m.id === messageId);
    const hasOwn = msg?.reactions?.some(r => r.emoji === emoji && r.user_id === currentUser?.id);

    try {
        if (hasOwn) {
            await fetch(`/api/v1/chats/${currentChat.id}/messages/${messageId}/react`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ emoji })
            });
        } else {
            await fetch(`/api/v1/chats/${currentChat.id}/messages/${messageId}/react`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ emoji })
            });
        }
        await loadMessages(currentChat.id);
    } catch (err) {
        console.error('Failed to toggle reaction:', err);
    }
}

// Handle sending a sticker
async function handleSendSticker(packId, stickerId) {
    if (!currentChat) return;

    try {
        const packs = window.STICKER_PACKS || {};
        const pack = packs[packId];
        const sticker = pack?.stickers.find(s => s.id === stickerId);

        const res = await fetch(`/api/v1/chats/${currentChat.id}/messages`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                type: 'sticker',
                content: sticker ? sticker.name : stickerId,
                sticker_pack_id: packId,
                sticker_id: stickerId,
            })
        });

        const data = await res.json();
        if (data.success && data.data) {
            messages.push(data.data);
            renderMessages();
            if (typeof addRecentSticker === 'function') {
                addRecentSticker(packId, stickerId);
            }
        }
    } catch (err) {
        console.error('Failed to send sticker:', err);
    }
}

// Mark as read
async function markAsRead(chatId) {
    try {
        await fetch(`/api/v1/chats/${chatId}/read`, { method: 'POST' });
        const chat = chats.find(c => c.id === chatId);
        if (chat) chat.unread_count = 0;
        renderConversations();
    } catch (err) {
        console.error('Failed to mark as read:', err);
    }
}

// Send message
async function sendMessage() {
    const input = document.getElementById('message-input');
    const content = input.value.trim();

    if (!content || !currentChat) return;

    input.value = '';
    input.style.height = 'auto';

    try {
        const res = await fetch(`/api/v1/chats/${currentChat.id}/messages`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content })
        });

        const data = await res.json();
        if (data.success && data.data) {
            messages.push(data.data);
            renderMessages();
            currentChat.last_message = data.data;
            renderConversations();
        }
    } catch (err) {
        console.error('Failed to send message:', err);
    }
}

// Handle Enter key
function handleKeyDown(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
}

// Auto-resize textarea
function autoResize(el) {
    el.style.height = 'auto';
    el.style.height = Math.min(el.scrollHeight, 120) + 'px';
}

// WebSocket
function connectWebSocket() {
    const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
    ws = new WebSocket(`${protocol}//${location.host}/ws`);

    ws.onopen = () => console.log('WebSocket connected');
    ws.onmessage = (event) => handleWebSocketMessage(JSON.parse(event.data));
    ws.onclose = () => {
        console.log('WebSocket disconnected, reconnecting...');
        setTimeout(connectWebSocket, 3000);
    };
    ws.onerror = (err) => console.error('WebSocket error:', err);
}

function handleWebSocketMessage(data) {
    switch(data.type) {
        case 'new_message':
            handleNewMessage(data.message);
            break;
        case 'typing':
            handleTyping(data);
            break;
    }
}

function handleNewMessage(msg) {
    const chat = chats.find(c => c.id === msg.chat_id);
    if (chat) {
        chat.last_message = msg;
        if (currentChat?.id !== msg.chat_id) {
            chat.unread_count = (chat.unread_count || 0) + 1;
        }
        chats = [chat, ...chats.filter(c => c.id !== chat.id)];
        renderConversations();
    }

    if (currentChat?.id === msg.chat_id) {
        messages.push(msg);
        renderMessages();
        markAsRead(msg.chat_id);
    }
}

function handleTyping(data) {
    // Could show typing indicator
}

// Modal functions
function showNewChatModal() {
    document.getElementById('new-chat-modal').classList.add('active');
    document.getElementById('contact-search').value = '';
    document.getElementById('contact-search').focus();
    showRecentContacts();
}

function hideNewChatModal() {
    document.getElementById('new-chat-modal').classList.remove('active');
}

function showRecentContacts() {
    const list = document.getElementById('contact-list');
    const recentUsers = [];
    const seenIds = new Set();

    for (const chat of chats) {
        if (chat.type === 'direct' && chat.other_user) {
            const user = chat.other_user;
            if (user.id !== currentUser?.id && !seenIds.has(user.id)) {
                seenIds.add(user.id);
                recentUsers.push(user);
            }
        }
    }

    if (recentUsers.length === 0) {
        list.innerHTML = '<div style="padding: var(--space-4); text-align: center; color: var(--text-tertiary); font-size: 13px;">Type to search for users...</div>';
        return;
    }

    list.innerHTML = recentUsers.slice(0, 5).map(user => {
        const initial = (user.display_name || user.username || '?').charAt(0).toUpperCase();
        const gradientClass = `gradient-${(user.id.charCodeAt(0) % 5) + 1}`;
        return `
            <div class="im-conversation" onclick="startChat('${user.id}')" style="margin: 0;">
                <div class="im-avatar sm ${gradientClass}">${initial}</div>
                <div class="im-conversation-content">
                    <span class="im-conversation-name">${escapeHtml(user.display_name || user.username)}</span>
                </div>
            </div>
        `;
    }).join('');
}

let searchTimeout = null;
async function searchUsers(query) {
    clearTimeout(searchTimeout);
    const list = document.getElementById('contact-list');

    if (query.trim().length < 2) {
        showRecentContacts();
        return;
    }

    list.innerHTML = '<div style="padding: var(--space-4); text-align: center; color: var(--text-tertiary); font-size: 13px;">Searching...</div>';

    searchTimeout = setTimeout(async () => {
        try {
            const res = await fetch(`/api/v1/users/search?q=${encodeURIComponent(query)}`);
            const data = await res.json();
            if (data.success) {
                const users = (data.data || []).filter(u => u.id !== currentUser?.id);
                if (users.length === 0) {
                    list.innerHTML = '<div style="padding: var(--space-4); text-align: center; color: var(--text-tertiary); font-size: 13px;">No users found</div>';
                } else {
                    list.innerHTML = users.map(user => {
                        const initial = (user.display_name || user.username || '?').charAt(0).toUpperCase();
                        const gradientClass = `gradient-${(user.id.charCodeAt(0) % 5) + 1}`;
                        return `
                            <div class="im-conversation" onclick="startChat('${user.id}')" style="margin: 0;">
                                <div class="im-avatar sm ${gradientClass}">${initial}</div>
                                <div class="im-conversation-content">
                                    <span class="im-conversation-name">${escapeHtml(user.display_name || user.username)}</span>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            }
        } catch (err) {
            console.error('Search failed:', err);
        }
    }, 300);
}

async function startChat(contactId) {
    try {
        const res = await fetch('/api/v1/chats', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ type: 'direct', recipient_id: contactId })
        });

        const data = await res.json();
        if (data.success && data.data) {
            hideNewChatModal();
            if (!chats.find(c => c.id === data.data.id)) {
                chats.unshift(data.data);
            }
            renderConversations();
            selectChat(data.data.id);
        }
    } catch (err) {
        console.error('Failed to create chat:', err);
    }
}

// QR Modal
let currentFriendCode = null;
let pendingFriendUser = null;
let pendingFriendCodeToAdd = null;

function showQRModal() {
    document.getElementById('qr-modal').classList.add('active');
    switchQRTab('my-code');
    loadMyFriendCode();
}

function hideQRModal() {
    document.getElementById('qr-modal').classList.remove('active');
}

function switchQRTab(tab) {
    document.querySelectorAll('#qr-modal .im-tab').forEach(t => t.classList.remove('active'));

    if (tab === 'my-code') {
        document.getElementById('qr-tab-my-code').classList.add('active');
        document.getElementById('qr-my-code-content').classList.remove('hidden');
        document.getElementById('qr-scan-content').classList.add('hidden');
    } else {
        document.getElementById('qr-tab-scan').classList.add('active');
        document.getElementById('qr-my-code-content').classList.add('hidden');
        document.getElementById('qr-scan-content').classList.remove('hidden');
        document.getElementById('friend-code-input').focus();
    }
}

async function loadMyFriendCode() {
    const container = document.getElementById('qr-code-container');
    const codeText = document.getElementById('qr-code-text');

    container.innerHTML = 'Generating...';
    codeText.textContent = '';

    try {
        const res = await fetch('/api/v1/friend-code');
        const data = await res.json();
        if (data.success && data.data) {
            currentFriendCode = data.data;
            codeText.textContent = data.data.code;

            container.innerHTML = '';
            if (typeof QRCode !== 'undefined') {
                new QRCode(container, {
                    text: data.data.qr_data,
                    width: 120,
                    height: 120,
                    colorDark: '#000000',
                    colorLight: '#ffffff',
                    correctLevel: QRCode.CorrectLevel.M
                });
            }
        }
    } catch (err) {
        console.error('Failed to load friend code:', err);
        container.innerHTML = 'Error loading code';
    }
}

function copyFriendCode() {
    if (currentFriendCode?.code) {
        navigator.clipboard.writeText(currentFriendCode.code);
    }
}

function copyFriendLink() {
    if (currentFriendCode?.qr_data) {
        const link = currentFriendCode.qr_data.startsWith('http') ? currentFriendCode.qr_data : window.location.origin + currentFriendCode.qr_data;
        navigator.clipboard.writeText(link);
    }
}

async function lookupFriendCode() {
    const code = document.getElementById('friend-code-input').value.trim();
    const resultDiv = document.getElementById('friend-code-result');

    if (!code) return;

    resultDiv.classList.remove('hidden');
    resultDiv.innerHTML = '<div style="color: var(--text-tertiary);">Looking up...</div>';

    try {
        const res = await fetch(`/api/v1/friend-code/${encodeURIComponent(code)}`);
        const data = await res.json();

        if (data.success && data.data) {
            pendingFriendUser = data.data;
            pendingFriendCodeToAdd = code;
            hideQRModal();
            showFriendPreviewModal(data.data);
        } else {
            resultDiv.innerHTML = '<div style="color: var(--accent-red);">Invalid or expired code</div>';
        }
    } catch (err) {
        resultDiv.innerHTML = '<div style="color: var(--accent-red);">Error looking up code</div>';
    }
}

function showFriendPreviewModal(user) {
    document.getElementById('friend-preview-name').textContent = user.display_name || user.username;
    document.getElementById('friend-preview-username').textContent = '@' + user.username;
    document.getElementById('friend-preview-status').textContent = user.status || '';
    document.getElementById('friend-preview-modal').classList.add('active');
}

function hideFriendPreviewModal() {
    document.getElementById('friend-preview-modal').classList.remove('active');
    pendingFriendUser = null;
    pendingFriendCodeToAdd = null;
}

async function confirmAddFriend() {
    if (!pendingFriendCodeToAdd) return;

    try {
        const res = await fetch(`/api/v1/friend-code/${encodeURIComponent(pendingFriendCodeToAdd)}`, { method: 'POST' });
        const data = await res.json();

        if (data.success) {
            hideFriendPreviewModal();
            if (pendingFriendUser?.id) {
                startChat(pendingFriendUser.id);
            }
        }
    } catch (err) {
        console.error('Error adding friend:', err);
    }
}

// Utilities
function escapeHtml(str) {
    if (!str) return '';
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

function truncate(str, len) {
    if (!str) return '';
    return str.length > len ? str.substring(0, len) + '...' : str;
}

function formatTime(dateStr) {
    if (!dateStr) return '';
    const date = new Date(dateStr);
    const now = new Date();
    const diff = now - date;

    if (diff < 60000) return 'now';
    if (diff < 3600000) return Math.floor(diff / 60000) + 'm';
    if (diff < 86400000) return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    if (diff < 604800000) return date.toLocaleDateString([], { weekday: 'short' });
    return date.toLocaleDateString([], { month: 'short', day: 'numeric' });
}

// Media handling
function handleFileSelect(event) {
    const files = event.target.files;
    if (files && files.length > 0) {
        uploadAndSendMedia(Array.from(files));
    }
    event.target.value = '';
}

async function uploadAndSendMedia(files) {
    if (!currentChat) return;

    for (const file of files) {
        try {
            if (window.MediaUpload && window.MediaUpload.showMediaPreview) {
                await new Promise((resolve) => {
                    window.MediaUpload.showMediaPreview(file, async (shouldSend, caption) => {
                        if (shouldSend) {
                            await sendMediaMessage(file, caption);
                        }
                        resolve(shouldSend);
                    });
                });
            } else {
                await sendMediaMessage(file, '');
            }
        } catch (err) {
            console.error('Failed to upload media:', err);
        }
    }
}

async function sendMediaMessage(file, caption) {
    if (!currentChat) return;

    try {
        const result = await window.MediaUpload.uploadMedia(file, () => {});

        if (result && result.id) {
            const res = await fetch(`/api/v1/chats/${currentChat.id}/messages`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    content: caption || '',
                    type: result.type || 'media',
                    media_id: result.id,
                    media_url: result.url,
                    media_type: result.type,
                    media_content_type: result.content_type,
                    media_filename: result.original_filename,
                    media_size: result.size,
                    media_width: result.width,
                    media_height: result.height,
                    media_duration: result.duration,
                    media_thumbnail_url: result.thumbnail_url
                })
            });

            const data = await res.json();
            if (data.success && data.data) {
                messages.push(data.data);
                renderMessages();
                currentChat.last_message = data.data;
                renderConversations();
            }
        }
    } catch (err) {
        console.error('Failed to send media:', err);
    }
}

function renderMediaContent(msg) {
    if (!msg.media_url && !msg.media_id) return '';

    const mediaType = msg.media_type || msg.type;
    const url = msg.media_url || `/api/v1/media/${msg.media_id}/download`;
    const thumbnailUrl = msg.media_thumbnail_url || url;
    const filename = msg.media_filename || 'file';

    switch (mediaType) {
        case 'image':
            return `<div class="im-message-media" onclick="window.MediaUpload?.showLightbox([{type: 'image', url: '${url}'}], 0)">
                <img src="${thumbnailUrl}" alt="${escapeHtml(filename)}" style="max-width: 240px; border-radius: var(--radius-lg); cursor: pointer;">
            </div>`;
        case 'video':
            return `<div class="im-message-media">
                <video controls style="max-width: 280px; border-radius: var(--radius-lg);">
                    <source src="${url}" type="${msg.media_content_type || 'video/mp4'}">
                </video>
            </div>`;
        case 'voice':
            if (window.MediaUpload?.renderVoiceMessage) {
                const streamUrl = msg.media_url || `/api/v1/media/${msg.media_id}/stream`;
                return window.MediaUpload.renderVoiceMessage(msg.media_id, streamUrl, msg.media_duration || 0, msg.media_waveform || '[]');
            }
            return `<audio controls style="width: 200px;"><source src="${url}"></audio>`;
        case 'audio':
            return `<audio controls style="width: 200px;"><source src="${url}"></audio>`;
        default:
            return `<div class="im-document-message">
                <div class="im-document-icon">${filename.split('.').pop().toUpperCase().slice(0, 3)}</div>
                <div class="im-document-info">
                    <div class="im-document-name">${escapeHtml(filename)}</div>
                    <div class="im-document-size">${formatFileSize(msg.media_size || 0)}</div>
                </div>
            </div>`;
    }
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}

// Voice recording
let isRecordingVoice = false;

function handleVoiceRecord() {
    if (!currentChat) return;

    if (!window.MediaUpload?.supportsVoiceRecording()) {
        alert('Voice recording is not supported in your browser');
        return;
    }

    if (isRecordingVoice) return;
    isRecordingVoice = true;

    const inputArea = document.querySelector('.im-input-area');
    const container = document.getElementById('voice-recording-container');
    inputArea.classList.add('hidden');
    container.classList.remove('hidden');

    window.MediaUpload.startVoiceRecording(
        container,
        async (blob, duration, waveform) => {
            inputArea.classList.remove('hidden');
            container.classList.add('hidden');
            isRecordingVoice = false;

            try {
                const media = await window.MediaUpload.uploadVoiceMessage(blob, duration, waveform);

                const res = await fetch(`/api/v1/chats/${currentChat.id}/messages`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        type: 'voice',
                        content: '',
                        media_id: media.id,
                        media_url: media.url,
                        media_type: 'voice',
                        media_duration: duration,
                        media_waveform: JSON.stringify(waveform)
                    })
                });

                const data = await res.json();
                if (data.success && data.data) {
                    messages.push(data.data);
                    renderMessages();
                    currentChat.last_message = data.data;
                    renderConversations();
                }
            } catch (err) {
                console.error('Failed to send voice message:', err);
            }
        },
        (err) => {
            inputArea.classList.remove('hidden');
            container.classList.add('hidden');
            isRecordingVoice = false;
        }
    );
}

// Initialize drag-drop
document.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
        const chatView = document.getElementById('chat-view');
        const messageInput = document.getElementById('message-input');

        if (chatView && window.MediaUpload) {
            window.MediaUpload.initDragDrop(chatView, (files) => {
                uploadAndSendMedia(files);
            });
        }

        if (messageInput && window.MediaUpload) {
            window.MediaUpload.initClipboardPaste(messageInput, (files) => {
                uploadAndSendMedia(files);
            });
        }
    }, 100);
});
</script>
{{end}}
