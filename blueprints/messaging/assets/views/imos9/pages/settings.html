{{define "content"}}
<div class="os9-window">
    <!-- Title Bar -->
    <div class="os9-titlebar">
        <div class="os9-window-controls">
            <button class="os9-control-btn os9-control-close" onclick="window.location.href='/app'" title="Close"></button>
        </div>
        <span class="os9-title">Settings</span>
        <div class="os9-window-controls">
            <button class="os9-control-btn os9-control-zoom" title="Zoom"></button>
        </div>
    </div>

    <!-- Settings Content -->
    <div style="flex: 1; overflow-y: auto; background: var(--os9-gray-300);">
        <div class="os9-settings">
            <!-- Profile Section -->
            <div class="os9-settings-section">
                <div class="os9-settings-title">Profile</div>
                <div class="os9-settings-card">
                    <div class="os9-settings-item">
                        <span class="os9-settings-label">Username</span>
                        <span class="os9-settings-value" id="settings-username">Loading...</span>
                    </div>
                    <div class="os9-settings-item">
                        <span class="os9-settings-label">Display Name</span>
                        <span class="os9-settings-value" id="settings-display-name">Loading...</span>
                    </div>
                    <div class="os9-settings-item">
                        <span class="os9-settings-label">Friend Code</span>
                        <button class="os9-btn" onclick="showQRModal()">View Code</button>
                    </div>
                </div>
            </div>

            <!-- Appearance Section -->
            <div class="os9-settings-section">
                <div class="os9-settings-title">Appearance</div>
                <div class="os9-settings-card">
                    <div class="os9-settings-item">
                        <span class="os9-settings-label">Theme</span>
                        <select class="os9-input-field os9-select" id="theme-select" style="width: 140px;" onchange="changeTheme(this.value)">
                            <option value="default">Default</option>
                            <option value="aim1.0">AIM Classic</option>
                            <option value="ymxp">Yahoo XP</option>
                            <option value="im26">iMessage Tahoe</option>
                            <option value="imos9" selected>Mac OS 9</option>
                            <option value="imosx">Mac OS X Aqua</option>
                            <option value="team11">Teams Win11</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Notifications Section -->
            <div class="os9-settings-section">
                <div class="os9-settings-title">Notifications</div>
                <div class="os9-settings-card">
                    <div class="os9-settings-item">
                        <span class="os9-settings-label">Message Sounds</span>
                        <div class="os9-toggle">
                            <input type="checkbox" id="sound-toggle" checked>
                        </div>
                    </div>
                    <div class="os9-settings-item">
                        <span class="os9-settings-label">Desktop Notifications</span>
                        <div class="os9-toggle">
                            <input type="checkbox" id="notification-toggle">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Account Section -->
            <div class="os9-settings-section">
                <div class="os9-settings-title">Account</div>
                <div class="os9-settings-card">
                    <div class="os9-settings-item">
                        <span class="os9-settings-label">Change Password</span>
                        <button class="os9-btn" onclick="showChangePasswordModal()">Change</button>
                    </div>
                    <div class="os9-settings-item">
                        <span class="os9-settings-label">Sign Out</span>
                        <button class="os9-btn os9-btn-danger" onclick="signOut()">Sign Out</button>
                    </div>
                </div>
            </div>

            <!-- About Section -->
            <div class="os9-settings-section">
                <div class="os9-settings-title">About</div>
                <div class="os9-settings-card">
                    <div class="os9-settings-item">
                        <span class="os9-settings-label">Version</span>
                        <span class="os9-settings-value">1.0.0</span>
                    </div>
                    <div class="os9-settings-item">
                        <span class="os9-settings-label">Theme</span>
                        <span class="os9-settings-value">Mac OS 9 Platinum</span>
                    </div>
                </div>
            </div>

            <!-- Back Button -->
            <div style="text-align: center; margin-top: 16px;">
                <a href="/app" class="os9-btn os9-btn-default" style="text-decoration: none;">Back to Messages</a>
            </div>
        </div>
    </div>
</div>

<!-- QR Modal -->
<div id="qr-modal" class="os9-modal-overlay">
    <div class="os9-modal" style="max-width: 300px;">
        <div class="os9-modal-header">
            <span class="os9-modal-title">Your Friend Code</span>
            <button class="os9-modal-close" onclick="hideQRModal()">x</button>
        </div>
        <div class="os9-modal-body" style="text-align: center;">
            <p style="font-size: 11px; color: var(--os9-gray-700); margin-bottom: 12px;">
                Share this code with friends to let them add you.
            </p>
            <div id="qr-code-container" style="background: white; padding: 12px; border: 1px solid var(--os9-black); display: inline-block; margin-bottom: 8px;">
                Loading...
            </div>
            <div id="qr-code-text" style="font-family: var(--font-mono); font-size: 14px; font-weight: bold; margin-bottom: 12px;"></div>
            <div style="display: flex; gap: 6px; justify-content: center;">
                <button class="os9-btn" onclick="copyFriendCode()">Copy Code</button>
            </div>
        </div>
    </div>
</div>

<!-- Change Password Modal -->
<div id="password-modal" class="os9-modal-overlay">
    <div class="os9-modal" style="max-width: 300px;">
        <div class="os9-modal-header">
            <span class="os9-modal-title">Change Password</span>
            <button class="os9-modal-close" onclick="hideChangePasswordModal()">x</button>
        </div>
        <div class="os9-modal-body">
            <form id="password-form" onsubmit="handleChangePassword(event)">
                <div class="os9-form-group">
                    <label class="os9-label" for="current-password">Current Password:</label>
                    <input type="password" id="current-password" class="os9-input-field" required>
                </div>
                <div class="os9-form-group">
                    <label class="os9-label" for="new-password">New Password:</label>
                    <input type="password" id="new-password" class="os9-input-field" required minlength="6">
                </div>
                <div class="os9-form-group">
                    <label class="os9-label" for="confirm-password">Confirm Password:</label>
                    <input type="password" id="confirm-password" class="os9-input-field" required minlength="6">
                </div>
                <div id="password-error" class="os9-auth-error hidden"></div>
            </form>
        </div>
        <div class="os9-modal-footer">
            <button class="os9-btn" onclick="hideChangePasswordModal()">Cancel</button>
            <button class="os9-btn os9-btn-default" onclick="document.getElementById('password-form').requestSubmit()">Change</button>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
let currentUser = null;
let currentFriendCode = null;

// Initialize
document.addEventListener('DOMContentLoaded', async () => {
    await loadCurrentUser();
    loadSettings();
});

async function loadCurrentUser() {
    try {
        const res = await fetch('/api/v1/users/me');
        const data = await res.json();
        if (data.success && data.data) {
            currentUser = data.data;
            document.getElementById('settings-username').textContent = currentUser.username;
            document.getElementById('settings-display-name').textContent = currentUser.display_name || currentUser.username;
        } else {
            window.location.href = '/login';
        }
    } catch (err) {
        console.error('Failed to load user:', err);
        window.location.href = '/login';
    }
}

function loadSettings() {
    // Load saved settings from localStorage
    const sounds = localStorage.getItem('message_sounds') !== 'false';
    const notifications = localStorage.getItem('desktop_notifications') === 'true';

    document.getElementById('sound-toggle').checked = sounds;
    document.getElementById('notification-toggle').checked = notifications;

    // Add event listeners
    document.getElementById('sound-toggle').addEventListener('change', (e) => {
        localStorage.setItem('message_sounds', e.target.checked);
    });

    document.getElementById('notification-toggle').addEventListener('change', (e) => {
        localStorage.setItem('desktop_notifications', e.target.checked);
        if (e.target.checked && Notification.permission === 'default') {
            Notification.requestPermission();
        }
    });
}

function changeTheme(theme) {
    // Use setTheme if available, otherwise use URL redirect
    if (typeof setTheme === 'function') {
        setTheme(theme);
    } else {
        localStorage.setItem('preferred_theme', theme);
        window.location.href = '/app?theme=' + theme;
    }
}

function showQRModal() {
    document.getElementById('qr-modal').classList.add('active');
    loadMyFriendCode();
}

function hideQRModal() {
    document.getElementById('qr-modal').classList.remove('active');
}

async function loadMyFriendCode() {
    const container = document.getElementById('qr-code-container');
    const codeText = document.getElementById('qr-code-text');

    container.innerHTML = 'Generating...';
    codeText.textContent = '';

    try {
        const res = await fetch('/api/v1/friend-code');
        const data = await res.json();
        if (data.success && data.data) {
            currentFriendCode = data.data;
            codeText.textContent = data.data.code;

            container.innerHTML = '';
            if (typeof QRCode !== 'undefined') {
                new QRCode(container, {
                    text: data.data.qr_data,
                    width: 100,
                    height: 100,
                    colorDark: '#000000',
                    colorLight: '#ffffff',
                    correctLevel: QRCode.CorrectLevel.M
                });
            }
        }
    } catch (err) {
        console.error('Failed to load friend code:', err);
        container.innerHTML = 'Error loading code';
    }
}

function copyFriendCode() {
    if (currentFriendCode?.code) {
        navigator.clipboard.writeText(currentFriendCode.code);
    }
}

function showChangePasswordModal() {
    document.getElementById('password-modal').classList.add('active');
    document.getElementById('password-form').reset();
    document.getElementById('password-error').classList.add('hidden');
}

function hideChangePasswordModal() {
    document.getElementById('password-modal').classList.remove('active');
}

async function handleChangePassword(e) {
    e.preventDefault();

    const currentPassword = document.getElementById('current-password').value;
    const newPassword = document.getElementById('new-password').value;
    const confirmPassword = document.getElementById('confirm-password').value;
    const errorDiv = document.getElementById('password-error');

    if (newPassword !== confirmPassword) {
        errorDiv.textContent = 'Passwords do not match';
        errorDiv.classList.remove('hidden');
        return;
    }

    try {
        const res = await fetch('/api/v1/users/me/password', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                current_password: currentPassword,
                new_password: newPassword
            })
        });

        const data = await res.json();
        if (data.success) {
            hideChangePasswordModal();
            alert('Password changed successfully');
        } else {
            errorDiv.textContent = data.error || 'Failed to change password';
            errorDiv.classList.remove('hidden');
        }
    } catch (err) {
        errorDiv.textContent = 'Failed to change password';
        errorDiv.classList.remove('hidden');
    }
}

async function signOut() {
    if (!confirm('Are you sure you want to sign out?')) return;

    try {
        await fetch('/api/v1/auth/logout', { method: 'POST' });
        window.location.href = '/login';
    } catch (err) {
        console.error('Failed to sign out:', err);
        window.location.href = '/login';
    }
}
</script>
{{end}}
