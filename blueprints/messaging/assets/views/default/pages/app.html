{{define "content"}}
<div class="h-screen flex overflow-hidden">
    <!-- Sidebar -->
    <aside id="sidebar" class="w-80 bg-secondary border-r border-default flex flex-col">
        <!-- Header -->
        <div class="h-16 px-4 flex items-center justify-between border-b border-default">
            <div class="flex items-center gap-3">
                <div id="user-avatar" class="w-10 h-10 rounded-full bg-tertiary flex items-center justify-center text-lg font-semibold text-primary"></div>
                <span id="user-name" class="font-medium text-primary"></span>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="showNewChatModal()" class="p-2 rounded-lg bg-hover text-secondary hover:text-primary" title="New chat">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                </button>
                <button onclick="toggleTheme()" class="p-2 rounded-lg bg-hover text-secondary hover:text-primary" title="Toggle theme">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/>
                    </svg>
                </button>
                <a href="/settings" class="p-2 rounded-lg bg-hover text-secondary hover:text-primary" title="Settings">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                </a>
            </div>
        </div>

        <!-- Search -->
        <div class="p-3">
            <div class="relative">
                <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                </svg>
                <input
                    id="search-input"
                    type="text"
                    placeholder="Search chats..."
                    class="w-full pl-10 pr-4 py-2 bg-tertiary border border-default rounded-lg text-primary placeholder-muted focus:outline-none focus:border-[#25D366]"
                    oninput="filterChats(this.value)"
                >
            </div>
        </div>

        <!-- Chat List -->
        <div id="chat-list" class="flex-1 overflow-y-auto">
            <!-- Chats will be populated here -->
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col">
        <!-- No chat selected state -->
        <div id="empty-state" class="flex-1 flex items-center justify-center">
            <div class="text-center max-w-md px-4">
                <div class="text-6xl mb-4">ðŸ’¬</div>
                <h2 class="text-xl font-semibold text-primary mb-2">Welcome to Messaging</h2>
                <p class="text-secondary mb-6">Select a chat from the sidebar or start a new conversation</p>
                <div class="space-y-3">
                    <button onclick="showNewChatModal()" class="w-full py-3 px-4 accent rounded-lg text-white font-medium hover:opacity-90 transition-opacity flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                        Start New Chat
                    </button>
                    <button onclick="openSavedMessages()" class="w-full py-3 px-4 bg-tertiary rounded-lg text-primary font-medium hover:bg-hover transition-colors flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/>
                        </svg>
                        Saved Messages
                    </button>
                </div>
            </div>
        </div>

        <!-- Chat view (hidden initially) -->
        <div id="chat-view" class="hidden flex-1 flex flex-col">
            <!-- Chat header -->
            <div class="h-16 px-4 flex items-center justify-between bg-secondary border-b border-default">
                <div class="flex items-center gap-3">
                    <button id="back-btn" class="md:hidden p-2 -ml-2 rounded-lg bg-hover" onclick="closeChat()">
                        <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                        </svg>
                    </button>
                    <div id="chat-avatar" class="w-10 h-10 rounded-full bg-tertiary flex items-center justify-center text-lg font-semibold text-primary"></div>
                    <div>
                        <h2 id="chat-name" class="font-medium text-primary"></h2>
                        <p id="chat-status" class="text-sm text-secondary"></p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <button class="p-2 rounded-lg bg-hover text-secondary hover:text-primary" title="Voice call">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                        </svg>
                    </button>
                    <button class="p-2 rounded-lg bg-hover text-secondary hover:text-primary" title="Video call">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                        </svg>
                    </button>
                    <button class="p-2 rounded-lg bg-hover text-secondary hover:text-primary" title="More options">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"/>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Messages area -->
            <div id="messages" class="flex-1 overflow-y-auto p-4 space-y-2">
                <!-- Messages will be populated here -->
            </div>

            <!-- Typing indicator -->
            <div id="typing-indicator" class="hidden px-4 py-2 text-sm text-secondary">
                <span id="typing-users"></span> typing...
            </div>

            <!-- Message input -->
            <div class="p-4 bg-secondary border-t border-default">
                <form id="message-form" class="flex items-end gap-3">
                    <button type="button" class="p-2 rounded-lg bg-hover text-secondary hover:text-primary" title="Attach file">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/>
                        </svg>
                    </button>
                    <div class="flex-1 relative">
                        <textarea
                            id="message-input"
                            rows="1"
                            placeholder="Type a message..."
                            class="w-full px-4 py-3 bg-tertiary border border-default rounded-2xl text-primary placeholder-muted focus:outline-none focus:border-[#25D366] resize-none max-h-32"
                            oninput="autoResize(this); sendTyping()"
                            onkeydown="handleKeyDown(event)"
                        ></textarea>
                    </div>
                    <button type="submit" class="p-3 accent rounded-full text-white">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                        </svg>
                    </button>
                </form>
            </div>
        </div>
    </main>
</div>

<!-- New Chat Modal -->
<div id="new-chat-modal" class="modal hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="bg-secondary rounded-2xl w-full max-w-md mx-4 p-6">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-semibold text-primary">New Chat</h3>
            <button onclick="hideNewChatModal()" class="p-2 rounded-lg bg-hover text-secondary hover:text-primary">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>

        <!-- Quick Actions -->
        <div class="mb-4 space-y-2">
            <button onclick="hideNewChatModal(); openSavedMessages();" class="w-full py-3 px-4 bg-tertiary rounded-lg text-primary font-medium hover:bg-hover transition-colors flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-blue-500 text-white flex items-center justify-center flex-shrink-0">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/>
                    </svg>
                </div>
                <div class="text-left">
                    <div class="font-medium">Saved Messages</div>
                    <div class="text-sm text-secondary">Save notes to yourself</div>
                </div>
            </button>
            <button onclick="showNewGroupModal()" class="w-full py-3 px-4 bg-tertiary rounded-lg text-primary font-medium hover:bg-hover transition-colors flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-green-500 text-white flex items-center justify-center flex-shrink-0">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                    </svg>
                </div>
                <div class="text-left">
                    <div class="font-medium">New Group</div>
                    <div class="text-sm text-secondary">Create a group chat</div>
                </div>
            </button>
        </div>

        <div class="border-t border-default pt-4">
            <input
                type="text"
                id="contact-search"
                placeholder="Search users by name or username..."
                class="w-full px-4 py-3 bg-tertiary border border-default rounded-lg text-primary placeholder-muted focus:outline-none focus:border-[#25D366] mb-4"
                oninput="searchUsers(this.value)"
            >
            <div id="contact-list" class="max-h-60 overflow-y-auto space-y-2">
                <div class="text-center text-secondary py-4">
                    <p>Type to search for users</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// App state
let currentUser = null;
let currentChat = null;
let chats = [];
let messages = [];
let ws = null;
let typingTimeout = null;

// Initialize app
document.addEventListener('DOMContentLoaded', async () => {
    await loadCurrentUser();
    await ensureUserChats();
    await loadChats();
    connectWebSocket();
});

// Ensure user has default chats (Saved Messages + Agent chat)
async function ensureUserChats() {
    try {
        await fetch('/api/v1/users/ensure-chats', { method: 'POST' });
    } catch (err) {
        console.error('Failed to ensure user chats:', err);
    }
}

// Load current user
async function loadCurrentUser() {
    try {
        const res = await fetch('/api/v1/users/me');
        const data = await res.json();
        if (data.success && data.data) {
            currentUser = data.data;
            document.getElementById('user-name').textContent = currentUser.display_name || currentUser.username;
            document.getElementById('user-avatar').textContent = (currentUser.display_name || currentUser.username).charAt(0).toUpperCase();
        } else {
            window.location.href = '/login';
        }
    } catch (err) {
        console.error('Failed to load user:', err);
        window.location.href = '/login';
    }
}

// Load chats
async function loadChats() {
    const chatList = document.getElementById('chat-list');
    chatList.innerHTML = `
        <div class="p-4 text-center">
            <div class="animate-pulse flex flex-col gap-3">
                <div class="h-16 bg-tertiary rounded-lg"></div>
                <div class="h-16 bg-tertiary rounded-lg"></div>
                <div class="h-16 bg-tertiary rounded-lg"></div>
            </div>
        </div>
    `;

    try {
        const res = await fetch('/api/v1/chats');
        const data = await res.json();
        if (data.success) {
            chats = data.data || [];
            renderChatList();
        } else {
            showError('Failed to load chats');
        }
    } catch (err) {
        console.error('Failed to load chats:', err);
        showError('Failed to load chats');
    }
}

// Show error notification
function showError(message) {
    // Simple error display - append to body temporarily
    const errorDiv = document.createElement('div');
    errorDiv.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
    errorDiv.textContent = message;
    document.body.appendChild(errorDiv);
    setTimeout(() => errorDiv.remove(), 3000);
}

// Render chat list
function renderChatList() {
    const chatList = document.getElementById('chat-list');
    if (chats.length === 0) {
        chatList.innerHTML = `
            <div class="p-4 text-center text-secondary">
                <p>No chats yet</p>
                <p class="text-sm mt-1">Start a new conversation!</p>
                <button onclick="showNewChatModal()" class="mt-3 px-4 py-2 accent rounded-lg text-white text-sm font-medium">
                    New Chat
                </button>
            </div>
        `;
        return;
    }

    chatList.innerHTML = chats.map(chat => {
        // Check if this is a self-chat (Saved Messages)
        const isSelfChat = chat.type === 'direct' && chat.other_user?.id === currentUser?.id;
        const isAgent = chat.type === 'direct' && chat.other_user?.username === 'mizu-agent';

        let name, avatarContent, avatarClass;
        if (isSelfChat) {
            name = 'Saved Messages';
            avatarContent = '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/></svg>';
            avatarClass = 'bg-blue-500 text-white';
        } else if (isAgent) {
            name = chat.other_user?.display_name || 'Mizu Agent';
            avatarContent = '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>';
            avatarClass = 'bg-purple-500 text-white';
        } else if (chat.type === 'direct') {
            name = chat.other_user?.display_name || chat.other_user?.username;
            avatarContent = name ? name.charAt(0).toUpperCase() : '?';
            avatarClass = 'bg-tertiary text-primary';
        } else {
            name = chat.group_name || chat.name;
            avatarContent = name ? name.charAt(0).toUpperCase() : '?';
            avatarClass = 'bg-tertiary text-primary';
        }

        const lastMsg = chat.last_message;
        const time = lastMsg ? formatTime(lastMsg.created_at) : '';
        const unread = chat.unread_count || 0;
        const isActive = currentChat?.id === chat.id;

        return `
            <div
                class="flex items-center gap-3 p-3 mx-2 rounded-lg cursor-pointer ${isActive ? 'bg-tertiary' : 'bg-hover'}"
                onclick="selectChat('${chat.id}')"
            >
                <div class="w-12 h-12 rounded-full ${avatarClass} flex items-center justify-center text-lg font-semibold flex-shrink-0">
                    ${avatarContent}
                </div>
                <div class="flex-1 min-w-0">
                    <div class="flex items-center justify-between">
                        <span class="font-medium text-primary truncate">${escapeHtml(name)}</span>
                        <span class="text-xs text-muted flex-shrink-0">${time}</span>
                    </div>
                    <div class="flex items-center justify-between mt-1">
                        <span class="text-sm text-secondary truncate">${lastMsg ? escapeHtml(lastMsg.content || 'Media') : 'No messages yet'}</span>
                        ${unread > 0 ? `<span class="ml-2 w-5 h-5 rounded-full accent text-white text-xs flex items-center justify-center flex-shrink-0">${unread > 99 ? '99+' : unread}</span>` : ''}
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

// Filter chats by search query
function filterChats(query) {
    const q = query.toLowerCase();
    const items = document.querySelectorAll('#chat-list > div');
    items.forEach(item => {
        const name = item.querySelector('.font-medium')?.textContent.toLowerCase() || '';
        item.style.display = name.includes(q) ? 'flex' : 'none';
    });
}

// Select a chat
async function selectChat(chatId) {
    currentChat = chats.find(c => c.id === chatId);
    if (!currentChat) return;

    document.getElementById('empty-state').classList.add('hidden');
    document.getElementById('chat-view').classList.remove('hidden');

    // Check if this is a self-chat (Saved Messages)
    const isSelfChat = currentChat.type === 'direct' && currentChat.other_user?.id === currentUser?.id;
    const isAgent = currentChat.type === 'direct' && currentChat.other_user?.username === 'mizu-agent';

    let name, avatarHtml, status;
    const avatarEl = document.getElementById('chat-avatar');

    if (isSelfChat) {
        name = 'Saved Messages';
        avatarEl.innerHTML = '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/></svg>';
        avatarEl.className = 'w-10 h-10 rounded-full bg-blue-500 text-white flex items-center justify-center text-lg font-semibold';
        status = 'Your personal notes';
    } else if (isAgent) {
        name = currentChat.other_user?.display_name || 'Mizu Agent';
        avatarEl.innerHTML = '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>';
        avatarEl.className = 'w-10 h-10 rounded-full bg-purple-500 text-white flex items-center justify-center text-lg font-semibold';
        status = 'AI Assistant';
    } else if (currentChat.type === 'direct') {
        name = currentChat.other_user?.display_name || currentChat.other_user?.username;
        avatarEl.textContent = name ? name.charAt(0).toUpperCase() : '?';
        avatarEl.className = 'w-10 h-10 rounded-full bg-tertiary flex items-center justify-center text-lg font-semibold text-primary';
        status = 'Online';
    } else {
        name = currentChat.group_name || currentChat.name;
        avatarEl.textContent = name ? name.charAt(0).toUpperCase() : '?';
        avatarEl.className = 'w-10 h-10 rounded-full bg-tertiary flex items-center justify-center text-lg font-semibold text-primary';
        status = `${currentChat.participant_count || 0} members`;
    }

    document.getElementById('chat-name').textContent = name;
    document.getElementById('chat-status').textContent = status;

    renderChatList(); // Update active state
    await loadMessages(chatId);

    // Mark as read
    markAsRead(chatId);
}

// Open Saved Messages (self-chat)
async function openSavedMessages() {
    // Check if saved messages chat already exists
    const savedChat = chats.find(c =>
        c.type === 'direct' && c.other_user?.id === currentUser?.id
    );

    if (savedChat) {
        selectChat(savedChat.id);
        return;
    }

    // Create saved messages chat (chat with self)
    try {
        const res = await fetch('/api/v1/chats', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                type: 'direct',
                recipient_id: currentUser.id
            })
        });

        const data = await res.json();
        if (data.success && data.data) {
            // Refresh chats to get the new one with proper user info
            await loadChats();
            selectChat(data.data.id);
        }
    } catch (err) {
        console.error('Failed to create saved messages:', err);
    }
}

// Close chat (mobile)
function closeChat() {
    currentChat = null;
    document.getElementById('empty-state').classList.remove('hidden');
    document.getElementById('chat-view').classList.add('hidden');
    renderChatList();
}

// Load messages for a chat
async function loadMessages(chatId) {
    const container = document.getElementById('messages');
    container.innerHTML = `
        <div class="flex items-center justify-center h-full">
            <div class="animate-spin w-8 h-8 border-2 border-[#25D366] border-t-transparent rounded-full"></div>
        </div>
    `;

    try {
        const res = await fetch(`/api/v1/chats/${chatId}/messages`);
        const data = await res.json();
        if (data.success) {
            messages = data.data || [];
            renderMessages();
            scrollToBottom();
        } else {
            showError('Failed to load messages');
        }
    } catch (err) {
        console.error('Failed to load messages:', err);
        showError('Failed to load messages');
    }
}

// Render messages
function renderMessages() {
    const container = document.getElementById('messages');
    if (messages.length === 0) {
        container.innerHTML = `
            <div class="text-center text-secondary py-8">
                <p>No messages yet</p>
                <p class="text-sm mt-1">Send a message to start the conversation</p>
            </div>
        `;
        return;
    }

    let lastDate = null;
    container.innerHTML = messages.map(msg => {
        const isSent = msg.sender_id === currentUser?.id;
        const msgDate = new Date(msg.created_at).toLocaleDateString();
        let dateHeader = '';

        if (msgDate !== lastDate) {
            lastDate = msgDate;
            dateHeader = `<div class="text-center my-4"><span class="px-3 py-1 bg-tertiary rounded-full text-xs text-secondary">${formatDate(msg.created_at)}</span></div>`;
        }

        const statusIcon = isSent ? getStatusIcon(msg.status) : '';

        return `
            ${dateHeader}
            <div class="flex ${isSent ? 'justify-end' : 'justify-start'}">
                <div class="${isSent ? 'sent-bubble' : 'received-bubble'} rounded-2xl px-4 py-2 max-w-[70%] ${isSent ? 'rounded-br-md' : 'rounded-bl-md'}">
                    ${!isSent && currentChat?.type === 'group' ? `<div class="text-xs text-[#25D366] font-medium mb-1">${escapeHtml(msg.sender_name || 'Unknown')}</div>` : ''}
                    <div class="text-primary whitespace-pre-wrap break-words">${escapeHtml(msg.content)}</div>
                    <div class="flex items-center justify-end gap-1 mt-1">
                        <span class="text-xs text-muted">${formatTime(msg.created_at)}</span>
                        ${statusIcon}
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

// Get status icon for message
function getStatusIcon(status) {
    switch(status) {
        case 'read':
            return '<span class="text-[#53bdeb] text-xs">âœ“âœ“</span>';
        case 'delivered':
            return '<span class="text-muted text-xs">âœ“âœ“</span>';
        case 'sent':
        default:
            return '<span class="text-muted text-xs">âœ“</span>';
    }
}

// Scroll to bottom of messages
function scrollToBottom() {
    const container = document.getElementById('messages');
    container.scrollTop = container.scrollHeight;
}

// Mark messages as read
async function markAsRead(chatId) {
    try {
        await fetch(`/api/v1/chats/${chatId}/read`, { method: 'POST' });
        const chat = chats.find(c => c.id === chatId);
        if (chat) chat.unread_count = 0;
        renderChatList();
    } catch (err) {
        console.error('Failed to mark as read:', err);
    }
}

// Handle message form submission
document.getElementById('message-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const input = document.getElementById('message-input');
    const content = input.value.trim();

    if (!content || !currentChat) return;

    input.value = '';
    autoResize(input);

    try {
        const res = await fetch(`/api/v1/chats/${currentChat.id}/messages`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content })
        });

        const data = await res.json();
        if (data.success && data.data) {
            messages.push(data.data);
            renderMessages();
            scrollToBottom();

            // Update chat in list
            currentChat.last_message = data.data;
            renderChatList();
        }
    } catch (err) {
        console.error('Failed to send message:', err);
    }
});

// Handle Enter key (Shift+Enter for new line)
function handleKeyDown(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        document.getElementById('message-form').dispatchEvent(new Event('submit'));
    }
}

// Auto-resize textarea
function autoResize(el) {
    el.style.height = 'auto';
    el.style.height = Math.min(el.scrollHeight, 128) + 'px';
}

// WebSocket connection
function connectWebSocket() {
    const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
    ws = new WebSocket(`${protocol}//${location.host}/ws`);

    ws.onopen = () => {
        console.log('WebSocket connected');
    };

    ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        handleWebSocketMessage(data);
    };

    ws.onclose = () => {
        console.log('WebSocket disconnected, reconnecting...');
        setTimeout(connectWebSocket, 3000);
    };

    ws.onerror = (err) => {
        console.error('WebSocket error:', err);
    };
}

// Handle incoming WebSocket messages
function handleWebSocketMessage(data) {
    switch(data.type) {
        case 'new_message':
            handleNewMessage(data.message);
            break;
        case 'message_status':
            handleMessageStatus(data);
            break;
        case 'typing':
            handleTyping(data);
            break;
        case 'presence':
            handlePresence(data);
            break;
    }
}

// Handle new message from WebSocket
function handleNewMessage(msg) {
    // Update chat list
    const chat = chats.find(c => c.id === msg.chat_id);
    if (chat) {
        chat.last_message = msg;
        if (currentChat?.id !== msg.chat_id) {
            chat.unread_count = (chat.unread_count || 0) + 1;
        }
        // Move to top
        chats = [chat, ...chats.filter(c => c.id !== chat.id)];
        renderChatList();
    }

    // Add to current chat
    if (currentChat?.id === msg.chat_id) {
        messages.push(msg);
        renderMessages();
        scrollToBottom();
        markAsRead(msg.chat_id);
    }
}

// Handle message status update
function handleMessageStatus(data) {
    if (currentChat?.id === data.chat_id) {
        const msg = messages.find(m => m.id === data.message_id);
        if (msg) {
            msg.status = data.status;
            renderMessages();
        }
    }
}

// Handle typing indicator
function handleTyping(data) {
    if (currentChat?.id === data.chat_id && data.user_id !== currentUser?.id) {
        const indicator = document.getElementById('typing-indicator');
        const usersSpan = document.getElementById('typing-users');
        usersSpan.textContent = data.user_name || 'Someone';
        indicator.classList.remove('hidden');

        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
            indicator.classList.add('hidden');
        }, 3000);
    }
}

// Handle presence update
function handlePresence(data) {
    if (currentChat?.type === 'direct' && currentChat?.other_user?.id === data.user_id) {
        document.getElementById('chat-status').textContent = data.online ? 'Online' : 'Offline';
    }
}

// Send typing indicator
let lastTypingSent = 0;
function sendTyping() {
    if (!currentChat || !ws || ws.readyState !== WebSocket.OPEN) return;

    const now = Date.now();
    if (now - lastTypingSent > 2000) {
        lastTypingSent = now;
        ws.send(JSON.stringify({
            type: 'typing',
            chat_id: currentChat.id
        }));
    }
}

// Modal functions
function showNewChatModal() {
    document.getElementById('new-chat-modal').classList.remove('hidden');
    document.getElementById('contact-search').value = '';
    showRecentContacts();
}

// Show recent contacts from existing chats
function showRecentContacts() {
    const list = document.getElementById('contact-list');

    // Extract unique users from existing chats
    const recentUsers = [];
    const seenIds = new Set();

    for (const chat of chats) {
        if (chat.type === 'direct' && chat.other_user) {
            const user = chat.other_user;
            // Skip current user (Saved Messages) but include Agent
            if (user.id !== currentUser?.id && !seenIds.has(user.id)) {
                seenIds.add(user.id);
                recentUsers.push(user);
            }
        }
    }

    if (recentUsers.length === 0) {
        list.innerHTML = '<div class="text-center text-secondary py-4"><p>Type to search for users</p></div>';
        return;
    }

    let html = '<div class="text-xs text-muted uppercase tracking-wide mb-2 px-1">Recent</div>';
    html += recentUsers.slice(0, 5).map(user => {
        const isAgent = user.username === 'mizu-agent';
        let avatarContent, avatarClass;

        if (isAgent) {
            avatarContent = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>';
            avatarClass = 'bg-purple-500 text-white';
        } else {
            avatarContent = (user.display_name || user.username || '?').charAt(0).toUpperCase();
            avatarClass = 'bg-tertiary text-primary';
        }

        return `
            <div
                class="flex items-center gap-3 p-3 rounded-lg cursor-pointer bg-hover"
                onclick="startChat('${user.id}')"
            >
                <div class="w-10 h-10 rounded-full ${avatarClass} flex items-center justify-center font-semibold flex-shrink-0">
                    ${avatarContent}
                </div>
                <div>
                    <div class="font-medium text-primary">${escapeHtml(user.display_name || user.username)}</div>
                    ${user.display_name ? `<div class="text-sm text-secondary">@${escapeHtml(user.username)}</div>` : ''}
                </div>
            </div>
        `;
    }).join('');

    html += '<div class="text-xs text-muted text-center py-2 mt-2 border-t border-default">Or search for more users above</div>';
    list.innerHTML = html;
}

function hideNewChatModal() {
    document.getElementById('new-chat-modal').classList.add('hidden');
}

function showNewGroupModal() {
    // TODO: Implement group creation modal
    alert('Group creation coming soon!');
}

// Search users by query
let searchTimeout = null;
async function searchUsers(query) {
    clearTimeout(searchTimeout);

    const list = document.getElementById('contact-list');

    if (query.trim().length < 2) {
        list.innerHTML = '<div class="text-center text-secondary py-4"><p>Type to search for users</p></div>';
        return;
    }

    list.innerHTML = '<div class="text-center text-secondary py-4"><p>Searching...</p></div>';

    // Debounce the search
    searchTimeout = setTimeout(async () => {
        try {
            const res = await fetch(`/api/v1/users/search?q=${encodeURIComponent(query)}`);
            const data = await res.json();
            if (data.success) {
                renderUserList(data.data || []);
            }
        } catch (err) {
            console.error('Failed to search users:', err);
            list.innerHTML = '<div class="text-center text-secondary py-4"><p>Search failed</p></div>';
        }
    }, 300);
}

// Render user list for new chat
function renderUserList(users) {
    const list = document.getElementById('contact-list');

    // Filter out current user from the list (they can use Saved Messages instead)
    const filteredUsers = users.filter(u => u.id !== currentUser?.id);

    if (filteredUsers.length === 0) {
        list.innerHTML = '<div class="text-center text-secondary py-4">No users found</div>';
        return;
    }

    list.innerHTML = filteredUsers.map(user => {
        const isAgent = user.username === 'mizu-agent';
        let avatarContent, avatarClass;

        if (isAgent) {
            avatarContent = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>';
            avatarClass = 'bg-purple-500 text-white';
        } else {
            avatarContent = (user.display_name || user.username || '?').charAt(0).toUpperCase();
            avatarClass = 'bg-tertiary text-primary';
        }

        return `
            <div
                class="flex items-center gap-3 p-3 rounded-lg cursor-pointer bg-hover"
                onclick="startChat('${user.id}')"
            >
                <div class="w-10 h-10 rounded-full ${avatarClass} flex items-center justify-center font-semibold flex-shrink-0">
                    ${avatarContent}
                </div>
                <div>
                    <div class="font-medium text-primary">${escapeHtml(user.display_name || user.username)}</div>
                    ${user.display_name ? `<div class="text-sm text-secondary">@${escapeHtml(user.username)}</div>` : ''}
                </div>
            </div>
        `;
    }).join('');
}

// Start chat with contact
async function startChat(contactId) {
    try {
        const res = await fetch('/api/v1/chats', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                type: 'direct',
                recipient_id: contactId
            })
        });

        const data = await res.json();
        if (data.success && data.data) {
            hideNewChatModal();
            if (!chats.find(c => c.id === data.data.id)) {
                chats.unshift(data.data);
            }
            renderChatList();
            selectChat(data.data.id);
        }
    } catch (err) {
        console.error('Failed to create chat:', err);
    }
}

// Utility functions
function escapeHtml(str) {
    if (!str) return '';
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

function formatTime(dateStr) {
    const date = new Date(dateStr);
    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}

function formatDate(dateStr) {
    const date = new Date(dateStr);
    const today = new Date();
    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);

    if (date.toDateString() === today.toDateString()) {
        return 'Today';
    } else if (date.toDateString() === yesterday.toDateString()) {
        return 'Yesterday';
    } else {
        return date.toLocaleDateString([], { weekday: 'long', month: 'short', day: 'numeric' });
    }
}
</script>
{{end}}
