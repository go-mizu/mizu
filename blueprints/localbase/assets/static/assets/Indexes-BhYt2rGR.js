import{h as O,y as i,j as e,G as u,$ as C,a as x,A as U,e as S,O as re,Q as ie,S as _,q as oe,T as p,a2 as t,d as ce,f as de,b as R,a3 as ue,a0 as he}from"./vendor-mantine-C8lHRUHi.js";import{r as a}from"./vendor-react-CFPnf9wS.js";import{P as me}from"./PageContainer-Czy__zFQ.js";import{E as xe}from"./EmptyState-BPjdg75G.js";import{C as pe}from"./ConfirmModal-BSlXvWzg.js";import{d as y}from"./database-CiK1Mmeb.js";import{p as T}from"./pgmeta-Ch70PY3U.js";import{$ as je,V as ge,k as be,U as fe,Z as Ce}from"./vendor-icons-rGG861t1.js";import"./client-CvoVCtJO.js";const Se=[{value:"btree",label:"B-tree (default)"},{value:"hash",label:"Hash"},{value:"gin",label:"GIN (Generalized Inverted Index)"},{value:"gist",label:"GiST (Generalized Search Tree)"},{value:"spgist",label:"SP-GiST"},{value:"brin",label:"BRIN (Block Range Index)"}];function De(){const[n,$]=a.useState("public"),[H,W]=a.useState([]),[o,K]=a.useState([]),[V,Y]=a.useState([]),[Q,I]=a.useState(!0),[X,{open:v,close:j}]=O(!1),[Z,{open:J,close:w}]=O(!1),[c,z]=a.useState(null),[g,E]=a.useState(""),[r,k]=a.useState(null),[b,q]=a.useState([]),[D,M]=a.useState("btree"),[N,P]=a.useState(!1),[L,B]=a.useState(""),[ee,f]=a.useState([]),[G,m]=a.useState(!1),A=a.useCallback(async()=>{try{const s=await y.listSchemas();W(s??[])}catch(s){i.show({title:"Error",message:s.message||"Failed to load schemas",color:"red"})}},[]),h=a.useCallback(async()=>{I(!0);try{const[s,d]=await Promise.all([T.listIndexes(n),y.listTables(n)]);K(s??[]),Y(d??[])}catch(s){i.show({title:"Error",message:s.message||"Failed to load indexes",color:"red"})}finally{I(!1)}},[n]);a.useEffect(()=>{A()},[A]),a.useEffect(()=>{h()},[h]),a.useEffect(()=>{r?y.listColumns(n,r).then(f).catch(()=>{f([])}):f([])},[n,r]);const se=async()=>{if(!g.trim()||!r||b.length===0){i.show({title:"Validation Error",message:"Index name, table, and at least one column are required",color:"red"});return}m(!0);try{await T.createIndex({schema:n,table:r,name:g,columns:b,unique:N,using:D,where:L||void 0}),i.show({title:"Success",message:"Index created successfully",color:"green"}),j(),te(),h()}catch(s){i.show({title:"Error",message:s.message||"Failed to create index",color:"red"})}finally{m(!1)}},ae=async()=>{if(c){m(!0);try{await T.dropIndex(c.schema,c.name),i.show({title:"Success",message:"Index deleted successfully",color:"green"}),w(),z(null),h()}catch(s){i.show({title:"Error",message:s.message||"Failed to delete index",color:"red"})}finally{m(!1)}}},te=()=>{E(""),k(null),q([]),M("btree"),P(!1),B("")},le=s=>{z(s),J()},ne=(o??[]).reduce((s,d)=>{const l=d.table;return s[l]||(s[l]=[]),s[l].push(d),s},{});return e.jsxs(me,{title:"Indexes",description:"Manage database indexes for query optimization",children:[e.jsxs(u,{justify:"space-between",mb:"lg",children:[e.jsxs(u,{gap:"md",children:[e.jsx(C,{size:"sm",value:n,onChange:s=>s&&$(s),data:H.map(s=>({value:s,label:s})),placeholder:"Select schema",w:150}),e.jsxs(x,{variant:"light",color:"blue",size:"lg",children:[(o==null?void 0:o.length)??0," indexes"]})]}),e.jsxs(u,{gap:"sm",children:[e.jsx(U,{variant:"subtle",onClick:h,children:e.jsx(je,{size:18})}),e.jsx(S,{leftSection:e.jsx(ge,{size:16}),onClick:v,children:"New Index"})]})]}),Q?e.jsx(re,{py:"xl",children:e.jsx(ie,{size:"lg"})}):!o||o.length===0?e.jsx(xe,{icon:e.jsx(be,{size:48}),title:"No indexes found",description:"Create indexes to optimize query performance",action:{label:"Create Index",onClick:v}}):e.jsx(_,{gap:"md",children:Object.entries(ne).map(([s,d])=>e.jsxs(oe,{shadow:"xs",p:"md",withBorder:!0,children:[e.jsx(p,{fw:500,mb:"md",children:s}),e.jsxs(t,{striped:!0,highlightOnHover:!0,children:[e.jsx(t.Thead,{children:e.jsxs(t.Tr,{children:[e.jsx(t.Th,{children:"Name"}),e.jsx(t.Th,{children:"Type"}),e.jsx(t.Th,{children:"Columns"}),e.jsx(t.Th,{children:"Unique"}),e.jsx(t.Th,{children:"Size"}),e.jsx(t.Th,{w:60})]})}),e.jsx(t.Tbody,{children:d.map(l=>e.jsxs(t.Tr,{children:[e.jsx(t.Td,{children:e.jsxs(u,{gap:"xs",children:[l.is_primary&&e.jsx(ce,{label:"Primary Key",children:e.jsx(fe,{size:14,color:"var(--mantine-color-yellow-6)"})}),e.jsx(p,{size:"sm",fw:500,children:l.name})]})}),e.jsx(t.Td,{children:e.jsx(x,{size:"sm",variant:"light",children:l.using})}),e.jsx(t.Td,{children:e.jsx(u,{gap:4,children:l.columns.map(F=>e.jsx(x,{size:"xs",variant:"outline",children:F},F))})}),e.jsx(t.Td,{children:l.is_unique?e.jsx(x,{size:"sm",color:"green",children:"Yes"}):e.jsx(p,{size:"sm",c:"dimmed",children:"No"})}),e.jsx(t.Td,{children:e.jsx(p,{size:"sm",children:l.size||"â€”"})}),e.jsx(t.Td,{children:!l.is_primary&&e.jsx(U,{variant:"subtle",color:"red",onClick:()=>le(l),children:e.jsx(Ce,{size:16})})})]},l.name))})]})]},s))}),e.jsx(de,{opened:X,onClose:j,title:"Create index",size:"md",children:e.jsxs(_,{gap:"md",children:[e.jsx(R,{label:"Index name",placeholder:"idx_table_column",value:g,onChange:s=>E(s.target.value),required:!0}),e.jsx(C,{label:"Table",description:"Select the table to create an index on",value:r,onChange:k,data:V.map(s=>({value:s.name,label:s.name})),placeholder:"Select table",searchable:!0,required:!0}),e.jsx(ue,{label:"Columns",description:"Select columns to include in the index",value:b,onChange:q,data:ee.map(s=>({value:s.name,label:`${s.name} (${s.type})`})),placeholder:"Select columns",disabled:!r,required:!0}),e.jsx(C,{label:"Index type",value:D,onChange:s=>s&&M(s),data:Se}),e.jsx(he,{label:"Unique index",description:"Enforce unique values in the indexed columns",checked:N,onChange:s=>P(s.currentTarget.checked)}),e.jsx(R,{label:"WHERE condition (optional)",description:"Create a partial index with a condition",placeholder:"column IS NOT NULL",value:L,onChange:s=>B(s.target.value)}),e.jsxs(u,{justify:"flex-end",mt:"md",children:[e.jsx(S,{variant:"outline",onClick:j,children:"Cancel"}),e.jsx(S,{onClick:se,loading:G,children:"Create Index"})]})]})}),e.jsx(pe,{opened:Z,onClose:w,onConfirm:ae,title:"Delete index",message:`Are you sure you want to delete the index "${c==null?void 0:c.name}"? This may affect query performance.`,confirmLabel:"Delete",danger:!0,loading:G})]})}export{De as IndexesPage};
