var ce=Object.defineProperty;var re=(o,n,t)=>n in o?ce(o,n,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[n]=t;var m=(o,n,t)=>re(o,typeof n!="symbol"?n+"":n,t);import{y as N,j as e,p as E,t as u,G as c,T as a,s as k,R as S,a as j,z as x,A as D,Q as M,S as g,q as b,O as le,X as F,E as G,B as oe,a4 as i,I as P,F as A,b as de,e as $,d as he}from"./vendor-mantine-BXMqcLry.js";import{r as l}from"./vendor-react-CFPnf9wS.js";import{P as xe}from"./PageContainer-QI0M3bfS.js";import{E as K}from"./EmptyState-T2jupwgE.js";import{a as _}from"./client-CvoVCtJO.js";import{l as q,n as f,h as B,t as me,an as je,Z as Q,aD as pe,W as V,I as ue,j as ge,V as be}from"./vendor-icons-q9-fAAJw.js";const H={getStats:()=>_.get("/api/realtime/stats"),listChannels:()=>_.get("/api/realtime/channels"),getWebSocketUrl:()=>{const o=window.location.protocol==="https:"?"wss:":"ws:",n=localStorage.getItem("serviceKey")||"";return`${o}//${window.location.host}/realtime/v1/websocket?apikey=${n}`}};class fe{constructor(){m(this,"ws",null);m(this,"reconnectAttempts",0);m(this,"maxReconnectAttempts",5);m(this,"reconnectDelay",1e3);m(this,"messageHandlers",[]);m(this,"connectionHandlers",[])}connect(){var t;if(((t=this.ws)==null?void 0:t.readyState)===WebSocket.OPEN)return;const n=H.getWebSocketUrl();this.ws=new WebSocket(n),this.ws.onopen=()=>{this.reconnectAttempts=0,this.notifyConnectionChange(!0)},this.ws.onclose=()=>{this.notifyConnectionChange(!1),this.attemptReconnect()},this.ws.onerror=()=>{this.notifyConnectionChange(!1)},this.ws.onmessage=I=>{try{const d=JSON.parse(I.data);this.notifyMessage(d)}catch{}}}disconnect(){this.ws&&(this.ws.close(),this.ws=null)}send(n){var t;((t=this.ws)==null?void 0:t.readyState)===WebSocket.OPEN&&this.ws.send(JSON.stringify(n))}subscribe(n){this.send({type:"subscribe",channel:n})}unsubscribe(n){this.send({type:"unsubscribe",channel:n})}onMessage(n){return this.messageHandlers.push(n),()=>{this.messageHandlers=this.messageHandlers.filter(t=>t!==n)}}onConnectionChange(n){return this.connectionHandlers.push(n),()=>{this.connectionHandlers=this.connectionHandlers.filter(t=>t!==n)}}notifyMessage(n){this.messageHandlers.forEach(t=>t(n))}notifyConnectionChange(n){this.connectionHandlers.forEach(t=>t(n))}attemptReconnect(){if(this.reconnectAttempts>=this.maxReconnectAttempts)return;this.reconnectAttempts++;const n=this.reconnectDelay*Math.pow(2,this.reconnectAttempts-1);setTimeout(()=>{this.connect()},n)}}const U=new fe;function ke(){const[o,n]=l.useState("inspector"),[t,I]=l.useState(null),[d,X]=l.useState([]),[R,W]=l.useState([]),[C,Z]=l.useState(!1),[w,L]=l.useState(!0),[r,h]=l.useState({maxChannelConnections:100,maxConcurrentUsers:200,maxEventsPerSecond:100,maxJoinReferences:10,poolSize:5,enablePresence:!0,enableBroadcast:!0,enablePostgresChanges:!0,publicChannelAccess:!1}),[v,O]=l.useState([{id:"1",pattern:"private:*",type:"deny",description:"Block public access to private channels"}]),[z,J]=l.useState(""),T=l.useCallback(async()=>{L(!0);try{const[s,y]=await Promise.all([H.getStats(),H.listChannels()]);I(s),X(y||[])}catch(s){N.show({title:"Error",message:s.message||"Failed to load realtime data",color:"red"})}finally{L(!1)}},[]);l.useEffect(()=>{T();const s=U.onConnectionChange(p=>{Z(p),p&&N.show({title:"Connected",message:"WebSocket connection established",color:"green"})}),y=U.onMessage(p=>{W(ae=>[{id:crypto.randomUUID(),timestamp:new Date,type:p.type||"unknown",channel:p.channel,payload:p},...ae.slice(0,99)])});U.connect();const ie=setInterval(T,1e4);return()=>{s(),y(),clearInterval(ie)}},[T]);const Y=()=>{W([])},ee=s=>s.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}),se=()=>{N.show({title:"Settings Saved",message:"Realtime settings have been updated",color:"green"})},ne=()=>{z.trim()&&(O([...v,{id:crypto.randomUUID(),pattern:z,type:"deny",description:""}]),J(""))},te=s=>{O(v.filter(y=>y.id!==s))};return e.jsxs(xe,{title:"Realtime",description:"Monitor WebSocket connections, messages, and configure realtime settings",children:[e.jsxs(E,{cols:{base:1,sm:4},spacing:"lg",mb:"xl",children:[e.jsxs(u,{className:"supabase-stat-card",children:[e.jsxs(c,{justify:"space-between",mb:"xs",children:[e.jsx(a,{size:"sm",c:"dimmed",fw:500,children:"Active Connections"}),e.jsx(k,{size:"lg",variant:"light",color:"blue",radius:"md",children:e.jsx(q,{size:20})})]}),w?e.jsx(S,{size:"sm"}):e.jsx(a,{className:"supabase-stat-value",children:(t==null?void 0:t.connections)??0})]}),e.jsxs(u,{className:"supabase-stat-card",children:[e.jsxs(c,{justify:"space-between",mb:"xs",children:[e.jsx(a,{size:"sm",c:"dimmed",fw:500,children:"Active Channels"}),e.jsx(k,{size:"lg",variant:"light",color:"violet",radius:"md",children:e.jsx(f,{size:20})})]}),w?e.jsx(S,{size:"sm"}):e.jsx(a,{className:"supabase-stat-value",children:(t==null?void 0:t.channels)??0})]}),e.jsxs(u,{className:"supabase-stat-card",children:[e.jsxs(c,{justify:"space-between",mb:"xs",children:[e.jsx(a,{size:"sm",c:"dimmed",fw:500,children:"Messages / sec"}),e.jsx(k,{size:"lg",variant:"light",color:"orange",radius:"md",children:e.jsx(B,{size:20})})]}),w?e.jsx(S,{size:"sm"}):e.jsx(a,{className:"supabase-stat-value",children:(t==null?void 0:t.messagesPerSecond)??0})]}),e.jsxs(u,{className:"supabase-stat-card",children:[e.jsxs(c,{justify:"space-between",mb:"xs",children:[e.jsx(a,{size:"sm",c:"dimmed",fw:500,children:"Connection Status"}),e.jsx(k,{size:"lg",variant:"light",color:C?"green":"red",radius:"md",children:e.jsx(B,{size:20})})]}),e.jsx(j,{size:"lg",color:C?"green":"red",variant:"light",children:C?"Connected":"Disconnected"})]})]}),e.jsxs(x,{value:o,onChange:n,children:[e.jsxs(x.List,{mb:"lg",children:[e.jsx(x.Tab,{value:"inspector",leftSection:e.jsx(f,{size:16}),children:"Inspector"}),e.jsx(x.Tab,{value:"channels",leftSection:e.jsx(q,{size:16}),children:"Channels"}),e.jsx(x.Tab,{value:"settings",leftSection:e.jsx(me,{size:16}),children:"Settings"})]}),e.jsx(x.Panel,{value:"inspector",children:e.jsxs(E,{cols:{base:1,lg:2},spacing:"lg",children:[e.jsxs(u,{className:"supabase-section",children:[e.jsxs(c,{justify:"space-between",mb:"md",children:[e.jsx(a,{fw:600,children:"Active Channels"}),e.jsx(D,{variant:"subtle",onClick:T,children:e.jsx(je,{size:18})})]}),w?e.jsx(M,{py:"xl",children:e.jsx(S,{size:"sm"})}):!d||d.length===0?e.jsx(K,{icon:e.jsx(f,{size:32}),title:"No active channels",description:"Channels will appear here when clients subscribe"}):e.jsx(g,{gap:"xs",children:d.map(s=>e.jsx(b,{p:"sm",style:{border:"1px solid var(--supabase-border)",borderRadius:6},children:e.jsxs(c,{justify:"space-between",children:[e.jsxs(c,{gap:"xs",children:[e.jsx(f,{size:16}),e.jsx(a,{size:"sm",fw:500,children:s.name})]}),e.jsxs(a,{size:"xs",c:"dimmed",children:["Created ",new Date(s.inserted_at).toLocaleDateString()]})]})},s.id))})]}),e.jsxs(u,{className:"supabase-section",style:{display:"flex",flexDirection:"column"},children:[e.jsxs(c,{justify:"space-between",mb:"md",children:[e.jsxs(c,{gap:"xs",children:[e.jsx(a,{fw:600,children:"Message Inspector"}),e.jsxs(j,{size:"sm",variant:"light",color:C?"green":"gray",children:[R.length," messages"]})]}),e.jsx(D,{variant:"subtle",onClick:Y,children:e.jsx(Q,{size:18})})]}),e.jsx(le,{style:{flex:1,minHeight:300},children:R.length===0?e.jsx(M,{py:"xl",children:e.jsx(a,{c:"dimmed",size:"sm",children:C?"Waiting for messages...":"Connect to see live messages"})}):e.jsx(g,{gap:"xs",children:R.map(s=>e.jsxs(b,{p:"xs",style:{border:"1px solid var(--supabase-border)",borderRadius:6,backgroundColor:"var(--supabase-bg-surface)"},children:[e.jsxs(c,{justify:"space-between",mb:"xs",children:[e.jsxs(c,{gap:"xs",children:[e.jsx(j,{size:"xs",variant:"light",children:s.type}),s.channel&&e.jsx(j,{size:"xs",variant:"light",color:"blue",children:s.channel})]}),e.jsxs(c,{gap:4,children:[e.jsx(pe,{size:12}),e.jsx(a,{size:"xs",c:"dimmed",children:ee(s.timestamp)})]})]}),e.jsx(F,{block:!0,style:{fontSize:11},children:JSON.stringify(s.payload,null,2)})]},s.id))})})]})]})}),e.jsx(x.Panel,{value:"channels",children:e.jsxs(g,{gap:"lg",children:[e.jsx(G,{icon:e.jsx(V,{size:16}),color:"blue",children:"Manage channel subscriptions and monitor channel activity. Channels are created automatically when clients subscribe."}),e.jsx(b,{withBorder:!0,children:w?e.jsx(M,{py:"xl",children:e.jsx(S,{size:"sm"})}):!d||d.length===0?e.jsx(oe,{p:"xl",children:e.jsx(K,{icon:e.jsx(f,{size:32}),title:"No active channels",description:"Channels will appear here when clients subscribe to them"})}):e.jsxs(i,{children:[e.jsx(i.Thead,{children:e.jsxs(i.Tr,{children:[e.jsx(i.Th,{children:"Channel Name"}),e.jsx(i.Th,{children:"Type"}),e.jsx(i.Th,{children:"Subscribers"}),e.jsx(i.Th,{children:"Created"}),e.jsx(i.Th,{children:"Status"})]})}),e.jsx(i.Tbody,{children:d.map(s=>e.jsxs(i.Tr,{children:[e.jsx(i.Td,{children:e.jsxs(c,{gap:"xs",children:[e.jsx(f,{size:16}),e.jsx(a,{size:"sm",fw:500,children:s.name})]})}),e.jsx(i.Td,{children:e.jsx(j,{size:"sm",variant:"light",children:"broadcast"})}),e.jsx(i.Td,{children:e.jsx(a,{size:"sm",children:"0"})}),e.jsx(i.Td,{children:e.jsx(a,{size:"sm",c:"dimmed",children:new Date(s.inserted_at).toLocaleString()})}),e.jsx(i.Td,{children:e.jsx(j,{size:"sm",variant:"light",color:"green",children:"Active"})})]},s.id))})]})})]})}),e.jsx(x.Panel,{value:"settings",children:e.jsxs(g,{gap:"lg",children:[e.jsx(G,{icon:e.jsx(V,{size:16}),color:"blue",children:"Configure realtime settings including connection limits, channel restrictions, and database connection pool size for RLS authorization."}),e.jsxs(E,{cols:{base:1,lg:2},spacing:"lg",children:[e.jsxs(b,{p:"md",withBorder:!0,children:[e.jsxs(c,{gap:"xs",mb:"md",children:[e.jsx(ue,{size:18}),e.jsx(a,{fw:600,children:"Connection Settings"})]}),e.jsxs(g,{gap:"md",children:[e.jsx(P,{label:"Max Channel Connections",description:"Maximum connections per channel",value:r.maxChannelConnections,onChange:s=>h({...r,maxChannelConnections:Number(s)||100}),min:1,max:1e4}),e.jsx(P,{label:"Max Concurrent Users",description:"Maximum total concurrent users",value:r.maxConcurrentUsers,onChange:s=>h({...r,maxConcurrentUsers:Number(s)||200}),min:1,max:1e5}),e.jsx(P,{label:"Max Events per Second",description:"Rate limit for events per connection",value:r.maxEventsPerSecond,onChange:s=>h({...r,maxEventsPerSecond:Number(s)||100}),min:1,max:1e3}),e.jsx(P,{label:"Database Pool Size",description:"Connection pool size for RLS authorization checks",value:r.poolSize,onChange:s=>h({...r,poolSize:Number(s)||5}),min:1,max:100})]})]}),e.jsxs(b,{p:"md",withBorder:!0,children:[e.jsxs(c,{gap:"xs",mb:"md",children:[e.jsx(B,{size:18}),e.jsx(a,{fw:600,children:"Features"})]}),e.jsxs(g,{gap:"md",children:[e.jsx(A,{label:"Enable Presence",description:"Allow presence tracking in channels",checked:r.enablePresence,onChange:s=>h({...r,enablePresence:s.currentTarget.checked})}),e.jsx(A,{label:"Enable Broadcast",description:"Allow broadcast messages between clients",checked:r.enableBroadcast,onChange:s=>h({...r,enableBroadcast:s.currentTarget.checked})}),e.jsx(A,{label:"Enable Postgres Changes",description:"Allow subscribing to database changes",checked:r.enablePostgresChanges,onChange:s=>h({...r,enablePostgresChanges:s.currentTarget.checked})}),e.jsx(A,{label:"Public Channel Access",description:"Allow unauthenticated access to public channels",checked:r.publicChannelAccess,onChange:s=>h({...r,publicChannelAccess:s.currentTarget.checked})})]})]})]}),e.jsxs(b,{p:"md",withBorder:!0,children:[e.jsxs(c,{gap:"xs",mb:"md",children:[e.jsx(ge,{size:18}),e.jsx(a,{fw:600,children:"Channel Restrictions"})]}),e.jsx(a,{size:"sm",c:"dimmed",mb:"md",children:"Define patterns to restrict public access to specific channels. Use wildcards (*) for pattern matching."}),e.jsxs(c,{mb:"md",children:[e.jsx(de,{placeholder:"e.g., private:*, admin:*",value:z,onChange:s=>J(s.target.value),style:{flex:1}}),e.jsx($,{leftSection:e.jsx(be,{size:14}),onClick:ne,disabled:!z.trim(),children:"Add Restriction"})]}),v.length===0?e.jsx(a,{size:"sm",c:"dimmed",ta:"center",py:"md",children:"No channel restrictions configured"}):e.jsxs(i,{children:[e.jsx(i.Thead,{children:e.jsxs(i.Tr,{children:[e.jsx(i.Th,{children:"Pattern"}),e.jsx(i.Th,{children:"Type"}),e.jsx(i.Th,{w:80,children:"Actions"})]})}),e.jsx(i.Tbody,{children:v.map(s=>e.jsxs(i.Tr,{children:[e.jsx(i.Td,{children:e.jsx(F,{children:s.pattern})}),e.jsx(i.Td,{children:e.jsx(j,{size:"sm",variant:"light",color:s.type==="deny"?"red":"green",children:s.type})}),e.jsx(i.Td,{children:e.jsx(he,{label:"Remove",children:e.jsx(D,{size:"sm",variant:"subtle",color:"red",onClick:()=>te(s.id),children:e.jsx(Q,{size:14})})})})]},s.id))})]})]}),e.jsx(c,{justify:"flex-end",children:e.jsx($,{onClick:se,children:"Save Settings"})})]})})]})]})}export{ke as RealtimePage};
