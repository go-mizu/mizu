import{h as V,y as c,j as e,G as l,a as n,A as q,e as p,Q as te,R as ne,S as H,q as J,T as a,a4 as r,f as ae,b as oe,J as le,a1 as m,I as ie,d as C}from"./vendor-mantine-BXMqcLry.js";import{r as t}from"./vendor-react-CFPnf9wS.js";import{P as ce}from"./PageContainer-QI0M3bfS.js";import{E as de}from"./EmptyState-T2jupwgE.js";import{C as he}from"./ConfirmModal-Dw1NY3dN.js";import{p as f}from"./pgmeta-Ch70PY3U.js";import{an as me,V as xe,i as b,I as ue,aH as ge,aJ as je,Z as pe}from"./vendor-icons-q9-fAAJw.js";import"./client-CvoVCtJO.js";const Ce=["postgres","pg_database_owner","pg_read_all_data","pg_write_all_data"];function ve(){const[i,Q]=t.useState([]),[W,T]=t.useState(!0),[Y,{open:w,close:g}]=V(!1),[Z,{open:$,close:_}]=V(!1),[d,S]=t.useState(null),[j,y]=t.useState(""),[R,v]=t.useState(""),[z,k]=t.useState(!0),[I,L]=t.useState(!1),[D,A]=t.useState(!1),[E,M]=t.useState(!1),[P,B]=t.useState(!0),[N,U]=t.useState(void 0),[F,x]=t.useState(!1),h=t.useCallback(async()=>{T(!0);try{const s=await f.listRoles();Q(s??[])}catch(s){c.show({title:"Error",message:s.message||"Failed to load roles",color:"red"})}finally{T(!1)}},[]);t.useEffect(()=>{h()},[h]);const K=async()=>{if(!j.trim()){c.show({title:"Validation Error",message:"Role name is required",color:"red"});return}x(!0);try{await f.createRole({name:j,password:R||void 0,can_login:z,can_create_db:I,can_create_role:D,is_superuser:E,inherit:P,connection_limit:N}),c.show({title:"Success",message:"Role created successfully",color:"green"}),g(),ee(),h()}catch(s){c.show({title:"Error",message:s.message||"Failed to create role",color:"red"})}finally{x(!1)}},X=async()=>{if(d){x(!0);try{await f.dropRole(d.name),c.show({title:"Success",message:"Role deleted successfully",color:"green"}),_(),S(null),h()}catch(s){c.show({title:"Error",message:s.message||"Failed to delete role",color:"red"})}finally{x(!1)}}},ee=()=>{y(""),v(""),k(!0),L(!1),A(!1),M(!1),B(!0),U(void 0)},se=s=>{S(s),$()},O=s=>Ce.includes(s)||s.startsWith("pg_"),u=(i??[]).filter(s=>O(s.name)),o=(i??[]).filter(s=>!O(s.name)),G=(s,re)=>e.jsxs(r.Tr,{children:[e.jsx(r.Td,{children:e.jsxs(l,{gap:"xs",children:[s.is_superuser?e.jsx(C,{label:"Superuser",children:e.jsx(ge,{size:16,color:"var(--mantine-color-red-6)"})}):s.can_login?e.jsx(C,{label:"Login role",children:e.jsx(b,{size:16,color:"var(--mantine-color-blue-6)"})}):e.jsx(C,{label:"Group role",children:e.jsx(je,{size:16,color:"var(--mantine-color-gray-6)"})}),e.jsx(a,{size:"sm",fw:500,children:s.name})]})}),e.jsx(r.Td,{children:e.jsxs(l,{gap:4,children:[s.is_superuser&&e.jsx(n,{size:"xs",color:"red",children:"Superuser"}),s.can_login&&e.jsx(n,{size:"xs",color:"blue",children:"Login"}),s.can_create_db&&e.jsx(n,{size:"xs",color:"green",children:"CreateDB"}),s.can_create_role&&e.jsx(n,{size:"xs",color:"grape",children:"CreateRole"}),s.can_bypass_rls&&e.jsx(n,{size:"xs",color:"orange",children:"BypassRLS"}),s.is_replication_role&&e.jsx(n,{size:"xs",color:"cyan",children:"Replication"})]})}),e.jsx(r.Td,{children:s.connection_limit===-1?e.jsx(a,{size:"sm",c:"dimmed",children:"Unlimited"}):e.jsx(a,{size:"sm",children:s.connection_limit})}),e.jsx(r.Td,{children:s.active_connections>0?e.jsxs(n,{size:"sm",color:"green",children:[s.active_connections," active"]}):e.jsx(a,{size:"sm",c:"dimmed",children:"0"})}),e.jsx(r.Td,{children:s.valid_until?e.jsx(a,{size:"sm",children:new Date(s.valid_until).toLocaleDateString()}):e.jsx(a,{size:"sm",c:"dimmed",children:"Never"})}),e.jsx(r.Td,{children:re&&e.jsx(q,{variant:"subtle",color:"red",onClick:()=>se(s),children:e.jsx(pe,{size:16})})})]},s.name);return e.jsxs(ce,{title:"Roles",description:"Manage database roles and permissions",children:[e.jsxs(l,{justify:"space-between",mb:"lg",children:[e.jsxs(l,{gap:"md",children:[e.jsxs(n,{variant:"light",color:"blue",size:"lg",children:[(i==null?void 0:i.length)??0," roles"]}),e.jsxs(n,{variant:"light",color:"green",size:"lg",children:[(o==null?void 0:o.length)??0," custom"]})]}),e.jsxs(l,{gap:"sm",children:[e.jsx(q,{variant:"subtle",onClick:h,children:e.jsx(me,{size:18})}),e.jsx(p,{leftSection:e.jsx(xe,{size:16}),onClick:w,children:"New Role"})]})]}),W?e.jsx(te,{py:"xl",children:e.jsx(ne,{size:"lg"})}):!i||i.length===0?e.jsx(de,{icon:e.jsx(b,{size:48}),title:"No roles found",description:"Create roles to manage database access",action:{label:"Create Role",onClick:w}}):e.jsxs(H,{gap:"lg",children:[e.jsxs(J,{shadow:"xs",p:"md",withBorder:!0,children:[e.jsxs(l,{gap:"xs",mb:"md",children:[e.jsx(b,{size:20}),e.jsx(a,{fw:500,children:"Custom Roles"}),e.jsx(n,{size:"sm",variant:"light",children:(o==null?void 0:o.length)??0})]}),!o||o.length===0?e.jsx(a,{c:"dimmed",size:"sm",ta:"center",py:"md",children:"No custom roles. Create one to manage access."}):e.jsxs(r,{striped:!0,highlightOnHover:!0,children:[e.jsx(r.Thead,{children:e.jsxs(r.Tr,{children:[e.jsx(r.Th,{children:"Name"}),e.jsx(r.Th,{children:"Attributes"}),e.jsx(r.Th,{children:"Connection Limit"}),e.jsx(r.Th,{children:"Active Connections"}),e.jsx(r.Th,{children:"Valid Until"}),e.jsx(r.Th,{w:60})]})}),e.jsx(r.Tbody,{children:o.map(s=>G(s,!0))})]})]}),e.jsxs(J,{shadow:"xs",p:"md",withBorder:!0,children:[e.jsxs(l,{gap:"xs",mb:"md",children:[e.jsx(ue,{size:20}),e.jsx(a,{fw:500,children:"System Roles"}),e.jsx(n,{size:"sm",variant:"light",color:"gray",children:(u==null?void 0:u.length)??0})]}),e.jsx(a,{size:"sm",c:"dimmed",mb:"md",children:"System roles are managed by PostgreSQL and cannot be deleted."}),e.jsxs(r,{striped:!0,highlightOnHover:!0,children:[e.jsx(r.Thead,{children:e.jsxs(r.Tr,{children:[e.jsx(r.Th,{children:"Name"}),e.jsx(r.Th,{children:"Attributes"}),e.jsx(r.Th,{children:"Connection Limit"}),e.jsx(r.Th,{children:"Active Connections"}),e.jsx(r.Th,{children:"Valid Until"}),e.jsx(r.Th,{w:60})]})}),e.jsx(r.Tbody,{children:u.map(s=>G(s,!1))})]})]})]}),e.jsx(ae,{opened:Y,onClose:g,title:"Create role",size:"md",children:e.jsxs(H,{gap:"md",children:[e.jsx(oe,{label:"Role name",placeholder:"my_role",value:j,onChange:s=>y(s.target.value),required:!0}),e.jsx(le,{label:"Password (optional)",description:"Leave empty for roles that don't need to log in",placeholder:"Enter password",value:R,onChange:s=>v(s.target.value)}),e.jsx(a,{size:"sm",fw:500,mt:"md",children:"Attributes"}),e.jsx(m,{label:"Can login",description:"Allow this role to connect to the database",checked:z,onChange:s=>k(s.currentTarget.checked)}),e.jsx(m,{label:"Inherit privileges",description:"Automatically inherit privileges from granted roles",checked:P,onChange:s=>B(s.currentTarget.checked)}),e.jsx(m,{label:"Can create databases",description:"Allow this role to create new databases",checked:I,onChange:s=>L(s.currentTarget.checked)}),e.jsx(m,{label:"Can create roles",description:"Allow this role to create and manage other roles",checked:D,onChange:s=>A(s.currentTarget.checked)}),e.jsx(m,{label:"Superuser",description:"Grant all privileges (use with caution)",checked:E,onChange:s=>M(s.currentTarget.checked),color:"red"}),e.jsx(ie,{label:"Connection limit",description:"Maximum concurrent connections (-1 for unlimited)",placeholder:"Unlimited",value:N,onChange:s=>U(s),min:-1}),e.jsxs(l,{justify:"flex-end",mt:"md",children:[e.jsx(p,{variant:"outline",onClick:g,children:"Cancel"}),e.jsx(p,{onClick:K,loading:F,children:"Create Role"})]})]})}),e.jsx(he,{opened:Z,onClose:_,onConfirm:X,title:"Delete role",message:`Are you sure you want to delete the role "${d==null?void 0:d.name}"? This action cannot be undone and may affect database access.`,confirmLabel:"Delete",danger:!0,loading:F})]})}export{ve as RolesPage};
