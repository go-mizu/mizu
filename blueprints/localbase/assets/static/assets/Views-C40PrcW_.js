import{h as q,y as o,j as e,G as c,$ as A,a as f,A as b,e as C,O as ie,Q as le,z as h,T as m,S as v,f as re,b as ne,H as oe,B as $,q as ce,d as de,C as me,Z as ue}from"./vendor-mantine-C8lHRUHi.js";import{r as s}from"./vendor-react-CFPnf9wS.js";import{P as he}from"./PageContainer-Czy__zFQ.js";import{E as xe}from"./EmptyState-BPjdg75G.js";import{C as ge}from"./ConfirmModal-BSlXvWzg.js";import{d as fe}from"./database-CiK1Mmeb.js";import{p as u}from"./pgmeta-Ch70PY3U.js";import{$ as B,V as pe,f as S,I as we,w as je,u as ye,Z as ze}from"./vendor-icons-rGG861t1.js";import"./client-CvoVCtJO.js";function ke(){const[r,N]=s.useState("public"),[O,_]=s.useState([]),[t,H]=s.useState([]),[i,G]=s.useState([]),[Q,V]=s.useState(!0),[Z,W]=s.useState(new Set),[J,{open:E,close:z}]=q(!1),[K,{open:U,close:M}]=q(!1),[l,D]=s.useState(null),[p,T]=s.useState("regular"),[w,k]=s.useState(""),[j,I]=s.useState(""),[L,y]=s.useState(!1),R=s.useCallback(async()=>{try{const a=await fe.listSchemas();_(a||[])}catch(a){o.show({title:"Error",message:a.message||"Failed to load schemas",color:"red"})}},[]),x=s.useCallback(async()=>{V(!0);try{const[a,n]=await Promise.all([u.listViews(r),u.listMaterializedViews(r)]);H(a||[]),G(n||[])}catch(a){o.show({title:"Error",message:a.message||"Failed to load views",color:"red"})}finally{V(!1)}},[r]);s.useEffect(()=>{R()},[R]),s.useEffect(()=>{x()},[x]);const X=a=>{W(n=>{const d=new Set(n);return d.has(a)?d.delete(a):d.add(a),d})},Y=async()=>{if(!w.trim()||!j.trim()){o.show({title:"Validation Error",message:"View name and definition are required",color:"red"});return}y(!0);try{p==="materialized"?await u.createMaterializedView({schema:r,name:w,definition:j}):await u.createView({schema:r,name:w,definition:j}),o.show({title:"Success",message:`${p==="materialized"?"Materialized view":"View"} created successfully`,color:"green"}),z(),se(),x()}catch(a){o.show({title:"Error",message:a.message||"Failed to create view",color:"red"})}finally{y(!1)}},ee=async()=>{if(l){y(!0);try{l.is_materialized?await u.dropMaterializedView(r,l.name):await u.dropView(r,l.name),o.show({title:"Success",message:"View deleted successfully",color:"green"}),M(),D(null),x()}catch(a){o.show({title:"Error",message:a.message||"Failed to delete view",color:"red"})}finally{y(!1)}}},ae=async a=>{try{await u.refreshMaterializedView(r,a.name),o.show({title:"Success",message:`Materialized view "${a.name}" refreshed successfully`,color:"green"})}catch(n){o.show({title:"Error",message:n.message||"Failed to refresh materialized view",color:"red"})}},se=()=>{k(""),I(""),T("regular")},te=a=>{D(a),U()},F=(a,n)=>{var P;const d=Z.has(a.name);return e.jsxs($,{children:[e.jsx(ce,{p:"md",withBorder:!0,style:{cursor:"pointer"},onClick:()=>X(a.name),children:e.jsxs(c,{justify:"space-between",children:[e.jsxs(c,{gap:"md",children:[d?e.jsx(je,{size:18}):e.jsx(ye,{size:18}),e.jsx(S,{size:18,color:"var(--mantine-color-blue-6)"}),e.jsx(m,{fw:500,children:a.name}),n&&e.jsx(f,{size:"sm",variant:"light",color:"orange",children:"Materialized"}),e.jsxs(f,{size:"sm",variant:"outline",children:[((P=a.columns)==null?void 0:P.length)??0," columns"]})]}),e.jsxs(c,{gap:"sm",onClick:g=>g.stopPropagation(),children:[n&&e.jsx(de,{label:"Refresh data",children:e.jsx(b,{variant:"subtle",color:"blue",onClick:()=>ae(a),children:e.jsx(B,{size:16})})}),e.jsx(b,{variant:"subtle",color:"red",onClick:()=>te({...a,is_materialized:n}),children:e.jsx(ze,{size:16})})]})]})}),e.jsx(me,{in:d,children:e.jsxs($,{p:"md",ml:"xl",style:{borderLeft:"2px solid var(--mantine-color-gray-3)"},children:[e.jsx(m,{size:"sm",fw:500,mb:"xs",children:"Columns"}),a.columns&&Array.isArray(a.columns)&&a.columns.length>0?e.jsx(c,{gap:"xs",mb:"md",children:a.columns.map(g=>e.jsxs(f,{variant:"outline",children:[g.name,": ",g.type]},g.name))}):e.jsx(m,{size:"sm",c:"dimmed",mb:"md",children:"No column information available"}),e.jsx(m,{size:"sm",fw:500,mb:"xs",children:"Definition"}),e.jsx(ue,{block:!0,style:{maxHeight:200,overflow:"auto"},children:a.definition||"Definition not available"})]})})]},a.name)};return e.jsxs(he,{title:"Views",description:"Manage database views and materialized views",children:[e.jsxs(c,{justify:"space-between",mb:"lg",children:[e.jsxs(c,{gap:"md",children:[e.jsx(A,{size:"sm",value:r,onChange:a=>a&&N(a),data:O.map(a=>({value:a,label:a})),placeholder:"Select schema",w:150}),e.jsxs(f,{variant:"light",color:"blue",size:"lg",children:[(t==null?void 0:t.length)??0," views"]}),e.jsxs(f,{variant:"light",color:"orange",size:"lg",children:[(i==null?void 0:i.length)??0," materialized"]})]}),e.jsxs(c,{gap:"sm",children:[e.jsx(b,{variant:"subtle",onClick:x,children:e.jsx(B,{size:18})}),e.jsx(C,{leftSection:e.jsx(pe,{size:16}),onClick:E,children:"New View"})]})]}),Q?e.jsx(ie,{py:"xl",children:e.jsx(le,{size:"lg"})}):(!t||t.length===0)&&(!i||i.length===0)?e.jsx(xe,{icon:e.jsx(S,{size:48}),title:"No views found",description:"Create views to simplify complex queries",action:{label:"Create View",onClick:E}}):e.jsxs(h,{defaultValue:"regular",children:[e.jsxs(h.List,{mb:"md",children:[e.jsxs(h.Tab,{value:"regular",leftSection:e.jsx(S,{size:16}),children:["Views (",(t==null?void 0:t.length)??0,")"]}),e.jsxs(h.Tab,{value:"materialized",leftSection:e.jsx(we,{size:16}),children:["Materialized Views (",(i==null?void 0:i.length)??0,")"]})]}),e.jsx(h.Panel,{value:"regular",children:!t||t.length===0?e.jsx(m,{c:"dimmed",ta:"center",py:"xl",children:"No regular views found"}):e.jsx(v,{gap:"sm",children:t.map(a=>F(a,!1))})}),e.jsx(h.Panel,{value:"materialized",children:!i||i.length===0?e.jsx(m,{c:"dimmed",ta:"center",py:"xl",children:"No materialized views found"}):e.jsx(v,{gap:"sm",children:i.map(a=>F(a,!0))})})]}),e.jsx(re,{opened:J,onClose:z,title:"Create view",size:"lg",children:e.jsxs(v,{gap:"md",children:[e.jsx(A,{label:"View type",value:p,onChange:a=>a&&T(a),data:[{value:"regular",label:"Regular View"},{value:"materialized",label:"Materialized View"}]}),p==="materialized"&&e.jsx(m,{size:"sm",c:"dimmed",children:"Materialized views store the query result and must be refreshed manually to update data."}),e.jsx(ne,{label:"View name",placeholder:"my_view",value:w,onChange:a=>k(a.target.value),required:!0}),e.jsx(oe,{label:"SQL Definition",description:"The SELECT query that defines the view",placeholder:"SELECT * FROM users WHERE active = true",value:j,onChange:a=>I(a.target.value),minRows:6,required:!0,styles:{input:{fontFamily:"monospace"}}}),e.jsxs(c,{justify:"flex-end",mt:"md",children:[e.jsx(C,{variant:"outline",onClick:z,children:"Cancel"}),e.jsx(C,{onClick:Y,loading:L,children:"Create View"})]})]})}),e.jsx(ge,{opened:K,onClose:M,onConfirm:ee,title:"Delete view",message:`Are you sure you want to delete the ${l!=null&&l.is_materialized?"materialized view":"view"} "${l==null?void 0:l.name}"? This action cannot be undone.`,confirmLabel:"Delete",danger:!0,loading:L})]})}export{ke as ViewsPage};
