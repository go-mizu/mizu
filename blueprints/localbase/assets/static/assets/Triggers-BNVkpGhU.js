import{h as q,y as i,j as e,G as d,$ as T,a as g,A as U,e as C,O as ge,Q as ue,S as W,q as he,T as v,a2 as s,f as me,b as $,a3 as Te,a0 as xe}from"./vendor-mantine-C8lHRUHi.js";import{r as a}from"./vendor-react-CFPnf9wS.js";import{P as je}from"./PageContainer-Czy__zFQ.js";import{E as pe}from"./EmptyState-BPjdg75G.js";import{C as fe}from"./ConfirmModal-BSlXvWzg.js";import{d as H}from"./database-CiK1Mmeb.js";import{p as x}from"./pgmeta-Ch70PY3U.js";import{$ as Ee,V as be,h as V,Z as Se}from"./vendor-icons-rGG861t1.js";import"./client-CvoVCtJO.js";const Ce=[{value:"INSERT",label:"INSERT"},{value:"UPDATE",label:"UPDATE"},{value:"DELETE",label:"DELETE"},{value:"TRUNCATE",label:"TRUNCATE"}],ve=[{value:"BEFORE",label:"BEFORE"},{value:"AFTER",label:"AFTER"},{value:"INSTEAD OF",label:"INSTEAD OF"}];function Oe(){const[n,Q]=a.useState("public"),[Z,J]=a.useState([]),[o,K]=a.useState([]),[X,Y]=a.useState([]),[j,ee]=a.useState([]),[te,y]=a.useState(!0),[se,{open:R,close:p}]=q(!1),[ae,{open:re,close:w}]=q(!1),[l,F]=a.useState(null),[f,D]=a.useState(""),[E,N]=a.useState(null),[b,I]=a.useState(null),[A,z]=a.useState("BEFORE"),[S,O]=a.useState(["INSERT"]),[k,M]=a.useState(!0),[_,B]=a.useState(""),[G,m]=a.useState(!1),L=a.useCallback(async()=>{try{const t=await H.listSchemas();J(t||[])}catch(t){i.show({title:"Error",message:t.message||"Failed to load schemas",color:"red"})}},[]),u=a.useCallback(async()=>{y(!0);try{const[t,c,r]=await Promise.all([x.listTriggers(n),H.listTables(n),x.listDatabaseFunctions(`${n},public`)]);K(t||[]),Y(c||[]);const h=(r||[]).filter(P=>P.return_type==="trigger"||P.return_type==="event_trigger");ee(h)}catch(t){i.show({title:"Error",message:t.message||"Failed to load triggers",color:"red"})}finally{y(!1)}},[n]);a.useEffect(()=>{L()},[L]),a.useEffect(()=>{u()},[u]);const ne=async()=>{if(!f.trim()||!E||!b||S.length===0){i.show({title:"Validation Error",message:"Trigger name, table, function, and at least one event are required",color:"red"});return}m(!0);try{await x.createTrigger({schema:n,table:E,name:f,function_name:b,function_schema:n,activation:A,events:S,orientation:k?"ROW":"STATEMENT",condition:_||void 0}),i.show({title:"Success",message:"Trigger created successfully",color:"green"}),p(),ie(),u()}catch(t){i.show({title:"Error",message:t.message||"Failed to create trigger",color:"red"})}finally{m(!1)}},le=async()=>{if(l){m(!0);try{await x.dropTrigger(l.schema,l.table,l.name),i.show({title:"Success",message:"Trigger deleted successfully",color:"green"}),w(),F(null),u()}catch(t){i.show({title:"Error",message:t.message||"Failed to delete trigger",color:"red"})}finally{m(!1)}}},ie=()=>{D(""),N(null),I(null),z("BEFORE"),O(["INSERT"]),M(!0),B("")},oe=t=>{F(t),re()},ce=t=>{switch(t){case"INSERT":return"green";case"UPDATE":return"yellow";case"DELETE":return"red";case"TRUNCATE":return"orange";default:return"gray"}},de=(o??[]).reduce((t,c)=>{const r=c.table;return t[r]||(t[r]=[]),t[r].push(c),t},{});return e.jsxs(je,{title:"Triggers",description:"Manage database triggers for automated actions",children:[e.jsxs(d,{justify:"space-between",mb:"lg",children:[e.jsxs(d,{gap:"md",children:[e.jsx(T,{size:"sm",value:n,onChange:t=>t&&Q(t),data:Z.map(t=>({value:t,label:t})),placeholder:"Select schema",w:150}),e.jsxs(g,{variant:"light",color:"blue",size:"lg",children:[(o==null?void 0:o.length)??0," triggers"]})]}),e.jsxs(d,{gap:"sm",children:[e.jsx(U,{variant:"subtle",onClick:u,children:e.jsx(Ee,{size:18})}),e.jsx(C,{leftSection:e.jsx(be,{size:16}),onClick:R,children:"New Trigger"})]})]}),te?e.jsx(ge,{py:"xl",children:e.jsx(ue,{size:"lg"})}):!o||o.length===0?e.jsx(pe,{icon:e.jsx(V,{size:48}),title:"No triggers found",description:"Create triggers to automate database actions",action:{label:"Create Trigger",onClick:R}}):e.jsx(W,{gap:"md",children:Object.entries(de).map(([t,c])=>e.jsxs(he,{shadow:"xs",p:"md",withBorder:!0,children:[e.jsx(v,{fw:500,mb:"md",children:t}),e.jsxs(s,{striped:!0,highlightOnHover:!0,children:[e.jsx(s.Thead,{children:e.jsxs(s.Tr,{children:[e.jsx(s.Th,{children:"Name"}),e.jsx(s.Th,{children:"Timing"}),e.jsx(s.Th,{children:"Events"}),e.jsx(s.Th,{children:"Function"}),e.jsx(s.Th,{children:"Level"}),e.jsx(s.Th,{children:"Enabled"}),e.jsx(s.Th,{w:60})]})}),e.jsx(s.Tbody,{children:c.map(r=>e.jsxs(s.Tr,{children:[e.jsx(s.Td,{children:e.jsxs(d,{gap:"xs",children:[e.jsx(V,{size:14,color:"var(--mantine-color-yellow-6)"}),e.jsx(v,{size:"sm",fw:500,children:r.name})]})}),e.jsx(s.Td,{children:e.jsx(g,{size:"sm",variant:"light",color:"blue",children:r.activation})}),e.jsx(s.Td,{children:e.jsx(d,{gap:4,children:r.events.map(h=>e.jsx(g,{size:"xs",color:ce(h),children:h},h))})}),e.jsx(s.Td,{children:e.jsxs(v,{size:"sm",children:[r.function_schema,".",r.function_name]})}),e.jsx(s.Td,{children:e.jsx(g,{size:"sm",variant:"outline",children:r.orientation})}),e.jsx(s.Td,{children:r.enabled?e.jsx(g,{size:"sm",color:"green",children:"Enabled"}):e.jsx(g,{size:"sm",color:"gray",children:"Disabled"})}),e.jsx(s.Td,{children:e.jsx(U,{variant:"subtle",color:"red",onClick:()=>oe(r),children:e.jsx(Se,{size:16})})})]},r.name))})]})]},t))}),e.jsx(me,{opened:se,onClose:p,title:"Create trigger",size:"md",children:e.jsxs(W,{gap:"md",children:[e.jsx($,{label:"Trigger name",placeholder:"my_trigger",value:f,onChange:t=>D(t.target.value),required:!0}),e.jsx(T,{label:"Table",description:"Select the table to create a trigger on",value:E,onChange:N,data:X.map(t=>({value:t.name,label:t.name})),placeholder:"Select table",searchable:!0,required:!0}),e.jsx(T,{label:"Trigger function",description:"Select the function to execute",value:b,onChange:I,data:j.map(t=>({value:t.name,label:`${t.schema}.${t.name}`})),placeholder:"Select function",searchable:!0,required:!0,nothingFoundMessage:!j||j.length===0?"No trigger functions found. Create a function that returns TRIGGER first.":"No matching functions"}),e.jsx(T,{label:"Timing",description:"When the trigger should fire",value:A,onChange:t=>t&&z(t),data:ve}),e.jsx(Te,{label:"Events",description:"Which events trigger this action",value:S,onChange:O,data:Ce,required:!0}),e.jsx(xe,{label:"FOR EACH ROW",description:"Execute trigger for each affected row (vs. once per statement)",checked:k,onChange:t=>M(t.currentTarget.checked)}),e.jsx($,{label:"Condition (optional)",description:"WHEN clause to conditionally fire the trigger",placeholder:"(NEW.status = 'active')",value:_,onChange:t=>B(t.target.value)}),e.jsxs(d,{justify:"flex-end",mt:"md",children:[e.jsx(C,{variant:"outline",onClick:p,children:"Cancel"}),e.jsx(C,{onClick:ne,loading:G,children:"Create Trigger"})]})]})}),e.jsx(fe,{opened:ae,onClose:w,onConfirm:le,title:"Delete trigger",message:`Are you sure you want to delete the trigger "${l==null?void 0:l.name}"? This action cannot be undone.`,confirmLabel:"Delete",danger:!0,loading:G})]})}export{Oe as TriggersPage};
