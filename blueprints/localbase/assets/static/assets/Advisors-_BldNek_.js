import{j as e,z as h,a as g,S as m,q as L,G as t,s as a,B as n,T as i,a9 as T,r as j,E as A,a8 as l,Z as R,e as u,p as D,t as b}from"./vendor-mantine-C8lHRUHi.js";import{r as p,L as w}from"./vendor-react-CFPnf9wS.js";import{P as H}from"./PageContainer-Czy__zFQ.js";import{d as G}from"./database-CiK1Mmeb.js";import{j as q,p as M,J as B,aR as k,H as P,I as S,B as U,aS as W,az as J,c as Y,W as F,K as $}from"./vendor-icons-BaFQZaXW.js";import"./client-CvoVCtJO.js";function ie(){const[_,N]=p.useState("security"),[I,C]=p.useState(!0),[c,Q]=p.useState([]),[o,O]=p.useState([]);p.useEffect(()=>{(async()=>{C(!0);try{const v=await G.listTables("public"),y=[],z=[];for(const r of v||[])r.rls_enabled||y.push({id:`rls-${r.name}`,severity:"critical",title:`Row Level Security disabled on "${r.name}"`,description:`The table "${r.name}" does not have Row Level Security (RLS) enabled. This means any authenticated user can access all rows.`,table:r.name,suggestion:"Enable RLS and create appropriate policies to restrict access.",sqlFix:`ALTER TABLE ${r.name} ENABLE ROW LEVEL SECURITY;`}),r.row_count&&r.row_count>1e3&&z.push({id:`index-${r.name}`,severity:"warning",title:`Consider adding indexes to "${r.name}"`,description:`Table "${r.name}" has ${r.row_count} rows. Consider adding indexes on frequently queried columns.`,impact:"Slow queries on large tables without proper indexes",suggestion:"Analyze query patterns and add indexes on columns used in WHERE clauses and JOINs.",sqlFix:`-- Example: Add index on commonly queried column
CREATE INDEX idx_${r.name}_user_id ON ${r.name}(user_id);`});y.filter(r=>r.severity==="critical").length===0&&y.push({id:"general-security",severity:"info",title:"Security best practices",description:"Your database appears to be configured securely. Here are some additional recommendations.",suggestion:"Regularly review your RLS policies and ensure service_role key is never exposed to clients."}),z.push({id:"connection-pooling",severity:"info",title:"Use connection pooling for serverless",description:"If using serverless functions, ensure you use the pooler connection string.",impact:"Connection exhaustion in serverless environments",suggestion:"Use transaction pooler mode for short-lived connections."}),Q(y),O(z)}catch(v){console.error("Failed to analyze database:",v)}finally{C(!1)}})()},[]);const f=s=>{switch(s){case"critical":return"red";case"warning":return"yellow";case"info":return"blue";default:return"gray"}},E=s=>{switch(s){case"critical":return e.jsx($,{size:16});case"warning":return e.jsx($,{size:16});case"info":return e.jsx(F,{size:16});default:return e.jsx(F,{size:16})}},d=Math.max(0,100-c.filter(s=>s.severity==="critical").length*30-c.filter(s=>s.severity==="warning").length*10),x=Math.max(0,100-o.filter(s=>s.severity==="critical").length*30-o.filter(s=>s.severity==="warning").length*10);return e.jsx(H,{title:"Advisors",description:"Security and performance recommendations for your project",children:e.jsxs(h,{value:_,onChange:N,children:[e.jsxs(h.List,{mb:"lg",children:[e.jsx(h.Tab,{value:"security",leftSection:e.jsx(q,{size:16}),rightSection:c.filter(s=>s.severity==="critical").length>0?e.jsx(g,{size:"xs",color:"red",variant:"filled",children:c.filter(s=>s.severity==="critical").length}):null,children:"Security"}),e.jsx(h.Tab,{value:"performance",leftSection:e.jsx(M,{size:16}),rightSection:o.filter(s=>s.severity==="critical").length>0?e.jsx(g,{size:"xs",color:"red",variant:"filled",children:o.filter(s=>s.severity==="critical").length}):null,children:"Performance"})]}),e.jsx(h.Panel,{value:"security",children:e.jsxs(m,{gap:"lg",children:[e.jsxs(L,{p:"md",radius:"md",withBorder:!0,children:[e.jsxs(t,{justify:"space-between",mb:"sm",children:[e.jsxs(t,{gap:"sm",children:[e.jsx(a,{size:"lg",radius:"md",variant:"light",color:d>=80?"green":d>=50?"yellow":"red",children:e.jsx(q,{size:20})}),e.jsxs(n,{children:[e.jsx(i,{fw:600,children:"Security Score"}),e.jsx(i,{size:"xs",c:"dimmed",children:"Based on RLS configuration and policy analysis"})]})]}),e.jsxs(i,{size:"xl",fw:700,children:[d,"%"]})]}),e.jsx(T,{value:d,color:d>=80?"green":d>=50?"yellow":"red",size:"lg",radius:"xl"})]}),I?e.jsxs(m,{gap:"md",children:[e.jsx(j,{height:100}),e.jsx(j,{height:100}),e.jsx(j,{height:100})]}):c.length===0?e.jsx(A,{icon:e.jsx(B,{size:16}),title:"All clear!",color:"green",children:"No security issues found in your database configuration."}):e.jsx(l,{variant:"separated",radius:"md",children:c.map(s=>e.jsxs(l.Item,{value:s.id,children:[e.jsx(l.Control,{children:e.jsxs(t,{gap:"sm",children:[e.jsx(a,{size:"sm",radius:"xl",variant:"light",color:f(s.severity),children:E(s.severity)}),e.jsxs(n,{style:{flex:1},children:[e.jsx(i,{size:"sm",fw:500,children:s.title}),s.table&&e.jsx(g,{size:"xs",variant:"light",mt:4,children:s.table})]}),e.jsx(g,{size:"sm",variant:"light",color:f(s.severity),children:s.severity})]})}),e.jsx(l.Panel,{children:e.jsxs(m,{gap:"md",children:[e.jsx(i,{size:"sm",c:"dimmed",children:s.description}),e.jsxs(n,{children:[e.jsxs(i,{size:"sm",fw:500,mb:4,children:[e.jsx(k,{size:14,style:{verticalAlign:"middle"}})," Recommendation"]}),e.jsx(i,{size:"sm",children:s.suggestion})]}),s.sqlFix&&e.jsxs(n,{children:[e.jsx(i,{size:"sm",fw:500,mb:4,children:"Quick Fix"}),e.jsx(R,{block:!0,children:s.sqlFix}),e.jsxs(t,{mt:"sm",gap:"xs",children:[e.jsx(u,{size:"xs",variant:"light",leftSection:e.jsx(P,{size:14}),onClick:()=>navigator.clipboard.writeText(s.sqlFix),children:"Copy SQL"}),e.jsx(u,{size:"xs",variant:"light",component:w,to:"/sql-editor",leftSection:e.jsx(S,{size:14}),children:"Open in SQL Editor"})]})]}),s.table&&e.jsxs(u,{size:"xs",variant:"subtle",component:w,to:"/database/policies",rightSection:e.jsx(U,{size:14}),children:["Manage policies for ",s.table]})]})})]},s.id))})]})}),e.jsx(h.Panel,{value:"performance",children:e.jsxs(m,{gap:"lg",children:[e.jsxs(L,{p:"md",radius:"md",withBorder:!0,children:[e.jsxs(t,{justify:"space-between",mb:"sm",children:[e.jsxs(t,{gap:"sm",children:[e.jsx(a,{size:"lg",radius:"md",variant:"light",color:x>=80?"green":x>=50?"yellow":"red",children:e.jsx(W,{size:20})}),e.jsxs(n,{children:[e.jsx(i,{fw:600,children:"Performance Score"}),e.jsx(i,{size:"xs",c:"dimmed",children:"Based on indexes, query patterns, and configuration"})]})]}),e.jsxs(i,{size:"xl",fw:700,children:[x,"%"]})]}),e.jsx(T,{value:x,color:x>=80?"green":x>=50?"yellow":"red",size:"lg",radius:"xl"})]}),e.jsxs(D,{cols:{base:1,sm:3},spacing:"md",children:[e.jsx(b,{padding:"md",radius:"md",withBorder:!0,children:e.jsxs(t,{children:[e.jsx(a,{size:"lg",radius:"md",variant:"light",color:"blue",children:e.jsx(S,{size:20})}),e.jsxs(n,{children:[e.jsx(i,{size:"xs",c:"dimmed",children:"Active Connections"}),e.jsx(i,{fw:600,children:"5 / 100"})]})]})}),e.jsx(b,{padding:"md",radius:"md",withBorder:!0,children:e.jsxs(t,{children:[e.jsx(a,{size:"lg",radius:"md",variant:"light",color:"green",children:e.jsx(J,{size:20})}),e.jsxs(n,{children:[e.jsx(i,{size:"xs",c:"dimmed",children:"Avg Query Time"}),e.jsx(i,{fw:600,children:"2.5ms"})]})]})}),e.jsx(b,{padding:"md",radius:"md",withBorder:!0,children:e.jsxs(t,{children:[e.jsx(a,{size:"lg",radius:"md",variant:"light",color:"orange",children:e.jsx(Y,{size:20})}),e.jsxs(n,{children:[e.jsx(i,{size:"xs",c:"dimmed",children:"Cache Hit Ratio"}),e.jsx(i,{fw:600,children:"98.5%"})]})]})})]}),I?e.jsxs(m,{gap:"md",children:[e.jsx(j,{height:100}),e.jsx(j,{height:100}),e.jsx(j,{height:100})]}):o.length===0?e.jsx(A,{icon:e.jsx(B,{size:16}),title:"All clear!",color:"green",children:"No performance issues found in your database configuration."}):e.jsx(l,{variant:"separated",radius:"md",children:o.map(s=>e.jsxs(l.Item,{value:s.id,children:[e.jsx(l.Control,{children:e.jsxs(t,{gap:"sm",children:[e.jsx(a,{size:"sm",radius:"xl",variant:"light",color:f(s.severity),children:E(s.severity)}),e.jsx(n,{style:{flex:1},children:e.jsx(i,{size:"sm",fw:500,children:s.title})}),e.jsx(g,{size:"sm",variant:"light",color:f(s.severity),children:s.severity})]})}),e.jsx(l.Panel,{children:e.jsxs(m,{gap:"md",children:[e.jsx(i,{size:"sm",c:"dimmed",children:s.description}),e.jsxs(n,{children:[e.jsx(i,{size:"sm",fw:500,mb:4,children:"Impact"}),e.jsx(i,{size:"sm",c:"red",children:s.impact})]}),e.jsxs(n,{children:[e.jsxs(i,{size:"sm",fw:500,mb:4,children:[e.jsx(k,{size:14,style:{verticalAlign:"middle"}})," Recommendation"]}),e.jsx(i,{size:"sm",children:s.suggestion})]}),s.sqlFix&&e.jsxs(n,{children:[e.jsx(i,{size:"sm",fw:500,mb:4,children:"Example Fix"}),e.jsx(R,{block:!0,children:s.sqlFix}),e.jsxs(t,{mt:"sm",gap:"xs",children:[e.jsx(u,{size:"xs",variant:"light",leftSection:e.jsx(P,{size:14}),onClick:()=>navigator.clipboard.writeText(s.sqlFix),children:"Copy SQL"}),e.jsx(u,{size:"xs",variant:"light",component:w,to:"/sql-editor",leftSection:e.jsx(S,{size:14}),children:"Open in SQL Editor"})]})]})]})})]},s.id))})]})})]})})}export{ie as AdvisorsPage};
