import{h as G,F as r,j as e,G as t,a3 as $,a as d,A as R,W as ue,X as xe,S as k,q as K,B as V,T as h,d as pe,e as D,C as je,x as i,_ as z,f as ge,H as u,b as fe,O as Q,a0 as ye}from"./vendor-mantine-aKbh6G_O.js";import{r as l}from"./vendor-react-CA6k1jPF.js";import{P as be}from"./PageContainer-BshQiLl_.js";import{E as Ce}from"./EmptyState-s1kxp5xn.js";import{C as Te}from"./ConfirmModal-vPtHsZos.js";import{d as g}from"./database-Co5xRXKh.js";import{ao as Ee,j as Se,x as we,v as Pe,aR as Le,aS as ve,W as _e,_ as Re}from"./vendor-icons-BYOfSTr6.js";import"./client-CvoVCtJO.js";const ke=[{name:"Enable read access for all users",command:"SELECT",definition:"true",description:"Allow all users to read all rows"},{name:"Enable insert for authenticated users only",command:"INSERT",definition:"(auth.role() = 'authenticated')",description:"Only authenticated users can insert rows"},{name:"Enable read access for users based on user_id",command:"SELECT",definition:"(auth.uid() = user_id)",description:"Users can only read rows where user_id matches their ID"},{name:"Enable update for users based on user_id",command:"UPDATE",definition:"(auth.uid() = user_id)",check_expression:"(auth.uid() = user_id)",description:"Users can only update their own rows"},{name:"Enable delete for users based on user_id",command:"DELETE",definition:"(auth.uid() = user_id)",description:"Users can only delete their own rows"}];function We(){const[m,X]=l.useState("public"),[Y,J]=l.useState([]),[f,I]=l.useState([]),[Z,A]=l.useState(!0),[ee,{open:se,close:T}]=G(!1),[ae,{open:ie,close:N}]=G(!1),[c,E]=l.useState(null),[x,M]=l.useState(null),[S,w]=l.useState(""),[p,P]=l.useState("SELECT"),[L,v]=l.useState(""),[U,y]=l.useState(""),[_,F]=l.useState(["public"]),[W,b]=l.useState(!1),O=l.useCallback(async()=>{try{const s=await g.listSchemas();J(s||[])}catch(s){r.show({title:"Error",message:s.message||"Failed to load schemas",color:"red"})}},[]),j=l.useCallback(async()=>{A(!0);try{const a=(await g.listTables(m)||[]).map(async n=>{try{const C=await g.listPolicies(m,n.name);return{table:n,policies:C||[],expanded:!1}}catch{return{table:n,policies:[],expanded:!1}}}),o=await Promise.all(a);I(o)}catch(s){r.show({title:"Error",message:s.message||"Failed to load policies",color:"red"})}finally{A(!1)}},[m]);l.useEffect(()=>{O()},[O]),l.useEffect(()=>{j()},[j]);const le=s=>{I(a=>a.map(o=>o.table.name===s?{...o,expanded:!o.expanded}:o))},ne=async s=>{try{r.show({title:"Info",message:`RLS is currently ${s.rls_enabled?"enabled":"disabled"} for ${s.name}`,color:"blue"})}catch(a){r.show({title:"Error",message:a.message||"Failed to toggle RLS",color:"red"})}},oe=async()=>{if(!c||!S.trim()||!L.trim()){r.show({title:"Validation Error",message:"Policy name and definition are required",color:"red"});return}b(!0);try{await g.createPolicy({name:S,schema:m,table:c.name,command:p,definition:L,check_expression:U||void 0,roles:_.length>0?_:void 0}),r.show({title:"Success",message:"Policy created successfully",color:"green"}),T(),B(),j()}catch(s){r.show({title:"Error",message:s.message||"Failed to create policy",color:"red"})}finally{b(!1)}},re=async()=>{if(!(!x||!c)){b(!0);try{await g.dropPolicy(m,c.name,x.name),r.show({title:"Success",message:"Policy deleted successfully",color:"green"}),N(),M(null),j()}catch(s){r.show({title:"Error",message:s.message||"Failed to delete policy",color:"red"})}finally{b(!1)}}},B=()=>{w(""),P("SELECT"),v(""),y(""),F(["public"]),E(null)},te=s=>{w(s.name.toLowerCase().replace(/\s+/g,"_")),P(s.command),v(s.definition),"check_expression"in s?y(s.check_expression||""):y("")},ce=s=>{E(s),B(),se()},de=(s,a)=>{E(s),M(a),ie()},H=s=>{switch(s){case"SELECT":return"blue";case"INSERT":return"green";case"UPDATE":return"yellow";case"DELETE":return"red";case"ALL":return"grape";default:return"gray"}},he=f.reduce((s,a)=>{var o;return s+(((o=a.policies)==null?void 0:o.length)??0)},0),me=f.filter(s=>{var a;return(a=s.table)==null?void 0:a.rls_enabled}).length;return e.jsxs(be,{title:"Row Level Security",description:"Manage access policies for your database tables",children:[e.jsxs(t,{justify:"space-between",mb:"lg",children:[e.jsxs(t,{gap:"md",children:[e.jsx($,{size:"sm",value:m,onChange:s=>s&&X(s),data:Y.map(s=>({value:s,label:s})),placeholder:"Select schema",w:150}),e.jsxs(d,{variant:"light",color:"blue",size:"lg",children:[he," policies"]}),e.jsxs(d,{variant:"light",color:"green",size:"lg",children:[me," tables with RLS"]})]}),e.jsx(R,{variant:"subtle",onClick:j,children:e.jsx(Ee,{size:18})})]}),Z?e.jsx(ue,{py:"xl",children:e.jsx(xe,{size:"lg"})}):f.length===0?e.jsx(Ce,{icon:e.jsx(Se,{size:48}),title:"No tables found",description:"Create tables first to manage RLS policies"}):e.jsx(k,{gap:"md",children:f.map(({table:s,policies:a,expanded:o})=>e.jsxs(K,{shadow:"xs",p:0,withBorder:!0,children:[e.jsx(V,{p:"md",style:{cursor:"pointer",backgroundColor:o?"var(--mantine-color-gray-0)":void 0},onClick:()=>le(s.name),children:e.jsxs(t,{justify:"space-between",children:[e.jsxs(t,{gap:"md",children:[o?e.jsx(we,{size:18}):e.jsx(Pe,{size:18}),e.jsx(h,{fw:500,children:s.name}),e.jsx(d,{size:"sm",variant:"light",color:s.rls_enabled?"green":"gray",children:s.rls_enabled?"RLS Enabled":"RLS Disabled"}),e.jsxs(d,{size:"sm",variant:"outline",children:[(a==null?void 0:a.length)??0," ",((a==null?void 0:a.length)??0)===1?"policy":"policies"]})]}),e.jsxs(t,{gap:"sm",onClick:n=>n.stopPropagation(),children:[e.jsx(pe,{label:s.rls_enabled?"Disable RLS":"Enable RLS",children:e.jsx(R,{variant:"subtle",color:s.rls_enabled?"green":"gray",onClick:()=>ne(s),children:s.rls_enabled?e.jsx(Le,{size:18}):e.jsx(ve,{size:18})})}),e.jsx(D,{size:"xs",variant:"light",leftSection:e.jsx(_e,{size:14}),onClick:()=>ce(s),children:"New Policy"})]})]})}),e.jsx(je,{in:o,children:e.jsx(V,{px:"md",pb:"md",children:!a||a.length===0?e.jsx(h,{size:"sm",c:"dimmed",ta:"center",py:"md",children:"No policies defined. Add a policy to control access."}):e.jsxs(i,{striped:!0,highlightOnHover:!0,children:[e.jsx(i.Thead,{children:e.jsxs(i.Tr,{children:[e.jsx(i.Th,{children:"Name"}),e.jsx(i.Th,{children:"Command"}),e.jsx(i.Th,{children:"Definition (USING)"}),e.jsx(i.Th,{children:"Check (WITH CHECK)"}),e.jsx(i.Th,{children:"Roles"}),e.jsx(i.Th,{w:60})]})}),e.jsx(i.Tbody,{children:a.map(n=>{var C;return e.jsxs(i.Tr,{children:[e.jsx(i.Td,{children:e.jsx(h,{size:"sm",fw:500,children:n.name})}),e.jsx(i.Td,{children:e.jsx(d,{size:"sm",color:H(n.command),children:n.command})}),e.jsx(i.Td,{children:e.jsx(z,{block:!0,style:{maxWidth:300},children:n.definition})}),e.jsx(i.Td,{children:n.check_expression?e.jsx(z,{block:!0,style:{maxWidth:200},children:n.check_expression}):e.jsx(h,{size:"sm",c:"dimmed",children:"â€”"})}),e.jsx(i.Td,{children:e.jsx(t,{gap:4,children:(C=n.roles)==null?void 0:C.map(q=>e.jsx(d,{size:"xs",variant:"outline",children:q},q))})}),e.jsx(i.Td,{children:e.jsx(R,{variant:"subtle",color:"red",onClick:()=>de(s,n),children:e.jsx(Re,{size:16})})})]},n.name)})})]})})})]},s.name))}),e.jsx(ge,{opened:ee,onClose:T,title:`Create policy for ${c==null?void 0:c.name}`,size:"lg",children:e.jsxs(u,{defaultValue:"custom",children:[e.jsxs(u.List,{mb:"md",children:[e.jsx(u.Tab,{value:"custom",children:"Custom Policy"}),e.jsx(u.Tab,{value:"templates",children:"Templates"})]}),e.jsx(u.Panel,{value:"custom",children:e.jsxs(k,{gap:"md",children:[e.jsx(fe,{label:"Policy name",placeholder:"policy_name",value:S,onChange:s=>w(s.target.value),required:!0}),e.jsx($,{label:"Command",description:"Which SQL command this policy applies to",value:p,onChange:s=>s&&P(s),data:[{value:"ALL",label:"ALL - All commands"},{value:"SELECT",label:"SELECT - Read access"},{value:"INSERT",label:"INSERT - Create access"},{value:"UPDATE",label:"UPDATE - Modify access"},{value:"DELETE",label:"DELETE - Delete access"}]}),e.jsx(Q,{label:"USING expression",description:"This expression is used to determine which rows are visible",placeholder:"(auth.uid() = user_id)",value:L,onChange:s=>v(s.target.value),minRows:3,required:!0}),(p==="INSERT"||p==="UPDATE"||p==="ALL")&&e.jsx(Q,{label:"WITH CHECK expression",description:"This expression is used for INSERT and UPDATE to determine which rows can be created/modified",placeholder:"(auth.uid() = user_id)",value:U,onChange:s=>y(s.target.value),minRows:3}),e.jsx(ye,{label:"Roles",description:"Which roles this policy applies to",value:_,onChange:F,data:["public","authenticated","anon","service_role"],placeholder:"Select roles"}),e.jsxs(t,{justify:"flex-end",mt:"md",children:[e.jsx(D,{variant:"outline",onClick:T,children:"Cancel"}),e.jsx(D,{onClick:oe,loading:W,children:"Create Policy"})]})]})}),e.jsx(u.Panel,{value:"templates",children:e.jsxs(k,{gap:"md",children:[ke.map((s,a)=>e.jsxs(K,{p:"md",withBorder:!0,style:{cursor:"pointer"},onClick:()=>te(s),children:[e.jsxs(t,{justify:"space-between",mb:"xs",children:[e.jsx(h,{fw:500,children:s.name}),e.jsx(d,{size:"sm",color:H(s.command),children:s.command})]}),e.jsx(h,{size:"sm",c:"dimmed",mb:"xs",children:s.description}),e.jsx(z,{block:!0,children:s.definition})]},a)),e.jsx(h,{size:"sm",c:"dimmed",ta:"center",children:"Click a template to apply it to the custom policy form"})]})})]})}),e.jsx(Te,{opened:ae,onClose:N,onConfirm:re,title:"Delete policy",message:`Are you sure you want to delete the policy "${x==null?void 0:x.name}"? This action cannot be undone.`,confirmLabel:"Delete",danger:!0,loading:W})]})}export{We as PoliciesPage};
