{{define "Streaming.kt.tmpl"}}// Code generated by sdkkotlin. DO NOT EDIT.

package {{.Package}}

{{- if .HasSSE}}

import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.flow.Flow
import kotlinx.coroutines.flow.flow
import kotlinx.coroutines.flow.flowOn
import kotlinx.serialization.json.Json
import java.io.BufferedReader
import java.io.InputStream
import java.io.InputStreamReader
import kotlin.reflect.KType
import kotlin.reflect.typeOf

/**
 * Parses Server-Sent Events from a byte stream into a Flow.
 *
 * SSE format:
 * ```
 * data: {"key": "value"}
 *
 * data: {"key": "value2"}
 *
 * data: [DONE]
 * ```
 */
internal inline fun <reified T> parseSSEStream(
    inputStream: InputStream,
    json: Json
): Flow<T> = flow {
    BufferedReader(InputStreamReader(inputStream)).use { reader ->
        var buffer = StringBuilder()

        reader.forEachLine { line ->
            if (line.isEmpty()) {
                // Empty line = end of event
                val data = buffer.toString().trim()
                buffer = StringBuilder()

                if (data.isNotEmpty() && data != "[DONE]") {
                    val item = json.decodeFromString<T>(data)
                    emit(item)
                }
            } else if (line.startsWith("data:")) {
                val content = line.removePrefix("data:").trimStart()
                if (buffer.isNotEmpty()) buffer.append("\n")
                buffer.append(content)
            }
            // Ignore other SSE fields (event:, id:, retry:, comments)
        }
    }
}.flowOn(Dispatchers.IO)

/**
 * Extension function to collect Flow items with a suspend callback.
 */
suspend inline fun <T> Flow<T>.collectItems(crossinline action: suspend (T) -> Unit) {
    collect { item -> action(item) }
}

/**
 * Extension function to collect all Flow items into a List.
 */
suspend fun <T> Flow<T>.toList(): List<T> {
    val result = mutableListOf<T>()
    collect { result.add(it) }
    return result
}
{{- else}}

// No streaming methods in this SDK.
// This file is included for consistency.
{{- end}}
{{end}}
