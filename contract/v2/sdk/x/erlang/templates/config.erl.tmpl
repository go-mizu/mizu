{{define "config.erl.tmpl"}}%% Code generated by sdkerlang. DO NOT EDIT.

%% @doc Configuration for {{.Service.Name}} client.
%%
%% Configuration can be provided via:
%% <ul>
%%   <li>Options passed to `new/1'</li>
%%   <li>Application environment under `{{.AppName}}'</li>
%%   <li>Built-in defaults</li>
%% </ul>
%%
%% Priority: Options > App Env > Defaults
-module({{.AppName}}_config).

-export([
    new/0,
    new/1,
    api_key/1,
    base_url/1,
    timeout/1,
    max_retries/1,
    auth_mode/1,
    headers/1
]).

-record(config, {
    api_key :: binary() | undefined,
    base_url :: binary(),
    timeout :: pos_integer(),
    max_retries :: non_neg_integer(),
    auth_mode :: auth_mode(),
    headers :: [{binary(), binary()}]
}).

-opaque config() :: #config{}.
-type auth_mode() :: bearer | basic | header | none.
-export_type([config/0, auth_mode/0]).

{{if .Client.BaseURL}}-define(DEFAULT_BASE_URL, {{erlangBinary .Client.BaseURL}}).
{{else}}-define(DEFAULT_BASE_URL, <<"https://api.example.com">>).
{{end}}-define(DEFAULT_TIMEOUT, 60000).
-define(DEFAULT_MAX_RETRIES, 2).
-define(DEFAULT_AUTH_MODE, {{if eq .Client.Auth "basic"}}basic{{else if eq .Client.Auth "header"}}header{{else if eq .Client.Auth "none"}}none{{else}}bearer{{end}}).

%% @doc Creates a new configuration with defaults.
-spec new() -> config().
new() ->
    new([]).

%% @doc Creates a new configuration from options.
%%
%% Options override application environment which overrides defaults.
%%
%% @param Opts Options proplist
%% @returns Configuration record
-spec new(proplists:proplist()) -> config().
new(Opts) ->
    ApiKey = get_opt(api_key, Opts, undefined),
    BaseURL = get_opt(base_url, Opts, ?DEFAULT_BASE_URL),
    Timeout = get_opt(timeout, Opts, ?DEFAULT_TIMEOUT),
    MaxRetries = get_opt(max_retries, Opts, ?DEFAULT_MAX_RETRIES),
    AuthMode = get_opt(auth_mode, Opts, ?DEFAULT_AUTH_MODE),
    Headers = get_opt(headers, Opts, default_headers()),

    #config{
        api_key = ensure_binary(ApiKey),
        base_url = ensure_binary(BaseURL),
        timeout = Timeout,
        max_retries = MaxRetries,
        auth_mode = AuthMode,
        headers = normalize_headers(Headers)
    }.

%% Accessors

%% @doc Returns the API key.
-spec api_key(config()) -> binary() | undefined.
api_key(#config{api_key = V}) -> V.

%% @doc Returns the base URL.
-spec base_url(config()) -> binary().
base_url(#config{base_url = V}) -> V.

%% @doc Returns the request timeout in milliseconds.
-spec timeout(config()) -> pos_integer().
timeout(#config{timeout = V}) -> V.

%% @doc Returns the maximum number of retries.
-spec max_retries(config()) -> non_neg_integer().
max_retries(#config{max_retries = V}) -> V.

%% @doc Returns the authentication mode.
-spec auth_mode(config()) -> auth_mode().
auth_mode(#config{auth_mode = V}) -> V.

%% @doc Returns the custom headers.
-spec headers(config()) -> [{binary(), binary()}].
headers(#config{headers = V}) -> V.

%% Private

get_opt(Key, Opts, Default) ->
    case proplists:get_value(Key, Opts) of
        undefined -> get_app_env(Key, Default);
        Value -> Value
    end.

get_app_env(Key, Default) ->
    application:get_env({{.AppName}}, Key, Default).

default_headers() ->
{{- if .Client.Headers}}
    [
{{- range $i, $h := .Client.Headers}}
        {{ "{" }}{{erlangBinary $h.K}}, {{erlangBinary $h.V}}{{ "}" }}{{if lt $i (sub (len $.Client.Headers) 1)}},{{end}}
{{- end}}
    ].
{{- else}}
    [].
{{- end}}

ensure_binary(undefined) -> undefined;
ensure_binary(B) when is_binary(B) -> B;
ensure_binary(L) when is_list(L) -> list_to_binary(L);
ensure_binary(A) when is_atom(A) -> atom_to_binary(A, utf8).

normalize_headers(Headers) ->
    [{ensure_binary(K), ensure_binary(V)} || {K, V} <- Headers].
{{end}}
