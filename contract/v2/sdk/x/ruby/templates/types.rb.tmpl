{{define "types.rb.tmpl"}}# frozen_string_literal: true

# Code generated by sdkruby. DO NOT EDIT.

require "json"
{{- if .HasDate}}
require "time"
{{- end}}

module {{.ModuleName}}
  module Types
    # Base class for all model types.
    #
    # Provides JSON serialization and hash conversion.
    class Base
      # Creates a new instance from a hash.
      #
      # @param hash [Hash] Attribute hash
      # @return [Base] New instance
      def self.from_hash(hash)
        return nil if hash.nil?

        obj = new
        hash.each do |key, value|
          setter = "#{key}="
          obj.send(setter, deserialize_value(value, key)) if obj.respond_to?(setter)
        end
        obj
      end

      # @api private
      def self.deserialize_value(value, _key = nil)
        case value
        when Hash
          value.transform_keys(&:to_sym)
        when Array
          value.map { |v| deserialize_value(v) }
        else
          value
        end
      end

      # Converts the object to a hash.
      #
      # @return [Hash] Attribute hash
      def to_h
        instance_variables.each_with_object({}) do |var, hash|
          key = var.to_s.delete_prefix("@").to_sym
          value = instance_variable_get(var)
          hash[key] = serialize_value(value) unless value.nil?
        end
      end

      # Converts the object to JSON.
      #
      # @param args [Array] JSON.generate arguments
      # @return [String] JSON string
      def to_json(*args)
        to_h.to_json(*args)
      end

      private

      def serialize_value(value)
        case value
        when Base
          value.to_h
        when Array
          value.map { |v| serialize_value(v) }
        when Hash
          value.transform_values { |v| serialize_value(v) }
        when Time
          value.iso8601
        else
          value
        end
      end
    end
{{range $type := .Types}}
{{- if $type.Description}}

    # {{$type.Description}}
{{- end}}
{{- if eq $type.Kind "struct"}}

    class {{$type.RubyName}} < Base
{{- range $field := $type.Fields}}
      # @return [{{$field.RubyType}}{{if or $field.Optional $field.Nullable}}, nil{{end}}]{{if $field.Description}} {{$field.Description}}{{end}}
      attr_accessor :{{$field.RubyName}}
{{- end}}

      # Creates a new {{$type.RubyName}} instance.
      #
{{- range $field := $type.Fields}}
      # @param {{$field.RubyName}} [{{$field.RubyType}}{{if or $field.Optional $field.Nullable}}, nil{{end}}]{{if $field.Description}} {{$field.Description}}{{end}}
{{- end}}
      def initialize(
{{- $fields := $type.Fields}}
{{- $lastIdx := len $fields | add -1}}
{{- range $i, $f := $fields}}
        {{$f.RubyName}}: {{if $f.Const}}{{rubyQuote $f.Const}}{{else if or $f.Optional $f.Nullable}}nil{{else}}nil{{end}}{{if lt $i $lastIdx}},{{end}}
{{- end}}
      )
{{- range $field := $type.Fields}}
        @{{$field.RubyName}} = {{$field.RubyName}}
{{- end}}
      end
{{- range $field := $type.Fields}}
{{- if $field.Enum}}

      # Valid values for {{$field.RubyName}}.
      module {{$field.RubyName | pascal}}
{{- range $e := $field.Enum}}
        {{$e.Name}} = {{rubyQuote $e.Value}}
{{- end}}

        ALL = [
{{- range $i, $e := $field.Enum}}
          {{$e.Name}}{{if lt $i (sub (len $field.Enum) 1)}},{{end}}
{{- end}}
        ].freeze

        # Checks if a value is valid.
        #
        # @param value [String] Value to check
        # @return [Boolean] True if valid
        def self.valid?(value)
          ALL.include?(value)
        end
      end
{{- end}}
{{- end}}
    end
{{- end}}

{{- if eq $type.Kind "slice"}}
    # Type alias for {{$type.Name}}.
    {{$type.RubyName}} = Array
{{- end}}

{{- if eq $type.Kind "map"}}
    # Type alias for {{$type.Name}}.
    {{$type.RubyName}} = Hash
{{- end}}

{{- if eq $type.Kind "union"}}

    # Discriminated union (tag: "{{$type.Tag}}").
    module {{$type.RubyName}}
      # Creates the appropriate variant from a hash.
      #
      # @param hash [Hash] Data hash with discriminator
      # @return [Base] The variant instance
      # @raise [ArgumentError] if type is unknown
      def self.from_hash(hash)
        return nil if hash.nil?

        type_value = hash[:{{$type.Tag}}] || hash["{{$type.Tag}}"]

        case type_value
{{- range $var := $type.Variants}}
        when {{rubyQuote $var.Value}}
          {{$var.RubyName}}.from_hash(hash)
{{- end}}
        else
          raise ArgumentError, "Unknown {{$type.RubyName}} type: #{type_value}"
        end
      end
    end
{{- range $var := $type.Variants}}
{{- if $var.Description}}

    # {{$var.Description}}
{{- end}}
    class {{$var.RubyName}} < Base
      # @return [String] The discriminator value
      attr_accessor :{{$type.Tag}}

      def initialize({{$type.Tag}}: {{rubyQuote $var.Value}})
        @{{$type.Tag}} = {{$type.Tag}}
      end
    end
{{- end}}
{{- end}}
{{- end}}
  end
end
{{end}}
