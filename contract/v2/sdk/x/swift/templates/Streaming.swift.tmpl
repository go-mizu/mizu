{{define "Streaming.swift.tmpl"}}// Code generated by sdkswift. DO NOT EDIT.

import Foundation

{{- if .HasSSE}}

// MARK: - Streaming Extensions

extension AsyncThrowingStream where Element: Decodable, Failure == Error {
    /// Collects all elements from the stream into an array.
    /// - Returns: An array containing all streamed elements.
    /// - Throws: Any error that occurred during streaming.
    public func collect() async throws -> [Element] {
        var items: [Element] = []
        for try await item in self {
            items.append(item)
        }
        return items
    }

    /// Returns the first element from the stream.
    /// - Returns: The first element, or nil if the stream is empty.
    /// - Throws: Any error that occurred during streaming.
    public func first() async throws -> Element? {
        for try await item in self {
            return item
        }
        return nil
    }

    /// Iterates over elements, applying a closure to each.
    /// - Parameter body: A closure that takes an element as its parameter.
    /// - Throws: Any error that occurred during streaming or in the closure.
    public func forEach(_ body: (Element) async throws -> Void) async throws {
        for try await item in self {
            try await body(item)
        }
    }
}

// MARK: - EventSource

/// A wrapper for SSE streams that provides cancellation support.
public final class EventSource<T: Decodable>: @unchecked Sendable {
    private let stream: AsyncThrowingStream<T, Error>
    private var task: Task<Void, Never>?
    private let lock = NSLock()

    /// Creates a new event source wrapping the given stream.
    public init(_ stream: AsyncThrowingStream<T, Error>) {
        self.stream = stream
    }

    /// The underlying async stream.
    public var events: AsyncThrowingStream<T, Error> {
        stream
    }

    /// Cancels the stream.
    public func cancel() {
        lock.lock()
        defer { lock.unlock() }
        task?.cancel()
    }

    /// Iterates over events with a handler.
    /// - Parameter handler: A closure called for each event.
    /// - Throws: Any error that occurred during streaming.
    @discardableResult
    public func onEvent(_ handler: @escaping (T) async throws -> Void) async throws -> Self {
        for try await event in stream {
            try await handler(event)
        }
        return self
    }

    /// Starts iteration in a background task.
    /// - Parameter handler: A closure called for each event.
    /// - Returns: Self for chaining.
    @discardableResult
    public func start(_ handler: @escaping (T) async -> Void) -> Self {
        lock.lock()
        defer { lock.unlock() }

        task = Task {
            do {
                for try await event in stream {
                    await handler(event)
                }
            } catch {
                // Stream ended or cancelled
            }
        }
        return self
    }

    /// Waits for the stream to complete.
    public func wait() async {
        lock.lock()
        let currentTask = task
        lock.unlock()

        await currentTask?.value
    }
}

extension AsyncThrowingStream where Element: Decodable, Failure == Error {
    /// Wraps this stream in an EventSource for easier management.
    public func asEventSource() -> EventSource<Element> {
        EventSource(self)
    }
}
{{- else}}
// No streaming methods in this SDK.
{{- end}}
{{end}}
