// <auto-generated>
// This file was generated by Mizu SDK Generator. Do not edit manually.
// </auto-generated>

using System.Runtime.CompilerServices;
using System.Text;
using System.Text.Json;

namespace {{.Namespace}};

{{- if .HasSSE}}

/// <summary>
/// Server-Sent Events (SSE) parser.
/// </summary>
internal static class SseParser
{
    /// <summary>
    /// Parses Server-Sent Events from an HTTP response stream.
    /// </summary>
    /// <typeparam name="T">The type to deserialize each event to.</typeparam>
    /// <param name="stream">The response stream.</param>
    /// <param name="jsonOptions">JSON serializer options.</param>
    /// <param name="cancellationToken">Cancellation token.</param>
    /// <returns>An async enumerable of deserialized events.</returns>
    public static async IAsyncEnumerable<T> ParseAsync<T>(
        Stream stream,
        JsonSerializerOptions? jsonOptions = null,
        [EnumeratorCancellation] CancellationToken cancellationToken = default)
    {
        using var reader = new StreamReader(stream, Encoding.UTF8);
        var dataBuffer = new StringBuilder();

        while (!reader.EndOfStream)
        {
            cancellationToken.ThrowIfCancellationRequested();

            var line = await reader.ReadLineAsync(cancellationToken).ConfigureAwait(false);
            if (line is null) break;

            if (line.Length == 0)
            {
                // Empty line = end of event
                var data = dataBuffer.ToString().Trim();
                dataBuffer.Clear();

                if (data.Length > 0 && data != "[DONE]")
                {
                    T? item;
                    try
                    {
                        item = JsonSerializer.Deserialize<T>(data, jsonOptions);
                    }
                    catch (JsonException ex)
                    {
                        throw new DeserializationException(ex);
                    }

                    if (item is not null)
                    {
                        yield return item;
                    }
                }
            }
            else if (line.StartsWith("data:", StringComparison.Ordinal))
            {
                var content = line.AsSpan(5);
                if (content.Length > 0 && content[0] == ' ')
                {
                    content = content.Slice(1);
                }
                if (dataBuffer.Length > 0) dataBuffer.AppendLine();
                dataBuffer.Append(content);
            }
            // Ignore other SSE fields (event:, id:, retry:)
        }
    }
}
{{- else}}

// No streaming methods in this service.
{{- end}}
