{{define "streaming.dart.tmpl"}}// Code generated by sdkdart. DO NOT EDIT.

import 'dart:async';
import 'dart:convert';

/// Parses Server-Sent Events from a byte stream into a Stream.
Stream<T> parseSSEStream<T>(
  Stream<List<int>> byteStream,
  T Function(Map<String, dynamic>) fromJson,
) async* {
  final buffer = StringBuffer();
  String partial = '';

  await for (final chunk in byteStream.transform(utf8.decoder)) {
    partial += chunk;
    final lines = partial.split('\n');
    partial = lines.removeLast();

    for (final line in lines) {
      if (line.isEmpty) {
        // Empty line = end of event
        final data = buffer.toString().trim();
        buffer.clear();

        if (data.isNotEmpty && data != '[DONE]') {
          try {
            final json = jsonDecode(data) as Map<String, dynamic>;
            yield fromJson(json);
          } catch (_) {
            // Skip malformed JSON
          }
        }
      } else if (line.startsWith('data:')) {
        final content = line.substring(5).trimLeft();
        if (buffer.isNotEmpty) buffer.writeln();
        buffer.write(content);
      }
      // Ignore other SSE fields (event:, id:, retry:)
    }
  }

  // Process any remaining data in buffer
  if (buffer.isNotEmpty) {
    final data = buffer.toString().trim();
    if (data.isNotEmpty && data != '[DONE]') {
      try {
        final json = jsonDecode(data) as Map<String, dynamic>;
        yield fromJson(json);
      } catch (_) {
        // Skip malformed JSON
      }
    }
  }
}
{{end}}
