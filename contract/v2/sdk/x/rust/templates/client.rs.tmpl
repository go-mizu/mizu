{{define "client.rs.tmpl"}}// Code generated by sdkrust. DO NOT EDIT.

//! HTTP client for the {{.Service.Name}} API.

use std::sync::Arc;
use std::time::Duration;

use reqwest::header::{HeaderMap, HeaderName, HeaderValue};
use reqwest::Client as HttpClient;

use crate::error::{Error, Result};
use crate::resources;

/// Authentication mode for API requests.
#[derive(Debug, Clone, Default)]
pub enum AuthMode {
    /// Bearer token authentication.
    #[default]
    Bearer,
    /// Basic authentication.
    Basic,
    /// API key in header.
    ApiKey,
    /// No authentication.
    None,
}

/// Configuration for the SDK client.
#[derive(Debug, Clone)]
pub struct ClientConfig {
    /// API key for authentication.
    pub api_key: Option<String>,
    /// Base URL for API requests.
    pub base_url: String,
    /// Authentication mode.
    pub auth_mode: AuthMode,
    /// Request timeout.
    pub timeout: Duration,
    /// Maximum retry attempts.
    pub max_retries: u32,
    /// Additional headers to include in all requests.
    pub default_headers: HeaderMap,
}

impl Default for ClientConfig {
    fn default() -> Self {
        Self {
            api_key: None,
            base_url: {{rustString .Client.BaseURL}}.to_string(),
            auth_mode: AuthMode::default(),
            timeout: Duration::from_secs(60),
            max_retries: 2,
            default_headers: HeaderMap::new(),
        }
    }
}

/// Builder for constructing a [`Client`].
#[derive(Debug, Clone, Default)]
pub struct ClientBuilder {
    config: ClientConfig,
}

impl ClientBuilder {
    /// Creates a new client builder with default configuration.
    #[must_use]
    pub fn new() -> Self {
        Self::default()
    }

    /// Sets the API key for authentication.
    #[must_use]
    pub fn api_key(mut self, key: impl Into<String>) -> Self {
        self.config.api_key = Some(key.into());
        self
    }

    /// Sets the base URL for API requests.
    #[must_use]
    pub fn base_url(mut self, url: impl Into<String>) -> Self {
        self.config.base_url = url.into();
        self
    }

    /// Sets the authentication mode.
    #[must_use]
    pub fn auth_mode(mut self, mode: AuthMode) -> Self {
        self.config.auth_mode = mode;
        self
    }

    /// Sets the request timeout.
    #[must_use]
    pub fn timeout(mut self, timeout: Duration) -> Self {
        self.config.timeout = timeout;
        self
    }

    /// Sets the maximum retry attempts.
    #[must_use]
    pub fn max_retries(mut self, retries: u32) -> Self {
        self.config.max_retries = retries;
        self
    }

    /// Adds a default header to include in all requests.
    ///
    /// # Errors
    ///
    /// Returns an error if the header name or value is invalid.
    pub fn header(mut self, name: &str, value: &str) -> Result<Self> {
        let header_name = HeaderName::try_from(name)
            .map_err(|_| Error::InvalidConfig(format!("invalid header name: {name}")))?;
        let header_value = HeaderValue::from_str(value)
            .map_err(|_| Error::InvalidConfig(format!("invalid header value for {name}")))?;
        self.config.default_headers.insert(header_name, header_value);
        Ok(self)
    }

    /// Builds the client.
    ///
    /// # Errors
    ///
    /// Returns an error if the HTTP client cannot be created.
    pub fn build(self) -> Result<Client> {
        let mut headers = self.config.default_headers.clone();
        headers.insert(
            reqwest::header::CONTENT_TYPE,
            HeaderValue::from_static("application/json"),
        );
        headers.insert(
            reqwest::header::ACCEPT,
            HeaderValue::from_static("application/json"),
        );

        // Apply default headers from contract
{{- range .Client.Headers}}
        headers.insert(
            HeaderName::from_static({{rustString (.K | lower)}}),
            HeaderValue::from_static({{rustString .V}}),
        );
{{- end}}

        // Apply authentication header
        if let Some(ref api_key) = self.config.api_key {
            let (header_name, auth_value) = match self.config.auth_mode {
                AuthMode::Bearer => ("authorization", format!("Bearer {api_key}")),
                AuthMode::Basic => ("authorization", format!("Basic {api_key}")),
                AuthMode::ApiKey => ("x-api-key", api_key.clone()),
                AuthMode::None => ("", String::new()),
            };
            if !auth_value.is_empty() {
                headers.insert(
                    HeaderName::from_static(header_name),
                    HeaderValue::from_str(&auth_value)
                        .map_err(|_| Error::InvalidConfig("invalid API key".into()))?,
                );
            }
        }

        let http_client = HttpClient::builder()
            .timeout(self.config.timeout)
            .default_headers(headers)
            .build()
            .map_err(Error::Connection)?;

        Ok(Client {
            inner: Arc::new(ClientInner {
                http: http_client,
                config: self.config,
            }),
        })
    }
}

#[derive(Debug)]
pub(crate) struct ClientInner {
    pub(crate) http: HttpClient,
    pub(crate) config: ClientConfig,
}

/// Client for the {{.Service.Name}} API.
///
/// The client is cheaply cloneable and can be shared across tasks.
#[derive(Debug, Clone)]
pub struct Client {
    pub(crate) inner: Arc<ClientInner>,
}

impl Client {
    /// Creates a new client builder.
    #[must_use]
    pub fn builder() -> ClientBuilder {
        ClientBuilder::new()
    }

    /// Creates a new client with default configuration.
    ///
    /// # Errors
    ///
    /// Returns an error if the HTTP client cannot be created.
    pub fn new() -> Result<Self> {
        Self::builder().build()
    }

    /// Returns the configured base URL.
    #[must_use]
    pub fn base_url(&self) -> &str {
        &self.inner.config.base_url
    }

    /// Returns the HTTP client for making requests.
    #[must_use]
    pub(crate) fn http(&self) -> &HttpClient {
        &self.inner.http
    }

    /// Returns the client configuration.
    #[must_use]
    pub(crate) fn config(&self) -> &ClientConfig {
        &self.inner.config
    }

    // Resource accessors
{{- range .Resources}}

    /// Access the {{.Name}} resource.
    #[must_use]
    pub fn {{.RustName}}(&self) -> resources::{{.StructName}} {
        resources::{{.StructName}}::new(self.clone())
    }
{{- end}}
}
{{end}}
