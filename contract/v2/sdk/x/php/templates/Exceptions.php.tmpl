{{define "Exceptions.php.tmpl"}}<?php

declare(strict_types=1);

// Code generated by sdkphp. DO NOT EDIT.

namespace {{.Namespace}}\Exceptions;

/**
 * Base exception for all SDK errors.
 */
class SDKException extends \Exception
{
}

/**
 * Exception for API errors (HTTP 4xx/5xx).
 */
class ApiException extends SDKException
{
    /**
     * @param array<string, array<string>> $headers
     */
    public function __construct(
        string $message,
        public readonly int $statusCode,
        public readonly ?string $body = null,
        public readonly array $headers = [],
        ?\Throwable $previous = null,
    ) {
        parent::__construct($message, $statusCode, $previous);
    }

    /**
     * Checks if this is a client error (4xx).
     */
    public function isClientError(): bool
    {
        return $this->statusCode >= 400 && $this->statusCode < 500;
    }

    /**
     * Checks if this is a server error (5xx).
     */
    public function isServerError(): bool
    {
        return $this->statusCode >= 500;
    }

    /**
     * Checks if the request can be retried.
     */
    public function isRetryable(): bool
    {
        return $this->statusCode === 429 || $this->statusCode >= 500;
    }

    /**
     * Gets the retry-after header value in seconds.
     */
    public function getRetryAfter(): ?int
    {
        $values = $this->headers['Retry-After'] ?? $this->headers['retry-after'] ?? null;
        if ($values === null || empty($values)) {
            return null;
        }

        $value = $values[0];
        if (is_numeric($value)) {
            return (int) $value;
        }

        // Parse HTTP date
        $timestamp = strtotime($value);
        if ($timestamp === false) {
            return null;
        }

        return max(0, $timestamp - time());
    }

    /**
     * Decodes the response body as the given type.
     *
     * @template T of object
     * @param class-string<T> $type
     * @return T|null
     */
    public function decodeAs(string $type): ?object
    {
        if ($this->body === null) {
            return null;
        }

        $data = json_decode($this->body, true);
        if (!is_array($data)) {
            return null;
        }

        if (!method_exists($type, 'fromArray')) {
            return null;
        }

        return $type::fromArray($data);
    }
}

/**
 * HTTP 400 Bad Request.
 */
class BadRequestException extends ApiException {}

/**
 * HTTP 401 Unauthorized.
 */
class AuthenticationException extends ApiException {}

/**
 * HTTP 403 Forbidden.
 */
class PermissionDeniedException extends ApiException {}

/**
 * HTTP 404 Not Found.
 */
class NotFoundException extends ApiException {}

/**
 * HTTP 422 Unprocessable Entity.
 */
class UnprocessableEntityException extends ApiException {}

/**
 * HTTP 429 Too Many Requests.
 */
class RateLimitException extends ApiException {}

/**
 * HTTP 5xx Server Error.
 */
class ServerException extends ApiException {}

/**
 * Network/connection error.
 */
class ConnectionException extends SDKException
{
    public function __construct(
        string $message,
        public readonly ?\Throwable $cause = null,
    ) {
        parent::__construct($message, 0, $cause);
    }
}

/**
 * Request timeout.
 */
class TimeoutException extends SDKException {}

/**
 * SSE stream parsing error.
 */
class StreamParseException extends SDKException
{
    public function __construct(
        string $message,
        public readonly ?string $data = null,
    ) {
        parent::__construct($message);
    }
}
{{end}}