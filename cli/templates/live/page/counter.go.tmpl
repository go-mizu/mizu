package page

import (
	"github.com/go-mizu/mizu/view/live"
)

// CounterState holds the counter page state.
type CounterState struct {
	Count int
}

// CounterPage implements a simple counter with live updates.
type CounterPage struct{}

// Mount initializes the counter state.
func (p *CounterPage) Mount(ctx *live.Ctx, s *live.Session[CounterState]) error {
	s.State = CounterState{Count: 0}
	s.MarkAll()
	return nil
}

// Render returns the view configuration.
func (p *CounterPage) Render(ctx *live.Ctx, s *live.Session[CounterState]) (live.View, error) {
	return live.View{
		Page: "counter/index",
		Regions: map[string]string{
			"count": "counter/count",
		},
	}, nil
}

// Handle processes user events.
func (p *CounterPage) Handle(ctx *live.Ctx, s *live.Session[CounterState], e live.Event) error {
	switch e.Name {
	case "inc":
		by := e.GetInt("by")
		if by == 0 {
			by = 1
		}
		s.State.Count += by
		s.Mark("count")

	case "dec":
		s.State.Count--
		s.Mark("count")

	case "reset":
		s.State.Count = 0
		s.Mark("count")
	}
	return nil
}

// Info handles server-side messages (unused for counter).
func (p *CounterPage) Info(ctx *live.Ctx, s *live.Session[CounterState], msg any) error {
	return nil
}
