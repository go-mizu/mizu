package server

import (
	"github.com/go-mizu/mizu"
	contract "github.com/go-mizu/mizu/contract/v2"
	"github.com/go-mizu/mizu/contract/v2/transport/async"
	"github.com/go-mizu/mizu/contract/v2/transport/jsonrpc"
	"github.com/go-mizu/mizu/contract/v2/transport/mcp"
	"github.com/go-mizu/mizu/contract/v2/transport/rest"
	"{{.Module}}/service/todo"
)

// New creates a new mizu app with REST, JSON-RPC, MCP, and Async transports.
func New(cfg Config, todoSvc *todo.Service) (*mizu.App, error) {
	// Register service using code-first approach
	svc := contract.Register[todo.API](todoSvc,
		contract.WithDefaultResource("todos"),
		contract.WithName("Todo"),
		contract.WithDescription("Todo management service"),
	)

	// Create mizu app
	app := mizu.New()

	// Mount REST API
	if err := rest.Mount(app.Router, svc); err != nil {
		return nil, err
	}

	// Mount JSON-RPC 2.0 endpoint
	if err := jsonrpc.Mount(app.Router, "/rpc", svc); err != nil {
		return nil, err
	}

	// Mount MCP endpoint (for LLM tool integration)
	if err := mcp.Mount(app.Router, "/mcp", svc,
		mcp.WithServerInfo("{{.Name}}", "1.0.0"),
	); err != nil {
		return nil, err
	}

	// Mount Async endpoint (SSE-based async)
	if err := async.Mount(app.Router, "/async", svc); err != nil {
		return nil, err
	}

	// Serve OpenAPI 3.0 spec
	app.Router.Get("/openapi.json", func(c *mizu.Ctx) error {
		spec, err := rest.OpenAPI(svc.Descriptor())
		if err != nil {
			return c.JSON(500, map[string]string{"error": err.Error()})
		}
		c.Header().Set("Content-Type", "application/json")
		_, err = c.Write(spec)
		return err
	})

	// Serve OpenRPC spec
	app.Router.Get("/openrpc.json", func(c *mizu.Ctx) error {
		spec, err := jsonrpc.OpenRPC(svc.Descriptor())
		if err != nil {
			return c.JSON(500, map[string]string{"error": err.Error()})
		}
		c.Header().Set("Content-Type", "application/json")
		_, err = c.Write(spec)
		return err
	})

	// Serve AsyncAPI spec
	app.Router.Get("/asyncapi.json", func(c *mizu.Ctx) error {
		spec, err := async.AsyncAPI(svc.Descriptor())
		if err != nil {
			return c.JSON(500, map[string]string{"error": err.Error()})
		}
		c.Header().Set("Content-Type", "application/json")
		_, err = c.Write(spec)
		return err
	})

	return app, nil
}
