import React, { useEffect, useState } from 'react';
import { NavigationContainer } from '@react-navigation/native';
import { createNativeStackNavigator } from '@react-navigation/native-stack';
import { MizuRuntime } from './runtime/MizuRuntime';
import { AppConfig } from './config/config';
import { useAuthStore } from './store/authStore';
import HomeScreen from './screens/HomeScreen';
import WelcomeScreen from './screens/WelcomeScreen';
import LoadingView from './components/LoadingView';

export type RootStackParamList = {
  Welcome: undefined;
  Home: undefined;
};

const Stack = createNativeStackNavigator<RootStackParamList>();

export default function App() {
  const [isReady, setIsReady] = useState(false);
  const isAuthenticated = useAuthStore((state) => state.isAuthenticated);
  const setIsAuthenticated = useAuthStore((state) => state.setIsAuthenticated);

  useEffect(() => {
    async function initialize() {
      // Initialize Mizu runtime
      await MizuRuntime.initialize({
        baseURL: AppConfig.baseURL,
        timeout: AppConfig.timeout,
      });

      // Subscribe to auth state changes
      const unsubscribe = MizuRuntime.shared.onAuthStateChange((isAuth) => {
        setIsAuthenticated(isAuth);
      });

      // Check initial auth state
      setIsAuthenticated(MizuRuntime.shared.isAuthenticated);
      setIsReady(true);

      return unsubscribe;
    }

    initialize();
  }, [setIsAuthenticated]);

  if (!isReady) {
    return <LoadingView message="Loading..." />;
  }

  return (
    <NavigationContainer>
      <Stack.Navigator screenOptions=\{{ headerShown: false }}>
        {isAuthenticated ? (
          <Stack.Screen name="Home" component={HomeScreen} />
        ) : (
          <Stack.Screen name="Welcome" component={WelcomeScreen} />
        )}
      </Stack.Navigator>
    </NavigationContainer>
  );
}
